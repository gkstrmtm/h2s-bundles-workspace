<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="color-scheme" content="light">
        <title>Home2Smart - Service Tech Hiring Dashboard</title>
        <script>
            // Suppress vendor console spam
            (function() {
                const originalError = console.error;
                const originalWarn = console.warn;
                const originalLog = console.log;
                
                const filterPatterns = [
                    'ApolloClient',
                    'FeatureGateClients',
                    'vendor-',
                    'Failed to load resource',
                    '400 (Bad Request)',
                    'go.apollo.dev',
                    'msgsndr.com',
                    'Deprecated API',
                    'useLazyQuery',
                    'useQuery',
                    'onError',
                    'onCompleted',
                    'An error occurred!',
                    'err#%7B'
                ];

                function shouldSuppress(args) {
                    const msg = args.map(a => String(a)).join(' ');
                    return filterPatterns.some(p => msg.includes(p));
                }

                console.error = function(...args) {
                    if (!shouldSuppress(args)) originalError.apply(console, args);
                };
                
                console.warn = function(...args) {
                    if (!shouldSuppress(args)) originalWarn.apply(console, args);
                };

                console.log = function(...args) {
                    if (!shouldSuppress(args)) originalLog.apply(console, args);
                };
            })();

            // Server-injected API base URL (available when served via Apps Script template)
            // Falls back on client if not injected.
            try { window.API_URL = '<?= API_URL ?>'; } catch (e) { /* not templated */ }
        </script>
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;900&display=swap" rel="stylesheet">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="180x180" 
      href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png">
    <meta name="theme-color" content="#0a2a5a">
    
    <style>
        /* === CRITICAL CSS === */
        /* Font loaded via Google Fonts API link tag above */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cobalt: #0a2a5a;
            --azure: #1493ff;
            --white: #ffffff;
            --success: #34A853;
            --warning: #FBBC04;
            --danger: #EA4335;
            --light: #F8F9FA;
            --border: #e7eaf0;
            --ease: cubic-bezier(.22,.8,.32,1);
            --ease-smooth: cubic-bezier(.16,.84,.44,1);
            --elev-1: 0 2px 6px rgba(0,0,0,.20), 0 6px 18px rgba(0,0,0,.14);
            --elev-2: 0 6px 14px rgba(0,0,0,.24), 0 18px 28px rgba(0,0,0,.18);
            --elev-card: 0 2px 10px rgba(0,0,0,.08);
            --elev-card-lg: 0 16px 36px rgba(0,0,0,.22);
            
            /* Unified Spacing System */
            --page-pad: clamp(16px, 4vw, 32px);
            --gap-1: 8px;
            --gap-2: 16px;
            --radius: 12px;
            --surface: #ffffff;
            --surface-2: #F8F9FA;
            --text: #0a2a5a;
            --muted: rgba(10, 42, 90, 0.6);
            --control-h: 40px;
        }

        html {
            scroll-behavior: smooth;
            background: #0a2a5a !important;
        }

        body {
            font-family: Archivo, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: var(--cobalt) !important;
            background-color: #0a2a5a !important;
            min-height: 100vh;
            color: var(--white);
            -webkit-font-smoothing: antialiased;
        }

        /* ===== HEADER ===== */
        .h2s-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--white);
            box-shadow: var(--elev-2);
            border-bottom: 1px solid var(--border);
        }

        .h2s-head-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px var(--page-pad);
            max-width: none;
            margin: 0;
        }

        .h2s-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .h2s-logo img {
            width: 64px;
            height: 64px;
        }

        .h2s-logo-text {
            font-weight: 900;
            font-size: clamp(20px, 2.4vw, 28px);
            color: var(--cobalt);
            text-transform: lowercase;
        }

        .logout-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 700;
            color: rgba(10, 42, 90, 0.7);
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(10, 42, 90, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            color: var(--cobalt);
            background: white;
            border-color: var(--cobalt);
            transform: translateY(-1px);
        }

        /* ===== MAIN ===== */
        .main {
            padding: var(--page-pad);
            max-width: none;
            margin: 0;
        }

        .page-title {
            font-weight: 900;
            font-size: clamp(20px, 3vw, 28px);
            color: var(--white);
            margin-bottom: var(--gap-2);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: var(--gap-1);
            margin-bottom: var(--gap-2);
            flex-wrap: wrap;
            background: var(--white);
            padding: var(--gap-1);
            border-radius: var(--radius);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
        }

        .tab {
            background: transparent;
            border: none;
            color: var(--cobalt);
            font-weight: 700;
            font-size: 15px;
            padding: 12px var(--gap-2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
            opacity: 0.6;
        }
        
        .tab:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
        }

        .tab:hover {
            background: #eef2f7; /* Neutral hover, no color bleed */
            opacity: 1;
        }

        .tab.active {
            background: #0a2a5a; /* Brand cobalt */
            color: var(--white);
            box-shadow: 0 2px 8px rgba(10,42,90,0.2);
            opacity: 1;
        }

        /* ===== PANELS ===== */
        .pane {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            will-change: opacity, transform;
        }

        .pane.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.25s var(--ease);
        }
        
        /* Smooth tab switching indicator */
        .tab-switching-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--cobalt), var(--azure));
            transform: translateX(-100%);
            z-index: 9999;
            pointer-events: none;
            transition: transform 0.3s ease-out;
        }
        
        .tab-switching-indicator.active {
            transform: translateX(0%);
            animation: slideProgress 0.4s ease-out forwards;
        }
        
        @keyframes slideProgress {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(0%); }
            100% { transform: translateX(100%); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== OFFER BUILDER SCOPED STYLES (No cross-tab bleed) ===== */
        #offerbuilder-pane #offerBuilderMainGrid {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 24px;
            align-items: start;
            /* Ensure grid items can expand naturally when content grows */
            min-height: 0;
        }
        
        /* Ensure left column (accordion container) allows natural expansion */
        #offerbuilder-pane #offerBuilderMainGrid > div:first-child {
            min-height: 0;
            overflow: visible;
        }

        #offerbuilder-pane #offerBuilderRightColumn {
            display: flex;
            flex-direction: column;
            gap: 24px;
            position: relative;
            min-width: 0;
            align-items: stretch;
            /* Ensure flex children can expand naturally */
            min-height: 0;
        }

        #offerbuilder-pane #offerBuilderStandards,
        #offerbuilder-pane #offerBuilderTotals {
            min-width: 0;
            width: 100%;
            flex-shrink: 0;
        }
        
        /* Standards panel - sticky at top */
        #offerbuilder-pane #offerBuilderStandards {
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(50vh - 60px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #offerbuilder-pane #offerBuilderStandardsContent {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
        }
        
        /* Totals panel - NOT sticky, flows naturally */
        #offerbuilder-pane #offerBuilderTotals {
            position: relative;
            align-self: flex-start;
        }
        
        /* Ensure Totals content can scroll if panel is tall */
        #offerbuilder-pane #offerBuilderResults {
            max-height: calc(100vh - var(--totals-top-offset, 300px) - 100px); /* Top offset + panel padding/header (~100px) */
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Mobile: Stack columns vertically */
        @media (max-width: 768px) {
            #offerbuilder-pane #offerBuilderMainGrid {
                grid-template-columns: 1fr;
            }
            
            #offerbuilder-pane #offerBuilderStandards,
            #offerbuilder-pane #offerBuilderTotals {
                position: relative !important;
                top: auto !important;
            }
            
            /* Remove max-height constraints on mobile for full content visibility */
            #offerbuilder-pane #offerBuilderStandardsContent,
            #offerbuilder-pane #offerBuilderResults {
                max-height: none !important;
                overflow-y: visible !important;
            }
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--gap-2);
            margin-bottom: var(--gap-2);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: clamp(18px, 2.2vw, 22px);
            color: var(--text);
            margin-bottom: var(--gap-2);
            font-weight: 900;
        }

        /* ===== GLOBAL SCROLLBAR ===== */
        /* Applies to all scrollable elements including textareas */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #bdc1c6;
        }

        /* ===== PIPELINE COLUMNS ===== */
        .pipeline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .pipeline-column {
            background: var(--white);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-height: 400px;
            max-height: 600px;
        }

        .pipeline-header {
            font-weight: 900;
            font-size: 16px;
            color: var(--cobalt);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .pipeline-count {
            background: var(--azure);
            color: var(--white);
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 13px;
        }

        .pipeline-cards-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding-right: 4px;
        }

        .pipeline-cards-container::-webkit-scrollbar {
            width: 6px;
        }

        .pipeline-cards-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .pipeline-cards-container::-webkit-scrollbar-thumb:hover {
            background: var(--azure);
        }

        .pipeline-pagination {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 8px 4px;
            border-top: 2px solid var(--border);
            font-size: 13px;
            color: #5f6368;
            font-weight: 600;
        }

        .pagination-info {
            font-size: 12px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .page-btn {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            color: var(--cobalt);
        }

        .page-btn:hover:not(:disabled) {
            background: var(--azure);
            color: white;
            border-color: var(--azure);
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .candidate-card {
            background: var(--light);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s var(--ease);
            border: 1px solid var(--border);
        }

        .candidate-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
            background: white;
        }

        .candidate-name {
            font-weight: 700;
            font-size: 14px;
            color: var(--cobalt);
            margin-bottom: 4px;
        }

        .candidate-info {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 2px;
        }

        .candidate-info strong {
            font-weight: 600;
            color: var(--cobalt);
        }

        .candidate-date {
            font-size: 11px;
            color: #80868b;
            margin-top: 4px;
            font-style: italic;
        }

        .candidate-outcome {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 6px;
        }

        .outcome-ready {
            background: #E8F5E9;
            color: var(--success);
        }

        .outcome-warm {
            background: #FFF9C4;
            color: #F57F17;
        }

        .outcome-hold {
            background: #E3F2FD;
            color: #1976D2;
        }

        .outcome-not-match {
            background: #FFEBEE;
            color: var(--danger);
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: var(--gap-2);
        }

        .form-label {
            display: block;
            font-weight: 700;
            color: var(--text);
            margin-bottom: var(--gap-1);
            font-size: 15px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 13px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s var(--ease);
            background: var(--white);
            color: var(--cobalt);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
            outline: none;
            border-color: var(--azure);
            box-shadow: 0 0 0 3px rgba(20, 147, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--gap-2);
        }

        /* ===== BUTTONS ===== */
        .btn {
            border: 2px solid var(--azure);
            background: var(--azure);
            color: var(--white);
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            padding: 13px 24px;
            font-size: 15px;
            transition: transform 0.2s var(--ease), box-shadow 0.22s var(--ease-smooth);
            box-shadow: var(--elev-1);
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-2);
        }
        
        .btn:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
        }
        
        .btn:active {
            transform: translateY(0);
            transition: transform 0.1s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
        }

        /* ===== SPINNER ===== */
        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid #e0e0e0; /* Darker track for visibility */
            border-top: 4px solid var(--azure);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .empty-text {
            font-size: 16px;
            font-weight: 600;
            color: #5f6368; /* Darker gray for readability */
        }

        /* ===== GHL FORM IFRAME STYLING ===== */
        #screening-pane .card,
        #techinterview-pane .card {
            min-height: 1200px;
            padding-bottom: 40px;
        }

        #screening-pane iframe,
        #techinterview-pane iframe {
            min-height: 1200px;
        }

        /* ===== AI PROFILE CARDS ===== */
        .ai-profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .ai-profile-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--elev-card);
            border: 2px solid var(--border);
            transition: all 0.3s var(--ease);
        }

        .ai-profile-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--elev-card-lg);
        }

        .ai-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .ai-profile-name {
            font-weight: 900;
            font-size: 20px;
            color: var(--cobalt);
            margin-bottom: 6px;
        }

        .ai-profile-contact {
            font-size: 13px;
            color: #5f6368;
            margin: 2px 0;
        }

        .ai-fit-score {
            text-align: center;
            min-width: 80px;
        }

        .ai-score-number {
            font-size: 36px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 4px;
        }

        .ai-score-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #5f6368;
        }

        .score-10, .score-9 { color: #34A853; }
        .score-8, .score-7 { color: #FBBC04; }
        .score-6, .score-5, .score-4 { color: #FF9800; }
        .score-3, .score-2, .score-1, .score-0 { color: #EA4335; }

        .ai-recommendation {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .rec-hire {
            background: #E8F5E9;
            color: #34A853;
            border: 2px solid #34A853;
        }

        .rec-maybe {
            background: #FFF9C4;
            color: #F57F17;
            border: 2px solid #FBBC04;
        }

        .rec-pass {
            background: #FFEBEE;
            color: #EA4335;
            border: 2px solid #EA4335;
        }

        .ai-section {
            margin-bottom: 16px;
        }

        .ai-section-title {
            font-weight: 700;
            font-size: 13px;
            color: var(--cobalt);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .ai-summary {
            color: #202124;
            font-size: 15px;
            line-height: 1.6;
        }

        .ai-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ai-list li {
            padding: 6px 0 6px 20px;
            position: relative;
            color: #202124;
            font-size: 14px;
            line-height: 1.5;
        }

        .ai-list li:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--azure);
            font-weight: 900;
            font-size: 18px;
        }

        .ai-profile-footer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: #80868b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-model-badge {
            background: var(--cobalt);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 11px;
        }

        /* ===== FILTER BUTTONS ===== */
        .filter-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: var(--white);
            border: 2px solid var(--border);
            color: var(--cobalt);
            font-weight: 700;
            font-size: 14px;
            padding: 10px 16px;
            border-radius: 999px; /* pill */
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
        }

        .filter-btn:hover {
            border-color: #0a2a5a;
            background: #eef2f7;
        }

        .filter-btn.active {
            background: #0a2a5a; /* solid brand blue */
            color: var(--white);
            border-color: #0a2a5a;
            box-shadow: 0 2px 8px rgba(10,42,90,0.2);
        }

        /* ===== ACTION BUTTONS ===== */
        .ai-profile-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid var(--border);
        }

        .action-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
            border: 2px solid;
        }

        .pass-btn {
            background: #E8F5E9;
            color: var(--success);
            border-color: var(--success);
        }

        .pass-btn:hover {
            background: var(--success);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .fail-btn {
            background: #FFEBEE;
            color: var(--danger);
            border-color: var(--danger);
        }

        .fail-btn:hover {
            background: var(--danger);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        /* ===== DECISION BADGE ===== */
        .decision-badge {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 14px;
            text-align: center;
            margin-top: 16px;
            width: 100%;
        }

        .decision-badge.pass {
            background: #E8F5E9;
            color: var(--success);
            border: 2px solid var(--success);
        }

        .decision-badge.fail {
            background: #FFEBEE;
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        .decision-badge small {
            display: block;
            margin-top: 6px;
            font-size: 11px;
            font-weight: 600;
            opacity: 0.8;
        }

        /* ===== TRAINING RESOURCES ===== */
        .training-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 32px;
            margin-top: 24px;
        }

        .training-filter-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .training-filter-tab:hover {
            border-bottom-color: #0a2a5a !important;
            color: #0a2a5a !important;
        }
        .training-filter-tab.active {
            color: #0a2a5a !important;
            border-bottom-color: #0a2a5a !important;
        }
        .training-filter-tab.active span {
            background: #0a2a5a !important;
            color: white !important;
        }
        .training-resource-item {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .training-resource-item.hidden {
            display: none !important;
        }

        .training-card {
            background: var(--white);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .training-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
        }

        .training-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .training-title {
            font-weight: 900;
            font-size: 18px;
            color: var(--cobalt);
            margin-bottom: 4px;
        }

        .training-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }



        /* Status badges: Not Started / In Progress / Completed */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 800;
        }
        .status-not-started { background: #eef2f7; color: #0a2a5a; }
        .status-in-progress { background: #fff9c4; color: #f57f17; }
        .status-completed   { background: #e8f5e9; color: #2e7d32; }

        .type-video {
            background: #E3F2FD;
            color: #1976D2;
        }

        .type-pdf {
            background: #FFEBEE;
            color: #D32F2F;
        }

        .type-sop {
            background: #FFF9C4;
            color: #F57F17;
        }

        .training-embed {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 10px;
            margin: 12px 0; /* tighter */
            border: 0;
            overflow: hidden;
            box-shadow: var(--elev-card);
            background: #000;
        }

        .training-description {
            color: #5f6368;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .training-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--azure);
            color: var(--white);
            border: 0; /* Remove any outline/border artifacts */
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s var(--ease);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        .training-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .training-category {
            display: inline-block;
            padding: 6px 12px;
            background: #0a2a5a;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            color: white;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }

        /* ===== TRAINING KNOWLEDGE PROFILE ===== */
        .knowledge-profile {
            background: #F8F9FA; /* Neutral, professional background */
            border-radius: 16px;
            padding: 24px;
            color: #202124;
            margin-bottom: 24px;
            box-shadow: var(--elev-card);
            border: 2px solid var(--border);
        }

        .knowledge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .knowledge-title {
            font-size: 20px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mastery-score {
            font-size: 48px;
            font-weight: 900;
            text-align: center;
        }

        .mastery-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .knowledge-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        .knowledge-stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 900;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .skills-section {
            margin-top: 20px;
        }

        .skills-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .skills-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .skill-badge.strong {
            background: rgba(76, 175, 80, 0.3);
        }

        .skill-badge.gap {
            background: rgba(255, 193, 7, 0.3);
        }

        .skill-score {
            font-weight: 900;
        }

        /* ===== COMPLETION MODAL ===== */
        .completion-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .completion-modal.active {
            display: flex;
        }

        .completion-modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--elev-card-lg);
            animation: slideUp 0.3s var(--ease);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .completion-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .completion-modal-icon {
            font-size: 32px;
        }

        .completion-modal-title {
            font-size: 24px;
            font-weight: 900;
            color: var(--cobalt);
            flex: 1;
        }

        .completion-field {
            margin-bottom: 24px;
        }

        .completion-field label {
            display: block;
            font-weight: 700;
            color: var(--cobalt);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .completion-field textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .completion-field textarea:focus {
            outline: none;
            border-color: var(--azure);
        }

        .star-rating {
            display: flex;
            gap: 8px;
            font-size: 32px;
        }

        .star {
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            color: #d1d5db;
            opacity: 0.3;
            font-size: 32px;
            line-height: 1;
            display: inline-block;
            position: relative;
            pointer-events: auto;
        }
        
        .star::before {
            content: '★';
            pointer-events: none;
        }

        .star:hover {
            opacity: 0.7;
            transform: scale(1.1);
        }
        
        .star.active {
            color: #fbbf24;
            opacity: 1;
            transform: scale(1.2);
        }

        .completion-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .completion-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-submit {
            background: var(--azure);
            color: white;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .btn-cancel {
            background: var(--light);
            color: var(--cobalt);
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        /* ===== COMPLETION INDICATORS ===== */
        .completed-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 12px;
        }

        .training-footer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .complete-btn {
            padding: 10px 20px;
            background: var(--azure);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .skill-tag {
            padding: 4px 10px;
            background: #E3F2FD;
            color: #1976D2;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .difficulty-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .difficulty-beginner {
            background: #C8E6C9;
            color: #2E7D32;
        }

        .difficulty-intermediate {
            background: #FFF9C4;
            color: #F57F17;
        }

        .difficulty-advanced {
            background: #FFCCBC;
            color: #D84315;
        }

        /* ===== TASKS ===== */
        .tasks-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .tasks-columns {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
        }

        .tasks-column {
            background: var(--light);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid var(--border);
        }

        .tasks-column-header {
            font-weight: 900;
            font-size: 20px;
            color: var(--cobalt);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--border);
        }

        .tasks-column-count {
            background: var(--azure);
            color: var(--white);
            border-radius: 12px;
            padding: 6px 14px;
            font-size: 14px;
            font-weight: 700;
        }

        .tasks-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .task-card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--elev-card);
            border: 2px solid var(--border);
            transition: all 0.3s var(--ease);
            cursor: pointer;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-card-lg);
        }

        .task-card.priority-high {
            border-left: 6px solid var(--danger);
        }

        .task-card.priority-medium {
            border-left: 6px solid var(--warning);
        }

        .task-card.priority-low {
            border-left: 6px solid var(--success);
        }

        .task-card.status-completed {
            opacity: 0.85;
            background: #f8fdf9;
        }

        .task-card.status-completed .task-title {
            color: #5f6368;
        }

        /* Task Modal */
        .task-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s var(--ease);
        }

        .task-modal-overlay.active {
            display: flex;
        }

        .task-modal {
            background: var(--white);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--elev-card-lg);
            animation: slideUp 0.3s var(--ease);
            color: #333; /* Ensure text is dark */
        }

        .task-modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: #f8f9fa;
            border-radius: 20px 20px 0 0;
        }

        .task-modal-body {
            padding: 32px;
        }

        .task-modal-actions {
            padding: 24px 32px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8f9fa;
            border-radius: 0 0 20px 20px;
        }

        /* Form Styles for Add Task */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #202124; /* High contrast dark gray */
            font-size: 14px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dadce0; /* Thicker, visible border */
            border-radius: 8px;
            font-family: inherit;
            font-size: 15px;
            transition: all 0.2s;
            background-color: #ffffff !important; /* Force white bg */
            color: #202124 !important; /* Force dark text */
        }

        /* Modern styled select dropdown */
        .form-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%235f6368" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px;
        }

        .form-input::placeholder, 
        .form-textarea::placeholder {
            color: #5f6368; /* Darker placeholder for visibility */
            opacity: 1;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--azure);
            box-shadow: 0 0 0 4px rgba(20, 147, 255, 0.15);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.5;
        }

        .btn-primary {
            background: var(--azure);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }

        /* Calendar (date/time) modal */
        .calendar-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(6px);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .calendar-modal-overlay.active { display: flex; }
        .calendar-modal {
            background: var(--white);
            border-radius: 16px;
            width: 480px;
            max-width: 95vw;
            box-shadow: var(--elev-card-lg);
            overflow: hidden;
        }
        .calendar-modal-header {
            padding: 16px 20px;
            border-bottom: 2px solid var(--border);
            font-weight: 900;
            color: var(--cobalt);
        }
        .calendar-modal-body { padding: 20px; }
        .calendar-modal-actions {
            padding: 16px 20px;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-primary:hover {
            background: #0077e6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 119, 230, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #5f6368;
            border: 2px solid #dadce0;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #c1c3c7;
            color: #202124;
        }

        .btn-magic {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); /* Vivid Indigo/Violet */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
        }

        .btn-magic:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            filter: brightness(1.1);
        }

        .btn-magic:disabled {
            opacity: 0.7;
            cursor: wait;
            filter: grayscale(20%);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            padding: 32px 32px 24px;
            border-bottom: 2px solid var(--border);
        }

        .task-modal-close {
            background: var(--light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s var(--ease);
            flex-shrink: 0;
        }

        .task-modal-close:hover {
            background: var(--danger);
            color: var(--white);
            transform: rotate(90deg);
        }

        .task-modal-body {
            padding: 32px;
        }

        .task-modal-actions {
            padding: 24px 32px 32px;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .task-action-btn {
            flex: 1;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
            border: 2px solid;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .task-complete-btn {
            background: #E8F5E9;
            color: var(--success);
            border-color: var(--success);
        }

        .task-complete-btn:hover {
            background: var(--success);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .task-uncomplete-btn {
            background: #FFF9C4;
            color: #F57F17;
            border-color: #FBBC04;
        }

        .task-uncomplete-btn:hover {
            background: #FBBC04;
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .task-close-btn {
            background: var(--light);
            color: var(--cobalt);
            border-color: var(--border);
        }

        .task-close-btn:hover {
            background: var(--cobalt);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        /* ===== HOURS HISTORY TABLE ===== */
        .hours-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .hours-table th {
            background: var(--light);
            color: var(--cobalt);
            font-weight: 900;
            text-align: left;
            padding: 14px 16px;
            border-bottom: 2px solid var(--border);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hours-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .hours-table tr:hover {
            background: #F8F9FA;
        }

        /* ===== GHL EMBED STYLE CONTAINMENT ===== */
        /* Prevent GoHighLevel styles from bleeding into hours logging UI */
        #hoursModal,
        #hoursModal *,
        #hoursHistoryContainer,
        #hoursHistoryContainer * {
            box-sizing: border-box;
        }

        #hoursModal .task-modal {
            max-width: 600px !important;
            background: white !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }

        #hoursModal .form-input,
        #hoursModal .form-textarea {
            font-family: inherit !important;
            font-size: 14px !important;
            background: white !important;
            border: 1px solid #dadce0 !important;
        }

        #hoursModal button {
            font-family: inherit !important;
            cursor: pointer !important;
        }

        #hoursHistoryContainer {
            max-width: 100% !important;
            overflow-x: auto !important;
        }

        .hours-table {
            background: white !important;
            font-family: inherit !important;
        }

        .hours-table th,
        .hours-table td {
            background: inherit !important;
            color: inherit !important;
        }

        .hours-date {
            font-weight: 700;
            color: var(--cobalt);
            font-size: 14px;
        }

        .hours-amount {
            font-weight: 900;
            color: var(--azure);
            font-size: 18px;
        }

        .hours-summary {
            color: var(--cobalt);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .hours-details {
            font-size: 12px;
            color: #5f6368;
            line-height: 1.5;
        }

        .productivity-score {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-weight: 900;
            font-size: 18px;
            background: linear-gradient(135deg, var(--azure), var(--cobalt));
            color: var(--white);
            box-shadow: var(--elev-1);
        }

        .productivity-score.low {
            background: linear-gradient(135deg, #FFA726, #FB8C00);
        }

        .productivity-score.medium {
            background: linear-gradient(135deg, #FBBC04, #F9A825);
        }

        .productivity-score.high {
            background: linear-gradient(135deg, #66BB6A, #43A047);
        }

        .input-output-box {
            background: #F8F9FA;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 12px;
            line-height: 1.6;
        }

        .input-output-label {
            font-weight: 700;
            color: var(--cobalt);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }


        .task-title {
            font-weight: 900;
            font-size: 18px;
            color: var(--cobalt);
            margin-bottom: 4px;
        }

        .task-card.status-completed .task-title {
            text-decoration: line-through;
            color: #80868b;
        }

        .task-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-priority-badge,
        .task-status-badge,
        .task-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-high-badge {
            background: #FFEBEE;
            color: var(--danger);
        }

        .priority-medium-badge {
            background: #FFF9C4;
            color: #F57F17;
        }

        .priority-low-badge {
            background: #E8F5E9;
            color: var(--success);
        }

        .status-pending-badge {
            background: #E3F2FD;
            color: #1976D2;
        }

        .status-in-progress-badge {
            background: #FFF9C4;
            color: #F57F17;
        }

        .status-completed-badge {
            background: #E8F5E9;
            color: var(--success);
        }

        .type-document-badge {
            background: #FFEBEE;
            color: #D32F2F;
        }

        .type-text-badge {
            background: #E3F2FD;
            color: #1976D2;
        }

        .type-link-badge {
            background: #F3E5F5;
            color: #7B1FA2;
        }

        .task-content {
            color: #202124;
            font-size: 15px;
            line-height: 1.6;
            margin: 16px 0;
            white-space: pre-wrap;
        }

        .task-description {
            color: #5f6368;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .task-embed {
            width: 100%;
            min-height: 600px;
            border-radius: 12px;
            margin: 16px 0;
            border: 0; /* Match embed styling to avoid harsh borders */
            overflow: hidden;
            box-shadow: var(--elev-card);
        }

        .task-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--azure);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s var(--ease);
            cursor: pointer;
        }

        .task-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .task-footer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: #80868b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .task-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .task-category {
            display: inline-block;
            padding: 4px 10px;
            background: var(--light);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--cobalt);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: white;
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 320px;
            max-width: 450px;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-left: none;
            position: relative;
            overflow: hidden;
        }

        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
        }

        .toast.success::before { background: var(--success); }
        .toast.error::before { background: var(--danger); }
        .toast.info::before { background: var(--azure); }

        .toast-icon {
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { background: #dcfce7; color: var(--success); }
        .toast.error .toast-icon { background: #fee2e2; color: var(--danger); }
        .toast.info .toast-icon { background: #eff6ff; color: var(--azure); }

        .toast-message {
            flex: 1;
            color: #1f2937;
            font-weight: 600;
            font-size: 15px;
            line-height: 1.4;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        /* ===== CUSTOM MODAL DIALOG ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 99999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: slideUp 0.3s ease;
            position: relative;
            margin: auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-dialog-content {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-header {
            font-size: 22px;
            font-weight: 900;
            color: var(--cobalt);
            margin: 0;
            padding: 24px 32px;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-body {
            font-size: 15px;
            color: #5f6368;
            line-height: 1.6;
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 24px 32px;
            border-top: 2px solid #e5e7eb;
            background: white;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
        }

        .modal-btn-cancel {
            background: var(--light);
            color: var(--cobalt);
        }

        .modal-btn-cancel:hover {
            background: #ddd;
        }

        .modal-btn-confirm {
            background: var(--azure);
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #0a2a5a;
            transform: translateY(-1px);
            box-shadow: var(--elev-1);
        }

        .modal-btn-danger {
            background: var(--danger);
            color: white;
        }

        .modal-btn-danger:hover {
            background: #c62828;
            transform: translateY(-1px);
            box-shadow: var(--elev-1);
        }

        /* Delete button on cards */
        .card-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            color: var(--danger);
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s var(--ease);
        }

        .candidate-card {
            position: relative;
        }

        .candidate-card:hover .card-delete-btn {
            opacity: 1;
        }

        .card-delete-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* USER GATE MODAL */
        #userGate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a2a5a 0%, #051428 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
            backdrop-filter: blur(0);
        }

        #userGate.hidden {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            to { 
                opacity: 0;
                backdrop-filter: blur(10px);
            }
        }

        .user-gate-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 56px 48px;
            box-shadow: 
                0 30px 90px rgba(0,0,0,0.4),
                0 0 1px rgba(255,255,255,0.5) inset;
            max-width: 460px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            animation: cardEnter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s forwards;
            position: relative;
            overflow: hidden;
        }

        @keyframes cardEnter {
            to {
                transform: scale(1);
            }
        }

        .user-gate-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            to { left: 100%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .user-gate-logo {
            width: 96px;
            height: 96px;
            margin: 0 auto 24px;
            border-radius: 50%;
            box-shadow: 0 8px 24px rgba(10, 42, 90, 0.2);
            animation: logoPulse 2s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .user-gate-title {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }

        .user-gate-subtitle {
            font-size: 15px;
            color: #666;
            margin: 0 0 40px 0;
            font-weight: 500;
        }

        .user-gate-select-wrapper {
            position: relative;
            margin-bottom: 24px;
        }

        .user-gate-select-wrapper::after {
            content: '▼';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #0a2a5a;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .user-gate-select-wrapper:has(select:focus)::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .user-gate-select {
            width: 100%;
            padding: 18px 48px 18px 20px;
            font-size: 16px;
            font-weight: 600;
            color: #0a2a5a;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e3e8ef;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .user-gate-select:hover {
            border-color: #0a2a5a;
            background: white;
            box-shadow: 0 4px 12px rgba(10, 42, 90, 0.1);
            transform: translateY(-2px);
        }

        .user-gate-select:focus {
            outline: none;
            border-color: #0a2a5a;
            background: white;
            box-shadow: 
                0 0 0 4px rgba(10, 42, 90, 0.1),
                0 8px 20px rgba(10, 42, 90, 0.15);
            transform: translateY(-2px);
        }

        .user-gate-select option {
            padding: 12px;
            font-weight: 600;
        }

        .user-gate-btn {
            width: 100%;
            padding: 18px 24px;
            font-size: 16px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        .user-gate-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .user-gate-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .user-gate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 12px 28px rgba(10, 42, 90, 0.35),
                0 0 0 1px rgba(255,255,255,0.1) inset;
        }

        .user-gate-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(10, 42, 90, 0.3);
        }

        .user-gate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .user-gate-btn:disabled:hover::before {
            width: 0;
            height: 0;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(0);
            }
        }

        /* ===== MOBILE OPTIMIZATION ===== */
        @media (max-width: 768px) {
            /* Prevent horizontal scroll and layout breaks */
            html, body {
                overflow-x: hidden !important;
                width: 100% !important;
                max-width: 100vw !important;
            }
            
            #h2s-app {
                width: 100% !important;
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
            
            /* Layout & Spacing */
            .main {
                padding: var(--gap-2) !important;
                width: 100% !important;
                max-width: 100vw !important;
            }
            
            .h2s-head-row {
                padding: 12px var(--gap-2) !important;
                flex-direction: row !important;
                gap: var(--gap-1);
            }
            
            #h2s-app .app-content {
                padding: var(--gap-2) !important;
            }
            
            #h2s-app .workbench-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            #h2s-app .workbench-search {
                max-width: none;
            }

            .h2s-logo img {
                width: 40px !important;
                height: 40px !important;
            }

            .h2s-logo-text {
                font-size: 20px !important;
            }

            .logout-btn {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }

            /* Typography Sizing */
            .page-title {
                font-size: 20px !important;
                margin-bottom: var(--gap-2) !important;
            }
            
            .card-title {
                font-size: 18px !important;
            }
            
            .card {
                padding: var(--gap-2) !important;
                margin-bottom: var(--gap-2) !important;
            }

            /* Tabs - Horizontal Scroll */
            .tabs {
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                padding: 4px !important;
                margin-bottom: 20px !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
                gap: 8px !important;
                background: transparent !important;
                box-shadow: none !important;
                border: none !important;
            }
            .tabs::-webkit-scrollbar {
                display: none; /* Chrome/Safari */
            }
            .tab {
                white-space: nowrap !important;
                flex-shrink: 0 !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
                background: rgba(255,255,255,0.1) !important;
                color: rgba(255,255,255,0.7) !important;
                border: 1px solid rgba(255,255,255,0.2) !important;
                border-radius: 20px !important;
            }
            .tab.active {
                background: white !important;
                color: var(--cobalt) !important;
                border-color: white !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
                opacity: 1 !important;
            }

            /* Pipeline Columns - Stacked */
            .pipeline {
                grid-template-columns: 1fr !important;
                gap: var(--gap-2) !important;
            }
            
            .pipeline-column {
                min-height: auto !important;
                max-height: 500px !important;
                padding: var(--gap-2) !important;
            }

            /* Training Grid - Single Column */
            .training-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            /* Training Card Adjustments */
            .training-card {
                border-radius: 12px !important;
            }
            
            /* Stack header elements on small screens */
            .training-card .header-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }

            /* Tasks Header Stack */
            .tasks-header-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: var(--gap-2) !important;
            }
            
            .tasks-header-row button {
                width: 100% !important;
                justify-content: center !important;
            }
            
            /* Tasks Columns Stack */
            .tasks-columns {
                grid-template-columns: 1fr !important;
                gap: var(--gap-2) !important;
            }
            
            /* Prevent horizontal overflow */
            * {
                max-width: 100%;
            }
            
            .main,
            .card,
            #h2s-app .app-content {
                overflow-x: hidden;
                word-wrap: break-word;
            }

            /* Modals - Full Width */
            .modal-dialog {
                width: 95% !important;
                padding: 20px !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
            }
            
            .modal-header {
                font-size: 18px !important;
            }

            /* Toast Notifications */
            .toast {
                min-width: auto !important;
                width: 90% !important;
                left: 5% !important;
                right: 5% !important;
                bottom: 20px !important;
                top: auto !important;
                transform: none !important;
            }
            
            /* Offer Builder Mobile Layout */
            #offerbuilder-pane #offerBuilderMainGrid {
                grid-template-columns: 1fr !important;
                gap: var(--gap-2) !important;
            }
            
            #offerbuilder-pane #offerBuilderRightColumn {
                width: 100% !important;
            }
            
            /* Tables - Scroll Horizontally */
            .data-table-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px !important;
            }
        }

        /* ===== APP SHELL - GHL ISOLATION ===== */
        /* ===== GHL PARENT CONTAINER OVERRIDES ===== */
        /* Neutralize any width constraints from GoHighLevel parent wrappers */
        /* Target common GHL wrapper patterns */
        body > div:has(#h2s-app),
        [class*="container"]:has(#h2s-app),
        [class*="wrapper"]:has(#h2s-app),
        [class*="content"]:has(#h2s-app),
        [id*="container"]:has(#h2s-app),
        [id*="wrapper"]:has(#h2s-app),
        div[style*="max-width"]:has(#h2s-app),
        div[style*="width"]:has(#h2s-app) {
            max-width: none !important;
            width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        #h2s-app {
            all: initial;
            box-sizing: border-box;
            display: block !important;
            font-family: Archivo, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: var(--cobalt);
            color: var(--white);
            min-height: 100vh;
            position: relative !important;
            isolation: isolate;
            /* Force full width expansion - override GHL constraints */
            width: 100% !important;
            max-width: none !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            min-width: 100% !important;
            transform: none !important;
            zoom: 1 !important;
        }

        #h2s-app * {
            box-sizing: border-box;
        }

        /* App Top Bar */
        #h2s-app .app-topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--elev-card);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        #h2s-app .app-topbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #h2s-app .app-topbar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #h2s-app .app-topbar-logo img {
            width: 40px;
            height: 40px;
        }

        #h2s-app .app-topbar-title {
            font-weight: 900;
            font-size: 18px;
            color: var(--cobalt);
            text-transform: lowercase;
        }

        #h2s-app .app-topbar-area {
            font-weight: 700;
            font-size: 16px;
            color: var(--cobalt);
            padding-left: 16px;
            border-left: 2px solid var(--border);
        }

        #h2s-app .app-topbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* App Sidebar */
        #h2s-app .app-sidebar {
            position: fixed;
            left: 0;
            top: 52px;
            width: 240px;
            height: calc(100vh - 52px);
            background: var(--white);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            z-index: 999;
        }

        #h2s-app .app-sidebar-nav {
            padding: 16px 0;
        }

        #h2s-app .app-sidebar-nav-item {
            display: block;
            padding: 12px 24px;
            color: var(--cobalt);
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            transition: all 0.2s var(--ease);
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        #h2s-app .app-sidebar-nav-item:hover {
            background: var(--light);
            border-left-color: var(--azure);
        }

        #h2s-app .app-sidebar-nav-item.active {
            background: rgba(10, 42, 90, 0.05);
            border-left-color: var(--cobalt);
            color: var(--cobalt);
            font-weight: 700;
        }

        /* App Main Content */
        #h2s-app .app-main {
            margin-left: 240px;
            margin-top: 52px;
            min-height: calc(100vh - 52px);
            background: var(--cobalt);
            width: calc(100% - 240px) !important;
            max-width: none !important;
            box-sizing: border-box !important;
        }

        #h2s-app .app-content {
            padding: var(--page-pad);
            max-width: none !important;
            width: 100% !important;
            box-sizing: border-box !important;
            /* Ensure content starts at top - no extra spacing */
            padding-top: var(--page-pad) !important;
            margin-top: 0 !important;
        }

        /* Workbench Header (Pipeline) */
        #h2s-app .workbench-header {
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--gap-2);
            margin-bottom: var(--gap-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--gap-2);
            box-shadow: var(--elev-card);
        }

        #h2s-app .workbench-search {
            flex: 1;
            max-width: 400px;
        }

        #h2s-app .workbench-search input {
            width: 100%;
            height: var(--control-h);
            padding: 0 var(--gap-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.15s var(--ease);
        }
        
        #h2s-app .workbench-search input:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
            border-color: var(--azure);
        }

        #h2s-app .workbench-actions {
            display: flex;
            align-items: center;
            gap: var(--gap-1);
        }

        #h2s-app .workbench-actions .btn {
            height: var(--control-h);
            padding: 0 var(--gap-2);
            font-size: 14px;
            transition: all 0.15s var(--ease);
            font-weight: 700;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s var(--ease);
        }

        /* Detail Drawer */
        #h2s-app .detail-drawer {
            position: fixed;
            right: 0;
            top: 52px;
            width: 400px;
            height: calc(100vh - 52px);
            background: var(--white);
            box-shadow: var(--elev-2);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s var(--ease);
            overflow-y: auto;
        }

        #h2s-app .detail-drawer.open {
            transform: translateX(0);
        }

        #h2s-app .detail-drawer-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #h2s-app .detail-drawer-title {
            font-weight: 900;
            font-size: 20px;
            color: var(--cobalt);
        }

        #h2s-app .detail-drawer-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 24px;
            color: var(--cobalt);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        #h2s-app .detail-drawer-close:hover {
            background: var(--light);
        }

        #h2s-app .detail-drawer-body {
            padding: 24px;
        }

        #h2s-app .detail-section {
            margin-bottom: 24px;
        }

        #h2s-app .detail-section-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--cobalt);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        #h2s-app .detail-field {
            margin-bottom: 16px;
        }

        #h2s-app .detail-field-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        #h2s-app .detail-field-value {
            font-size: 15px;
            color: var(--cobalt);
            font-weight: 600;
        }

        /* Hide old header/tabs when in app shell */
        #h2s-app .h2s-header,
        #h2s-app .tabs {
            display: none;
        }

        #h2s-app .main {
            padding: 0;
            max-width: none;
        }

        #h2s-app .page-title {
            display: none;
        }

        /* Ensure pane display logic works correctly */
        /* All panes must be in the same container (app-content) for consistent viewport */
        #h2s-app .app-content {
            position: relative;
            width: 100%;
            min-height: calc(100vh - 52px);
            box-sizing: border-box;
            /* Container for all panes - ensures same viewport */
            overflow: visible;
            /* Ensure content starts at top */
            padding-top: 0;
            margin-top: 0;
        }

        /* All panes share the same container and viewport - inactive panes take NO space */
        #h2s-app .pane {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            width: 0 !important;
            height: 0 !important;
            max-width: 0 !important;
            max-height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            /* Completely remove from layout flow */
            position: absolute !important;
            top: -9999px !important;
            left: -9999px !important;
        }

        #h2s-app .pane.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            animation: fadeIn 0.3s var(--ease);
            /* Active pane takes normal flow position at top of container */
            position: relative !important;
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            max-height: none !important;
            top: 0 !important;
            left: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: visible !important;
        }

        /* Improved Pipeline Density */
        #h2s-app #pipeline-pane {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            display: block !important;
        }

        #h2s-app .workbench-header {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        #h2s-app .pipeline {
            display: grid !important;
            grid-template-columns: repeat(4, 1fr) !important;
            gap: var(--gap-2);
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            min-width: 0 !important;
        }

        #h2s-app .pipeline-column {
            min-height: 500px;
            max-height: calc(100vh - 200px);
            width: 100% !important;
            min-width: 0 !important;
            max-width: none !important;
            box-sizing: border-box !important;
            flex: 1 1 0 !important;
        }

        #h2s-app .candidate-card {
            padding: 12px;
            margin-bottom: 8px;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            #h2s-app .app-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s var(--ease);
            }

            #h2s-app .app-sidebar.open {
                transform: translateX(0);
            }

            #h2s-app .app-main {
                margin-left: 0;
                width: 100% !important;
            }

            #h2s-app .pipeline {
                grid-template-columns: 1fr !important;
            }
        }

        /* Desktop: Ensure pipeline expands on wide screens */
        @media (min-width: 1025px) {
            #h2s-app .app-main {
                width: calc(100% - 240px) !important;
                max-width: none !important;
            }

            #h2s-app .pipeline {
                grid-template-columns: repeat(4, 1fr) !important;
                width: 100% !important;
            }

            /* Allow horizontal scroll if viewport is too narrow for 4 columns */
            #h2s-app #pipeline-pane {
                overflow-x: auto;
                overflow-y: visible;
            }

            #h2s-app .pipeline {
                min-width: min(100%, 1200px);
            }
        }
        
        /* Offer Builder Messaging Tabs */
        .messaging-tab-content {
            display: block;
        }
    </style>
    <!-- jsPDF Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body style="background: #0a2a5a !important; background-color: #0a2a5a !important;">

    <!-- USER SELECTION GATE -->
    <div id="userGate">
        <div class="user-gate-card">
            <img class="user-gate-logo" 
                 src="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png" 
                 alt="Home2Smart">
            <h2 class="user-gate-title">Welcome to Home2Smart</h2>
            <p class="user-gate-subtitle">Select your profile to continue</p>
            
            <div class="user-gate-select-wrapper">
                <select id="userSelect" class="user-gate-select">
                    <option value="">-- Select Your Name --</option>
                    <option value="ROSEL">Rosel</option>
                </select>
            </div>
            
            <button id="userGateBtn" class="user-gate-btn" disabled onclick="enterDashboard()">
                <span>Enter Dashboard</span>
            </button>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- CUSTOM MODAL DIALOG -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-dialog">
            <div class="modal-header" id="modalHeader">Confirm</div>
            <div class="modal-body" id="modalBody">Are you sure?</div>
            <div class="modal-actions" id="modalActions">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- APP SHELL WRAPPER -->
    <div id="h2s-app">
        <!-- TOP BAR -->
        <div class="app-topbar">
            <div class="app-topbar-left">
                <div class="app-topbar-logo">
                    <img src="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png" 
                         alt="Home2Smart Logo">
                    <span class="app-topbar-title">hiring dashboard</span>
                </div>
                <div class="app-topbar-area" id="currentAreaTitle">Pipeline</div>
            </div>
            <div class="app-topbar-right">
                <button class="logout-btn" onclick="logoutUser()" style="display: none;" id="logoutBtn">
                    Logout
                </button>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="app-sidebar">
            <nav class="app-sidebar-nav">
                <a class="app-sidebar-nav-item active" data-tab="pipeline" onclick="switchToTab('pipeline')">
                    Pipeline
                </a>
                <a class="app-sidebar-nav-item" data-tab="screening" onclick="switchToTab('screening')">
                    Screening Form
                </a>
                <a class="app-sidebar-nav-item" data-tab="techinterview" onclick="switchToTab('techinterview')">
                    Tech Interview
                </a>
                <a class="app-sidebar-nav-item" data-tab="hours" onclick="switchToTab('hours')">
                    Log Hours
                </a>
                <a class="app-sidebar-nav-item" data-tab="reports" onclick="switchToTab('reports')">
                    Candidate Review
                </a>
                <a class="app-sidebar-nav-item" data-tab="training" onclick="switchToTab('training')">
                    Training
                </a>
                <a class="app-sidebar-nav-item" data-tab="tasks" onclick="switchToTab('tasks')">
                    Tasks
                </a>
                <a class="app-sidebar-nav-item" data-tab="deliverables" onclick="switchToTab('deliverables')">
                    Deliverables
                </a>
                <a class="app-sidebar-nav-item" data-tab="admin" onclick="switchToTab('admin')">
                    📊 Admin Dashboard
                </a>
                <a class="app-sidebar-nav-item" data-tab="offerbuilder" onclick="switchToTab('offerbuilder')">
                    🎯 Offer Builder
                </a>
            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="app-main">
            <div class="app-content">
                <!-- TABS (hidden, kept for compatibility) -->
                <nav class="tabs" style="display: none;">
                    <button class="tab active" data-tab="pipeline">Pipeline</button>
                    <button class="tab" data-tab="screening">Screening Form</button>
                    <button class="tab" data-tab="techinterview">Tech Interview Form</button>
                    <button class="tab" data-tab="hours">Log Hours</button>
                    <button class="tab" data-tab="reports">Candidate Review</button>
                    <button class="tab" data-tab="training">Training</button>
                    <button class="tab" data-tab="tasks">Tasks</button>
                    <button class="tab" data-tab="deliverables">Deliverables</button>
                </nav>

                <!-- PIPELINE PANE -->
                <div class="pane active" id="pipeline-pane">
                    <!-- Workbench Header -->
                    <div class="workbench-header">
                        <div class="workbench-search">
                            <input type="text" id="pipelineSearch" placeholder="Search candidates..." oninput="filterPipeline()">
                        </div>
                        <div class="workbench-actions">
                            <button onclick="bulkCleanupPipeline()" class="btn" style="background: var(--danger); color: white;">
                                Bulk Cleanup
                            </button>
                        </div>
                    </div>
                    <div id="pipelineContainer" class="pipeline">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- SCREENING FORM PANE -->
                <div class="pane" id="screening-pane">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 4px;">H2S Screening Form</h2>
                        <p style="color: var(--cobalt); margin: 0;">Initial VA-led screening form for service tech candidates.</p>
                    </div>
                    <button onclick="refreshForm('inline-JUTMlrebPo2W3qaNamNv')" class="btn" style="padding: 10px 20px; font-size: 14px;">
                        Reset Form
                    </button>
                </div>
                <iframe 
                    src="https://api.leadconnectorhq.com/widget/form/JUTMlrebPo2W3qaNamNv"
                    style="width:100%;height:100%;border:none;border-radius:3px"
                    id="inline-JUTMlrebPo2W3qaNamNv" 
                    data-layout="{'id':'INLINE'}"
                    data-trigger-type="alwaysShow"
                    data-trigger-value=""
                    data-activation-type="alwaysActivated"
                    data-activation-value=""
                    data-deactivation-type="neverDeactivate"
                    data-deactivation-value=""
                    data-form-name="H2S Screening"
                    data-height="1177"
                    data-layout-iframe-id="inline-JUTMlrebPo2W3qaNamNv"
                    data-form-id="JUTMlrebPo2W3qaNamNv"
                    title="H2S Screening">
                </iframe>
                <script src="https://link.msgsndr.com/js/form_embed.js"></script>
            </div>
                </div>

                <!-- TECH INTERVIEW FORM PANE -->
                <div class="pane" id="techinterview-pane">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 4px;">Tech Interview Form</h2>
                        <p style="color: var(--cobalt); margin: 0;">Deep VA interview phase for technical assessment.</p>
                    </div>
                    <button onclick="refreshForm('inline-VXWUGtxOQRUGheIn7u4p')" class="btn" style="padding: 10px 20px; font-size: 14px;">
                        Reset Form
                    </button>
                </div>
                <iframe
                    src="https://api.leadconnectorhq.com/widget/form/VXWUGtxOQRUGheIn7u4p"
                    style="width:100%;height:100%;border:none;border-radius:3px"
                    id="inline-VXWUGtxOQRUGheIn7u4p" 
                    data-layout="{'id':'INLINE'}"
                    data-trigger-type="alwaysShow"
                    data-trigger-value=""
                    data-activation-type="alwaysActivated"
                    data-activation-value=""
                    data-deactivation-type="neverDeactivate"
                    data-deactivation-value=""
                    data-form-name="Tech Interview"
                    data-height="1559"
                    data-layout-iframe-id="inline-VXWUGtxOQRUGheIn7u4p"
                    data-form-id="VXWUGtxOQRUGheIn7u4p"
                    title="Tech Interview">
                </iframe>
                <script src="https://link.msgsndr.com/js/form_embed.js"></script>
            </div>
                </div>

                <!-- HOURS PANE -->
                <div class="pane" id="hours-pane">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 4px;">Hours Tracking</h2>
                        <p style="color: var(--cobalt); margin: 0;">Log your daily work with AI-powered productivity analysis.</p>
                    </div>
                    <button onclick="openHoursModal()" class="btn" style="padding: 14px 24px; font-size: 16px; background: var(--success); color: white;">
                        Log Today's Hours
                    </button>
                </div>
                
                <div id="hoursHistoryContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- HOURS LOGGING MODAL -->
        <div class="task-modal-overlay" id="hoursModal" onclick="closeHoursModal(event)">
            <div class="task-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                <div class="task-modal-header">
                    <div style="flex: 1;">
                        <div class="task-title" style="font-size: 24px; margin-bottom: 8px;">Log Hours</div>
                        <div style="color: var(--cobalt); font-size: 14px;">Record your work hours: Enter start and end times to calculate total hours worked</div>
                    </div>
                    <button class="task-modal-close" onclick="closeHoursModal()">✕</button>
                </div>
                <div class="task-modal-body">
                    <form id="hoursForm">
                        <div class="form-row" style="margin-bottom: 20px; align-items: flex-end; gap: 12px;">
                            <div class="form-group" style="flex: 1.5;">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input" id="hoursDate" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Start</label>
                                <input type="time" class="form-input" id="hoursStart" onchange="calculateDuration()" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">End</label>
                                <input type="time" class="form-input" id="hoursEnd" onchange="calculateDuration()" required>
                            </div>
                            <div class="form-group" style="flex: 0.8; text-align: center; background: #f1f3f4; border-radius: 8px; padding: 8px; height: 46px; display: flex; flex-direction: column; justify-content: center;" title="Calculated automatically from start and end times">
                                <div style="font-size: 10px; color: #5f6368; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Hours Worked</div>
                                <div id="durationDisplay" style="font-size: 16px; font-weight: 900; color: var(--azure); line-height: 1;">0h</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">1. What specific tasks did you complete today?</label>
                            <textarea class="form-textarea" id="hoursTasks" rows="4" placeholder="List the candidates screened, interviews booked, or admin tasks finished..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">2. What was your biggest win or learning today?</label>
                            <textarea class="form-textarea" id="hoursLearned" rows="3" placeholder="e.g., 'Learned how to handle objection X' or 'Found a great candidate for the North region'..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">3. Any blockers, questions, or support needed?</label>
                            <textarea class="form-textarea" id="hoursBlockers" rows="2" placeholder="e.g., 'Need access to X tool' or 'Unsure about Y process' (Leave blank if none)"></textarea>
                        </div>
                        
                        <div style="margin-top: 8px; color: #5f6368; font-size: 13px; font-style: italic;">
                            * Detailed logs help us track progress and remove blockers faster.
                        </div>
                    </form>
                </div>
                <div class="task-modal-actions">
                    <button type="button" class="task-action-btn task-close-btn" onclick="closeHoursModal()">Cancel</button>
                    <button type="button" class="task-action-btn task-complete-btn" onclick="submitHours()">Log Hours</button>
                </div>
            </div>
                </div>

                <!-- REPORTS PANE -->
                <div class="pane" id="reports-pane">
            <div class="card">
                <h2 class="card-title">👥 Candidate Review</h2>
                <p style="color: var(--cobalt); margin-bottom: 20px;">AI-powered candidate evaluations with manual review capabilities.</p>
                
                <!-- Filter Buttons -->
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="pending" onclick="filterProfiles('pending')">
                        ⏳ Pending Review
                    </button>
                    <button class="filter-btn" data-filter="passed" onclick="filterProfiles('passed')">
                        ✅ Passed
                    </button>
                    <button class="filter-btn" data-filter="all" onclick="filterProfiles('all')">
                        📋 All Candidates
                    </button>
                    <button class="filter-btn" data-filter="failed" onclick="filterProfiles('failed')">
                        ❌ Failed
                    </button>
                </div>
                
                <div id="aiProfilesContainer">
                    <div class="spinner"></div>
                </div>
            </div>
                </div>

                <!-- TRAINING PANE -->
                <div class="pane" id="training-pane">
            <!-- Minimal Progress Summary -->
            <div class="card" id="knowledgeProfileCard" style="margin-bottom: 24px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 4px;">Your Training Progress</h2>
                        <p style="color: var(--cobalt); margin: 0; font-size: 14px;">Keep completing trainings to build your skills</p>
                    </div>
                    <div style="display: flex; gap: 24px; align-items: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 900; color: var(--azure);" id="totalTrainings">0</div>
                            <div style="font-size: 12px; color: #666;">Completed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 900; color: var(--success);" id="learningHours">0h</div>
                            <div style="font-size: 12px; color: #666;">Learning Time</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Training Resources Card -->
            <div class="card">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 4px;">Training Resources</h2>
                        <p style="color: var(--cobalt); margin: 0;">Complete trainings to build your knowledge base</p>
                    </div>
                    <button onclick="toggleAdminPanel()" class="btn" style="padding: 10px 20px; font-size: 14px; background: #eff6ff; color: var(--azure); border: 1px solid #bfdbfe; font-weight: 700; border-radius: 10px; transition: all 0.2s;">
                        ⚙️ Manage Training
                    </button>
                </div>

                <!-- Learning Path Tiers -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <button class="tier-btn active" data-tier="all" onclick="filterTrainingByTier('all')" style="padding: 20px; border-radius: 16px; border: 2px solid #0a2a5a; background: #0a2a5a; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(10,42,90,0.2);">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <div style="font-size: 16px;">All Training</div>
                    </button>
                    <button class="tier-btn" data-tier="Foundation" onclick="filterTrainingByTier('Foundation')" style="padding: 20px; border-radius: 16px; border: 3px solid #e0e0e0; background: white; color: var(--cobalt); font-weight: 700; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 8px;">🏗️</div>
                        <div style="font-size: 16px;">Foundation</div>
                        <div style="font-size: 12px; font-weight: 400; color: #666; margin-top: 4px;">Business basics, systems, ops</div>
                    </button>
                    <button class="tier-btn" data-tier="Core Skills" onclick="filterTrainingByTier('Core Skills')" style="padding: 20px; border-radius: 16px; border: 3px solid #e0e0e0; background: white; color: var(--cobalt); font-weight: 700; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 8px;">💼</div>
                        <div style="font-size: 16px;">Core Skills</div>
                        <div style="font-size: 12px; font-weight: 400; color: #666; margin-top: 4px;">Marketing, offers, customer work</div>
                    </button>
                    <button class="tier-btn" data-tier="Advanced" onclick="filterTrainingByTier('Advanced')" style="padding: 20px; border-radius: 16px; border: 3px solid #e0e0e0; background: white; color: var(--cobalt); font-weight: 700; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 8px;">🚀</div>
                        <div style="font-size: 16px;">Advanced</div>
                        <div style="font-size: 12px; font-weight: 400; color: #666; margin-top: 4px;">Web design, AI tools, tech skills</div>
                    </button>
                </div>

                <!-- Admin Panel (Hidden by default) -->
                <div id="trainingAdminPanel" style="display: none; margin-bottom: 24px; padding: 32px; background: linear-gradient(135deg, #0a2a5a 0%, #144a8a 100%); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h3 style="color: white; margin: 0; font-size: 24px; margin-bottom: 4px;">🔧 Training Management Console</h3>
                            <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">Upload videos, create SOPs, manage all training content</p>
                        </div>
                        <button onclick="toggleAdminPanel()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            ✕ Close
                        </button>
                    </div>
                    
                    <!-- Quick Add Form -->
                    <form id="newTrainingForm" onsubmit="submitNewTraining(event)" style="background: white; padding: 32px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.12);">
                        <h4 style="color: var(--cobalt); margin-bottom: 24px; font-size: 22px; font-weight: 700;">➕ Upload New Training</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Title -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Video Title</label>
                                <input type="text" id="newTrainingTitle" placeholder="e.g., How to Create Winning Marketing Offers" required style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; transition: all 0.2s; font-family: inherit;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>

                            <!-- Loom URL -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Loom Video URL</label>
                                <input type="url" id="newTrainingURL" placeholder="https://loom.com/share/abc123..." required style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; transition: all 0.2s; font-family: monospace;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                <p style="font-size: 12px; color: #999; margin-top: 6px; margin-bottom: 0;">💡 Copy the share link from your Loom video</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Learning Category -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Training Category</label>
                                <select id="newTrainingCategory" required style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                    <option value="Marketing">📈 Marketing & Lead Generation</option>
                                    <option value="CRM">💼 CRM & Sales Management</option>
                                    <option value="Technical">🔧 Technical Implementation</option>
                                    <option value="Operations">⚙️ Operations & Fulfillment</option>
                                    <option value="Home2Smart">🏠 Home2Smart</option>
                                </select>
                                <p style="font-size: 12px; color: #999; margin-top: 6px; margin-bottom: 0;">💡 Choose the category that best fits this training</p>
                            </div>

                            <!-- Duration -->
                            <div style="margin-bottom: 28px;">
                                <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Video Length (minutes)</label>
                                <input type="number" id="newTrainingDuration" placeholder="e.g., 15" min="1" style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; transition: all 0.2s;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                        </div>

                        <!-- Optional: Description -->
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Description <span style="font-weight: 400; text-transform: none; color: #999;">(Optional)</span></label>
                            <textarea id="newTrainingDescription" rows="3" placeholder="Brief overview of what's covered..." style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; font-family: inherit; resize: vertical; transition: all 0.2s;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"></textarea>
                        </div>

                        <button type="submit" style="width: 100%; padding: 18px; background: linear-gradient(135deg, var(--azure) 0%, #667eea 100%); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 17px; cursor: pointer; box-shadow: 0 6px 20px rgba(20, 147, 255, 0.4); transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(20, 147, 255, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(20, 147, 255, 0.4)'">
                            ✅ Upload Training Video
                        </button>
                    </form>

                    <!-- Manage Existing Resources -->
                    <div style="background: white; padding: 28px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                        <h4 style="color: var(--cobalt); margin-bottom: 16px; font-size: 18px;">📑 Manage Existing Resources</h4>
                        <div id="adminTrainingList">
                            <div class="spinner"></div>
                        </div>

                <!-- Smart Filter Tabs -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
                    <button class="training-filter-tab" data-filter="recommended" onclick="filterTrainingResources('recommended')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                        Recommended for You <span id="recommendedCount" style="background: #e5e7eb; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
                    </button>
                    <button class="training-filter-tab" data-filter="inprogress" onclick="filterTrainingResources('inprogress')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                        In Progress <span id="inprogressCount" style="background: #e5e7eb; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
                    </button>
                    <button class="training-filter-tab active" data-filter="all" onclick="filterTrainingResources('all')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid #0a2a5a; color: #0a2a5a; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                        All Resources <span id="allCount" style="background: #0a2a5a; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
                    </button>
                </div>
                    </div>
                </div>

                <!-- Training Resources Grid -->
                <div id="trainingContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

                <!-- DELIVERABLES PANE -->
                <div class="pane" id="deliverables-pane">
            <div style="display: flex; gap: var(--gap-2); margin-bottom: var(--gap-2); flex-wrap: wrap;">
                <button class="btn" onclick="switchDeliverablesView('submission')" id="deliverablesTabSubmission" style="background: var(--cobalt); color: white;">
                    Submit
                </button>
                <button class="btn" onclick="switchDeliverablesView('review')" id="deliverablesTabReview">
                    Review Queue
                </button>
                <button class="btn" onclick="switchDeliverablesView('library')" id="deliverablesTabLibrary">
                    Library
                </button>
            </div>
            
            <!-- Submission View -->
            <div id="deliverablesSubmissionView" class="deliverables-view">
                <div class="card">
                    <h2 class="card-title">Submit Deliverable</h2>
                    <form id="deliverableSubmissionForm" onsubmit="submitDeliverable(event)">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--cobalt);">Title</label>
                            <input type="text" id="deliverableTitle" required style="width: 100%; height: 40px; padding: 0 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--cobalt);">Description</label>
                            <textarea id="deliverableDescription" required style="width: 100%; min-height: 120px; padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; font-family: inherit;"></textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--cobalt);">Attach File (optional)</label>
                            <div id="deliverableFileUpload" style="border: 2px dashed var(--border); border-radius: var(--radius); padding: var(--gap-2); text-align: center; background: var(--surface-2); cursor: pointer; transition: all 0.2s;" 
                                 ondrop="handleFileDrop(event)" 
                                 ondragover="handleDragOver(event)" 
                                 ondragleave="handleDragLeave(event)"
                                 onclick="document.getElementById('deliverableFileInput').click()">
                                <input type="file" id="deliverableFileInput" style="display: none;" onchange="handleFileSelect(event)" multiple>
                                <div id="deliverableFileDisplay" style="font-size: 14px; color: var(--muted);">
                                    <div style="margin-bottom: 8px;">📎 Drag and drop files here, or click to browse</div>
                                    <div style="font-size: 12px; color: var(--muted);">Supports multiple files</div>
                                </div>
                                <div id="deliverableFileList" style="margin-top: var(--gap-1); text-align: left; display: none;"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn" style="background: var(--cobalt); color: white;">
                            Submit for Review
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Review Queue View -->
            <div id="deliverablesReviewView" class="deliverables-view" style="display: none;">
                <div id="deliverablesReviewContainer">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <!-- Library View -->
            <div id="deliverablesLibraryView" class="deliverables-view" style="display: none;">
                <div id="deliverablesLibraryContainer">
                    <div class="spinner"></div>
                </div>
            </div>
                </div>

                <!-- TASKS PANE -->
                <div class="pane" id="tasks-pane">
            <div class="card">
                <div class="tasks-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 class="card-title">Tasks</h2>
                        <p style="color: var(--cobalt); margin: 0;">Active tasks, documents, and action items.</p>
                    </div>
                    <button onclick="openAddTaskModal()" class="btn" style="padding: 10px 20px; font-size: 14px; background: var(--azure); color: white;">
                        + Add Task
                    </button>
                </div>
                <div id="tasksContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

                <!-- ADMIN DASHBOARD PANE -->
                <div class="pane" id="admin-pane">
                    <div style="max-width: 1600px; margin: 0 auto; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <h2 style="font-size: 28px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">Admin Dashboard</h2>
                                <p style="color: #6b7280; margin: 0; font-size: 14px;">Comprehensive overview of operations, deliverables, training, and productivity metrics</p>
            </div>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <select id="adminDateRange" onchange="adminDashboard.refresh()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px; background: white; color: var(--cobalt); cursor: pointer;">
                                    <option value="all">All Time</option>
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                </select>
                                <button onclick="adminDashboard.refresh()" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    ↻ Refresh
                                </button>
                            </div>
                        </div>
                        <div id="adminDashboardContent">
                <div class="spinner"></div>
                        </div>
                    </div>
            </div>

                <!-- OFFER BUILDER PANE -->
                <!-- 
                    DIAGNOSTIC: Pane Root Identification
                    ====================================
                    All pane roots use class="pane" with id="{tabname}-pane"
                    Tab switching: switchToTab() function hides ALL panes (display:none), then shows only target pane (display:block + .active class)
                    Pane roots found:
                    - #screening-pane, #techinterview-pane, #hours-pane, #reports-pane, #training-pane
                    - #deliverables-pane, #tasks-pane, #admin-pane, #offerbuilder-pane
                    Each pane is completely isolated - no shared DOM or event listeners between panes.
                    CSS scoping: All Offer Builder styles must be scoped to #offerbuilder-pane to prevent cross-tab bleed.
                -->
                <div class="pane" id="offerbuilder-pane">
                    <div style="max-width: 1600px; margin: 0 auto; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <h2 style="font-size: 28px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">Build Your Offer</h2>
                                <p style="color: #6b7280; margin: 0; font-size: 14px;">Create service packages and bundles. Add services, set pricing, and generate a complete offer brief.</p>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <button onclick="offerBuilder.showHelp()" class="btn" style="padding: 8px 16px; font-size: 13px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    How to Use
                                </button>
                                <button onclick="offerBuilder.recalculateOffer()" id="offerBuilderRecalcBtn" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Recalculate
                                </button>
                                <span id="offerBuilderLastUpdate" style="padding: 8px 12px; font-size: 12px; color: #6b7280; display: none;"></span>
                                <button onclick="offerBuilder.saveOffer()" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Save Offer
                                </button>
                                <button onclick="offerBuilder.generateBrief()" id="offerBuilderGenerateBriefBtn" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Generate Brief
                                </button>
                                <button onclick="offerBuilder.markReady()" id="offerBuilderMarkReadyBtn" class="btn" style="padding: 8px 16px; font-size: 13px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: none;">
                                    Mark Ready
                                </button>
                                <button onclick="offerBuilder.generateSampleOffer()" class="btn" style="padding: 8px 16px; font-size: 13px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Generate Sample Offer
                            </button>
                        </div>
                        </div>
                        
                        <!-- Build Order Strip -->
                        <div id="offerBuilderBuildOrder" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                            <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                    <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--cobalt);">
                                        <span id="buildOrderServices" style="font-size: 16px;">○</span>
                                        <span>Add services</span>
                                    </div>
                                    <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
                                    <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--cobalt);">
                                        <span id="buildOrderPricing" style="font-size: 16px;">○</span>
                                        <span>Choose pricing</span>
                                    </div>
                                    <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
                                    <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--cobalt);">
                                        <span id="buildOrderMessaging" style="font-size: 16px;">○</span>
                                        <span>Fill messaging</span>
                                    </div>
                                    <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
                                    <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--cobalt);">
                                        <span id="buildOrderStandards" style="font-size: 16px;">○</span>
                                        <span>Review Standards</span>
                                    </div>
                                    <div style="width: 1px; height: 20px; background: #e5e7eb;"></div>
                                    <div style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--cobalt);">
                                        <span id="buildOrderBrief" style="font-size: 16px;">○</span>
                                        <span>Generate Brief</span>
                                    </div>
                                </div>
                        </div>
                    </div>

                    <!-- Main Content Container - Centered with max-width -->
                    <div style="max-width: 1400px; margin: 0 auto; padding: 0 24px;">
                        
                        <!-- 2-COLUMN GRID LAYOUT -->
                        <div id="offerBuilderMainGrid" style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; align-items: start;">
                            
                            <!-- ========== LEFT COLUMN ========== -->
                            <div style="display: flex; flex-direction: column; gap: 20px; min-width: 0;">
                                
                                <!-- Offer Name -->
                                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Offer Name <span style="color: #ef4444;">*</span></label>
                                    <input type="text" id="offerBuilderName" placeholder="e.g., Spring Security Bundle" oninput="offerBuilder.updateOfferName(this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                    <div id="offerBuilderNameGuidance" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: none;">Enter a clear, descriptive offer name</div>
                                </div>

                                <!-- SET YOUR PRICE - MINIMALISTIC SECTION -->
                                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px; flex-wrap: wrap;">
                                        <div style="flex: 0 0 auto;">
                                            <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">Offer Price</div>
                                            <div style="font-size: 11px; color: #9ca3af;">What customers will pay</div>
                                        </div>
                                        
                                        <div style="display: flex; align-items: center; gap: 12px; flex: 1; justify-content: flex-end;">
                                            <div style="position: relative; flex: 0 0 auto;">
                                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; font-weight: 600; color: #9ca3af; pointer-events: none;">$</span>
                                                <input type="number" id="offerBuilderDirectPrice" min="0" step="0.01" placeholder="299.00" oninput="offerBuilder.handleDirectPriceInput(this.value)" style="width: 140px; padding: 10px 12px 10px 28px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 18px; font-weight: 600; color: var(--cobalt); text-align: right; transition: all 0.2s;" onfocus="this.style.borderColor='var(--cobalt)'; this.style.boxShadow='0 0 0 3px rgba(10,42,90,0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                                            </div>
                                            <button onclick="offerBuilder.applyDirectPrice()" style="padding: 10px 18px; background: var(--cobalt); color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#1a4a8a'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='var(--cobalt)'; this.style.transform='translateY(0)'">
                                                Set Price
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="offerBuilderPriceHelp" style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 6px; font-size: 11px; color: #6b7280; display: none;">
                                        <!-- Dynamic help text will appear here -->
                                    </div>
                                    
                                    <div id="offerBuilderCurrentPrice" style="margin-top: 12px; padding: 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; display: none;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 11px; color: #0369a1; margin-bottom: 2px;">Current Offer Price</div>
                                                <div id="offerBuilderCurrentPriceDisplay" style="font-size: 20px; font-weight: 700; color: var(--cobalt);">$0</div>
                                            </div>
                                            <button onclick="offerBuilder.clearOfferPrice()" style="padding: 6px 12px; background: white; color: #6b7280; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.borderColor='#ef4444'; this.style.color='#ef4444'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#6b7280'">
                                                Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Line Items -->
                                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <div>
                                            <h3 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 4px 0;">What's Included</h3>
                                            <p style="font-size: 12px; color: #6b7280; margin: 0;">Services in this offer</p>
                                        </div>
                                        <button onclick="offerBuilder.showAddServiceModal()" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                            + Add Service
                                        </button>
                                    </div>
                                    <div style="background: #fef3c7; border-left: 3px solid #f59e0b; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                                        <div style="font-size: 11px; color: #92400e; line-height: 1.5;">
                                            <strong style="color: #b45309;">💡 Tip:</strong> Your offer price is set above. Add services to describe what's included.
                                        </div>
                                    </div>
                                    <div id="offerBuilderLineItems" style="display: flex; flex-direction: column; gap: 16px;"></div>
                                    <div id="offerBuilderEmptyState" style="text-align: center; padding: 60px 20px; color: #6b7280;">
                                        <div style="font-size: 16px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">No services added yet</div>
                                        <div style="font-size: 14px;">Click "Add Service" to start building your offer</div>
                                    </div>
                                </div>

                                <!-- Pricing Strategy (Optional/Advanced) -->
                                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer;" onclick="offerBuilder.toggleSection('pricingStrategySection')">
                                        <div>
                                            <h3 style="font-size: 15px; font-weight: 700; color: var(--cobalt); margin: 0;">Advanced Options</h3>
                                            <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">Optional pricing calculations</p>
                                        </div>
                                        <span id="pricingStrategySectionToggle" style="font-size: 18px; color: var(--cobalt);">▼</span>
                                    </div>
                                    <div id="pricingStrategySection" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 2px solid #e5e7eb;">
                                        <p style="font-size: 12px; color: #6b7280; margin: 0 0 16px 0;">Let the system calculate your offer price by adding up individual service prices. Most people just set the price above instead.</p>
                                        <div style="display: flex; flex-direction: column; gap: 12px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--cobalt)'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                            <input type="radio" name="offerBuilderPricingStrategy" value="sum" checked onchange="offerBuilder.updatePricingStrategy('sum')" style="cursor: pointer;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; color: var(--cobalt); font-weight: 600;">Regular Pricing</div>
                                                <div style="font-size: 11px; color: #6b7280;">Add up all service prices (no discount)</div>
                                            </div>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--cobalt)'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                            <input type="radio" name="offerBuilderPricingStrategy" value="percentOff" onchange="offerBuilder.updatePricingStrategy('percentOff')" style="cursor: pointer;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; color: var(--cobalt); font-weight: 600;">Percentage Discount</div>
                                                <div style="font-size: 11px; color: #6b7280;">Take a % off the total (e.g., "20% off")</div>
                                            </div>
                                        </label>
                                        <div id="offerBuilderPercentOffContainer" style="display: none; margin-left: 24px; margin-top: -4px; margin-bottom: 8px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" id="offerBuilderPercentOff" min="0" max="100" step="1" placeholder="20" oninput="offerBuilder.recalculateOffer()" style="width: 100px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                                <span style="font-size: 14px; color: #374151; font-weight: 500;">% off</span>
                                            </div>
                        </div>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--cobalt)'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                            <input type="radio" name="offerBuilderPricingStrategy" value="dollarOff" onchange="offerBuilder.updatePricingStrategy('dollarOff')" style="cursor: pointer;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; color: var(--cobalt); font-weight: 600;">Dollar Discount</div>
                                                <div style="font-size: 11px; color: #6b7280;">Take a fixed amount off (e.g., "$50 off")</div>
                                            </div>
                                        </label>
                                        <div id="offerBuilderDollarOffContainer" style="display: none; margin-left: 24px; margin-top: -4px; margin-bottom: 8px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="font-size: 18px; color: #374151;">$</span>
                                                <input type="number" id="offerBuilderDollarOff" min="0" step="0.01" placeholder="50.00" oninput="offerBuilder.recalculateOffer()" style="width: 120px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                                <span style="font-size: 14px; color: #374151; font-weight: 500;">off total</span>
                                            </div>
                                        </div>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--cobalt)'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                            <input type="radio" name="offerBuilderPricingStrategy" value="bundlePrice" onchange="offerBuilder.updatePricingStrategy('bundlePrice')" style="cursor: pointer;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; color: var(--cobalt); font-weight: 600;">Fixed Package Price</div>
                                                <div style="font-size: 11px; color: #6b7280;">Set one price for everything (ignores individual prices)</div>
                                            </div>
                                        </label>
                                        <div id="offerBuilderBundlePriceContainer" style="display: none; margin-left: 24px; margin-top: -4px; margin-bottom: 8px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="font-size: 18px; color: #374151;">$</span>
                                                <input type="number" id="offerBuilderBundlePrice" min="0" step="0.01" placeholder="299.00" oninput="offerBuilder.recalculateOffer()" style="width: 120px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                                <span style="font-size: 14px; color: #374151; font-weight: 500;">total</span>
                                            </div>
                                        </div>
                        </div>
                    </div>

                                <!-- Offer Messaging Section (Collapsible) -->
                                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; cursor: pointer;" onclick="offerBuilder.toggleSection('offerMessagingSection')">
                                        <div>
                                            <h3 style="font-size: 15px; font-weight: 700; color: var(--cobalt); margin: 0;">Messaging & Details</h3>
                                            <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">Optional marketing content</p>
                                        </div>
                                        <span id="offerMessagingSectionToggle" style="font-size: 18px; color: var(--cobalt);">▼</span>
                                    </div>
                                    <div id="offerMessagingSection" style="display: none;">
                                        <!-- Tab Navigation -->
                                        <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
                                            <button onclick="offerBuilder.switchMessagingTab('snapshot')" id="messagingTabSnapshot" style="padding: 8px 16px; background: var(--cobalt); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Snapshot</button>
                                            <button onclick="offerBuilder.switchMessagingTab('value')" id="messagingTabValue" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Value Equation</button>
                                            <button onclick="offerBuilder.switchMessagingTab('messaging')" id="messagingTabMessaging" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Messaging Pack</button>
                                            <button onclick="offerBuilder.switchMessagingTab('creative')" id="messagingTabCreative" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Creative Angles</button>
                                            <button onclick="offerBuilder.switchMessagingTab('ops')" id="messagingTabOps" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Ops Notes</button>
                                            <button onclick="offerBuilder.switchMessagingTab('decision')" id="messagingTabDecision" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Decision Notes</button>
                                        </div>
                                        
                                        <!-- Tab Content: Snapshot -->
                                        <div id="messagingTabContentSnapshot" class="messaging-tab-content">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Category <span style="color: #ef4444;">*</span></label>
                                                    <select id="offerBuilderCategory" onchange="offerBuilder.updateField('category', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                        <option value="">Select...</option>
                                                        <option value="TV Mount">TV Mount</option>
                                                        <option value="Cameras">Cameras</option>
                                                        <option value="Doorbell">Doorbell</option>
                                                        <option value="WiFi">WiFi</option>
                                                        <option value="Bundle">Bundle</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Market <span style="color: #ef4444;">*</span></label>
                                                    <input type="text" id="offerBuilderMarket" placeholder="City/Zip or 'All'" oninput="offerBuilder.updateField('market', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Primary Avatar <span style="color: #ef4444;">*</span></label>
                                                    <select id="offerBuilderPrimaryAvatar" onchange="offerBuilder.updateField('primaryAvatar', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                        <option value="">Select...</option>
                                                        <option value="homeowner">Homeowner</option>
                                                        <option value="renter">Renter</option>
                                                        <option value="property manager">Property Manager</option>
                                                        <option value="small biz">Small Biz</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Intended Goal <span style="color: #ef4444;">*</span></label>
                                                    <select id="offerBuilderIntendedGoal" onchange="offerBuilder.updateField('intendedGoal', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                        <option value="">Select...</option>
                                                        <option value="bookings">Bookings</option>
                                                        <option value="AOV lift">AOV Lift</option>
                                                        <option value="bundle attach">Bundle Attach</option>
                                                        <option value="speed to cash">Speed to Cash</option>
                                                        <option value="lead volume">Lead Volume</option>
                                                    </select>
                        </div>
                    </div>

                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Headline (Ad-Ready) <span style="color: #ef4444;">*</span></label>
                                                <input type="text" id="offerBuilderHeadline" placeholder="e.g., Get Your TV Mounted in 24 Hours" oninput="offerBuilder.updateField('headline', this.value); offerBuilder.validateHeadline(this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                <div id="offerBuilderHeadlineGuardrail" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: none;"></div>
                        </div>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">1-Sentence Promise <span style="color: #ef4444;">*</span></label>
                                                <input type="text" id="offerBuilderOneSentencePromise" placeholder="e.g., Professional installation in under 2 hours, guaranteed." oninput="offerBuilder.updateField('oneSentencePromise', this.value); offerBuilder.validatePromise(this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                <div id="offerBuilderPromiseGuardrail" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: none;"></div>
                        </div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Offer Start Date</label>
                                                    <input type="date" id="offerBuilderOfferStartDate" onchange="offerBuilder.updateField('offerStartDate', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                    </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Offer End Date</label>
                                                    <input type="date" id="offerBuilderOfferEndDate" onchange="offerBuilder.updateField('offerEndDate', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                </div>
            </div>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Scarcity Mechanism</label>
                                                <select id="offerBuilderScarcityMechanism" onchange="offerBuilder.updateField('scarcityMechanism', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                    <option value="">Select...</option>
                                                    <option value="deadline">Deadline</option>
                                                    <option value="limited slots">Limited Slots</option>
                                                    <option value="limited bundles">Limited Bundles</option>
                                                    <option value="price ends">Price Ends</option>
                                                </select>
        </div>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Risk Reversal</label>
                                                <textarea id="offerBuilderRiskReversal" placeholder="Warranty, guarantee, redo policy, etc." oninput="offerBuilder.updateField('riskReversal', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            
                                            <div style="border-top: 2px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
                                                <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px;">The Deal</h4>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">What's Included</label>
                                                    <textarea id="offerBuilderWhatsIncluded" placeholder="Exact services and items included" oninput="offerBuilder.updateField('whatsIncluded', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">What's Not Included / Upcharges</label>
                                                    <textarea id="offerBuilderWhatsNotIncluded" placeholder="Exclusions, additional costs, upcharges" oninput="offerBuilder.updateField('whatsNotIncluded', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Eligibility Rules</label>
                                                    <textarea id="offerBuilderEligibilityRules" placeholder="Distance, wall type, height, existing wiring limits, etc." oninput="offerBuilder.updateField('eligibilityRules', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Redemption Rules</label>
                                                    <textarea id="offerBuilderRedemptionRules" placeholder="Online only, booking link, promo code, etc." oninput="offerBuilder.updateField('redemptionRules', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Value Equation -->
                                        <div id="messagingTabContentValue" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Dream Outcome</label>
                                                <textarea id="offerBuilderDreamOutcome" placeholder="What result does the customer get?" oninput="offerBuilder.updateField('dreamOutcome', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Likelihood of Achievement (Proof, Process, Guarantees)</label>
                                                <textarea id="offerBuilderLikelihoodOfAchievement" placeholder="Why will this work? Proof, process, guarantees" oninput="offerBuilder.updateField('likelihoodOfAchievement', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Time Delay (How Fast They Get Results)</label>
                                                <input type="text" id="offerBuilderTimeDelay" placeholder="e.g., Same day, 24 hours, 2 hours" oninput="offerBuilder.updateField('timeDelay', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Effort + Sacrifice (What You Remove/Simplify)</label>
                                                <textarea id="offerBuilderEffortSacrifice" placeholder="What do you handle for them? What complexity do you remove?" oninput="offerBuilder.updateField('effortSacrifice', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            
                                            <div style="border-top: 2px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
                                                <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px;">Competitor Reality Check</h4>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Competitor Price Range Found</label>
                                                    <input type="text" id="offerBuilderCompetitorPriceRange" placeholder="e.g., $200-$400" oninput="offerBuilder.updateField('competitorPriceRange', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">How We're Different (Not Cheaper, Better)</label>
                                                    <textarea id="offerBuilderHowWereDifferent" placeholder="What makes us better, not just cheaper?" oninput="offerBuilder.updateField('howWereDifferent', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Why Someone Chooses Us Even If Not Lowest Price</label>
                                                    <textarea id="offerBuilderWhyChooseUs" placeholder="Value proposition beyond price" oninput="offerBuilder.updateField('whyChooseUs', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Messaging Pack -->
                                        <div id="messagingTabContentMessaging" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Booking Page Microcopy (2-4 lines)</label>
                                                <textarea id="offerBuilderBookingPageMicrocopy" placeholder="Short copy for booking page" oninput="offerBuilder.updateField('bookingPageMicrocopy', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">SMS Confirmation Copy</label>
                                                <textarea id="offerBuilderSmsConfirmation" placeholder="SMS sent after booking" oninput="offerBuilder.updateField('smsConfirmation', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">SMS Reminder (24h)</label>
                                                <textarea id="offerBuilderSmsReminder24h" placeholder="SMS reminder 24h before" oninput="offerBuilder.updateField('smsReminder24h', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">If Customer Asks About Price Line</label>
                                                <textarea id="offerBuilderPriceQuestionLine" placeholder="Response to price questions" oninput="offerBuilder.updateField('priceQuestionLine', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Tech Broadcast Message</label>
                                                <textarea id="offerBuilderTechBroadcastMessage" placeholder="Message to techs about this offer" oninput="offerBuilder.updateField('techBroadcastMessage', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Creative Angles -->
                                        <div id="messagingTabContentCreative" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">5 Hooks (one per line, keep short)</label>
                                                <textarea id="offerBuilderHooks" placeholder="Hook 1&#10;Hook 2&#10;Hook 3&#10;Hook 4&#10;Hook 5" oninput="offerBuilder.updateField('hooks', this.value.split('\\n').filter(h => h.trim())); offerBuilder.validateHooks(this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 100px; resize: vertical;"></textarea>
                                                <div id="offerBuilderHooksGuardrail" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: none;"></div>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">3 Primary Objections + Rebuttal (one per line)</label>
                                                <textarea id="offerBuilderObjectionsRebuttals" placeholder="Objection 1 + Rebuttal&#10;Objection 2 + Rebuttal&#10;Objection 3 + Rebuttal" oninput="offerBuilder.updateField('objectionsRebuttals', this.value.split('\\n').filter(o => o.trim())); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;"></textarea>
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">3 Proof Ideas (one per line)</label>
                                                <textarea id="offerBuilderProofIdeas" placeholder="Proof idea 1&#10;Proof idea 2&#10;Proof idea 3" oninput="offerBuilder.updateField('proofIdeas', this.value.split('\\n').filter(p => p.trim())); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Ops Notes -->
                                        <div id="messagingTabContentOps" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">What to Say In-Home (one per line)</label>
                                                <textarea id="offerBuilderWhatToSayInHome" placeholder="Point 1&#10;Point 2&#10;Point 3" oninput="offerBuilder.updateField('whatToSayInHome', this.value.split('\\n').filter(s => s.trim())); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Special Instructions</label>
                                                <textarea id="offerBuilderSpecialInstructions" placeholder="Photos, checklist, upsell rules, do-not-do" oninput="offerBuilder.updateField('specialInstructions', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Capacity Assumption</label>
                                                <input type="text" id="offerBuilderCapacityAssumption" placeholder="e.g., 3 jobs/day" oninput="offerBuilder.updateField('capacityAssumption', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Cancellation Risks</label>
                                                <textarea id="offerBuilderCancellationRisks" placeholder="What could cause cancellations or reschedules?" oninput="offerBuilder.updateField('cancellationRisks', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            
                                            <div style="border-top: 2px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
                                                <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px;">Unit Economics Notes</h4>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Where Can This Break (Edge Cases That Destroy Margin)</label>
                                                    <textarea id="offerBuilderMarginBreakPoints" placeholder="Edge cases, risks to margin" oninput="offerBuilder.updateField('marginBreakPoints', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Safeguards to Prevent Margin Bleed</label>
                                                    <textarea id="offerBuilderSafeguards" placeholder="How to protect margin" oninput="offerBuilder.updateField('safeguards', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Decision Notes -->
                                        <div id="messagingTabContentDecision" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Best-Case Outcome If This Works</label>
                                                <textarea id="offerBuilderBestCaseOutcome" placeholder="What's the best possible result?" oninput="offerBuilder.updateField('bestCaseOutcome', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Worst-Case Risk If This Fails</label>
                                                <textarea id="offerBuilderWorstCaseRisk" placeholder="What could go wrong?" oninput="offerBuilder.updateField('worstCaseRisk', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Confidence Score (1-10)</label>
                                                    <input type="number" id="offerBuilderConfidenceScore" min="1" max="10" step="1" placeholder="1-10" oninput="offerBuilder.updateField('confidenceScore', parseInt(this.value) || 0); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Why</label>
                                                    <input type="text" id="offerBuilderConfidenceWhy" placeholder="Why this score?" oninput="offerBuilder.updateField('confidenceWhy', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ========== RIGHT COLUMN ========== -->
                            <div id="offerBuilderRightColumn" style="display: flex; flex-direction: column; gap: 16px; position: relative; min-width: 0;">
                                
                                <!-- Standards Panel -->
                                <div id="offerBuilderStandards" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">Standards Check</h3>
                                    <div id="offerBuilderStandardsContent">
                                        <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 12px;">
                                            Fill in details to check standards
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Offer Totals -->
                                <div id="offerBuilderTotals" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">Pricing Breakdown</h3>
                                    <div id="offerBuilderResults">
                                        <div style="text-align: center; padding: 24px 16px; color: #9ca3af; font-size: 12px;">
                                            Add services to see totals
                                        </div>
                                    </div>
                                    <div id="offerBuilderWarnings" style="margin-top: 12px;"></div>
                                </div>
                                
                            </div>
                            <!-- END RIGHT COLUMN -->
                            
                        </div>
                        <!-- END GRID -->
                        
                        <!-- Optional sections below the grid -->
                        <div style="margin-top: 32px; display: flex; flex-direction: column; gap: 20px;">
                            
                            <!-- Insights & Suggestions (Optional) -->
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer;" onclick="offerBuilder.toggleSection('offerBuilderInsights')">
                                    <div>
                                        <h3 style="font-size: 17px; font-weight: 700; color: var(--cobalt); margin: 0;">Insights & Suggestions</h3>
                                        <p style="font-size: 12px; color: #6b7280; margin: 4px 0 0 0;">Optional guidance based on what's working</p>
                                    </div>
                                    <span id="offerBuilderInsightsToggle" style="font-size: 18px; color: var(--cobalt);">▼</span>
                                </div>
                                <div id="offerBuilderInsights" style="display: none;">
                                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px; line-height: 1.6;">Get suggestions based on successful past offers and performance data.</p>
                                    
                                    <!-- Loading state -->
                                    <div id="offerBuilderInsightsLoading" style="display: none; padding: 32px; text-align: center;">
                                        <div style="width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top-color: var(--cobalt); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px;"></div>
                                        <p style="font-size: 13px; color: #6b7280; margin: 0;">Loading insights...</p>
                                    </div>
                                    
                                    <!-- Insights content -->
                                    <div id="offerBuilderInsightsContent" style="display: none;"></div>
                                    
                                    <!-- Empty state -->
                                    <div id="offerBuilderInsightsEmpty" style="display: none; padding: 24px; text-align: center; background: #f9fafb; border-radius: 8px; border: 1px dashed #e5e7eb;">
                                        <div style="font-size: 32px; margin-bottom: 8px;">💡</div>
                                        <p style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 8px 0;">No insights available yet</p>
                                        <p style="font-size: 12px; color: #6b7280; margin: 0;">As more offers are deployed and tracked, insights will appear here.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Performance Feedback -->
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer;" onclick="offerBuilder.toggleSection('offerBuilderPerformanceFeedback')">
                                    <h3 style="font-size: 17px; font-weight: 700; color: var(--cobalt); margin: 0;">How This Offer Is Performing</h3>
                                    <span id="offerBuilderPerformanceFeedbackToggle" style="font-size: 18px; color: var(--cobalt);">▼</span>
                                </div>
                                <div id="offerBuilderPerformanceFeedback" style="display: none;">
                                    <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px; line-height: 1.6;">Light performance indicators based on campaign tracking. Data updates automatically as campaigns run.</p>
                                    
                                    <!-- Loading state -->
                                    <div id="offerBuilderPerformanceLoading" style="display: none; padding: 32px; text-align: center;">
                                        <div style="width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top-color: var(--cobalt); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px;"></div>
                                        <p style="font-size: 13px; color: #6b7280; margin: 0;">Loading performance data...</p>
                                    </div>
                                    
                                    <!-- Performance summary -->
                                    <div id="offerBuilderPerformanceSummary" style="display: none;"></div>
                                    
                                    <!-- Empty state -->
                                    <div id="offerBuilderPerformanceEmpty" style="display: none; padding: 24px; text-align: center; background: #f9fafb; border-radius: 8px; border: 1px dashed #e5e7eb;">
                                        <div style="font-size: 32px; margin-bottom: 8px;">📊</div>
                                        <p style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 8px 0;">No performance data yet</p>
                                        <p style="font-size: 12px; color: #6b7280; margin: 0;">Once this offer is deployed and campaigns are running, performance metrics will appear here.</p>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        <!-- End optional sections -->
                        
                    </div>
                    <!-- End centered container -->
                </div>
            </div>
        </div>

        <!-- Training Completion Modal -->
        <div id="completionModal" class="completion-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.60); z-index: 10000; align-items: center; justify-content: center;">
            <div class="completion-modal-content" style="background: #ffffff; border-radius: 16px; max-width: 820px; width: 94%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(10,42,90,0.30);">
                <div style="padding: 20px 24px; border-bottom: 1px solid rgba(10,42,90,0.12); background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); animation: shimmer 2s infinite;"></div>
                    <h3 style="color: #ffffff; font-size: 20px; font-weight: 900; margin: 0; position: relative; z-index: 1;" id="completionModalTitle">Training Completion Report</h3>
                    <p style="color: rgba(255,255,255,0.85); font-size: 13px; margin: 6px 0 0; position: relative; z-index: 1;">Detailed responses build your knowledge profile and unlock better recommendations.</p>
                </div>
                <div style="padding: 20px 24px;">
                    <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-left: 3px solid #0a2a5a; border-radius: 8px;">
                        <label style="display: block; font-weight: 900; color: #0a2a5a; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">1. What specific concept, tool, or process did you learn?</label>
                        <textarea id="conceptLearned" placeholder="Example: Learned how to build multi-step email automation in GoHighLevel. The process includes: 1) Create workflow in Automation tab, 2) Set up trigger (form submission or tag added), 3) Add email actions with delays between them, 4) Use merge fields for personalization, 5) Set up A/B testing for subject lines." style="width: 100%; min-height: 110px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#0a2a5a'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                        <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;"><strong>Be specific:</strong> Name the tool/feature, list the steps, mention settings or configurations.</p>
                    </div>
                    <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-left: 3px solid #0a2a5a; border-radius: 8px;">
                        <label style="display: block; font-weight: 900; color: #0a2a5a; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">2. How will you apply this to client work or internal operations?</label>
                        <textarea id="practicalApplication" placeholder="Example: Will use this to set up automated lead nurture sequences for HVAC clients. When a lead fills out ''Free Quote'' form, they''ll get: Day 1 = Welcome + service overview, Day 3 = Customer testimonials, Day 5 = Limited-time discount offer. This replaces manual follow-up emails and ensures no leads fall through cracks." style="width: 100%; min-height: 110px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#0a2a5a'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                        <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;"><strong>Real scenarios:</strong> Which client? What problem does it solve? What''s the outcome?</p>
                    </div>
                    <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-left: 3px solid #0a2a5a; border-radius: 8px;">
                        <label style="display: block; font-weight: 900; color: #0a2a5a; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">3. What''s your next action or what will change in your workflow?</label>
                        <textarea id="nextActions" placeholder="Example: Next steps: 1) Create template automation in our GHL agency account, 2) Document the setup process in ClickUp with screenshots, 3) Add ''Email Automation Setup'' to client onboarding checklist, 4) Test with 1-2 pilot clients before rolling out to all. This will save ~3 hours/week previously spent on manual follow-ups." style="width: 100%; min-height: 110px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#0a2a5a'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                        <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;"><strong>Actionable steps:</strong> What will you build, test, or implement? What changes in your process?</p>
                    </div>
                    <div style="margin-bottom: 20px; padding: 16px; background: #fff7ed; border-left: 3px solid #f59e0b; border-radius: 8px;">
                        <label style="display: block; font-weight: 900; color: #f59e0b; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">4. What''s unclear or what do you need help with? (Optional)</label>
                        <textarea id="challengesQuestions" placeholder="Example: Not sure how to handle unsubscribes in the automation - do I need a separate workflow? Also unclear on best practice for email frequency (don''t want to spam). Need guidance on A/B testing setup - which metrics should I track?" style="width: 100%; min-height: 90px; padding: 12px; border: 2px solid #fed7aa; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#f59e0b'" onblur="this.style.borderColor='#fed7aa'"></textarea>
                        <p style="color: #92400e; font-size: 12px; margin-top: 8px; margin-bottom: 0;"><strong>Flag gaps:</strong> What confused you? What needs clarification? What''s the next skill to learn?</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 800; color: #0a2a5a; margin-bottom: 8px; font-size: 13px;">Comprehension Level</label>
                            <div class="star-rating" id="starRating" style="display: flex; gap: 8px; align-items: center;">
                                <span class="star" data-rating="1" title="1 - Need to rewatch"></span>
                                <span class="star" data-rating="2" title="2 - Understood basics"></span>
                                <span class="star" data-rating="3" title="3 - Can explain it"></span>
                                <span class="star" data-rating="4" title="4 - Can apply with guidance"></span>
                                <span class="star" data-rating="5" title="5 - Can apply independently"></span>
                            </div>
                            <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;">1 = rewatch needed  5 = ready to implement</p>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 800; color: #0a2a5a; margin-bottom: 8px; font-size: 13px;">Time Spent (minutes)</label>
                            <input type="number" id="timeSpent" value="30" min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#0a2a5a'" onblur="this.style.borderColor='#e5e7eb'">
                            <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;">Total time including pauses/rewatches</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                        <button onclick="closeCompletionModal()" style="padding: 14px 18px; background: #f3f4f6; color: #0a2a5a; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">Cancel</button>
                        <button onclick="submitTrainingCompletion()" style="padding: 14px 18px; background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%); color: #ffffff; border: none; border-radius: 10px; font-weight: 900; font-size: 14px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 8px 20px rgba(10,42,90,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"><span style="position: relative; z-index: 1;">Submit Training Report</span></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADD TASK MODAL -->
        <div class="task-modal-overlay" id="addTaskModal" onclick="closeAddTaskModal(event)">
            <div class="task-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                <div class="task-modal-header">
                    <div style="flex: 1;">
                        <div class="task-title" style="font-size: 24px; margin-bottom: 8px;">Add New Task</div>
                        <div style="color: var(--cobalt); font-size: 14px;">Create a task or let AI write the SOP for you</div>
                    </div>
                    <button class="task-modal-close" onclick="closeAddTaskModal()">✕</button>
                </div>
                <div class="task-modal-body">
                    <form id="addTaskForm" onsubmit="submitNewTask(event)">
                        <div class="form-group">
                            <label class="form-label">Task Title</label>
                            <input type="text" id="newTaskTitle" class="form-input" placeholder="e.g., Check candidate emails" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Priority</label>
                                <select id="newTaskPriority" class="form-select">
                                    <option value="HIGH">High</option>
                                    <option value="MEDIUM" selected>Medium</option>
                                    <option value="LOW">Low</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Due Date</label>
                                <div style="display:flex; gap:8px;">
                                    <input type="date" id="newTaskDueDate" class="form-input" style="flex:1;">
                                    <input type="time" id="newTaskDueTime" class="form-input" style="flex:1;">
                                    <button type="button" class="btn-secondary" onclick="openCalendarModal()" title="Schedule"><span style="font-weight:900;">📅</span></button>
                                </div>
                            </div>
                        </div>

                        <div class="form-row" style="display: flex; gap: 16px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Recurrence</label>
                                <select id="newTaskRecurrence" class="form-select">
                                    <option value="none" selected>None</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Retention (days in Done)</label>
                                <select id="newTaskRetention" class="form-select">
                                    <option value="1">1 day</option>
                                    <option value="3">3 days</option>
                                    <option value="7" selected>7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30">30 days</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label class="form-label" style="margin-bottom: 0;">Description / Rough Notes</label>
                                <button type="button" onclick="polishTaskDescription()" class="btn-magic">
                                    ✨ AI Polish
                                </button>
                            </div>
                            <textarea id="newTaskDescription" class="form-textarea" placeholder="Type a rough idea here (e.g., 'Check emails and reply to candidates') and click AI Polish to turn it into a full SOP."></textarea>
                        </div>

                        <div class="task-modal-actions">
                            <button type="button" class="btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
                            <button type="submit" class="btn-primary">Create Task</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- CALENDAR SCHEDULING MODAL -->
        <div class="calendar-modal-overlay" id="calendarModal" onclick="closeCalendarModal(event)">
            <div class="calendar-modal" onclick="event.stopPropagation()">
                <div class="calendar-modal-header">Schedule Task</div>
                <div class="calendar-modal-body">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="calendarDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" id="calendarTime" class="form-input">
                    </div>
                </div>
                <div class="calendar-modal-actions">
                    <button class="btn-secondary" onclick="closeCalendarModal()">Cancel</button>
                    <button class="btn-primary" onclick="applyCalendarSelection()">Apply</button>
                </div>
            </div>
        </div>

        <!-- VIEW TASK MODAL -->
        <div class="task-modal-overlay" id="taskModal" onclick="closeTaskModal(event)">
            <div class="task-modal" onclick="event.stopPropagation()">
                <div class="task-modal-header">
                    <div style="flex: 1; padding-right: 20px;">
                        <div id="modalTaskTitle" class="task-title" style="font-size: 24px; margin-bottom: 12px;"></div>
                        <div id="modalTaskBadges" class="task-badges"></div>
                    </div>
                    <button class="task-modal-close" onclick="closeTaskModal()">✕</button>
                </div>
                <div class="task-modal-body">
                    <div id="modalTaskDescription" class="task-description" style="font-size: 16px; margin-bottom: 24px;"></div>
                    <div id="modalTaskContent"></div>
                </div>
                <div class="task-modal-actions">
                    <button id="modalTaskAction" class="task-action-btn"></button>
                    <button class="task-action-btn task-close-btn" onclick="closeTaskModal()">Close</button>
                </div>
            </div>
            </div>
        </div>

        <!-- DETAIL DRAWER -->
        <div class="detail-drawer" id="detailDrawer">
            <div class="detail-drawer-header">
                <div class="detail-drawer-title" id="drawerTitle">Candidate Details</div>
                <button class="detail-drawer-close" onclick="closeDetailDrawer()">×</button>
            </div>
            <div class="detail-drawer-body" id="drawerBody">
                <!-- Content populated by viewCandidate() -->
            </div>
        </div>
    </div> <!-- End #h2s-app -->

    <script>
        // Configuration - H2S Backend API
        // Prefer a real templated override (window.API_URL), otherwise use production.
        const DEFAULT_API_HOST = 'https://h2s-backend.vercel.app';
        const API_HOST = (() => {
            try {
                const maybe = (typeof window !== 'undefined' && typeof window.API_URL === 'string')
                    ? window.API_URL.trim()
                    : '';
                // If the page is not templated, the literal placeholder can leak through.
                if (!maybe || maybe.includes('<?') || !/^https?:\/\//i.test(maybe)) return DEFAULT_API_HOST;
                return new URL(maybe).origin;
            } catch {
                return DEFAULT_API_HOST;
            }
        })();

        const API_URL = `${API_HOST}/api/v1`;
        const TRACK_API = `${API_HOST}/api/track`;
        const TRACK_PING_API = `${API_HOST}/api/track-ping`;
        
        let candidates = [];
        let autoRefreshInterval = null;
        
        // Tracking Helper Functions - DISABLED FOR DASHBOARD (internal tool, not sales funnel)
        async function trackEvent(eventName, properties = {}) {
            // Tracking disabled - this is an internal dashboard, not a customer-facing funnel page
            // All trackEvent calls are no-ops to prevent polluting sales funnel analytics
            return { ok: true, tracked: false, reason: 'internal_dashboard' };
        }
        
        async function checkTrackingHealth() {
            try {
                const response = await fetch(TRACK_PING_API);
                const health = await response.json();
                return health;
            } catch (error) {
                console.error('Health check error:', error);
                return { ok: false, healthy: false };
            }
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
            
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-message">${message}</div>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }

        // Custom Modal Dialog System
        let modalResolve = null;

        function showModal(title, message, options = {}) {
            return new Promise((resolve) => {
                modalResolve = resolve;
                
                const overlay = document.getElementById('modalOverlay');
                const header = document.getElementById('modalHeader');
                const body = document.getElementById('modalBody');
                const confirmBtn = document.getElementById('modalConfirmBtn');
                const actions = document.getElementById('modalActions');
                
                header.textContent = title;
                
                // Support HTML content - check if message contains HTML tags
                if (options.html !== false && typeof message === 'string' && (message.includes('<div') || message.includes('<p') || message.includes('<button') || message.includes('<span') || message.includes('<h'))) {
                    body.innerHTML = message;
                } else {
                body.textContent = message;
                }
                
                // Configure modal size
                const dialog = overlay.querySelector('.modal-dialog');
                if (options.width) {
                    dialog.style.maxWidth = options.width;
                }
                if (options.maxHeight) {
                    dialog.style.maxHeight = options.maxHeight;
                    dialog.style.overflowY = 'auto';
                }
                
                // Configure confirm button
                if (options.hideConfirm) {
                    confirmBtn.style.display = 'none';
                } else {
                    confirmBtn.style.display = 'block';
                confirmBtn.textContent = options.confirmText || 'Confirm';
                confirmBtn.className = 'modal-btn ' + (options.danger ? 'modal-btn-danger' : 'modal-btn-confirm');
                confirmBtn.onclick = () => {
                    closeModal(true);
                };
                }
                
                // Hide actions if needed
                if (options.hideActions) {
                    actions.style.display = 'none';
                } else {
                    actions.style.display = 'flex';
                }
                
                // Prevent body scroll and layout shift
                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                if (scrollbarWidth > 0) {
                    document.body.style.paddingRight = `${scrollbarWidth}px`;
                }
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Focus trap - focus first focusable element
                setTimeout(() => {
                    const firstFocusable = overlay.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (firstFocusable) firstFocusable.focus();
                }, 100);
            });
        }

        function closeModal(confirmed = false) {
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
            overlay.classList.remove('active');
            }
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            if (modalResolve) {
                modalResolve(confirmed);
                modalResolve = null;
            }
        }
        
        // Custom Confirm Dialog (replaces native confirm)
        function showConfirm(title, message, options = {}) {
            return new Promise((resolve) => {
                const confirmText = options.confirmText || 'Confirm';
                const cancelText = options.cancelText || 'Cancel';
                const danger = options.danger || false;
                
                // Create a temporary modal resolver
                let tempResolve = null;
                const tempPromise = new Promise((r) => { tempResolve = r; });
                
                const confirmHtml = `
                    <div style="padding: 24px 0;">
                        <div style="font-size: 16px; line-height: 1.6; color: #374151; white-space: pre-line;">${message}</div>
                    </div>
                `;
                
                const overlay = document.getElementById('modalOverlay');
                const header = document.getElementById('modalHeader');
                const body = document.getElementById('modalBody');
                const confirmBtn = document.getElementById('modalConfirmBtn');
                const cancelBtn = document.querySelector('.modal-btn-cancel');
                const actions = document.getElementById('modalActions');
                
                header.textContent = title;
                body.innerHTML = confirmHtml;
                
                // Configure buttons
                confirmBtn.textContent = confirmText;
                confirmBtn.className = 'modal-btn ' + (danger ? 'modal-btn-danger' : 'modal-btn-confirm');
                confirmBtn.onclick = () => {
                    closeModal();
                    resolve(true);
                };
                
                if (cancelBtn) {
                    cancelBtn.textContent = cancelText;
                    cancelBtn.onclick = () => {
                        closeModal();
                        resolve(false);
                    };
                }
                
                actions.style.display = 'flex';
                confirmBtn.style.display = 'block';
                
                // Configure modal size
                const dialog = overlay.querySelector('.modal-dialog');
                if (options.width) {
                    dialog.style.maxWidth = options.width;
                }
                
                // Show modal
                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                if (scrollbarWidth > 0) {
                    document.body.style.paddingRight = `${scrollbarWidth}px`;
                }
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Focus trap
                setTimeout(() => {
                    cancelBtn?.focus();
                }, 100);
            });
        }

        // Close modal on overlay click
        document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                closeModal(false);
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('modalOverlay');
                if (overlay && overlay.classList.contains('active')) {
                    closeModal(false);
                }
            }
        });

        // Guard against multiple initializations (GHL may inject script multiple times)
        let dashboardInitialized = false;
        let appInstanceId = null;

        // Initialize Dashboard (called after user gate)
        function initDashboard() {
            // Prevent duplicate initialization
            if (dashboardInitialized) {
                console.warn('Dashboard already initialized, skipping duplicate init');
                return;
            }

            // Check for duplicate app containers (GHL might inject multiple times)
            const existingApps = document.querySelectorAll('#h2s-app');
            if (existingApps.length > 1) {
                console.warn(`Found ${existingApps.length} app instances, removing duplicates`);
                // Keep only the first instance, remove others
                for (let i = 1; i < existingApps.length; i++) {
                    existingApps[i].remove();
                }
            }

            // Mark as initialized
            dashboardInitialized = true;
            appInstanceId = Date.now();

            setupTabs();
            // Only load pipeline if it's the active pane
            const pipelinePane = document.getElementById('pipeline-pane');
            if (pipelinePane && pipelinePane.classList.contains('active')) {
                loadPipeline();
            }
            initHoursForm();
            setupForms();
            startAutoRefresh();
            loadKnowledgeProfile(); // Load user-specific profile
            // Only load training if it's the active pane (unlikely on init, but safe)
            const trainingPane = document.getElementById('training-pane');
            if (trainingPane && trainingPane.classList.contains('active')) {
                loadTrainingResources();
            }
            // Only load tasks if it's the active pane
            const tasksPane = document.getElementById('tasks-pane');
            if (tasksPane && tasksPane.classList.contains('active')) {
                loadTasks();
            }
            
            // Show logout button when logged in
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.style.display = 'block';
        }

        // Initialize on page load (user gate will show first)
        document.addEventListener('DOMContentLoaded', () => {
            // Track page load
            if (typeof trackEvent === 'function') {
                trackEvent('page_view', {
                    page_type: 'dashboard',
                    page_title: 'H2S Dashboard'
                });
            }
            
            // Set up user select change listener to enable/disable button
            const userSelect = document.getElementById('userSelect');
            const userGateBtn = document.getElementById('userGateBtn');
            if (userSelect && userGateBtn) {
                userSelect.addEventListener('change', (e) => {
                    userGateBtn.disabled = !e.target.value;
                });
            }
            
            // Check if user is already cached (auto-login)
            const isCached = checkCachedUser();
            
            // If no cached user, gate will show (default state)
            if (!isCached) {
                // User gate will show (default state)
            } else {
                // Restore last active tab from localStorage (intelligent persistence)
                const restoreActiveTab = () => {
                    try {
                        const savedTab = localStorage.getItem('h2s_active_tab');
                        const savedTimestamp = localStorage.getItem('h2s_active_tab_timestamp');
                        
                        // Check if tab was saved recently (within last 24 hours)
                        const isValid = savedTab && savedTimestamp && (Date.now() - parseInt(savedTimestamp)) < (24 * 60 * 60 * 1000);
                        
                        // Check for URL parameters that override saved tab
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlTab = urlParams.get('tab');
                        
                        // Priority: URL param > Saved tab > Default (pipeline)
                        const targetTab = urlTab || (isValid ? savedTab : 'pipeline');
                        
                        // Validate tab exists
                        const validTabs = ['pipeline', 'screening', 'techinterview', 'hours', 'reports', 'training', 'tasks', 'deliverables', 'admin', 'offerbuilder'];
                        if (validTabs.includes(targetTab)) {
                            // Small delay to ensure DOM is ready
                            setTimeout(() => {
                                switchToTab(targetTab, { skipPersistence: true, smooth: false });
                                
                                // Clean up URL if it had a tab parameter
                                if (urlTab) {
                                    const newUrl = new URL(window.location);
                                    newUrl.searchParams.delete('tab');
                                    window.history.replaceState({}, '', newUrl);
                                }
                            }, 100);
                        }
                    } catch (e) {
                        console.warn('Could not restore active tab:', e);
                    }
                };
                
                // Check if Analytics wants to open a specific training
                const urlParams = new URLSearchParams(window.location.search);
                const trainingToOpen = urlParams.get('openTraining') || localStorage.getItem('h2s_open_training');

                if (trainingToOpen && currentUser) {
                    localStorage.removeItem('h2s_open_training'); // Clear flag
                    setTimeout(() => {
                        // Switch to training pane
                        switchToTab('training', { skipPersistence: false, smooth: true });
                        // Open completion modal for this training
                        setTimeout(() => {
                            // Fetch title from training resources if available
                            const trainingContainer = document.getElementById('trainingContainer');
                            let title = 'Training Completion Report';
                            if (trainingContainer) {
                                const resourceEl = trainingContainer.querySelector(`[data-resource-id="${trainingToOpen}"]`);
                                if (resourceEl) {
                                    const titleEl = resourceEl.querySelector('.training-title');
                                    if (titleEl) {
                                        title = titleEl.textContent || title;
                                    }
                                }
                            }
                            openCompletionModal(trainingToOpen, title);
                        }, 500);
                    }, 1000);
                } else {
                    // Restore active tab if no special training flow
                    restoreActiveTab();
                }
            }
        });

        // Auto-refresh data every 30 seconds
        function startAutoRefresh() {
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Refresh every 30 seconds
            autoRefreshInterval = setInterval(() => {
                
                // Get currently active tab
                const activeTab = document.querySelector('.tab.active');
                if (!activeTab) return;
                
                const tabName = activeTab.dataset.tab;
                
                // Refresh the active tab's data silently (no loading spinner)
                switch(tabName) {
                    case 'pipeline':
                        refreshPipeline();
                        break;
                    case 'reports':
                        refreshAIProfiles();
                        break;
                    case 'training':
                        loadTrainingResources(true); // Silent
                        break;
                    case 'tasks':
                        loadTasks(true); // Silent
                        break;
                    case 'hours':
                        loadHoursHistory(true); // Silent - no spinner on refresh
                        break;
                }
            }, 30000); // 30 seconds
            
        }

        // Silent refresh for pipeline (no spinner)
        async function refreshPipeline() {
            try {
                const response = await fetch(`${API_URL}?action=candidates&stage=all`);
                const data = await response.json();
                
                if (data.ok && data.candidates) {
                    const newCount = data.candidates.length;
                    const oldCount = candidates.length;
                    
                    candidates = data.candidates;
                    renderPipeline(candidates);
                    
                    if (newCount !== oldCount) {
                    }
                }
            } catch (error) {
                console.error('Auto-refresh error:', error);
            }
        }

        // Silent refresh for AI profiles (no spinner)
        async function refreshAIProfiles() {
            try {
                const response = await fetch(`${API_URL}?action=aiProfiles`);
                const data = await response.json();
                
                if (data.ok && data.profiles) {
                    const newCount = data.profiles.length;
                    const oldCount = allProfiles.length;
                    
                    allProfiles = data.profiles;
                    filterProfiles(currentFilter);
                    
                    if (newCount !== oldCount) {
                    }
                }
            } catch (error) {
                console.error('Auto-refresh error:', error);
            }
        }

        // Tab Switching (updated for sidebar)
        function switchToTab(targetTab, options = {}) {
            const { skipPersistence = false, smooth = true } = options;
            
            // Check admin password gate
            if (targetTab === 'admin' && !checkAdminAuth()) {
                promptAdminPassword((authenticated) => {
                    if (authenticated) {
                        // Retry switching to admin tab after successful auth
                        switchToTab('admin', options);
                    }
                });
                return;
            }
            
            // Show loading indicator for smooth transitions
            if (smooth) {
                let indicator = document.getElementById('tabSwitchingIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'tabSwitchingIndicator';
                    indicator.className = 'tab-switching-indicator';
                    document.body.appendChild(indicator);
                }
                indicator.classList.add('active');
                setTimeout(() => {
                    indicator.classList.remove('active');
                }, 400);
            }
            
            // Persist active tab to localStorage (unless explicitly skipped)
            if (!skipPersistence) {
                try {
                    localStorage.setItem('h2s_active_tab', targetTab);
                    localStorage.setItem('h2s_active_tab_timestamp', Date.now().toString());
                } catch (e) {
                    console.warn('Could not save active tab:', e);
                }
            }
            
            // Add smooth transition class to panes
            if (smooth) {
                document.querySelectorAll('.pane').forEach(p => {
                    p.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out';
                    p.style.opacity = '0';
                    p.style.transform = 'translateY(4px)';
                });
            }
            
            // CRITICAL: First, hide ALL panes to prevent stacking
            document.querySelectorAll('.pane').forEach(p => {
                p.classList.remove('active');
                // Force hide with inline style as backup (in case CSS is overridden)
                p.style.display = 'none';
            });
            
            // Update sidebar nav with smooth transition
            document.querySelectorAll('.app-sidebar-nav-item').forEach(item => {
                item.classList.remove('active');
                item.style.transition = 'all 0.2s ease-out';
            });
            const navItem = document.querySelector(`.app-sidebar-nav-item[data-tab="${targetTab}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            // Update hidden tabs (for compatibility)
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabElement = document.querySelector(`.tab[data-tab="${targetTab}"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Show ONLY the target pane with smooth fade-in
            const paneElement = document.getElementById(targetTab + '-pane');
            if (paneElement) {
                paneElement.classList.add('active');
                // Force show with inline style as backup (CSS will override with !important)
                paneElement.style.display = 'block';
                
                // Track tab view event
                if (typeof trackEvent === 'function') {
                    trackEvent('tab_view', {
                        tab_name: targetTab,
                        page_type: 'dashboard'
                    });
                }
                
                // If switching to offer builder, load performance data
                if (targetTab === 'offerbuilder') {
                    setTimeout(() => {
                        if (typeof offerBuilder !== 'undefined' && typeof offerBuilder.loadOfferPerformanceData === 'function') {
                            offerBuilder.loadOfferPerformanceData();
                        }
                    }, 300);
                }
                
                // Smooth fade-in animation
                if (smooth) {
                    requestAnimationFrame(() => {
                        paneElement.style.opacity = '0';
                        paneElement.style.transform = 'translateY(4px)';
                        requestAnimationFrame(() => {
                            paneElement.style.opacity = '1';
                            paneElement.style.transform = 'translateY(0)';
                        });
                    });
                }
                
                // After a brief delay, remove inline style to let CSS take over
                // This ensures CSS !important rules work while also having a fallback
                setTimeout(() => {
                    if (paneElement.classList.contains('active')) {
                        paneElement.style.display = '';
                        if (!smooth) {
                            paneElement.style.opacity = '';
                            paneElement.style.transform = '';
                        }
                    }
                }, smooth ? 200 : 100);
                
                // Initialize features if needed
                setTimeout(() => {
                    if (typeof initFeatureIfNeeded === 'function') {
                        initFeatureIfNeeded(targetTab);
                    }
                }, smooth ? 250 : 150);
            } else {
                console.error(`Pane not found: ${targetTab}-pane`);
            }
            
            // Update top bar title
            const areaTitles = {
                'pipeline': 'Pipeline',
                'screening': 'Screening Form',
                'techinterview': 'Tech Interview',
                'hours': 'Log Hours',
                'reports': 'Candidate Review',
                'training': 'Training',
                'tasks': 'Tasks',
                'deliverables': 'Deliverables',
                'admin': 'Admin Dashboard',
                'offerbuilder': 'Offer Builder'
            };
            const titleEl = document.getElementById('currentAreaTitle');
            if (titleEl) {
                titleEl.style.transition = 'opacity 0.15s ease-out';
                titleEl.style.opacity = '0';
                setTimeout(() => {
                    titleEl.textContent = areaTitles[targetTab] || 'Dashboard';
                    titleEl.style.opacity = '1';
                }, 100);
            }
            
            // Close drawer if open
            closeDetailDrawer();
            
            // Scroll to top when switching tabs - scroll both window and app-content
            window.scrollTo({ top: 0, behavior: smooth ? 'smooth' : 'auto' });
            const appContent = document.querySelector('#h2s-app .app-content');
            if (appContent) {
                appContent.scrollTop = 0;
            }
            // Also scroll the active pane to top
            if (paneElement) {
                paneElement.scrollTop = 0;
            }
            
            // Load data when specific tabs are clicked (only if pane is now active)
            // Use setTimeout to ensure pane is visible before loading
            setTimeout(() => {
                const activePane = document.getElementById(targetTab + '-pane');
                if (!activePane || !activePane.classList.contains('active')) {
                    return; // Pane was switched away before load completed
                }

                if (targetTab === 'pipeline') {
                    loadPipeline();
                } else if (targetTab === 'reports') {
                    loadAIProfiles();
                } else if (targetTab === 'training') {
                    loadTrainingResources();
                } else if (targetTab === 'deliverables') {
                    // Initialize deliverables view when tab is clicked
                    if (typeof switchDeliverablesView === 'function') {
                        const view = currentDeliverablesView || 'submission';
                        switchDeliverablesView(view);
                    } else {
                        console.error('switchDeliverablesView function not found');
                    }
                    // Refresh deliverables data to show latest submissions
                    setTimeout(() => {
                        if (typeof loadDeliverablesReview === 'function') {
                            loadDeliverablesReview();
                        }
                        if (typeof loadDeliverablesLibrary === 'function') {
                            loadDeliverablesLibrary();
                        }
                    }, 200);
                } else if (targetTab === 'tasks') {
                    loadTasks();
                } else if (targetTab === 'hours') {
                    loadHoursHistory();
                }
            }, 50);
        }

        // Tab Switching (legacy, for compatibility)
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchToTab(tab.dataset.tab);
                });
            });
        }

        // Load Pipeline
        async function loadPipeline(silent = false) {
            const container = document.getElementById('pipelineContainer');
            
            // Only show spinner on initial load, not on refreshes
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
                container.style.display = 'grid';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=candidates&stage=all`);
                const data = await response.json();
                
                if (data.ok) {
                    // API returns { ok: true, data: [...] }
                    candidates = data.data || data.candidates || [];
                    if (candidates.length === 0) {
                        container.style.display = 'block';
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">No candidates yet. Submit a screening form to get started.</div>
                            </div>
                        `;
                    } else {
                        container.style.display = 'grid';
                        renderPipeline(candidates);
                    }
                } else {
                    container.style.display = 'block';
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text" style="color: var(--danger);">Error: ${data.error || 'Failed to load candidates'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.style.display = 'block';
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error loading candidates. Check console for details.</div>
                    </div>
                `;
            }
        }

        // Pagination state for each pipeline column
        const pipelinePages = {
            'SCREENED': 1,
            'INTERVIEWED': 1,
            'HIRED': 1,
            'REJECTED': 1
        };
        const CARDS_PER_PAGE = 5;

        function renderPipeline(candidates) {
            const stages = ['SCREENED', 'INTERVIEWED', 'HIRED', 'REJECTED'];
            const stageNames = {
                'SCREENED': 'Screened',
                'INTERVIEWED': 'Interviewed',
                'HIRED': 'Hired',
                'REJECTED': 'Rejected'
            };

            // Deduplicate: Candidates should only appear in their current stage
            const seenCandidates = new Set();
            const uniqueCandidates = candidates.filter(c => {
                const key = c.Phone || c.phone || c.Email || c.email || c.Candidate_ID || c.id;
                if (seenCandidates.has(key)) {
                    return false;
                }
                seenCandidates.add(key);
                return true;
            });

            let html = '';
            
            stages.forEach(stage => {
                const stageCandidates = uniqueCandidates.filter(c => (c.Current_Stage || c.currentStage) === stage);
                const totalCount = stageCandidates.length;
                const currentPage = pipelinePages[stage] || 1;
                const totalPages = Math.ceil(totalCount / CARDS_PER_PAGE);
                
                // Calculate pagination slice
                const startIdx = (currentPage - 1) * CARDS_PER_PAGE;
                const endIdx = startIdx + CARDS_PER_PAGE;
                const paginatedCandidates = stageCandidates.slice(startIdx, endIdx);
                
                html += `
                    <div class="pipeline-column">
                        <div class="pipeline-header">
                            <span>${stageNames[stage]}</span>
                            <span class="pipeline-count">${totalCount}</span>
                        </div>
                        <div class="pipeline-cards-container">
                            ${totalCount === 0 ? 
                                '<div class="empty-state"><div class="empty-text">No candidates in this stage</div></div>' :
                                paginatedCandidates.map(c => {
                                    const daysSince = getDaysSince(c.Screening_Date);
                                    return `
                                        <div class="candidate-card">
                                            <button class="card-delete-btn" onclick="event.stopPropagation(); deleteCandidate('${c.Candidate_ID || c.id}', '${c.First_Name || c.firstName} ${c.Last_Name || c.lastName}')">Delete</button>
                                            <div onclick="viewCandidate('${c.Candidate_ID || c.id}')">
                                                <div class="candidate-name">${c.First_Name || c.firstName} ${c.Last_Name || c.lastName}</div>
                                                <div class="candidate-info">${c.Phone || c.phone}</div>
                                                <div class="candidate-date">${daysSince}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')
                            }
                        </div>
                        ${totalPages > 1 ? `
                            <div class="pipeline-pagination">
                                <div class="pagination-info">Page ${currentPage} of ${totalPages}</div>
                                <div class="pagination-controls">
                                    <button class="page-btn" onclick="changePage('${stage}', -1)" ${currentPage === 1 ? 'disabled' : ''}>
                                        ←
                                    </button>
                                    <button class="page-btn" onclick="changePage('${stage}', 1)" ${currentPage === totalPages ? 'disabled' : ''}>
                                        →
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            document.getElementById('pipelineContainer').innerHTML = html;
        }

        function changePage(stage, delta) {
            const totalCandidates = candidates.filter(c => c.Current_Stage === stage).length;
            const totalPages = Math.ceil(totalCandidates / CARDS_PER_PAGE);
            
            pipelinePages[stage] = Math.max(1, Math.min(pipelinePages[stage] + delta, totalPages));
            renderPipeline(candidates);
        }

        function getDaysSince(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return `${Math.floor(diffDays / 30)} months ago`;
        }

        // Delete candidate (archive with reason)
        async function deleteCandidate(candidateId, candidateName) {
            const confirmed = await showModal(
                'Delete Candidate',
                `Are you sure you want to delete "${candidateName}"? This will move them to the archive. This is useful for removing test data or candidates who should no longer be in the pipeline.`,
                { confirmText: 'Delete', danger: true }
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(
                    `${API_URL}?action=archiveCandidate&candidateId=${encodeURIComponent(candidateId)}&reason=${encodeURIComponent('Manually deleted - cleanup')}`,
                    { method: 'GET' }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    showToast(`Deleted: ${candidateName}`, 'success');
                    // Reload pipeline silently (no spinner)
                    loadPipeline(true);
                } else {
                    // More detailed error message
                    const errorMsg = result.error || 'Unknown error occurred';
                    showToast('Failed to delete: ' + errorMsg, 'error');
                    
                    // If it's a sheet not found error, suggest creating it
                    if (errorMsg.toLowerCase().includes('sheet') || errorMsg.toLowerCase().includes('not found')) {
                        await showModal(
                            'Archive Sheet Missing',
                            'The Candidate_Archive sheet needs to be created. Click OK to run the auto-archive function which will create it.',
                            { confirmText: 'OK' }
                        );
                    }
                }
            } catch (error) {
                showToast('Network or server error: ' + error.message, 'error');
            }
        }

        // Bulk cleanup - find and delete test candidates
        async function bulkCleanupPipeline() {
            const testKeywords = ['test', 'demo', 'sample', 'fake', 'example', 'asdf', 'qwer', 'zzz', 'xxx'];
            
            const testCandidates = candidates.filter(c => {
                const fullName = `${c.First_Name} ${c.Last_Name}`.toLowerCase();
                const phone = (c.Phone || '').toLowerCase();
                const email = (c.Email || '').toLowerCase();
                
                return testKeywords.some(keyword => 
                    fullName.includes(keyword) || 
                    phone.includes(keyword) || 
                    email.includes(keyword)
                );
            });
            
            if (testCandidates.length === 0) {
                await showModal(
                    'No Test Data Found',
                    'No candidates detected with test keywords (test, demo, sample, etc.). Your pipeline looks clean!',
                    { confirmText: 'OK' }
                );
                return;
            }
            
            const names = testCandidates.map(c => `${c.First_Name} ${c.Last_Name}`).join(', ');
            
            const confirmed = await showModal(
                'Bulk Cleanup',
                `Found ${testCandidates.length} potential test candidates:\n\n${names}\n\nDelete all of these?`,
                { confirmText: `Delete ${testCandidates.length}`, danger: true }
            );
            
            if (!confirmed) return;
            
            let deleted = 0;
            let failed = 0;
            
            for (const candidate of testCandidates) {
                try {
                    const response = await fetch(
                        `${API_URL}?action=archiveCandidate&candidateId=${encodeURIComponent(candidate.Candidate_ID)}&reason=${encodeURIComponent('Bulk cleanup - test data')}`,
                        { method: 'GET' }
                    );
                    
                    const result = await response.json();
                    
                    if (result.ok) {
                        deleted++;
                    } else {
                        failed++;
                    }
                } catch (error) {
                    failed++;
                }
            }
            
            showToast(`Bulk cleanup complete: ${deleted} deleted, ${failed} failed`, deleted > 0 ? 'success' : 'error');
            loadPipeline(true); // Silent reload
        }

        // Detail Drawer Functions
        function openDetailDrawer() {
            document.getElementById('detailDrawer').classList.add('open');
        }

        function closeDetailDrawer() {
            document.getElementById('detailDrawer').classList.remove('open');
        }

        function viewCandidate(candidateId) {
            const candidate = candidates.find(c => (c.Candidate_ID || c.id) === candidateId);
            if (!candidate) {
                showToast('Candidate not found', 'error');
                return;
            }

            const drawerBody = document.getElementById('drawerBody');
            const drawerTitle = document.getElementById('drawerTitle');
            
            drawerTitle.textContent = `${candidate.First_Name} ${candidate.Last_Name}`;
            
            const daysSince = getDaysSince(candidate.Screening_Date);
            
            drawerBody.innerHTML = `
                <div class="detail-section">
                    <div class="detail-section-title">Profile</div>
                    <div class="detail-field">
                        <div class="detail-field-label">Name</div>
                        <div class="detail-field-value">${candidate.First_Name} ${candidate.Last_Name}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Phone</div>
                        <div class="detail-field-value">${candidate.Phone || 'N/A'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Email</div>
                        <div class="detail-field-value">${candidate.Email || 'N/A'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Current Stage</div>
                        <div class="detail-field-value">${candidate.Current_Stage || 'N/A'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Days Since Screening</div>
                        <div class="detail-field-value">${daysSince}</div>
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">Actions</div>
                    <button class="btn" onclick="deleteCandidate('${candidate.Candidate_ID}', '${candidate.First_Name} ${candidate.Last_Name}'); closeDetailDrawer();" style="background: var(--danger); color: white; width: 100%; margin-bottom: 8px;">
                        Delete Candidate
                    </button>
                </div>
            `;
            
            openDetailDrawer();
        }

        // Pipeline Search Filter
        let filteredCandidates = [];
        function filterPipeline() {
            const searchTerm = document.getElementById('pipelineSearch').value.toLowerCase();
            if (!searchTerm) {
                renderPipeline(candidates);
                return;
            }
            
            filteredCandidates = candidates.filter(c => {
                const name = `${c.First_Name} ${c.Last_Name}`.toLowerCase();
                const phone = (c.Phone || '').toLowerCase();
                const email = (c.Email || '').toLowerCase();
                return name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm);
            });
            
            renderPipeline(filteredCandidates);
        }

        // Deliverables Functions
        let currentDeliverablesView = 'submission';
        
        function switchDeliverablesView(view) {
            currentDeliverablesView = view;
            
            // Hide all views
            document.getElementById('deliverablesSubmissionView').style.display = 'none';
            document.getElementById('deliverablesReviewView').style.display = 'none';
            document.getElementById('deliverablesLibraryView').style.display = 'none';
            
            // Reset tab buttons
            document.querySelectorAll('[id^="deliverablesTab"]').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });
            
            // Show selected view and activate tab
            if (view === 'submission') {
                document.getElementById('deliverablesSubmissionView').style.display = 'block';
                document.getElementById('deliverablesTabSubmission').style.background = 'var(--cobalt)';
                document.getElementById('deliverablesTabSubmission').style.color = 'white';
            } else if (view === 'review') {
                document.getElementById('deliverablesReviewView').style.display = 'block';
                document.getElementById('deliverablesTabReview').style.background = 'var(--cobalt)';
                document.getElementById('deliverablesTabReview').style.color = 'white';
                loadDeliverablesReview();
            } else if (view === 'library') {
                document.getElementById('deliverablesLibraryView').style.display = 'block';
                document.getElementById('deliverablesTabLibrary').style.background = 'var(--cobalt)';
                document.getElementById('deliverablesTabLibrary').style.color = 'white';
                loadDeliverablesLibrary();
            }
        }
        
        // File upload state
        let selectedFiles = [];
        
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = 'var(--azure)';
            event.currentTarget.style.background = 'var(--surface)';
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = 'var(--border)';
            event.currentTarget.style.background = 'var(--surface-2)';
        }
        
        function handleFileDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = 'var(--border)';
            event.currentTarget.style.background = 'var(--surface-2)';
            
            const files = Array.from(event.dataTransfer.files);
            addFiles(files);
        }
        
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }
        
        function addFiles(files) {
            selectedFiles = [...selectedFiles, ...files];
            updateFileDisplay();
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileDisplay();
            // Reset file input
            document.getElementById('deliverableFileInput').value = '';
        }
        
        function updateFileDisplay() {
            const display = document.getElementById('deliverableFileDisplay');
            const list = document.getElementById('deliverableFileList');
            
            if (selectedFiles.length === 0) {
                display.innerHTML = `
                    <div style="margin-bottom: 8px;">Drag and drop files here, or click to browse</div>
                    <div style="font-size: 12px; color: var(--muted);">Supports multiple files</div>
                `;
                list.style.display = 'none';
            } else {
                display.innerHTML = `<div style="font-size: 14px; color: var(--text); font-weight: 600;">${selectedFiles.length} file(s) selected</div>`;
                list.style.display = 'block';
                list.innerHTML = selectedFiles.map((file, index) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--surface); border-radius: 4px; margin-bottom: 4px;">
                        <div style="flex: 1; font-size: 13px; color: var(--text);">
                            <div style="font-weight: 600;">${file.name}</div>
                            <div style="font-size: 11px; color: var(--muted);">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button type="button" onclick="removeFile(${index})" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                `).join('');
            }
        }
        
        async function submitDeliverable(event) {
            event.preventDefault();
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            const title = document.getElementById('deliverableTitle').value.trim();
            const description = document.getElementById('deliverableDescription').value.trim();
            
            if (!title || !description) {
                showToast('Please fill in title and description', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }
            
            // Handle file uploads - convert to base64 data URLs
            let fileLinks = null;
            if (selectedFiles.length > 0) {
                submitBtn.textContent = 'Processing files...';
                try {
                    const fileData = await Promise.all(selectedFiles.map(async (file) => {
                        const reader = new FileReader();
                        const dataUrl = await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        return {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            dataUrl: dataUrl
                        };
                    }));
                    fileLinks = JSON.stringify(fileData);
                } catch (error) {
                    showToast(`Error processing files: ${error.message}`, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_URL}?action=submitDeliverable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        description,
                        fileLink: fileLinks,
                        submittedBy: currentUser || 'ROSEL'
                    })
                });
                
                const data = await response.json();
                
                if (data.ok && data.result) {
                    showToast('Deliverable submitted for review!', 'success');
                    document.getElementById('deliverableSubmissionForm').reset();
                    selectedFiles = [];
                    updateFileDisplay();
                    // Refresh review queue if it's open
                    if (currentDeliverablesView === 'review') {
                        loadDeliverablesReview();
                    }
                } else {
                    showToast(data.error || 'Failed to submit deliverable', 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        async function loadDeliverablesReview() {
            const container = document.getElementById('deliverablesReviewContainer');
            container.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch(`${API_URL}?action=deliverables&status=pending`);
                const data = await response.json();
                
                if (data.ok && data.deliverables && data.deliverables.length > 0) {
                    container.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: var(--gap-2);">
                            ${data.deliverables.map(d => `
                                <div class="card">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--gap-1);">
                                        <div style="flex: 1;">
                                            <h3 style="font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: var(--gap-1);">${d.Title || 'Untitled'}</h3>
                                            <p style="font-size: 14px; color: var(--muted); margin-bottom: var(--gap-1);">${d.Description || ''}</p>
                                            ${d.AI_Summary ? `
                                                    <div style="background: var(--surface-2); padding: var(--gap-2); border-radius: var(--radius); margin-bottom: var(--gap-1); border-left: 3px solid var(--azure);">
                                                    <div style="font-size: 12px; font-weight: 600; color: var(--azure); margin-bottom: 4px;">AI Analysis</div>
                                                    <div style="font-size: 13px; color: var(--text); margin-bottom: 8px;">${d.AI_Summary}</div>
                                                    ${d.AI_Quality_Score !== null ? `<div style="font-size: 12px; color: var(--muted);">Quality Score: <strong style="color: ${d.AI_Quality_Score >= 70 ? '#10b981' : d.AI_Quality_Score >= 50 ? '#f59e0b' : '#ef4444'}">${d.AI_Quality_Score}/100</strong></div>` : ''}
                                                            </div>
                                                        ` : ''}
                                            <div style="font-size: 13px; color: var(--muted);">
                                                <div>Submitted by: ${d.Submitted_By || 'Unknown'}</div>
                                                <div>Submitted: ${new Date(d.Created_At).toLocaleDateString()}</div>
                                                ${d.File_Link ? `
                                                    <div style="margin-top: 8px;">
                                                        ${(() => {
                                                            try {
                                                                const files = JSON.parse(d.File_Link);
                                                                if (Array.isArray(files)) {
                                                                    return files.map(f => `
                                                                        <div style="margin-bottom: 4px;">
                                                                            <a href="${f.dataUrl}" download="${f.name}" target="_blank" style="color: var(--azure); font-size: 12px;">${f.name} (${(f.size / 1024).toFixed(1)} KB)</a>
                                                                        </div>
                                                                    `).join('');
                                                                }
                                                            } catch (e) {
                                                                // Legacy format - just a URL string
                                                                return `<a href="${d.File_Link}" target="_blank" style="color: var(--azure);">View File/Link →</a>`;
                                                            }
                                                        })()}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: var(--gap-1); flex-shrink: 0; margin-left: var(--gap-2);">
                                            <button class="btn btn-success" onclick="approveDeliverable('${d.Deliverable_ID}')" style="min-width: 100px;">Approve</button>
                                            <button class="btn btn-danger" onclick="rejectDeliverable('${d.Deliverable_ID}')" style="min-width: 100px;">Reject</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">No deliverables pending review.</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error loading review queue: ${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function loadDeliverablesLibrary() {
            const container = document.getElementById('deliverablesLibraryContainer');
            container.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch(`${API_URL}?action=deliverables&status=published`);
                const data = await response.json();
                
                if (data.ok && data.deliverables && data.deliverables.length > 0) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--gap-2);">
                            ${data.deliverables.map(d => `
                                <div class="card">
                                    <h3 style="font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: var(--gap-1);">${d.Title || 'Untitled'}</h3>
                                    <p style="font-size: 14px; color: var(--muted); margin-bottom: var(--gap-1); line-height: 1.5;">${d.Description || ''}</p>
                                    ${d.AI_Summary ? `
                                            <div style="background: var(--surface-2); padding: var(--gap-2); border-radius: var(--radius); margin-bottom: var(--gap-1); border-left: 3px solid var(--azure);">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--azure); margin-bottom: 4px;">AI Analysis</div>
                                            <div style="font-size: 13px; color: var(--text); margin-bottom: 8px;">${d.AI_Summary}</div>
                                            ${d.AI_Quality_Score !== null ? `<div style="font-size: 12px; color: var(--muted);">Quality Score: <strong style="color: ${d.AI_Quality_Score >= 70 ? '#10b981' : d.AI_Quality_Score >= 50 ? '#f59e0b' : '#ef4444'}">${d.AI_Quality_Score}/100</strong></div>` : ''}
                                                </div>
                                                ` : ''}
                                    <div style="font-size: 13px; color: var(--muted); margin-bottom: var(--gap-1);">
                                        <div>By: ${d.Submitted_By || 'Unknown'}</div>
                                        <div>Published: ${d.Published_At ? new Date(d.Published_At).toLocaleDateString() : 'N/A'}</div>
                                    </div>
                                    ${d.File_Link ? `
                                        <div style="margin-top: var(--gap-1);">
                                            ${(() => {
                                                try {
                                                    const files = JSON.parse(d.File_Link);
                                                    if (Array.isArray(files)) {
                                                        return files.map(f => `
                                                            <a href="${f.dataUrl}" download="${f.name}" target="_blank" class="btn" style="background: var(--azure); color: white; width: 100%; margin-bottom: 4px; display: block; text-align: center; padding: 8px;">Download ${f.name}</a>
                                                        `).join('');
                                                    }
                                                } catch (e) {
                                                    // Legacy format
                                                    return `<a href="${d.File_Link}" target="_blank" class="btn" style="background: var(--azure); color: white; width: 100%; margin-top: var(--gap-1);">View →</a>`;
                                                }
                                            })()}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">No published deliverables yet.</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error loading library: ${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function approveDeliverable(deliverableId) {
            if (!confirm('Approve and publish this deliverable? It will be moved to the library.')) return;
            
            try {
                // First approve
                const approveResponse = await fetch(`${API_URL}?action=approveDeliverable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deliverableId,
                        reviewedBy: currentUser || 'ADMIN'
                    })
                });
                
                const approveData = await approveResponse.json();
                
                if (approveData.ok) {
                    // Then publish
                    const publishResponse = await fetch(`${API_URL}?action=publishDeliverable`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            deliverableId
                        })
                    });
                    
                    const publishData = await publishResponse.json();
                    
                    if (publishData.ok) {
                        showToast('Deliverable approved and published!', 'success');
                        loadDeliverablesReview();
                        loadDeliverablesLibrary();
                    } else {
                        showToast(publishData.error || 'Approved but failed to publish', 'error');
                        loadDeliverablesReview();
                    }
                } else {
                    showToast(approveData.error || 'Failed to approve deliverable', 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function rejectDeliverable(deliverableId) {
            const notes = prompt('Rejection reason (optional):');
            if (notes === null) return; // User cancelled
            
            try {
                const response = await fetch(`${API_URL}?action=rejectDeliverable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deliverableId,
                        reviewedBy: currentUser || 'ADMIN',
                        reviewNotes: notes || null
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showToast('Deliverable rejected', 'success');
                    loadDeliverablesReview();
                } else {
                    showToast(data.error || 'Failed to reject deliverable', 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // Initialize deliverables view - will be called when tab is clicked
        // No need to initialize on page load since it's hidden by default

        // Store all profiles for filtering
        let allProfiles = [];
        let currentFilter = 'pending'; // Default to pending review

        // Load AI Profiles
        async function loadAIProfiles(silent = false) {
            const container = document.getElementById('aiProfilesContainer');
            
            // Only show spinner on initial load
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
            }
            
            try {
                // Fetch candidates and extract profiles since aiProfiles endpoint might be unavailable
                const response = await fetch(`${API_URL}?action=candidates&stage=all`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                if (data.ok) {
                    const candidates = data.data || data.candidates || [];
                    
                    // Transform candidates to profiles format
                    allProfiles = candidates
                        .filter(c => c.AI_Candidate_Profiles && (Object.keys(c.AI_Candidate_Profiles).length > 0 || c.AI_Candidate_Profiles.Fit_Score))
                        .map(c => ({
                            ...c.AI_Candidate_Profiles,
                            Candidate_ID: c.Candidate_ID,
                            Candidate_Name: `${c.First_Name} ${c.Last_Name}`,
                            First_Name: c.First_Name,
                            Last_Name: c.Last_Name,
                            Phone: c.Phone,
                            Email: c.Email,
                            Current_Stage: c.Current_Stage,
                            Interview_Date: c.Interview_Date
                        }));

                    if (allProfiles.length > 0) {
                        filterProfiles(currentFilter); // Apply current filter
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">No AI profiles generated yet. Profiles are automatically created when tech interview forms are submitted.</div>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text" style="color: var(--danger);">Error: ${data.error || 'Failed to load AI profiles'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error loading AI profiles. Check console for details.</div>
                    </div>
                `;
            }
        }

        // Filter profiles by decision status
        function filterProfiles(filter) {
            currentFilter = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            // Filter profiles based on Manual_Decision
            let filteredProfiles = allProfiles;
            
            if (filter === 'pending') {
                // Show only profiles without a decision
                filteredProfiles = allProfiles.filter(p => !p.Manual_Decision || p.Manual_Decision === '');
            } else if (filter === 'passed') {
                // Show only PASSED profiles
                filteredProfiles = allProfiles.filter(p => p.Manual_Decision === 'PASS');
            } else if (filter === 'failed') {
                // Show only FAILED profiles
                filteredProfiles = allProfiles.filter(p => p.Manual_Decision === 'FAIL');
            }
            // 'all' shows everything (no filtering)
            
            renderAIProfiles(filteredProfiles);
        }

        // Make decision on a candidate (PASS or FAIL)
        async function makeDecision(candidateId, decision) {
            let notes = '';
            
            // For FAIL decisions, collect feedback/reason (feedback loop) - REQUIRED
            if (decision === 'FAIL') {
                // Use a custom modal that validates the field
                const modalResult = await new Promise((resolve) => {
                    const modalHtml = `
                        <div style="padding: 20px 0;">
                            <p style="margin-bottom: 16px; color: #374151; font-size: 14px; line-height: 1.6;">
                                Why is this candidate being rejected? <span style="color: #ef4444; font-weight: 700; font-size: 18px;">*</span>
                            </p>
                            <p style="margin-bottom: 12px; font-size: 12px; color: #6b7280; font-style: italic;">
                                This feedback is <strong style="color: #ef4444;">required</strong> and helps improve our screening process.
                            </p>
                            <textarea 
                                id="rejectionFeedback" 
                                placeholder="e.g., Missing required tools, unclear communication, scheduling conflicts, not available for required hours, etc."
                                required
                                style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                                onfocus="this.style.borderColor='#0a2a5a'"
                                onblur="this.style.borderColor='#e5e7eb'"
                            ></textarea>
                            <p id="rejectionFeedbackError" style="margin-top: 8px; font-size: 12px; color: #ef4444; display: none; font-weight: 600;">⚠️ Please provide a rejection reason</p>
                        </div>
                    `;
                    
                    // Show modal and set up validation
                    showModal('Reject Candidate - Provide Feedback', modalHtml, {
                        width: '500px',
                        html: true,
                        confirmText: 'Reject',
                        danger: true
                    });
                    
                    // Override confirm button to validate before closing
                    setTimeout(() => {
                        const confirmBtn = document.getElementById('modalConfirmBtn');
                        if (confirmBtn) {
                            // Store original handler
                            const originalOnClick = confirmBtn.onclick;
                            
                            // Replace with validation handler
                            confirmBtn.onclick = () => {
                                const feedbackEl = document.getElementById('rejectionFeedback');
                                const errorEl = document.getElementById('rejectionFeedbackError');
                                const feedbackValue = feedbackEl ? feedbackEl.value.trim() : '';
                                
                                if (!feedbackValue) {
                                    // Show error and prevent closing
                                    if (errorEl) errorEl.style.display = 'block';
                                    if (feedbackEl) {
                                        feedbackEl.style.borderColor = '#ef4444';
                                        feedbackEl.focus();
                                    }
                                    showToast('Please provide a rejection reason', 'error');
                                    return false; // Prevent modal from closing
                                }
                                
                                // Valid - store value globally and proceed
                                window._pendingRejectionNotes = feedbackValue;
                                if (originalOnClick) originalOnClick();
                            };
                        }
                        
                        // Focus textarea when modal opens
                        const feedbackEl = document.getElementById('rejectionFeedback');
                        if (feedbackEl) feedbackEl.focus();
                    }, 150);
                    
                    // Wait for modal to close (check if overlay is hidden)
                    const checkModalClosed = () => {
                        const checkInterval = setInterval(() => {
                            const overlay = document.getElementById('modalOverlay');
                            if (overlay && !overlay.classList.contains('active')) {
                                clearInterval(checkInterval);
                                
                                // Get the notes if modal was confirmed (check if notes were stored)
                                const notes = window._pendingRejectionNotes || null;
                                if (notes) {
                                    delete window._pendingRejectionNotes;
                                    resolve(notes);
                                } else {
                                    resolve(null); // User cancelled
                                }
                            }
                        }, 100);
                    };
                    
                    checkModalClosed();
                });
                
                if (!modalResult) return; // User cancelled or validation failed
                notes = modalResult;
            } else {
                // For PASS, simple confirmation
                const title = 'Pass Candidate';
                const message = 'Mark this candidate as PASSED?';
                
                const confirmed = await showModal(title, message, {
                    confirmText: 'Pass',
                    danger: false
                });
                
                if (!confirmed) return;
            }
            
            // Find the profile card for smooth animation
            const profileCards = document.querySelectorAll('.ai-profile-card');
            let targetCard = null;
            profileCards.forEach(card => {
                if (card.dataset.candidateId === candidateId) {
                    targetCard = card;
                }
            });
            
            // Add fade-out animation
            if (targetCard) {
                targetCard.style.transition = 'all 0.4s ease';
                targetCard.style.opacity = '0';
                targetCard.style.transform = 'scale(0.95)';
            }
            
            try {
                // Include notes/feedback in the request (backend already supports this)
                const urlParams = new URLSearchParams({
                    action: 'updateDecision',
                    candidateId: candidateId,
                    decision: decision
                });
                
                // Add notes if provided (especially for FAIL decisions)
                if (notes) {
                    urlParams.append('notes', notes);
                }
                
                const url = `${API_URL}?${urlParams.toString()}`;
                
                const response = await fetch(url, { 
                    method: 'GET',
                    redirect: 'follow'
                });
                
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    // Wait for animation, then smoothly remove card
                    setTimeout(() => {
                        if (targetCard) {
                            targetCard.remove();
                        }
                        // Update the count without full reload
                        const container = document.getElementById('aiProfilesContainer');
                        const remainingCards = container.querySelectorAll('.ai-profile-card');
                        if (remainingCards.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-text">No candidates pending review</div>
                                </div>
                            `;
                        }
                        
                        // If PASSED, refresh the pipeline to show them in HIRED
                        if (decision === 'PASS') {
                            showToast('Candidate moved to HIRED', 'success');
                            // Silently refresh pipeline in background
                            loadPipeline(true);
                        } else {
                            showToast(`Candidate marked as ${decision}`, 'success');
                        }
                    }, 400);
                } else {
                    if (targetCard) {
                        targetCard.style.opacity = '1';
                        targetCard.style.transform = 'scale(1)';
                    }
                    showToast('Error: ' + result.error, 'error');
                }
            } catch (error) {
                if (targetCard) {
                    targetCard.style.opacity = '1';
                    targetCard.style.transform = 'scale(1)';
                }
                showToast('Failed to update: ' + error.message, 'error');
            }
        }

        // Edit rejection reason for a candidate
        async function editRejectionReason(candidateId, currentNotes) {
            const modalHtml = `
                <div style="padding: 20px 0;">
                    <p style="margin-bottom: 16px; color: #374151; font-size: 14px; line-height: 1.6;">
                        Edit Rejection Reason <span style="color: #ef4444; font-weight: 700; font-size: 18px;">*</span>
                    </p>
                    <textarea 
                        id="editRejectionFeedback" 
                        placeholder="e.g., Missing required tools, unclear communication, scheduling conflicts, not available for required hours, etc."
                        style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                        onfocus="this.style.borderColor='#0a2a5a'"
                        onblur="this.style.borderColor='#e5e7eb'"
                    >${(currentNotes || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                    <p id="editRejectionFeedbackError" style="margin-top: 8px; font-size: 12px; color: #ef4444; display: none; font-weight: 600;">⚠️ Please provide a rejection reason</p>
                </div>
            `;
            
            const confirmed = await showModal('Edit Rejection Reason', modalHtml, {
                width: '500px',
                html: true,
                confirmText: 'Save',
                danger: false
            });
            
            if (!confirmed) return;
            
            // Validate and update
            const feedbackEl = document.getElementById('editRejectionFeedback');
            const errorEl = document.getElementById('editRejectionFeedbackError');
            const notes = feedbackEl ? feedbackEl.value.trim() : '';
            
            if (!notes) {
                if (errorEl) errorEl.style.display = 'block';
                if (feedbackEl) {
                    feedbackEl.style.borderColor = '#ef4444';
                    feedbackEl.focus();
                }
                showToast('Please provide a rejection reason', 'error');
                return;
            }
            
            // Update via API
            try {
                const urlParams = new URLSearchParams({
                    action: 'updateDecision',
                    candidateId: candidateId,
                    decision: 'FAIL',
                    notes: notes
                });
                
                const response = await fetch(`${API_URL}?${urlParams.toString()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    showToast('Rejection reason updated', 'success');
                    // Reload profiles to show updated reason
                    loadAIProfiles();
                } else {
                    showToast('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Failed to update: ' + error.message, 'error');
            }
        }

        function renderAIProfiles(profiles) {
            // Sort by fit score descending (best first)
            profiles.sort((a, b) => (b.Fit_Score || 0) - (a.Fit_Score || 0));
            
            const html = profiles.map(profile => {
                const recommendation = (profile.Recommendation || 'MAYBE').toUpperCase();
                const recClass = recommendation === 'HIRE' ? 'rec-hire' : 
                                recommendation === 'PASS' ? 'rec-pass' : 'rec-maybe';
                
                const fitScore = profile.Fit_Score || 0;
                const scoreClass = `score-${fitScore}`;
                
                const strengths = (profile.Strengths || 'No strengths listed').split('\n').filter(s => s.trim());
                const concerns = (profile.Concerns || 'No concerns listed').split('\n').filter(s => s.trim());
                
                // Safely get candidate name and contact info
                const candidateName = profile.Candidate_Name || `Candidate ${profile.Candidate_ID || 'Unknown'}`;
                const phone = profile.Phone || 'N/A';
                const email = profile.Email || 'N/A';
                
                return `
                    <div class="ai-profile-card" data-candidate-id="${profile.Candidate_ID}">
                        <div class="ai-profile-header">
                            <div>
                                <div class="ai-profile-name">${candidateName}</div>
                                <div class="ai-profile-contact"><strong>Phone:</strong> ${phone}</div>
                                <div class="ai-profile-contact"><strong>Email:</strong> ${email}</div>
                            </div>
                            <div class="ai-fit-score">
                                <div class="ai-score-number ${scoreClass}">${fitScore}</div>
                                <div class="ai-score-label">Fit Score</div>
                            </div>
                        </div>
                        
                        <div class="ai-recommendation ${recClass}">
                            ${recommendation}
                        </div>
                        
                        <div class="ai-section">
                            <div class="ai-section-title">Summary</div>
                            <div class="ai-summary">${profile.Profile_Summary || 'No summary available'}</div>
                        </div>
                        
                        <div class="ai-section">
                            <div class="ai-section-title">Strengths</div>
                            <ul class="ai-list">
                                ${strengths.map(s => `<li>${s.replace(/^[•\-\*]\s*/, '')}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="ai-section">
                            <div class="ai-section-title">Concerns</div>
                            <ul class="ai-list">
                                ${concerns.map(c => `<li>${c.replace(/^[•\-\*]\s*/, '')}</li>`).join('')}
                            </ul>
                        </div>
                        
                        ${profile.Manual_Decision && profile.Manual_Decision !== '' ? `
                            <div class="decision-badge ${profile.Manual_Decision.toLowerCase()}">
                                ${profile.Manual_Decision === 'PASS' ? 'PASSED' : 'FAILED'} by ${profile.Decision_By || 'ROSEL'}
                                <small>Decision made: ${formatDate(profile.Decision_Date)}</small>
                                ${profile.Manual_Decision === 'FAIL' && profile.Decision_Notes ? `
                                    <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); border-radius: 6px;">
                                        <div style="font-size: 12px; font-weight: 700; color: var(--danger); margin-bottom: 6px;">Rejection Reason:</div>
                                        <div style="font-size: 13px; color: #374151; line-height: 1.5;">${profile.Decision_Notes}</div>
                                        <button onclick="editRejectionReason('${profile.Candidate_ID}', '${profile.Decision_Notes.replace(/'/g, "\\'")}')" style="margin-top: 8px; padding: 6px 12px; background: white; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fee'; this.style.borderColor='#dc2626'" onmouseout="this.style.background='white'; this.style.borderColor='var(--danger)'">✏️ Edit Reason</button>
                                    </div>
                                ` : profile.Manual_Decision === 'FAIL' ? `
                                    <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); border-radius: 6px;">
                                        <div style="font-size: 12px; color: #6b7280; font-style: italic;">No rejection reason provided</div>
                                        <button onclick="editRejectionReason('${profile.Candidate_ID}', '')" style="margin-top: 8px; padding: 6px 12px; background: white; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fee'; this.style.borderColor='#dc2626'" onmouseout="this.style.background='white'; this.style.borderColor='var(--danger)'">✏️ Add Reason</button>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="ai-profile-actions">
                                <button class="action-btn pass-btn" onclick="makeDecision('${profile.Candidate_ID}', 'PASS')">
                                    PASS
                                </button>
                                <button class="action-btn fail-btn" onclick="makeDecision('${profile.Candidate_ID}', 'FAIL')">
                                    FAIL
                                </button>
                            </div>
                        `}
                        
                        <div class="ai-profile-footer">
                            <span>Generated: ${formatDate(profile.Profile_Generated_At)}</span>
                            <span class="ai-model-badge">${profile.AI_Model_Used || 'GPT-4'}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Handle empty state with filter context
            if (profiles.length === 0) {
                const filterName = currentFilter === 'pending' ? 'pending review' : 
                                  currentFilter === 'passed' ? 'passed' : 
                                  currentFilter === 'failed' ? 'failed' : 'this filter';
                document.getElementById('aiProfilesContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">No candidates ${filterName}</div>
                    </div>
                `;
            } else {
                document.getElementById('aiProfilesContainer').innerHTML = `<div class="ai-profiles-grid">${html}</div>`;
            }
        }

        // Setup Forms
        function setupForms() {
            // Hours form is now modal-based, no inline form to setup
        }

        // Hours Modal Functions
        function openHoursModal() {
            document.getElementById('hoursModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Set defaults
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('hoursDate').value = today;
            document.getElementById('hoursStart').value = '09:00';
            document.getElementById('hoursEnd').value = '17:00';
            
            // Clear text areas
            document.getElementById('hoursTasks').value = '';
            document.getElementById('hoursLearned').value = '';
            document.getElementById('hoursBlockers').value = '';
            
            calculateDuration();
        }

        function calculateDuration() {
            const startVal = document.getElementById('hoursStart').value;
            const endVal = document.getElementById('hoursEnd').value;
            const display = document.getElementById('durationDisplay');
            
            if (!startVal || !endVal) {
                display.textContent = '--';
                return;
            }
            
            const start = new Date(`2000-01-01T${startVal}`);
            const end = new Date(`2000-01-01T${endVal}`);
            let diff = (end - start) / (1000 * 60 * 60);
            
            if (diff < 0) diff += 24; // Handle overnight shifts
            
            // Format to 1 decimal place, ensure it's precise
            const hours = Math.round(diff * 10) / 10;
            
            // Display with clear labeling
            display.textContent = hours.toFixed(1) + 'h';
            display.style.color = diff > 0 ? 'var(--azure)' : 'var(--danger)';
            
            // Update tooltip to show calculation details
            display.title = `Work duration: ${startVal} to ${endVal} = ${hours.toFixed(1)} hours`;
        }

        function closeHoursModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('hoursModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function submitHours() {
            const submitBtn = document.querySelector('#hoursModal button[onclick="submitHours()"]');
            const originalBtnText = submitBtn?.textContent || 'Log Hours';
            
            // Generate request ID for tracing
            const requestId = `hours_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Client-side logging
            const date = document.getElementById('hoursDate').value;
            const startTime = document.getElementById('hoursStart').value;
            const endTime = document.getElementById('hoursEnd').value;
            const tasksInput = document.getElementById('hoursTasks').value;
            const learnedInput = document.getElementById('hoursLearned').value;
            const blockersInput = document.getElementById('hoursBlockers').value || 'None';
            
            // Validation
            if (!date || !startTime || !endTime || !tasksInput || !learnedInput) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Validate user identity
            if (!currentUser || currentUser === 'DEMO') {
                showToast('Please select a user before logging hours', 'error');
                return;
            }
            
            // Calculate duration
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            let diff = (end - start) / (1000 * 60 * 60);
            
            if (diff <= 0) {
                showToast('End time must be after start time', 'error');
                return;
            }
            
            if (diff > 24) {
                showToast('Hours cannot exceed 24 hours. Please check your times.', 'error');
                return;
            }
            
            const hours = Math.round(diff * 100) / 100;
            
            // Combine into structured format
            const combinedLog = `[SHIFT: ${startTime} - ${endTime} (${hours}h)]\n\n[TASKS]\n${tasksInput}\n\n[WINS/LEARNINGS]\n${learnedInput}\n\n[BLOCKERS]\n${blockersInput}`;
            
            const data = { 
                date, 
                hours, 
                vaName: currentUser,
                tasks: combinedLog,
                analysisPrompt: `Analyze this work log with focus on: 1) Specific outcomes achieved (revenue-generating tasks prioritized?), 2) Learning and skill development demonstrated, 3) Process improvements or blockers to address, 4) Priorities for tomorrow based on today's patterns. Be direct and constructive.`,
                requestId: requestId
            };
            
            // Disable button and show loading
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Logging...';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=logHours`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    showToast('✅ Hours logged successfully!', 'success');
                    closeHoursModal();
                    loadHoursHistory();
                    
                    // Refresh Admin Dashboard if it's currently visible
                    const adminPane = document.getElementById('admin-pane');
                    if (adminPane && adminPane.classList.contains('active')) {
                        setTimeout(() => {
                            if (typeof adminDashboard !== 'undefined' && adminDashboard.refresh) {
                                adminDashboard.refresh();
                            }
                        }, 500);
                    }
                } else {
                    const errorMsg = result.error || 'Unknown error occurred';
                    let userMessage = 'Failed to log hours. ';
                    
                    if (errorMsg.includes('duplicate') || errorMsg.includes('already exists')) {
                        userMessage += 'You have already logged hours for this date. Please check your history or contact support if you need to update.';
                    } else if (errorMsg.includes('validation') || errorMsg.includes('invalid')) {
                        userMessage += 'Please check your input and try again.';
                    } else if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
                        userMessage += 'Network error. Please check your connection and try again.';
                    } else {
                        userMessage += errorMsg;
                    }
                    
                    showToast(userMessage, 'error');
                }
            } catch (error) {
                const errorMsg = error.message || 'Network error';
                showToast(`Failed to log hours: ${errorMsg}. Please check your connection and try again.`, 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            }
        }

        // Load Hours History
        async function loadHoursHistory(silent = false) {
            const container = document.getElementById('hoursHistoryContainer');
            
            // Only show spinner on initial load, not on auto-refresh
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
            }
            
            try {
                // Pass vaName query param to filter by user (if not DEMO)
                const vaNameParam = currentUser && currentUser !== 'DEMO' 
                    ? `&vaName=${encodeURIComponent(currentUser)}` 
                    : '';
                const response = await fetch(`${API_URL}?action=hours${vaNameParam}`);
                
                // Check HTTP status
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.ok) {
                    const entries = data.hours || [];
                    if (entries.length > 0) {
                        renderHoursHistory(entries);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">No hours logged yet. Click "Log Today's Hours" to get started.</div>
                            </div>
                        `;
                    }
                } else {
                    // Only show error if not silent
                    if (!silent) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text" style="color: var(--danger);">Error loading hours: ${data.error || 'Unknown error'}. Please refresh the page.</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                if (!silent) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text" style="color: var(--danger);">Network error loading hours. Please check your connection and refresh.</div>
                        </div>
                    `;
                }
            }
        }

        // Add Task Modal Functions
        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
            document.getElementById('newTaskDueDate').valueAsDate = new Date();
            // Reset recurrence defaults
            document.getElementById('newTaskRecurrence').value = 'none';
            document.getElementById('newTaskRetention').value = '7';
            document.getElementById('newTaskDueTime').value = '09:00';
        }
        // Calendar modal controls
        function openCalendarModal() {
            const dateEl = document.getElementById('newTaskDueDate');
            const timeEl = document.getElementById('newTaskDueTime');
            document.getElementById('calendarDate').value = dateEl.value || new Date().toISOString().split('T')[0];
            document.getElementById('calendarTime').value = timeEl.value || '09:00';
            document.getElementById('calendarModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCalendarModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('calendarModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function applyCalendarSelection() {
            const date = document.getElementById('calendarDate').value;
            const time = document.getElementById('calendarTime').value;
            if (date) document.getElementById('newTaskDueDate').value = date;
            if (time) document.getElementById('newTaskDueTime').value = time;
            closeCalendarModal();
        }

        function closeAddTaskModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('addTaskModal').classList.remove('active');
            document.getElementById('addTaskForm').reset();
        }

        async function polishTaskDescription() {
            const title = document.getElementById('newTaskTitle').value;
            const description = document.getElementById('newTaskDescription').value;
            const btn = document.querySelector('button[onclick="polishTaskDescription()"]');
            
            if (!description) {
                showToast('Please enter some rough notes first', 'error');
                return;
            }
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '✨ Polishing...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}?action=refineTask&title=${encodeURIComponent(title)}&description=${encodeURIComponent(description)}`);
                const data = await response.json();
                
                if (data.ok) {
                    document.getElementById('newTaskDescription').value = data.refinedDescription;
                    showToast('Task polished by AI!', 'success');
                } else {
                    showToast('Failed to polish task: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function submitNewTask(event) {
            event.preventDefault();
            
            const btn = event.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Creating...';
            btn.disabled = true;
            
            const taskData = {
                title: document.getElementById('newTaskTitle').value,
                description: document.getElementById('newTaskDescription').value,
                priority: document.getElementById('newTaskPriority').value,
                dueDate: document.getElementById('newTaskDueDate').value,
                dueTime: document.getElementById('newTaskDueTime').value,
                recurrence: document.getElementById('newTaskRecurrence').value, // none|daily|weekly
                retentionDays: parseInt(document.getElementById('newTaskRetention').value || '7', 10) // how long it stays in Done
            };
            
            try {
                const response = await fetch(`${API_URL}?action=addTask`, {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });
                const data = await response.json();
                
                if (data.ok) {
                    showToast('Task created successfully!', 'success');
                            closeAddTaskModal();
                    loadTasks(); // Refresh list
                    } else {
                    showToast('Failed to create task: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function renderHoursHistory(entries) {
            // Normalize field names (backend returns capital case)
            const normalizedEntries = entries.map(entry => ({
                date: entry.Date || entry.date,
                hours: entry.Hours || entry.hours,
                tasks: entry.Tasks || entry.tasks,
                aiSummary: entry.AI_Summary || entry.aiSummary,
                loggedBy: entry.Logged_By || entry.loggedBy
            }));
            
            // Filter to only show entries from last 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const recentEntries = normalizedEntries.filter(entry => {
                if (!entry.date) return false;
                const entryDate = new Date(entry.date);
                return entryDate >= sevenDaysAgo;
            });
            
            // If no recent entries after filtering, show message
            if (recentEntries.length === 0) {
                document.getElementById('hoursHistoryContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">No hours logged in the last 7 days. Click "Log Today's Hours" to get started.</div>
                    </div>
                `;
                return;
            }
            
            const html = `
                <table class="hours-table">
                    <thead>
                        <tr>
                            <th style="width: 120px;">Date</th>
                            <th style="width: 80px;">Hours</th>
                            <th>Daily Summary</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${recentEntries.map(entry => {
                        // Safely get loggedBy as string
                        let loggedByName = 'ROSEL';
                        if (entry.loggedBy) {
                            if (typeof entry.loggedBy === 'string') {
                                loggedByName = entry.loggedBy;
                            } else {
                                loggedByName = 'ROSEL'; // Default if it's an object
                            }
                        }
                        
                        return `
                                <tr>
                                    <td>
                                        <div class="hours-date">${formatDate(entry.date)}</div>
                                        <div style="font-size: 11px; color: #5f6368; margin-top: 4px;">${loggedByName}</div>
                                    </td>
                                    <td>
                                        <div class="hours-amount">${entry.hours || 0}h</div>
                                    </td>
                                    <td>
                                        <div class="hours-summary">${entry.aiSummary || entry.tasks || 'No summary available'}</div>
                                    </td>
                                </tr>
                        `;
                    }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('hoursHistoryContainer').innerHTML = html;
        }

        async function handleHoursSubmit(e) {
            e.preventDefault();
            
            const data = {
                date: document.getElementById('hoursDate').value,
                hours: parseFloat(document.getElementById('hoursWorked').value),
                tasks: document.getElementById('tasks').value,
                vaName: currentUser || 'ROSEL' // Include vaName for proper attribution
            };

            try {
                const response = await fetch(`${API_URL}?action=logHours`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    alert('✅ Hours logged successfully!');
                    e.target.reset();
                    initHoursForm();
                    // Reload hours history if function exists
                    if (typeof loadHoursHistory === 'function') {
                        loadHoursHistory();
                    }
                } else {
                    alert('❌ Error: ' + result.error);
                }
            } catch (error) {
                alert('❌ Error logging hours: ' + error);
            }
        }

        function initHoursForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('hoursDate').value = today;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString();
        }

        // Refresh GHL form iframe (reload without full page refresh)
        function refreshForm(iframeId) {
            const iframe = document.getElementById(iframeId);
            if (iframe) {
                // Force iframe reload by resetting src
                const currentSrc = iframe.src;
                iframe.src = '';
                setTimeout(() => {
                    iframe.src = currentSrc;
                }, 100);
            }
        }

        // Load Training Resources
        function renderTrainingResources(resources) {
            const html = resources.map(resource => {
                const type = (resource.Type || 'VIDEO').toUpperCase();
                const typeClass = type === 'VIDEO' ? 'type-video' : type === 'PDF' ? 'type-pdf' : 'type-sop';
                
                // Check if completed
                const completions = resource.completions || [];
                const isCompleted = completions.length > 0;
                const latestCompletion = isCompleted ? completions[0] : null;
                const analysisStatus = latestCompletion && (latestCompletion.AI_Analysis_Raw || latestCompletion.AI_Extracted_Concepts || latestCompletion.AI_Knowledge_Gaps)
                    ? `Analyzed ${formatDate(latestCompletion.Completed_At)}`
                    : (isCompleted ? 'Pending AI analysis' : 'Not started');

                // Course status badge
                let statusLabel = 'Not Started';
                let statusClass = 'status-not-started';
                let statusIcon = '⭕';
                
                if (isCompleted) {
                    statusLabel = 'Completed';
                    statusClass = 'status-completed';
                    statusIcon = '✅';
                } else if (resource.Progress && Number(resource.Progress) > 0) {
                    statusLabel = 'In Progress';
                    statusClass = 'status-in-progress';
                    statusIcon = '⏳';
                }
                
                // Parse skills and difficulty
                const skills = resource.Skills_Taught ? resource.Skills_Taught.split(',').map(s => s.trim()) : [];
                const difficulty = resource.Difficulty_Level || 'BEGINNER';
                
                let content = '';

                if (type === 'VIDEO' && resource.URL) {
                    // Support both Loom and YouTube
                    let videoId = '';
                    let platform = 'loom';
                    
                    if (resource.URL.includes('youtube.com') || resource.URL.includes('youtu.be')) {
                        platform = 'youtube';
                        const ytMatch = resource.URL.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]+)/);
                        if (ytMatch) videoId = ytMatch[1];
                    } else if (resource.URL.includes('loom.com/share/')) {
                        videoId = resource.URL.split('loom.com/share/')[1].split('?')[0];
                    } else if (resource.URL.includes('loom.com/embed/')) {
                        videoId = resource.URL.split('loom.com/embed/')[1].split('?')[0];
                    }
                    
                    if (videoId && platform === 'youtube') {
                        content = `
                            <div style="position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <iframe 
                                    src="https://www.youtube.com/embed/${videoId}"
                                    style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0;"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen
                                ></iframe>
                            </div>
                        `;
                    } else if (videoId && platform === 'loom') {
                        content = `
                            <div style="position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <iframe 
                                    src="https://www.loom.com/embed/${videoId}?hide_title=true&hide_owner=true"
                                    allow="fullscreen; picture-in-picture"
                                    style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0; display: block;"
                                ></iframe>
                            </div>
                        `;
                    } else {
                        content = `<div style="padding: 32px; text-align: center; background: #f8f9fa; border-radius: 8px; border: 2px dashed #e0e0e0;">
                            <a href="${resource.URL}" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--cobalt); color: #fff; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 14px; transition: transform 0.2s;">
                                <span>▶️</span> Open Video Link
                            </a>
                        </div>`;
                    }
                } else if (type === 'PDF' && resource.URL) {
                    const preview = (resource.Description || '').substring(0, 180);
                    content = `
                        <div style="padding: 24px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display:flex; align-items:center; gap:10px; font-weight:800; color:var(--cobalt); font-size:16px; margin-bottom:12px;">
                                <span style="font-size: 24px;">📄</span> PDF Document
                            </div>
                            <p style="color:#4b5563; font-size:14px; line-height:1.6; margin-bottom: 16px;">${preview || 'No description available.'}</p>
                            <a href="${resource.URL}" target="_blank" class="btn" style="background: white; color: var(--cobalt); border: 2px solid var(--cobalt); width: 100%; justify-content: center;">
                                Open PDF
                            </a>
                        </div>`;
                } else if (type === 'SOP' && resource.URL) {
                    const preview = (resource.Description || '').substring(0, 200);
                    content = `
                        <div style="padding: 24px; background: #f0f7ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                            <div style="display:flex; align-items:center; gap:10px; font-weight:800; color:var(--azure); font-size:16px; margin-bottom:12px;">
                                <span style="font-size: 24px;">📋</span> Standard Operating Procedure
                            </div>
                            <p style="color:#1e3a8a; font-size:14px; line-height:1.6; margin-bottom: 16px;">${preview || 'No description available.'}</p>
                            <a href="${resource.URL}" target="_blank" class="btn" style="background: var(--azure); color: white; width: 100%; justify-content: center;">
                                View SOP
                            </a>
                        </div>`;
                }
                
                return `
                    <div class="training-card" data-resource-id="${resource.Resource_ID}" style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 20px; transition: transform 0.2s, box-shadow 0.2s;">
                        
                        <!-- Header -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px; margin-bottom: 12px;">
                                <h3 style="font-size: 18px; font-weight: 800; color: var(--cobalt); line-height: 1.4; margin: 0;">${resource.Title || 'Untitled Resource'}</h3>
                                ${isCompleted ? `<span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; white-space: nowrap;">✅ Done</span>` : ''}
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="background: #f3f4f6; color: #4b5563; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;">${resource.Category || 'General'}</span>
                                <span style="background: #f3f4f6; color: #4b5563; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;">⏱️ ${resource.Estimated_Minutes || '?'} min</span>
                                <span style="background: #eff6ff; color: var(--azure); padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700;">${type}</span>
                            </div>
                        </div>

                        <!-- Content -->
                        <div style="flex: 1;">
                            ${content}
                        </div>
                        
                        <!-- Description -->
                        ${resource.Description ? `<p style="color: #6b7280; font-size: 14px; line-height: 1.6; margin: 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${resource.Description}</p>` : ''}
                        
                        <!-- Footer / Action -->
                        <div style="padding-top: 20px; border-top: 1px solid #f3f4f6; display: flex; flex-direction: column; gap: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; color: #9ca3af; font-weight: 500;">
                                    ${isCompleted ? `Completed ${formatDate(latestCompletion.Completed_At)}` : 'Not completed yet'}
                                </div>
                            </div>
                            
                            ${!isCompleted ? `
                                <button 
                                    onclick="openCompletionModal('${resource.Resource_ID}', '${resource.Title.replace(/'/g, "\\'")}')"
                                    style="padding: 14px 20px; background: var(--cobalt); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(10, 42, 90, 0.2); width: 100%; text-align: center;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(10, 42, 90, 0.3)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(10, 42, 90, 0.2)'"
                                >
                                    Complete Learnings
                                </button>
                            ` : `
                                <button disabled style="padding: 14px 20px; background: #f3f4f6; color: #9ca3af; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: not-allowed; width: 100%; text-align: center;">
                                    Completed
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('trainingContainer').innerHTML = `<div class="training-grid">${html}</div>`;
            
            // Update counts
            const allCount = resources.length;
            const completedCount = resources.filter(r => (r.completions || []).length > 0).length;
            document.getElementById('allCount').textContent = allCount;
            document.getElementById('inprogressCount').textContent = completedCount;
            
            // Load recommendations and apply default filter
            loadRecommendationsForFilter().then(() => {
                // If no recommendations found, default to showing all training
                if (currentFilterMode === 'recommended' && recommendedResourceIds.length === 0) {
                    currentFilterMode = 'all';
                }
                filterTrainingResources(currentFilterMode);
            });
        }

        // Knowledge Profile Functions
        let currentFilterMode = 'all'; // Track current filter (recommended, inprogress, all)
        let recommendedResourceIds = []; // Store recommended Resource_IDslet currentUser = null; // Set via user gate or localStorage

        // User Gate Logic with localStorage persistence
        const STORAGE_KEY = 'h2s_current_user';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        const ADMIN_PASSWORD = 'admin2024';
        const ADMIN_AUTH_KEY = 'h2s_admin_authenticated';

        // Check if admin is authenticated
        function checkAdminAuth() {
            try {
                const authState = sessionStorage.getItem(ADMIN_AUTH_KEY);
                return authState === 'true';
            } catch (e) {
                return false;
            }
        }

        // Set admin authentication state
        function setAdminAuth(authenticated) {
            try {
                sessionStorage.setItem(ADMIN_AUTH_KEY, authenticated ? 'true' : 'false');
            } catch (e) {
                console.warn('Could not save admin auth state:', e);
            }
        }

        // Prompt for admin password
        function promptAdminPassword(callback) {
            const overlay = document.getElementById('modalOverlay');
            const header = document.getElementById('modalHeader');
            const body = document.getElementById('modalBody');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.querySelector('.modal-btn-cancel');
            const actions = document.getElementById('modalActions');
            const dialog = overlay.querySelector('.modal-dialog');
            
            header.textContent = 'Admin Access Required';
            body.innerHTML = `
                <div style="padding: 24px 0;">
                    <div style="font-size: 16px; line-height: 1.6; color: #374151; margin-bottom: 16px;">
                        Enter the admin password to access the Admin Dashboard:
                    </div>
                    <input 
                        type="password" 
                        id="adminPasswordInput" 
                        placeholder="Password" 
                        style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                        autocomplete="off"
                    />
                </div>
            `;
            
            // Set modal width
            if (dialog) {
                dialog.style.maxWidth = '400px';
            }
            
            actions.style.display = 'flex';
            confirmBtn.style.display = 'block';
            confirmBtn.textContent = 'Enter';
            confirmBtn.className = 'modal-btn modal-btn-confirm';
            
            // Lock body scroll
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            if (scrollbarWidth > 0) {
                document.body.style.paddingRight = `${scrollbarWidth}px`;
            }
            document.body.style.overflow = 'hidden';
            
            const passwordInput = document.getElementById('adminPasswordInput');
            if (passwordInput) {
                // Focus after a short delay to ensure modal is visible
                setTimeout(() => {
                    passwordInput.focus();
                }, 100);
                
                const handleConfirm = () => {
                    const password = passwordInput.value.trim();
                    if (password === ADMIN_PASSWORD) {
                        setAdminAuth(true);
                        closeModal();
                        callback(true);
                        showToast('Admin access granted', 'success');
                    } else {
                        showToast('Incorrect password', 'error');
                        passwordInput.value = '';
                        setTimeout(() => passwordInput.focus(), 100);
                    }
                };
                
                const handleCancel = () => {
                    closeModal();
                    callback(false);
                };
                
                // Clear previous event listeners by cloning
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                newConfirmBtn.onclick = handleConfirm;
                
                if (cancelBtn) {
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                    newCancelBtn.onclick = handleCancel;
                }
                
                // Allow Enter key to submit, Escape to cancel
                passwordInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleConfirm();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        handleCancel();
                    }
                };
            }
            
            overlay.classList.add('active');
        }

        // Check for cached user on page load
        function checkCachedUser() {
            try {
                const cached = localStorage.getItem(STORAGE_KEY);
                if (cached) {
                    const { user, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    
                    // If session is still valid (within 24 hours)
                    if (now - timestamp < SESSION_DURATION) {
                        currentUser = user;
                        document.getElementById('userGate').style.display = 'none';
                        initDashboard();
                        return true;
                    } else {
                        // Session expired, clear storage
                        localStorage.removeItem(STORAGE_KEY);
                    }
                }
            } catch (e) {
            }
            return false;
        }

        function enterDashboard() {
            const selected = document.getElementById('userSelect').value;
            if (!selected) return;
            
            currentUser = selected;
            
            // Cache user selection with timestamp
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    user: currentUser,
                    timestamp: Date.now()
                }));
            } catch (e) {
            }
            
            // Smooth transition
            const gate = document.getElementById('userGate');
                gate.classList.add('hidden');
                
                setTimeout(() => {
                    gate.style.display = 'none';
                }, 300);
            
            // Initialize dashboard with user context
            initDashboard();
        }

        // Add logout function for manual session clearing
        function logoutUser() {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        function safeParseJSON(text, fallback) {
            if (!text || typeof text !== 'string') return fallback;
            try { return JSON.parse(text); } catch { return fallback; }
        }

        async function loadKnowledgeProfile() {
            try {
                const response = await fetch(`${API_URL}?action=vaKnowledgeProfile&vaName=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (data.ok && data.vaKnowledgeProfile) {
                    const profile = data.vaKnowledgeProfile;
                    renderKnowledgeProfile(profile);
                    renderRecommendations(profile);
                    renderActionableTasks(profile);
                }
            } catch (error) {
                console.error('Error loading knowledge profile:', error);
            }
        }

        // ===== KNOWLEDGE PROFILE TRACKING =====
        // Relies on completion feedback: user submits notes, comprehension rating, time spent
        // AI analyzes and updates VA_Knowledge_Profile with extracted concepts, gaps, and recommendations
        function renderRecommendations(profile) {
            const container = document.getElementById('recommendedTrainingList');
            const raw = profile.Recommended_Trainings || '[]';
            const items = safeParseJSON(raw, []);
            if (!container) return;
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="color:#6b7280;">No recommendations yet. Complete a training to generate guidance.</div>';
                return;
            }
            container.innerHTML = items.slice(0,3).map(it => {
                const title = it.title || 'Recommended Training';
                const pillar = it.pillar || 'General';
                const reason = it.reason || 'High ROI next step.';
                const resId = it.resourceId || '';
                return `
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:8px;">
                        <div style="min-width:0;">
                            <div style="font-weight:800; color:#0a2a5a;">${title}</div>
                            <div style="font-size:12px; color:#6b7280;">${pillar} • ${reason}</div>
                            </div>
                        <button style="padding:8px 12px; background:#0a2a5a; color:#fff; border:none; border-radius:8px; font-weight:700; font-size:12px;" onclick="focusTraining('${resId}')">Start</button>
                    </div>
                `;
            }).join('');
        }

        function renderActionableTasks(profile) {
            const container = document.getElementById('knowledgeGapsList');
            if (!container) return;
            const concepts = safeParseJSON(profile.AI_Extracted_Concepts || '[]', []);
            const gaps = safeParseJSON(profile.Top_Skill_Gaps || '[]', []);
            const tasks = [];
            concepts.slice(0,5).forEach(c => {
                const skill = (c.skill || c.name || '').trim();
                if (!skill) return;
                        tasks.push({
                    title: `Apply ${skill}: create a 1-page summary and implement on 3 examples`,
                            pillar: c.pillar || 'Training',
                    reason: 'Reinforce learning by immediate application.'
                });
            });
            gaps.slice(0,3).forEach(g => {
                const skill = (g.skill || g.name || '').trim();
                if (!skill) return;
                        tasks.push({
                    title: `Close gap in ${skill}: draft SOP and run a 5-case test`,
                            pillar: g.pillar || 'Fulfillment',
                    reason: 'Addresses a current weakness with measurable output.'
                });
            });
            if (tasks.length === 0) {
                container.innerHTML = '<div style="color:#6b7280;">No actionable tasks yet. Complete a training first.</div>';
                return;
            }
            container.innerHTML = tasks.slice(0,5).map(t => `
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:8px;">
                    <div style="min-width:0;">
                        <div style="font-weight:700; color:#0a2a5a;">${t.title}</div>
                        <div style="font-size:12px; color:#6b7280;">${t.pillar} • ${t.reason}</div>
                                </div>
                    <button style="padding:8px 12px; background:#0a2a5a; color:#fff; border:none; border-radius:8px; font-weight:700; font-size:12px;" onclick="createTaskFromSuggestion('${t.title.replace(/'/g, "\\'")}', '${t.pillar}')">Create Task</button>
                </div>
            `).join('');
        }

        async function createTaskFromSuggestion(title, pillar) {
            try {
                const body = { title, description: title, pillar, assignedTo: currentUser };
                const resp = await fetch(`${API_URL}?action=createTask`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
                const data = await resp.json();
                if (data.ok) {
                    showToast('Task created from recommendation', 'success');
                } else {
                    showToast('Failed to create task', 'error');
                }
            } catch (e) {
                showToast('Error creating task', 'error');
            }
        }

        function focusTraining(resourceId) {
            // Scroll to training card and highlight (basic implementation)
            const el = document.querySelector(`[onclick*="openCompletionModal('${resourceId}'"]`);
            if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        function renderKnowledgeProfile(profile) {
            const skillCompetencies = profile.Skill_Competencies ? JSON.parse(profile.Skill_Competencies) : {};
            const topSkillGaps = profile.Top_Skill_Gaps ? JSON.parse(profile.Top_Skill_Gaps) : [];
            
            // Get top 3 skills
            const skills = Object.entries(skillCompetencies)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            const masteryScore = profile.Overall_Mastery_Score || 0;
            const totalTrainings = profile.Total_Trainings_Completed || 0;
            const learningHours = (profile.Total_Learning_Hours || 0).toFixed(1);
            
            const html = `
                <div class="knowledge-profile">
                    <div class="knowledge-header">
                        <div class="knowledge-title">
                            ROSEL's Learning Profile
                        </div>
                        <div style="text-align: center;">
                            <div class="mastery-score">${masteryScore}%</div>
                            <div class="mastery-label">Overall Mastery</div>
                        </div>
                    </div>

                    <div style="font-size: 13px; color: #5f6368; margin-top: -8px; margin-bottom: 12px;">
                        Feedback loop: Watch → Write learnings → AI analyzes → Profile updates.
                    </div>
                    
                    <div class="knowledge-stats">
                        <div class="knowledge-stat">
                            <span class="stat-value">${totalTrainings}</span>
                            <span class="stat-label">Trainings Completed</span>
                        </div>
                        <div class="knowledge-stat">
                            <span class="stat-value">${learningHours}</span>
                            <span class="stat-label">Learning Hours</span>
                        </div>
                        <div class="knowledge-stat">
                            <span class="stat-value">${skills.length}</span>
                            <span class="stat-label">Skills Mastered</span>
                        </div>
                    </div>
                    
                    ${skills.length > 0 ? `
                        <div class="skills-section">
                            <div class="skills-label">💪 Strong Skills</div>
                            <div class="skills-badges">
                                ${skills.map(([skill, score]) => `
                                    <div class="skill-badge strong">
                                        ${skill} <span class="skill-score">${score}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${topSkillGaps.length > 0 ? `
                        <div class="skills-section">
                            <div class="skills-label">📝 Needs Work</div>
                            <div class="skills-badges">
                                ${topSkillGaps.slice(0, 3).map(gap => `
                                    <div class="skill-badge gap">${gap}</div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('knowledgeProfile').innerHTML = html;
            document.getElementById('knowledgeProfile').style.display = 'block';
        }

        // Training Completion Modal Functions
        let currentCompletionResourceId = null;

        function openCompletionModal(resourceId, title) {
            if (!resourceId) return;
            
            currentCompletionResourceId = resourceId;
            
            // Set title if provided, otherwise fetch it
            if (title) {
                document.getElementById('completionModalTitle').textContent = title;
            } else {
                // Try to get title from training resources
                const trainingContainer = document.getElementById('trainingContainer');
                if (trainingContainer) {
                    const resourceEl = trainingContainer.querySelector(`[data-resource-id="${resourceId}"]`);
                    if (resourceEl) {
                        const titleEl = resourceEl.querySelector('.training-title');
                        if (titleEl) {
                            document.getElementById('completionModalTitle').textContent = titleEl.textContent || 'Training Completion Report';
                        }
                    }
                }
            }
            
            const modal = document.getElementById('completionModal');
            if (!modal) return;
            modal.style.display = 'flex';
            
            // Reset form fields
            const conceptField = document.getElementById('conceptLearned');
            const practicalField = document.getElementById('practicalApplication');
            const nextActionsField = document.getElementById('nextActions');
            const challengesField = document.getElementById('challengesQuestions');
            const timeSpentField = document.getElementById('timeSpent');
            
            if (conceptField) conceptField.value = '';
            if (practicalField) practicalField.value = '';
            if (nextActionsField) nextActionsField.value = '';
            if (challengesField) challengesField.value = '';
            if (timeSpentField) timeSpentField.value = '30';
            
            setStarRating(0);
            
            // Setup star rating - attach click handlers directly to each star
            setTimeout(() => {
                const stars = document.querySelectorAll('#starRating .star');
                if (stars.length === 0) return;
                
                stars.forEach((star) => {
                    // Remove any existing handlers
                    star.onclick = null;
                    star.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const rating = parseInt(this.dataset.rating);
                        if (rating >= 1 && rating <= 5) {
                            setStarRating(rating);
                        }
                    }, false);
                    star.style.cursor = 'pointer';
                    star.style.pointerEvents = 'auto';
                });
            }, 50);
        }

        function closeCompletionModal() {
            document.getElementById('completionModal').style.display = 'none';
            // Reset all form fields
            document.getElementById('conceptLearned').value = '';
            document.getElementById('practicalApplication').value = '';
            document.getElementById('nextActions').value = '';
            document.getElementById('challengesQuestions').value = '';
            document.getElementById('timeSpent').value = '30';
            document.querySelectorAll('#starRating .star').forEach(star => {
                star.classList.remove('active');
                star.style.color = '#d1d5db';
                star.style.opacity = '0.3';
            });
            currentCompletionResourceId = null;
        }

        function setStarRating(rating) {
            const stars = document.querySelectorAll('#starRating .star');
            if (stars.length === 0) return;
            
            // Normalize rating
            if (!rating || rating < 1 || rating > 5) {
                rating = 0;
            }
            
            stars.forEach((star) => {
                const starRating = parseInt(star.dataset.rating);
                if (rating > 0 && starRating <= rating) {
                    star.classList.add('active');
                    star.style.color = '#fbbf24';
                    star.style.opacity = '1';
                } else {
                    star.classList.remove('active');
                    star.style.color = '#d1d5db';
                    star.style.opacity = '0.3';
                }
            });
        }

        async function submitTrainingCompletion() {
            const conceptLearned = document.getElementById('conceptLearned').value.trim();
            const practicalApplication = document.getElementById('practicalApplication').value.trim();
            const nextActions = document.getElementById('nextActions').value.trim();
            const challengesQuestions = document.getElementById('challengesQuestions').value.trim();
            const timeSpent = parseInt(document.getElementById('timeSpent').value);
            const rating = document.querySelectorAll('#starRating .star.active').length;
            
            if (!conceptLearned || !practicalApplication || !nextActions) {
                showToast('Please answer questions 1-3 (Question 4 is optional)', 'error');
                return;
            }
            
            if (rating === 0) {
                showToast('Please rate your comprehension', 'error');
                return;
            }
            
            // Combine all responses into structured format
            const structuredNotes = `CONCEPT LEARNED:\n${conceptLearned}\n\nPRACTICAL APPLICATION:\n${practicalApplication}\n\nNEXT ACTIONS:\n${nextActions}${challengesQuestions ? `\n\nCHALLENGES/QUESTIONS:\n${challengesQuestions}` : ''}`;
            
            const completionData = {
                resourceId: currentCompletionResourceId,
                completedBy: currentUser,
                notesLearned: structuredNotes,
                comprehensionRating: rating,
                timeSpentMinutes: timeSpent
            };
            
            try {
                closeCompletionModal();
                showToast('🤖 AI is analyzing your learnings...', 'info');
                
                const response = await fetch(`${API_URL}?action=completeTraining`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(completionData)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    // Extract and display AI insights
                    const insights = result.result || result.completion || {};
                    let extractedConcepts = [];
                    let confidenceScore = 0;
                    let knowledgeGaps = [];
                    
                    try {
                        if (insights.AI_Extracted_Concepts) {
                            if (typeof insights.AI_Extracted_Concepts === 'string') {
                                extractedConcepts = JSON.parse(insights.AI_Extracted_Concepts);
                            } else {
                                extractedConcepts = insights.AI_Extracted_Concepts;
                            }
                        }
                        if (insights.AI_Knowledge_Gaps) {
                            if (typeof insights.AI_Knowledge_Gaps === 'string') {
                                knowledgeGaps = JSON.parse(insights.AI_Knowledge_Gaps);
                            } else {
                                knowledgeGaps = insights.AI_Knowledge_Gaps;
                            }
                        }
                        confidenceScore = insights.AI_Confidence_Score || 0;
                    } catch (e) {
                        // Parse error - continue without AI insights
                    }
                    
                    // Show detailed insight modal if we have data
                    if (extractedConcepts.length > 0 || knowledgeGaps.length > 0 || confidenceScore > 0) {
                        showAIInsightModal(extractedConcepts, confidenceScore, knowledgeGaps);
                    }
                    
                    // Show toast with extracted concepts
                    if (extractedConcepts.length > 0) {
                        const conceptList = extractedConcepts.slice(0, 3).map(c => `✓ ${c}`).join(' ');
                        showToast(`✅ Detected: ${conceptList}${extractedConcepts.length > 3 ? ` +${extractedConcepts.length - 3} more` : ''}`, 'success');
                    } else {
                        showToast('✅ Training completed! Your knowledge profile has been updated.', 'success');
                    }
                    
                    // Reload training resources and knowledge profile
                    setTimeout(() => {
                        loadTrainingResources(true);
                        loadAndDisplayKnowledgeProfile();
                    }, 1000);
                } else {
                    showToast('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error submitting completion: ' + error.message, 'error');
            }
        }

        // Show AI Insight Modal
        function showAIInsightModal(concepts, confidence, gaps) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;';
            
            const conceptHTML = concepts.length > 0 
                ? concepts.map(c => `<div style="padding: 8px 12px; background: #dcfce7; color: #166534; border-radius: 8px; font-weight: 600; font-size: 13px;">✓ ${c}</div>`).join('')
                : '<div style="color: #6b7280; font-size: 13px;">AI is still analyzing...</div>';
            
            const gapHTML = gaps && gaps.length > 0
                ? `<div style="margin-top: 16px; padding: 12px; background: #fff7ed; border-left: 3px solid #f59e0b; border-radius: 8px;">
                    <div style="font-weight: 700; color: #92400e; font-size: 13px; margin-bottom: 8px;">📋 Identified Learning Gaps:</div>
                    ${gaps.map(g => `<div style="color: #92400e; font-size: 12px; margin: 4px 0;">• ${g}</div>`).join('')}
                  </div>`
                : '';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 520px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;">
                    <div style="padding: 20px 24px; background: linear-gradient(135deg, #00ff88 0%, #00cc6f 100%); border-radius: 16px 16px 0 0;">
                        <h3 style="color: #0a2a5a; font-size: 18px; font-weight: 900; margin: 0;">🤖 AI Analysis Complete</h3>
                        <p style="color: rgba(10,42,90,0.8); font-size: 13px; margin: 6px 0 0;">Skills added to your knowledge profile</p>
                    </div>
                    <div style="padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: #0a2a5a; font-size: 14px;">Detected Skills:</div>
                            ${confidence > 0 ? `<div style="background: linear-gradient(135deg, #0a2a5a, #1a4a8a); color: white; padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 13px;">Confidence: ${confidence}%</div>` : ''}
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${conceptHTML}
                        </div>
                        ${gapHTML}
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: #0a2a5a; color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#1a4a8a'" onmouseout="this.style.background='#0a2a5a'">Got it!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                if (modal.parentElement) modal.remove();
            }, 8000);
        }
        
        // Show AI Insight Modal
        function showAIInsightModal(concepts, confidence, gaps) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;';
            
            const conceptHTML = concepts.length > 0 
                ? concepts.map(c => `<div style="padding: 8px 12px; background: #dcfce7; color: #166534; border-radius: 8px; font-weight: 600; font-size: 13px;">✓ ${c}</div>`).join('')
                : '<div style="color: #6b7280; font-size: 13px;">AI is still analyzing...</div>';
            
            const gapHTML = gaps && gaps.length > 0
                ? `<div style="margin-top: 16px; padding: 12px; background: #fff7ed; border-left: 3px solid #f59e0b; border-radius: 8px;">
                    <div style="font-weight: 700; color: #92400e; font-size: 13px; margin-bottom: 8px;">📋 Identified Learning Gaps:</div>
                    ${gaps.map(g => `<div style="color: #92400e; font-size: 12px; margin: 4px 0;">• ${g}</div>`).join('')}
                  </div>`
                : '';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 520px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;">
                    <div style="padding: 20px 24px; background: linear-gradient(135deg, #00ff88 0%, #00cc6f 100%); border-radius: 16px 16px 0 0;">
                        <h3 style="color: #0a2a5a; font-size: 18px; font-weight: 900; margin: 0;">🤖 AI Analysis Complete</h3>
                        <p style="color: rgba(10,42,90,0.8); font-size: 13px; margin: 6px 0 0;">Skills added to your knowledge profile</p>
                    </div>
                    <div style="padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: #0a2a5a; font-size: 14px;">Detected Skills:</div>
                            ${confidence > 0 ? `<div style="background: linear-gradient(135deg, #0a2a5a, #1a4a8a); color: white; padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 13px;">Confidence: ${confidence}%</div>` : ''}
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${conceptHTML}
                        </div>
                        ${gapHTML}
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: #0a2a5a; color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#1a4a8a'" onmouseout="this.style.background='#0a2a5a'">Got it!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                if (modal.parentElement) modal.remove();
            }, 8000);
        }
        
        // Helper: Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'Foundation': '',
                'Core Skills': '',
                'Advanced': ''
            };
            return icons[category] || '';
        }

        // Filter training resources by mode (recommended/inprogress/all)
        function filterTrainingResources(mode) {
            currentFilterMode = mode;
    
    // Update tab UI
    document.querySelectorAll('.training-filter-tab').forEach(tab => {
        const isActive = tab.dataset.filter === mode;
        tab.classList.toggle('active', isActive);
        if (isActive) {
            tab.style.color = '#0a2a5a';
            tab.style.borderBottomColor = '#0a2a5a';
        } else {
            tab.style.color = '#6b7280';
            tab.style.borderBottomColor = 'transparent';
        }
    });
    
    // Filter training grid items
    const trainingItems = document.querySelectorAll('.training-card');
    trainingItems.forEach(item => {
        const resourceId = item.dataset.resourceId;
        let shouldShow = false;
        
        if (mode === 'all') {
            shouldShow = true;
        } else if (mode === 'recommended') {
            shouldShow = recommendedResourceIds.includes(resourceId);
        } else if (mode === 'inprogress') {
            // In progress = has completions but not fully mastered
            const isCompleted = item.querySelector('.training-completed-badge') !== null;
            shouldShow = isCompleted;
        }
        
        item.classList.toggle('hidden', !shouldShow);
    });

    // Show empty state if no items visible
    const visibleCount = document.querySelectorAll('.training-card:not(.hidden)').length;
    const container = document.querySelector('.training-grid');
    
    // Remove existing empty message if any
    const existingMsg = document.getElementById('trainingEmptyMsg');
    if (existingMsg) existingMsg.remove();
    
    if (visibleCount === 0 && container) {
        const emptyMsg = document.createElement('div');
        emptyMsg.id = 'trainingEmptyMsg';
        emptyMsg.className = 'empty-state';
        emptyMsg.style.gridColumn = '1 / -1';
        emptyMsg.style.padding = '40px';
        
        if (mode === 'recommended') {
            emptyMsg.innerHTML = '<div class="empty-icon">✨</div><div class="empty-text">No specific recommendations yet.<br>Check out "All Training" to get started!</div>';
        } else if (mode === 'inprogress') {
            emptyMsg.innerHTML = '<div class="empty-icon"></div><div class="empty-text">No training history found.<br>Start a course from the "All" tab.</div>';
        } else {
            emptyMsg.innerHTML = '<div class="empty-icon">📚</div><div class="empty-text">No training resources found.</div>';
        }
        container.appendChild(emptyMsg);
    }
}

// Fetch recommendations from Analytics API and update counts
async function loadRecommendationsForFilter() {
    if (!currentUser) return;
    
    try {
        // Use vaKnowledgeProfile endpoint instead of missing recommendations endpoint
        const response = await fetch(`${API_URL}?action=vaKnowledgeProfile&vaName=${encodeURIComponent(currentUser)}`);
        const data = await response.json();
        
        if (data.ok && data.vaKnowledgeProfile) {
            const profile = data.vaKnowledgeProfile;
            const raw = profile.Recommended_Trainings || '[]';
            const recommendations = safeParseJSON(raw, []);
            
            // Extract Resource_IDs from recommendations
            recommendedResourceIds = recommendations
                .filter(r => r.resourceId)
                .map(r => r.resourceId);
            
            // Update recommended count
            document.getElementById('recommendedCount').textContent = recommendedResourceIds.length;
        }
    } catch (error) {
    }
}

        // Load Training Resources
        async function loadTrainingResources(silent = false) {
            const container = document.getElementById('trainingContainer');
            
            // Only show spinner on initial load
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=training`);
                const data = await response.json();
                
                if (data.ok) {
                    const resources = data.training || data.resources || [];
                    allTrainingResources = resources; // Store globally for filtering
                    
                    if (resources.length > 0) {
                        renderTrainingResources(resources);
                        loadAndDisplayKnowledgeProfile(); // Load VA's knowledge profile
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon"></div>
                                <div class="empty-text">No training resources yet. Click "Manage Training" to add your first resource!</div>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">⚠️</div>
                            <div class="empty-text" style="color: var(--danger);">Error: ${data.error || 'Failed to load training resources'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⚠️</div>
                        <div class="empty-text" style="color: var(--danger);">Error loading training resources. Check console for details.</div>
                    </div>
                `;
            }
        }

        // Toggle Admin Panel
        function toggleAdminPanel() {
            const panel = document.getElementById('trainingAdminPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                loadAdminTrainingList();
            }
        }

        // Load Admin Training List
        async function loadAdminTrainingList() {
            const container = document.getElementById('adminTrainingList');
            container.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch(`${API_URL}?action=training`);
                const data = await response.json();
                
                if (data.ok) {
                    const resources = data.training || [];
                    if (resources.length === 0) {
                        container.innerHTML = '<p style="color: #666;">No training resources yet.</p>';
                        return;
                    }
                    
                    const html = resources.map(resource => `
                        <div style="padding: 20px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 16px; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                        <h4 style="color: var(--cobalt); font-size: 16px; font-weight: 700; margin: 0;">${resource.Title}</h4>
                                        <span style="background: #f3f4f6; color: #4b5563; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${resource.Type}</span>
                                    </div>
                                    
                                    <div style="display: flex; gap: 12px; font-size: 13px; color: #6b7280; margin-bottom: 10px;">
                                        <span>${getCategoryIcon(resource.Category)} ${resource.Category}</span>
                                        <span>•</span>
                                        <span>${resource.Difficulty_Level || 'BEGINNER'}</span>
                                        <span>•</span>
                                        <span>${resource.Estimated_Minutes || '?'} min</span>
                                    </div>
                                    
                                    <p style="font-size: 14px; color: #4b5563; margin-bottom: 12px; line-height: 1.5;">${resource.Description || 'No description'}</p>
                                    
                                    <a href="${resource.URL}" target="_blank" style="font-size: 13px; color: var(--azure); font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                                        View Resource <span>→</span>
                                    </a>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 8px; min-width: 100px;">
                                    <button onclick="editTraining('${resource.Resource_ID}')" class="btn" style="padding: 8px 16px; font-size: 13px; background: white; color: var(--azure); border: 1px solid var(--azure); width: 100%; justify-content: center; border-radius: 8px; font-weight: 600;">
                                        Edit
                                    </button>
                                    <button onclick="deleteTraining('${resource.Resource_ID}', '${resource.Title}')" class="btn" style="padding: 8px 16px; font-size: 13px; background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; width: 100%; justify-content: center; border-radius: 8px; font-weight: 600;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);">Error loading training list</p>';
                console.error(error);
            }
        }

        // Get Category Icon
        function getCategoryIcon(category) {
            const icons = {
                'Onboarding': '',
                'Safety': '',
                'Technical': '',
                'Product': '',
                'Customer Service': '',
                'Tools': '',
                'Troubleshooting': '',
                'Business': '',
                'Home2Smart': ''
            };
            return icons[category] || '';
        }

        // Submit New Training
        async function submitNewTraining(event) {
            event.preventDefault();
            
            // Ensure API_URL is available
            const endpoint = (typeof API_URL !== 'undefined') ? API_URL : `${DEFAULT_API_HOST}/api/v1`;

            const formData = {
                title: document.getElementById('newTrainingTitle').value,
                type: 'Video', // Always video for now
                url: document.getElementById('newTrainingURL').value,
                description: document.getElementById('newTrainingDescription').value || null,
                category: document.getElementById('newTrainingCategory').value,
                difficultyLevel: 'BEGINNER', // Default
                estimatedMinutes: parseInt(document.getElementById('newTrainingDuration').value) || null,
                skillsTaught: null, // Will be extracted by AI
                order: 0,
                createdBy: 'Tabari'
            };
            
            try {
                showToast('\ud83d\udce4 Uploading training video...', 'info');
                
                const response = await fetch(`${endpoint}?action=createTraining`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showToast('\u2705 Training uploaded successfully!', 'success');
                    document.getElementById('newTrainingForm').reset();
                    loadAdminTrainingList();
                    loadTrainingResources(true); // Refresh main view
                } else {
                    showToast(`\u274c Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast('\u274c Failed to upload training', 'error');
                console.error(error);
            }
        }

        // Delete Training
        async function deleteTraining(resourceId, title) {
            if (!confirm(`Are you sure you want to delete "${title}"? This will also delete all completion records.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}?action=deleteTraining`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resourceId })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showToast('✅ Training resource deleted', 'success');
                    loadAdminTrainingList();
                    loadTrainingResources(true);
                } else {
                    showToast(`❌ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast('❌ Failed to delete training resource', 'error');
                console.error(error);
            }
        }

        // Edit Training (TODO: Add edit modal)
        function editTraining(resourceId) {
            showToast('Edit functionality coming soon! For now, delete and recreate.', 'info');
        }



        // Filter Training by Tier
        let allTrainingResources = [];

        function filterTrainingByTier(tier) {
            // Update active button
            document.querySelectorAll('.tier-btn').forEach(btn => {
                if (btn.dataset.tier === tier) {
                    btn.style.background = 'linear-gradient(135deg, var(--azure) 0%, #667eea 100%)';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'var(--azure)';
                    btn.style.boxShadow = '0 4px 15px rgba(20, 147, 255, 0.3)';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = 'var(--cobalt)';
                    btn.style.borderColor = '#e0e0e0';
                    btn.style.boxShadow = 'none';
                }
            });

            // Filter resources
            if (tier === 'all') {
                renderTrainingResources(allTrainingResources);
            } else {
                const filtered = allTrainingResources.filter(r => r.Category === tier);
                renderTrainingResources(filtered);
            }
        }

        // Load and Display Knowledge Profile
        async function loadAndDisplayKnowledgeProfile() {
            try {
                const response = await fetch(`${API_URL}?action=trainingCompletions&vaName=ROSEL`);
                const data = await response.json();
                
                if (data.ok && data.trainingCompletions) {
                    const completions = data.trainingCompletions;
                    
                    if (completions.length === 0) {
                        document.getElementById('knowledgeProfileCard').style.display = 'none';
                        return;
                    }

                    // Calculate stats
                    const totalTrainings = completions.length;
                    const totalMinutes = completions.reduce((sum, c) => sum + (c.Time_Spent_Minutes || 0), 0);
                    const learningHours = (totalMinutes / 60).toFixed(1);

                    // Update minimal stats
                    document.getElementById('totalTrainings').textContent = totalTrainings;
                    document.getElementById('learningHours').textContent = `${learningHours}h`;

                    // Show the profile card
                    document.getElementById('knowledgeProfileCard').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading knowledge profile:', error);
            }
        }

        // Load Tasks
        async function loadTasks(silent = false) {
            const container = document.getElementById('tasksContainer');
            
            // Only show spinner on initial load
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=tasks`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.ok) {
                    const tasks = data.tasks || [];
                    if (tasks.length > 0) {
                        renderTasks(tasks);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">No tasks yet. Add tasks to the Tasks sheet.</div>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text" style="color: var(--danger);">Error: ${data.error || 'Failed to load tasks'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error: ${error.message}</div>
                    </div>
                `;
            }
        }

        // Store tasks globally for modal access
        let currentTasks = [];

        function renderTasks(tasks) {
            currentTasks = tasks;
            
            // Split tasks into To Do and Done
            const now = new Date();
            const todoTasks = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() !== 'COMPLETED');
            let doneTasks = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() === 'COMPLETED');
            // Client-side retention pruning based on Retention_Days
            doneTasks = doneTasks.filter(t => {
                const days = parseInt(t.Retention_Days || t.retentionDays || '7', 10);
                const completedAt = t.Completed_At || t.completedAt || t.Completed_Date || t.completedDate;
                if (!completedAt) return true; // keep if no timestamp
                const completedDate = new Date(completedAt);
                const diffDays = Math.floor((now - completedDate) / (1000 * 60 * 60 * 24));
                return diffDays <= days;
            });
            
            const html = `
                <div class="tasks-columns">
                    <div class="tasks-column">
                        <div class="tasks-column-header">
                            <span>📋 To Do</span>
                            <span class="tasks-column-count">${todoTasks.length}</span>
                        </div>
                        <div class="tasks-grid">
                            ${todoTasks.length === 0 ? `
                                <div class="empty-state" style="padding: 40px 20px;">
                                    <div class="empty-icon">🎉</div>
                                    <div class="empty-text">All caught up!</div>
                                </div>
                            ` : todoTasks.map(task => renderTaskCard(task)).join('')}
                        </div>
                    </div>
                    <div class="tasks-column">
                        <div class="tasks-column-header">
                            <span>✅ Done</span>
                            <span class="tasks-column-count">${doneTasks.length}</span>
                        </div>
                        <div class="tasks-grid">
                            ${doneTasks.length === 0 ? `
                                <div class="empty-state" style="padding: 40px 20px;">
                                    <div class="empty-icon">📭</div>
                                    <div class="empty-text">No completed tasks yet</div>
                                </div>
                            ` : doneTasks.map(task => renderTaskCard(task)).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('tasksContainer').innerHTML = html;
        }

        function renderTaskCard(task) {
            // Determine actual type from data
            let type = 'LINK';
            if (task.Content && task.Content.trim()) {
                type = 'TEXT';
            } else if (task.URL && (task.URL.includes('docs.google.com') || task.URL.includes('drive.google.com'))) {
                type = 'DOCUMENT';
            } else if (task.URL) {
                type = 'LINK';
            }
            
            const status = (task.Status || 'PENDING').toUpperCase();
            
            // Handle Priority as either string or number
            let priority = task.Priority || 2;
            if (typeof priority === 'number') {
                priority = priority === 1 ? 'HIGH' : priority === 2 ? 'MEDIUM' : 'LOW';
            }
            priority = String(priority).toUpperCase();
            
            const priorityClass = `priority-${priority.toLowerCase()}`;
            const statusClass = `status-${status.toLowerCase().replace(' ', '-')}`;
            const priorityBadgeClass = `priority-${priority.toLowerCase()}-badge`;
            
            // Build footer metadata
            const footerItems = [];
            if (task.Assigned_To) footerItems.push(`👤 ${task.Assigned_To}`);
            if (task.Due_Date) footerItems.push(`📅 ${formatDate(task.Due_Date)}`);
            if (task.Completed_At) footerItems.push(`✅ ${formatDate(task.Completed_At)}`);
            
            return `
                <div class="task-card ${priorityClass} ${statusClass}" onclick="openTaskModal('${task.Task_ID}')">
                    <div class="task-header">
                        <div style="flex: 1;">
                            <div class="task-title">${task.Title || task.title || 'Untitled Task'}</div>
                            ${task.Category ? `<span class="task-category" style="margin-top: 6px;">${task.Category}</span>` : ''}
                        </div>
                        <span class="task-priority-badge ${priorityBadgeClass}">${priority}</span>
                    </div>
                    ${task.Description ? `<div class="task-description" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${task.Description.substring(0, 100)}${task.Description.length > 100 ? '...' : ''}</div>` : ''}
                    ${footerItems.length > 0 ? `
                    <div class="task-footer" style="margin-top: 12px; padding-top: 12px;">
                        <div class="task-meta">
                            ${footerItems.join(' • ')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function openTaskModal(taskId) {
            const task = currentTasks.find(t => t.Task_ID === taskId);
            if (!task) return;
            
            // Determine actual type from data
            let type = 'LINK';
            if (task.Content && task.Content.trim()) {
                type = 'TEXT';
            } else if (task.URL && (task.URL.includes('docs.google.com') || task.URL.includes('drive.google.com'))) {
                type = 'DOCUMENT';
            } else if (task.URL) {
                type = 'LINK';
            }
            
            const status = (task.Status || 'PENDING').toUpperCase();
            
            // Handle Priority as either string or number
            let priority = task.Priority || 2;
            if (typeof priority === 'number') {
                priority = priority === 1 ? 'HIGH' : priority === 2 ? 'MEDIUM' : 'LOW';
            }
            priority = String(priority).toUpperCase();
            
            const priorityBadgeClass = `priority-${priority.toLowerCase()}-badge`;
            const isCompleted = status === 'COMPLETED';
            
            // Set title and badges
            document.getElementById('modalTaskTitle').textContent = task.Title || task.title || 'Untitled Task';
            document.getElementById('modalTaskBadges').innerHTML = `
                <span class="task-priority-badge ${priorityBadgeClass}">${priority}</span>
                ${task.Category ? `<span class="task-category">${task.Category}</span>` : ''}
            `;
            
            // Set description
            document.getElementById('modalTaskDescription').innerHTML = task.Description ? task.Description.replace(/\n/g, '<br>') : '';
            
            // Set content based on type
            let content = '';
            if (type === 'DOCUMENT' && task.URL) {
                let embedUrl = task.URL;
                if (task.URL.includes('/view')) {
                    embedUrl = task.URL.replace('/view', '/preview');
                } else if (task.URL.includes('/edit')) {
                    embedUrl = task.URL.replace('/edit', '/preview');
                }
                content = `
                    <iframe 
                        src="${embedUrl}" 
                        frameborder="0"
                        class="task-embed">
                    </iframe>
                    <a href="${task.URL}" target="_blank" class="task-link-btn" style="margin-top: 12px;">Open in New Tab</a>
                `;
            } else if (type === 'LINK' && task.URL) {
                content = `<a href="${task.URL}" target="_blank" class="task-link-btn">Open ${task.Category || 'Link'}</a>`;
            } else if (type === 'TEXT' && task.Content) {
                content = `<div class="task-content">${task.Content}</div>`;
            }
            
            // Add metadata
            const footerItems = [];
            if (task.Assigned_To) footerItems.push(`Assigned to: ${task.Assigned_To}`);
            if (task.Due_Date) footerItems.push(`Due: ${formatDate(task.Due_Date)}`);
            if (task.Completed_At) footerItems.push(`Completed: ${formatDate(task.Completed_At)}`);
            
            if (footerItems.length > 0) {
                content += `<div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border); color: #5f6368; font-size: 14px;">${footerItems.join(' • ')}</div>`;
            }
            
            document.getElementById('modalTaskContent').innerHTML = content;
            
            // Set action button
            const actionBtn = document.getElementById('modalTaskAction');
            if (isCompleted) {
                actionBtn.textContent = 'Mark as To Do';
                actionBtn.className = 'task-action-btn task-uncomplete-btn';
                actionBtn.onclick = () => toggleTaskStatus(taskId, false);
            } else {
                actionBtn.textContent = 'Mark as Done';
                actionBtn.className = 'task-action-btn task-complete-btn';
                actionBtn.onclick = () => toggleTaskStatus(taskId, true);
            }

            // Add Refine Button
            const actionsContainer = document.querySelector('#taskModal .task-modal-actions');
            let refineBtn = document.getElementById('modalRefineBtn');
            if (!refineBtn) {
                refineBtn = document.createElement('button');
                refineBtn.id = 'modalRefineBtn';
                refineBtn.className = 'btn-magic';
                refineBtn.style.marginRight = 'auto'; // Push to left
                refineBtn.innerHTML = '🧠 Clarify with AI';
                actionsContainer.insertBefore(refineBtn, actionsContainer.firstChild);
            }
            refineBtn.style.display = 'inline-flex'; // Ensure visible
            refineBtn.onclick = () => openRefineInput(taskId);
            
            // CLEANUP: Remove any stale refine containers from previous opens
            const staleContainer = document.getElementById('refineContainer');
            if (staleContainer) staleContainer.remove();

            // Show modal
            document.getElementById('taskModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function openRefineInput(taskId) {
            const descEl = document.getElementById('modalTaskDescription');
            
            // Double check cleanup
            const existing = document.getElementById('refineContainer');
            if (existing) existing.remove();

            // Create input area
            const container = document.createElement('div');
            container.id = 'refineContainer';
            container.style.marginTop = '20px';
            container.style.padding = '20px';
            container.style.background = '#ffffff';
            container.style.borderRadius = '12px';
            container.style.border = '2px solid #e0e0e0';
            container.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label class="form-label" style="color: #202124; margin: 0;">What needs clarification?</label>
                    <button onclick="closeRefineInput()" style="background:none; border:none; cursor:pointer; font-size: 18px; color: #5f6368;">&times;</button>
                </div>
                <textarea id="refineFeedback" class="form-textarea" 
                    style="min-height: 120px; margin-bottom: 16px; font-family: inherit; line-height: 1.5; resize: vertical; overflow-y: auto;" 
                    placeholder="e.g. 'She thinks this is about X, but it's about Y. Mention that she needs to check the Z folder.'"></textarea>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="closeRefineInput()" style="padding: 10px 20px;">Cancel</button>
                    <button class="btn-magic" onclick="submitRefineTask('${taskId}')" style="margin: 0; padding: 10px 20px;">✨ Update Task</button>
                </div>
            `;
            
            // Insert after description
            descEl.parentNode.insertBefore(container, descEl.nextSibling);
            document.getElementById('refineFeedback').focus();
            
            // Hide the main refine button temporarily
            document.getElementById('modalRefineBtn').style.display = 'none';
        }

        function closeRefineInput() {
            const container = document.getElementById('refineContainer');
            if (container) container.remove();
            const btn = document.getElementById('modalRefineBtn');
            if (btn) btn.style.display = 'inline-flex';
        }

        async function submitRefineTask(taskId) {
            const feedback = document.getElementById('refineFeedback').value;
            if (!feedback) return;
            
            const btn = document.querySelector('#refineContainer .btn-magic');
            const originalText = btn.innerHTML;
            btn.innerHTML = '✨ Refining...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}?action=refineExistingTask&taskId=${encodeURIComponent(taskId)}&feedback=${encodeURIComponent(feedback)}`);
                const result = await response.json();
                
                if (result.ok) {
                    // Update UI immediately
                    document.getElementById('modalTaskDescription').innerHTML = result.newDescription.replace(/\n/g, '<br>');
                    closeRefineInput(); // Use the cleanup function
                    showToast('Task clarified and updated!', 'success');
                    
                    // Reload tasks in background
                    loadTasks(true);
                } else {
                    showToast('Error: ' + result.error, 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function closeTaskModal(event) {
            if (event && event.target !== event.currentTarget) return;
            
            // CLEANUP: Ensure refine container is gone when closing modal
            closeRefineInput();
            
            document.getElementById('taskModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function toggleTaskStatus(taskId, markComplete) {
            const newStatus = markComplete ? 'COMPLETED' : 'PENDING';
            
            try {
                const response = await fetch(
                    `${API_URL}?action=updateTaskStatus&taskId=${encodeURIComponent(taskId)}&status=${newStatus}`,
                    { method: 'GET' }
                );
                
                const result = await response.json();
                
                if (result.ok) {
                    // If the task was a recurring one and just completed, create the next instance client-side
                    try {
                        const task = currentTasks.find(t => t.Task_ID === taskId);
                        if (markComplete && task && (task.Recurrence || task.recurrence)) {
                            const recur = (task.Recurrence || task.recurrence || 'none').toLowerCase();
                            if (recur === 'daily' || recur === 'weekly') {
                                const due = new Date(task.Due_Date || task.dueDate || Date.now());
                                const nextDue = new Date(due);
                                nextDue.setDate(due.getDate() + (recur === 'daily' ? 1 : 7));
                                const payload = {
                                    title: task.Title,
                                    description: task.Description,
                                    priority: task.Priority,
                                    dueDate: nextDue.toISOString().slice(0,10),
                                    recurrence: recur,
                                    retentionDays: task.Retention_Days || task.retentionDays || 7
                                };
                                // Fire-and-forget create next task; do not block UI
                                fetch(`${API_URL}?action=addTask`, { method: 'POST', body: JSON.stringify(payload) })
                                    .then(() => loadTasks(true))
                                    .catch(() => {});
                            }
                        }
                    } catch (_) { /* noop */ }

                    closeTaskModal();
                    loadTasks(true); // Silent reload - no spinner
                    showToast(`Task marked as ${markComplete ? 'completed' : 'pending'}`, 'success');
                } else {
                    showToast('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error updating task: ' + error, 'error');
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTaskModal();
            }
        });

        // Force background color after GoHighLevel scripts load
        function enforceBackground() {
            document.documentElement.style.setProperty('background', '#0a2a5a', 'important');
            document.documentElement.style.setProperty('background-color', '#0a2a5a', 'important');
            document.body.style.setProperty('background', '#0a2a5a', 'important');
            document.body.style.setProperty('background-color', '#0a2a5a', 'important');
        }
        
        // Run immediately and on DOMContentLoaded
        enforceBackground();
        document.addEventListener('DOMContentLoaded', enforceBackground);
        
        // Watch for DOM mutations that might override styles
        const observer = new MutationObserver(enforceBackground);
        observer.observe(document.documentElement, { 
            attributes: true, 
            attributeFilter: ['style', 'class'],
            subtree: false 
        });
        observer.observe(document.body, { 
            attributes: true, 
            attributeFilter: ['style', 'class'],
            subtree: false 
        });
        
        // Also run after a delay to catch async script injections
        setTimeout(enforceBackground, 100);
        setTimeout(enforceBackground, 500);
        setTimeout(enforceBackground, 1000);

        /* ===== GHL PARENT CONTAINER CONSTRAINT NEUTRALIZER ===== */
        function neutralizeGHLConstraints() {
            const app = document.getElementById('h2s-app');
            if (!app) return;

            // Ensure app itself expands
            app.style.setProperty('width', '100%', 'important');
            app.style.setProperty('max-width', 'none', 'important');
            app.style.setProperty('margin-left', '0', 'important');
            app.style.setProperty('margin-right', '0', 'important');
            app.style.setProperty('display', 'block', 'important');

            // Walk up the DOM tree and neutralize parent constraints
            let parent = app.parentElement;
            let depth = 0;
            const maxDepth = 10; // Safety limit

            while (parent && parent !== document.body && depth < maxDepth) {
                // Check for width constraints
                const computedStyle = window.getComputedStyle(parent);
                const maxWidth = computedStyle.maxWidth;
                const width = computedStyle.width;

                // If parent has a max-width that's not 'none', neutralize it
                if (maxWidth && maxWidth !== 'none' && maxWidth !== '100%') {
                    parent.style.setProperty('max-width', 'none', 'important');
                }

                // If parent has a fixed width that's constraining, override it
                if (width && width !== 'auto' && width !== '100%' && !width.includes('calc')) {
                    // Only override if it's a pixel value that seems constraining
                    if (width.includes('px')) {
                        const pxValue = parseInt(width);
                        if (pxValue < window.innerWidth * 0.9) {
                            parent.style.setProperty('width', '100%', 'important');
                        }
                    }
                }

                // Override any centering margins that create narrow columns
                const marginLeft = computedStyle.marginLeft;
                const marginRight = computedStyle.marginRight;
                if (marginLeft === 'auto' && marginRight === 'auto') {
                    parent.style.setProperty('margin-left', '0', 'important');
                    parent.style.setProperty('margin-right', '0', 'important');
                }

                parent = parent.parentElement;
                depth++;
            }

            // Ensure pipeline containers expand (only set width, never display)
            const pipelinePane = document.getElementById('pipeline-pane');
            if (pipelinePane) {
                // Only set width properties, never touch display
                pipelinePane.style.setProperty('width', '100%', 'important');
                pipelinePane.style.setProperty('max-width', '100%', 'important');
                // Explicitly do NOT set display - let CSS .pane.active handle it
            }

            const pipeline = document.querySelector('#h2s-app .pipeline');
            if (pipeline) {
                pipeline.style.setProperty('width', '100%', 'important');
                pipeline.style.setProperty('max-width', '100%', 'important');
            }

            const appMain = document.querySelector('#h2s-app .app-main');
            if (appMain) {
                appMain.style.setProperty('width', 'calc(100% - 240px)', 'important');
                appMain.style.setProperty('max-width', 'none', 'important');
            }

            const appContent = document.querySelector('#h2s-app .app-content');
            if (appContent) {
                appContent.style.setProperty('width', '100%', 'important');
                appContent.style.setProperty('max-width', 'none', 'important');
            }

            // DO NOT touch pane display - let CSS handle it via .active class
            // This ensures tab switching works correctly
        }

        // Run immediately and on DOM ready
        neutralizeGHLConstraints();
        document.addEventListener('DOMContentLoaded', neutralizeGHLConstraints);

        // Watch for DOM mutations (GHL might inject containers dynamically)
        // But exclude pane elements to avoid interfering with tab switching
        const constraintObserver = new MutationObserver((mutations) => {
            // Only run if the mutation doesn't involve pane elements
            const hasPaneMutation = mutations.some(mutation => {
                if (mutation.target.classList && mutation.target.classList.contains('pane')) {
                    return true;
                }
                if (mutation.target.closest && mutation.target.closest('.pane')) {
                    return true;
                }
                return false;
            });
            
            if (!hasPaneMutation) {
                neutralizeGHLConstraints();
            }
        });
        constraintObserver.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });

        // Also run after delays to catch late injections
        setTimeout(neutralizeGHLConstraints, 100);
        setTimeout(neutralizeGHLConstraints, 500);
        setTimeout(neutralizeGHLConstraints, 1000);
        setTimeout(neutralizeGHLConstraints, 2000);

        /* ===== ADMIN DASHBOARD ===== */
        const adminDashboard = {
            dateRange: '30',
            
            async refresh() {
                const container = document.getElementById('adminDashboardContent');
                if (!container) return;
                
                container.innerHTML = '<div class="spinner"></div>';
                this.dateRange = document.getElementById('adminDateRange')?.value || '30';
                
                try {
                const [deliverablesRes, trainingRes, tasksRes, candidatesRes, hoursRes] = await Promise.all([
                    fetch(`${API_URL}?action=deliverables&status=all`).catch((e) => { console.error('[Admin] Deliverables fetch error:', e); return { ok: false }; }),
                    fetch(`${API_URL}?action=trainingCompletions&vaName=all`).catch((e) => { console.error('[Admin] Training fetch error:', e); return { ok: false }; }),
                    fetch(`${API_URL}?action=tasks`).catch((e) => { console.error('[Admin] Tasks fetch error:', e); return { ok: false }; }),
                    fetch(`${API_URL}?action=candidates&stage=all`).catch((e) => { console.error('[Admin] Candidates fetch error:', e); return { ok: false }; }),
                    // CRITICAL: Use same endpoint format as Log Hours tab, but with vaName=all for admin view
                    fetch(`${API_URL}?action=hours`).catch((e) => { console.error('[Admin] Hours fetch error:', e); return { ok: false }; })
                ]);
                
                // Debug: Log hours response status
                if (!hoursRes.ok) {
                    console.warn('[Admin Dashboard] Hours fetch failed:', hoursRes.status, hoursRes.statusText);
                }

                    const deliverables = deliverablesRes.ok ? await deliverablesRes.json().catch(() => ({ deliverables: [] })) : { deliverables: [] };
                    const training = trainingRes.ok ? await trainingRes.json().catch(() => ({ trainingCompletions: [] })) : { trainingCompletions: [] };
                    const tasks = tasksRes.ok ? await tasksRes.json().catch(() => ({ tasks: [] })) : { tasks: [] };
                    const candidates = candidatesRes.ok ? await candidatesRes.json().catch(() => ({ data: [], candidates: [] })) : { data: [], candidates: [] };
                    
                    // CRITICAL: Use same response structure as Log Hours tab
                    let hoursData = null;
                    try {
                        hoursData = hoursRes.ok ? await hoursRes.json() : { ok: false, hours: [] };
                    } catch (e) {
                        console.error('[Admin Dashboard] Failed to parse hours JSON:', e);
                        hoursData = { ok: false, hours: [] };
                    }
                    
                    // Extract hours array - handle both { ok: true, hours: [...] } and { hours: [...] } formats
                    // This matches exactly how loadHoursHistory() processes the response
                    let allHours = [];
                    if (hoursData && hoursData.ok && Array.isArray(hoursData.hours)) {
                        allHours = hoursData.hours;
                    } else if (hoursData && Array.isArray(hoursData.hours)) {
                        allHours = hoursData.hours;
                    } else if (Array.isArray(hoursData)) {
                        allHours = hoursData;
                    } else if (hoursData && hoursData.data && Array.isArray(hoursData.data)) {
                        allHours = hoursData.data;
                    }
                    
                    // Debug logging to help diagnose
                    console.log('[Admin Dashboard] Hours data:', {
                        responseOk: hoursRes.ok,
                        responseStatus: hoursRes.status,
                        dataStructure: hoursData,
                        hoursCount: allHours.length,
                        sampleEntry: allHours[0] || null
                    });
                    
                    if (allHours.length === 0 && hoursRes.ok) {
                        console.warn('[Admin Dashboard] No hours found. Response structure:', hoursData);
                    }

                    // Keep ALL hours for accurate "Total Hours" calculation
                    // Date range filter is only for other context-specific views, not for hours totals
                    const hours = allHours; // Use all hours for calculations

                    this.render(deliverables.deliverables || [], training.trainingCompletions || [], tasks.tasks || [], candidates.candidates || candidates.data || [], hours);
                } catch (error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-text" style="color: var(--danger);">Error: ${error.message}</div></div>`;
                }
            },
            
            render(deliverables, trainingCompletions, tasks, candidates, hours) {
                const container = document.getElementById('adminDashboardContent');
                if (!container) return;
                
                const deliverablesCount = deliverables.length;
                const pendingDeliverables = deliverables.filter(d => d.Status === 'pending').length;
                const trainingCount = trainingCompletions.length;
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() === 'COMPLETED').length;
                const candidatesCount = candidates.length;
                
                // DEBUG: Log initial hours data
                console.log('[Admin Dashboard] render() - Hours calculation START:', {
                    hoursArrayLength: hours.length,
                    firstEntry: hours[0] || null,
                    firstEntryKeys: hours[0] ? Object.keys(hours[0]) : [],
                    sampleEntries: hours.slice(0, 3).map(h => ({
                        keys: Object.keys(h),
                        hoursField: h.Hours || h.hours || h.Hours_Logged || h.hoursLogged || 'NOT_FOUND',
                        dateField: h.Date || h.date || h.Logged_At || h.loggedAt || 'NOT_FOUND',
                        loggedBy: h.Logged_By || h.loggedBy || h.VA_Name || h.vaName || 'NOT_FOUND'
                    }))
                });
                
                // Helper function to extract hours value from entry (matches Log Hours tab logic)
                const getHoursValue = (h) => {
                    const val = h.Hours || h.hours || h.Hours_Logged || h.hoursLogged || 0;
                    const parsed = parseFloat(val);
                    const result = isNaN(parsed) ? 0 : parsed;
                    if (result === 0 && val !== 0 && val !== '0') {
                        console.warn('[Admin Dashboard] Failed to parse hours value:', { val, h });
                    }
                    return result;
                };
                
                // Helper function to extract date from entry
                const getEntryDate = (h) => {
                    const dateStr = h.Date || h.date || h.Logged_At || h.loggedAt;
                    if (!dateStr) return null;
                    const date = new Date(dateStr);
                    return isNaN(date.getTime()) ? null : date;
                };
                
                // Calculate total hours - ALL time (use all hours entries)
                const totalHours = hours.reduce((sum, h) => {
                    const hoursValue = getHoursValue(h);
                    return sum + hoursValue;
                }, 0);
                
                console.log('[Admin Dashboard] Total hours calculated:', totalHours);
                
                // Pipeline stats
                const byStage = { SCREENED: 0, INTERVIEWED: 0, HIRED: 0, REJECTED: 0 };
                candidates.forEach(c => {
                    const stage = (c.Current_Stage || c.currentStage || 'SCREENED').toUpperCase();
                    if (byStage[stage] !== undefined) byStage[stage]++;
                });
                const total = candidates.length;
                const screenedToInterview = byStage.SCREENED > 0 ? ((byStage.INTERVIEWED / byStage.SCREENED) * 100).toFixed(1) : 0;
                const interviewToHire = byStage.INTERVIEWED > 0 ? ((byStage.HIRED / byStage.INTERVIEWED) * 100).toFixed(1) : 0;
                const overallConversion = total > 0 ? ((byStage.HIRED / total) * 100).toFixed(1) : 0;
                
                // Task stats
                const todo = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() !== 'COMPLETED');
                const done = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() === 'COMPLETED');
                const byPriority = { high: 0, medium: 0, low: 0 };
                todo.forEach(t => {
                    const p = ((t.Priority || 'medium').toLowerCase());
                    if (byPriority[p] !== undefined) byPriority[p]++;
                });
                const completionRate = tasks.length > 0 ? ((done.length / tasks.length) * 100).toFixed(1) : 0;
                
                // Hours stats by VA - group all hours by team member
                const byVA = {};
                hours.forEach(h => {
                    const va = h.Logged_By || h.loggedBy || h.VA_Name || h.vaName || h.VA || 'Unknown';
                    const hoursValue = getHoursValue(h);
                    
                    if (!byVA[va]) byVA[va] = { total: 0, count: 0 };
                    byVA[va].total += hoursValue;
                    byVA[va].count++;
                });
                
                // Average hours per entry (across all entries)
                const avgHoursPerEntry = hours.length > 0 ? (totalHours / hours.length) : 0;
                
                // Calculate weekly hours (last 7 days) - filter entries from last 7 days
                const now = new Date();
                const sevenDaysAgo = new Date(now);
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                sevenDaysAgo.setHours(0, 0, 0, 0);
                
                console.log('[Admin Dashboard] Weekly hours filter:', {
                    now: now.toISOString(),
                    sevenDaysAgo: sevenDaysAgo.toISOString()
                });
                
                let weeklyEntriesCount = 0;
                const weeklyHours = hours.reduce((sum, h) => {
                    const entryDate = getEntryDate(h);
                    if (!entryDate) return sum;
                    
                    const entryDateOnly = new Date(entryDate);
                    entryDateOnly.setHours(0, 0, 0, 0);
                    
                    // Include entries from last 7 days (including today)
                    if (entryDateOnly >= sevenDaysAgo) {
                        weeklyEntriesCount++;
                        const hoursValue = getHoursValue(h);
                        return sum + hoursValue;
                    }
                    return sum;
                }, 0);
                
                console.log('[Admin Dashboard] Weekly hours calculated:', {
                    weeklyHours,
                    weeklyEntriesCount,
                    totalEntries: hours.length
                });
                
                const sortedVAs = Object.entries(byVA).sort((a, b) => b[1].total - a[1].total);
                
                // DEBUG: Final calculated values
                console.log('[Admin Dashboard] Final calculations:', {
                    totalHours,
                    weeklyHours,
                    avgHoursPerEntry,
                    hoursCount: hours.length,
                    byVACount: Object.keys(byVA).length,
                    sortedVAs: sortedVAs.map(([va, stats]) => ({ va, total: stats.total, count: stats.count }))
                });

                container.innerHTML = `
                    <!-- Key Metrics Row -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 32px;">
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;" onclick="adminDashboard.showDeliverablesDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--cobalt); margin-bottom: 8px; line-height: 1;">${deliverablesCount}</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Total Deliverables</div>
                            <div style="font-size: 12px; color: #6b7280;">${pendingDeliverables} pending</div>
                    </div>
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;" onclick="adminDashboard.showTrainingDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--cobalt); margin-bottom: 8px; line-height: 1;">${trainingCount}</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Training Completions</div>
                            <div style="font-size: 12px; color: #6b7280;">Across all team</div>
                    </div>
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;" onclick="adminDashboard.showTasksDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--cobalt); margin-bottom: 8px; line-height: 1;">${totalTasks}</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Total Tasks</div>
                            <div style="font-size: 12px; color: #6b7280;">${completedTasks} completed</div>
                    </div>
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;" onclick="adminDashboard.showCandidatesDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--cobalt); margin-bottom: 8px; line-height: 1;">${candidatesCount}</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Candidates</div>
                            <div style="font-size: 12px; color: #6b7280;">In pipeline</div>
                    </div>
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer; border-left: 4px solid var(--azure);" onclick="adminDashboard.showHoursDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--azure); margin-bottom: 8px; line-height: 1;">${weeklyHours.toFixed(1)}h</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">This Week's Hours</div>
                            <div style="font-size: 12px; color: #6b7280;">Total hours worked (last 7 days)</div>
                            <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">All time: ${totalHours.toFixed(1)}h</div>
                        </div>
                    </div>

                    <!-- Main Dashboard Grid -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">
                        <!-- Pipeline Intelligence -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 20px 0;">Pipeline Intelligence</h3>
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${total}</div>
                                        <div style="font-size: 12px; color: #6b7280;">Total Candidates</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${overallConversion}%</div>
                                        <div style="font-size: 12px; color: #6b7280;">Overall Conversion</div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${byStage.SCREENED}</div>
                                        <div style="font-size: 10px; color: #6b7280;">Screened</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${byStage.INTERVIEWED}</div>
                                        <div style="font-size: 10px; color: #6b7280;">Interviewed</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${byStage.HIRED}</div>
                                        <div style="font-size: 10px; color: #6b7280;">Hired</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${byStage.REJECTED}</div>
                                        <div style="font-size: 10px; color: #6b7280;">Rejected</div>
                                    </div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">Conversion Rates</div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                            <span style="color: #6b7280;">Screened → Interviewed</span>
                                            <span style="font-weight: 600; color: var(--cobalt);">${screenedToInterview}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                            <span style="color: #6b7280;">Interviewed → Hired</span>
                                            <span style="font-weight: 600; color: var(--cobalt);">${interviewToHire}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Task Ecosystem -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 20px 0;">Task Ecosystem</h3>
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${todo.length}</div>
                                        <div style="font-size: 12px; color: #6b7280;">To Do</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${done.length}</div>
                                        <div style="font-size: 12px; color: #6b7280;">Completed</div>
                                    </div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">Completion Rate</div>
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${completionRate}%</div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">Priority Breakdown (To Do)</div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">
                                            <span style="color: var(--cobalt); font-weight: 600;">High</span>
                                            <span style="font-weight: 700; color: var(--cobalt);">${byPriority.high}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">
                                            <span style="color: var(--cobalt); font-weight: 600;">Medium</span>
                                            <span style="font-weight: 700; color: var(--cobalt);">${byPriority.medium}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">
                                            <span style="color: var(--cobalt); font-weight: 600;">Low</span>
                                            <span style="font-weight: 700; color: var(--cobalt);">${byPriority.low}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Productivity & Capacity -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 20px 0;">Productivity & Capacity</h3>
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; border-left: 4px solid var(--azure);">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--azure); margin-bottom: 4px;">${weeklyHours.toFixed(1)}h</div>
                                        <div style="font-size: 12px; color: #6b7280; font-weight: 600;">This Week</div>
                                        <div style="font-size: 10px; color: #9ca3af; margin-top: 2px;">Hours worked (last 7 days)</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${totalHours.toFixed(1)}h</div>
                                        <div style="font-size: 12px; color: #6b7280;">Total Hours</div>
                                        <div style="font-size: 10px; color: #9ca3af; margin-top: 2px;">All time</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${avgHoursPerEntry.toFixed(1)}h</div>
                                        <div style="font-size: 12px; color: #6b7280;">Avg per Entry</div>
                                        <div style="font-size: 10px; color: #9ca3af; margin-top: 2px;">Per work day</div>
                                    </div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">Hours by Team Member</div>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        ${sortedVAs.length === 0 ? '<div style="color: #6b7280; font-size: 12px;">No hours logged yet</div>' : sortedVAs.map(([va, stats]) => `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                                <div>
                                                    <div style="font-weight: 600; font-size: 14px; color: var(--cobalt);">${va}</div>
                                                    <div style="font-size: 11px; color: #6b7280;">${stats.count} entries</div>
                                                </div>
                                                <div style="font-size: 18px; font-weight: 900; color: var(--cobalt);">${stats.total.toFixed(1)}h</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Learning & Knowledge -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 20px 0;">Learning & Knowledge</h3>
                            <div style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                                <p style="color: #6b7280; margin-bottom: 20px; font-size: 15px;">Advanced learning analytics, pattern analysis, and scenario simulation</p>
                                <a href="https://home2smart.com/analytics" target="_blank" class="btn" style="padding: 12px 24px; font-size: 14px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block; font-weight: 600;">
                                    Open Analytics Dashboard →
                                </a>
                            </div>
                        </div>

                        <!-- Forecast / Simulation -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; margin-top: 24px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 24px 0;">Forecast / Simulation</h3>
                            <div id="adminForecastCalculator"></div>
                        </div>
                    </div>
                `;
                
                // Initialize forecast calculator after rendering
                setTimeout(async () => {
                    if (typeof adminForecastCalculator !== 'undefined' && adminForecastCalculator) {
                        await adminForecastCalculator.init();
                    }
                }, 100);
            },
            
            async showDeliverablesDetail() {
            try {
                const response = await fetch(`${API_URL}?action=deliverables&status=all`);
                const data = await response.json();
                    const deliverables = data.deliverables || [];
                    
                    showModal('All Deliverables', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${deliverables.length === 0 ? '<div style="text-align: center; padding: 40px; color: #6b7280;">No deliverables found</div>' : deliverables.map(d => `
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-weight: 700; font-size: 15px; color: var(--cobalt); margin-bottom: 8px;">${d.Title || 'Untitled'}</div>
                                        <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">${(d.Description || '').substring(0, 200)}${(d.Description || '').length > 200 ? '...' : ''}</div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
                                            <span style="color: #6b7280;">By: ${d.Submitted_By || 'Unknown'}</span>
                                        <span style="background: ${d.Status === 'pending' ? '#fef3c7' : d.Status === 'published' ? '#d1fae5' : '#fee2e2'}; color: ${d.Status === 'pending' ? '#92400e' : d.Status === 'published' ? '#065f46' : '#991b1b'}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                            ${d.Status || 'unknown'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        </div>
                    `, { width: '800px' });
            } catch (error) {
                    showToast('Error loading deliverables: ' + error.message, 'error');
            }
            },

            async showTrainingDetail() {
            try {
                const response = await fetch(`${API_URL}?action=trainingCompletions&vaName=all`);
                const data = await response.json();
                    const completions = data.trainingCompletions || [];
                    
                    const byVA = {};
                    completions.forEach(c => {
                        const va = c.VA_Name || 'Unknown';
                        if (!byVA[va]) byVA[va] = [];
                        byVA[va].push(c);
                    });
                    
                    showModal('Training Completions', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                                ${Object.keys(byVA).length === 0 ? '<div style="text-align: center; padding: 40px; color: #6b7280;">No training completions found</div>' : Object.entries(byVA).map(([va, comps]) => {
                                const totalMinutes = comps.reduce((sum, c) => sum + (c.Time_Spent_Minutes || 0), 0);
                                const avgComprehension = comps.reduce((sum, c) => sum + (c.Comprehension_Level || 0), 0) / comps.length;
                                return `
                                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                            <div style="font-weight: 700; font-size: 16px; color: var(--cobalt); margin-bottom: 12px;">${va}</div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                                            <div>
                                                    <div style="font-size: 24px; font-weight: 900; color: var(--cobalt);">${comps.length}</div>
                                                    <div style="font-size: 11px; color: #6b7280;">Completed</div>
                                            </div>
                                            <div>
                                                    <div style="font-size: 24px; font-weight: 900; color: var(--cobalt);">${(totalMinutes / 60).toFixed(1)}h</div>
                                                    <div style="font-size: 11px; color: #6b7280;">Learning Time</div>
                                            </div>
                                            <div>
                                                    <div style="font-size: 24px; font-weight: 900; color: var(--cobalt);">${avgComprehension.toFixed(1)}/5</div>
                                                    <div style="font-size: 11px; color: #6b7280;">Avg Comprehension</div>
                                            </div>
                                        </div>
                                            <div style="font-size: 12px; color: #6b7280;">Recent: ${comps.slice(0, 3).map(c => c.Training_Title || 'Untitled').join(', ')}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        </div>
                    `, { width: '800px' });
                } catch (error) {
                    showToast('Error loading training: ' + error.message, 'error');
                }
            },
            
            async showTasksDetail() {
                try {
                    const response = await fetch(`${API_URL}?action=tasks`);
                    const data = await response.json();
                    const tasks = data.tasks || [];
                    
                    showModal('All Tasks', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${tasks.length === 0 ? '<div style="text-align: center; padding: 40px; color: #6b7280;">No tasks found</div>' : tasks.map(t => `
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-weight: 700; font-size: 15px; color: var(--cobalt);">${t.Title || 'Untitled'}</div>
                                            <span style="background: ${(t.Status || 'PENDING').toUpperCase() === 'COMPLETED' ? '#d1fae5' : '#fef3c7'}; color: ${(t.Status || 'PENDING').toUpperCase() === 'COMPLETED' ? '#065f46' : '#92400e'}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                                ${t.Status || 'PENDING'}
                                            </span>
                                        </div>
                                        <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">${(t.Description || '').substring(0, 150)}${(t.Description || '').length > 150 ? '...' : ''}</div>
                                        <div style="display: flex; gap: 8px; font-size: 12px; color: #6b7280;">
                                            <span>Priority: ${(t.Priority || 'medium').toUpperCase()}</span>
                                            <span>•</span>
                                            <span>Assigned: ${t.Assigned_To || 'Unassigned'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `, { width: '800px' });
            } catch (error) {
                    showToast('Error loading tasks: ' + error.message, 'error');
                }
            },
            
            async showCandidatesDetail() {
                try {
                    const response = await fetch(`${API_URL}?action=candidates&stage=all`);
                    const data = await response.json();
                    const candidates = data.candidates || data.data || [];
                    
                    const byStage = { SCREENED: 0, INTERVIEWED: 0, HIRED: 0, REJECTED: 0 };
                    candidates.forEach(c => {
                        const stage = (c.Current_Stage || c.currentStage || 'SCREENED').toUpperCase();
                        if (byStage[stage] !== undefined) byStage[stage]++;
                    });
                    
                    showModal('All Candidates', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${byStage.SCREENED}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Screened</div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${byStage.INTERVIEWED}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Interviewed</div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${byStage.HIRED}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Hired</div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${byStage.REJECTED}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Rejected</div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${candidates.slice(0, 20).map(c => `
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-weight: 600; font-size: 14px; color: var(--cobalt);">${c.First_Name || ''} ${c.Last_Name || ''}</div>
                                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${c.Phone || 'No phone'} • ${c.Email || 'No email'} • Stage: ${c.Current_Stage || 'UNKNOWN'}</div>
                                    </div>
                                `).join('')}
                                ${candidates.length > 20 ? `<div style="text-align: center; padding: 16px; color: #6b7280; font-size: 13px;">... and ${candidates.length - 20} more candidates</div>` : ''}
                            </div>
                        </div>
                    `, { width: '900px' });
                } catch (error) {
                    showToast('Error loading candidates: ' + error.message, 'error');
                }
            },
            
            async showHoursDetail() {
                try {
                    const response = await fetch(`${API_URL}?action=hours&vaName=all`);
                const data = await response.json();
                    let hours = data.hours || [];
                    
                    // Apply date range filter if set
                    if (this.dateRange && this.dateRange !== 'all') {
                        const days = parseInt(this.dateRange);
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - days);
                        
                        hours = hours.filter(h => {
                            const entryDate = new Date(h.Date || h.date || h.Logged_At || h.loggedAt);
                            return entryDate >= cutoffDate;
                        });
                    }
                    
                    const byVA = {};
                    hours.forEach(h => {
                        const va = h.Logged_By || h.loggedBy || h.VA_Name || 'Unknown';
                        if (!byVA[va]) byVA[va] = { total: 0, entries: [] };
                        byVA[va].total += parseFloat(h.Hours || h.hours) || 0;
                        byVA[va].entries.push(h);
                    });
                    
                    const sortedVAs = Object.entries(byVA).sort((a, b) => b[1].total - a[1].total);
                    
                    showModal('Hours Logged', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                ${sortedVAs.length === 0 ? '<div style="text-align: center; padding: 40px; color: #6b7280;">No hours logged yet</div>' : sortedVAs.map(([va, stats]) => `
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <div style="font-weight: 700; font-size: 16px; color: var(--cobalt);">${va}</div>
                                            <div style="font-size: 20px; font-weight: 900; color: var(--cobalt);">${stats.total.toFixed(1)}h</div>
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">${stats.entries.length} entries</div>
                                        <div style="display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto;">
                                            ${stats.entries.slice(0, 10).map(e => `
                                                <div style="background: white; padding: 8px; border-radius: 6px; font-size: 12px; border: 1px solid #e5e7eb;">
                                                    <span style="font-weight: 600; color: var(--cobalt);">${parseFloat(e.Hours || e.hours || 0).toFixed(1)}h</span>
                                                    <span style="color: #6b7280; margin-left: 8px;">${e.Tasks || 'No description'}</span>
                                                </div>
                                            `).join('')}
                                            ${stats.entries.length > 10 ? `<div style="text-align: center; padding: 8px; color: #6b7280; font-size: 11px;">... and ${stats.entries.length - 10} more entries</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `, { width: '800px' });
                } catch (error) {
                    showToast('Error loading hours: ' + error.message, 'error');
                }
            }
        };

        /* ===== ADMIN FORECAST CALCULATOR (Inside Admin Dashboard) ===== */
        const adminForecastCalculator = {
            inputs: {
                cities: 1,
                techs: 2,
                jobsPerTechPerDay: 3,
                workDaysPerMonth: 22,
                rampFactor: 100,
                aov: 300,
                grossMargin: 40,
                techPayoutPct: 35,
                equipCostPerJob: 50,
                overheadPerJob: 10,
                dailyAdSpend: 20, // Updated to $20/day baseline
                cpm: 0,
                cpc: 15,
                leadToBookingRate: 25,
                bookingToCompletedRate: 85,
                cancelRate: 5,
                // Extracted metadata fields (aligned with extraction schema)
                market: null, // Location extracted from scenario (e.g., "Greenville, South Carolina")
                services: [], // Services extracted from scenario (e.g., ["TV mounting", "camera mounting"])
                creatives: null // Number of creatives extracted
            },
            // Store conversation context including location
            conversationContext: {
                location: null, // e.g., "Greenville, South Carolina" or "Dallas, TX"
                previousInputs: null // Last parsed scenario text for context
            },
            
            updateStickyPositioning() {
                // Simplified: Standards is sticky at top, Totals flows naturally
                // No need for complex calculations - CSS handles the layout
                const standardsEl = document.getElementById('offerBuilderStandards');
                const totalsEl = document.getElementById('offerBuilderTotals');
                
                if (!standardsEl || !totalsEl) return;
                
                // On mobile, disable sticky behavior
                if (window.innerWidth <= 768) {
                    standardsEl.style.position = 'relative';
                    standardsEl.style.top = 'auto';
                    standardsEl.style.maxHeight = 'none';
                    return;
                }
                
                // Desktop: Standards is sticky, Totals flows naturally
                // No overlap because Totals is not sticky
            },
            
            initStickyPositioningObserver() {
                // Set up ResizeObserver to watch for height changes in both panels and their content
                const standardsEl = document.getElementById('offerBuilderStandards');
                const totalsEl = document.getElementById('offerBuilderTotals');
                if (!standardsEl || !totalsEl || this.stickyObserver) return;
                
                // Create ResizeObserver to watch panel heights
                this.stickyObserver = new ResizeObserver(() => {
                    // Debounce updates to avoid excessive recalculations
                    clearTimeout(this.stickyUpdateTimer);
                    this.stickyUpdateTimer = setTimeout(() => {
                        this.updateStickyPositioning();
                    }, 100);
                });
                
                // Observe both panels and their content areas
                this.stickyObserver.observe(standardsEl);
                this.stickyObserver.observe(totalsEl);
                const standardsContent = standardsEl.querySelector('#offerBuilderStandardsContent');
                const totalsResults = totalsEl.querySelector('#offerBuilderResults');
                if (standardsContent) this.stickyObserver.observe(standardsContent);
                if (totalsResults) this.stickyObserver.observe(totalsResults);
                
                // Also watch for select dropdown interactions and any DOM changes in right column
                const rightColumn = document.getElementById('offerBuilderRightColumn');
                if (rightColumn && !this.selectInteractionHandler) {
                    this.selectInteractionHandler = (e) => {
                        // When any select in the right column is interacted with
                        if (e.target.tagName === 'SELECT') {
                            // Update immediately, then again after a delay to catch dropdown render
                            this.updateStickyPositioning();
                            clearTimeout(this.stickyUpdateTimer);
                            this.stickyUpdateTimer = setTimeout(() => {
                                this.updateStickyPositioning();
                            }, 200);
                        }
                    };
                    // Listen for clicks, focus, and changes on select elements
                    rightColumn.addEventListener('click', this.selectInteractionHandler, true);
                    rightColumn.addEventListener('change', this.selectInteractionHandler, true);
                    rightColumn.addEventListener('focus', this.selectInteractionHandler, true);
                    rightColumn.addEventListener('blur', this.selectInteractionHandler, true);
                }
                
                // Watch for DOM mutations in the right column (content changes, attribute changes)
                if (rightColumn && !this.mutationObserver) {
                    this.mutationObserver = new MutationObserver(() => {
                        clearTimeout(this.stickyUpdateTimer);
                        this.stickyUpdateTimer = setTimeout(() => {
                            this.updateStickyPositioning();
                        }, 100);
                    });
                    this.mutationObserver.observe(rightColumn, {
                        childList: true,
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['style', 'class']
                    });
                }
                
                // CRITICAL: Watch LEFT column for accordion expansions that change height
                // This ensures sticky positioning recalculates when accordions expand/collapse
                const leftColumn = document.querySelector('#offerbuilder-pane #offerBuilderMainGrid > div:first-child');
                if (leftColumn && !this.leftColumnObserver) {
                    this.leftColumnObserver = new ResizeObserver(() => {
                        clearTimeout(this.stickyUpdateTimer);
                        this.stickyUpdateTimer = setTimeout(() => {
                            this.updateStickyPositioning();
                        }, 100);
                    });
                    this.leftColumnObserver.observe(leftColumn);
                    
                    // Also watch for accordion content changes via MutationObserver
                    this.leftColumnMutationObserver = new MutationObserver((mutations) => {
                        // Only trigger if display style changes (accordion toggle)
                        const hasDisplayChange = mutations.some(m => 
                            m.type === 'attributes' && 
                            m.attributeName === 'style' &&
                            (m.target.style.display === 'block' || m.target.style.display === 'none')
                        );
                        if (hasDisplayChange) {
                            clearTimeout(this.stickyUpdateTimer);
                            this.stickyUpdateTimer = setTimeout(() => {
                                this.updateStickyPositioning();
                            }, 150);
                        }
                    });
                    this.leftColumnMutationObserver.observe(leftColumn, {
                        childList: true,
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['style']
                    });
                }
                
                // Watch window resize
                if (!this.windowResizeHandler) {
                    this.windowResizeHandler = () => {
                        clearTimeout(this.stickyUpdateTimer);
                        this.stickyUpdateTimer = setTimeout(() => {
                            this.updateStickyPositioning();
                        }, 150);
                    };
                    window.addEventListener('resize', this.windowResizeHandler);
                }
            },
            
            async init() {
                // Calculate intelligent defaults before loading saved values
                await this.calculateIntelligentDefaults();
                this.loadFromStorage();
                
                // Initialize sticky positioning observer
                setTimeout(() => {
                    this.initStickyPositioningObserver();
                    this.updateStickyPositioning();
                }, 200);
                
                this.render();
                this.attachListeners();
                setTimeout(() => this.loadOfferPresets(), 100);
            },
            
            async calculateIntelligentDefaults(extractedText) {
                // GAP FIX #1: Expanded auto-population intelligence + GAP FIX #14: Extraction-driven intelligence
                try {
                    // GAP FIX #14: Detect business stage and adjust defaults
                    if (extractedText) {
                        const businessStage = this.detectBusinessStage(extractedText);
                        if (businessStage === 'early') {
                            // Early stage: Lower expectations, adjust defaults
                            if (!this.inputs.leadToBookingRate || this.inputs.leadToBookingRate === 25) {
                                this.inputs.leadToBookingRate = 15; // Conservative for early stage
                            }
                            if (!this.inputs.bookingToCompletedRate || this.inputs.bookingToCompletedRate === 85) {
                                this.inputs.bookingToCompletedRate = 70; // Lower for new business
                            }
                        } else if (businessStage === 'scaling') {
                            // Scaling: Optimistic defaults
                            if (!this.inputs.leadToBookingRate || this.inputs.leadToBookingRate === 25) {
                                this.inputs.leadToBookingRate = 30; // Higher for scaling
                            }
                        }
                    }
                    
                    try {
                        // 1. AOV from saved offers or performance data
                        const savedOffers = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                        if (savedOffers.length > 0) {
                            const aovs = savedOffers
                                .filter(o => o.totals && o.totals.customerPrice > 0)
                                .map(o => o.totals.customerPrice);
                            
                            if (aovs.length > 0) {
                                const avgAOV = aovs.reduce((sum, aov) => sum + aov, 0) / aovs.length;
                                this.inputs.aov = Math.round(avgAOV);
                            }
                        }
                        
                        // Try to get AOV from performance data
                        try {
                            const perfResponse = await fetch(`${API_URL}?action=offer_performance&days=90`);
                            if (perfResponse.ok) {
                                const perfData = await perfResponse.json();
                                const data = perfData.offer_performance || perfData;
                                if (data.summary && data.summary.avg_order_value > 0) {
                                    this.inputs.aov = Math.round(data.summary.avg_order_value);
                                }
                            }
                        } catch (e) {
                            // Fallback to default
                        }
                        
                        // 2. GAP FIX: Service-specific AOV if services extracted
                        if (this.inputs.services && this.inputs.services.length > 0) {
                            const serviceAOVs = {
                                'TV Mount': 300,
                                'TV mounting': 300,
                                'Cameras': 800,
                                'Camera': 800,
                                'camera mounting': 800,
                                'Doorbell': 400,
                                'WiFi': 300,
                                'Network': 300,
                                'Bundle': 1200
                            };
                            
                            const serviceValues = this.inputs.services
                                .map(s => serviceAOVs[s] || serviceAOVs[Object.keys(serviceAOVs).find(k => s.toLowerCase().includes(k.toLowerCase()))] || 300)
                                .filter(v => v);
                            
                            if (serviceValues.length > 0) {
                                const weightedAOV = serviceValues.reduce((sum, v) => sum + v, 0) / serviceValues.length;
                                // Use service AOV if it's significantly different from current
                                if (Math.abs(weightedAOV - this.inputs.aov) > 50) {
                                    this.inputs.aov = Math.round(weightedAOV);
                                }
                            }
                        }
                        
                        // 3. GAP FIX: Fetch actual CPC from tracking/revenue data
                        try {
                            const revenueResponse = await fetch(`${API_URL}?action=revenue`);
                            if (revenueResponse.ok) {
                                const revData = await revenueResponse.json();
                                // Try to calculate CPC from tracking events if available
                                // This would need tracking events endpoint to provide CPC data
                            }
                        } catch (e) {
                            // Fallback
                        }
                        
                        // 4. GAP FIX: Calculate jobs-per-tech from hours logged data
                        try {
                            const hoursResponse = await fetch(`${API_URL}?action=hours&vaName=all`);
                            if (hoursResponse.ok) {
                                const hoursData = await hoursResponse.json();
                                const hours = hoursData.hours || [];
                                
                                if (hours.length > 0 && this.inputs.techs > 0) {
                                    // Calculate average hours per entry in last 30 days
                                    const thirtyDaysAgo = new Date();
                                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                                    
                                    const recentHours = hours.filter(h => {
                                        const date = new Date(h.Date || h.date || h.Logged_At);
                                        return date >= thirtyDaysAgo;
                                    });
                                    
                                    if (recentHours.length > 0) {
                                        const totalHours = recentHours.reduce((sum, h) => {
                                            return sum + (parseFloat(h.Hours || h.hours || 0));
                                        }, 0);
                                        
                                        // Estimate: 4 hours per job on average
                                        const avgJobsPerDay = (totalHours / 30) / 4 / this.inputs.techs;
                                        
                                        if (avgJobsPerDay > 0 && avgJobsPerDay < 10) {
                                            this.inputs.jobsPerTechPerDay = Math.round(avgJobsPerDay * 10) / 10;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            // Fallback
                        }
                    } catch (e) {
                        console.warn('Could not calculate intelligent defaults (inner)', e);
                    }
                } catch (e) {
                    console.warn('Could not calculate intelligent defaults (outer)', e);
                }
            },
            
            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('h2s_admin_forecast_inputs_v1');
                    if (saved) {
                        const savedData = JSON.parse(saved);
                        // Load inputs
                        if (savedData.inputs) {
                            Object.keys(savedData.inputs).forEach(key => {
                                if (savedData.inputs[key] !== undefined && savedData.inputs[key] !== null) {
                                    this.inputs[key] = savedData.inputs[key];
                                }
                            });
                        } else {
                            // Legacy format - just inputs object
                            Object.keys(savedData).forEach(key => {
                                if (savedData[key] !== undefined && savedData[key] !== null && key !== 'location') {
                                    this.inputs[key] = savedData[key];
                                }
                            });
                        }
                        // Load conversation context
                        if (savedData.context) {
                            if (savedData.context.location) {
                                this.conversationContext.location = savedData.context.location;
                            }
                            if (savedData.context.previousInputs) {
                                this.conversationContext.previousInputs = savedData.context.previousInputs;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Could not load saved forecast inputs', e);
                }
            },
            
            saveToStorage() {
                try {
                    // Save both inputs and conversation context
                    localStorage.setItem('h2s_admin_forecast_inputs_v1', JSON.stringify({
                        inputs: this.inputs,
                        context: this.conversationContext
                    }));
                } catch (e) {
                    console.warn('Could not save forecast inputs', e);
                }
            },
            
            attachListeners() {
                const container = document.getElementById('adminForecastCalculator');
                if (!container) return;
                
                // Debounced update
                let updateTimer;
                container.addEventListener('input', (e) => {
                    if (e.target.dataset.forecastInput) {
                        clearTimeout(updateTimer);
                        updateTimer = setTimeout(() => {
                            this.updateInput(e.target.dataset.forecastInput, e.target.value);
                            this.recalculate();
                        }, 300);
                    }
                });
                
                container.addEventListener('change', (e) => {
                    if (e.target.dataset.forecastInput) {
                        this.updateInput(e.target.dataset.forecastInput, e.target.value);
                        this.recalculate();
                    }
                });
            },
            
            async parseNaturalLanguage() {
                const inputEl = document.getElementById('forecastNaturalLanguageInput');
                const resultEl = document.getElementById('forecastParseResult');
                if (!inputEl || !resultEl) return;
                
                const text = inputEl.value.trim();
                if (!text) {
                    showToast('Please describe your scenario first', 'error');
                    return;
                }
                
                // Show loading
                resultEl.style.display = 'block';
                resultEl.innerHTML = '<div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #bae6fd;"><div style="display: flex; align-items: center; gap: 8px;"><div class="spinner" style="width: 16px; height: 16px;"></div><span style="color: #075985; font-size: 13px;">Parsing scenario with AI...</span></div></div>';
                
                try {
                    // Use AI to extract metrics with location context awareness
                    const extracted = await this.extractForecastMetricsWithAI(text);
                    
                    // Update conversation context with location if found
                    if (extracted.market) {
                        this.conversationContext.location = extracted.market;
                    }
                    this.conversationContext.previousInputs = text;
                    
                    // Show extracted values for confirmation
                    const extractedSummary = this.formatExtractedMetrics(extracted);
                    const extractedJSON = this.formatExtractedJSON(extracted);
                    resultEl.innerHTML = `
                        <div style="background: white; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px;">
                            <div style="font-size: 14px; font-weight: 700; color: #0c4a6e; margin-bottom: 12px;">Extracted Metrics</div>
                            <div style="font-size: 12px; color: #075985; line-height: 1.6; margin-bottom: 16px; white-space: pre-wrap;">${extractedSummary}</div>
                            
                            <details style="margin-bottom: 16px;">
                                <summary style="font-size: 12px; font-weight: 600; color: #0c4a6e; cursor: pointer; padding: 8px; background: #f0f9ff; border-radius: 6px;">View JSON Response</summary>
                                <pre style="margin-top: 8px; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; overflow-x: auto; max-height: 300px; overflow-y: auto; color: #334155; font-family: 'Courier New', monospace;">${extractedJSON}</pre>
                            </details>
                            
                            <div style="display: flex; gap: 8px;">
                                <button id="applyExtractedBtn" style="padding: 8px 16px; font-size: 13px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Apply These Values</button>
                                <button onclick="document.getElementById('forecastParseResult').style.display='none'" style="padding: 8px 16px; font-size: 13px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>
                    `;
                    // Attach event listener with extracted data
                    const applyBtn = document.getElementById('applyExtractedBtn');
                    if (applyBtn) {
                        applyBtn.onclick = () => {
                            this.applyExtractedMetrics(extracted);
                        };
                    }
                } catch (error) {
                    resultEl.innerHTML = `<div style="padding: 12px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca; color: #991b1b; font-size: 13px;">Error parsing: ${error.message}</div>`;
                }
            },
            
            async extractForecastMetricsWithAI(text) {
                // The actual extraction happens on the backend with improved prompt
                // Frontend just calls the API

                try {
                    const response = await fetch(`${API_URL}?action=parseForecast`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            context: this.conversationContext
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Handle both response formats: data.result.extracted or data.extracted
                        const extracted = data.result?.extracted || data.extracted;
                        if (data.ok && extracted) {
                            console.log('[Forecast] AI extraction successful:', extracted);
                            return extracted;
                        } else {
                            console.warn('[Forecast] AI extraction returned invalid response:', data);
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('[Forecast] API error:', response.status, errorText);
                    }
                    
                    // Fallback to regex-based extraction if API fails
                    console.warn('[Forecast] AI extraction failed, using regex fallback');
                    return this.extractForecastMetrics(text);
                } catch (error) {
                    console.error('[Forecast] AI extraction error:', error);
                    console.warn('[Forecast] Using regex fallback due to error');
                    return this.extractForecastMetrics(text);
                }
            },
            
            extractForecastMetrics(text) {
                const lower = text.toLowerCase();
                const extracted = {
                    dailyAdSpend: null,
                    services: [],
                    market: null,
                    techs: null,
                    jobsPerTechPerDay: null,
                    aov: null,
                    cpc: null,
                    leadToBookingRate: null,
                    bookingToCompletedRate: null,
                    cities: null,
                    creatives: null
                };
                
                // Extract daily ad spend (e.g., "$20/day", "20 dollars a day", "spending 20")
                const adSpendPatterns = [
                    /\$(\d+)\s*(?:per\s*day|\/day|a\s*day|daily)/i,
                    /spending\s*\$?(\d+)/i,
                    /ad\s*spend.*?\$?(\d+)/i,
                    /\$?(\d+)\s*(?:dollars?|bucks?)\s*(?:per\s*day|\/day|a\s*day|daily)/i
                ];
                for (const pattern of adSpendPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.dailyAdSpend = parseFloat(match[1]);
                        break;
                    }
                }
                
                // Extract services mentioned - dynamic approach (extract any service/product mentioned)
                // Look for common patterns: "for X", "doing X", "X services", "X jobs", etc.
                const servicePatterns = [
                    /(?:for|doing|offering|providing|selling)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:services?|jobs?|installations?|work)/gi,
                    /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:mounting|installation|service|repair|consulting)/gi,
                    /(?:services?|products?):\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*(?:\s*,\s*[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)*)/gi
                ];
                
                servicePatterns.forEach(pattern => {
                    const matches = [...text.matchAll(pattern)];
                    matches.forEach(match => {
                        const service = match[1].trim();
                        if (service && service.length > 2 && !extracted.services.includes(service)) {
                            extracted.services.push(service);
                        }
                    });
                });
                
                // Also check for comma-separated service lists
                const serviceListPattern = /(?:services?|products?|offerings?):\s*([^,]+(?:,\s*[^,]+)+)/i;
                const listMatch = text.match(serviceListPattern);
                if (listMatch) {
                    const services = listMatch[1].split(',').map(s => s.trim()).filter(s => s.length > 2);
                    services.forEach(service => {
                        if (!extracted.services.includes(service)) {
                            extracted.services.push(service);
                        }
                    });
                }
                
                // Extract market/location - improved to handle states properly
                // First try to match "City, State" or "City, ST" format
                const locationPatterns = [
                    // Full format: "in Greenville, South Carolina" or "Greenville, SC"
                    /(?:in|at|for)\s+([A-Z][a-zA-Z\s]+?),\s*([A-Z][a-zA-Z]+|[A-Z]{2})\b/gi,
                    // Direct mention: "Greenville, South Carolina" or "Greenville, SC"
                    /\b([A-Z][a-zA-Z\s]+?),\s*([A-Z][a-zA-Z]+|[A-Z]{2})\b/g
                ];
                
                let locationFound = false;
                for (const pattern of locationPatterns) {
                    const matches = [...text.matchAll(pattern)];
                    if (matches.length > 0) {
                        const city = matches[0][1].trim();
                        const state = matches[0][2].trim();
                        // Use previous context if we have it and city matches
                        if (this.conversationContext.location && city.toLowerCase().includes(this.conversationContext.location.split(',')[0].toLowerCase())) {
                            extracted.market = this.conversationContext.location;
                        } else {
                            extracted.market = `${city}, ${state}`;
                        }
                        locationFound = true;
                        break;
                    }
                }
                
                // If no full format found, look for city names and use context if available
                if (!locationFound) {
                    // Check if we have previous location context and the city name appears
                    if (this.conversationContext.location) {
                        const prevCity = this.conversationContext.location.split(',')[0].toLowerCase();
                        const cityPattern = new RegExp(`\\b${prevCity}\\b`, 'i');
                        if (cityPattern.test(text)) {
                            extracted.market = this.conversationContext.location;
                            locationFound = true;
                        }
                    }
                    
                    // Don't default to any specific location - only use what's explicitly mentioned or from context
                }
                
                // Extract number of techs
                const techPatterns = [
                    /(\d+)\s*(?:tech|technician|worker|installer)/i,
                    /(?:have|with|using)\s*(\d+)\s*(?:tech|technician)/i
                ];
                for (const pattern of techPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.techs = parseInt(match[1]);
                        break;
                    }
                }
                
                // Extract jobs per tech per day
                const jobsPatterns = [
                    /(\d+(?:\.\d+)?)\s*(?:jobs?|installations?)\s*(?:per\s*tech|per\s*technician|per\s*day)/i,
                    /(?:doing|handling|completing)\s*(\d+(?:\.\d+)?)\s*(?:jobs?|installations?)\s*(?:per\s*day)/i
                ];
                for (const pattern of jobsPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.jobsPerTechPerDay = parseFloat(match[1]);
                        break;
                    }
                }
                
                // Extract AOV (average order value)
                const aovPatterns = [
                    /(?:aov|average\s*order|order\s*value).*?\$?(\d+)/i,
                    /\$?(\d+)\s*(?:per\s*order|per\s*job|average)/i
                ];
                for (const pattern of aovPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const val = parseFloat(match[1]);
                        if (val > 50 && val < 5000) { // Reasonable range
                            extracted.aov = val;
                            break;
                        }
                    }
                }
                
                // Extract CPC/Cost per lead
                const cpcPatterns = [
                    /(?:cpc|cost\s*per\s*lead).*?\$?(\d+)/i,
                    /\$?(\d+)\s*(?:per\s*lead|per\s*click)/i
                ];
                for (const pattern of cpcPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.cpc = parseFloat(match[1]);
                        break;
                    }
                }
                
                // Extract conversion rates
                const leadToBookingPatterns = [
                    /(?:lead.*?booking|booking\s*rate).*?(\d+)%/i,
                    /(\d+)%\s*(?:lead.*?booking|conversion)/i
                ];
                for (const pattern of leadToBookingPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.leadToBookingRate = parseFloat(match[1]);
                        break;
                    }
                }
                
                // Extract number of creatives
                const creativePatterns = [
                    /(\d+)\s*(?:creative|ad|campaign)/i,
                    /(?:have|running|deploy).*?(\d+)\s*(?:creative|ad)/i
                ];
                for (const pattern of creativePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.creatives = parseInt(match[1]);
                        break;
                    }
                }
                
                // Extract cities
                const citiesPatterns = [
                    /(\d+)\s*(?:cities?|markets?|areas?)/i,
                    /(?:in|across)\s*(\d+)\s*(?:cities?|markets?)/i
                ];
                for (const pattern of citiesPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.cities = parseInt(match[1]);
                        break;
                    }
                }
                
                return extracted;
            },
            
            formatExtractedMetrics(extracted) {
                const found = [];
                const notFound = [];
                
                if (extracted.dailyAdSpend !== null && extracted.dailyAdSpend !== undefined) {
                    found.push(`✅ Daily Ad Spend: $${extracted.dailyAdSpend}/day`);
                } else {
                    notFound.push('Daily Ad Spend');
                }
                
                if (extracted.services && extracted.services.length > 0) {
                    found.push(`✅ Services: ${extracted.services.join(', ')}`);
                } else {
                    notFound.push('Services');
                }
                
                if (extracted.market) {
                    found.push(`✅ Market/Location: ${extracted.market}`);
                } else {
                    notFound.push('Market/Location');
                }
                
                if (extracted.techs !== null && extracted.techs !== undefined) {
                    found.push(`✅ Techs/Workers: ${extracted.techs}`);
                } else {
                    notFound.push('Techs/Workers');
                }
                
                if (extracted.jobsPerTechPerDay !== null && extracted.jobsPerTechPerDay !== undefined) {
                    found.push(`✅ Jobs per Tech/Day: ${extracted.jobsPerTechPerDay}`);
                } else {
                    notFound.push('Jobs per Tech/Day');
                }
                
                if (extracted.aov !== null && extracted.aov !== undefined) {
                    found.push(`✅ AOV (Avg Order Value): $${extracted.aov}`);
                } else {
                    notFound.push('AOV');
                }
                
                if (extracted.cpc !== null && extracted.cpc !== undefined) {
                    found.push(`✅ CPC (Cost per Lead): $${extracted.cpc}`);
                } else {
                    notFound.push('CPC');
                }
                
                if (extracted.leadToBookingRate !== null && extracted.leadToBookingRate !== undefined) {
                    found.push(`✅ Lead to Booking Rate: ${extracted.leadToBookingRate}%`);
                } else {
                    notFound.push('Lead to Booking Rate');
                }
                
                if (extracted.bookingToCompletedRate !== null && extracted.bookingToCompletedRate !== undefined) {
                    found.push(`✅ Booking to Completed Rate: ${extracted.bookingToCompletedRate}%`);
                } else {
                    notFound.push('Booking to Completed Rate');
                }
                
                if (extracted.cities !== null && extracted.cities !== undefined) {
                    found.push(`✅ Cities/Markets: ${extracted.cities}`);
                } else {
                    notFound.push('Cities');
                }
                
                if (extracted.creatives !== null && extracted.creatives !== undefined) {
                    found.push(`✅ Creatives/Ads: ${extracted.creatives}`);
                } else {
                    notFound.push('Creatives');
                }
                
                let output = '';
                if (found.length > 0) {
                    output += found.join('\n');
                }
                
                if (notFound.length > 0 && found.length > 0) {
                    output += `\n\n⚠️ Not found (will use current defaults):\n${notFound.map(m => `• ${m}`).join('\n')}`;
                } else if (notFound.length > 0) {
                    output = `No metrics extracted. Please be more specific. Mention:\n${notFound.map(m => `• ${m}`).join('\n')}`;
                }
                
                return output || 'No metrics could be extracted. Try being more specific.';
            },
            
            formatExtractedJSON(extracted) {
                // Create a clean JSON representation showing what was extracted vs defaults
                const json = {
                    extracted: {},
                    defaults: {},
                    willApply: {}
                };
                
                // Add extracted values (only non-null)
                if (extracted.dailyAdSpend !== null && extracted.dailyAdSpend !== undefined) {
                    json.extracted.dailyAdSpend = extracted.dailyAdSpend;
                }
                if (extracted.services && extracted.services.length > 0) {
                    json.extracted.services = extracted.services;
                }
                if (extracted.market) {
                    json.extracted.market = extracted.market;
                }
                if (extracted.techs !== null && extracted.techs !== undefined) {
                    json.extracted.techs = extracted.techs;
                }
                if (extracted.jobsPerTechPerDay !== null && extracted.jobsPerTechPerDay !== undefined) {
                    json.extracted.jobsPerTechPerDay = extracted.jobsPerTechPerDay;
                }
                if (extracted.aov !== null && extracted.aov !== undefined) {
                    json.extracted.aov = extracted.aov;
                }
                if (extracted.cpc !== null && extracted.cpc !== undefined) {
                    json.extracted.cpc = extracted.cpc;
                }
                if (extracted.leadToBookingRate !== null && extracted.leadToBookingRate !== undefined) {
                    json.extracted.leadToBookingRate = extracted.leadToBookingRate;
                }
                if (extracted.bookingToCompletedRate !== null && extracted.bookingToCompletedRate !== undefined) {
                    json.extracted.bookingToCompletedRate = extracted.bookingToCompletedRate;
                }
                if (extracted.cities !== null && extracted.cities !== undefined) {
                    json.extracted.cities = extracted.cities;
                }
                if (extracted.creatives !== null && extracted.creatives !== undefined) {
                    json.extracted.creatives = extracted.creatives;
                }
                
                // Add current defaults (what will be used if not extracted)
                json.defaults = { ...this.inputs };
                
                // Calculate what will actually be applied (extracted overrides defaults)
                json.willApply = { ...this.inputs };
                if (extracted.dailyAdSpend !== null && extracted.dailyAdSpend !== undefined && !isNaN(extracted.dailyAdSpend)) {
                    json.willApply.dailyAdSpend = parseFloat(extracted.dailyAdSpend);
                }
                if (extracted.techs !== null && extracted.techs !== undefined && !isNaN(extracted.techs)) {
                    json.willApply.techs = parseInt(extracted.techs);
                }
                if (extracted.jobsPerTechPerDay !== null && extracted.jobsPerTechPerDay !== undefined && !isNaN(extracted.jobsPerTechPerDay)) {
                    json.willApply.jobsPerTechPerDay = parseFloat(extracted.jobsPerTechPerDay);
                }
                if (extracted.aov !== null && extracted.aov !== undefined && !isNaN(extracted.aov) && extracted.aov > 0) {
                    json.willApply.aov = parseFloat(extracted.aov);
                }
                if (extracted.cpc !== null && extracted.cpc !== undefined && !isNaN(extracted.cpc) && extracted.cpc > 0) {
                    json.willApply.cpc = parseFloat(extracted.cpc);
                }
                if (extracted.leadToBookingRate !== null && extracted.leadToBookingRate !== undefined && !isNaN(extracted.leadToBookingRate)) {
                    json.willApply.leadToBookingRate = parseFloat(extracted.leadToBookingRate);
                }
                if (extracted.bookingToCompletedRate !== null && extracted.bookingToCompletedRate !== undefined && !isNaN(extracted.bookingToCompletedRate)) {
                    json.willApply.bookingToCompletedRate = parseFloat(extracted.bookingToCompletedRate);
                }
                if (extracted.cities !== null && extracted.cities !== undefined && !isNaN(extracted.cities) && extracted.cities > 0) {
                    json.willApply.cities = parseInt(extracted.cities);
                }
                
                return JSON.stringify(json, null, 2);
            },
            
            applyExtractedMetrics(extracted) {
                let appliedCount = 0;
                const appliedItems = [];
                
                // Only apply non-null, non-undefined values
                if (extracted.dailyAdSpend !== null && extracted.dailyAdSpend !== undefined && !isNaN(extracted.dailyAdSpend)) {
                    this.inputs.dailyAdSpend = parseFloat(extracted.dailyAdSpend);
                    appliedItems.push('Daily Ad Spend');
                    appliedCount++;
                }
                
                if (extracted.techs !== null && extracted.techs !== undefined && !isNaN(extracted.techs)) {
                    this.inputs.techs = parseInt(extracted.techs);
                    appliedItems.push('Techs');
                    appliedCount++;
                }
                
                if (extracted.jobsPerTechPerDay !== null && extracted.jobsPerTechPerDay !== undefined && !isNaN(extracted.jobsPerTechPerDay)) {
                    this.inputs.jobsPerTechPerDay = parseFloat(extracted.jobsPerTechPerDay);
                    appliedItems.push('Jobs per Tech/Day');
                    appliedCount++;
                }
                
                if (extracted.aov !== null && extracted.aov !== undefined && !isNaN(extracted.aov) && extracted.aov > 0) {
                    this.inputs.aov = parseFloat(extracted.aov);
                    appliedItems.push('AOV');
                    appliedCount++;
                }
                
                if (extracted.cpc !== null && extracted.cpc !== undefined && !isNaN(extracted.cpc) && extracted.cpc > 0) {
                    this.inputs.cpc = parseFloat(extracted.cpc);
                    appliedItems.push('CPC');
                    appliedCount++;
                }
                
                if (extracted.leadToBookingRate !== null && extracted.leadToBookingRate !== undefined && !isNaN(extracted.leadToBookingRate) && extracted.leadToBookingRate >= 0 && extracted.leadToBookingRate <= 100) {
                    this.inputs.leadToBookingRate = parseFloat(extracted.leadToBookingRate);
                    appliedItems.push('Lead to Booking Rate');
                    appliedCount++;
                }
                
                if (extracted.bookingToCompletedRate !== null && extracted.bookingToCompletedRate !== undefined && !isNaN(extracted.bookingToCompletedRate) && extracted.bookingToCompletedRate >= 0 && extracted.bookingToCompletedRate <= 100) {
                    this.inputs.bookingToCompletedRate = parseFloat(extracted.bookingToCompletedRate);
                    appliedItems.push('Booking to Completed Rate');
                    appliedCount++;
                }
                
                if (extracted.cities !== null && extracted.cities !== undefined && !isNaN(extracted.cities) && extracted.cities > 0) {
                    this.inputs.cities = parseInt(extracted.cities);
                    appliedItems.push('Cities');
                    appliedCount++;
                }
                
                if (extracted.creatives !== null && extracted.creatives !== undefined && !isNaN(extracted.creatives) && extracted.creatives > 0) {
                    this.inputs.creatives = parseInt(extracted.creatives);
                    appliedItems.push('Creatives');
                    appliedCount++;
                }
                
                // Store extracted metadata (market, services) even if not directly used in calculations
                if (extracted.market) {
                    this.inputs.market = extracted.market;
                    this.conversationContext.location = extracted.market; // Also update context
                    appliedItems.push('Market/Location');
                    appliedCount++;
                }
                
                if (extracted.services && Array.isArray(extracted.services) && extracted.services.length > 0) {
                    this.inputs.services = extracted.services;
                    appliedItems.push('Services');
                    appliedCount++;
                }
                
                // Save and re-render
                this.saveToStorage();
                this.render();
                this.recalculate();
                
                // Hide parse result
                document.getElementById('forecastParseResult').style.display = 'none';
                
                if (appliedCount > 0) {
                    showToast(`✅ Applied ${appliedCount} metric(s): ${appliedItems.join(', ')}`, 'success');
                } else {
                    showToast('⚠️ No valid metrics found to apply', 'error');
                }
            },
            
            estimateServiceAOV(services) {
                // GAP FIX #3: Service-specific AOV estimation
                const serviceAOVs = {
                    'TV Mount': 300, 'TV mounting': 300, 'TV': 300,
                    'Cameras': 800, 'Camera': 800, 'camera mounting': 800, 'Security': 800,
                    'Doorbell': 400, 'Ring': 400,
                    'WiFi': 300, 'Network': 300, 'Mesh': 350,
                    'Bundle': 1200, 'Package': 1200
                };
                
                if (!services || services.length === 0) return 300;
                
                const values = services
                    .map(s => {
                        const key = Object.keys(serviceAOVs).find(k => 
                            s.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(s.toLowerCase())
                        );
                        return serviceAOVs[key] || 300;
                    })
                    .filter(v => v);
                
                return values.length > 0 ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : 300;
            },
            
            // GAP FIX #6: What-If Scenario Modeling
            generateScenarios() {
                const i = this.inputs;
                const base = this.calculate();
                
                // Conservative scenario (-10% conversion rates, +10% costs)
                const conservative = {
                    leadToBookingRate: i.leadToBookingRate * 0.9,
                    bookingToCompletedRate: i.bookingToCompletedRate * 0.9,
                    cpc: i.cpc * 1.1,
                    aov: i.aov * 0.95
                };
                
                // Aggressive scenario (+15% conversion, -10% costs)
                const aggressive = {
                    leadToBookingRate: Math.min(100, i.leadToBookingRate * 1.15),
                    bookingToCompletedRate: Math.min(100, i.bookingToCompletedRate * 1.05),
                    cpc: i.cpc * 0.9,
                    aov: i.aov * 1.05
                };
                
                // Calculate each scenario
                const calcScenario = (mods) => {
                    const modInputs = { ...i, ...mods };
                    const dailyCapacity = modInputs.techs * modInputs.jobsPerTechPerDay * (modInputs.rampFactor / 100);
                    const monthlyCapacity = dailyCapacity * modInputs.workDaysPerMonth;
                    const completedJobs = monthlyCapacity;
                    const bookings = completedJobs / (modInputs.bookingToCompletedRate / 100);
                    const leads = bookings / (modInputs.leadToBookingRate / 100);
                    const monthlyAdSpend = modInputs.dailyAdSpend * 30;
                    const revenue = completedJobs * modInputs.aov;
                    const profit = revenue - (completedJobs * modInputs.aov * 0.35) - (completedJobs * modInputs.equipCostPerJob) - (completedJobs * modInputs.overheadPerJob) - monthlyAdSpend;
                    return { revenue, profit, margin: revenue > 0 ? (profit / revenue) * 100 : 0, leads };
                };
                
                return {
                    conservative: { ...calcScenario(conservative), label: 'Conservative (-10%)' },
                    base: { ...base, label: 'Base Case' },
                    aggressive: { ...calcScenario(aggressive), label: 'Aggressive (+15%)' }
                };
            },
            
            // GAP FIX #9: Industry Benchmark Comparison
            getIndustryBenchmarks() {
                return {
                    cpc: { avg: 18, good: 12, excellent: 8 },
                    leadToBookingRate: { avg: 25, good: 30, excellent: 35 },
                    bookingToCompletedRate: { avg: 80, good: 85, excellent: 90 },
                    netMargin: { avg: 10, good: 15, excellent: 20 },
                    adSpendPercent: { avg: 25, good: 20, excellent: 15 }
                };
            },
            
            // GAP FIX #8: Early Warning System
            generateEarlyWarnings(results) {
                const i = this.inputs;
                const warnings = [];
                const benchmarks = this.getIndustryBenchmarks();
                
                // Early warnings at 80% of thresholds
                if (i.leadToBookingRate < benchmarks.leadToBookingRate.avg * 0.8) {
                    warnings.push({ level: 'warning', message: `Booking rate (${i.leadToBookingRate}%) approaching threshold - optimize follow-up` });
                }
                
                if (i.bookingToCompletedRate < benchmarks.bookingToCompletedRate.avg * 0.8) {
                    warnings.push({ level: 'warning', message: `Show rate (${i.bookingToCompletedRate}%) approaching threshold - review booking process` });
                }
                
                if (results.netMargin < benchmarks.netMargin.avg * 0.8 && results.netMargin > 0) {
                    warnings.push({ level: 'warning', message: `Margin (${results.netMargin.toFixed(1)}%) below target - review costs` });
                }
                
                const adSpendPercent = results.monthlyRevenue > 0 ? (results.monthlyAdSpend / results.monthlyRevenue) * 100 : 0;
                if (adSpendPercent > benchmarks.adSpendPercent.avg * 0.8 && adSpendPercent < benchmarks.adSpendPercent.avg) {
                    warnings.push({ level: 'info', message: `Ad spend at ${adSpendPercent.toFixed(1)}% of revenue - monitor efficiency` });
                }
                
                // Capacity utilization warning
                const capacityUtil = (i.jobsPerTechPerDay / 5) * 100; // 5 jobs/day = 100% utilization
                if (capacityUtil < 50) {
                    warnings.push({ level: 'info', message: `Low capacity utilization (${capacityUtil.toFixed(0)}%) - consider adding jobs or reducing techs` });
                } else if (capacityUtil > 90) {
                    warnings.push({ level: 'warning', message: `High capacity utilization (${capacityUtil.toFixed(0)}%) - risk of burnout or delays` });
                }
                
                return warnings;
            },
            
            // GAP FIX #14: Extraction-Driven Intelligence
            detectBusinessStage(extractedText) {
                const lower = extractedText.toLowerCase();
                const indicators = {
                    early: ['first customers', 'getting started', 'just starting', 'looking to acquire', 'early stage', 'new'],
                    scaling: ['scale', 'growing', 'expanding', 'adding', 'increase', 'ramp up'],
                    established: ['current', 'existing', 'running', 'operating', 'active']
                };
                
                for (const [stage, keywords] of Object.entries(indicators)) {
                    if (keywords.some(kw => lower.includes(kw))) {
                        return stage;
                    }
                }
                return 'unknown';
            },
            
            // GAP FIX #11: Intelligent Default Ranges
            getDefaultRanges(field) {
                const ranges = {
                    cpc: { min: 10, max: 30, typical: '15-20', unit: '$' },
                    leadToBookingRate: { min: 15, max: 40, typical: '20-30', unit: '%' },
                    bookingToCompletedRate: { min: 70, max: 95, typical: '80-90', unit: '%' },
                    jobsPerTechPerDay: { min: 1, max: 6, typical: '2-4', unit: 'jobs' },
                    aov: { min: 200, max: 1500, typical: '300-800', unit: '$' },
                    netMargin: { min: 5, max: 25, typical: '10-15', unit: '%' }
                };
                return ranges[field] || null;
            },
            
            // Scenario Analysis
            runScenarioAnalysis(inputs) {
                const scenarios = {
                    conservative: { modifier: 0.8, label: 'Conservative' },
                    expected: { modifier: 1.0, label: 'Expected' },
                    optimistic: { modifier: 1.2, label: 'Optimistic' }
                };
                const results = {};
                
                Object.keys(scenarios).forEach(key => {
                    const mod = scenarios[key].modifier;
                    const i = { ...inputs };
                    
                    // Adjust key variables
                    i.leadToBookingRate = Math.min(100, i.leadToBookingRate * mod);
                    i.bookingToCompletedRate = Math.min(100, i.bookingToCompletedRate * mod);
                    i.dailyAdSpend = i.dailyAdSpend * mod;
                    
                    // Recalculate
                    const dailyCapacity = i.techs * i.jobsPerTechPerDay * (i.rampFactor / 100);
                    const monthlyCapacity = dailyCapacity * i.workDaysPerMonth;
                    const completedJobsNeeded = monthlyCapacity;
                    const bookingsNeeded = completedJobsNeeded / (i.bookingToCompletedRate / 100) / (1 - i.cancelRate / 100);
                    const leadsNeeded = bookingsNeeded / (i.leadToBookingRate / 100);
                    const monthlyAdSpend = i.dailyAdSpend * 30;
                    const cpl = i.cpc || (monthlyAdSpend / leadsNeeded);
                    const cac = cpl / (i.leadToBookingRate / 100);
                    const monthlyRevenue = completedJobsNeeded * i.aov;
                    const techPayoutTotal = completedJobsNeeded * (i.aov * i.techPayoutPct / 100);
                    const equipCostTotal = completedJobsNeeded * i.equipCostPerJob;
                    const overheadTotal = completedJobsNeeded * i.overheadPerJob;
                    const grossProfit = monthlyRevenue - techPayoutTotal - equipCostTotal;
                    const netProfit = grossProfit - overheadTotal - monthlyAdSpend;
                    const netMargin = monthlyRevenue > 0 ? (netProfit / monthlyRevenue) * 100 : 0;
                    
                    results[key] = {
                        label: scenarios[key].label,
                        monthlyRevenue: monthlyRevenue,
                        netProfit: netProfit,
                        netMargin: netMargin,
                        leadsNeeded: leadsNeeded,
                        monthlyAdSpend: monthlyAdSpend
                    };
                });
                
                return results;
            },
            
            // GAP FIX #8: Early Warning System
            generateEarlyWarnings(inputs, results) {
                const warnings = [];
                
                // Ad spend approaching 30% threshold
                if (results.monthlyRevenue > 0) {
                    const adSpendPct = (results.monthlyAdSpend / results.monthlyRevenue) * 100;
                    if (adSpendPct >= 24 && adSpendPct < 30) {
                        warnings.push({
                            type: 'warning',
                            message: `Ad spend at ${adSpendPct.toFixed(1)}% of revenue - approaching 30% threshold`,
                            suggestion: 'Optimize CPC or improve conversion rates to reduce ad spend ratio'
                        });
                    }
                }
                
                // Margin approaching 10% target
                if (results.netMargin >= 8 && results.netMargin < 10) {
                    warnings.push({
                        type: 'warning',
                        message: `Net margin at ${results.netMargin.toFixed(1)}% - close to 10% target`,
                        suggestion: `Increase margin by ${(10 - results.netMargin).toFixed(1)}% to hit target`
                    });
                }
                
                // Conversion rates approaching thresholds
                if (results.leadToBookingRate >= 18 && results.leadToBookingRate < 20) {
                    warnings.push({
                        type: 'warning',
                        message: `Lead-to-booking rate at ${results.leadToBookingRate}% - approaching 20% threshold`,
                        suggestion: 'Optimize follow-up process or improve offer clarity'
                    });
                }
                
                if (results.bookingToCompletedRate >= 76 && results.bookingToCompletedRate < 80) {
                    warnings.push({
                        type: 'warning',
                        message: `Show rate at ${results.bookingToCompletedRate}% - approaching 80% threshold`,
                        suggestion: 'Add booking confirmations or reduce booking window'
                    });
                }
                
                // CAC approaching break-even
                if (results.cac > 0 && results.breakEvenCAC > 0) {
                    const ratio = results.cac / results.breakEvenCAC;
                    if (ratio >= 0.9 && ratio < 1.0) {
                        warnings.push({
                            type: 'warning',
                            message: `CAC at ${(ratio * 100).toFixed(0)}% of break-even - optimize soon`,
                            suggestion: `Reduce CPC by $${((results.cac - results.breakEvenCAC) * 0.8).toFixed(2)} to get below break-even`
                        });
                    }
                }
                
                return warnings;
            },
            
            // GAP FIX #9: Industry Benchmark Comparison
            compareToBenchmarks(inputs, metrics) {
                // Industry benchmarks for service businesses
                const benchmarks = {
                    cpc: { avg: 18, good: 12, excellent: 8 },
                    leadToBookingRate: { avg: 25, good: 30, excellent: 35 },
                    bookingToCompletedRate: { avg: 82, good: 85, excellent: 90 },
                    netMargin: { avg: 12, good: 15, excellent: 20 }
                };
                
                const comparisons = {};
                
                // Compare CPC
                if (metrics.cpc) {
                    const avg = benchmarks.cpc.avg;
                    comparisons.cpc = {
                        value: metrics.cpc,
                        benchmark: avg,
                        status: metrics.cpc <= benchmarks.cpc.excellent ? 'excellent' :
                               metrics.cpc <= benchmarks.cpc.good ? 'good' :
                               metrics.cpc <= avg ? 'average' : 'below',
                        message: metrics.cpc <= avg ? 
                            `✅ ${avg - metrics.cpc}% below industry average` :
                            `⚠️ ${((metrics.cpc - avg) / avg * 100).toFixed(0)}% above industry average`
                    };
                }
                
                // Compare conversion rates
                if (metrics.leadToBookingRate) {
                    const avg = benchmarks.leadToBookingRate.avg;
                    comparisons.leadToBookingRate = {
                        value: metrics.leadToBookingRate,
                        benchmark: avg,
                        status: metrics.leadToBookingRate >= benchmarks.leadToBookingRate.excellent ? 'excellent' :
                               metrics.leadToBookingRate >= benchmarks.leadToBookingRate.good ? 'good' :
                               metrics.leadToBookingRate >= avg ? 'average' : 'below',
                        message: metrics.leadToBookingRate >= avg ?
                            `✅ ${((metrics.leadToBookingRate - avg) / avg * 100).toFixed(0)}% above industry average` :
                            `⚠️ ${(avg - metrics.leadToBookingRate).toFixed(0)}% below industry average`
                    };
                }
                
                if (metrics.bookingToCompletedRate) {
                    const avg = benchmarks.bookingToCompletedRate.avg;
                    comparisons.bookingToCompletedRate = {
                        value: metrics.bookingToCompletedRate,
                        benchmark: avg,
                        status: metrics.bookingToCompletedRate >= benchmarks.bookingToCompletedRate.excellent ? 'excellent' :
                               metrics.bookingToCompletedRate >= benchmarks.bookingToCompletedRate.good ? 'good' :
                               metrics.bookingToCompletedRate >= avg ? 'average' : 'below',
                        message: metrics.bookingToCompletedRate >= avg ?
                            `✅ ${((metrics.bookingToCompletedRate - avg) / avg * 100).toFixed(0)}% above industry average` :
                            `⚠️ ${(avg - metrics.bookingToCompletedRate).toFixed(0)}% below industry average`
                    };
                }
                
                // Compare margin
                if (metrics.netMargin !== undefined) {
                    const avg = benchmarks.netMargin.avg;
                    comparisons.netMargin = {
                        value: metrics.netMargin,
                        benchmark: avg,
                        status: metrics.netMargin >= benchmarks.netMargin.excellent ? 'excellent' :
                               metrics.netMargin >= benchmarks.netMargin.good ? 'good' :
                               metrics.netMargin >= avg ? 'average' : 'below',
                        message: metrics.netMargin >= avg ?
                            `✅ ${((metrics.netMargin - avg) / avg * 100).toFixed(0)}% above industry average` :
                            `⚠️ ${(avg - metrics.netMargin).toFixed(1)}% below industry average`
                    };
                }
                
                return comparisons;
            },
            
            // GAP FIX #14: Analyze business stage from extracted text
            analyzeBusinessStage(text, extracted) {
                const lower = text.toLowerCase();
                const context = { stage: null, adjustments: {} };
                
                // Detect early stage indicators
                if (lower.includes('first customers') || 
                    lower.includes('getting started') || 
                    lower.includes('just starting') ||
                    lower.includes('acquiring first') ||
                    lower.includes('launching')) {
                    context.stage = 'early';
                    context.adjustments = {
                        leadToBookingRate: null, // Early stage = no data yet
                        bookingToCompletedRate: null,
                        note: 'Early stage business - rates unknown, use industry benchmarks'
                    };
                }
                
                // Detect scaling/growth stage
                if (lower.includes('scaling') || 
                    lower.includes('growing') || 
                    lower.includes('expanding') ||
                    lower.includes('ramping up')) {
                    context.stage = 'scaling';
                    context.adjustments = {
                        rampFactor: 85, // Lower utilization during growth
                        note: 'Scaling phase - capacity may be partially utilized'
                    };
                }
                
                // Detect mature/optimized stage
                if (lower.includes('optimized') || 
                    lower.includes('established') || 
                    lower.includes('mature') ||
                    lower.includes('efficient')) {
                    context.stage = 'mature';
                    context.adjustments = {
                        rampFactor: 95, // Higher utilization
                        note: 'Mature operation - higher capacity utilization expected'
                    };
                }
                
                return context;
            },
            
            // GAP FIX #14: Apply stage-specific defaults
            applyStageDefaults(stage, extracted) {
                if (stage === 'early') {
                    // For early stage, don't override rates if null (they're unknown)
                    // But set realistic industry defaults if they weren't extracted
                    if (!extracted.leadToBookingRate) {
                        this.inputs.leadToBookingRate = 20; // Conservative for early stage
                    }
                    if (!extracted.bookingToCompletedRate) {
                        this.inputs.bookingToCompletedRate = 75; // Lower for early stage
                    }
                } else if (stage === 'scaling') {
                    if (this.inputs.rampFactor > 90) {
                        this.inputs.rampFactor = 85; // Account for growth inefficiency
                    }
                }
            },
            
            // GAP FIX #11: Intelligent Default Ranges
            getInputRange(field, currentValue) {
                const ranges = {
                    jobsPerTechPerDay: { typical: '2-4', excellent: '4-5', note: 'Typical: 2-4 jobs/day, Excellent: 4-5 jobs/day' },
                    leadToBookingRate: { typical: '20-30%', excellent: '30-35%', note: 'Industry average: 25%, Good: 30%+' },
                    bookingToCompletedRate: { typical: '80-85%', excellent: '85-90%', note: 'Industry average: 82%, Good: 85%+' },
                    cpc: { typical: '$12-20', excellent: '$8-12', note: 'Industry average: $18, Good: <$12' },
                    netMargin: { typical: '10-15%', excellent: '15-20%', note: 'Industry average: 12%, Good: 15%+' },
                    dailyAdSpend: { typical: '$20-50', excellent: '$50-100+', note: 'Growth range: $20-100/day' }
                };
                
                if (ranges[field]) {
                    const range = ranges[field];
                    let status = '';
                    if (field === 'jobsPerTechPerDay') {
                        if (currentValue >= 4) status = ' ✅ Excellent';
                        else if (currentValue >= 2) status = ' ✓ Typical';
                        else status = ' ⚠️ Below typical';
                    } else if (field.includes('Rate') || field === 'netMargin') {
                        const match = range.typical.match(/(\d+)-(\d+)/);
                        if (match && currentValue >= parseFloat(match[1]) && currentValue <= parseFloat(match[2])) {
                            status = ' ✓ In typical range';
                        } else if (currentValue < parseFloat(match[1])) {
                            status = ' ⚠️ Below typical';
                        }
                    }
                    return range.note + status;
                }
                return '';
            },
            
            updateInput(key, value) {
                const numValue = parseFloat(value) || 0;
                if (key in this.inputs) {
                    this.inputs[key] = numValue;
                    this.saveToStorage();
                }
            },
            
            calculate() {
                const i = this.inputs;
                
                // Capacity calculations
                const dailyCapacity = i.techs * i.jobsPerTechPerDay * (i.rampFactor / 100);
                const monthlyCapacity = dailyCapacity * i.workDaysPerMonth;
                
                // Funnel calculations
                const completedJobsNeeded = monthlyCapacity; // Use capacity as target
                const bookingsNeeded = completedJobsNeeded / (i.bookingToCompletedRate / 100) / (1 - i.cancelRate / 100);
                const leadsNeeded = bookingsNeeded / (i.leadToBookingRate / 100);
                
                // Cost calculations
                const monthlyAdSpend = i.dailyAdSpend * 30;
                const cpl = i.cpc || (monthlyAdSpend / leadsNeeded);
                const cac = cpl / (i.leadToBookingRate / 100);
                
                // Revenue calculations
                const monthlyRevenue = completedJobsNeeded * i.aov;
                const techPayoutTotal = completedJobsNeeded * (i.aov * i.techPayoutPct / 100);
                const equipCostTotal = completedJobsNeeded * i.equipCostPerJob;
                const overheadTotal = completedJobsNeeded * i.overheadPerJob;
                const grossProfit = monthlyRevenue - techPayoutTotal - equipCostTotal;
                const netProfit = grossProfit - overheadTotal - monthlyAdSpend;
                const grossMarginActual = monthlyRevenue > 0 ? (grossProfit / monthlyRevenue) * 100 : 0;
                const netMargin = monthlyRevenue > 0 ? (netProfit / monthlyRevenue) * 100 : 0;
                
                // Daily/Weekly breakdowns
                const dailyRevenue = monthlyRevenue / 30;
                const weeklyRevenue = monthlyRevenue / 4.33;
                const dailyProfit = netProfit / 30;
                const weeklyProfit = netProfit / 4.33;
                
                // Required jobs per day/tech
                const requiredJobsPerDay = completedJobsNeeded / i.workDaysPerMonth;
                const requiredJobsPerTech = requiredJobsPerDay / i.techs;
                
                // Break-even CAC
                const breakEvenCAC = (grossProfit - overheadTotal) / leadsNeeded;
                
                // What has to be true constraints
                const constraints = [];
                const recommendations = []; // GAP FIX #2: Dynamic recommendations
                
                if (requiredJobsPerTech > i.jobsPerTechPerDay) {
                    constraints.push(`Need ${requiredJobsPerTech.toFixed(1)} jobs/tech/day (currently ${i.jobsPerTechPerDay})`);
                    // GAP FIX: Add recommendation
                    const additionalJobs = requiredJobsPerTech - i.jobsPerTechPerDay;
                    recommendations.push(`Increase capacity: Add ${additionalJobs.toFixed(1)} jobs/tech/day OR add ${Math.ceil((requiredJobsPerTech / i.jobsPerTechPerDay) - 1)} more techs`);
                }
                
                if (cac > breakEvenCAC) {
                    constraints.push(`CAC ($${cac.toFixed(2)}) exceeds break-even ($${breakEvenCAC.toFixed(2)})`);
                    // GAP FIX: Calculate target CPC
                    const maxCPC = breakEvenCAC * (i.leadToBookingRate / 100);
                    recommendations.push(`Reduce CPC to $${maxCPC.toFixed(2)} or improve booking rate to ${Math.ceil((i.cpc / breakEvenCAC) * 100)}%`);
                }
                
                if (i.leadToBookingRate < 20) {
                    constraints.push(`Lead-to-booking rate (${i.leadToBookingRate}%) is below 20% threshold`);
                    recommendations.push(`Improve booking rate by ${(20 - i.leadToBookingRate).toFixed(1)}%: Review follow-up process, offer clarity, or scheduling ease`);
                }
                
                if (i.bookingToCompletedRate < 80) {
                    constraints.push(`Booking-to-completed rate (${i.bookingToCompletedRate}%) is below 80% threshold`);
                    recommendations.push(`Improve show rate by ${(80 - i.bookingToCompletedRate).toFixed(1)}%: Add reminders, confirmations, or reduce booking window`);
                }
                
                if (netMargin < 10) {
                    constraints.push(`Net margin (${netMargin.toFixed(1)}%) is below 10% target`);
                    // GAP FIX: Calculate what needs to change
                    const targetProfit = monthlyRevenue * 0.1;
                    const currentProfit = netProfit;
                    const gap = targetProfit - currentProfit;
                    if (gap > 0) {
                        const reduceBy = (gap / monthlyRevenue) * 100;
                        recommendations.push(`Increase margin by ${reduceBy.toFixed(1)}%: Reduce costs by $${Math.ceil(gap)}/month OR increase AOV by $${Math.ceil(gap / completedJobsNeeded)}`);
                    }
                }
                
                if (monthlyAdSpend > monthlyRevenue * 0.3) {
                    constraints.push(`Ad spend (${(monthlyAdSpend / monthlyRevenue * 100).toFixed(1)}% of revenue) exceeds 30% threshold`);
                    const targetSpend = monthlyRevenue * 0.3;
                    recommendations.push(`Reduce ad spend to $${Math.ceil(targetSpend)}/month OR improve efficiency: CPC reduction of ${((monthlyAdSpend - targetSpend) / leadsNeeded).toFixed(2)} would work`);
                }
                
                // GAP FIX #5: Input validation intelligence
                if (i.techs === 0 && i.jobsPerTechPerDay > 0) {
                    constraints.push(`⚠️ Invalid: Techs = 0 but jobs/tech/day > 0`);
                }
                
                if (monthlyAdSpend > monthlyRevenue && monthlyRevenue > 0) {
                    constraints.push(`⚠️ Warning: Ad spend ($${monthlyAdSpend.toFixed(0)}) exceeds revenue ($${monthlyRevenue.toFixed(0)})`);
                }
                
                if (i.dailyAdSpend > 0 && leadsNeeded === 0) {
                    constraints.push(`⚠️ Warning: Ad spend set but no leads needed (check capacity)`);
                }
                
                // GAP FIX #8: Early warnings (proactive alerts)
                const earlyWarnings = this.generateEarlyWarnings({
                    netMargin,
                    monthlyAdSpend,
                    monthlyRevenue
                });
                
                // GAP FIX #13: Auto-Optimization Engine - Rank suggestions by ROI impact
                if (recommendations.length > 1) {
                    // Calculate impact score for each recommendation
                    const optimizedRecs = recommendations.map(rec => {
                        let impactScore = 1; // Default
                        
                        // Revenue impact
                        if (rec.includes('Reduce costs') || rec.includes('increase AOV')) {
                            const costMatch = rec.match(/\$(\d+)/);
                            if (costMatch) impactScore = parseFloat(costMatch[1]) / 100; // Higher impact = higher score
                        }
                        
                        // Conversion impact
                        if (rec.includes('Improve booking rate') || rec.includes('Improve show rate')) {
                            const rateMatch = rec.match(/(\d+(?:\.\d+)?)%/);
                            if (rateMatch) impactScore = parseFloat(rateMatch[1]) / 10;
                        }
                        
                        // Capacity impact
                        if (rec.includes('Add') && rec.includes('techs')) {
                            impactScore = 3; // High impact
                        }
                        
                        return { text: rec, impact: impactScore };
                    }).sort((a, b) => b.impact - a.impact);
                    
                    // Update recommendations with ranked list (top 3)
                    recommendations.length = 0;
                    recommendations.push(...optimizedRecs.slice(0, 5).map(r => r.text));
                }
                
                if (constraints.length === 0) {
                    constraints.push('All constraints met ✓');
                }
                
                // GAP FIX #6: Generate What-If Scenarios (Conservative, Base, Aggressive)
                const scenarios = this.generateScenarios(i, {
                    dailyCapacity,
                    monthlyCapacity,
                    completedJobsNeeded,
                    bookingsNeeded,
                    leadsNeeded,
                    monthlyAdSpend,
                    cpl,
                    cac,
                    breakEvenCAC,
                    monthlyRevenue,
                    grossProfit,
                    netProfit,
                    grossMarginActual,
                    netMargin
                });
                
                // GAP FIX #8: Early Warning System (proactive alerts)
                const warnings = this.generateEarlyWarnings(i, {
                    monthlyAdSpend,
                    monthlyRevenue,
                    netMargin,
                    cac,
                    breakEvenCAC,
                    leadToBookingRate: i.leadToBookingRate,
                    bookingToCompletedRate: i.bookingToCompletedRate
                });
                
                // GAP FIX #9: Industry Benchmark Comparison
                const benchmarks = this.compareToBenchmarks(i, {
                    cpc: i.cpc,
                    leadToBookingRate: i.leadToBookingRate,
                    bookingToCompletedRate: i.bookingToCompletedRate,
                    netMargin
                });
                
                return {
                    dailyCapacity,
                    monthlyCapacity,
                    completedJobsNeeded,
                    bookingsNeeded,
                    leadsNeeded,
                    monthlyAdSpend,
                    cpl,
                    cac,
                    breakEvenCAC,
                    monthlyRevenue,
                    dailyRevenue,
                    weeklyRevenue,
                    grossProfit,
                    netProfit,
                    dailyProfit,
                    weeklyProfit,
                    grossMarginActual,
                    netMargin,
                    techPayoutTotal,
                    equipCostTotal,
                    overheadTotal,
                    requiredJobsPerDay,
                    requiredJobsPerTech,
                    constraints,
                    recommendations, // GAP FIX #2: Add recommendations to results
                    scenarios, // GAP FIX #6: What-if scenarios
                    warnings, // GAP FIX #8: Early warnings
                    benchmarks // GAP FIX #9: Industry benchmarks
                };
            },
            
            recalculate() {
                const results = this.calculate();
                const outputsEl = document.getElementById('forecastOutputs');
                const chartsEl = document.getElementById('forecastCharts');
                
                if (outputsEl) {
                    outputsEl.outerHTML = this.renderOutputs(results);
                }
                if (chartsEl) {
                    chartsEl.outerHTML = this.renderCharts(results);
                }
                
                // GAP FIX #7: Auto-save forecast for tracking (debounced)
                clearTimeout(this.saveTimer);
                this.saveTimer = setTimeout(() => {
                    this.saveForecastScenario();
                }, 5000); // Save 5 seconds after last change
            },
            
            render() {
                const container = document.getElementById('adminForecastCalculator');
                if (!container) return;
                
                    container.innerHTML = `
                    <!-- Natural Language Input -->
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="font-size: 18px; font-weight: 700; color: #0c4a6e;">Describe Your Scenario</div>
                            <div style="flex: 1;"></div>
                            <button onclick="adminForecastCalculator.parseNaturalLanguage()" class="btn" style="padding: 8px 16px; font-size: 13px; background: #0ea5e9; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Parse & Apply
                            </button>
                        </div>
                        <textarea id="forecastNaturalLanguageInput" placeholder="Example: We're spending $20/day on ads, have 3 creatives running for TV mounting and camera mounting jobs in Dallas, TX. We have 2 techs available..." style="width: 100%; padding: 12px; border: 1px solid #bae6fd; border-radius: 8px; font-size: 14px; min-height: 80px; resize: vertical; font-family: inherit;" onkeydown="if(event.key==='Enter' && event.ctrlKey) adminForecastCalculator.parseNaturalLanguage()"></textarea>
                        <div style="font-size: 11px; color: #075985; margin-top: 8px;">💡 Tip: Describe your ad spend, services, location, and team size. Press Ctrl+Enter to parse.</div>
                        <div id="forecastParseResult" style="margin-top: 12px; display: none;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;" id="forecastMainGrid">
                        <!-- LEFT: Inputs -->
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            ${this.renderInputs()}
                        </div>
                        
                        <!-- RIGHT: Outputs + Charts -->
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            ${this.renderOutputs(this.calculate())}
                            ${this.renderCharts(this.calculate())}
                        </div>
                    </div>
                    <style>
                        @media (max-width: 768px) {
                            #forecastMainGrid {
                                grid-template-columns: 1fr !important;
                            }
                        }
                    </style>
                `;
                
                this.attachListeners();
            },
            
            renderInputs() {
                const i = this.inputs;
                return `
                    <!-- Markets / Scale -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">A) Markets / Scale</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${i.market ? `
                            <div style="background: #dbeafe; padding: 10px; border-radius: 6px; border: 1px solid #93c5fd;">
                                <div style="font-size: 11px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">📍 Market Location</div>
                                <div style="font-size: 13px; color: #1e3a8a; font-weight: 600;">${i.market}</div>
                                <div style="font-size: 10px; color: #3b82f6; margin-top: 4px;">Extracted from scenario</div>
                            </div>
                            ` : ''}
                            ${i.services && i.services.length > 0 ? `
                            <div style="background: #dbeafe; padding: 10px; border-radius: 6px; border: 1px solid #93c5fd;">
                                <div style="font-size: 11px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">🔧 Services</div>
                                <div style="font-size: 12px; color: #1e3a8a;">${i.services.join(', ')}</div>
                                <div style="font-size: 10px; color: #3b82f6; margin-top: 4px;">Extracted from scenario</div>
                            </div>
                            ` : ''}
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Cities Active</label>
                                <input type="number" data-forecast-input="cities" value="${i.cities}" min="1" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Techs Active</label>
                                <input type="number" data-forecast-input="techs" value="${i.techs}" min="1" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Jobs per Tech per Day</label>
                                <input type="number" data-forecast-input="jobsPerTechPerDay" value="${i.jobsPerTechPerDay}" min="0" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Work Days per Month</label>
                                <input type="number" data-forecast-input="workDaysPerMonth" value="${i.workDaysPerMonth}" min="1" max="31" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Ramp Factor (%)</label>
                                <input type="number" data-forecast-input="rampFactor" value="${i.rampFactor}" min="0" max="100" step="5" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Partial utilization factor</div>
                            </div>
                        </div>
                    </div>

                    <!-- Offer Economics -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">B) Offer Economics</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Offer Preset</label>
                                <select id="forecastOfferPreset" onchange="adminForecastCalculator.applyOfferPreset(this.value)" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                    <option value="">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Avg Order Value (AOV)</label>
                                <input type="number" data-forecast-input="aov" value="${i.aov}" min="0" step="10" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                    ${i.services && i.services.length > 0 ? 
                                        `Based on ${i.services.join(', ')}: Typical range $${this.estimateServiceAOV(i.services)}-${this.estimateServiceAOV(i.services) + 100}` :
                                        'Auto-calculated from saved offers or performance data. Adjust as needed.'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Gross Margin (%)</label>
                                <input type="number" data-forecast-input="grossMargin" value="${i.grossMargin}" min="0" max="100" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Default: 40%</div>
                            </div>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border: 1px solid #fde68a;">
                                <div style="font-size: 12px; color: #92400e; font-weight: 600;">Tech Payout</div>
                                <div style="font-size: 11px; color: #a16207; margin-top: 2px;">Fixed at 35% of original base price (not discounted)</div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Equipment Cost per Job</label>
                                <input type="number" data-forecast-input="equipCostPerJob" value="${i.equipCostPerJob}" min="0" step="5" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Overhead per Job</label>
                                <input type="number" data-forecast-input="overheadPerJob" value="${i.overheadPerJob}" min="0" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                        </div>
                    </div>

                    <!-- Ads + Funnel -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">C) Ads + Funnel (Meta)</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Daily Ad Spend</label>
                                <input type="number" data-forecast-input="dailyAdSpend" value="${i.dailyAdSpend}" min="0" step="5" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${this.getInputRange('dailyAdSpend', i.dailyAdSpend) || 'Current baseline: $20/day. Target scale: $100/day. Adjust to match your actual spend.'}</div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">CPC / Cost per Lead</label>
                                <input type="number" data-forecast-input="cpc" value="${i.cpc}" min="0" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                    ${i.market ? `Typical CPC for ${i.market}: $10-$25 (service industry)` : 'Industry average: $15-$20 per lead'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Lead to Booking Rate (%)</label>
                                <input type="number" data-forecast-input="leadToBookingRate" value="${i.leadToBookingRate}" min="0" max="100" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: ${i.leadToBookingRate < 20 ? '#dc2626' : '#6b7280'}; margin-top: 4px;">
                                    ${i.leadToBookingRate < 20 ? '⚠️ Below 20% threshold - optimize follow-up process' : 'Industry benchmark: 20-30%'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Booking to Completed Rate (%)</label>
                                <input type="number" data-forecast-input="bookingToCompletedRate" value="${i.bookingToCompletedRate}" min="0" max="100" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: ${i.bookingToCompletedRate < 80 ? '#dc2626' : '#6b7280'}; margin-top: 4px;">
                                    ${i.bookingToCompletedRate < 80 ? '⚠️ Below 80% threshold - improve show rate' : 'Industry benchmark: 80-90%'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Cancel/Refund Rate (%)</label>
                                <input type="number" data-forecast-input="cancelRate" value="${i.cancelRate}" min="0" max="100" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                        </div>
                    </div>
                `;
            },
            
            renderOutputs(results) {
                const r = results;
                return `
                    <div id="forecastOutputs" style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">Outputs</h4>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <!-- Revenue Breakdown -->
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Revenue</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Daily</div>
                                        <div style="font-size: 16px; font-weight: 700; color: var(--cobalt);">$${r.dailyRevenue.toFixed(0)}</div>
                                </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Weekly</div>
                                        <div style="font-size: 16px; font-weight: 700; color: var(--cobalt);">$${r.weeklyRevenue.toFixed(0)}</div>
                                </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Monthly</div>
                                        <div style="font-size: 18px; font-weight: 900; color: var(--cobalt);">$${r.monthlyRevenue.toFixed(0)}</div>
                            </div>
                                    </div>
                                    </div>
                            
                            <!-- Profit Breakdown -->
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Profit</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Daily</div>
                                        <div style="font-size: 16px; font-weight: 700; color: ${r.dailyProfit >= 0 ? '#10b981' : '#ef4444'};">$${r.dailyProfit.toFixed(0)}</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Weekly</div>
                                        <div style="font-size: 16px; font-weight: 700; color: ${r.weeklyProfit >= 0 ? '#10b981' : '#ef4444'};">$${r.weeklyProfit.toFixed(0)}</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Monthly</div>
                                        <div style="font-size: 18px; font-weight: 900; color: ${r.netProfit >= 0 ? '#10b981' : '#ef4444'};">$${r.netProfit.toFixed(0)}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Key Metrics</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Gross Profit:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">$${r.grossProfit.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Net Profit:</span>
                                        <span style="font-weight: 600; color: ${r.netProfit >= 0 ? '#10b981' : '#ef4444'};">$${r.netProfit.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Gross Margin:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.grossMarginActual.toFixed(1)}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Net Margin:</span>
                                        <span style="font-weight: 600; color: ${r.netMargin >= 0 ? '#10b981' : '#ef4444'};">${r.netMargin.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Funnel Requirements -->
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Funnel Requirements</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Leads Needed:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.leadsNeeded.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Bookings Needed:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.bookingsNeeded.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Completed Jobs:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.completedJobsNeeded.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Jobs/Day Required:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.requiredJobsPerDay.toFixed(1)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Jobs/Tech/Day Required:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.requiredJobsPerTech.toFixed(1)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CAC / Break-even -->
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">CAC Analysis</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Current CPL:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">$${r.cpl.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Current CAC:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">$${r.cac.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Break-even CAC:</span>
                                        <span style="font-weight: 600; color: ${r.cac <= r.breakEvenCAC ? '#10b981' : '#ef4444'};">$${r.breakEvenCAC.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- What Has to Be True -->
                            <div style="background: ${r.constraints.some(c => !c.includes('✓')) ? '#fef2f2' : '#d1fae5'}; padding: 12px; border-radius: 6px; border: 1px solid ${r.constraints.some(c => !c.includes('✓')) ? '#fecaca' : '#a7f3d0'};">
                                <div style="font-size: 13px; font-weight: 600; color: ${r.constraints.some(c => !c.includes('✓')) ? '#991b1b' : '#065f46'}; margin-bottom: 8px;">What Has to Be True</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: ${r.constraints.some(c => !c.includes('✓')) ? '#991b1b' : '#065f46'}; line-height: 1.6;">
                                    ${r.constraints.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                                </div>
                            </div>
                            
                            ${r.recommendations && r.recommendations.length > 0 ? `
                            <!-- GAP FIX #2: Dynamic Recommendations -->
                            <div style="background: #eff6ff; padding: 12px; border-radius: 6px; border: 1px solid #93c5fd;">
                                <div style="font-size: 13px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">💡 Recommendations</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #1e3a8a; line-height: 1.6;">
                                    ${r.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    `;
            },
            
            renderCharts(results) {
                const r = results;
                return `
                    <div id="forecastCharts" style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Chart 1: Monthly Revenue vs Profit -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                            <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">Monthly Revenue vs Profit</h4>
                            <div style="display: flex; align-items: flex-end; gap: 8px; height: 200px;">
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                                    <div style="width: 100%; background: var(--cobalt); height: ${Math.max(10, (r.monthlyRevenue / Math.max(r.monthlyRevenue, Math.abs(r.netProfit)) * 180))}px; border-radius: 4px 4px 0 0; margin-bottom: 4px;"></div>
                                    <div style="font-size: 11px; color: #6b7280; font-weight: 600;">Revenue</div>
                                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">$${(r.monthlyRevenue / 1000).toFixed(0)}k</div>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                                    <div style="width: 100%; background: ${r.netProfit >= 0 ? '#10b981' : '#ef4444'}; height: ${Math.max(10, (Math.abs(r.netProfit) / Math.max(r.monthlyRevenue, Math.abs(r.netProfit)) * 180))}px; border-radius: 4px 4px 0 0; margin-bottom: 4px;"></div>
                                    <div style="font-size: 11px; color: #6b7280; font-weight: 600;">Profit</div>
                                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">$${(r.netProfit / 1000).toFixed(0)}k</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart 2: Sensitivity (CPL impact) -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                            <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">Sensitivity: CPL Impact on Profit</h4>
                            <div style="display: flex; align-items: flex-end; gap: 4px; height: 150px;">
                                ${[5, 10, 15, 20, 25, 30].map(cpl => {
                                    const testCAC = cpl / (this.inputs.leadToBookingRate / 100);
                                    const testAdSpend = r.leadsNeeded * cpl;
                                    const testProfit = r.grossProfit - r.overheadTotal - testAdSpend;
                                    const height = Math.max(5, (testProfit / Math.max(Math.abs(r.netProfit), 10000) * 140));
                                    return `
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                                            <div style="width: 100%; background: ${testProfit >= 0 ? '#10b981' : '#ef4444'}; height: ${height}px; border-radius: 2px 2px 0 0; margin-bottom: 4px;"></div>
                                            <div style="font-size: 9px; color: #6b7280; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);">$${cpl}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 8px;">CPL ($)</div>
                        </div>
                        
                        <!-- Chart 3: Capacity vs Required -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                            <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">Capacity vs Required Jobs</h4>
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="flex: 1; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${r.monthlyCapacity.toFixed(0)}</div>
                                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Available Capacity</div>
                                    </div>
                                    <div style="width: 2px; height: 40px; background: #e5e7eb; margin: 0 16px;"></div>
                                    <div style="flex: 1; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: ${r.completedJobsNeeded <= r.monthlyCapacity ? '#10b981' : '#ef4444'};">${r.completedJobsNeeded.toFixed(0)}</div>
                                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Required Jobs</div>
                                    </div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; margin-top: 12px;">
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Utilization</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; background: #f3f4f6; border-radius: 4px; height: 24px; overflow: hidden; position: relative;">
                                            <div style="background: ${r.completedJobsNeeded <= r.monthlyCapacity ? 'linear-gradient(90deg, #10b981, #059669)' : 'linear-gradient(90deg, #ef4444, #dc2626)'}; height: 100%; width: ${Math.min(100, (r.completedJobsNeeded / Math.max(r.monthlyCapacity, 1)) * 100)}%; transition: width 0.3s ease; border-radius: 4px;"></div>
                                        </div>
                                        <div style="font-size: 13px; font-weight: 700; color: ${r.completedJobsNeeded <= r.monthlyCapacity ? '#10b981' : '#ef4444'}; min-width: 50px; text-align: right;">
                                            ${((r.completedJobsNeeded / Math.max(r.monthlyCapacity, 1)) * 100).toFixed(0)}%
                                        </div>
                                    </div>
                                    ${r.completedJobsNeeded > r.monthlyCapacity ? `
                                        <div style="font-size: 11px; color: #ef4444; margin-top: 8px; padding: 8px; background: #fef2f2; border-radius: 4px; border-left: 3px solid #ef4444;">
                                            <strong>Warning:</strong> Required jobs (${r.completedJobsNeeded.toFixed(0)}) exceed available capacity (${r.monthlyCapacity.toFixed(0)}). Consider adding techs or increasing jobs per tech.
                                        </div>
                                    ` : r.completedJobsNeeded < r.monthlyCapacity * 0.5 ? `
                                        <div style="font-size: 11px; color: #f59e0b; margin-top: 8px; padding: 8px; background: #fffbeb; border-radius: 4px; border-left: 3px solid #f59e0b;">
                                            <strong>Note:</strong> Capacity utilization is low. You have room to scale up.
                                        </div>
                                    ` : `
                                        <div style="font-size: 11px; color: #10b981; margin-top: 8px; padding: 8px; background: #d1fae5; border-radius: 4px; border-left: 3px solid #10b981;">
                                            <strong>Good:</strong> Capacity and requirements are well-balanced.
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Assumptions Panel -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px;">
                            <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Key Assumptions</h4>
                            <div style="display: flex; flex-direction: column; gap: 6px; font-size: 11px; color: #6b7280; line-height: 1.5;">
                                <div>• Revenue = Completed Jobs × AOV</div>
                                <div>• Tech Payout = 35% of AOV (original price)</div>
                                <div>• Gross Profit = Revenue - Tech Payout - Equipment</div>
                                <div>• Net Profit = Gross Profit - Overhead - Ad Spend</div>
                                <div>• Leads = Bookings ÷ Lead-to-Booking Rate</div>
                                <div>• Bookings = Completed Jobs ÷ Booking-to-Completed Rate</div>
                                <div>• Break-even CAC = (Gross Profit - Overhead) ÷ Leads</div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            applyOfferPreset(presetId) {
                if (!presetId) return;
                
                try {
                    const savedOffers = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                    const preset = savedOffers.find(o => o.id === presetId || o.timestamp === presetId);
                    
                    if (preset && preset.totals) {
                        this.inputs.aov = preset.totals.customerPrice || this.inputs.aov;
                        this.inputs.equipCostPerJob = (preset.totals.equipCostTotal / (preset.lineItems.reduce((sum, item) => sum + item.qty, 0) || 1)) || this.inputs.equipCostPerJob;
                        this.render();
                        this.recalculate();
                    }
                } catch (e) {
                    console.warn('Could not load offer preset', e);
                }
            },
            
            loadOfferPresets() {
                try {
                    const savedOffers = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                    const select = document.getElementById('forecastOfferPreset');
                    if (!select) return;
                    
                    select.innerHTML = '<option value="">Custom</option>';
                    savedOffers.slice(-10).reverse().forEach((offer, idx) => {
                        const option = document.createElement('option');
                        option.value = offer.timestamp || offer.id || idx;
                        option.textContent = `Offer ${savedOffers.length - idx} ($${offer.totals?.customerPrice?.toFixed(0) || 'N/A'})`;
                        select.appendChild(option);
                    });
                } catch (e) {
                    console.warn('Could not load offer presets', e);
                }
            }
        };

        /* ===== FORECAST CALCULATOR (Separate Tab) ===== */
        const forecastCalculator = {
            scenarios: [],
            
            init() {
                this.loadScenariosFromStorage();
            },
            
            loadScenariosFromStorage() {
                try {
                    this.scenarios = JSON.parse(localStorage.getItem('h2s_forecast_scenarios_v1') || '[]');
                } catch (e) {
                    this.scenarios = [];
                }
            },
            
            saveScenario() {
                const scenarioName = prompt('Enter a name for this scenario:');
                if (!scenarioName) return;
                
                const scenario = {
                    id: Date.now().toString(),
                    name: scenarioName,
                    timestamp: new Date().toISOString(),
                    inputs: {
                        // Store current forecast inputs if they exist
                        adSpend: 0,
                        cpl: 0,
                        bookingRate: 0,
                        cancelRate: 0,
                        techs: 0,
                        jobsPerTech: 0,
                        workdays: 0
                    }
                };
                
                this.scenarios.push(scenario);
                localStorage.setItem('h2s_forecast_scenarios_v1', JSON.stringify(this.scenarios));
                showToast('Scenario saved successfully!', 'success');
            },
            
            loadScenarios() {
                if (this.scenarios.length === 0) {
                    showModal('Saved Scenarios', '<div style="text-align: center; padding: 40px; color: #6b7280;">No saved scenarios yet</div>');
                    return;
                }
                
                const html = this.scenarios.map(s => `
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 700; font-size: 15px; color: var(--cobalt); margin-bottom: 4px;">${s.name}</div>
                                <div style="font-size: 12px; color: #6b7280;">${new Date(s.timestamp).toLocaleString()}</div>
                            </div>
                            <button onclick="forecastCalculator.applyScenario('${s.id}')" style="padding: 6px 12px; background: var(--cobalt); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                Load
                            </button>
                        </div>
                    </div>
                `).join('');
                
                showModal('Saved Forecast Scenarios', `<div style="max-height: 60vh; overflow-y: auto;">${html}</div>`, { width: '600px' });
            },
            
            applyScenario(scenarioId) {
                const scenario = this.scenarios.find(s => s.id === scenarioId);
                if (!scenario) return;
                
                showToast('Scenario loaded!', 'success');
                closeModal();
            }
        };

        /* ===== OFFER BUILDER - CART-BASED MULTI-SERVICE SYSTEM ===== */
        const offerBuilder = {
            offer: {
                name: '',
                lineItems: [],
                pricingStrategy: 'sum',
                percentOff: 0,
                dollarOff: 0,
                bundlePrice: 0,
                briefGenerated: false,
                // Offer Snapshot
                category: '',
                market: '',
                primaryAvatar: '',
                intendedGoal: '',
                headline: '',
                oneSentencePromise: '',
                offerStartDate: '',
                offerEndDate: '',
                scarcityMechanism: '',
                riskReversal: '',
                // The Deal
                whatsIncluded: '',
                whatsNotIncluded: '',
                eligibilityRules: '',
                redemptionRules: '',
                // Unit Economics (computed + notes)
                expectedAOV: 0,
                techPayoutRate: 35,
                estimatedMaterialsCost: 0,
                paymentProcessingFees: 0,
                travelOtherVariableCost: 0,
                marginBreakPoints: '',
                safeguards: '',
                // Value Equation
                dreamOutcome: '',
                likelihoodOfAchievement: '',
                timeDelay: '',
                effortSacrifice: '',
                // Competitor Reality Check
                competitorPriceRange: '',
                howWereDifferent: '',
                whyChooseUs: '',
                // Ops Notes
                whatToSayInHome: [],
                specialInstructions: '',
                capacityAssumption: '',
                cancellationRisks: '',
                // Messaging Pack
                bookingPageMicrocopy: '',
                smsConfirmation: '',
                smsReminder24h: '',
                priceQuestionLine: '',
                techBroadcastMessage: '',
                // Creative Angles
                hooks: [],
                objectionsRebuttals: [],
                proofIdeas: [],
                // Decision Notes
                bestCaseOutcome: '',
                worstCaseRisk: '',
                confidenceScore: 0,
                confidenceWhy: ''
            },
            
            serviceCatalog: [
                { id: 'tv-install', name: 'TV Installation', basePrice: 150, defaultEquipCost: 0, benchmarkPrice: 'Industry: $120-$200', benchmarkEquip: 'Customer provides TV' },
                { id: 'tv-mount-wall', name: 'TV Wall Mount (Basic)', basePrice: 125, defaultEquipCost: 0, benchmarkPrice: 'Industry: $100-$175', benchmarkEquip: 'Mount included or customer provides' },
                { id: 'tv-mount-ceiling', name: 'TV Ceiling Mount', basePrice: 200, defaultEquipCost: 0, benchmarkPrice: 'Industry: $175-$275', benchmarkEquip: 'Mount included or customer provides' },
                { id: 'soundbar-mount', name: 'Soundbar Mount', basePrice: 75, defaultEquipCost: 0, benchmarkPrice: 'Industry: $60-$100', benchmarkEquip: 'Customer provides soundbar' },
                { id: 'doorbell-camera', name: 'Doorbell Camera Install', basePrice: 200, defaultEquipCost: 150, benchmarkPrice: 'Industry: $150-$250', benchmarkEquip: 'Camera: $100-$200 (Ring, Nest, etc.)' },
                { id: 'security-system', name: 'Security System Install', basePrice: 500, defaultEquipCost: 300, benchmarkPrice: 'Industry: $400-$800', benchmarkEquip: 'Per camera: $100-$250 (wired), $150-$300 (wireless)' },
                { id: 'security-camera-single', name: 'Single Security Camera', basePrice: 175, defaultEquipCost: 150, benchmarkPrice: 'Industry: $125-$225', benchmarkEquip: 'Camera: $100-$200' },
                { id: 'smart-lock', name: 'Smart Lock Install', basePrice: 100, defaultEquipCost: 80, benchmarkPrice: 'Industry: $75-$150', benchmarkEquip: 'Lock: $50-$200 (August, Schlage, etc.)' },
                { id: 'wifi-setup', name: 'WiFi Setup / Mesh Network', basePrice: 250, defaultEquipCost: 0, benchmarkPrice: 'Industry: $200-$350', benchmarkEquip: 'Customer provides router/mesh system' },
                { id: 'wifi-troubleshoot', name: 'WiFi Troubleshooting', basePrice: 150, defaultEquipCost: 0, benchmarkPrice: 'Industry: $100-$200', benchmarkEquip: 'No equipment needed' },
                { id: 'wire-management', name: 'Wire Management / Hide Cables', basePrice: 100, defaultEquipCost: 25, benchmarkPrice: 'Industry: $75-$150', benchmarkEquip: 'Cable management kit: $20-$50' },
                { id: 'smart-switch', name: 'Smart Switch Install', basePrice: 85, defaultEquipCost: 35, benchmarkPrice: 'Industry: $60-$120', benchmarkEquip: 'Switch: $25-$60 (Lutron, TP-Link, etc.)' },
                { id: 'smart-thermostat', name: 'Smart Thermostat Install', basePrice: 150, defaultEquipCost: 200, benchmarkPrice: 'Industry: $125-$200', benchmarkEquip: 'Thermostat: $150-$300 (Nest, Ecobee, etc.)' }
            ],
            
            init() {
                // Ensure idempotent - check if already initialized
                const container = document.getElementById('offerbuilder-pane');
                if (container && container.dataset.initialized) return;
                if (container) container.dataset.initialized = 'true';
                
                // Update sticky positioning on init (if not already set up)
                const self = this;
                if (!this.stickyObserver) {
                    setTimeout(() => {
                        if (self.initStickyPositioningObserver) {
                            self.initStickyPositioningObserver();
                        }
                        if (self.updateStickyPositioning) {
                            self.updateStickyPositioning();
                        }
                    }, 300);
                }
                
                this.renderLineItems();
                this.recalculateOffer();
                
                // Auto-update on input change (idempotent - remove old listeners if any)
                if (container) {
                    const debounceTimer = {};
                    const inputHandler = (e) => {
                        if (e.target.closest('#offerbuilder-pane')) {
                            clearTimeout(debounceTimer[e.target.id]);
                            debounceTimer[e.target.id] = setTimeout(() => {
                                this.recalculateOffer();
                            }, 300);
                        }
                    };
                    const changeHandler = (e) => {
                        if (e.target.closest('#offerbuilder-pane')) {
                            this.recalculateOffer();
                        }
                    };
                    
                    // Remove existing listeners if any (idempotent)
                    container.removeEventListener('input', inputHandler);
                    container.removeEventListener('change', changeHandler);
                    
                    // Add fresh listeners
                    container.addEventListener('input', inputHandler);
                    container.addEventListener('change', changeHandler);
                }
                
                // Initialize messaging tab to 'snapshot'
                this.switchMessagingTab('snapshot');
            },
            
            addLineItem(serviceId = null) {
                const allServices = [...this.serviceCatalog, ...this.getCustomServices()];
                const service = serviceId ? allServices.find(s => s.id === serviceId) : allServices[0];
                if (!service) return;
                
                // Create line item with zero prices - user must enter their own pricing
                const lineItem = {
                    id: Date.now().toString(),
                    serviceId: service.id,
                    name: service.name,
                    qty: 1,
                    baseUnitPrice: 0,  // User enters their own price
                    equipCostPerUnit: 0,  // User enters their own equipment cost
                    equipMode: 'BYO',  // Default to customer provides equipment
                    isIncludedInOffer: true,
                    notes: service.notes || ''
                };
                
                this.offer.lineItems.push(lineItem);
                this.renderLineItems();
                this.recalculateOffer();
                
                // Track service addition
                if (typeof trackEvent === 'function') {
                    trackEvent('service_added_to_offer', {
                        service_name: service.name,
                        service_id: service.id,
                        offer_name: this.offer.name || 'Unnamed',
                        total_services: this.offer.lineItems.length
                    });
                }
            },
            
            removeLineItem(itemId) {
                this.offer.lineItems = this.offer.lineItems.filter(item => item.id !== itemId);
                this.renderLineItems();
                this.recalculateOffer();
            },
            
            updateLineItem(itemId, field, value) {
                const item = this.offer.lineItems.find(i => i.id === itemId);
                if (!item) return;
                
                if (field === 'qty') {
                    item.qty = Math.max(1, parseInt(value) || 1);
                } else if (field === 'equipMode') {
                    item.equipMode = value;
                    if (value === 'BYO') {
                        item.equipCostPerUnit = 0;
                        item.equipEstimate = null; // Clear estimate when switching to BYO
                    }
                } else if (field === 'equipCostPerUnit') {
                    item.equipCostPerUnit = parseFloat(value) || 0;
                } else if (field === 'baseUnitPrice') {
                    item.baseUnitPrice = parseFloat(value) || 0;
                } else if (field === 'name') {
                    item.name = value;
                } else if (field === 'notes') {
                    item.notes = value;
                }
                
                this.renderLineItems();
                this.recalculateOffer();
            },
            
            async estimateEquipmentCost(itemId) {
                const item = this.offer.lineItems.find(i => i.id === itemId);
                if (!item) return;
                
                if (item.equipMode === 'BYO') {
                    showToast('Equipment cost estimation is not needed when customer provides equipment', 'info');
                    return;
                }
                
                // Show loading state
                showToast('Estimating equipment cost...', 'info');
                
                try {
                    const allServices = [...this.serviceCatalog, ...this.getCustomServices()];
                    const service = allServices.find(s => s.id === item.serviceId);
                    const category = this.offer.category || service?.category || '';
                    const serviceDescription = service?.description || item.notes || '';
                    
                    const params = new URLSearchParams({
                        serviceName: item.name,
                        category: category,
                        serviceDescription: serviceDescription
                    });
                    
                    const response = await fetch(`${API_URL}?action=estimateEquipmentCost&${params.toString()}`);
                    const data = await response.json();
                    
                    // Handle both response formats: { ok: true, estimateEquipmentCost: {...} } or direct result
                    const estimate = data.estimateEquipmentCost || (data.ok ? data : null);
                    
                    if (estimate && estimate.estimatedCost !== undefined) {
                        item.equipEstimate = {
                            estimatedCost: estimate.estimatedCost,
                            costRange: estimate.costRange || { min: 0, max: 0 },
                            confidence: estimate.confidence || 'medium',
                            notes: estimate.notes || '',
                            equipmentItems: estimate.equipmentItems || []
                        };
                        this.renderLineItems();
                        showToast('Equipment cost estimated successfully!', 'success');
                    } else {
                        showToast('Failed to estimate equipment cost: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Equipment cost estimation error:', error);
                    showToast('Error estimating equipment cost: ' + error.message, 'error');
                }
            },
            
            applyEquipmentEstimate(itemId) {
                const item = this.offer.lineItems.find(i => i.id === itemId);
                if (!item || !item.equipEstimate) return;
                
                item.equipCostPerUnit = item.equipEstimate.estimatedCost;
                item.equipEstimate = null; // Clear estimate after applying
                this.renderLineItems();
                this.recalculateOffer();
                showToast('Equipment cost applied!', 'success');
            },
            
            clearEquipmentEstimate(itemId) {
                const item = this.offer.lineItems.find(i => i.id === itemId);
                if (!item) return;
                
                item.equipEstimate = null;
                this.renderLineItems();
            },
            
            updateOfferName(name) {
                this.offer.name = name;
                // Show/hide guidance
                const guidance = document.getElementById('offerBuilderNameGuidance');
                if (guidance) {
                    guidance.style.display = (!name || name.trim() === '') ? 'block' : 'none';
                }
            },
            
            updateField(field, value) {
                this.offer[field] = value;
            },
            
            toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const toggle = document.getElementById(sectionId + 'Toggle');
                if (section && toggle) {
                    const isHidden = section.style.display === 'none';
                    section.style.display = isHidden ? 'block' : 'none';
                    toggle.textContent = isHidden ? '▲' : '▼';
                    
                    // CRITICAL: Recalculate sticky positioning when accordion expands/collapses
                    // This ensures right column panels adjust when left column content changes height
                    if (typeof this.updateStickyPositioning === 'function') {
                        // Use requestAnimationFrame to ensure DOM has updated
                        requestAnimationFrame(() => {
                            this.updateStickyPositioning();
                            // Also recalculate after a brief delay to catch any async content loading
                            setTimeout(() => {
                                this.updateStickyPositioning();
                            }, 150);
                        });
                    }
                    
                    // Smooth scroll expanded section into view if it's partially off-screen
                    if (isHidden && section.style.display === 'block') {
                        requestAnimationFrame(() => {
                            const sectionRect = section.getBoundingClientRect();
                            const viewportHeight = window.innerHeight;
                            const headerHeight = 80; // Approximate header height
                            
                            // Check if section is partially or fully off-screen
                            if (sectionRect.top < headerHeight || sectionRect.bottom > viewportHeight) {
                                // Scroll the section header (parent element) into view
                                const sectionHeader = section.previousElementSibling;
                                if (sectionHeader) {
                                    sectionHeader.scrollIntoView({ 
                                        block: 'nearest', 
                                        behavior: 'smooth' 
                                    });
                                } else {
                                    // Fallback: scroll the section itself
                                    section.scrollIntoView({ 
                                        block: 'nearest', 
                                        behavior: 'smooth' 
                                    });
                                }
                            }
                        });
                    }
                    
                    // Load data when section is opened
                    if (sectionId === 'offerBuilderPerformanceFeedback' && isHidden) {
                        this.loadPerformanceData();
                    }
                    if (sectionId === 'offerBuilderInsights' && isHidden) {
                        this.loadInsights();
                    }
                }
            },
            
            updatePricingStrategy(strategy) {
                this.offer.pricingStrategy = strategy;
                
                document.getElementById('offerBuilderPercentOffContainer').style.display = 
                    strategy === 'percentOff' ? 'block' : 'none';
                document.getElementById('offerBuilderDollarOffContainer').style.display = 
                    strategy === 'dollarOff' ? 'block' : 'none';
                document.getElementById('offerBuilderBundlePriceContainer').style.display = 
                    strategy === 'bundlePrice' ? 'block' : 'none';
                
                this.recalculateOffer();
            },
            
            handleDirectPriceInput(value) {
                const price = parseFloat(value) || 0;
                const helpEl = document.getElementById('offerBuilderPriceHelp');
                
                if (price > 0) {
                    const techPayout = price * 0.35;
                    const remaining = price - techPayout;
                    helpEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; font-size: 11px;">
                            <div>
                                <span style="color: #9ca3af;">Tech earns:</span>
                                <strong style="color: var(--cobalt); margin-left: 4px;">$${techPayout.toFixed(2)}</strong>
                                <span style="color: #d1d5db; margin: 0 6px;">•</span>
                                <span style="color: #9ca3af;">Your budget:</span>
                                <strong style="color: var(--cobalt); margin-left: 4px;">$${remaining.toFixed(2)}</strong>
                            </div>
                            <span style="color: #d1d5db; font-size: 10px;">(35% tech payout)</span>
                        </div>
                    `;
                    helpEl.style.display = 'block';
                } else {
                    helpEl.style.display = 'none';
                }
            },
            
            applyDirectPrice() {
                const priceInput = document.getElementById('offerBuilderDirectPrice');
                const price = parseFloat(priceInput.value) || 0;
                
                if (price <= 0) {
                    showToast('Please enter a price greater than $0', 'error');
                    return;
                }
                
                // Set to fixed bundle price mode
                this.offer.pricingStrategy = 'bundlePrice';
                this.offer.bundlePrice = price;
                
                // Update radio button
                const bundleRadio = document.querySelector('input[name="offerBuilderPricingStrategy"][value="bundlePrice"]');
                if (bundleRadio) bundleRadio.checked = true;
                
                // Show the bundle price input and set its value
                document.getElementById('offerBuilderBundlePriceContainer').style.display = 'block';
                const bundlePriceInput = document.getElementById('offerBuilderBundlePrice');
                if (bundlePriceInput) bundlePriceInput.value = price;
                
                // Show current price indicator
                const currentPriceDisplay = document.getElementById('offerBuilderCurrentPrice');
                const currentPriceValue = document.getElementById('offerBuilderCurrentPriceDisplay');
                if (currentPriceDisplay && currentPriceValue) {
                    currentPriceValue.textContent = `$${price.toFixed(2)}`;
                    currentPriceDisplay.style.display = 'block';
                }
                
                // Recalculate
                this.recalculateOffer();
                
                showToast(`✓ Offer price set to $${price.toFixed(2)}`, 'success');
                
                // Clear the direct price input
                priceInput.value = '';
                document.getElementById('offerBuilderPriceHelp').style.display = 'none';
            },
            
            clearOfferPrice() {
                this.offer.pricingStrategy = 'sum';
                this.offer.bundlePrice = 0;
                
                // Reset radio to sum
                const sumRadio = document.querySelector('input[name="offerBuilderPricingStrategy"][value="sum"]');
                if (sumRadio) sumRadio.checked = true;
                
                // Hide current price indicator
                const currentPriceDisplay = document.getElementById('offerBuilderCurrentPrice');
                if (currentPriceDisplay) currentPriceDisplay.style.display = 'none';
                
                // Hide bundle price container
                document.getElementById('offerBuilderBundlePriceContainer').style.display = 'none';
                
                this.recalculateOffer();
                showToast('Offer price cleared - now calculating from services', 'info');
            },
            
            calculateTotals() {
                const { lineItems, pricingStrategy, percentOff, dollarOff, bundlePrice } = this.offer;
                
                const subtotalBase = lineItems.reduce((sum, item) => {
                    return sum + (item.baseUnitPrice * item.qty);
                }, 0);
                
                // Equipment cost (only for items where equipMode != "BYO")
                const equipCostTotal = lineItems.reduce((sum, item) => {
                    if (item.equipMode !== 'BYO') {
                        return sum + (item.equipCostPerUnit * item.qty);
                    }
                    return sum;
                }, 0);
                
                // Customer price based on pricing strategy
                let customerPrice = subtotalBase;
                if (pricingStrategy === 'bundlePrice' && bundlePrice > 0) {
                    customerPrice = bundlePrice;
                } else if (pricingStrategy === 'percentOff' && percentOff > 0) {
                    customerPrice = subtotalBase * (1 - percentOff / 100);
                } else if (pricingStrategy === 'dollarOff' && dollarOff > 0) {
                    customerPrice = Math.max(0, subtotalBase - dollarOff);
                }
                
                // Tech payout is 35% of what WE get paid (customer price)
                const techPayoutTotal = customerPrice * 0.35;
                
                const profit = customerPrice - techPayoutTotal - equipCostTotal;
                const marginPct = customerPrice > 0 ? (profit / customerPrice) * 100 : 0;
                
                return {
                    subtotalBase,
                    techPayoutTotal,
                    equipCostTotal,
                    customerPrice,
                    profit,
                    marginPct
                };
            },
            
            recalculateOffer() {
                if (this.offer.lineItems.length === 0) {
                    document.getElementById('offerBuilderResults').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6b7280; font-size: 14px;">
                            Add services to see calculations
                        </div>
                    `;
                    document.getElementById('offerBuilderWarnings').innerHTML = '';
                    this.renderStandards();
                    return;
                }
                
                // Get current pricing strategy values
                this.offer.percentOff = parseFloat(document.getElementById('offerBuilderPercentOff')?.value || 0);
                this.offer.dollarOff = parseFloat(document.getElementById('offerBuilderDollarOff')?.value || 0);
                this.offer.bundlePrice = parseFloat(document.getElementById('offerBuilderBundlePrice')?.value || 0);
                
                const totals = this.calculateTotals();
                const warnings = this.validateOffer();
                const standards = this.evaluateStandards(totals);
                
                // Update Standards panel
                this.renderStandards(standards);
                
                // Update button states
                this.updateButtonStates(standards);
                
                // Update sticky positioning after content changes
                const self = this;
                setTimeout(() => {
                    if (self.updateStickyPositioning) {
                        self.updateStickyPositioning();
                    }
                }, 150);
                
                document.getElementById('offerBuilderResults').innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <span style="font-size: 14px; color: #6b7280;">Subtotal (Base)</span>
                            <span style="font-size: 16px; font-weight: 700; color: var(--cobalt);">$${totals.subtotalBase.toFixed(2)}</span>
                            </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div>
                                <span style="font-size: 14px; color: #6b7280;">Customer Price</span>
                                <div style="font-size: 11px; color: #9ca3af; margin-top: 2px;">Final price customer pays</div>
                                </div>
                            <span style="font-size: 20px; font-weight: 900; color: var(--cobalt);">$${totals.customerPrice.toFixed(2)}</span>
                                </div>
                        <div style="border-top: 2px solid #e5e7eb; padding-top: 12px; margin-top: 4px;">
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: #fef3c7; border-radius: 8px; margin-bottom: 8px; border: 1px solid #fde68a;">
                                <div>
                                    <span style="font-size: 14px; color: #92400e; font-weight: 600;">Tech Payout</span>
                                    <div style="font-size: 11px; color: #a16207; margin-top: 2px;">35% of customer price</div>
                                </div>
                                <span style="font-size: 16px; font-weight: 700; color: #92400e;">$${totals.techPayoutTotal.toFixed(2)}</span>
                                </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <span style="font-size: 14px; color: #6b7280;">Equipment Cost</span>
                                <span style="font-size: 16px; font-weight: 700; color: var(--cobalt);">$${totals.equipCostTotal.toFixed(2)}</span>
                            </div>
                        </div>
                        <div style="border-top: 2px solid #e5e7eb; padding-top: 12px; margin-top: 4px;">
                            <div style="display: flex; justify-content: space-between; padding: 16px; background: ${totals.profit >= 0 ? '#d1fae5' : '#fee2e2'}; border-radius: 8px; margin-bottom: 8px; border: 1px solid ${totals.profit >= 0 ? '#a7f3d0' : '#fecaca'};">
                                <span style="font-size: 16px; font-weight: 700; color: ${totals.profit >= 0 ? '#065f46' : '#991b1b'};">Profit</span>
                                <span style="font-size: 20px; font-weight: 900; color: ${totals.profit >= 0 ? '#065f46' : '#991b1b'};">$${totals.profit.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <span style="font-size: 14px; color: #6b7280;">Margin</span>
                                <span style="font-size: 18px; font-weight: 700; color: ${totals.marginPct >= 40 ? '#10b981' : totals.marginPct >= 20 ? '#f59e0b' : '#ef4444'};">
                                    ${totals.marginPct.toFixed(1)}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
                if (warnings.length > 0) {
                    document.getElementById('offerBuilderWarnings').innerHTML = `
                        <div style="padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: #991b1b; margin-bottom: 8px;">⚠️ Warnings</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #991b1b; line-height: 1.6;">
                                ${warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    document.getElementById('offerBuilderWarnings').innerHTML = '';
                }
                
                const updateEl = document.getElementById('offerBuilderLastUpdate');
                if (updateEl) {
                    updateEl.textContent = 'Updated just now';
                    updateEl.style.display = 'inline-block';
                    setTimeout(() => {
                        updateEl.style.display = 'none';
                    }, 3000);
                }
            },
            
            validateOffer() {
                const warnings = [];
                const totals = this.calculateTotals();
                
                this.offer.lineItems.forEach((item, index) => {
                    // Check if service price is not entered
                    if (!item.baseUnitPrice || item.baseUnitPrice <= 0) {
                        warnings.push(`Service "${item.name}" needs a price entered.`);
                    }
                    
                    // Check if equipment mode requires cost but none is set
                    if (item.equipMode !== 'BYO' && (!item.equipCostPerUnit || item.equipCostPerUnit <= 0)) {
                        warnings.push(`Service "${item.name}" has equipment included but no equipment cost set.`);
                    }
                });
                
                if (totals.profit < 0) {
                    warnings.push(`Offer is unprofitable ($${Math.abs(totals.profit).toFixed(2)} loss).`);
                }
                
                if (totals.marginPct < 40 && totals.profit >= 0) {
                    warnings.push(`Margin is below 40% threshold (currently ${totals.marginPct.toFixed(1)}%).`);
                }
                
                if (totals.customerPrice <= 0) {
                    warnings.push('Customer price is zero or negative. Check pricing strategy.');
                }
                
                return warnings;
            },
            
            evaluateStandards(totals) {
                const issues = [];
                const hardFails = [];
                const softWarnings = [];
                let score = 100;
                
                // Hard-fail triggers (block export/mark ready)
                if (!this.offer.name || this.offer.name.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Offer name is required', fix: 'Enter an offer name' });
                    score -= 20;
                }
                
                if (this.offer.lineItems.length === 0) {
                    hardFails.push({ type: 'hard', message: 'No services selected', fix: 'Add at least one service' });
                    score -= 20;
                }
                
                // New required fields for deployable offer
                if (!this.offer.headline || this.offer.headline.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Headline is required', fix: 'Enter ad-ready headline' });
                    score -= 15;
                }
                
                if (!this.offer.oneSentencePromise || this.offer.oneSentencePromise.trim() === '') {
                    hardFails.push({ type: 'hard', message: '1-Sentence Promise is required', fix: 'Enter 1-sentence promise' });
                    score -= 15;
                }
                
                if (!this.offer.category || this.offer.category.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Category is required', fix: 'Select offer category' });
                    score -= 10;
                }
                
                if (!this.offer.primaryAvatar || this.offer.primaryAvatar.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Primary Avatar is required', fix: 'Select primary avatar' });
                    score -= 10;
                }
                
                if (!this.offer.intendedGoal || this.offer.intendedGoal.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Intended Goal is required', fix: 'Select intended goal' });
                    score -= 10;
                }
                
                if (!this.offer.market || this.offer.market.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Market is required', fix: 'Enter market (City/Zip or All)' });
                    score -= 10;
                }
                
                // Check pricing strategy completeness
                if (this.offer.pricingStrategy === 'percentOff' && (!this.offer.percentOff || this.offer.percentOff <= 0)) {
                    hardFails.push({ type: 'hard', message: 'Percentage off value missing', fix: 'Enter discount percentage' });
                    score -= 15;
                }
                if (this.offer.pricingStrategy === 'dollarOff' && (!this.offer.dollarOff || this.offer.dollarOff <= 0)) {
                    hardFails.push({ type: 'hard', message: 'Dollar off value missing', fix: 'Enter discount amount' });
                    score -= 15;
                }
                if (this.offer.pricingStrategy === 'bundlePrice' && (!this.offer.bundlePrice || this.offer.bundlePrice <= 0)) {
                    hardFails.push({ type: 'hard', message: 'Bundle price missing', fix: 'Enter bundle price' });
                    score -= 15;
                }
                
                // Missing equipment costs
                this.offer.lineItems.forEach((item, idx) => {
                    // Check if service price is missing (new requirement)
                    if (!item.baseUnitPrice || item.baseUnitPrice <= 0) {
                        hardFails.push({ type: 'hard', message: `"${item.name}" needs a price`, fix: `Enter your price for ${item.name}` });
                        score -= 10;
                    }
                    
                    // Check equipment cost
                    if (item.equipMode !== 'BYO' && (!item.equipCostPerUnit || item.equipCostPerUnit <= 0)) {
                        hardFails.push({ type: 'hard', message: `"${item.name}" missing equipment cost`, fix: `Set equipment cost for ${item.name}` });
                        score -= 10;
                    }
                });
                
                // Negative profit check is handled above in Economics validity section
                
                // Economics validity (40 points)
                if (totals.customerPrice <= 0) {
                    hardFails.push({ type: 'hard', message: 'Customer price is zero or negative', fix: 'Check pricing strategy' });
                    score -= 15;
                } else {
                    // Margin checks
                    if (totals.marginPct < 30) {
                        softWarnings.push({ type: 'soft', message: `Low margin: ${totals.marginPct.toFixed(1)}%`, fix: 'Aim for 30%+ margin', impact: 10 });
                        score -= 10;
                    } else if (totals.marginPct < 40) {
                        softWarnings.push({ type: 'soft', message: `Margin below target: ${totals.marginPct.toFixed(1)}%`, fix: 'Target 40%+ margin', impact: 5 });
                        score -= 5;
                    }
                }
                
                // Completeness of offer definition (20 points)
                if (!this.offer.whatsIncluded || this.offer.whatsIncluded.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing "What\'s Included"', fix: 'Define what\'s included', impact: 5 });
                    score -= 5;
                }
                if (!this.offer.eligibilityRules || this.offer.eligibilityRules.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing eligibility rules', fix: 'Define eligibility rules', impact: 3 });
                    score -= 3;
                }
                if (!this.offer.redemptionRules || this.offer.redemptionRules.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing redemption rules', fix: 'Define redemption rules', impact: 3 });
                    score -= 3;
                }
                
                // Copy + deployability (20 points)
                if (!this.offer.bookingPageMicrocopy || this.offer.bookingPageMicrocopy.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing booking page microcopy', fix: 'Add booking page copy', impact: 5 });
                    score -= 5;
                }
                if (!this.offer.smsConfirmation || this.offer.smsConfirmation.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing SMS confirmation', fix: 'Add SMS confirmation copy', impact: 3 });
                    score -= 3;
                }
                if (!this.offer.priceQuestionLine || this.offer.priceQuestionLine.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing price question response', fix: 'Add price question line', impact: 3 });
                    score -= 3;
                }
                
                // Credibility stack (20 points)
                if (!this.offer.scarcityMechanism || this.offer.scarcityMechanism.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing scarcity mechanism', fix: 'Select scarcity mechanism', impact: 5 });
                    score -= 5;
                }
                if (!this.offer.riskReversal || this.offer.riskReversal.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing risk reversal', fix: 'Add risk reversal (warranty, guarantee)', impact: 5 });
                    score -= 5;
                }
                if (!this.offer.marginBreakPoints || this.offer.marginBreakPoints.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing margin break points', fix: 'Document where this can break', impact: 5 });
                    score -= 5;
                }
                if (this.offer.hooks.length === 0) {
                    softWarnings.push({ type: 'soft', message: 'Missing creative hooks', fix: 'Add 5 hooks for ads', impact: 3 });
                    score -= 3;
                }
                if (this.offer.objectionsRebuttals.length === 0) {
                    softWarnings.push({ type: 'soft', message: 'Missing objections + rebuttals', fix: 'Add 3 objections + rebuttals', impact: 3 });
                    score -= 3;
                }
                
                // Determine status
                let status = 'Draft';
                if (hardFails.length > 0) {
                    status = 'Incomplete';
                } else if (score < 70) {
                    status = 'Needs Fixes';
                } else if (score < 85) {
                    status = 'Risky';
                } else {
                    status = 'Up to Standard';
                }
                
                // Get next fix (highest impact)
                let nextFix = null;
                if (hardFails.length > 0) {
                    nextFix = hardFails[0];
                } else if (softWarnings.length > 0) {
                    // Sort by impact
                    const sorted = [...softWarnings].sort((a, b) => (b.impact || 0) - (a.impact || 0));
                    nextFix = sorted[0];
                }
                
                // Get top 3-6 issues affecting score
                const allIssues = [...hardFails, ...softWarnings].slice(0, 6);
                
                return {
                    status,
                    score: Math.max(0, score),
                    hardFails,
                    softWarnings,
                    nextFix,
                    issues: allIssues
                };
            },
            
            renderStandards(standards = null) {
                const container = document.getElementById('offerBuilderStandardsContent');
                if (!container) return;
                
                const self = this; // Capture 'this' for setTimeout callbacks
                
                if (!standards) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 13px;">
                            Add services to begin evaluation
                        </div>
                    `;
                    // Update sticky positioning after rendering
                    setTimeout(() => {
                        if (self.updateStickyPositioning) {
                            self.updateStickyPositioning();
                        }
                    }, 50);
                    return;
                }
                
                // Continue with standards rendering - 'self' already declared above
                
                const { status, score, hardFails, softWarnings, nextFix, issues } = standards;
                
                // Status badge colors
                const statusColors = {
                    'Draft': { bg: '#f3f4f6', text: '#374151', border: '#d1d5db' },
                    'Incomplete': { bg: '#fee2e2', text: '#991b1b', border: '#fecaca' },
                    'Needs Fixes': { bg: '#fef3c7', text: '#92400e', border: '#fde68a' },
                    'Risky': { bg: '#fef3c7', text: '#92400e', border: '#fde68a' },
                    'Up to Standard': { bg: '#d1fae5', text: '#065f46', border: '#a7f3d0' }
                };
                
                const statusColor = statusColors[status] || statusColors['Draft'];
                const scoreColor = score >= 85 ? '#10b981' : score >= 70 ? '#f59e0b' : '#ef4444';
                const isPass = status === 'Up to Standard';
                
                // Map issues to field IDs for scrolling
                const fieldMap = {
                    'Offer name is required': 'offerBuilderName',
                    'No services selected': 'offerBuilderLineItems',
                    'Headline is required': 'offerBuilderHeadline',
                    '1-Sentence Promise is required': 'offerBuilderOneSentencePromise',
                    'Category is required': 'offerBuilderCategory',
                    'Primary Avatar is required': 'offerBuilderPrimaryAvatar',
                    'Intended Goal is required': 'offerBuilderIntendedGoal',
                    'Market is required': 'offerBuilderMarket',
                    'Percentage off value missing': 'offerBuilderPercentOff',
                    'Dollar off value missing': 'offerBuilderDollarOff',
                    'Bundle price missing': 'offerBuilderBundlePrice'
                };
                
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Status Badge -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${statusColor.bg}; border: 2px solid ${statusColor.border}; border-radius: 8px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: ${statusColor.text}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Status</div>
                                <div style="font-size: 16px; font-weight: 700; color: ${statusColor.text};">${isPass ? 'Pass' : status}</div>
                                </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; font-weight: 600; color: ${statusColor.text}; margin-bottom: 4px;">Score</div>
                                <div style="font-size: 20px; font-weight: 900; color: ${scoreColor};">${score}</div>
                            </div>
                        </div>
                        
                        ${nextFix ? `
                            <!-- Next Fix -->
                            <div style="padding: 12px; background: #f9fafb; border-left: 4px solid ${nextFix.type === 'hard' ? '#ef4444' : '#f59e0b'}; border-radius: 6px;">
                                <div style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 6px;">Next Fix</div>
                                <button onclick="offerBuilder.scrollToField('${fieldMap[nextFix.message] || ''}')" style="width: 100%; text-align: left; padding: 0; background: none; border: none; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">${nextFix.fix}</button>
                                <div style="font-size: 12px; color: #6b7280; line-height: 1.4;">${nextFix.message}</div>
                                ${nextFix.suggestion ? `<div style="font-size: 11px; color: #059669; margin-top: 6px; font-weight: 600;">💡 ${nextFix.suggestion}</div>` : ''}
                            </div>
                        ` : ''}
                        
                        ${issues.length > 0 ? `
                            <!-- Top Issues -->
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Issues (${issues.length})</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto;">
                                    ${issues.slice(0, 5).map((issue, idx) => {
                                        const fieldId = fieldMap[issue.message] || '';
                                        return `
                                            <div style="padding: 8px; background: ${issue.type === 'hard' ? '#fee2e2' : '#fef3c7'}; border-radius: 6px; border-left: 3px solid ${issue.type === 'hard' ? '#ef4444' : '#f59e0b'}; ${fieldId ? 'cursor: pointer;' : ''}" ${fieldId ? `onclick="offerBuilder.scrollToField('${fieldId}')"` : ''}>
                                                <div style="font-size: 11px; font-weight: 600; color: ${issue.type === 'hard' ? '#991b1b' : '#92400e'}; ${fieldId ? 'text-decoration: underline;' : ''}">${issue.message}</div>
                        </div>
                    `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div style="padding: 12px; background: #d1fae5; border-radius: 6px; text-align: center;">
                                <div style="font-size: 12px; color: #065f46; font-weight: 600;">✓ All checks passed</div>
                            </div>
                        `}
                    </div>
                `;
                
                // Update sticky positioning after rendering standards (content height changed)
                // Note: 'self' already declared at function start
                setTimeout(() => {
                    if (self.updateStickyPositioning) {
                        self.updateStickyPositioning();
                    }
                }, 50);
            },
            
            scrollToField(fieldId) {
                if (!fieldId) return;
                const field = document.getElementById(fieldId);
                if (field) {
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => field.focus(), 300);
                }
            },
            
            validateHeadline(value) {
                const guardrail = document.getElementById('offerBuilderHeadlineGuardrail');
                if (!guardrail) return;
                
                if (!value || value.trim() === '') {
                    guardrail.style.display = 'none';
                    return;
                }
                
                const hasOutcome = /install|mount|setup|protect|secure|fast|complete/i.test(value);
                const hasTime = /\d+\s*(hour|day|minute|today|same|24)/i.test(value);
                const hasPain = /no|without|avoid|save|easy|simple|guarantee/i.test(value);
                
                if (!hasOutcome || (!hasTime && !hasPain)) {
                    guardrail.style.display = 'block';
                    guardrail.style.color = '#f59e0b';
                    guardrail.textContent = 'Tip: Include a concrete outcome AND either a time reference or pain removed.';
                } else {
                    guardrail.style.display = 'none';
                }
            },
            
            validatePromise(value) {
                const guardrail = document.getElementById('offerBuilderPromiseGuardrail');
                if (!guardrail) return;
                
                if (!value || value.trim() === '') {
                    guardrail.style.display = 'none';
                    return;
                }
                
                const minLength = 30;
                const hasOutcome = /install|mount|setup|protect|secure|guarantee|complete|working/i.test(value);
                
                if (value.length < minLength || !hasOutcome) {
                    guardrail.style.display = 'block';
                    guardrail.style.color = '#f59e0b';
                    guardrail.textContent = `Tip: Promise should be at least ${minLength} characters and include an outcome keyword.`;
                } else {
                    guardrail.style.display = 'none';
                }
            },
            
            validateHooks(value) {
                const guardrail = document.getElementById('offerBuilderHooksGuardrail');
                if (!guardrail) return;
                
                if (!value || value.trim() === '') {
                    guardrail.style.display = 'none';
                    return;
                }
                
                const hooks = value.split('\\n').filter(h => h.trim());
                const maxLength = 60;
                const longHooks = hooks.filter(h => h.length > maxLength);
                
                if (longHooks.length > 0) {
                    guardrail.style.display = 'block';
                    guardrail.style.color = '#f59e0b';
                    guardrail.textContent = `Tip: Keep hooks short (≤${maxLength} chars). ${longHooks.length} hook(s) too long.`;
                } else {
                    guardrail.style.display = 'none';
                }
            },
            
            switchMessagingTab(tab) {
                const tabs = ['snapshot', 'value', 'messaging', 'creative', 'ops', 'decision'];
                tabs.forEach(t => {
                    const tabBtn = document.getElementById(`messagingTab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                    const tabContent = document.getElementById(`messagingTabContent${t.charAt(0).toUpperCase() + t.slice(1)}`);
                    if (tabBtn) {
                        if (t === tab) {
                            tabBtn.style.background = 'var(--cobalt)';
                            tabBtn.style.color = 'white';
                        } else {
                            tabBtn.style.background = '#f3f4f6';
                            tabBtn.style.color = 'var(--cobalt)';
                        }
                    }
                    if (tabContent) {
                        tabContent.style.display = t === tab ? 'block' : 'none';
                    }
                });
            },
            
            updateButtonStates(standards) {
                const generateBtn = document.getElementById('offerBuilderGenerateBriefBtn');
                const markReadyBtn = document.getElementById('offerBuilderMarkReadyBtn');
                
                if (!standards) {
                    // Generate Brief is always enabled (just warns if incomplete)
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.style.opacity = '1';
                        generateBtn.style.cursor = 'pointer';
                    }
                    if (markReadyBtn) markReadyBtn.style.display = 'none';
                    return;
                }
                
                const canMarkReady = standards.status === 'Up to Standard' && standards.hardFails.length === 0;
                
                // Generate Brief is always enabled - preview is always available
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.style.opacity = '1';
                    generateBtn.style.cursor = 'pointer';
                }
                
                if (markReadyBtn) {
                    markReadyBtn.style.display = canMarkReady ? 'block' : 'none';
                    markReadyBtn.disabled = !canMarkReady;
                }
                
                // Update build order
                this.updateBuildOrder(standards);
            },
            
            updateBuildOrder(standards) {
                const servicesComplete = this.offer.lineItems.length > 0;
                const pricingComplete = this.offer.pricingStrategy && 
                    (this.offer.pricingStrategy === 'sum' || 
                     (this.offer.pricingStrategy === 'percentOff' && this.offer.percentOff > 0) ||
                     (this.offer.pricingStrategy === 'dollarOff' && this.offer.dollarOff > 0) ||
                     (this.offer.pricingStrategy === 'bundlePrice' && this.offer.bundlePrice > 0));
                const messagingComplete = this.offer.headline && this.offer.oneSentencePromise;
                const standardsComplete = standards && standards.status === 'Up to Standard';
                const briefComplete = this.offer.briefGenerated || false;
                
                const updateIcon = (id, complete) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = complete ? '✓' : '○';
                };
                
                updateIcon('buildOrderServices', servicesComplete);
                updateIcon('buildOrderPricing', pricingComplete);
                updateIcon('buildOrderMessaging', messagingComplete);
                updateIcon('buildOrderStandards', standardsComplete);
                updateIcon('buildOrderBrief', briefComplete);
            },
            
            generateSampleOfferData() {
                const categories = ['TV Mount', 'Cameras', 'Doorbell', 'WiFi', 'Bundle'];
                const category = categories[Math.floor(Math.random() * categories.length)];
                const avatars = ['homeowner', 'renter', 'property manager', 'small biz'];
                const goals = ['bookings', 'AOV lift', 'bundle attach', 'speed to cash', 'lead volume'];
                const markets = ['All', 'Dallas, TX', 'Houston, TX', 'Austin, TX', 'San Antonio, TX'];
                const scarcityTypes = ['deadline', 'limited slots', 'limited bundles', 'price ends'];
                
                // Use Math.random() for random selections (can be made deterministic with seed if needed)
                // Check for URL seed parameter for deterministic generation
                const urlParams = new URLSearchParams(window.location.search);
                const seedParam = urlParams.get('seed');
                let seed = seedParam ? parseInt(seedParam) : null;
                
                // Simple seeded RNG if seed provided, otherwise use Math.random()
                let rngState = seed || Math.floor(Math.random() * 1000000);
                const seededRandom = () => {
                    rngState = (rngState * 9301 + 49297) % 233280;
                    return rngState / 233280;
                };
                
                const random = seed !== null ? seededRandom : () => Math.random();
                const randomInt = (max) => Math.floor(random() * max);
                const randomChoice = (arr) => arr[randomInt(arr.length)];
                
                const sample = {
                    name: `${category} Special Offer ${new Date().getMonth() + 1}/${new Date().getDate()}`,
                    category: category,
                    market: randomChoice(markets),
                    primaryAvatar: randomChoice(avatars),
                    intendedGoal: randomChoice(goals),
                    headline: this.generateHeadline(category),
                    oneSentencePromise: this.generatePromise(category),
                    offerStartDate: new Date().toISOString().split('T')[0],
                    offerEndDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    scarcityMechanism: randomChoice(scarcityTypes),
                    riskReversal: '30-day satisfaction guarantee. If not happy, we\'ll redo the work at no charge.',
                    whatsIncluded: this.generateWhatsIncluded(category),
                    whatsNotIncluded: 'Additional wiring beyond 10 feet, custom mounting brackets, premium equipment upgrades.',
                    eligibilityRules: this.generateEligibility(category),
                    redemptionRules: 'Book online only. Use promo code at checkout. Valid for new customers only.',
                    dreamOutcome: this.generateDreamOutcome(category),
                    likelihoodOfAchievement: 'Proven process with 500+ installations. Licensed and insured technicians.',
                    timeDelay: this.generateTimeDelay(category),
                    effortSacrifice: 'No need to research installers, buy tools, or risk DIY mistakes. We handle everything.',
                    competitorPriceRange: this.generateCompetitorRange(category),
                    howWereDifferent: 'Not just cheaper—faster, guaranteed, and fully insured. Same-day service available.',
                    whyChooseUs: 'Licensed pros with 4.9/5 rating. We show up on time, clean up after, and guarantee our work.',
                    bookingPageMicrocopy: 'Limited time offer. Book your installation today and save. Professional service, guaranteed satisfaction.',
                    smsConfirmation: `Your ${category.toLowerCase()} installation is confirmed! We'll text you 24h before with arrival time.`,
                    smsReminder24h: 'Reminder: Your installation is tomorrow. We\'ll arrive between 9am-12pm. Reply STOP to opt out.',
                    priceQuestionLine: 'Our price includes professional installation, all materials, and a satisfaction guarantee. Best value in town.',
                    techBroadcastMessage: `New ${category} offer active. Follow standard installation checklist. Upsell opportunities: wire management, extended warranty.`,
                    hooks: this.generateHooks(category),
                    objectionsRebuttals: this.generateObjections(category),
                    proofIdeas: ['Customer testimonials (4.9/5 stars)', 'Before/after photos', '30-day guarantee badge'],
                    whatToSayInHome: this.generateWhatToSay(category),
                    specialInstructions: 'Take before photos. Check wall type and stud location. Offer wire management upgrade if applicable.',
                    capacityAssumption: '3-4 jobs per day per tech',
                    cancellationRisks: 'Weather delays, wall type incompatibility, customer not home, access issues.',
                    bestCaseOutcome: `Book 20+ ${category.toLowerCase()} installations this month with 40%+ margins.`,
                    worstCaseRisk: 'Low booking rate if pricing too aggressive. Margin compression if materials cost spike.',
                    confidenceScore: 7,
                    confidenceWhy: 'Strong offer structure, realistic pricing, proven category demand.',
                    marginBreakPoints: 'Materials cost increase, travel distance >20mi, complex wall types requiring extra time.',
                    safeguards: 'Cap travel distance. Require wall type photos before booking. Lock in material costs upfront.',
                    paymentProcessingFees: 2.9,
                    travelOtherVariableCost: 15
                };
                
                // Add services based on category
                if (category === 'TV Mount') {
                    sample.lineItems = [
                        { id: '1', serviceId: 'tv-install', name: 'TV Installation', qty: randomInt(3) + 1, baseUnitPrice: 150, equipCostPerUnit: 0, equipMode: 'BYO', isIncludedInOffer: true, notes: '' }
                    ];
                    if (random() > 0.5) {
                        sample.lineItems.push({ id: '2', serviceId: 'soundbar-mount', name: 'Soundbar Mount', qty: 1, baseUnitPrice: 75, equipCostPerUnit: 0, equipMode: 'BYO', isIncludedInOffer: true, notes: 'Add-on' });
                    }
                } else if (category === 'Cameras') {
                    const cameraCount = randomInt(5) + 2;
                    sample.lineItems = [
                        { id: '1', serviceId: 'security-system', name: 'Security System Install', qty: cameraCount, baseUnitPrice: Math.round(500 / cameraCount), equipCostPerUnit: Math.round(300 / cameraCount), equipMode: 'included', isIncludedInOffer: true, notes: `${cameraCount} cameras` }
                    ];
                } else if (category === 'Doorbell') {
                    sample.lineItems = [
                        { id: '1', serviceId: 'doorbell-camera', name: 'Doorbell Camera Install', qty: 1, baseUnitPrice: 200, equipCostPerUnit: 150, equipMode: 'included', isIncludedInOffer: true, notes: '' }
                    ];
                } else if (category === 'WiFi') {
                    sample.lineItems = [
                        { id: '1', serviceId: 'wifi-setup', name: 'WiFi Setup / Mesh Network', qty: 1, baseUnitPrice: 250, equipCostPerUnit: 0, equipMode: 'BYO', isIncludedInOffer: true, notes: 'Mesh system setup' }
                    ];
                } else {
                    sample.lineItems = [
                        { id: '1', serviceId: 'tv-install', name: 'TV Installation', qty: 1, baseUnitPrice: 150, equipCostPerUnit: 0, equipMode: 'BYO', isIncludedInOffer: true, notes: '' },
                        { id: '2', serviceId: 'doorbell-camera', name: 'Doorbell Camera Install', qty: 1, baseUnitPrice: 200, equipCostPerUnit: 150, equipMode: 'included', isIncludedInOffer: true, notes: '' }
                    ];
                }
                
                // Pricing strategy
                const strategies = ['sum', 'percentOff', 'dollarOff', 'bundlePrice'];
                sample.pricingStrategy = randomChoice(strategies);
                const subtotal = sample.lineItems.reduce((sum, item) => sum + (item.baseUnitPrice * item.qty), 0);
                
                if (sample.pricingStrategy === 'percentOff') {
                    sample.percentOff = randomInt(25) + 10; // 10-35% off
                } else if (sample.pricingStrategy === 'dollarOff') {
                    sample.dollarOff = Math.floor(subtotal * 0.15);
                } else if (sample.pricingStrategy === 'bundlePrice') {
                    sample.bundlePrice = Math.floor(subtotal * 0.85);
                }
                
                return sample;
            },
            
            generateHeadline(category) {
                const headlines = {
                    'TV Mount': ['Get Your TV Mounted in 24 Hours', 'Professional TV Mounting Same Day', 'TV Mounted Today, No Hassle'],
                    'Cameras': ['Complete Security System Installed Today', 'Get Protected in 24 Hours', 'Professional Camera Installation Same Day'],
                    'Doorbell': ['Smart Doorbell Installed Today', 'Get Your Doorbell Camera in 24 Hours', 'Professional Doorbell Install Same Day'],
                    'WiFi': ['WiFi Setup Done Right, Same Day', 'Get Fast WiFi Today', 'Professional WiFi Setup in 24 Hours'],
                    'Bundle': ['Complete Smart Home Setup Today', 'Get Everything Installed Same Day', 'Full Installation Package in 24 Hours']
                };
                const options = headlines[category] || headlines['TV Mount'];
                // Use a simple hash of category for consistent selection if seed is used
                return options[Math.floor(Math.random() * options.length)];
            },
            
            generatePromise(category) {
                const promises = {
                    'TV Mount': 'Professional installation in under 2 hours, guaranteed perfect level and secure mounting.',
                    'Cameras': 'Complete security system installed and configured in one visit, with mobile app setup included.',
                    'Doorbell': 'Smart doorbell installed and connected to your phone in under 90 minutes, guaranteed.',
                    'WiFi': 'Fast, reliable WiFi throughout your home, professionally configured and tested same day.',
                    'Bundle': 'Complete smart home setup in one visit, everything working and connected to your phone.'
                };
                return promises[category] || promises['TV Mount'];
            },
            
            generateWhatsIncluded(category) {
                if (category === 'TV Mount') return 'Professional mounting, leveling, cable management, basic wall patching if needed.';
                if (category === 'Cameras') return 'Camera installation, wiring (up to 10ft), mobile app setup, basic configuration.';
                if (category === 'Doorbell') return 'Doorbell installation, wiring connection, mobile app setup, video testing.';
                if (category === 'WiFi') return 'Router/mesh setup, network configuration, speed testing, device connection help.';
                return 'Professional installation, setup, and configuration of all included services.';
            },
            
            generateEligibility(category) {
                if (category === 'TV Mount') return 'Standard drywall or stud walls. TV up to 85". Height restrictions may apply for very high mounts.';
                if (category === 'Cameras') return 'Standard home construction. Access to power and mounting locations required.';
                if (category === 'Doorbell') return 'Existing doorbell wiring or power access required. Standard door frame compatibility.';
                if (category === 'WiFi') return 'Home with existing internet service. Access to router location required.';
                return 'Standard home installation. Access and compatibility requirements apply.';
            },
            
            generateDreamOutcome(category) {
                if (category === 'TV Mount') return 'Perfect viewing angle, no visible wires, secure mounting you can trust.';
                if (category === 'Cameras') return 'Complete home security, peace of mind, remote monitoring from anywhere.';
                if (category === 'Doorbell') return 'See who\'s at your door from anywhere, package protection, visitor alerts.';
                if (category === 'WiFi') return 'Fast, reliable internet in every room, no dead zones, seamless streaming.';
                return 'Complete smart home setup, everything working perfectly, controlled from your phone.';
            },
            
            generateTimeDelay(category) {
                return category === 'WiFi' ? 'Same day' : '24 hours';
            },
            
            generateCompetitorRange(category) {
                const ranges = {
                    'TV Mount': '$200-$400',
                    'Cameras': '$800-$1500',
                    'Doorbell': '$300-$500',
                    'WiFi': '$200-$400',
                    'Bundle': '$1000-$2000'
                };
                return ranges[category] || '$200-$500';
            },
            
            generateHooks(category) {
                return [
                    `Get your ${category.toLowerCase()} installed today`,
                    'Professional service, guaranteed satisfaction',
                    'No DIY headaches, we handle everything',
                    'Licensed and insured technicians',
                    'Same-day service available'
                ];
            },
            
            generateObjections(category) {
                return [
                    'Too expensive → Our price includes everything: installation, materials, and guarantee. Competitors charge extra.',
                    'Can do it myself → Save 4+ hours and avoid costly mistakes. We guarantee perfect results.',
                    'Not sure I need it → Free consultation included. See the value before you commit.'
                ];
            },
            
            generateWhatToSay(category) {
                return [
                    'Highlight the guarantee and same-day service',
                    'Show before/after photos if available',
                    'Mention the included mobile app setup'
                ];
            },
            
            async generateSampleOffer() {
                // Check if user has typed anything
                const hasContent = this.offer.name || 
                    this.offer.lineItems.length > 0 || 
                    this.offer.headline || 
                    document.getElementById('offerBuilderName')?.value ||
                    document.getElementById('offerBuilderHeadline')?.value;
                
                if (hasContent) {
                    const confirmed = await showConfirm('Overwrite Draft?', 'This will populate all fields with a sample offer. Continue?');
                    if (!confirmed) return;
                }
                
                const sample = this.generateSampleOfferData();
                // Mark as sample offer
                this.offer.isSample = true;
                this.applyOfferToUI(sample, { keepNumbers: false });
                
                // Show sample indicator
                showToast('Sample offer generated. Review and adjust as needed, then click "Save Offer" to keep it.', 'success');
                
                // Recalculate and scroll to standards
                setTimeout(() => {
                    this.recalculateOffer();
                    setTimeout(() => {
                        const standardsEl = document.getElementById('offerBuilderStandards');
                        if (standardsEl) {
                            standardsEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }, 100);
            },
            
            applyOfferToUI(sample, { keepNumbers }) {
                // Always update messaging/copy fields
                if (sample.name) {
                    const nameEl = document.getElementById('offerBuilderName');
                    if (nameEl) {
                        nameEl.value = sample.name;
                        this.updateOfferName(sample.name);
                    }
                }
                
                if (!keepNumbers) {
                    // Clear existing line items
                    this.offer.lineItems = [];
                    this.renderLineItems();
                    
                    // Add new services
                    sample.lineItems.forEach(item => {
                        const service = this.serviceCatalog.find(s => s.id === item.serviceId) || this.serviceCatalog[0];
                        if (service) {
                            const lineItem = {
                                id: Date.now().toString() + Math.random(),
                                serviceId: item.serviceId,
                                name: item.name,
                                qty: item.qty,
                                baseUnitPrice: item.baseUnitPrice,
                                equipCostPerUnit: item.equipCostPerUnit,
                                equipMode: item.equipMode,
                                isIncludedInOffer: true,
                                notes: item.notes || ''
                            };
                            this.offer.lineItems.push(lineItem);
                        }
                    });
                    this.renderLineItems();
                    
                    // Update pricing strategy
                    this.offer.pricingStrategy = sample.pricingStrategy;
                    this.updatePricingStrategy(sample.pricingStrategy);
                    
                    if (sample.percentOff) {
                        this.offer.percentOff = sample.percentOff;
                        const el = document.getElementById('offerBuilderPercentOff');
                        if (el) el.value = sample.percentOff;
                    }
                    if (sample.dollarOff) {
                        this.offer.dollarOff = sample.dollarOff;
                        const el = document.getElementById('offerBuilderDollarOff');
                        if (el) el.value = sample.dollarOff;
                    }
                    if (sample.bundlePrice) {
                        this.offer.bundlePrice = sample.bundlePrice;
                        const el = document.getElementById('offerBuilderBundlePrice');
                        if (el) el.value = sample.bundlePrice;
                    }
                }
                
                // Update all messaging fields
                const fieldMap = {
                    category: 'offerBuilderCategory',
                    market: 'offerBuilderMarket',
                    primaryAvatar: 'offerBuilderPrimaryAvatar',
                    intendedGoal: 'offerBuilderIntendedGoal',
                    headline: 'offerBuilderHeadline',
                    oneSentencePromise: 'offerBuilderOneSentencePromise',
                    offerStartDate: 'offerBuilderOfferStartDate',
                    offerEndDate: 'offerBuilderOfferEndDate',
                    scarcityMechanism: 'offerBuilderScarcityMechanism',
                    riskReversal: 'offerBuilderRiskReversal',
                    whatsIncluded: 'offerBuilderWhatsIncluded',
                    whatsNotIncluded: 'offerBuilderWhatsNotIncluded',
                    eligibilityRules: 'offerBuilderEligibilityRules',
                    redemptionRules: 'offerBuilderRedemptionRules',
                    dreamOutcome: 'offerBuilderDreamOutcome',
                    likelihoodOfAchievement: 'offerBuilderLikelihoodOfAchievement',
                    timeDelay: 'offerBuilderTimeDelay',
                    effortSacrifice: 'offerBuilderEffortSacrifice',
                    competitorPriceRange: 'offerBuilderCompetitorPriceRange',
                    howWereDifferent: 'offerBuilderHowWereDifferent',
                    whyChooseUs: 'offerBuilderWhyChooseUs',
                    bookingPageMicrocopy: 'offerBuilderBookingPageMicrocopy',
                    smsConfirmation: 'offerBuilderSmsConfirmation',
                    smsReminder24h: 'offerBuilderSmsReminder24h',
                    priceQuestionLine: 'offerBuilderPriceQuestionLine',
                    techBroadcastMessage: 'offerBuilderTechBroadcastMessage',
                    specialInstructions: 'offerBuilderSpecialInstructions',
                    capacityAssumption: 'offerBuilderCapacityAssumption',
                    cancellationRisks: 'offerBuilderCancellationRisks',
                    bestCaseOutcome: 'offerBuilderBestCaseOutcome',
                    worstCaseRisk: 'offerBuilderWorstCaseRisk',
                    confidenceWhy: 'offerBuilderConfidenceWhy',
                    marginBreakPoints: 'offerBuilderMarginBreakPoints',
                    safeguards: 'offerBuilderSafeguards'
                };
                
                Object.keys(fieldMap).forEach(key => {
                    if (sample[key] !== undefined) {
                        const el = document.getElementById(fieldMap[key]);
                        if (el) {
                            if (el.tagName === 'SELECT') {
                                el.value = sample[key];
                                el.dispatchEvent(new Event('change'));
                            } else if (el.tagName === 'TEXTAREA') {
                                el.value = sample[key];
                                el.dispatchEvent(new Event('input'));
                            } else {
                                el.value = sample[key];
                                el.dispatchEvent(new Event('input'));
                            }
                            this.updateField(key, sample[key]);
                        }
                    }
                });
                
                // Handle arrays
                if (sample.hooks && Array.isArray(sample.hooks)) {
                    const el = document.getElementById('offerBuilderHooks');
                    if (el) {
                        el.value = sample.hooks.join('\\n');
                        this.updateField('hooks', sample.hooks);
                    }
                }
                if (sample.objectionsRebuttals && Array.isArray(sample.objectionsRebuttals)) {
                    const el = document.getElementById('offerBuilderObjectionsRebuttals');
                    if (el) {
                        el.value = sample.objectionsRebuttals.join('\\n');
                        this.updateField('objectionsRebuttals', sample.objectionsRebuttals);
                    }
                }
                if (sample.proofIdeas && Array.isArray(sample.proofIdeas)) {
                    const el = document.getElementById('offerBuilderProofIdeas');
                    if (el) {
                        el.value = sample.proofIdeas.join('\\n');
                        this.updateField('proofIdeas', sample.proofIdeas);
                    }
                }
                if (sample.whatToSayInHome && Array.isArray(sample.whatToSayInHome)) {
                    const el = document.getElementById('offerBuilderWhatToSayInHome');
                    if (el) {
                        el.value = sample.whatToSayInHome.join('\\n');
                        this.updateField('whatToSayInHome', sample.whatToSayInHome);
                    }
                }
                
                // Handle confidence score
                if (sample.confidenceScore !== undefined) {
                    const el = document.getElementById('offerBuilderConfidenceScore');
                    if (el) {
                        el.value = sample.confidenceScore;
                        this.updateField('confidenceScore', sample.confidenceScore);
                    }
                }
            },
            
            renderLineItems() {
                const container = document.getElementById('offerBuilderLineItems');
                const emptyState = document.getElementById('offerBuilderEmptyState');
                
                if (!container) return;
                
                if (this.offer.lineItems.length === 0) {
                    container.innerHTML = '';
                    if (emptyState) emptyState.style.display = 'block';
                    return;
                }
                
                if (emptyState) emptyState.style.display = 'none';
                
                container.innerHTML = this.offer.lineItems.map((item, index) => {
                    // Ensure BYO mode has 0 cost
                    if (item.equipMode === 'BYO') {
                        item.equipCostPerUnit = 0;
                    }
                    
                    const allServices = [...this.serviceCatalog, ...this.getCustomServices()];
                    const service = allServices.find(s => s.id === item.serviceId);
                    const lineTotal = item.baseUnitPrice * item.qty;
                    const equipTotal = item.equipCostPerUnit * item.qty;
                    
                    return `
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--cobalt)'; this.style.boxShadow='0 2px 8px rgba(10,42,90,0.1)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <div style="font-size: 17px; font-weight: 700; color: var(--cobalt); margin-bottom: 6px;">${item.name}</div>
                                ${item.baseUnitPrice === 0 ? `
                                    <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 8px 10px; margin-bottom: 6px; border-radius: 4px;">
                                        <div style="font-size: 12px; color: #92400e; font-weight: 600;">⚠️ Enter your price below</div>
                                        ${service && service.benchmarkPrice ? `<div style="font-size: 11px; color: #78350f; margin-top: 2px;">Industry Reference: ${service.benchmarkPrice}</div>` : ''}
                                    </div>
                                ` : `
                                    <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
                                        Your Price: <strong style="color: #374151;">$${item.baseUnitPrice.toFixed(2)}</strong>
                                        ${service && service.benchmarkPrice ? ` <span style="color: #9ca3af;">(Industry: ${service.benchmarkPrice})</span>` : ''}
                                    </div>
                                `}
                                ${item.notes ? `<div style="font-size: 12px; color: #6b7280; font-style: italic; margin-top: 4px;">${item.notes}</div>` : ''}
                            </div>
                            <button onclick="offerBuilder.removeLineItem('${item.id}')" style="padding: 8px 14px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ef4444'; this.style.transform='scale(1)'">
                                Remove
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">What's Your Price? <span style="color: #ef4444;">*</span></label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #6b7280; font-weight: 600;">$</span>
                                    <input type="number" value="${item.baseUnitPrice}" min="0" step="0.01" placeholder="0.00" onchange="offerBuilder.updateLineItem('${item.id}', 'baseUnitPrice', this.value)" style="width: 100%; padding: 10px 10px 10px 28px; border: 2px solid ${item.baseUnitPrice === 0 ? '#f59e0b' : '#e5e7eb'}; border-radius: 8px; font-size: 15px; font-weight: 600; color: var(--cobalt);">
                                </div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Your labor charge to the customer</div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Quantity</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button onclick="offerBuilder.updateLineItem('${item.id}', 'qty', Math.max(1, ${item.qty} - 1))" style="width: 36px; height: 36px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; color: var(--cobalt); transition: all 0.2s;" onmouseover="this.style.borderColor='var(--cobalt)'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">−</button>
                                    <input type="number" value="${item.qty}" min="1" onchange="offerBuilder.updateLineItem('${item.id}', 'qty', this.value)" style="width: 70px; padding: 8px; text-align: center; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--cobalt);">
                                    <button onclick="offerBuilder.updateLineItem('${item.id}', 'qty', ${item.qty} + 1)" style="width: 36px; height: 36px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; color: var(--cobalt); transition: all 0.2s;" onmouseover="this.style.borderColor='var(--cobalt)'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Equipment</label>
                                <select onchange="offerBuilder.updateLineItem('${item.id}', 'equipMode', this.value)" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                                    <option value="included" ${item.equipMode === 'included' ? 'selected' : ''}>We Provide</option>
                                    <option value="BYO" ${item.equipMode === 'BYO' ? 'selected' : ''}>Customer Provides</option>
                                    <option value="custom" ${item.equipMode === 'custom' ? 'selected' : ''}>Custom Cost</option>
                                </select>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                    ${item.equipMode === 'included' ? 'Enter cost per unit below' : item.equipMode === 'BYO' ? 'No equipment cost' : 'Set custom cost per unit'}
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt);">Equipment Cost <span style="font-weight: 400; color: #6b7280; font-size: 11px;">(per unit)</span></label>
                                    ${item.equipMode !== 'BYO' ? `
                                        <button type="button" onclick="offerBuilder.estimateEquipmentCost('${item.id}')" style="padding: 4px 10px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; color: var(--cobalt); transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                            AI Estimate
                                        </button>
                                    ` : ''}
                                </div>
                                <input type="number" value="${item.equipCostPerUnit}" min="0" step="0.01" ${item.equipMode === 'BYO' ? 'disabled' : ''} onchange="offerBuilder.updateLineItem('${item.id}', 'equipCostPerUnit', this.value)" placeholder="0.00" style="width: 100%; padding: 8px; border: 2px solid ${item.equipMode === 'BYO' ? '#d1d5db' : '#e5e7eb'}; border-radius: 8px; font-size: 13px; ${item.equipMode === 'BYO' ? 'background: #f3f4f6; color: #9ca3af;' : ''}">
                                ${item.equipEstimate ? `
                                    <div style="background: ${item.equipEstimate.confidence === 'high' ? '#d1fae5' : item.equipEstimate.confidence === 'medium' ? '#fef3c7' : '#fee2e2'}; border: 1px solid ${item.equipEstimate.confidence === 'high' ? '#a7f3d0' : item.equipEstimate.confidence === 'medium' ? '#fde68a' : '#fecaca'}; border-radius: 6px; padding: 10px; margin-top: 6px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="font-size: 11px; font-weight: 600; color: ${item.equipEstimate.confidence === 'high' ? '#065f46' : item.equipEstimate.confidence === 'medium' ? '#92400e' : '#991b1b'};">
                                                AI Estimate (${item.equipEstimate.confidence} confidence)
                                            </div>
                                            <button onclick="offerBuilder.clearEquipmentEstimate('${item.id}')" style="padding: 2px 6px; background: transparent; border: none; cursor: pointer; font-size: 12px; color: #6b7280; font-weight: 700;">×</button>
                                        </div>
                                        <div style="font-size: 12px; font-weight: 700; color: var(--cobalt); margin-bottom: 4px;">
                                            $${item.equipEstimate.estimatedCost.toFixed(2)} (Range: $${item.equipEstimate.costRange.min.toFixed(2)} - $${item.equipEstimate.costRange.max.toFixed(2)})
                                        </div>
                                        ${item.equipEstimate.notes ? `<div style="font-size: 11px; color: #374151; line-height: 1.4; margin-bottom: 6px;">${item.equipEstimate.notes}</div>` : ''}
                                        ${item.equipEstimate.equipmentItems && item.equipEstimate.equipmentItems.length > 0 ? `
                                            <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;"><strong>Equipment:</strong> ${item.equipEstimate.equipmentItems.join(', ')}</div>
                                        ` : ''}
                                        <button onclick="offerBuilder.applyEquipmentEstimate('${item.id}')" style="width: 100%; padding: 6px; background: var(--cobalt); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; margin-top: 6px; transition: all 0.2s;" onmouseover="this.style.background='#1a4a8a'" onmouseout="this.style.background='var(--cobalt)'">
                                            Apply $${item.equipEstimate.estimatedCost.toFixed(2)}
                                        </button>
                                    </div>
                                ` : service && service.benchmarkEquip && item.equipMode !== 'BYO' ? `
                                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; padding: 8px; margin-top: 6px;">
                                        <div style="font-size: 11px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Industry Reference:</div>
                                        <div style="font-size: 11px; color: #374151; line-height: 1.4;">${service.benchmarkEquip}</div>
                                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px; font-style: italic;">Use as a guide. Do specific research if needed for your exact equipment.</div>
                                    </div>
                                ` : item.equipMode !== 'BYO' ? `
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 6px; padding: 8px; background: #f9fafb; border-radius: 6px;">
                                        Enter the cost per unit of equipment you'll provide. Use "AI Estimate" above for a cost range estimate, or do specific research if needed.
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="background: #f9fafb; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
                                <div>
                                    <div style="color: #6b7280; margin-bottom: 2px;">Service Total</div>
                                    <div style="font-weight: 700; font-size: 14px; color: var(--cobalt);">$${lineTotal.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280; margin-bottom: 2px;">Equipment Total</div>
                                    <div style="font-weight: 700; font-size: 14px; color: ${item.equipMode === 'BYO' ? '#9ca3af' : '#374151'};">$${equipTotal.toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-style: italic;">
                                Note: Tech payout (35%) is calculated on the final customer price, shown in Offer Totals panel.
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Notes (optional)</label>
                            <input type="text" value="${item.notes || ''}" placeholder="Add notes about this service..." onchange="offerBuilder.updateLineItem('${item.id}', 'notes', this.value)" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                        </div>
                    </div>
                `;
                }).join('');
            },
            
            getCustomServices() {
                try {
                    return JSON.parse(localStorage.getItem('h2s_custom_services_v1') || '[]');
                } catch (e) {
                    return [];
                }
            },
            
            saveCustomService(service) {
                const custom = this.getCustomServices();
                service.id = service.id || 'custom_' + Date.now();
                custom.push(service);
                localStorage.setItem('h2s_custom_services_v1', JSON.stringify(custom));
            },
            
            showAddServiceModal() {
                const customServices = this.getCustomServices();
                const allServices = [...this.serviceCatalog, ...customServices];
                
                const modalHtml = `
                    <div style="padding: 24px;">
                        <h3 style="font-size: 22px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Choose a Service</h3>
                        <p style="font-size: 13px; color: #6b7280; margin: 0 0 20px 0;">Pick from our standard services below, or create your own custom service.</p>
                        
                        <button onclick="offerBuilder.showCreateCustomServiceModal()" style="width: 100%; padding: 14px; margin-bottom: 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#d97706'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.background='#f59e0b'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            ✨ Create Custom Service
                        </button>
                        
                        <div style="border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 4px;">
                            <div style="font-size: 13px; font-weight: 700; color: var(--cobalt); margin-bottom: 14px;">📋 Standard Services</div>
                            <div style="display: flex; flex-direction: column; gap: 10px; max-height: 50vh; overflow-y: auto; padding-right: 4px;">
                                ${allServices.map(s => {
                                    return `
                                    <button onclick="offerBuilder.addLineItem('${s.id}'); closeModal();" style="width: 100%; padding: 16px; text-align: left; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--cobalt)'; this.style.background='#f0f9ff'; this.style.boxShadow='0 4px 12px rgba(10,42,90,0.1)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'; this.style.boxShadow='none'">
                                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; font-size: 15px; color: var(--cobalt); margin-bottom: 4px;">
                                                    ${s.name}
                                                    ${s.id && s.id.startsWith('custom_') ? '<span style="display: inline-block; margin-left: 6px; padding: 2px 8px; font-size: 10px; color: #f59e0b; background: #fef3c7; border-radius: 4px; font-weight: 600;">YOUR CUSTOM</span>' : ''}
                                                </div>
                                                ${s.benchmarkPrice ? `<div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">💡 Industry Reference: ${s.benchmarkPrice}</div>` : ''}
                                                ${s.benchmarkEquip ? `<div style="font-size: 11px; color: #6b7280; font-style: italic;">🔧 Equipment: ${s.benchmarkEquip}</div>` : ''}
                                            </div>
                                            <div style="padding: 4px 12px; background: var(--cobalt); color: white; border-radius: 6px; font-size: 11px; font-weight: 600; align-self: center; white-space: nowrap;">
                                                Add →
                                            </div>
                                        </div>
                                    </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                showModal('Add Service', modalHtml, { width: '600px', maxHeight: '85vh', html: true });
            },
            
            showCreateCustomServiceModal() {
                const modalHtml = `
                    <div style="padding: 24px;">
                        <h3 style="font-size: 22px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Create Your Own Service</h3>
                        <p style="font-size: 13px; color: #6b7280; margin: 0 0 20px 0;">Don't see what you need? Create a custom service with your own pricing.</p>
                        <form id="customServiceForm" onsubmit="event.preventDefault(); offerBuilder.createCustomService();">
                            <div style="display: flex; flex-direction: column; gap: 18px;">
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">What's the service called? <span style="color: #ef4444;">*</span></label>
                                    <input type="text" id="customServiceName" required placeholder="e.g., Premium Outdoor Camera Setup" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Give it a clear, descriptive name</div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Category</label>
                                    <select id="customServiceCategory" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                        <option value="">Select...</option>
                                        <option value="TV Mount">TV Mount</option>
                                        <option value="Cameras">Cameras</option>
                                        <option value="Doorbell">Doorbell</option>
                                        <option value="WiFi">WiFi</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">What's your price? <span style="color: #ef4444;">*</span></label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #6b7280;">$</span>
                                        <input type="number" id="customServiceBasePrice" required min="0" step="0.01" placeholder="150.00" style="width: 100%; padding: 12px 12px 12px 28px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">This is what you'll charge the customer for your labor</div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Who provides the equipment?</label>
                                    <select id="customServiceEquipMode" onchange="document.getElementById('customServiceEquipCost').style.display = this.value === 'BYO' ? 'none' : 'block';" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                        <option value="BYO">Customer brings it (most common)</option>
                                        <option value="included">We provide it (add equipment cost below)</option>
                                        <option value="custom">Custom arrangement</option>
                                    </select>
                                </div>
                                <div id="customServiceEquipCost" style="display: none;">
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">What's the equipment cost?</label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #6b7280;">$</span>
                                        <input type="number" id="customServiceEquipCostValue" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px 12px 12px 28px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">💡 The actual cost of cameras, mounts, cables, etc. This gets added to your labor price.</div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Industry Benchmark (optional)</label>
                                    <input type="text" id="customServiceBenchmark" placeholder="e.g., Industry: $100-$200" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Notes (optional)</label>
                                    <textarea id="customServiceNotes" placeholder="Any additional notes about this service" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; min-height: 60px; resize: vertical;"></textarea>
                                </div>
                                <div style="display: flex; gap: 12px; margin-top: 8px;">
                                    <button type="submit" style="flex: 1; padding: 12px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Create & Add</button>
                                    <button type="button" onclick="closeModal(); offerBuilder.showAddServiceModal();" style="flex: 1; padding: 12px; background: #f3f4f6; color: var(--cobalt); border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal('Create Custom Service', modalHtml, { width: '550px', html: true });
            },
            
            createCustomService() {
                const name = document.getElementById('customServiceName')?.value.trim();
                const basePrice = parseFloat(document.getElementById('customServiceBasePrice')?.value || 0);
                const equipMode = document.getElementById('customServiceEquipMode')?.value || 'BYO';
                const equipCost = equipMode === 'BYO' ? 0 : parseFloat(document.getElementById('customServiceEquipCostValue')?.value || 0);
                const category = document.getElementById('customServiceCategory')?.value || '';
                const benchmark = document.getElementById('customServiceBenchmark')?.value || '';
                const notes = document.getElementById('customServiceNotes')?.value || '';
                
                if (!name || basePrice <= 0) {
                    showToast('Service name and base price are required', 'error');
                    return;
                }
                
                const customService = {
                    id: 'custom_' + Date.now(),
                    name: name,
                    basePrice: basePrice,
                    baseUnitPrice: basePrice,
                    defaultEquipCost: equipCost,
                    equipCostPerUnit: equipCost,
                    equipMode: equipMode,
                    category: category,
                    benchmarkPrice: benchmark || undefined,
                    notes: notes
                };
                
                this.saveCustomService(customService);
                showToast('Custom service created!', 'success');
                closeModal();
                
                // Add it to the offer immediately
                this.addLineItem(customService.id);
            },
            
            showHelp() {
                const helpHtml = `
                    <div style="max-width: 800px; max-height: 85vh; overflow-y: auto; padding: 24px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; position: relative;">
                        <button onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; background: #f3f4f6; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: 700; color: #6b7280; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='#e5e7eb'; this.style.color='#374151'" onmouseout="this.style.background='#f3f4f6'; this.style.color='#6b7280'">×</button>
                        <h2 style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin: 0 0 8px 0; border-bottom: 3px solid var(--cobalt); padding-bottom: 12px; padding-right: 40px;">How to Use the Offer Builder</h2>
                        <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">Follow these steps to create a complete offer that's ready to use.</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            <!-- Step 1 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 1: Give Your Offer a Name</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    At the top, type a name for your offer. Make it clear what the offer is about. For example: "Spring Security Bundle" or "TV Mounting Special".
                                </p>
                            </div>
                            
                            <!-- Step 2 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 2: Add Services and Add-ons</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 12px 0;">
                                    <strong>What does this mean?</strong> This is where you list all the services that will be included in your offer. Think of it like a shopping cart.
                                </p>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    For example, if you're creating a "Security Bundle" offer, you might add:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li>3 Security Camera Installations</li>
                                    <li>1 Doorbell Camera Installation</li>
                                    <li>1 Wire Management Service</li>
                                </ul>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    <strong>How to add services:</strong>
                                </p>
                                <ol style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0; padding-left: 24px;">
                                    <li>Click the "Add Service" button</li>
                                    <li>Pick a service from the list (like "TV Installation" or "Security Camera")</li>
                                    <li>The service will appear in your list</li>
                                    <li>You can change the quantity, price, and equipment settings for each service</li>
                                </ol>
                            </div>
                            
                            <!-- Step 3 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 3: Set Your Pricing Strategy</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 12px 0;">
                                    Choose how you want to price this offer:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li><strong>Sum of all services (no discount):</strong> Customer pays the full price of all services added together</li>
                                    <li><strong>Percentage off:</strong> Give a discount like 10% or 20% off the total</li>
                                    <li><strong>Dollar amount off:</strong> Take a fixed amount off, like $50 off</li>
                                    <li><strong>Fixed bundle price:</strong> Set one total price for everything, no matter what services are included</li>
                                </ul>
                                <p style="font-size: 13px; color: #6b7280; line-height: 1.6; margin: 8px 0 0 0; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <strong>Important:</strong> No matter what discount you give, the tech always gets paid 35% of the original service price. If you give a discount, the customer pays less, but the tech still gets the same amount.
                                </p>
                            </div>
                            
                            <!-- Step 4 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 4: Equipment Costs</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 12px 0;">
                                    For each service, you need to decide about equipment:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li><strong>Included:</strong> You provide the equipment (like a camera or smart lock). Enter how much it costs you.</li>
                                    <li><strong>BYO (Bring Your Own):</strong> The customer provides the equipment. No cost to you.</li>
                                    <li><strong>Custom:</strong> You can set a custom equipment cost if needed.</li>
                                </ul>
                                <p style="font-size: 13px; color: #6b7280; line-height: 1.6; margin: 8px 0 0 0; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <strong>Industry prices:</strong> When you add a service, you'll see typical industry prices. Use these as a guide, but you can change them to match your actual costs.
                                </p>
                            </div>
                            
                            <!-- Step 5 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 5: Fill in the Messaging</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    Click "Offer Messaging & Framing" to expand it. You'll see tabs for different sections:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li><strong>Snapshot:</strong> Basic info like category, market, headline, and dates</li>
                                    <li><strong>Value Equation:</strong> Why this offer is good for customers</li>
                                    <li><strong>Messaging Pack:</strong> Copy you can use in ads, texts, and booking pages</li>
                                    <li><strong>Creative Angles:</strong> Hooks and ideas for making ads</li>
                                    <li><strong>Ops Notes:</strong> Instructions for technicians</li>
                                    <li><strong>Decision Notes:</strong> Your thoughts on best-case and worst-case outcomes</li>
                                </ul>
                            </div>
                            
                            <!-- Step 6 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 6: Check the Standards Panel</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    On the right side, you'll see a "Standards" panel. This tells you:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li>If your offer is complete or needs fixes</li>
                                    <li>A score from 0 to 100</li>
                                    <li>What to fix next</li>
                                    <li>Any problems that need attention</li>
                                </ul>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 8px 0 0 0;">
                                    Click on any issue to jump to the field that needs fixing.
                                </p>
                            </div>
                            
                            <!-- Step 7 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 7: Review Offer Totals</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    Below the Standards panel, you'll see "Offer Totals". This shows:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li><strong>Subtotal Base:</strong> Total of all services before any discount</li>
                                    <li><strong>Customer Price:</strong> What the customer will pay (after discount)</li>
                                    <li><strong>Tech Payout:</strong> How much the tech gets (35% of customer price)</li>
                                    <li><strong>Equipment Cost:</strong> Total cost of all equipment</li>
                                    <li><strong>Profit:</strong> How much money you make</li>
                                    <li><strong>Margin:</strong> Profit as a percentage</li>
                                </ul>
                            </div>
                            
                            <!-- Step 8 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 8: Generate Your Brief</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    Once your offer is complete and passes the Standards check:
                                </p>
                                <ol style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0; padding-left: 24px;">
                                    <li>Click "Generate Brief" to create a document with all your offer details</li>
                                    <li>Review the preview</li>
                                    <li>Click "Export PDF" to download it</li>
                                    <li>When everything looks good, click "Mark Ready" to finalize your offer</li>
                                </ol>
                            </div>
                            
                            <!-- Tips -->
                            <div style="background: #fff7ed; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px; margin-top: 8px;">
                                <h3 style="font-size: 16px; font-weight: 700; color: #92400e; margin: 0 0 12px 0;">Quick Tips</h3>
                                <ul style="font-size: 14px; color: #78350f; line-height: 1.8; margin: 0; padding-left: 24px;">
                                    <li>Use "Fill Sample Offer" to see an example of a complete offer</li>
                                    <li>Check the build order strip at the top to see your progress</li>
                                    <li>Save your work often using "Save Offer"</li>
                                    <li>If profit is negative (red), adjust your pricing or reduce costs</li>
                                    <li>Make sure equipment costs are filled in if you're providing equipment</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal('How to Use Offer Builder', helpHtml, { width: '850px', maxHeight: '90vh', html: true });
            },
            
            async saveOffer() {
                const warnings = this.validateOffer();
                if (warnings.length > 0) {
                    const confirmed = await showConfirm('Save Offer with Warnings?', `This offer has warnings:\n\n${warnings.join('\n')}\n\nSave anyway?`);
                    if (!confirmed) return;
                }
                
                // Validate required fields
                if (!this.offer.name || this.offer.name.trim() === '') {
                    showToast('Please enter an offer name', 'error');
                    return;
                }
                
                if (this.offer.lineItems.length === 0) {
                    showToast('Please add at least one service', 'error');
                    return;
                }
                
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                const offerData = {
                    ...this.offer,
                    totals,
                    standards: {
                        status: standards.status,
                        score: standards.score,
                        evaluatedAt: new Date().toISOString()
                    },
                    timestamp: new Date().toISOString(),
                    createdBy: currentUser || 'USER',
                    isReady: false,
                    // Preserve isSample flag if it exists
                    isSample: this.offer.isSample || false
                };
                
                // Save to localStorage
                const saved = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                saved.push(offerData);
                localStorage.setItem('h2s_offer_builder_offers_v1', JSON.stringify(saved));
                
                // Save to backend API
                try {
                    const response = await fetch(`${API_URL}?action=saveOffer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            offerName: offerData.name,
                            offerData: offerData,
                            vaName: currentUser || 'USER'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.ok) {
                            // Track offer creation event
                            await trackEvent('offer_created', {
                                offer_name: offerData.name,
                                offer_id: result.offerId || offerData.timestamp,
                                customer_price: totals.finalCustomerPrice,
                                profit: totals.profit,
                                margin: totals.margin,
                                standards_status: standards.status,
                                standards_score: standards.score,
                                service_count: offerData.lineItems.length
                            });
                            
                            showToast('Offer saved successfully to backend!', 'success');
                        } else {
                            console.warn('Backend save failed:', result);
                            showToast('Offer saved locally (backend save failed)', 'warning');
                        }
                    }
                } catch (error) {
                    console.error('Backend save error:', error);
                    showToast('Offer saved locally (backend unavailable)', 'warning');
                }
                
                showToast('Offer saved successfully!', 'success');
            },
            
            async markReady() {
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                if (standards.status !== 'Up to Standard' || standards.hardFails.length > 0) {
                    showToast('Offer must be "Up to Standard" to mark ready', 'error');
                    return;
                }
                
                const confirmed = await showConfirm('Mark Ready for Deployment?', `Status: ${standards.status}\nScore: ${standards.score}/100\n\nThis will create an immutable snapshot.`);
                if (!confirmed) return;
                
                // Create locked version
                const offerData = {
                    ...this.offer,
                    totals,
                    standards: {
                        status: standards.status,
                        score: standards.score,
                        evaluatedAt: new Date().toISOString()
                    },
                    timestamp: new Date().toISOString(),
                    createdBy: currentUser || 'USER',
                    isReady: true,
                    readyAt: new Date().toISOString(),
                    version: '1.0',
                    // Preserve isSample flag if it exists
                    isSample: this.offer.isSample || false
                };
                
                const saved = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                saved.push(offerData);
                localStorage.setItem('h2s_offer_builder_offers_v1', JSON.stringify(saved));
                
                showToast('Offer marked ready for deployment!', 'success');
            },
            
            async generateBrief() {
                // Validate required fields
                if (!this.offer.name || this.offer.name.trim() === '') {
                    showToast('Please enter an offer name first', 'error');
                    return;
                }
                
                if (this.offer.lineItems.length === 0) {
                    showToast('Please add at least one service', 'error');
                    return;
                }
                
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                // Track brief generation event
                if (typeof trackEvent === 'function') {
                    await trackEvent('brief_generated', {
                        offer_name: this.offer.name,
                        standards_status: standards.status,
                        standards_score: standards.score,
                        customer_price: totals.finalCustomerPrice,
                        profit: totals.profit,
                        margin: totals.margin,
                        service_count: this.offer.lineItems.length
                    });
                }
                
                // Allow preview even if standards aren't met (just warn)
                if (standards.hardFails.length > 0 || standards.status === 'Incomplete') {
                    const confirmed = await showConfirm('Preview Brief with Issues?', 'This offer has issues that need to be fixed. Preview brief anyway?');
                    if (!confirmed) return;
                }
                
                if (totals.profit < 0) {
                    const confirmed = await showConfirm('Preview Unprofitable Offer?', 'This offer is unprofitable. Preview brief anyway?');
                    if (!confirmed) return;
                }
                
                this.offer.briefGenerated = true;
                this.updateBuildOrder(standards);
                await this.previewBrief();
            },
            
            showBriefEditor() {
                const totals = this.calculateTotals();
                const modalHtml = `
                    <div style="max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 24px;">
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 8px 0;">Offer Brief Editor</h3>
                            <p style="color: #6b7280; font-size: 13px; margin: 0;">Fill in the details below, then preview and export as PDF.</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- LEFT: Inputs -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Customer-Facing Offer Statement</label>
                                    <textarea id="briefOfferStatement" placeholder="One paragraph describing the offer..." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;">${this.offer.offerStatement || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Executive Summary</label>
                                    <textarea id="briefExecutiveSummary" placeholder="1-2 sentences..." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;">${this.offer.executiveSummary || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Value Stack</label>
                                    <textarea id="briefValueStack" placeholder="DIY vs us, time saved, etc." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;">${this.offer.valueStack || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Top 3 Objections + Rebuttals</label>
                                    <div id="briefObjections" style="display: flex; flex-direction: column; gap: 8px;">
                                        ${[0, 1, 2].map(i => `
                                            <input type="text" id="briefObjection${i}" placeholder="Objection ${i + 1} + Rebuttal" value="${(this.offer.objections[i] || '')}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Social Proof</label>
                                    <input type="text" id="briefSocialProofType" placeholder="Type (e.g., Testimonial, Case Study)" value="${this.offer.socialProof.type || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; margin-bottom: 8px;">
                                    <textarea id="briefSocialProofDetail" placeholder="Detail..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 60px; resize: vertical;">${this.offer.socialProof.detail || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Urgency Mechanics</label>
                                    <input type="text" id="briefUrgencyType" placeholder="Type (e.g., Limited Time, Limited Quantity)" value="${this.offer.urgency.type || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; margin-bottom: 8px;">
                                    <textarea id="briefUrgencyDetail" placeholder="Detail..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 50px; resize: vertical; margin-bottom: 8px;">${this.offer.urgency.detail || ''}</textarea>
                                    <input type="text" id="briefUrgencyRationale" placeholder="Rationale..." value="${this.offer.urgency.rationale || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Eligibility / Rules</label>
                                    <textarea id="briefEligibility" placeholder="Who qualifies, terms, restrictions..." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;">${this.offer.eligibility || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- RIGHT: Platform Copy -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Meta Headline (≤40 chars)</label>
                                    <input type="text" id="briefHeadline" maxlength="40" placeholder="Headline..." value="${this.offer.platformCopy.headline || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><span id="headlineCount">0</span>/40</div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Sub-headline (≤60 chars)</label>
                                    <input type="text" id="briefSubheadline" maxlength="60" placeholder="Sub-headline..." value="${this.offer.platformCopy.subheadline || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><span id="subheadlineCount">0</span>/60</div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Primary Text A (≤180 chars)</label>
                                    <textarea id="briefPrimaryTextA" maxlength="180" placeholder="Primary text..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 60px; resize: vertical;">${this.offer.platformCopy.primaryTextA || ''}</textarea>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><span id="primaryTextACount">0</span>/180</div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Primary Text B (≤180 chars)</label>
                                    <textarea id="briefPrimaryTextB" maxlength="180" placeholder="Primary text..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 60px; resize: vertical;">${this.offer.platformCopy.primaryTextB || ''}</textarea>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><span id="primaryTextBCount">0</span>/180</div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Landing Bullets (one per line)</label>
                                    <textarea id="briefLandingBullets" placeholder="Bullet 1&#10;Bullet 2&#10;Bullet 3" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 80px; resize: vertical;">${(this.offer.platformCopy.landingBullets || []).join('\\n')}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Disclaimer / Fine Print</label>
                                    <textarea id="briefDisclaimer" placeholder="Fine print..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 60px; resize: vertical;">${this.offer.platformCopy.disclaimer || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="offerBuilder.previewBrief()" class="btn" style="padding: 10px 20px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                👁️ Preview Brief
                            </button>
                            <button onclick="offerBuilder.exportPDF()" class="btn" style="padding: 10px 20px; font-size: 13px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                📄 Export PDF
                            </button>
                        </div>
                    </div>
                `;
                
                showModal('Offer Brief Editor', modalHtml, { width: '1000px', maxHeight: '90vh' });
                
                // Update character counts
                ['headline', 'subheadline', 'primaryTextA', 'primaryTextB'].forEach(id => {
                    const el = document.getElementById(`brief${id.charAt(0).toUpperCase() + id.slice(1)}`);
                    const countEl = document.getElementById(`${id}Count`);
                    if (el && countEl) {
                        countEl.textContent = el.value.length;
                        el.addEventListener('input', () => {
                            countEl.textContent = el.value.length;
                        });
                    }
                });
            },
            
            collectBriefData() {
                this.offer.offerStatement = document.getElementById('briefOfferStatement')?.value || '';
                this.offer.executiveSummary = document.getElementById('briefExecutiveSummary')?.value || '';
                this.offer.valueStack = document.getElementById('briefValueStack')?.value || '';
                this.offer.objections = [0, 1, 2].map(i => document.getElementById(`briefObjection${i}`)?.value || '').filter(o => o);
                this.offer.socialProof = {
                    type: document.getElementById('briefSocialProofType')?.value || '',
                    detail: document.getElementById('briefSocialProofDetail')?.value || ''
                };
                this.offer.urgency = {
                    type: document.getElementById('briefUrgencyType')?.value || '',
                    detail: document.getElementById('briefUrgencyDetail')?.value || '',
                    rationale: document.getElementById('briefUrgencyRationale')?.value || ''
                };
                this.offer.eligibility = document.getElementById('briefEligibility')?.value || '';
                this.offer.platformCopy = {
                    headline: document.getElementById('briefHeadline')?.value || '',
                    subheadline: document.getElementById('briefSubheadline')?.value || '',
                    primaryTextA: document.getElementById('briefPrimaryTextA')?.value || '',
                    primaryTextB: document.getElementById('briefPrimaryTextB')?.value || '',
                    landingBullets: (document.getElementById('briefLandingBullets')?.value || '').split('\\n').filter(b => b.trim()),
                    disclaimer: document.getElementById('briefDisclaimer')?.value || ''
                };
            },
            
            collectAllOfferData() {
                // Collect all fields from the messaging tabs
                const fieldMap = {
                    category: 'offerBuilderCategory',
                    market: 'offerBuilderMarket',
                    primaryAvatar: 'offerBuilderPrimaryAvatar',
                    intendedGoal: 'offerBuilderIntendedGoal',
                    headline: 'offerBuilderHeadline',
                    oneSentencePromise: 'offerBuilderOneSentencePromise',
                    offerStartDate: 'offerBuilderOfferStartDate',
                    offerEndDate: 'offerBuilderOfferEndDate',
                    scarcityMechanism: 'offerBuilderScarcityMechanism',
                    riskReversal: 'offerBuilderRiskReversal',
                    whatsIncluded: 'offerBuilderWhatsIncluded',
                    whatsNotIncluded: 'offerBuilderWhatsNotIncluded',
                    eligibilityRules: 'offerBuilderEligibilityRules',
                    redemptionRules: 'offerBuilderRedemptionRules',
                    dreamOutcome: 'offerBuilderDreamOutcome',
                    likelihoodOfAchievement: 'offerBuilderLikelihoodOfAchievement',
                    timeDelay: 'offerBuilderTimeDelay',
                    effortSacrifice: 'offerBuilderEffortSacrifice',
                    competitorPriceRange: 'offerBuilderCompetitorPriceRange',
                    howWereDifferent: 'offerBuilderHowWereDifferent',
                    whyChooseUs: 'offerBuilderWhyChooseUs',
                    bookingPageMicrocopy: 'offerBuilderBookingPageMicrocopy',
                    smsConfirmation: 'offerBuilderSmsConfirmation',
                    smsReminder24h: 'offerBuilderSmsReminder24h',
                    priceQuestionLine: 'offerBuilderPriceQuestionLine',
                    techBroadcastMessage: 'offerBuilderTechBroadcastMessage',
                    specialInstructions: 'offerBuilderSpecialInstructions',
                    capacityAssumption: 'offerBuilderCapacityAssumption',
                    cancellationRisks: 'offerBuilderCancellationRisks',
                    bestCaseOutcome: 'offerBuilderBestCaseOutcome',
                    worstCaseRisk: 'offerBuilderWorstCaseRisk',
                    confidenceWhy: 'offerBuilderConfidenceWhy',
                    marginBreakPoints: 'offerBuilderMarginBreakPoints',
                    safeguards: 'offerBuilderSafeguards'
                };
                
                Object.keys(fieldMap).forEach(key => {
                    const el = document.getElementById(fieldMap[key]);
                    if (el) {
                        this.offer[key] = el.value || '';
                    }
                });
                
                // Handle arrays
                const hooksEl = document.getElementById('offerBuilderHooks');
                if (hooksEl) {
                    this.offer.hooks = hooksEl.value.split('\\n').filter(h => h.trim());
                }
                
                const objectionsEl = document.getElementById('offerBuilderObjectionsRebuttals');
                if (objectionsEl) {
                    this.offer.objectionsRebuttals = objectionsEl.value.split('\\n').filter(o => o.trim());
                }
                
                const proofEl = document.getElementById('offerBuilderProofIdeas');
                if (proofEl) {
                    this.offer.proofIdeas = proofEl.value.split('\\n').filter(p => p.trim());
                }
                
                const whatToSayEl = document.getElementById('offerBuilderWhatToSayInHome');
                if (whatToSayEl) {
                    this.offer.whatToSayInHome = whatToSayEl.value.split('\\n').filter(s => s.trim());
                }
                
                // Handle confidence score
                const confidenceEl = document.getElementById('offerBuilderConfidenceScore');
                if (confidenceEl) {
                    this.offer.confidenceScore = parseInt(confidenceEl.value) || 0;
                }
            },
            
            async previewBrief() {
                this.collectAllOfferData();
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                let discountType = 'sum';
                if (this.offer.pricingStrategy === 'percentOff') discountType = '% off';
                else if (this.offer.pricingStrategy === 'dollarOff') discountType = '$ off';
                else if (this.offer.pricingStrategy === 'bundlePrice') discountType = 'bundle price';
                
                const previewHtml = `
                    <div style="max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 0; background: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; position: relative;">
                        <div style="position: sticky; top: 0; background: white; padding: 24px 32px 16px 32px; border-bottom: 2px solid #e5e7eb; margin-bottom: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            ${this.offer.isSample ? `
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">⚠️</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 2px;">SAMPLE OFFER</div>
                                    <div style="font-size: 12px; color: #78350f;">This brief was generated from a sample offer template. Review all content before deployment.</div>
                                </div>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h1 style="font-size: 28px; font-weight: 900; color: var(--cobalt); margin: 0;">Home2Smart Offer Brief</h1>
                                <button onclick="closeModal()" style="width: 32px; height: 32px; background: #f3f4f6; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: 700; color: #6b7280; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'; this.style.color='#374151'" onmouseout="this.style.background='#f3f4f6'; this.style.color='#6b7280'">×</button>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button onclick="offerBuilder.exportPDF()" style="padding: 10px 20px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#1a4a8a'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='var(--cobalt)'; this.style.transform='translateY(0)'">Export PDF</button>
                                <button id="submitDeliverablesBtn" onclick="offerBuilder.submitToDeliverables()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;" onmouseover="if(!this.disabled) { this.style.background='#059669'; this.style.transform='translateY(-1px)'; }" onmouseout="if(!this.disabled) { this.style.background='#10b981'; this.style.transform='translateY(0)'; }">
                                    <span id="submitDeliverablesText">Submit to Deliverables</span>
                                    <span id="submitDeliverablesSpinner" style="display: none; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>
                                </button>
                            </div>
                        </div>
                        <div style="line-height: 1.7; color: #1f2937; padding: 32px; background: white;">
                            
                            <!-- Economics Summary Box (Compact, Top) -->
                            <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; border-radius: 12px;">
                                <h3 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Economics Summary</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; font-size: 13px;">
                                    <div><strong>Customer Price:</strong><br><span style="font-size: 18px; font-weight: 900; color: var(--cobalt);">$${totals.customerPrice.toFixed(2)}</span></div>
                                    <div><strong>Tech Payout:</strong><br><span style="font-size: 16px; font-weight: 700; color: #92400e;">$${totals.techPayoutTotal.toFixed(2)}</span><br><span style="font-size: 11px; color: #6b7280;">(35% of customer price)</span></div>
                                    <div><strong>Equipment Cost:</strong><br><span style="font-size: 16px; font-weight: 700; color: #dc2626;">$${totals.equipCostTotal.toFixed(2)}</span></div>
                                    <div><strong>Profit:</strong><br><span style="font-size: 18px; font-weight: 900; color: ${totals.profit >= 0 ? '#059669' : '#dc2626'};">$${totals.profit.toFixed(2)}</span></div>
                                    <div><strong>Margin:</strong><br><span style="font-size: 18px; font-weight: 900; color: ${totals.marginPct >= 30 ? '#059669' : totals.marginPct >= 20 ? '#d97706' : '#dc2626'};">${totals.marginPct.toFixed(1)}%</span></div>
                                    <div><strong>Standards Score:</strong><br><span style="font-size: 16px; font-weight: 700; color: ${standards.score >= 80 ? '#059669' : standards.score >= 60 ? '#d97706' : '#dc2626'};">${standards.score}/100</span><br><span style="font-size: 11px; color: #6b7280;">${standards.status}</span></div>
                                </div>
                            </div>
                            
                            <!-- 1) OFFER SNAPSHOT -->
                            <section style="margin-bottom: 32px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">1) Offer Snapshot (Read This First)</h2>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 13px;">
                                    <div><strong>Offer Name:</strong> ${this.offer.name || 'N/A'}</div>
                                    <div><strong>Category:</strong> ${this.offer.category || 'N/A'}</div>
                                    <div><strong>Market:</strong> ${this.offer.market || 'N/A'}</div>
                                    <div><strong>Primary Avatar:</strong> ${this.offer.primaryAvatar || 'N/A'}</div>
                                    <div><strong>Intended Goal:</strong> ${this.offer.intendedGoal || 'N/A'}</div>
                                    <div><strong>Offer Dates:</strong> ${this.offer.offerStartDate || 'N/A'} to ${this.offer.offerEndDate || 'N/A'}</div>
                                </div>
                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                                    <div style="margin-bottom: 12px;"><strong>Headline (Ad-Ready):</strong><br>${this.offer.headline || 'N/A'}</div>
                                    <div style="margin-bottom: 12px;"><strong>1-Sentence Promise:</strong><br>${this.offer.oneSentencePromise || 'N/A'}</div>
                                    <div style="margin-bottom: 12px;"><strong>Scarcity Mechanism:</strong> ${this.offer.scarcityMechanism || 'N/A'}</div>
                                    <div><strong>Risk Reversal:</strong><br>${this.offer.riskReversal || 'N/A'}</div>
                                </div>
                            </section>
                            
                            <!-- 2) THE DEAL -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">2) The Deal (Exact Mechanics)</h2>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; font-size: 13px;">
                                    <div><strong>Regular Price:</strong> $${totals.subtotalBase.toFixed(2)}</div>
                                    <div><strong>Offer Price:</strong> $${totals.customerPrice.toFixed(2)}</div>
                                    <div><strong>Discount Type:</strong> ${discountType}</div>
                                    <div><strong>Discount Amount:</strong> ${this.offer.pricingStrategy === 'percentOff' ? this.offer.percentOff + '%' : this.offer.pricingStrategy === 'dollarOff' ? '$' + this.offer.dollarOff.toFixed(2) : this.offer.pricingStrategy === 'bundlePrice' ? 'Fixed $' + this.offer.bundlePrice.toFixed(2) : 'None'}</div>
                                </div>
                                <div style="margin-bottom: 12px;"><strong>What's Included:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.whatsIncluded || 'N/A'}</div></div>
                                <div style="margin-bottom: 12px;"><strong>What's Not Included / Upcharges:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.whatsNotIncluded || 'N/A'}</div></div>
                                <div style="margin-bottom: 12px;"><strong>Eligibility Rules:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.eligibilityRules || 'N/A'}</div></div>
                                <div><strong>Redemption Rules:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.redemptionRules || 'N/A'}</div></div>
                            </section>
                            
                            <!-- 3) UNIT ECONOMICS -->
                            <section style="margin-bottom: 32px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">3) Unit Economics (Must Be Filled)</h2>
                                <div style="margin-bottom: 16px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Assumptions:</h3>
                                    <div style="font-size: 13px; line-height: 1.8;">
                                        <div><strong>Expected Avg Order Total (AOV):</strong> $${totals.customerPrice.toFixed(2)}</div>
                                        <div><strong>Tech Payout Rate:</strong> 35%</div>
                                        <div><strong>Estimated Materials Cost:</strong> $${totals.equipCostTotal.toFixed(2)}</div>
                                        <div><strong>Payment Processing / Platform Fees:</strong> $${(this.offer.paymentProcessingFees || 0).toFixed(2)}</div>
                                        <div><strong>Travel / Other Variable Cost:</strong> $${(this.offer.travelOtherVariableCost || 0).toFixed(2)}</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Math:</h3>
                                    <div style="font-size: 13px; line-height: 1.8;">
                                        <div><strong>Revenue (AOV):</strong> $${totals.customerPrice.toFixed(2)}</div>
                                        <div><strong>Tech Payout:</strong> $${totals.techPayoutTotal.toFixed(2)} (35% of customer price: $${totals.customerPrice.toFixed(2)})</div>
                                        <div><strong>Materials:</strong> $${totals.equipCostTotal.toFixed(2)}</div>
                                        <div><strong>Fees:</strong> $${(this.offer.paymentProcessingFees || 0).toFixed(2)}</div>
                                        <div><strong>Gross Profit:</strong> $${totals.profit.toFixed(2)}</div>
                                        <div><strong>Gross Margin %:</strong> ${totals.marginPct.toFixed(1)}%</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;"><strong>Where Can This Break:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.marginBreakPoints || 'N/A'}</div></div>
                                <div><strong>Safeguards to Prevent Margin Bleed:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.safeguards || 'N/A'}</div></div>
                            </section>
                            
                            <!-- 4) VALUE EQUATION -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">4) Value Equation (Why This Will Work)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>Dream Outcome:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.dreamOutcome || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>Likelihood of Achievement (Proof, Process, Guarantees):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.likelihoodOfAchievement || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>Time Delay (How Fast They Get Results):</strong> ${this.offer.timeDelay || 'N/A'}</div>
                                    <div><strong>Effort + Sacrifice (What You Remove, Simplify, Handle for Them):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.effortSacrifice || 'N/A'}</div></div>
                                </div>
                            </section>
                            
                            <!-- 5) COMPETITOR REALITY CHECK -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">5) Competitor Reality Check (Short + Useful)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>Competitor Price Range Found:</strong> ${this.offer.competitorPriceRange || 'N/A'}</div>
                                    <div style="margin-bottom: 12px;"><strong>How We're Different (Not Cheaper, Better):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.howWereDifferent || 'N/A'}</div></div>
                                    <div><strong>Why Someone Chooses Us Even If Not Lowest Price:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.whyChooseUs || 'N/A'}</div></div>
                                </div>
                            </section>
                            
                            <!-- 6) OPS NOTES FOR PROS -->
                            <section style="margin-bottom: 32px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">6) Ops Notes for Pros (Technician-Side)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>What to Say In-Home:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">${(this.offer.whatToSayInHome || []).length > 0 ? (this.offer.whatToSayInHome || []).map(item => `<li>${item}</li>`).join('') : '<li>N/A</li>'}</ul></div>
                                    <div style="margin-bottom: 12px;"><strong>Special Instructions:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.specialInstructions || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>Capacity Assumption:</strong> ${this.offer.capacityAssumption || 'N/A'}</div>
                                    <div><strong>Anything That Could Cause Cancellations or Reschedules:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.cancellationRisks || 'N/A'}</div></div>
                                </div>
                            </section>
                            
                            <!-- 7) MESSAGING PACK -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">7) Messaging Pack (Copy You Can Reuse)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>Booking Page Microcopy (2-4 lines):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.bookingPageMicrocopy || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>SMS Confirmation Copy:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.smsConfirmation || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>SMS Reminder (24h):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.smsReminder24h || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>If Customer Asks About Price Line:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.priceQuestionLine || 'N/A'}</div></div>
                                    <div><strong>Tech Broadcast Message:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.techBroadcastMessage || 'N/A'}</div></div>
                                </div>
                            </section>
                            
                            <!-- 8) CREATIVE ANGLES -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">8) Creative Angles (So You Can Make Ads Fast)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>5 Hooks:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">${(this.offer.hooks || []).length > 0 ? (this.offer.hooks || []).map(hook => `<li>${hook}</li>`).join('') : '<li>N/A</li>'}</ul></div>
                                    <div style="margin-bottom: 12px;"><strong>3 Primary Objections + Rebuttal Line:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">${(this.offer.objectionsRebuttals || []).length > 0 ? (this.offer.objectionsRebuttals || []).map(obj => `<li>${obj}</li>`).join('') : '<li>N/A</li>'}</ul></div>
                                    <div><strong>3 Proof Ideas:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">${(this.offer.proofIdeas || []).length > 0 ? (this.offer.proofIdeas || []).map(proof => `<li>${proof}</li>`).join('') : '<li>N/A</li>'}</ul></div>
                                </div>
                            </section>
                            
                            <!-- 9) DECISION NOTES -->
                            <section style="margin-bottom: 32px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">9) Decision Notes (For Internal)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>Best-Case Outcome If This Works:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.bestCaseOutcome || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>Worst-Case Risk If This Fails:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.worstCaseRisk || 'N/A'}</div></div>
                                    <div><strong>Confidence Score:</strong> ${this.offer.confidenceScore || 0}/10 - ${this.offer.confidenceWhy || 'N/A'}</div>
                                </div>
                            </section>
                            
                            <!-- Standards Status -->
                            <div style="padding: 16px; background: ${standards.status === 'Up to Standard' ? '#d1fae5' : '#fef3c7'}; border-radius: 8px; border: 2px solid ${standards.status === 'Up to Standard' ? '#a7f3d0' : '#fde68a'}; text-align: center;">
                                <div style="font-size: 14px; font-weight: 700; color: ${standards.status === 'Up to Standard' ? '#065f46' : '#92400e'};">
                                    Standard Status: ${standards.status} (Score: ${standards.score}/100)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal('Offer Brief Preview', previewHtml, { width: '950px', maxHeight: '90vh', html: true });
            },
            
            async exportPDF() {
                this.collectAllOfferData();
                
                // Initialize missing properties to prevent errors
                if (!this.offer.objections) this.offer.objections = [];
                if (!this.offer.socialProof) this.offer.socialProof = { type: '', detail: '' };
                if (!this.offer.urgency) this.offer.urgency = { type: '', detail: '', rationale: '' };
                if (!this.offer.platformCopy) this.offer.platformCopy = { headline: '', subheadline: '', primaryTextA: '', primaryTextB: '', landingBullets: [], disclaimer: '' };
                if (!this.offer.platformCopy.landingBullets) this.offer.platformCopy.landingBullets = [];
                if (!this.offer.lineItems) this.offer.lineItems = [];
                
                // Validate required fields
                if (!this.offer.name || this.offer.name.trim() === '') {
                    showToast('Offer name is required', 'error');
                    return;
                }
                
                if (!this.offer.lineItems || this.offer.lineItems.length === 0) {
                    showToast('At least one service is required', 'error');
                    return;
                }
                
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                // Block export if hard-fails exist
                if (standards.hardFails.length > 0 || standards.status === 'Incomplete') {
                    showToast('Cannot export: Offer has hard-fail issues. Check Standards panel.', 'error');
                    return;
                }
                
                if (totals.profit < 0) {
                    const confirmed = await showConfirm('Export Unprofitable Offer?', 'This offer is unprofitable. Export PDF anyway?');
                    if (!confirmed) return;
                }
                
                let discountType = 'sum';
                if (this.offer.pricingStrategy === 'percentOff') discountType = '% off';
                else if (this.offer.pricingStrategy === 'dollarOff') discountType = '$ off';
                else if (this.offer.pricingStrategy === 'bundlePrice') discountType = 'bundle price';
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    const maxWidth = pageWidth - (margin * 2);
                    let yPos = margin;
                    
                    // Helper to add text with word wrap
                    const addText = (text, fontSize = 12, isBold = false, color = [0, 0, 0]) => {
                        doc.setFontSize(fontSize);
                        doc.setFont(undefined, isBold ? 'bold' : 'normal');
                        doc.setTextColor(color[0], color[1], color[2]);
                        const lines = doc.splitTextToSize(text, maxWidth);
                        lines.forEach(line => {
                            if (yPos > pageHeight - 30) {
                                doc.addPage();
                                yPos = margin;
                            }
                            doc.text(line, margin, yPos);
                            yPos += fontSize * 0.5;
                        });
                        yPos += 5;
                    };
                    
                    // Title
                    addText('HOME2SMART OFFER BRIEF', 18, true, [10, 42, 90]);
                    yPos += 5;
                    addText(this.offer.name || 'Untitled Offer', 16, true, [10, 42, 90]);
                    addText(`Generated: ${new Date().toLocaleDateString()}`, 9, false, [107, 114, 128]);
                    yPos += 12;
                    
                    // 1) OFFER SNAPSHOT
                    addText('1) OFFER SNAPSHOT (Read This First)', 14, true, [10, 42, 90]);
                    addText(`Offer Name: ${this.offer.name || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Category: ${this.offer.category || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Market: ${this.offer.market || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Primary Avatar: ${this.offer.primaryAvatar || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Intended Goal: ${this.offer.intendedGoal || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Offer Dates: ${this.offer.offerStartDate || 'N/A'} to ${this.offer.offerEndDate || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 3;
                    addText(`Headline (Ad-Ready): ${this.offer.headline || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`1-Sentence Promise: ${this.offer.oneSentencePromise || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Scarcity Mechanism: ${this.offer.scarcityMechanism || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Risk Reversal: ${this.offer.riskReversal || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 2) THE DEAL
                    addText('2) THE DEAL (Exact Mechanics)', 14, true, [10, 42, 90]);
                    addText(`Regular Price: $${totals.subtotalBase.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Offer Price: $${totals.customerPrice.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Discount Type: ${discountType}`, 11, false, [0, 0, 0]);
                    const discountAmt = this.offer.pricingStrategy === 'percentOff' ? (this.offer.percentOff || 0) + '%' : 
                                       this.offer.pricingStrategy === 'dollarOff' ? '$' + (this.offer.dollarOff || 0).toFixed(2) : 
                                       this.offer.pricingStrategy === 'bundlePrice' ? 'Fixed $' + (this.offer.bundlePrice || 0).toFixed(2) : 'None';
                    addText(`Discount Amount: ${discountAmt}`, 11, false, [0, 0, 0]);
                    yPos += 3;
                    addText(`What's Included: ${this.offer.whatsIncluded || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`What's Not Included / Upcharges: ${this.offer.whatsNotIncluded || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Eligibility Rules: ${this.offer.eligibilityRules || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Redemption Rules: ${this.offer.redemptionRules || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 5;
                    addText('Services Included:', 11, true, [0, 0, 0]);
                    if (this.offer.lineItems && this.offer.lineItems.length > 0) {
                        this.offer.lineItems.forEach(item => {
                            const equipInfo = item.equipMode === 'BYO' ? ' (Customer provides equipment)' : item.equipMode === 'included' ? ` (Equipment cost: $${(item.equipCostPerUnit || 0).toFixed(2)}/unit)` : ` (Custom equipment: $${(item.equipCostPerUnit || 0).toFixed(2)}/unit)`;
                            addText(`  • ${item.name || 'Unknown'} × ${item.qty || 1} @ $${(item.baseUnitPrice || 0).toFixed(2)} each${equipInfo}${item.notes ? ` — ${item.notes}` : ''}`, 10, false, [0, 0, 0]);
                        });
                    }
                    yPos += 10;
                    
                    // 3) UNIT ECONOMICS
                    addText('3) UNIT ECONOMICS (Must Be Filled)', 14, true, [10, 42, 90]);
                    addText('Assumptions:', 11, true, [0, 0, 0]);
                    addText(`  Expected Avg Order Total (AOV): $${totals.customerPrice.toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Tech Payout Rate: 35%`, 10, false, [0, 0, 0]);
                    addText(`  Estimated Materials Cost: $${totals.equipCostTotal.toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Payment Processing / Platform Fees: $${(this.offer.paymentProcessingFees || 0).toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Travel / Other Variable Cost: $${(this.offer.travelOtherVariableCost || 0).toFixed(2)}`, 10, false, [0, 0, 0]);
                    yPos += 3;
                    addText('Math:', 11, true, [0, 0, 0]);
                    addText(`  Revenue (AOV): $${totals.customerPrice.toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Tech Payout: $${totals.techPayoutTotal.toFixed(2)} (35% of customer price)`, 10, false, [0, 0, 0]);
                    addText(`  Materials: $${totals.equipCostTotal.toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Fees: $${(this.offer.paymentProcessingFees || 0).toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Gross Profit: $${totals.profit.toFixed(2)}`, 10, false, totals.profit >= 0 ? [0, 0, 0] : [239, 68, 68]);
                    addText(`  Gross Margin %: ${totals.marginPct.toFixed(1)}%`, 10, false, totals.marginPct >= 40 ? [16, 185, 129] : totals.marginPct >= 20 ? [245, 158, 11] : [239, 68, 68]);
                    yPos += 3;
                    addText(`Where Can This Break: ${this.offer.marginBreakPoints || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Safeguards to Prevent Margin Bleed: ${this.offer.safeguards || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 4) VALUE EQUATION
                    addText('4) VALUE EQUATION (Why This Will Work)', 14, true, [10, 42, 90]);
                    addText(`Dream Outcome: ${this.offer.dreamOutcome || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Likelihood of Achievement (Proof, Process, Guarantees): ${this.offer.likelihoodOfAchievement || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Time Delay (How Fast They Get Results): ${this.offer.timeDelay || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Effort + Sacrifice (What You Remove/Simplify): ${this.offer.effortSacrifice || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 5) COMPETITOR REALITY CHECK
                    addText('5) COMPETITOR REALITY CHECK (Short + Useful)', 14, true, [10, 42, 90]);
                    addText(`Competitor Price Range Found: ${this.offer.competitorPriceRange || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`How We're Different (Not Cheaper, Better): ${this.offer.howWereDifferent || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Why Someone Chooses Us Even If Not Lowest Price: ${this.offer.whyChooseUs || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 6) OPS NOTES FOR PROS
                    addText('6) OPS NOTES FOR PROS (Technician-Side)', 14, true, [10, 42, 90]);
                    if (this.offer.whatToSayInHome && Array.isArray(this.offer.whatToSayInHome) && this.offer.whatToSayInHome.length > 0) {
                        addText('What to Say In-Home:', 11, true, [0, 0, 0]);
                        this.offer.whatToSayInHome.forEach(item => {
                            addText(`  • ${item}`, 10, false, [0, 0, 0]);
                        });
                    } else {
                        addText('What to Say In-Home: N/A', 11, false, [0, 0, 0]);
                    }
                    addText(`Special Instructions: ${this.offer.specialInstructions || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Capacity Assumption: ${this.offer.capacityAssumption || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Anything That Could Cause Cancellations or Reschedules: ${this.offer.cancellationRisks || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 7) MESSAGING PACK
                    addText('7) MESSAGING PACK (Copy You Can Reuse)', 14, true, [10, 42, 90]);
                    addText(`Booking Page Microcopy (2-4 lines): ${this.offer.bookingPageMicrocopy || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`SMS Confirmation Copy: ${this.offer.smsConfirmation || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`SMS Reminder (24h): ${this.offer.smsReminder24h || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`If Customer Asks About Price Line: ${this.offer.priceQuestionLine || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Tech Broadcast Message: ${this.offer.techBroadcastMessage || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 8) CREATIVE ANGLES
                    addText('8) CREATIVE ANGLES (So You Can Make Ads Fast)', 14, true, [10, 42, 90]);
                    if (this.offer.hooks && Array.isArray(this.offer.hooks) && this.offer.hooks.length > 0) {
                        addText('5 Hooks:', 11, true, [0, 0, 0]);
                        this.offer.hooks.forEach(hook => {
                            addText(`  • ${hook}`, 10, false, [0, 0, 0]);
                        });
                    } else {
                        addText('5 Hooks: N/A', 11, false, [0, 0, 0]);
                    }
                    yPos += 2;
                    if (this.offer.objectionsRebuttals && Array.isArray(this.offer.objectionsRebuttals) && this.offer.objectionsRebuttals.length > 0) {
                        addText('3 Primary Objections + Rebuttal Line:', 11, true, [0, 0, 0]);
                        this.offer.objectionsRebuttals.forEach(obj => {
                            addText(`  • ${obj}`, 10, false, [0, 0, 0]);
                        });
                    } else if (this.offer.objections && Array.isArray(this.offer.objections) && this.offer.objections.length > 0) {
                        addText('3 Primary Objections + Rebuttal Line:', 11, true, [0, 0, 0]);
                        this.offer.objections.forEach(obj => {
                            addText(`  • ${obj}`, 10, false, [0, 0, 0]);
                        });
                    } else {
                        addText('3 Primary Objections + Rebuttal Line: N/A', 11, false, [0, 0, 0]);
                    }
                    yPos += 2;
                    if (this.offer.proofIdeas && Array.isArray(this.offer.proofIdeas) && this.offer.proofIdeas.length > 0) {
                        addText('3 Proof Ideas:', 11, true, [0, 0, 0]);
                        this.offer.proofIdeas.forEach(proof => {
                            addText(`  • ${proof}`, 10, false, [0, 0, 0]);
                        });
                    } else {
                        addText('3 Proof Ideas: N/A', 11, false, [0, 0, 0]);
                    }
                    yPos += 10;
                    
                    // 9) DECISION NOTES
                    addText('9) DECISION NOTES (For Internal)', 14, true, [10, 42, 90]);
                    addText(`Best-Case Outcome If This Works: ${this.offer.bestCaseOutcome || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Worst-Case Risk If This Fails: ${this.offer.worstCaseRisk || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Confidence Score: ${this.offer.confidenceScore || 0}/10 - ${this.offer.confidenceWhy || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // PLATFORM COPY (META)
                    addText('PLATFORM COPY (Meta)', 14, true, [10, 42, 90]);
                    if (this.offer.platformCopy) {
                        if (this.offer.platformCopy.headline) addText(`Headline (≤40): ${this.offer.platformCopy.headline}`, 11, false, [0, 0, 0]);
                        if (this.offer.platformCopy.subheadline) addText(`Sub-headline (≤60): ${this.offer.platformCopy.subheadline}`, 11, false, [0, 0, 0]);
                        if (this.offer.platformCopy.primaryTextA) addText(`Primary Text A (≤180): ${this.offer.platformCopy.primaryTextA}`, 11, false, [0, 0, 0]);
                        if (this.offer.platformCopy.primaryTextB) addText(`Primary Text B (≤180): ${this.offer.platformCopy.primaryTextB}`, 11, false, [0, 0, 0]);
                        if (this.offer.platformCopy.landingBullets && Array.isArray(this.offer.platformCopy.landingBullets) && this.offer.platformCopy.landingBullets.length > 0) {
                            addText('Landing Bullets:', 11, true, [0, 0, 0]);
                            this.offer.platformCopy.landingBullets.forEach(b => {
                                addText(`  • ${b}`, 10, false, [0, 0, 0]);
                            });
                        }
                        if (this.offer.platformCopy.disclaimer) {
                            addText(`Disclaimer: ${this.offer.platformCopy.disclaimer}`, 10, false, [107, 114, 128]);
                        }
                    } else {
                        addText('Platform Copy: N/A', 11, false, [0, 0, 0]);
                    }
                    yPos += 10;
                    
                    // ADDITIONAL SECTIONS (Offer Statement, Executive Summary, Value Stack, Social Proof, Urgency, Eligibility)
                    if (this.offer.offerStatement) {
                        addText('CUSTOMER-FACING OFFER STATEMENT', 14, true, [10, 42, 90]);
                        addText(this.offer.offerStatement, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    if (this.offer.executiveSummary) {
                        addText('EXECUTIVE SUMMARY', 14, true, [10, 42, 90]);
                        addText(this.offer.executiveSummary, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    if (this.offer.valueStack) {
                        addText('VALUE STACK', 14, true, [10, 42, 90]);
                        addText(this.offer.valueStack, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    if (this.offer.socialProof && (this.offer.socialProof.type || this.offer.socialProof.detail)) {
                        addText('SOCIAL PROOF', 14, true, [10, 42, 90]);
                        if (this.offer.socialProof.type) addText(`Type: ${this.offer.socialProof.type}`, 11, false, [0, 0, 0]);
                        if (this.offer.socialProof.detail) addText(`Detail: ${this.offer.socialProof.detail}`, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    if (this.offer.urgency && (this.offer.urgency.type || this.offer.urgency.detail)) {
                        addText('URGENCY MECHANICS', 14, true, [10, 42, 90]);
                        if (this.offer.urgency.type) addText(`Type: ${this.offer.urgency.type}`, 11, false, [0, 0, 0]);
                        if (this.offer.urgency.detail) addText(`Detail: ${this.offer.urgency.detail}`, 11, false, [0, 0, 0]);
                        if (this.offer.urgency.rationale) addText(`Rationale: ${this.offer.urgency.rationale}`, 10, false, [107, 114, 128]);
                        yPos += 10;
                    }
                    
                    if (this.offer.eligibility) {
                        addText('ELIGIBILITY / RULES', 14, true, [10, 42, 90]);
                        addText(this.offer.eligibility, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    // ECONOMICS SNAPSHOT (INTERNAL) - Final Summary
                    yPos += 5;
                    addText('ECONOMICS SNAPSHOT (Internal)', 14, true, [10, 42, 90]);
                    addText(`Customer Price: $${totals.customerPrice.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Tech Payout: $${totals.techPayoutTotal.toFixed(2)} (35% of customer price)`, 11, false, [0, 0, 0]);
                    addText(`Equipment Cost: $${totals.equipCostTotal.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Profit: $${totals.profit.toFixed(2)}`, 11, false, totals.profit >= 0 ? [16, 185, 129] : [239, 68, 68]);
                    addText(`Margin: ${totals.marginPct.toFixed(1)}%`, 11, false, totals.marginPct >= 40 ? [16, 185, 129] : totals.marginPct >= 20 ? [245, 158, 11] : [239, 68, 68]);
                    yPos += 5;
                    addText(`Standards Status: ${standards.status} (Score: ${standards.score}/100)`, 10, false, [107, 114, 128]);
                    
                    // Generate filename
                    const date = new Date().toISOString().split('T')[0];
                    const safeName = (this.offer.name || 'Untitled').replace(/[^a-z0-9]/gi, '_').substring(0, 50);
                    const filename = `Offer_Brief_${safeName}_${date}.pdf`;
                    
                    // Save PDF
                    doc.save(filename);
                    showToast('PDF exported successfully!', 'success');
                    closeModal();
            } catch (error) {
                    console.error('PDF export error:', error);
                    showToast('Error exporting PDF: ' + error.message, 'error');
                }
            },
            
            async submitToDeliverables() {
                // Get button elements for loading state
                const submitBtn = document.getElementById('submitDeliverablesBtn');
                const submitText = document.getElementById('submitDeliverablesText');
                const submitSpinner = document.getElementById('submitDeliverablesSpinner');
                
                // Set loading state immediately
                const setLoadingState = (loading) => {
                    if (submitBtn) {
                        submitBtn.disabled = loading;
                        submitBtn.style.cursor = loading ? 'not-allowed' : 'pointer';
                        submitBtn.style.opacity = loading ? '0.7' : '1';
                    }
                    if (submitText) {
                        submitText.textContent = loading ? 'Submitting...' : 'Submit to Deliverables';
                    }
                    if (submitSpinner) {
                        submitSpinner.style.display = loading ? 'block' : 'none';
                    }
                };
                
                // Start loading state immediately
                setLoadingState(true);
                
                this.collectAllOfferData();
                
                // Initialize missing properties to prevent errors
                if (!this.offer.objections) this.offer.objections = [];
                if (!this.offer.socialProof) this.offer.socialProof = { type: '', detail: '' };
                if (!this.offer.urgency) this.offer.urgency = { type: '', detail: '', rationale: '' };
                if (!this.offer.platformCopy) this.offer.platformCopy = { headline: '', subheadline: '', primaryTextA: '', primaryTextB: '', landingBullets: [], disclaimer: '' };
                if (!this.offer.platformCopy.landingBullets) this.offer.platformCopy.landingBullets = [];
                if (!this.offer.lineItems) this.offer.lineItems = [];
                
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                // Validate required fields
                if (!this.offer.name || this.offer.name.trim() === '') {
                    setLoadingState(false);
                    showToast('Offer name is required', 'error');
                    return;
                }
                
                if (!this.offer.lineItems || this.offer.lineItems.length === 0) {
                    setLoadingState(false);
                    showToast('At least one service is required', 'error');
                    return;
                }
                
                // Generate PDF first
                let pdfDataUrl = null;
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    const maxWidth = pageWidth - (margin * 2);
                    let yPos = margin;
                    
                    const addText = (text, fontSize = 12, isBold = false, color = [0, 0, 0]) => {
                        doc.setFontSize(fontSize);
                        doc.setFont(undefined, isBold ? 'bold' : 'normal');
                        doc.setTextColor(color[0], color[1], color[2]);
                        const lines = doc.splitTextToSize(text, maxWidth);
                        lines.forEach(line => {
                            if (yPos > pageHeight - 30) {
                                doc.addPage();
                                yPos = margin;
                            }
                            doc.text(line, margin, yPos);
                            yPos += fontSize * 0.5;
                        });
                        yPos += 5;
                    };
                    
                    addText(this.offer.name || 'Untitled Offer', 20, true, [10, 42, 90]);
                    yPos += 10;
                    addText(`Offer Brief - ${new Date().toLocaleDateString()}`, 12, false, [107, 114, 128]);
                    yPos += 10;
                    addText(`Status: ${standards.status} (Score: ${standards.score}/100)`, 11, false, [107, 114, 128]);
                    yPos += 10;
                    addText(`Customer Price: $${totals.customerPrice.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Tech Payout: $${totals.techPayoutTotal.toFixed(2)} (35% of customer price)`, 11, false, [0, 0, 0]);
                    addText(`Profit: $${totals.profit.toFixed(2)} | Margin: ${totals.marginPct.toFixed(1)}%`, 11, false, totals.profit >= 0 ? [0, 0, 0] : [239, 68, 68]);
                    yPos += 10;
                    
                    // Add key offer details
                    if (this.offer.headline) {
                        addText('Headline:', 14, true, [10, 42, 90]);
                        addText(this.offer.headline, 11, false, [0, 0, 0]);
                    }
                    if (this.offer.oneSentencePromise) {
                        addText('Promise:', 14, true, [10, 42, 90]);
                        addText(this.offer.oneSentencePromise, 11, false, [0, 0, 0]);
                    }
                    if (this.offer.lineItems && this.offer.lineItems.length > 0) {
                        addText('Services:', 14, true, [10, 42, 90]);
                        this.offer.lineItems.forEach(item => {
                            addText(`${item.name || 'Unknown'} × ${item.qty || 1} @ $${(item.baseUnitPrice || 0).toFixed(2)}`, 11, false, [0, 0, 0]);
                        });
                    }
                    
                    pdfDataUrl = doc.output('dataurlstring');
                } catch (error) {
                    console.error('PDF generation error:', error);
                    setLoadingState(false);
                    showToast('Error generating PDF for submission', 'error');
                    return;
                }
                
                // Prepare description
                const description = `
Offer: ${this.offer.name}
Category: ${this.offer.category || 'Not set'}
Market: ${this.offer.market || 'Not set'}

Services: ${(this.offer.lineItems || []).map(item => `${item.name || 'Unknown'} × ${item.qty || 1}`).join(', ')}
Customer Price: $${totals.customerPrice.toFixed(2)}
Tech Payout: $${totals.techPayoutTotal.toFixed(2)} (35% of customer price)
Profit: $${totals.profit.toFixed(2)}
Margin: ${totals.marginPct.toFixed(1)}%

Standards Status: ${standards.status} (Score: ${standards.score}/100)
${standards.hardFails && standards.hardFails.length > 0 ? `Issues: ${standards.hardFails.map(f => f.message || f).join('; ')}` : ''}

${this.offer.headline ? `Headline: ${this.offer.headline}` : ''}
${this.offer.oneSentencePromise ? `Promise: ${this.offer.oneSentencePromise}` : ''}
                `.trim();
                
                // Submit to deliverables
                try {
                    const response = await fetch(`${API_URL}?action=submitDeliverable`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: `Offer Brief: ${this.offer.name}`,
                            description: description,
                            fileLink: pdfDataUrl,
                            submittedBy: currentUser || 'USER',
                            metadata: {
                                type: 'offer_brief',
                                offerId: this.offer.name,
                                isSample: this.offer.isSample || false,
                                standards: {
                                    status: standards.status,
                                    score: standards.score
                                },
                                totals: {
                                    customerPrice: totals.customerPrice,
                                    techPayout: totals.techPayoutTotal,
                                    profit: totals.profit,
                                    margin: totals.marginPct
                                }
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.ok && data.result) {
                        // Update button to show success state briefly
                        if (submitText) submitText.textContent = 'Submitted!';
                        if (submitSpinner) submitSpinner.style.display = 'none';
                        
                        showToast('Offer brief submitted to Deliverables!', 'success');
                        
                        // Close modal and navigate after a brief delay
                        setTimeout(() => {
                            closeModal();
                            
                            // Smoothly navigate to deliverables tab (intelligent routing)
                            setTimeout(() => {
                                // Switch to review view to show the new submission
                                if (typeof switchDeliverablesView === 'function') {
                                    switchDeliverablesView('review');
                                }
                                
                                switchToTab('deliverables', { skipPersistence: false, smooth: true });
                                
                                // Highlight the new submission after a brief delay
                                setTimeout(() => {
                                    const deliverablesContainer = document.getElementById('deliverablesContainer');
                                    const reviewContainer = document.getElementById('deliverablesReviewContainer');
                                    
                                    // Refresh deliverables to show new submission
                                    if (typeof loadDeliverablesReview === 'function') {
                                        loadDeliverablesReview();
                                    }
                                    if (typeof loadDeliverablesLibrary === 'function') {
                                        loadDeliverablesLibrary();
                                    }
                                    
                                    // Scroll to review container to show new submission
                                    if (reviewContainer) {
                                        setTimeout(() => {
                                            reviewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                        }, 400);
                                    } else if (deliverablesContainer) {
                                        deliverablesContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                    }
                                }, 400);
                            }, 200);
                        }, 300);
                    } else {
                        setLoadingState(false);
                        showToast('Error submitting: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Submit deliverable error:', error);
                    setLoadingState(false);
                    showToast('Error submitting to deliverables: ' + error.message, 'error');
                }
            },
            
            async loadPerformanceData() {
                const summaryDiv = document.getElementById('offerBuilderPerformanceSummary');
                const loadingDiv = document.getElementById('offerBuilderPerformanceLoading');
                const emptyDiv = document.getElementById('offerBuilderPerformanceEmpty');
                const container = document.getElementById('offerBuilderPerformanceFeedback');
                
                if (!summaryDiv || !loadingDiv || !emptyDiv || !container) return;
                
                const offerName = this.offer.name || null;
                
                // Show loading state
                summaryDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                
                try {
                    // Use meta_pixel_events endpoint from current backend (has CORS configured)
                    // This endpoint queries the same h2s_tracking_events table structure
                    const response = await fetch(`${API_URL}?action=meta_pixel_events`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to load: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    // meta_pixel_events returns { ok: true, meta_pixel_events: {...} } or just the data directly
                    const pixelData = result.meta_pixel_events || result;
                    
                    // Log for debugging
                    console.log('📊 Meta Pixel data loaded:', pixelData);
                    if (pixelData.summary) {
                        console.log('✅ Total events:', pixelData.summary.total_events);
                        console.log('✅ Unique users:', pixelData.summary.unique_users);
                        console.log('✅ Event types:', pixelData.summary.by_event_type);
                    }
                    
                    // Hide loading
                    loadingDiv.style.display = 'none';
                    
                    const summary = pixelData.summary || {};
                    const totalEvents = summary.total_events || 0;
                    const uniqueUsers = summary.unique_users || 0;
                    
                    if (!summary || totalEvents === 0) {
                        // Show empty state
                        emptyDiv.style.display = 'block';
                        return;
                    }
                    
                    // Hide empty state
                    emptyDiv.style.display = 'none';
                    
                    // Extract metrics from meta_pixel_events format
                    // Calculate page views (page_view + view_content events)
                    // Backend now normalizes to lowercase, so check both formats for backward compatibility
                    const eventTypes = summary.by_event_type || {};
                    const pageViews = (eventTypes.page_view?.count || eventTypes.pageview?.count || 0) + 
                                    (eventTypes.view_content?.count || eventTypes.viewcontent?.count || 0);
                    const leads = (eventTypes.lead?.count || 0) + 
                                (eventTypes.complete_registration?.count || 0);
                    const orders = (eventTypes.purchase?.count || 0);
                    // REMOVED: totalRevenue and avgOrderValue - user explicitly said NO revenue
                    const uniqueSessions = summary.unique_sessions || 0;
                    
                    // Get page type performance if available
                    const pageTypeData = pixelData.by_page_type || {};
                    const pageTypeEntries = Object.entries(pageTypeData).slice(0, 5);
                    
                    // Calculate engagement rate (soft indicator)
                    const engagementRate = uniqueUsers > 0 ? Math.round((leads / uniqueUsers) * 100) : 0;
                    // Calculate conversion rate (leads to purchases)
                    const conversionRate = leads > 0 ? Math.round((orders / leads) * 100) : 0;
                    
                    // Format latest event timestamp
                    let latestEventTime = '';
                    if (summary.latest_event_at) {
                        const eventDate = new Date(summary.latest_event_at);
                        const now = new Date();
                        const diffMs = now - eventDate;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);
                        
                        if (diffMins < 1) {
                            latestEventTime = 'Just now';
                        } else if (diffMins < 60) {
                            latestEventTime = `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
                        } else if (diffHours < 24) {
                            latestEventTime = `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
                        } else if (diffDays < 7) {
                            latestEventTime = `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
                        } else {
                            latestEventTime = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                        }
                    }
                    
                    summaryDiv.style.display = 'block';
                    summaryDiv.innerHTML = `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="font-size: 14px; font-weight: 600; color: #6b7280; margin: 0;">Activity Overview</h4>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${latestEventTime ? `<span style="font-size: 11px; color: #059669; background: #d1fae5; padding: 4px 10px; border-radius: 10px; font-weight: 600;">⏱️ ${latestEventTime}</span>` : ''}
                                    ${offerName ? `<span style="font-size: 11px; color: #9ca3af; background: #f3f4f6; padding: 3px 10px; border-radius: 10px;">${offerName}</span>` : ''}
                                </div>
                            </div>
                            
                            <!-- Metrics Cards - EXACT MATCH to funnel-track.html Meta Pixel section (NO REVENUE) -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;">
                                <div style="background: #fafbfc; padding: 14px; border-radius: 8px; border: 1px solid #e8eaed;">
                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 500;">Total Events</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #1493ff;">${(summary.total_events || 0).toLocaleString()}</div>
                                    <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">${uniqueSessions.toLocaleString()} sessions tracked</div>
                                </div>
                                
                                <div style="background: #fafbfc; padding: 14px; border-radius: 8px; border: 1px solid #e8eaed;">
                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 500;">Unique Users</div>
                                    <div style="font-size: 20px; font-weight: 600; color: var(--cobalt);">${uniqueUsers.toLocaleString()}</div>
                                </div>
                                
                                <div style="background: #fafbfc; padding: 14px; border-radius: 8px; border: 1px solid #e8eaed;">
                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 500;">Top Content</div>
                                    ${(() => {
                                        let topEvent = 'No data';
                                        let topCount = 0;
                                        if (eventTypes && Object.keys(eventTypes).length > 0) {
                                            Object.entries(eventTypes).forEach(([name, data]) => {
                                                const count = typeof data === 'object' ? (data.count || 0) : (data || 0);
                                                if (count > topCount) {
                                                    topCount = count;
                                                    topEvent = name;
                                                }
                                            });
                                        }
                                        return `<div style="font-size: 20px; font-weight: 600; color: #6366f1;">${topEvent}</div><div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">${topCount.toLocaleString()} events</div>`;
                                    })()}
                                </div>
                                
                                <div style="background: #fafbfc; padding: 14px; border-radius: 8px; border: 1px solid #e8eaed;">
                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 500;">Conversions</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #FBBC04;">${orders.toLocaleString()}</div>
                                    <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">${orders === 1 ? 'conversion' : 'conversions'}</div>
                                </div>
                            </div>
                            
                            ${pageTypeEntries.length > 0 ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e8eaed;">
                                <h5 style="font-size: 13px; font-weight: 600; color: #6b7280; margin: 0 0 12px 0;">Page Type Performance</h5>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${pageTypeEntries.map(([type, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f9fafb; border-radius: 6px;">
                                            <span style="font-size: 12px; color: #374151; font-weight: 500;">${type}</span>
                                            <span style="font-size: 12px; color: var(--cobalt); font-weight: 600;">${count.toLocaleString()} events</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Error loading performance data:', error);
                    loadingDiv.style.display = 'none';
                    emptyDiv.style.display = 'block';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 32px; margin-bottom: 8px;">⚠️</div>
                        <p style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 8px 0;">Unable to load data</p>
                        <p style="font-size: 12px; color: #6b7280; margin: 0;">There was an error connecting to the tracking system. Please try again later.</p>
                    `;
                }
            },
            
            async loadInsights() {
                const contentDiv = document.getElementById('offerBuilderInsightsContent');
                const loadingDiv = document.getElementById('offerBuilderInsightsLoading');
                const emptyDiv = document.getElementById('offerBuilderInsightsEmpty');
                const container = document.getElementById('offerBuilderInsights');
                
                if (!contentDiv || !loadingDiv || !emptyDiv || !container) return;
                
                // Show loading
                contentDiv.style.display = 'none';
                emptyDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                
                try {
                    // Get overall performance data to analyze service performance
                    const response = await fetch(`${API_URL}?action=offer_performance&days=90`);
                    if (!response.ok) throw new Error(`Failed to load: ${response.status}`);
                    
                    const result = await response.json();
                    const allData = result.offer_performance || result;
                    
                    // Also get meta_pixel_events to analyze service performance by page type/campaign
                    const pixelResponse = await fetch(`${API_URL}?action=meta_pixel_events`);
                    const pixelResult = await pixelResponse.ok ? await pixelResponse.json() : null;
                    const pixelData = pixelResult?.meta_pixel_events || pixelResult;
                    
                    loadingDiv.style.display = 'none';
                    
                    // Analyze which services/categories are performing well
                    const insights = this.analyzeServicePerformance(allData, pixelData);
                    
                    if (insights.hasData) {
                        emptyDiv.style.display = 'none';
                        contentDiv.style.display = 'block';
                        contentDiv.innerHTML = this.renderInsights(insights);
                    } else {
                        contentDiv.style.display = 'none';
                        emptyDiv.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Error loading insights:', error);
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'none';
                    emptyDiv.style.display = 'block';
                }
            },
            
            analyzeServicePerformance(performanceData, pixelData) {
                // Extract service performance from page types and campaign names
                const servicePerformance = {};
                const categoryPerformance = {};
                
                // Analyze pixel data for page performance by type
                if (pixelData?.page_performance) {
                    pixelData.page_performance.forEach((page) => {
                        const path = page.path?.toLowerCase() || '';
                        // Map page paths to services
                        if (path.includes('tv') || path.includes('mount')) {
                            categoryPerformance['TV Mounting'] = (categoryPerformance['TV Mounting'] || 0) + (page.score || 0);
                        } else if (path.includes('security') || path.includes('camera')) {
                            categoryPerformance['Security'] = (categoryPerformance['Security'] || 0) + (page.score || 0);
                        } else if (path.includes('smart') || path.includes('automation')) {
                            categoryPerformance['Smart Home'] = (categoryPerformance['Smart Home'] || 0) + (page.score || 0);
                        } else if (path.includes('wifi') || path.includes('network')) {
                            categoryPerformance['WiFi'] = (categoryPerformance['WiFi'] || 0) + (page.score || 0);
                        }
                    });
                }
                
                // Analyze conversion rates by campaign/offer name patterns
                let avgConversionRate = 0;
                let topPerformingCategories = [];
                
                if (performanceData?.conversion_rates?.visitor_to_purchase) {
                    avgConversionRate = parseFloat(performanceData.conversion_rates.visitor_to_purchase) || 0;
                }
                
                // Get top categories by performance score
                const sortedCategories = Object.entries(categoryPerformance)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([cat]) => cat);
                
                return {
                    hasData: sortedCategories.length > 0 || avgConversionRate > 0,
                    topCategories: sortedCategories,
                    avgConversionRate: avgConversionRate,
                    categoryPerformance: categoryPerformance
                };
            },
            
            renderInsights(insights) {
                const currentCategory = this.offer.category || '';
                const currentServices = this.offer.lineItems.map(item => item.name);
                const totals = this.calculateTotals(); // Calculate once at the start
                
                let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';
                
                // Service Performance Section
                if (insights.topCategories && insights.topCategories.length > 0) {
                    html += `
                        <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 16px; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: #0c4a6e; margin-bottom: 12px;">Top Performing Service Categories</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${insights.topCategories.map((cat, idx) => `
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px; font-weight: 700; color: #0ea5e9; min-width: 24px;">${idx + 1}</span>
                                        <span style="font-size: 13px; color: #0c4a6e; font-weight: 600;">${cat}</span>
                                        ${currentCategory === cat ? '<span style="font-size: 11px; background: #22c55e; color: white; padding: 2px 8px; border-radius: 12px; margin-left: auto;">Your category</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="font-size: 12px; color: #075985; margin-top: 12px; padding-top: 12px; border-top: 1px solid #bae6fd;">
                                <strong>Note:</strong> Performance is based on campaign tracking. Make sure your ad set names (utm_campaign) match your offer names to track properly.
                            </div>
                        </div>
                    `;
                }
                
                // Conversion Rate Benchmark
                if (insights.avgConversionRate > 0) {
                    const marginColor = totals.marginPct >= 30 ? '#22c55e' : totals.marginPct >= 20 ? '#eab308' : '#ef4444';
                    
                    html += `
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px;">Performance Benchmarks</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Avg Conversion Rate</div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${insights.avgConversionRate.toFixed(1)}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Your Current Margin</div>
                                    <div style="font-size: 20px; font-weight: 700; color: ${marginColor};">${totals.marginPct.toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Pricing Guidance
                if (currentServices.length > 0) {
                    html += `
                        <div style="background: #fff7ed; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 8px;">Pricing Tip</div>
                            <div style="font-size: 13px; color: #78350f; line-height: 1.6;">
                                ${totals.marginPct < 30 ? 
                                    'Your margin is below the 30% target. Consider adjusting pricing or reducing equipment costs to improve profitability.' :
                                    totals.marginPct < 20 ?
                                    'Margin is getting low. Monitor closely to ensure profitability.' :
                                    'Great margin! This offer should be profitable.'
                                }
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                return html;
            },
            
            // Load offer-specific performance metrics
            async loadOfferPerformanceData() {
                if (!this.offer.name) return;
                
                try {
                    const response = await fetch(`${API_URL}?action=offer_performance&offerName=${encodeURIComponent(this.offer.name)}&days=30&debug=true`);
                    
                    if (!response.ok) {
                        console.warn('Offer performance endpoint not available yet');
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (result.ok && result.offer_performance) {
                        const perf = result.offer_performance;
                        console.log('📊 Offer Performance:', perf);
                        
                        // Track that we loaded performance data
                        await trackEvent('offer_performance_viewed', {
                            offer_name: this.offer.name,
                            has_data: perf.has_data || false,
                            total_events: perf.summary?.total_events || 0,
                            total_revenue: perf.summary?.total_revenue || 0
                        });
                        
                        // You can display this data in the Performance Feedback section
                        // or store it for later use
                        this.offerPerformance = perf;
                    }
                } catch (error) {
                    console.log('Offer performance tracking not yet available:', error.message);
                }
            }
        };


        // Initialize features when tabs become active
        function initFeatureIfNeeded(tabName) {
            if (tabName === 'admin') {
                const pane = document.getElementById('admin-pane');
                if (pane && pane.classList.contains('active') && !pane.dataset.initialized) {
                    adminDashboard.refresh();
                    pane.dataset.initialized = 'true';
                }
            } else if (tabName === 'offerbuilder') {
                const pane = document.getElementById('offerbuilder-pane');
                if (pane && pane.classList.contains('active') && !pane.dataset.initialized) {
                    offerBuilder.init();
                    pane.dataset.initialized = 'true';
                }
            }
        }

        // Hook into switchToTab
        const originalSwitchToTab = window.switchToTab;
        if (typeof originalSwitchToTab === 'function') {
            window.switchToTab = function(tab) {
                originalSwitchToTab(tab);
                setTimeout(() => initFeatureIfNeeded(tab), 150);
            };
        }

        // ===== LAYOUT AUDIT HELPER (Dev Tool) =====
        // Run: layoutAudit() in console to diagnose layout issues
        window.layoutAudit = function() {
            const report = {
                timestamp: new Date().toISOString(),
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    scrollY: window.scrollY,
                    scrollX: window.scrollX
                },
                scrollContainers: [],
                accordionElements: [],
                fixedHeights: [],
                absolutePositioned: [],
                stickyElements: []
            };

            // Find active scroll containers
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                const overflowY = style.overflowY;
                const overflowX = style.overflowX;
                
                if ((overflowY === 'auto' || overflowY === 'scroll') && el.scrollHeight > el.clientHeight) {
                    report.scrollContainers.push({
                        id: el.id || 'no-id',
                        className: el.className || 'no-class',
                        tag: el.tagName,
                        scrollHeight: el.scrollHeight,
                        clientHeight: el.clientHeight,
                        scrollTop: el.scrollTop,
                        overflowY: overflowY,
                        overflowX: overflowX
                    });
                }
            });

            // Find accordion sections in Offer Builder
            const offerBuilderPane = document.getElementById('offerbuilder-pane');
            if (offerBuilderPane) {
                const accordionSections = [
                    'offerMessagingSection',
                    'offerBuilderInsights',
                    'offerBuilderPerformanceFeedback'
                ];
                
                accordionSections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        const style = window.getComputedStyle(section);
                        const parent = section.parentElement;
                        const parentStyle = parent ? window.getComputedStyle(parent) : null;
                        
                        report.accordionElements.push({
                            id: sectionId,
                            display: style.display,
                            position: style.position,
                            height: section.offsetHeight,
                            scrollHeight: section.scrollHeight,
                            isVisible: style.display !== 'none',
                            parent: {
                                id: parent?.id || 'no-id',
                                position: parentStyle?.position || 'unknown',
                                overflow: parentStyle?.overflow || 'unknown',
                                maxHeight: parentStyle?.maxHeight || 'none'
                            },
                            hasAbsoluteChildren: Array.from(section.querySelectorAll('*')).some(child => {
                                return window.getComputedStyle(child).position === 'absolute';
                            })
                        });
                    }
                });
            }

            // Find elements with fixed heights that might prevent reflow
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                const height = style.height;
                const maxHeight = style.maxHeight;
                
                if (height && height !== 'auto' && !height.includes('%')) {
                    const heightNum = parseFloat(height);
                    if (heightNum > 0 && heightNum < 10000) { // Reasonable range
                        report.fixedHeights.push({
                            id: el.id || 'no-id',
                            className: el.className || 'no-class',
                            tag: el.tagName,
                            height: height,
                            actualHeight: el.offsetHeight,
                            scrollHeight: el.scrollHeight
                        });
                    }
                }
                
                if (maxHeight && maxHeight !== 'none' && !maxHeight.includes('%')) {
                    const maxHeightNum = parseFloat(maxHeight);
                    if (maxHeightNum > 0 && maxHeightNum < 10000) {
                        report.fixedHeights.push({
                            id: el.id || 'no-id',
                            className: el.className || 'no-class',
                            tag: el.tagName,
                            maxHeight: maxHeight,
                            actualHeight: el.offsetHeight,
                            scrollHeight: el.scrollHeight,
                            isClipped: el.scrollHeight > el.offsetHeight
                        });
                    }
                }
            });

            // Find absolutely positioned elements inside accordion content
            if (offerBuilderPane) {
                const accordionContent = offerBuilderPane.querySelectorAll('[id*="Section"], [id*="Insights"], [id*="Performance"]');
                accordionContent.forEach(el => {
                    const style = window.getComputedStyle(el);
                    if (style.position === 'absolute' || style.position === 'fixed') {
                        report.absolutePositioned.push({
                            id: el.id || 'no-id',
                            position: style.position,
                            top: style.top,
                            left: style.left,
                            zIndex: style.zIndex
                        });
                    }
                });
            }

            // Find sticky elements
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                if (style.position === 'sticky') {
                    report.stickyElements.push({
                        id: el.id || 'no-id',
                        className: el.className || 'no-class',
                        tag: el.tagName,
                        top: style.top,
                        bottom: style.bottom,
                        zIndex: style.zIndex
                    });
                }
            });

            // Print report
            console.group('🔍 Layout Audit Report');
            console.log('Viewport:', report.viewport);
            console.log('Active Scroll Containers:', report.scrollContainers);
            console.log('Accordion Elements:', report.accordionElements);
            console.log('Fixed/Max Heights:', report.fixedHeights);
            console.log('Absolute Positioned (in accordions):', report.absolutePositioned);
            console.log('Sticky Elements:', report.stickyElements);
            console.groupEnd();
            
            return report;
        };
    </script>
</body>
</html>








