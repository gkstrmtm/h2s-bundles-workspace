<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="color-scheme" content="light">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Home2Smart">
        <title>Home2Smart - Service Tech Hiring Dashboard</title>
        <script>
            // Suppress vendor console spam
            (function() {
                const originalError = console.error;
                const originalWarn = console.warn;
                const originalLog = console.log;
                
                const filterPatterns = [
                    'ApolloClient',
                    'FeatureGateClients',
                    'vendor-',
                    'Failed to load resource',
                    '400 (Bad Request)',
                    'go.apollo.dev',
                    'msgsndr.com',
                    'Deprecated API',
                    'useLazyQuery',
                    'useQuery',
                    'onError',
                    'onCompleted',
                    'An error occurred!',
                    'err#%7B'
                ];

                function shouldSuppress(args) {
                    const msg = args.map(a => String(a)).join(' ');
                    return filterPatterns.some(p => msg.includes(p));
                }

                console.error = function(...args) {
                    if (!shouldSuppress(args)) originalError.apply(console, args);
                };
                
                console.warn = function(...args) {
                    if (!shouldSuppress(args)) originalWarn.apply(console, args);
                };

                console.log = function(...args) {
                    if (!shouldSuppress(args)) originalLog.apply(console, args);
                };
            })();

            // Server-injected API base URL (available when served via Apps Script template)
            // Falls back on client if not injected.
            try { window.API_URL = '<?= API_URL ?>'; } catch (e) { /* not templated */ }
        </script>
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;900&display=swap" rel="stylesheet">

    <!-- Dashboard Design System (single source of truth) -->
    <link rel="stylesheet" href="/dashboard-design-system.css">
    
    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="180x180" 
      href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png">
        <link rel="apple-touch-icon" sizes="180x180" href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png">
    <meta name="theme-color" content="#0a2a5a">
    
    <style>
        /* === CRITICAL CSS === */
        /* Font loaded via Google Fonts API link tag above */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Tokens live in dashboard-design-system.css */
        /* Hosted-safe fallback: if the design-system file 404s, these variables keep the UI readable. */
        :root {
            /* Brand */
            --primary: #1a365d;
            --primary-hover: #2d4a7c;
            --accent: #f59e0b;
            --accent-hover: #d97706;

            /* Semantic */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;

            /* Neutrals */
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;

            /* Surface */
            --bg-page: var(--gray-50);
            --bg-card: #ffffff;
            --border-default: var(--gray-200);
            --border-focus: var(--primary);

            /* Typography scale */
            --text-display: 40px;
            --text-h1: 32px;
            --text-h2: 24px;
            --text-h3: 20px;
            --text-body-lg: 18px;
            --text-body: 16px;
            --text-body-sm: 14px;
            --text-caption: 12px;

            --lh-tight: 1.1;
            --lh-title: 1.2;
            --lh-body: 1.5;

            /* Spacing (8px rhythm) */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;

            /* Component sizing */
            --radius-sm: 8px;
            --radius-md: 12px;
            --input-h: 44px;
            --input-h-touch: 48px;

            /* Elevation */
            --shadow-card: 0 1px 3px rgba(0, 0, 0, 0.05);

            /* Interaction */
            --ease: cubic-bezier(.22,.8,.32,1);

            /* Layout */
            --page-max: 1200px;
            --page-pad: clamp(16px, 4vw, 32px);

            /* Compatibility aliases (legacy Dash.html variables) */
            --cobalt: var(--primary);
            --azure: var(--info);
            --white: #ffffff;
            --danger: var(--error);
            --light: var(--gray-50);
            --border: var(--border-default);
            --surface: var(--bg-card);
            --surface-2: var(--gray-50);
            --text: var(--primary);
            --muted: rgba(26, 54, 93, 0.6);
            --control-h: var(--input-h);

            /* Compatibility elevations used throughout Dash.html */
            --elev-1: 0 2px 6px rgba(0,0,0,.20), 0 6px 18px rgba(0,0,0,.14);
            --elev-2: 0 6px 14px rgba(0,0,0,.24), 0 18px 28px rgba(0,0,0,.18);
            --elev-card: 0 2px 10px rgba(0,0,0,.08);
            --elev-card-lg: 0 16px 36px rgba(0,0,0,.22);

            /* Legacy spacing */
            --gap-1: 8px;
            --gap-2: 16px;
        }

        html {
            scroll-behavior: smooth;
            background: #0a2a5a !important;
        }

        body {
            font-family: Archivo, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: var(--cobalt) !important;
            background-color: #0a2a5a !important;
            min-height: 100vh;
            color: var(--white);
            -webkit-font-smoothing: antialiased;
        }

        /* ===== HEADER ===== */
        .h2s-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--white);
            box-shadow: var(--elev-2);
            border-bottom: 1px solid var(--border);
        }

        .h2s-head-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px var(--page-pad);
            max-width: none;
            margin: 0;
        }

        .h2s-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .h2s-logo img {
            width: 64px;
            height: 64px;
        }

        .h2s-logo-text {
            font-weight: 900;
            font-size: clamp(20px, 2.4vw, 28px);
            color: var(--cobalt);
            text-transform: lowercase;
        }

        .logout-btn {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 700;
            color: rgba(10, 42, 90, 0.7);
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(10, 42, 90, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            color: var(--cobalt);
            background: white;
            border-color: var(--cobalt);
            transform: translateY(-1px);
        }

        /* ===== MAIN ===== */
        .main {
            padding: var(--page-pad);
            max-width: none;
            margin: 0;
        }

        .page-title {
            font-weight: 900;
            font-size: clamp(20px, 3vw, 28px);
            color: var(--white);
            margin-bottom: var(--gap-2);
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: var(--gap-1);
            margin-bottom: var(--gap-2);
            flex-wrap: wrap;
            background: var(--white);
            padding: var(--gap-1);
            border-radius: var(--radius);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
        }

        .tab {
            background: transparent;
            border: none;
            color: var(--cobalt);
            font-weight: 700;
            font-size: 15px;
            padding: 12px var(--gap-2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
            opacity: 0.6;
        }
        
        .tab:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
        }

        .tab:hover {
            background: #eef2f7; /* Neutral hover, no color bleed */
            opacity: 1;
        }

        .tab.active {
            background: #0a2a5a; /* Brand cobalt */
            color: var(--white);
            box-shadow: 0 2px 8px rgba(10,42,90,0.2);
            opacity: 1;
        }

        /* ===== PANELS ===== */
        .pane {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            will-change: opacity, transform;
        }

        .pane.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.25s var(--ease);
        }
        
        /* Smooth tab switching indicator */
        .tab-switching-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--cobalt), var(--azure));
            transform: translateX(-100%);
            z-index: 9999;
            pointer-events: none;
            transition: transform 0.3s ease-out;
        }
        
        .tab-switching-indicator.active {
            transform: translateX(0%);
            animation: slideProgress 0.4s ease-out forwards;
        }
        
        @keyframes slideProgress {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(0%); }
            100% { transform: translateX(100%); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== OFFER BUILDER SCOPED STYLES (No cross-tab bleed) ===== */
        /* URGENT FIX: Ensure vertical alignment is always top */
        #offerbuilder-pane.hidden {
            display: none !important;
        }

        #offerbuilder-pane:not(.hidden) {
            display: block !important;
            position: absolute !important;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            z-index: 50;
            background: var(--surface-2);
            padding-top: 24px;
        }

        #offerbuilder-pane .ob-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        #offerbuilder-pane .ob-workspace {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--elev-card);
        }

        #offerbuilder-pane .ob-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        #offerbuilder-pane .ob-title {
            font-size: 28px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 4px;
            line-height: 1.15;
        }

        /* ===== PROOF PACKS EDITOR 2026 UI REFRESH ===== */
        :root {
            /* 2026 Modern Palette */
            --pp-primary: #0066ff;
            --pp-primary-hover: #0052cc;
            --pp-primary-light: #eff6ff;
            --pp-text-primary: #0f172a;
            --pp-text-secondary: #475569;
            --pp-text-muted: #64748b;
            --pp-bg-primary: #ffffff;
            --pp-bg-secondary: #fafafa;
            --pp-bg-tertiary: #f8fafc;
            --pp-border: #e2e8f0;
            --pp-border-hover: #cbd5e1;
            --pp-success: #16a34a;
            --pp-success-bg: #f0fdf4;
            --pp-shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --pp-shadow-md: 0 2px 4px rgba(0, 0, 0, 0.08);
            --pp-shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.12);
            --pp-radius-md: 8px;
            --pp-radius-lg: 10px;
            --pp-radius-pill: 20px;
        }

        /* Modern Editor Header */
        .editor-header {
            padding: 20px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between; /* Ensure spacing */
            align-items: center;
            background: var(--pp-bg-primary);
            border-radius: var(--pp-radius-lg) var(--pp-radius-lg) 0 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .editor-title { font-size: 18px; font-weight: 600; color: var(--pp-text-primary); margin: 0 0 4px 0; }
        .editor-subtitle { font-size: 13px; color: var(--pp-text-muted); margin: 0; }
        .editor-status { display: flex; align-items: center; gap: 12px; }
        .editor-badge { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--pp-success-bg); color: var(--pp-success); border-radius: 20px; font-size: 13px; font-weight: 500; }
        .editor-badge::before { content: ''; width: 6px; height: 6px; background: var(--pp-success); border-radius: 50%; }
        .editor-close { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 8px; cursor: pointer; color: var(--pp-text-muted); transition: all 150ms ease; }
        .editor-close:hover { background: var(--pp-bg-secondary); color: var(--pp-text-primary); }

        /* Modern Toolbar */
        .editor-toolbar {
            display: flex; align-items: center; gap: 8px; padding: 12px 24px;
            background: var(--pp-bg-secondary); border-bottom: 1px solid rgba(0,0,0,0.06);
            position: relative; /* Fix overlap - revert to flow */
            z-index: 40;
            justify-content: space-between;
        }
        
        .editor-tool-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            border: 1px solid transparent; background: white; border-radius: 8px; cursor: pointer;
            color: var(--pp-text-secondary); transition: all 150ms ease; box-shadow: var(--pp-shadow-sm);
        }
        .editor-tool-btn:hover { background: var(--pp-bg-tertiary); color: var(--pp-text-primary); box-shadow: var(--pp-shadow-md); }
        
        /* Sticky Footer - Now relative to content flow to ensure visibility */
        .editor-footer {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 24px;
            
            /* SOLID BACKGROUND FIX */
            background: #ffffff !important;
            opacity: 1 !important;
            backdrop-filter: none !important;
            
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
            z-index: 100;
            border-radius: 0 0 var(--pp-radius-lg) var(--pp-radius-lg);
        }

        .editor-cancel {
            padding: 10px 20px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
        }

        .editor-save {
            padding: 10px 24px;
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 150ms ease;
        }

        .editor-save:hover {
            background: #0052cc;
            box-shadow: 0 2px 8px rgba(0, 102, 255, 0.3);
        }
        
        .editor-save:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        /* Drag and Drop Destinations */
        .destination-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 150ms ease;
        }

        .destination-card:hover {
            border-color: #cbd5e1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .destination-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .drag-handle {
            font-size: 18px;
            color: #94a3b8;
            cursor: grab;
            padding-right: 8px;
            border-right: 1px solid #f1f5f9;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .destination-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .destination-name {
            font-size: 14px;
            font-weight: 600;
            color: #0f172a;
        }

        .destination-meta {
            font-size: 12px;
            color: #64748b;
        }
        
        .destination-actions {
            display: flex;
            gap: 8px;
        }

        .btn-preview, .btn-remove {
            padding: 6px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-remove {
            color: #ef4444;
            border-color: #fecaca;
        }

        .btn-remove:hover {
            background: #fef2f2;
        }

        .btn-add-destination {
            width: 100%;
            padding: 12px;
            border: 1px dashed #cbd5e1;
            background: #f8fafc;
            border-radius: 8px;
            color: #64748b;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
        }
        .btn-add-destination:hover {
            border-color: #94a3b8;
            color: #475569;
            background: #f1f5f9;
        }

        .editor-edited-badge {
            display: flex; align-items: center; gap: 6px; padding: 6px 12px;
            background: #dbeafe; color: #1e40af; border-radius: 20px; font-size: 12px; font-weight: 500;
        }
        .editor-edited-badge::before {
            content: ''; width: 6px; height: 6px; background: #3b82f6; border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        .editor-view-toggle {
            display: flex; gap: 2px; padding: 3px; background: white; border-radius: 10px;
            box-shadow: var(--pp-shadow-sm); border: 1px solid var(--pp-border);
        }
        .editor-view-btn {
            padding: 6px 16px; border: none; background: transparent; border-radius: 7px;
            font-size: 13px; font-weight: 500; color: var(--pp-text-muted); cursor: pointer;
            transition: all 150ms ease;
        }
        .editor-view-btn.active {
            background: var(--pp-primary); color: white;
            box-shadow: 0 2px 4px rgba(0, 102, 255, 0.2);
        }
        .editor-view-btn:not(.active):hover { background: var(--pp-bg-secondary); color: var(--pp-text-primary); }

        /* Modern Crop Presets */
        .crop-presets { display: flex; gap: 8px; padding: 16px 24px; background: white; flex-wrap: wrap; }
        .crop-preset-btn {
            display: flex; align-items: center; gap: 8px; padding: 10px 16px;
            border: 1px solid var(--pp-border); background: white; border-radius: 10px;
            font-size: 13px; font-weight: 500; color: var(--pp-text-secondary); cursor: pointer;
            transition: all 150ms ease;
        }
        .crop-preset-btn:hover {
            border-color: var(--pp-border-hover); background: var(--pp-bg-tertiary);
            transform: translateY(-1px); box-shadow: var(--pp-shadow-sm);
        }
        .crop-preset-btn.active {
            border-color: var(--pp-primary);
            background: linear-gradient(135deg, var(--pp-primary) 0%, #0052cc 100%);
            color: white; box-shadow: 0 2px 8px rgba(0, 102, 255, 0.25);
        }
        .crop-preset-icon { width: 18px; height: 18px; opacity: 0.7; fill: currentColor; }
        .crop-preset-btn.active .crop-preset-icon { opacity: 1; }

        /* Modern Controls */
        .pp-control-section { margin-bottom: 24px; }
        .editor-select label { display: block; font-size: 13px; font-weight: 500; color: var(--pp-text-secondary); margin-bottom: 6px; }
        .editor-select-trigger {
            width: 100%; padding: 10px 16px; border: 1px solid var(--pp-border);
            background: white; border-radius: 8px; font-size: 14px; color: var(--pp-text-primary);
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .editor-toggle { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; }
        .editor-toggle label { font-size: 13px; font-weight: 500; color: var(--pp-text-secondary); }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; transition: .2s; border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .2s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle-switch input:checked + .toggle-slider { background-color: var(--pp-primary); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Modern Sliders */
        .editor-slider-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .editor-slider-label span:first-child { font-size: 13px; font-weight: 500; color: var(--pp-text-secondary); }
        .editor-slider-label span:last-child { font-size: 12px; font-weight: 600; color: var(--pp-primary); font-variant-numeric: tabular-nums; }
        .editor-slider {
            width: 100%; height: 6px; background: var(--pp-border); border-radius: 3px;
            outline: none; appearance: none; -webkit-appearance: none; cursor: pointer;
        }
        .editor-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; background: white;
            border: 2px solid var(--pp-primary); border-radius: 50%; box-shadow: var(--pp-shadow-sm);
            transition: transform 0.1s; margin-top: -6px; /* Fix alignment */
        }
        .editor-slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .editor-slider::-moz-range-thumb {
             width: 18px; height: 18px; background: white;
            border: 2px solid var(--pp-primary); border-radius: 50%; box-shadow: var(--pp-shadow-sm);
            transition: transform 0.1s; cursor: pointer; border: none;
        }

        /* Frontend Preview */
        .editor-section-title { font-size: 15px; font-weight: 600; color: var(--pp-text-primary); margin: 0 0 16px 0; }
        .crop-mode-btn {
            flex: 1; padding: 10px 16px; border: 1px solid var(--pp-border); background: white;
            font-size: 13px; font-weight: 500; color: var(--pp-text-secondary); cursor: pointer;
            transition: all 150ms ease; display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .crop-mode-btn:first-child { border-radius: 8px 0 0 8px; }
        .crop-mode-btn:last-child { border-radius: 0 8px 8px 0; }
        .crop-mode-btn:not(:first-child) { border-left: none; }
        .crop-mode-btn.active {
            background: var(--pp-primary-light); color: #1e40af; border-color: var(--pp-primary);
            position: relative; z-index: 1;
        }
        .crop-mode-btn::before {
            content: ''; width: 12px; height: 12px; border: 2px solid #cbd5e1; border-radius: 50%;
        }
        .crop-mode-btn.active::before {
             background: var(--pp-primary); border-color: var(--pp-primary);
             box-shadow: 0 0 0 2px white, 0 0 0 4px var(--pp-primary) inset;
        }
        
        .focal-point-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; max-width: 160px; }
        .focal-point-btn {
            width: 48px; height: 48px; border: 1px solid var(--pp-border); background: white;
            border-radius: 8px; cursor: pointer; font-size: 16px; color: var(--pp-text-muted);
            transition: all 150ms ease; display: flex; align-items: center; justify-content: center;
        }
        .focal-point-btn:hover { border-color: var(--pp-border-hover); background: var(--pp-bg-tertiary); }
        .focal-point-btn.active {
            border-color: var(--pp-primary); background: var(--pp-primary); color: white;
            box-shadow: 0 2px 6px rgba(0, 102, 255, 0.3);
        }

        #offerbuilder-pane .ob-subtitle {
            margin: 0;
            font-size: 14px;
            color: var(--gray-600);
            opacity: 1;
        }

        #offerbuilder-pane .ob-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        #offerbuilder-pane .ob-btn {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-family: inherit;
            border: 1px solid transparent;
            box-shadow: var(--elev-card);
            transition: transform 0.2s var(--ease), box-shadow 0.22s var(--ease-smooth), opacity 0.2s var(--ease);
            white-space: nowrap;
        }

        #offerbuilder-pane .ob-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--elev-1);
        }

        #offerbuilder-pane .ob-btn:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
        }

        #offerbuilder-pane .ob-btn--primary {
            background: var(--cobalt);
            color: var(--white);
            border-color: rgba(255,255,255,0.12);
        }

        #offerbuilder-pane .ob-btn--secondary {
            background: var(--surface);
            color: var(--cobalt);
            border-color: var(--border);
        }

        #offerbuilder-pane .ob-btn--success {
            background: var(--success);
            color: var(--white);
            border-color: var(--success);
        }

        #offerbuilder-pane .ob-btn--warning {
            background: var(--warning);
            color: var(--cobalt);
            border-color: var(--warning);
        }

        #offerbuilder-pane .ob-btn--tertiary {
            background: transparent;
            color: var(--cobalt);
            border-color: var(--border);
            box-shadow: none;
        }

        #offerbuilder-pane .ob-btn--tertiary:hover {
            background: #f8fafc;
            border-color: #94a3b8;
        }

        #offerbuilder-pane .ob-btn--icon {
            width: 38px;
            height: 38px;
            padding: 0;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
        }

        #offerbuilder-pane .ob-btn--small {
            padding: 7px 12px;
            font-size: 12px;
            border-radius: 10px;
        }

        /* Stepper */
        #offerbuilder-pane .ob-stepper {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #offerbuilder-pane .ob-stepper-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        #offerbuilder-pane .ob-stepper-title {
            font-size: 13px;
            font-weight: 900;
            color: var(--cobalt);
        }

        #offerbuilder-pane .ob-stepper-track {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 10px;
            align-items: center;
        }

        #offerbuilder-pane .ob-step {
            display: grid;
            grid-template-columns: 34px 1fr;
            gap: 10px;
            align-items: center;
            background: transparent;
            border: 1px solid transparent;
            padding: 8px 10px;
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            min-width: 0;
        }

        #offerbuilder-pane .ob-step:hover {
            background: #f8fafc;
            border-color: #e2e8f0;
        }

        #offerbuilder-pane .ob-step-circle {
            width: 30px;
            height: 30px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 13px;
            border: 2px solid #e2e8f0;
            color: #94a3b8;
            background: #ffffff;
        }

        #offerbuilder-pane .ob-step-label {
            font-size: 12px;
            font-weight: 800;
            color: #64748b;
            line-height: 1.15;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #offerbuilder-pane .ob-step.is-done .ob-step-circle {
            background: #10b981;
            border-color: #10b981;
            color: #ffffff;
        }

        #offerbuilder-pane .ob-step.is-current {
            background: #eff6ff;
            border-color: rgba(10, 42, 90, 0.15);
        }

        #offerbuilder-pane .ob-step.is-current .ob-step-circle {
            background: var(--cobalt);
            border-color: var(--cobalt);
            color: #ffffff;
            box-shadow: 0 0 0 4px rgba(10, 42, 90, 0.12);
        }

        #offerbuilder-pane .ob-step.is-current .ob-step-label {
            color: var(--cobalt);
        }

        /* Info banner + improved empty state */
        #offerbuilder-pane .ob-info-banner {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-left: 3px solid #3b82f6;
            border-radius: 10px;
            padding: 12px;
            color: #1e40af;
            font-size: 12px;
        }

        #offerbuilder-pane .ob-empty {
            text-align: center;
            padding: 44px 18px;
            border: 1px dashed #cbd5e1;
            border-radius: 14px;
            background: #f8fafc;
            color: #475569;
        }

        #offerbuilder-pane .ob-empty-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        #offerbuilder-pane .ob-empty-title {
            font-size: 16px;
            font-weight: 900;
            color: var(--cobalt);
            margin-bottom: 6px;
        }

        #offerbuilder-pane .ob-empty-subtitle {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            #offerbuilder-pane .ob-stepper-track {
                display: flex;
                gap: 10px;
                overflow-x: auto;
                padding-bottom: 6px;
                -webkit-overflow-scrolling: touch;
            }

            #offerbuilder-pane .ob-step {
                min-width: 210px;
            }
        }

        #offerbuilder-pane #offerBuilderLastUpdate {
            padding: 8px 12px;
            font-size: 12px;
            color: var(--white);
            opacity: 0.75;
        }

        #offerbuilder-pane .ob-strip {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 24px;
            box-shadow: var(--elev-card);
        }

        #offerbuilder-pane .ob-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--elev-card);
        }

        #offerbuilder-pane .ob-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        #offerbuilder-pane .ob-card-title {
            font-size: 16px;
            font-weight: 800;
            color: var(--cobalt);
            margin: 0 0 4px 0;
        }

        #offerbuilder-pane .ob-card-subtitle {
            font-size: 12px;
            color: var(--muted);
            margin: 0;
        }

        #offerbuilder-pane .ob-divider {
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        #offerbuilder-pane #offerBuilderMainGrid {
            display: grid !important;
            grid-template-columns: 1.5fr 1fr !important;
            gap: var(--gap-2) !important;
            align-items: start;
            /* Ensure grid items can expand naturally when content grows */
            min-height: 0;
        }
        
        /* Ensure left column (accordion container) allows natural expansion */
        #offerbuilder-pane #offerBuilderMainGrid > div:first-child {
            min-height: 0;
            overflow: visible;
        }

        #offerbuilder-pane #offerBuilderRightColumn {
            display: flex;
            flex-direction: column;
            gap: var(--gap-2) !important;
            position: relative;
            min-width: 0;
            align-items: stretch;
            /* Ensure flex children can expand naturally */
            min-height: 0;
        }

        #offerbuilder-pane #offerBuilderStandards,
        #offerbuilder-pane #offerBuilderTotals {
            min-width: 0;
            width: 100%;
            flex-shrink: 0;
        }
        
        /* Standards panel - sticky at top */
        #offerbuilder-pane #offerBuilderStandards {
            position: sticky;
            top: 90px;
            align-self: flex-start;
            max-height: calc(50vh - 60px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        #offerbuilder-pane #offerBuilderStandardsContent {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px;
        }
        
        /* Totals panel - NOT sticky, flows naturally */
        #offerbuilder-pane #offerBuilderTotals {
            position: relative;
            align-self: flex-start;
        }
        
        /* Ensure Totals content can scroll if panel is tall */
        #offerbuilder-pane #offerBuilderResults {
            max-height: calc(100vh - var(--totals-top-offset, 300px) - 100px); /* Top offset + panel padding/header (~100px) */
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Mobile: Stack columns vertically */
        @media (max-width: 768px) {
            #offerbuilder-pane #offerBuilderMainGrid {
                grid-template-columns: 1fr;
            }
            
            #offerbuilder-pane #offerBuilderStandards,
            #offerbuilder-pane #offerBuilderTotals {
                position: relative !important;
                top: auto !important;
            }
            
            /* Remove max-height constraints on mobile for full content visibility */
            #offerbuilder-pane #offerBuilderStandardsContent,
            #offerbuilder-pane #offerBuilderResults {
                max-height: none !important;
                overflow-y: visible !important;
            }
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--gap-2);
            margin-bottom: var(--gap-2);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: clamp(18px, 2.2vw, 22px);
            color: var(--text);
            margin-bottom: var(--gap-2);
            font-weight: 900;
        }

        /* ===== GLOBAL SCROLLBAR ===== */
        /* Applies to all scrollable elements including textareas */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #dadce0;
            border-radius: 4px;
            border: 2px solid transparent;
            background-clip: content-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #bdc1c6;
        }

        /* ===== PIPELINE COLUMNS ===== */
        .pipeline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .pipeline-column {
            background: var(--white);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            min-height: 400px;
            max-height: 600px;
        }

        .pipeline-header {
            font-weight: 900;
            font-size: 16px;
            color: var(--cobalt);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .pipeline-count {
            background: var(--azure);
            color: var(--white);
            border-radius: 12px;
            padding: 4px 10px;
            font-size: 13px;
        }

        .pipeline-cards-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 12px;
            padding-right: 4px;
        }

        .pipeline-cards-container::-webkit-scrollbar {
            width: 6px;
        }

        .pipeline-cards-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .pipeline-cards-container::-webkit-scrollbar-thumb:hover {
            background: var(--azure);
        }

        .pipeline-pagination {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 8px 4px;
            border-top: 2px solid var(--border);
            font-size: 13px;
            color: #5f6368;
            font-weight: 600;
        }

        .pagination-info {
            font-size: 12px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .page-btn {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            color: var(--cobalt);
        }

        .page-btn:hover:not(:disabled) {
            background: var(--azure);
            color: white;
            border-color: var(--azure);
        }

        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .candidate-card {
            background: var(--light);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s var(--ease);
            border: 1px solid var(--border);
        }

        .candidate-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
            background: white;
        }

        .candidate-name {
            font-weight: 700;
            font-size: 14px;
            color: var(--cobalt);
            margin-bottom: 4px;
        }

        .candidate-info {
            font-size: 12px;
            color: #5f6368;
            margin-bottom: 2px;
        }

        .candidate-info strong {
            font-weight: 600;
            color: var(--cobalt);
        }

        .candidate-date {
            font-size: 11px;
            color: #80868b;
            margin-top: 4px;
            font-style: italic;
        }

        .candidate-outcome {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 6px;
        }

        .outcome-ready {
            background: #E8F5E9;
            color: var(--success);
        }

        .outcome-warm {
            background: #FFF9C4;
            color: #F57F17;
        }

        .outcome-hold {
            background: #E3F2FD;
            color: #1976D2;
        }

        .outcome-not-match {
            background: #FFEBEE;
            color: var(--danger);
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: var(--gap-2);
        }

        .form-label {
            display: block;
            font-weight: 700;
            color: var(--text);
            margin-bottom: var(--gap-1);
            font-size: 15px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 13px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s var(--ease);
            background: var(--white);
            color: var(--cobalt);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
            outline: none;
            border-color: var(--azure);
            box-shadow: 0 0 0 3px rgba(20, 147, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--gap-2);
        }

        /* ===== BUTTONS ===== */
        .btn {
            border: 2px solid var(--azure);
            background: var(--azure);
            color: var(--white);
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            padding: 13px 24px;
            font-size: 15px;
            transition: transform 0.2s var(--ease), box-shadow 0.22s var(--ease-smooth);
            box-shadow: var(--elev-1);
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-2);
        }
        
        .btn:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
        }
        
        .btn:active {
            transform: translateY(0);
            transition: transform 0.1s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: var(--success);
            border-color: var(--success);
        }

        /* ===== SPINNER ===== */
        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid #e0e0e0; /* Darker track for visibility */
            border-top: 4px solid var(--azure);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .empty-text {
            font-size: 16px;
            font-weight: 600;
            color: #5f6368; /* Darker gray for readability */
        }

        /* ===== GHL FORM IFRAME STYLING ===== */
        #screening-pane .card,
        #techinterview-pane .card {
            min-height: 1200px;
            padding-bottom: 40px;
        }

        #screening-pane iframe,
        #techinterview-pane iframe {
            min-height: 1200px;
        }

        /* ===== AI PROFILE CARDS ===== */
        .ai-profiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .ai-profile-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--elev-card);
            border: 2px solid var(--border);
            transition: all 0.3s var(--ease);
        }

        .ai-profile-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--elev-card-lg);
        }

        .ai-profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .ai-profile-name {
            font-weight: 900;
            font-size: 20px;
            color: var(--cobalt);
            margin-bottom: 6px;
        }

        .ai-profile-contact {
            font-size: 13px;
            color: #5f6368;
            margin: 2px 0;
        }

        .ai-fit-score {
            text-align: center;
            min-width: 80px;
        }

        .ai-score-number {
            font-size: 36px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 4px;
        }

        .ai-score-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #5f6368;
        }

        .score-10, .score-9 { color: #34A853; }
        .score-8, .score-7 { color: #FBBC04; }
        .score-6, .score-5, .score-4 { color: #FF9800; }
        .score-3, .score-2, .score-1, .score-0 { color: #EA4335; }

        .ai-recommendation {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .rec-hire {
            background: #E8F5E9;
            color: #34A853;
            border: 2px solid #34A853;
        }

        .rec-maybe {
            background: #FFF9C4;
            color: #F57F17;
            border: 2px solid #FBBC04;
        }

        .rec-pass {
            background: #FFEBEE;
            color: #EA4335;
            border: 2px solid #EA4335;
        }

        .ai-section {
            margin-bottom: 16px;
        }

        .ai-section-title {
            font-weight: 700;
            font-size: 13px;
            color: var(--cobalt);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .ai-summary {
            color: #202124;
            font-size: 15px;
            line-height: 1.6;
        }

        .ai-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .ai-list li {
            padding: 6px 0 6px 20px;
            position: relative;
            color: #202124;
            font-size: 14px;
            line-height: 1.5;
        }

        .ai-list li:before {
            content: "\2022";
            position: absolute;
            left: 0;
            color: var(--azure);
            font-weight: 900;
            font-size: 18px;
        }

        .ai-profile-footer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: #80868b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-model-badge {
            background: var(--cobalt);
            color: var(--white);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 11px;
        }

        /* ===== FILTER BUTTONS ===== */
        .filter-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: var(--white);
            border: 2px solid var(--border);
            color: var(--cobalt);
            font-weight: 700;
            font-size: 14px;
            padding: 10px 16px;
            border-radius: 999px; /* pill */
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
        }

        .filter-btn:hover {
            border-color: #0a2a5a;
            background: #eef2f7;
        }

        .filter-btn.active {
            background: #0a2a5a; /* solid brand blue */
            color: var(--white);
            border-color: #0a2a5a;
            box-shadow: 0 2px 8px rgba(10,42,90,0.2);
        }

        /* ===== ACTION BUTTONS ===== */
        .ai-profile-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid var(--border);
        }

        .action-btn {
            flex: 1;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
            border: 2px solid;
        }

        .pass-btn {
            background: #E8F5E9;
            color: var(--success);
            border-color: var(--success);
        }

        .pass-btn:hover {
            background: var(--success);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .fail-btn {
            background: #FFEBEE;
            color: var(--danger);
            border-color: var(--danger);
        }

        .fail-btn:hover {
            background: var(--danger);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        /* ===== DECISION BADGE ===== */
        .decision-badge {
            display: inline-block;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 900;
            font-size: 14px;
            text-align: center;
            margin-top: 16px;
            width: 100%;
        }

        .decision-badge.pass {
            background: #E8F5E9;
            color: var(--success);
            border: 2px solid var(--success);
        }

        .decision-badge.fail {
            background: #FFEBEE;
            color: var(--danger);
            border: 2px solid var(--danger);
        }

        .decision-badge small {
            display: block;
            margin-top: 6px;
            font-size: 11px;
            font-weight: 600;
            opacity: 0.8;
        }

        /* ===== TRAINING RESOURCES ===== */
        .training-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 32px;
            margin-top: 24px;
        }

        .training-filter-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .training-filter-tab:hover {
            border-bottom-color: #0a2a5a !important;
            color: #0a2a5a !important;
        }
        .training-filter-tab.active {
            color: #0a2a5a !important;
            border-bottom-color: #0a2a5a !important;
        }
        .training-filter-tab.active span {
            background: #0a2a5a !important;
            color: white !important;
        }
        .training-resource-item {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .training-resource-item.hidden {
            display: none !important;
        }

        .training-card {
            background: var(--white);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .training-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
        }

        .training-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .training-title {
            font-weight: 900;
            font-size: 18px;
            color: var(--cobalt);
            margin-bottom: 4px;
        }

        .training-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }



        /* Status badges: Not Started / In Progress / Completed */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 800;
        }
        .status-not-started { background: #eef2f7; color: #0a2a5a; }
        .status-in-progress { background: #fff9c4; color: #f57f17; }
        .status-completed   { background: #e8f5e9; color: #2e7d32; }

        .type-video {
            background: #E3F2FD;
            color: #1976D2;
        }

        .type-pdf {
            background: #FFEBEE;
            color: #D32F2F;
        }

        .type-sop {
            background: #FFF9C4;
            color: #F57F17;
        }

        .training-embed {
            width: 100%;
            aspect-ratio: 16/9;
            border-radius: 10px;
            margin: 12px 0; /* tighter */
            border: 0;
            overflow: hidden;
            box-shadow: var(--elev-card);
            background: #000;
        }

        .training-description {
            color: #5f6368;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .training-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--azure);
            color: var(--white);
            border: 0; /* Remove any outline/border artifacts */
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s var(--ease);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        .training-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .training-category {
            display: inline-block;
            padding: 6px 12px;
            background: #0a2a5a;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            color: white;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }

        /* ===== TRAINING KNOWLEDGE PROFILE ===== */
        .knowledge-profile {
            background: #F8F9FA; /* Neutral, professional background */
            border-radius: 16px;
            padding: 24px;
            color: #202124;
            margin-bottom: 24px;
            box-shadow: var(--elev-card);
            border: 2px solid var(--border);
        }

        .knowledge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .knowledge-title {
            font-size: 20px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mastery-score {
            font-size: 48px;
            font-weight: 900;
            text-align: center;
        }

        .mastery-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .knowledge-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        .knowledge-stat {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 900;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .skills-section {
            margin-top: 20px;
        }

        .skills-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .skills-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .skill-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .skill-badge.strong {
            background: rgba(76, 175, 80, 0.3);
        }

        .skill-badge.gap {
            background: rgba(255, 193, 7, 0.3);
        }

        .skill-score {
            font-weight: 900;
        }

        /* ===== COMPLETION MODAL ===== */
        .completion-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .completion-modal.active {
            display: flex;
        }

        .completion-modal-content {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--elev-card-lg);
            animation: slideUp 0.3s var(--ease);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .completion-modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .completion-modal-icon {
            font-size: 32px;
        }

        .completion-modal-title {
            font-size: 24px;
            font-weight: 900;
            color: var(--cobalt);
            flex: 1;
        }

        .completion-field {
            margin-bottom: 24px;
        }

        .completion-field label {
            display: block;
            font-weight: 700;
            color: var(--cobalt);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .completion-field textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .completion-field textarea:focus {
            outline: none;
            border-color: var(--azure);
        }

        .star-rating {
            display: flex;
            gap: 8px;
            font-size: 32px;
        }

        .star {
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            color: #d1d5db;
            opacity: 0.3;
            font-size: 32px;
            line-height: 1;
            display: inline-block;
            position: relative;
            pointer-events: auto;
        }
        
        .star::before {
            content: '\2605';
            pointer-events: none;
        }

        .star:hover {
            opacity: 0.7;
            transform: scale(1.1);
        }
        
        .star.active {
            color: #fbbf24;
            opacity: 1;
            transform: scale(1.2);
        }

        .completion-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .completion-actions button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-submit {
            background: var(--azure);
            color: white;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .btn-cancel {
            background: var(--light);
            color: var(--cobalt);
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        /* ===== COMPLETION INDICATORS ===== */
        .completed-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            margin-top: 12px;
        }

        .training-footer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .complete-btn {
            padding: 10px 20px;
            background: var(--azure);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .skill-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .skill-tag {
            padding: 4px 10px;
            background: #E3F2FD;
            color: #1976D2;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .difficulty-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .difficulty-beginner {
            background: #C8E6C9;
            color: #2E7D32;
        }

        .difficulty-intermediate {
            background: #FFF9C4;
            color: #F57F17;
        }

        .difficulty-advanced {
            background: #FFCCBC;
            color: #D84315;
        }

        /* ===== TASKS ===== */
        .tasks-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .tasks-columns {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }
        }

        .tasks-column {
            background: var(--light);
            border-radius: 16px;
            padding: 20px;
            border: 2px solid var(--border);
        }

        .tasks-column-header {
            font-weight: 900;
            font-size: 20px;
            color: var(--cobalt);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--border);
        }

        .tasks-column-count {
            background: var(--azure);
            color: var(--white);
            border-radius: 12px;
            padding: 6px 14px;
            font-size: 14px;
            font-weight: 700;
        }

        .tasks-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .task-card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--elev-card);
            border: 2px solid var(--border);
            transition: all 0.3s var(--ease);
            cursor: pointer;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-card-lg);
        }

        .task-card.priority-high {
            border-left: 6px solid var(--danger);
        }

        .task-card.priority-medium {
            border-left: 6px solid var(--warning);
        }

        .task-card.priority-low {
            border-left: 6px solid var(--success);
        }

        .task-card.status-completed {
            opacity: 0.85;
            background: #f8fdf9;
        }

        .task-card.status-completed .task-title {
            color: #5f6368;
        }

        /* Task Modal */
        .task-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s var(--ease);
        }

        .task-modal-overlay.active {
            display: flex;
        }

        .task-modal {
            background: var(--white);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--elev-card-lg);
            animation: slideUp 0.3s var(--ease);
            color: #333; /* Ensure text is dark */
        }

        .task-modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: #f8f9fa;
            border-radius: 20px 20px 0 0;
        }

        .task-modal-body {
            padding: 32px;
        }

        .task-modal-actions {
            padding: 24px 32px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8f9fa;
            border-radius: 0 0 20px 20px;
        }

        /* Form Styles for Add Task */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #202124; /* High contrast dark gray */
            font-size: 14px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dadce0; /* Thicker, visible border */
            border-radius: 8px;
            font-family: inherit;
            font-size: 15px;
            transition: all 0.2s;
            background-color: #ffffff !important; /* Force white bg */
            color: #202124 !important; /* Force dark text */
        }

        /* Modern styled select dropdown */
        .form-select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%235f6368" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px;
        }

        .form-input::placeholder, 
        .form-textarea::placeholder {
            color: #5f6368; /* Darker placeholder for visibility */
            opacity: 1;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--azure);
            box-shadow: 0 0 0 4px rgba(20, 147, 255, 0.15);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
            line-height: 1.5;
        }

        .btn-primary {
            background: var(--azure);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }

        /* Calendar (date/time) modal */
        .calendar-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(6px);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .calendar-modal-overlay.active { display: flex; }
        .calendar-modal {
            background: var(--white);
            border-radius: 16px;
            width: 480px;
            max-width: 95vw;
            box-shadow: var(--elev-card-lg);
            overflow: hidden;
        }
        .calendar-modal-header {
            padding: 16px 20px;
            border-bottom: 2px solid var(--border);
            font-weight: 900;
            color: var(--cobalt);
        }
        .calendar-modal-body { padding: 20px; }
        .calendar-modal-actions {
            padding: 16px 20px;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-primary:hover {
            background: #0077e6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 119, 230, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #5f6368;
            border: 2px solid #dadce0;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 15px;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #c1c3c7;
            color: #202124;
        }

        .btn-magic {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); /* Vivid Indigo/Violet */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
        }

        .btn-magic:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            filter: brightness(1.1);
        }

        .btn-magic:disabled {
            opacity: 0.7;
            cursor: wait;
            filter: grayscale(20%);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .task-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            padding: 32px 32px 24px;
            border-bottom: 2px solid var(--border);
        }

        .task-modal-close {
            background: var(--light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s var(--ease);
            flex-shrink: 0;
        }

        .task-modal-close:hover {
            background: var(--danger);
            color: var(--white);
            transform: rotate(90deg);
        }

        .task-modal-body {
            padding: 32px;
        }

        .task-modal-actions {
            padding: 24px 32px 32px;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 12px;
        }

        .task-action-btn {
            flex: 1;
            padding: 16px 24px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
            border: 2px solid;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .task-complete-btn {
            background: #E8F5E9;
            color: var(--success);
            border-color: var(--success);
        }

        .task-complete-btn:hover {
            background: var(--success);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .task-uncomplete-btn {
            background: #FFF9C4;
            color: #F57F17;
            border-color: #FBBC04;
        }

        .task-uncomplete-btn:hover {
            background: #FBBC04;
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .task-close-btn {
            background: var(--light);
            color: var(--cobalt);
            border-color: var(--border);
        }

        .task-close-btn:hover {
            background: var(--cobalt);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        /* ===== HOURS HISTORY TABLE ===== */
        .hours-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .hours-table th {
            background: var(--light);
            color: var(--cobalt);
            font-weight: 900;
            text-align: left;
            padding: 14px 16px;
            border-bottom: 2px solid var(--border);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hours-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
        }

        .hours-table tr:hover {
            background: #F8F9FA;
        }

        /* ===== GHL EMBED STYLE CONTAINMENT ===== */
        /* Prevent GoHighLevel styles from bleeding into hours logging UI */
        #hoursModal,
        #hoursModal *,
        #hoursHistoryContainer,
        #hoursHistoryContainer * {
            box-sizing: border-box;
        }

        #hoursModal .task-modal {
            max-width: 600px !important;
            background: white !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }

        #hoursModal .form-input,
        #hoursModal .form-textarea {
            font-family: inherit !important;
            font-size: 14px !important;
            background: white !important;
            border: 1px solid #dadce0 !important;
        }

        #hoursModal button {
            font-family: inherit !important;
            cursor: pointer !important;
        }

        #hoursHistoryContainer {
            max-width: 100% !important;
            overflow-x: auto !important;
        }

        .hours-table {
            background: white !important;
            font-family: inherit !important;
        }

        .hours-table th,
        .hours-table td {
            background: inherit !important;
            color: inherit !important;
        }

        .hours-date {
            font-weight: 700;
            color: var(--cobalt);
            font-size: 14px;
        }

        .hours-amount {
            font-weight: 900;
            color: var(--azure);
            font-size: 18px;
        }

        .hours-summary {
            color: var(--cobalt);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .hours-details {
            font-size: 12px;
            color: #5f6368;
            line-height: 1.5;
        }

        .productivity-score {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-weight: 900;
            font-size: 18px;
            background: linear-gradient(135deg, var(--azure), var(--cobalt));
            color: var(--white);
            box-shadow: var(--elev-1);
        }

        .productivity-score.low {
            background: linear-gradient(135deg, #FFA726, #FB8C00);
        }

        .productivity-score.medium {
            background: linear-gradient(135deg, #FBBC04, #F9A825);
        }

        .productivity-score.high {
            background: linear-gradient(135deg, #66BB6A, #43A047);
        }

        .input-output-box {
            background: #F8F9FA;
            padding: 12px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 12px;
            line-height: 1.6;
        }

        .input-output-label {
            font-weight: 700;
            color: var(--cobalt);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }


        .task-title {
            font-weight: 900;
            font-size: 18px;
            color: var(--cobalt);
            margin-bottom: 4px;
        }

        .task-card.status-completed .task-title {
            text-decoration: line-through;
            color: #80868b;
        }

        .task-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-priority-badge,
        .task-status-badge,
        .task-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-high-badge {
            background: #FFEBEE;
            color: var(--danger);
        }

        .priority-medium-badge {
            background: #FFF9C4;
            color: #F57F17;
        }

        .priority-low-badge {
            background: #E8F5E9;
            color: var(--success);
        }

        .status-pending-badge {
            background: #E3F2FD;
            color: #1976D2;
        }

        .status-in-progress-badge {
            background: #FFF9C4;
            color: #F57F17;
        }

        .status-completed-badge {
            background: #E8F5E9;
            color: var(--success);
        }

        .type-document-badge {
            background: #FFEBEE;
            color: #D32F2F;
        }

        .type-text-badge {
            background: #E3F2FD;
            color: #1976D2;
        }

        .type-link-badge {
            background: #F3E5F5;
            color: #7B1FA2;
        }

        .task-content {
            color: #202124;
            font-size: 15px;
            line-height: 1.6;
            margin: 16px 0;
            white-space: pre-wrap;
        }

        .task-description {
            color: #5f6368;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .task-embed {
            width: 100%;
            min-height: 600px;
            border-radius: 12px;
            margin: 16px 0;
            border: 0; /* Match embed styling to avoid harsh borders */
            overflow: hidden;
            box-shadow: var(--elev-card);
        }

        .task-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--azure);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s var(--ease);
            cursor: pointer;
        }

        .task-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--elev-1);
        }

        .task-footer {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 12px;
            color: #80868b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .task-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .task-category {
            display: inline-block;
            padding: 4px 10px;
            background: var(--light);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--cobalt);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            background: white;
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 320px;
            max-width: 450px;
            animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-left: none;
            position: relative;
            overflow: hidden;
        }

        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
        }

        .toast.success::before { background: var(--success); }
        .toast.error::before { background: var(--danger); }
        .toast.info::before { background: var(--azure); }

        .toast-icon {
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .toast.success .toast-icon { background: #dcfce7; color: var(--success); }
        .toast.error .toast-icon { background: #fee2e2; color: var(--danger); }
        .toast.info .toast-icon { background: #eff6ff; color: var(--azure); }

        .toast-message {
            flex: 1;
            color: #1f2937;
            font-weight: 600;
            font-size: 15px;
            line-height: 1.4;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        /* ===== CUSTOM MODAL DIALOG ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 99999;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            animation: slideUp 0.3s ease;
            position: relative;
            margin: auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-dialog-content {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-header {
            font-size: 22px;
            font-weight: 900;
            color: var(--cobalt);
            margin: 0;
            padding: 24px 32px;
            border-bottom: 2px solid #e5e7eb;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-body {
            font-size: 15px;
            color: #5f6368;
            line-height: 1.6;
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding: 24px 32px;
            border-top: 2px solid #e5e7eb;
            background: white;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s var(--ease);
            font-family: inherit;
        }

        .modal-btn-cancel {
            background: var(--light);
            color: var(--cobalt);
        }

        .modal-btn-cancel:hover {
            background: #ddd;
        }

        .modal-btn-confirm {
            background: var(--azure);
            color: white;
        }

        .modal-btn-confirm:hover {
            background: #0a2a5a;
            transform: translateY(-1px);
            box-shadow: var(--elev-1);
        }

        .modal-btn-danger {
            background: var(--danger);
            color: white;
        }

        .modal-btn-danger:hover {
            background: #c62828;
            transform: translateY(-1px);
            box-shadow: var(--elev-1);
        }

        /* Delete button on cards */
        .card-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 11px;
            font-weight: 700;
            color: var(--danger);
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s var(--ease);
        }

        .candidate-card {
            position: relative;
        }

        .candidate-card:hover .card-delete-btn {
            opacity: 1;
        }

        .card-delete-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* USER GATE MODAL */
        #userGate {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a2a5a 0%, #051428 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease;
            backdrop-filter: blur(0);
        }

        #userGate.hidden {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            to { 
                opacity: 0;
                backdrop-filter: blur(10px);
            }
        }

        .user-gate-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 56px 48px;
            box-shadow: 
                0 30px 90px rgba(0,0,0,0.4),
                0 0 1px rgba(255,255,255,0.5) inset;
            max-width: 460px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            animation: cardEnter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.1s forwards;
            position: relative;
            overflow: hidden;
        }

        @keyframes cardEnter {
            to {
                transform: scale(1);
            }
        }

        .user-gate-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            to { left: 100%; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .user-gate-logo {
            width: 96px;
            height: 96px;
            margin: 0 auto 24px;
            border-radius: 50%;
            box-shadow: 0 8px 24px rgba(10, 42, 90, 0.2);
            animation: logoPulse 2s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .user-gate-title {
            font-size: 28px;
            font-weight: 900;
            background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0 0 8px 0;
            letter-spacing: -0.5px;
        }

        .user-gate-subtitle {
            font-size: 15px;
            color: #666;
            margin: 0 0 40px 0;
            font-weight: 500;
        }

        .user-gate-select-wrapper {
            position: relative;
            margin-bottom: 24px;
        }

        .user-gate-select-wrapper::after {
            content: 'v';
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #0a2a5a;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .user-gate-select-wrapper:has(select:focus)::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .user-gate-select {
            width: 100%;
            padding: 18px 48px 18px 20px;
            font-size: 16px;
            font-weight: 600;
            color: #0a2a5a;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 2px solid #e3e8ef;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .user-gate-select:hover {
            border-color: #0a2a5a;
            background: white;
            box-shadow: 0 4px 12px rgba(10, 42, 90, 0.1);
            transform: translateY(-2px);
        }

        .user-gate-select:focus {
            outline: none;
            border-color: #0a2a5a;
            background: white;
            box-shadow: 
                0 0 0 4px rgba(10, 42, 90, 0.1),
                0 8px 20px rgba(10, 42, 90, 0.15);
            transform: translateY(-2px);
        }

        .user-gate-select option {
            padding: 12px;
            font-weight: 600;
        }

        .user-gate-btn {
            width: 100%;
            padding: 18px 24px;
            font-size: 16px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
        }

        .user-gate-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .user-gate-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .user-gate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 12px 28px rgba(10, 42, 90, 0.35),
                0 0 0 1px rgba(255,255,255,0.1) inset;
        }

        .user-gate-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(10, 42, 90, 0.3);
        }

        .user-gate-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .user-gate-btn:disabled:hover::before {
            width: 0;
            height: 0;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0;
                backdrop-filter: blur(0);
            }
            to { 
                opacity: 1;
                backdrop-filter: blur(0);
            }
        }

        /* ===== MOBILE OPTIMIZATION ===== */
        @media (max-width: 768px) {
            /* Prevent horizontal scroll and layout breaks */
            html, body {
                overflow-x: hidden !important;
                width: 100% !important;
                max-width: 100vw !important;
            }
            
            #h2s-app {
                width: 100% !important;
                max-width: 100vw !important;
                overflow-x: hidden !important;
            }
            
            /* Layout & Spacing */
            .main {
                padding: var(--gap-2) !important;
                width: 100% !important;
                max-width: 100vw !important;
            }
            
            .h2s-head-row {
                padding: 12px var(--gap-2) !important;
                flex-direction: row !important;
                gap: var(--gap-1);
            }
            
            #h2s-app .app-content {
                padding: var(--gap-2) !important;
            }
            
            #h2s-app .workbench-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            #h2s-app .workbench-search {
                max-width: none;
            }

            .h2s-logo img {
                width: 40px !important;
                height: 40px !important;
            }

            .h2s-logo-text {
                font-size: 20px !important;
            }

            .logout-btn {
                padding: 6px 12px !important;
                font-size: 12px !important;
            }

            /* Typography Sizing */
            .page-title {
                font-size: 20px !important;
                margin-bottom: var(--gap-2) !important;
            }
            
            .card-title {
                font-size: 18px !important;
            }
            
            .card {
                padding: var(--gap-2) !important;
                margin-bottom: var(--gap-2) !important;
            }

            /* Tabs - Horizontal Scroll */
            .tabs {
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                padding: 4px !important;
                margin-bottom: 20px !important;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
                gap: 8px !important;
                background: transparent !important;
                box-shadow: none !important;
                border: none !important;
            }
            .tabs::-webkit-scrollbar {
                display: none; /* Chrome/Safari */
            }
            .tab {
                white-space: nowrap !important;
                flex-shrink: 0 !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
                background: rgba(255,255,255,0.1) !important;
                color: rgba(255,255,255,0.7) !important;
                border: 1px solid rgba(255,255,255,0.2) !important;
                border-radius: 20px !important;
            }
            .tab.active {
                background: white !important;
                color: var(--cobalt) !important;
                border-color: white !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
                opacity: 1 !important;
            }

            /* Pipeline Columns - Stacked */
            .pipeline {
                grid-template-columns: 1fr !important;
                gap: var(--gap-2) !important;
            }
            
            .pipeline-column {
                min-height: auto !important;
                max-height: 500px !important;
                padding: var(--gap-2) !important;
            }

            /* Training Grid - Single Column */
            .training-grid {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            /* Training Card Adjustments */
            .training-card {
                border-radius: 12px !important;
            }
            
            /* Stack header elements on small screens */
            .training-card .header-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }

            /* Tasks Header Stack */
            .tasks-header-row {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: var(--gap-2) !important;
            }
            
            .tasks-header-row button {
                width: 100% !important;
                justify-content: center !important;
            }
            
            /* Tasks Columns Stack */
            .tasks-columns {
                grid-template-columns: 1fr !important;
                gap: var(--gap-2) !important;
            }
            
            /* Prevent horizontal overflow */
            * {
                max-width: 100%;
            }
            
            .main,
            .card,
            #h2s-app .app-content {
                overflow-x: hidden;
                word-wrap: break-word;
            }

            /* Modals - Full Width */
            .modal-dialog {
                width: 95% !important;
                padding: 20px !important;
                max-height: 90vh !important;
                overflow-y: auto !important;
            }
            
            .modal-header {
                font-size: 18px !important;
            }

            /* Toast Notifications */
            .toast {
                min-width: auto !important;
                width: 90% !important;
                left: 5% !important;
                right: 5% !important;
                bottom: 20px !important;
                top: auto !important;
                transform: none !important;
            }
            
            /* Offer Builder Mobile Layout */
            #offerbuilder-pane #offerBuilderMainGrid {
                grid-template-columns: 1fr !important;
                gap: var(--gap-2) !important;
            }
            
            #offerbuilder-pane #offerBuilderRightColumn {
                width: 100% !important;
            }
            
            /* Tables - Scroll Horizontally */
            .data-table-container {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px !important;
            }
        }

        /* ===== APP SHELL - GHL ISOLATION ===== */
        /* ===== GHL PARENT CONTAINER OVERRIDES ===== */
        /* Neutralize any width constraints from GoHighLevel parent wrappers */
        /* Target common GHL wrapper patterns */
        body > div:has(#h2s-app),
        [class*="container"]:has(#h2s-app),
        [class*="wrapper"]:has(#h2s-app),
        [class*="content"]:has(#h2s-app),
        [id*="container"]:has(#h2s-app),
        [id*="wrapper"]:has(#h2s-app),
        div[style*="max-width"]:has(#h2s-app),
        div[style*="width"]:has(#h2s-app) {
            max-width: none !important;
            width: 100% !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }

        #h2s-app {
            all: initial;
            box-sizing: border-box;
            display: block !important;
            font-family: Archivo, system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-page);
            color: var(--gray-900);
            min-height: 100vh;
            position: relative !important;
            isolation: isolate;
            /* Force full width expansion - override GHL constraints */
            width: 100% !important;
            max-width: none !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            min-width: 100% !important;
            transform: none !important;
            zoom: 1 !important;
        }

        #h2s-app * {
            box-sizing: border-box;
        }

        /* App Top Bar */
        #h2s-app .app-topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 52px;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            box-shadow: var(--elev-card);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        #h2s-app .app-topbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        #h2s-app .app-topbar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #h2s-app .app-topbar-logo img {
            width: 40px;
            height: 40px;
        }

        #h2s-app .app-topbar-title {
            font-weight: 900;
            font-size: 18px;
            color: var(--cobalt);
            text-transform: lowercase;
        }

        #h2s-app .app-topbar-area {
            font-weight: 700;
            font-size: 16px;
            color: var(--cobalt);
            padding-left: 16px;
            border-left: 2px solid var(--border);
        }

        #h2s-app .app-topbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* App Sidebar */
        #h2s-app .app-sidebar {
            position: fixed;
            left: 0;
            top: 52px;
            width: 240px;
            height: calc(100vh - 52px);
            background: var(--white);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            z-index: 999;
        }

        #h2s-app .app-sidebar-nav {
            padding: 16px 0;
        }

        #h2s-app .app-sidebar-nav-divider {
            height: 0;
            border-top: 1px solid var(--border);
            margin: 10px 16px;
        }

        #h2s-app .app-sidebar-nav-label {
            padding: 8px 24px;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #64748b;
            opacity: 0.9;
            user-select: none;
        }

        #h2s-app .app-sidebar-nav-item {
            display: block;
            padding: 12px 24px;
            color: var(--cobalt);
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            transition: all 0.2s var(--ease);
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        #h2s-app .app-sidebar-nav-item:hover {
            background: var(--light);
            border-left-color: var(--azure);
        }

        #h2s-app .app-sidebar-nav-item.active {
            background: rgba(10, 42, 90, 0.05);
            border-left-color: var(--cobalt);
            color: var(--cobalt);
            font-weight: 700;
        }

        /* App Main Content */
        #h2s-app .app-main {
            margin-left: 240px;
            margin-top: 52px;
            min-height: calc(100vh - 52px);
            background: var(--bg-page);
            width: calc(100% - 240px) !important;
            max-width: none !important;
            box-sizing: border-box !important;
            position: relative !important; /* Critical for absolute pane positioning */
        }

        #h2s-app .app-content {
            padding: var(--page-pad);
            max-width: none !important;
            width: 100% !important;
            box-sizing: border-box !important;
            background: var(--bg-page);
            /* Ensure content starts at top - no extra spacing */
            padding-top: var(--page-pad) !important;
            margin-top: 0 !important;
        }

        /* Workbench Header (Pipeline) */
        #h2s-app .workbench-header {
            background: var(--surface);
            border-radius: var(--radius);
            padding: var(--gap-2);
            margin-bottom: var(--gap-2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--gap-2);
            box-shadow: var(--elev-card);
        }

        #h2s-app .workbench-search {
            flex: 1;
            max-width: 400px;
        }

        #h2s-app .workbench-search input {
            width: 100%;
            height: var(--control-h);
            padding: 0 var(--gap-2);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.15s var(--ease);
        }
        
        #h2s-app .workbench-search input:focus {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
            border-color: var(--azure);
        }

        #h2s-app .workbench-actions {
            display: flex;
            align-items: center;
            gap: var(--gap-1);
        }

        #h2s-app .workbench-actions .btn {
            height: var(--control-h);
            padding: 0 var(--gap-2);
            font-size: 14px;
            transition: all 0.15s var(--ease);
            font-weight: 700;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s var(--ease);
        }

        /* Detail Drawer */
        #h2s-app .detail-drawer {
            position: fixed;
            right: 0;
            top: 52px;
            width: 400px;
            height: calc(100vh - 52px);
            background: var(--white);
            box-shadow: var(--elev-2);
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s var(--ease);
            overflow-y: auto;
        }

        #h2s-app .detail-drawer.open {
            transform: translateX(0);
        }

        #h2s-app .detail-drawer-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #h2s-app .detail-drawer-title {
            font-weight: 900;
            font-size: 20px;
            color: var(--cobalt);
        }

        #h2s-app .detail-drawer-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 24px;
            color: var(--cobalt);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        #h2s-app .detail-drawer-close:hover {
            background: var(--light);
        }

        #h2s-app .detail-drawer-body {
            padding: 24px;
        }

        #h2s-app .detail-section {
            margin-bottom: 24px;
        }

        #h2s-app .detail-section-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--cobalt);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        #h2s-app .detail-field {
            margin-bottom: 16px;
        }

        #h2s-app .detail-field-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        #h2s-app .detail-field-value {
            font-size: 15px;
            color: var(--cobalt);
            font-weight: 600;
        }

        /* Hide old header/tabs when in app shell */
        #h2s-app .h2s-header,
        #h2s-app .tabs {
            display: none;
        }

        #h2s-app .main {
            padding: 0;
            max-width: none;
        }

        #h2s-app .page-title {
            display: none;
        }

        /* Ensure pane display logic works correctly */
        /* All panes must be in the same container (app-content) for consistent viewport */
        #h2s-app .app-content {
            position: relative;
            width: 100%;
            min-height: calc(100vh - 52px);
            box-sizing: border-box;
            /* Container for all panes - ensures same viewport */
            overflow: visible;
            /* Ensure content starts at top */
            padding-top: 0;
            margin-top: 0;
        }

        /* All panes share the same container and viewport - inactive panes take NO space */
        #h2s-app .pane {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            width: 0 !important;
            height: 0 !important;
            max-width: 0 !important;
            max-height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
            /* Completely remove from layout flow */
            position: absolute !important;
            top: -9999px !important;
            left: -9999px !important;
        }

        #h2s-app .pane.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
            animation: fadeIn 0.3s var(--ease);
            /* Active pane takes normal flow position at top of container */
            position: relative !important;
            width: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            max-height: none !important;
            top: 0 !important;
            left: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: visible !important;
        }

        /* Improved Pipeline Density */
        #h2s-app #pipeline-pane {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            display: block !important;
        }

        #h2s-app .workbench-header {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
        }

        #h2s-app .pipeline {
            display: grid !important;
            grid-template-columns: repeat(4, 1fr) !important;
            gap: var(--gap-2);
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            min-width: 0 !important;
        }

        #h2s-app .pipeline-column {
            min-height: 500px;
            max-height: calc(100vh - 200px);
            width: 100% !important;
            min-width: 0 !important;
            max-width: none !important;
            box-sizing: border-box !important;
            flex: 1 1 0 !important;
        }

        #h2s-app .candidate-card {
            padding: 12px;
            margin-bottom: 8px;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            #h2s-app .app-sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s var(--ease);
            }

            #h2s-app .app-sidebar.open {
                transform: translateX(0);
            }

            #h2s-app .app-main {
                margin-left: 0;
                width: 100% !important;
            }

            #h2s-app .pipeline {
                grid-template-columns: 1fr !important;
            }
        }

        /* Desktop: Ensure pipeline expands on wide screens */
        @media (min-width: 1025px) {
            #h2s-app .app-main {
                width: calc(100% - 240px) !important;
                max-width: none !important;
            }

            #h2s-app .pipeline {
                grid-template-columns: repeat(4, 1fr) !important;
                width: 100% !important;
            }

            /* Allow horizontal scroll if viewport is too narrow for 4 columns */
            #h2s-app #pipeline-pane {
                overflow-x: auto;
                overflow-y: visible;
            }

            #h2s-app .pipeline {
                min-width: min(100%, 1200px);
            }
        }
        
        /* Offer Builder Messaging Tabs */
        .messaging-tab-content {
            display: block;
        }

        /* ========================================
           PROOF PACKS - APPLE-GRADE DESIGN SYSTEM
           ======================================== */
        
        /* Design System Variables */
        :root {
            /* Typography - SF Pro / Inter */
            --pp-font-display: 600 28px/1.2 -apple-system, BlinkMacSystemFont, "SF Pro Display", "Inter", sans-serif;
            --pp-font-title: 600 20px/1.3 -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif;
            --pp-font-body: 400 15px/1.4 -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif;
            --pp-font-caption: 500 13px/1.3 -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif;
            --pp-font-label: 600 11px/1.2 -apple-system, BlinkMacSystemFont, "SF Pro Text", "Inter", sans-serif;
            
            /* Colors */
            --pp-gray-50: #fafafa;
            --pp-gray-100: #f5f5f5;
            --pp-gray-200: #e5e5e5;
            --pp-gray-300: #d4d4d4;
            --pp-gray-400: #a3a3a3;
            --pp-gray-500: #737373;
            --pp-gray-600: #525252;
            --pp-gray-700: #404040;
            --pp-gray-800: #262626;
            --pp-gray-900: #171717;
            
            --pp-accent-blue: #007aff;
            --pp-accent-blue-hover: #0051d5;
            --pp-accent-red: #ff3b30;
            --pp-accent-green: #34c759;
            --pp-accent-orange: #ff9500;
            
            /* Spacing (4px base) */
            --pp-space-1: 4px;
            --pp-space-2: 8px;
            --pp-space-3: 12px;
            --pp-space-4: 16px;
            --pp-space-5: 20px;
            --pp-space-6: 24px;
            --pp-space-8: 32px;
            --pp-space-10: 40px;
            --pp-space-12: 48px;
            
            /* Shadows */
            --pp-shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --pp-shadow-md: 0 2px 8px rgba(0,0,0,0.08);
            --pp-shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
            --pp-shadow-focus: 0 0 0 4px rgba(0,122,255,0.15);
            
            /* Border Radius */
            --pp-radius-sm: 6px;
            --pp-radius-md: 10px;
            --pp-radius-lg: 14px;
            --pp-radius-xl: 20px;
            --pp-radius-full: 9999px;
        }
        
        /* Video Thumbnail with Custom Play Button */
        .pp-video-thumbnail {
            position: relative;
            width: 160px;
            height: 90px;
            border-radius: var(--pp-radius-md);
            overflow: hidden;
            background: var(--pp-gray-100);
            flex-shrink: 0;
        }
        
        .pp-video-thumbnail video,
        .pp-video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* CRITICAL: Hide ALL native video controls */
        .pp-video-thumbnail video {
            pointer-events: none;
        }
        
        .pp-video-thumbnail video::-webkit-media-controls {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        .pp-video-thumbnail video::-webkit-media-controls-panel {
            display: none !important;
        }
        
        .pp-video-thumbnail video::-webkit-media-controls-play-button {
            display: none !important;
        }
        
        .pp-video-thumbnail video::-webkit-media-controls-start-playback-button {
            display: none !important;
        }
        
        .pp-play-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            background: linear-gradient(135deg, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
        }
        
        .pp-video-thumbnail:hover .pp-play-overlay {
            opacity: 1;
        }
        
        .pp-play-overlay svg {
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.4));
            transition: transform 0.2s ease;
        }
        
        .pp-video-thumbnail:hover .pp-play-overlay svg {
            transform: scale(1.1);
        }
        
        /* Library Item Card */
        .pp-library-item {
            display: flex;
            gap: var(--pp-space-4);
            padding: var(--pp-space-4);
            background: white;
            border: 1px solid var(--pp-gray-200);
            border-radius: var(--pp-radius-lg);
            transition: all 0.2s ease;
            margin-bottom: var(--pp-space-3);
            align-items: flex-start;
            position: relative;
            overflow: hidden; /* Clip action button overflow */
            max-width: 100%;
        }
        
        .pp-library-item:hover {
            border-color: var(--pp-gray-300);
            box-shadow: var(--pp-shadow-md);
            transform: translateY(-1px);
        }
        
        .pp-library-item-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--pp-accent-blue);
            flex-shrink: 0;
            margin-top: 4px;
        }
        
        .pp-library-item-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: var(--pp-space-2);
        }
        
        .pp-library-item-tags {
            display: flex;
            gap: var(--pp-space-2);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .pp-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            font: var(--pp-font-label);
            text-transform: uppercase;
            letter-spacing: 0.02em;
            border-radius: var(--pp-radius-full);
            background: var(--pp-gray-100);
            color: var(--pp-gray-700);
            white-space: nowrap;
        }
        
        .pp-tag svg {
            width: 12px;
            height: 12px;
        }
        
        .pp-tag-media { background: #e0f2fe; color: #0369a1; }
        .pp-tag-service { background: #fce7f3; color: #9f1239; }
        .pp-tag-intent { background: #fef3c7; color: #92400e; font-weight: 600; }
        .pp-tag-visible { background: #d1fae5; color: #065f46; }
        .pp-tag-hidden { background: var(--pp-gray-100); color: var(--pp-gray-500); }
        .pp-tag-rotation { background: #fff3e0; color: #e65100; }
        
        .pp-library-item-meta {
            font: var(--pp-font-caption);
            color: var(--pp-gray-500);
            display: flex;
            align-items: center;
            gap: var(--pp-space-2);
        }
        
        .pp-meta-id {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
        }
        
        .pp-meta-separator {
            color: var(--pp-gray-400);
        }
        
        .pp-library-item-path {
            font: var(--pp-font-caption);
            color: var(--pp-gray-400);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .pp-library-item-actions {
            display: flex;
            gap: var(--pp-space-2);
            flex-shrink: 0;
            margin-left: auto;
        }
        
        /* Button System */
        .pp-btn-primary {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--pp-space-2);
            padding: 10px 20px;
            font: var(--pp-font-body);
            font-weight: 600;
            color: white;
            background: var(--pp-accent-blue);
            border: none;
            border-radius: var(--pp-radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
            min-height: 40px;
        }
        
        .pp-btn-primary:hover {
            background: var(--pp-accent-blue-hover);
            transform: translateY(-1px);
            box-shadow: var(--pp-shadow-md);
        }
        
        .pp-btn-primary:active {
            transform: translateY(0);
        }
        
        .pp-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Button state machine: CSS-driven loading/success/error states */
        .pp-btn-primary[data-state="loading"]::before {
            content: '';
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 6px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }
        
        .pp-btn-primary[data-state="success"]::before {
            content: 'OK';
            margin-right: 6px;
            font-size: 12px;
            font-weight: 900;
        }
        
        .pp-btn-primary[data-state="error"]::before {
            content: '!';
            margin-right: 6px;
            font-size: 16px;
            font-weight: bold;
        }
        
        .pp-btn-secondary {
            padding: 8px 16px;
            font: var(--pp-font-body);
            font-weight: 500;
            color: var(--pp-gray-700);
            background: white;
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
            min-height: 36px;
        }
        
        /* Crisp Load More Button */
        .pp-btn-load-more {
            min-width: 240px;
            font-weight: 600;
            color: var(--pp-gray-800);
            border: 1px solid #cbd5e1;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            background: #f8fafc;
        }
        .pp-btn-load-more:hover {
            border-color: #94a3b8;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }

        /* Compact Select for Toolbar */
        .pp-compact-select {
            padding: 6px 30px 6px 10px; /* Right padding for chevron */
            font-size: 13px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background-color: white;
            color: #334155;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="%2364748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
            font-weight: 500;
        }
        .pp-compact-select:hover {
            border-color: #94a3b8;
        }
        .pp-compact-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .pp-btn-secondary:hover {
            border-color: var(--pp-gray-400);
            background: var(--pp-gray-50);
            transform: translateY(-1px);
            box-shadow: var(--pp-shadow-sm);
        }
        
        .pp-btn-secondary:active {
            transform: translateY(0);
        }
        
        .pp-btn-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-md);
            cursor: pointer;
            color: var(--pp-gray-600);
            transition: all 0.15s ease;
            flex-shrink: 0;
        }
        
        .pp-btn-icon:hover {
            border-color: var(--pp-gray-400);
            background: var(--pp-gray-50);
            color: var(--pp-gray-800);
            transform: translateY(-1px);
            box-shadow: var(--pp-shadow-sm);
        }
        
        .pp-btn-icon:active {
            transform: translateY(0);
        }
        
        .pp-btn-destructive {
            color: var(--pp-accent-red);
        }
        
        .pp-btn-destructive:hover {
            background: #fff5f5;
            border-color: var(--pp-accent-red);
        }
        
        /* Editor Panel */
        .pp-editor-panel {
            background: white;
            border: 1px solid var(--pp-gray-200);
            border-radius: var(--pp-radius-lg);
            overflow: hidden;
            box-shadow: var(--pp-shadow-lg);
            margin-bottom: var(--pp-space-6);
        }
        
        .pp-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: var(--pp-space-6);
            border-bottom: 1px solid var(--pp-gray-200);
            background: var(--pp-gray-50);
        }
        
        .pp-editor-title h2 {
            font: var(--pp-font-title);
            color: var(--pp-gray-900);
            margin: 0 0 var(--pp-space-1) 0;
        }
        
        .pp-editor-subtitle {
            font: var(--pp-font-caption);
            color: var(--pp-gray-500);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            display: block;
        }
        
        .pp-editor-body {
            padding: var(--pp-space-6);
        }
        
        .pp-editor-preview {
            padding: var(--pp-space-6);
            background: var(--pp-gray-50);
            border-radius: var(--pp-radius-md);
            margin-bottom: var(--pp-space-6);
        }
        
        .pp-video-preview-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            background: var(--pp-gray-900);
            border-radius: var(--pp-radius-lg);
            overflow: hidden;
        }
        
        .pp-editor-quick-actions {
            display: flex;
            gap: var(--pp-space-2);
            justify-content: center;
            margin-top: var(--pp-space-4);
        }
        
        .pp-control-group {
            display: flex;
            align-items: center;
            gap: var(--pp-space-3);
            padding: var(--pp-space-4) 0;
            border-bottom: 1px solid var(--pp-gray-100);
        }
        
        .pp-control-group:last-child {
            border-bottom: none;
        }
        
        .pp-control-label {
            font: var(--pp-font-caption);
            font-weight: 600;
            color: var(--pp-gray-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 100px;
        }
        
        /* Custom Slider Styling */
        .pp-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: var(--pp-gray-200);
            border-radius: var(--pp-radius-full);
            outline: none;
            cursor: pointer;
        }
        
        .pp-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid var(--pp-accent-blue);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--pp-shadow-sm);
            transition: all 0.15s ease;
        }
        
        .pp-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: var(--pp-shadow-md);
            border-width: 3px;
        }
        
        .pp-slider::-webkit-slider-thumb:active {
            transform: scale(1.05);
        }
        
        .pp-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            border: 2px solid var(--pp-accent-blue);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--pp-shadow-sm);
            transition: all 0.15s ease;
        }
        
        .pp-slider::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: var(--pp-shadow-md);
        }
        
        .pp-control-value {
            font: var(--pp-font-caption);
            font-weight: 600;
            color: var(--pp-gray-700);
            min-width: 60px;
            text-align: right;
            font-variant-numeric: tabular-nums;
        }
        
        .pp-editor-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--pp-space-3);
            padding: var(--pp-space-6);
            border-top: 1px solid var(--pp-gray-200);
            background: var(--pp-gray-50);
        }
        
        /* Custom Timeline Scrubber */
        .pp-timeline-container {
            padding: var(--pp-space-6) 0;
            margin-bottom: var(--pp-space-6);
        }
        
        .pp-timeline {
            position: relative;
            height: 6px;
            cursor: pointer;
            padding: var(--pp-space-2) 0;
        }
        
        .pp-timeline-track {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 6px;
            background: var(--pp-gray-200);
            border-radius: var(--pp-radius-full);
        }
        
        .pp-timeline-progress {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 6px;
            background: var(--pp-accent-blue);
            border-radius: var(--pp-radius-full);
            transition: width 0.1s linear;
            pointer-events: none;
        }
        
        .pp-timeline-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid var(--pp-accent-blue);
            border-radius: 50%;
            box-shadow: var(--pp-shadow-md);
            cursor: grab;
            transition: transform 0.15s ease;
            z-index: 10;
        }
        
        .pp-timeline-handle:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: var(--pp-shadow-lg);
        }
        
        .pp-timeline-handle:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        .pp-timeline-ticks {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        
        .pp-timeline-ticks span {
            font: var(--pp-font-caption);
            color: var(--pp-gray-500);
            font-variant-numeric: tabular-nums;
        }
        
        /* Filter Tabs */
        .pp-filter-tabs {
            display: flex;
            gap: var(--pp-space-2);
            margin-bottom: var(--pp-space-4);
            border-bottom: 2px solid var(--pp-gray-200);
            padding-bottom: var(--pp-space-2);
        }
        
        .pp-filter-tab {
            padding: var(--pp-space-2) var(--pp-space-4);
            font: var(--pp-font-body);
            font-weight: 500;
            color: var(--pp-gray-600);
            background: transparent;
            border: none;
            border-radius: var(--pp-radius-md) var(--pp-radius-md) 0 0;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
        }
        
        .pp-filter-tab:hover {
            color: var(--pp-gray-900);
            background: var(--pp-gray-50);
        }
        
        .pp-filter-tab.active {
            color: var(--pp-accent-blue);
            font-weight: 600;
        }
        
        .pp-filter-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--pp-accent-blue);
        }
        
        /* Loading States */
        .pp-skeleton {
            background: linear-gradient(90deg, var(--pp-gray-200) 25%, var(--pp-gray-100) 50%, var(--pp-gray-200) 75%);
            background-size: 200% 100%;
            animation: ppSkeletonLoad 1.5s ease-in-out infinite;
        }
        
        @keyframes ppSkeletonLoad {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Empty States */
        .pp-empty-state {
            text-align: center;
            padding: var(--pp-space-12) var(--pp-space-6);
            color: var(--pp-gray-500);
        }
        
        .pp-empty-state svg {
            width: 64px;
            height: 64px;
            color: var(--pp-gray-300);
            margin-bottom: var(--pp-space-4);
        }
        
        .pp-empty-state-title {
            font: var(--pp-font-title);
            color: var(--pp-gray-700);
            margin-bottom: var(--pp-space-2);
        }
        
        .pp-empty-state-message {
            font: var(--pp-font-body);
            color: var(--pp-gray-500);
        }
        
        /* ========================================
           PRODUCTION-GRADE VIDEO EDITOR
           Modern Timeline + Stage Display + Smart Controls
           ======================================== */
        
        /* Modern Timeline Component */
        .pp-timeline-pro {
            position: relative;
            height: 100px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            border-radius: var(--pp-radius-md);
            overflow: hidden;
            margin: var(--pp-space-4) 0;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .pp-timeline-waveform {
            position: absolute;
            inset: 0;
            opacity: 0.3;
            pointer-events: none;
            z-index: 1;
        }
        
        .pp-timeline-thumbnails {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            height: 48px;
            display: flex;
            gap: 4px;
            opacity: 0.4;
            pointer-events: none;
            z-index: 2;
        }
        
        .pp-timeline-thumbnails img {
            height: 100%;
            width: auto;
            object-fit: cover;
            border-radius: 4px;
            filter: brightness(0.7);
        }
        
        .pp-trim-range {
            position: absolute;
            top: 8px;
            bottom: 28px;
            background: rgba(0,122,255,0.12);
            border-left: 3px solid var(--pp-accent-blue);
            border-right: 3px solid var(--pp-accent-blue);
            cursor: move;
            z-index: 5;
            transition: background 0.15s ease;
        }
        
        .pp-trim-range:hover {
            background: rgba(0,122,255,0.18);
        }
        
        .pp-trim-range::before {
            content: 'TRIM RANGE';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.1em;
            color: rgba(255,255,255,0.4);
            pointer-events: none;
        }
        
        .pp-trim-handle {
            position: absolute;
            top: -4px;
            bottom: -4px;
            width: 16px;
            background: var(--pp-accent-blue);
            cursor: ew-resize;
            z-index: 6;
            transition: all 0.15s ease;
            box-shadow: 0 2px 8px rgba(0,122,255,0.4);
        }
        
        .pp-trim-handle:hover {
            background: var(--pp-accent-blue-hover);
            transform: scaleX(1.2);
            box-shadow: 0 4px 12px rgba(0,122,255,0.6);
        }
        
        .pp-trim-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 16px;
            background: rgba(255,255,255,0.4);
        }
        
        .pp-trim-start { 
            left: -8px; 
            border-radius: 6px 0 0 6px;
        }
        
        .pp-trim-end { 
            right: -8px; 
            border-radius: 0 6px 6px 0;
        }
        
        .pp-playhead {
            position: absolute;
            top: 0;
            bottom: 20px;
            width: 2px;
            pointer-events: none;
            z-index: 7;
        }
        
        .pp-playhead-line {
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, var(--pp-accent-red) 0%, rgba(255,59,48,0.6) 100%);
            box-shadow: 0 0 8px rgba(255,59,48,0.6), 0 0 16px rgba(255,59,48,0.3);
            margin-left: -0.5px;
        }
        
        .pp-playhead-time {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--pp-accent-red);
            color: white;
            font-size: 11px;
            font-weight: 700;
            border-radius: 6px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-variant-numeric: tabular-nums;
        }
        
        .pp-playhead-time::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid var(--pp-accent-red);
        }
        
        .pp-timeline-markers {
            position: absolute;
            bottom: 0;
            left: 8px;
            right: 8px;
            height: 20px;
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 10px;
            font-variant-numeric: tabular-nums;
            font-weight: 500;
            padding: 4px 0;
            z-index: 3;
        }
        
        .pp-timeline-markers span {
            position: relative;
        }
        
        .pp-timeline-markers span::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 4px;
            background: rgba(255,255,255,0.2);
        }
        
        /* Stage Display Component - Replaced by new layout styles below */

        
        /* Editor Video - Unique ID */
        #ppEditorVideo {
            width: 100% !important;
            height: 100% !important;
            max-width: none !important;
            max-height: 100% !important;
            object-fit: contain !important;
            display: block;
        }

        /* 
           UPDATED EDITOR LAYOUT (Single Viewport + White Frame) 
        */

        .pp-editor-modal-body {
            /* FIXED LAYOUT - Flex Container */
            padding: 0 !important;
            overflow: hidden !important; /* Disable body scroll */
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f4f4f7;
            /* Removed justify-content: center */
        }

        /* 1. Editor Card Container - The "Looking Glass" */
        .pp-editor-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: auto; /* Allow growth */
            min-height: 100%; /* Fill at least the container */
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            overflow: visible; /* Don't clip! */
            position: relative;
            max-width: 100%; 
            margin: 0;
        }

        /* 2. Video Stage */
        .pp-stage-container {
            flex: 1; 
            min-height: 200px; 
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Changed from black to transparent so no "black bars" visible */
            background: transparent; 
            position: relative;
            z-index: 10;
        }
        
        .pp-video-stage {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            /* Enforce max-width constraint on content, not container background */
        }

        .pp-stage-container {
            cursor: grab;
        }

        .pp-stage-container.is-dragging {
            cursor: grabbing;
        }

        .pp-preview-frame {
            cursor: crosshair;
        }

        .pp-preview-frame.is-dragging {
            cursor: grabbing;
        }

        .pp-stage-drag-hint {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 55;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(226, 232, 240, 0.9);
            color: rgba(15, 23, 42, 0.78);
            font-size: 11px;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 999px;
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
            pointer-events: none;
            opacity: 0;
            transform: translateY(-2px);
            transition: opacity 160ms ease, transform 160ms ease;
        }

        .pp-stage-container:hover .pp-stage-drag-hint {
            opacity: 1;
            transform: translateY(0);
        }

        .pp-media-fade {
            opacity: 0;
            transition: opacity 160ms ease;
        }

        .pp-media-fade.pp-media-ready {
            opacity: 1;
        }

        .pp-load-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
            background: radial-gradient(circle at 50% 40%, rgba(255,255,255,0.92), rgba(248,249,250,0.96));
            color: #0f172a;
            z-index: 60;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 140ms ease, visibility 140ms ease;
        }

        .pp-load-overlay.is-visible {
            opacity: 1;
            visibility: visible;
        }

        .pp-load-spinner {
            width: 22px;
            height: 22px;
            border-radius: 999px;
            border: 2px solid rgba(15, 23, 42, 0.18);
            border-top-color: rgba(15, 23, 42, 0.65);
            animation: ppSpin 700ms linear infinite;
        }

        @keyframes ppSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .pp-load-title {
            font-weight: 650;
            font-size: 12px;
        }

        .pp-load-subtitle {
            font-size: 11px;
            color: rgba(15, 23, 42, 0.65);
        }

        .pp-error-overlay {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #991b1b;
            z-index: 70;
            pointer-events: auto;
        }

        .pp-error-overlay .pp-error-box {
            max-width: 320px;
            border: 1px solid rgba(220, 38, 38, 0.25);
            background: rgba(254, 226, 226, 0.6);
            border-radius: 10px;
            padding: 12px;
        }

        .pp-error-overlay .pp-error-title {
            font-weight: 700;
            font-size: 12px;
            margin-bottom: 6px;
        }

        .pp-error-overlay .pp-error-subtitle {
            font-size: 11px;
            color: rgba(153, 27, 27, 0.85);
        }

        /* Ensure video fits inside the flexible container without overflowing */
        #ppEditorVideo {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Critical for aspect ratio preservation */
            /* Removed fixed max-width constraint, let flexbox handle it normally */
        }

        /* 3. Bottom Controls Section - Fixed or Scrollable */
        .pp-editor-bottom-section {
            flex-shrink: 0; 
            width: 100%;
            padding: 12px; /* Reduced from 16px 24px */
            background: #fff;
            border-top: 1px solid #eee;
            z-index: 20;
            
            /* Remove fixed height constraints to let parent scroll */
            box-sizing: border-box;
        }

        .pp-editor-stage-area, 
        .pp-editor-controls-wrapper {
             display: none; 
        }

        /* 4. Controls Styling Refinements */
        .pp-playback-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px; /* Tighter */
        }

        .pp-timeline-container {
            margin: 0 0 12px; /* Tighter */
            padding: 0;
            position: relative;
            z-index: 1;
            clear: both;
        }

        .pp-preset-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px; /* Tighter */
            margin-bottom: 12px;
        }
        
        .pp-preset-btn {
            min-height: 38px; /* Much smaller buttons */
            padding: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: white;
            border: 1px solid var(--pp-gray-200);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pp-preset-btn:hover {
            border-color: var(--pp-accent-blue);
            background: var(--pp-gray-50);
        }

        .pp-controls-grid {
            display: grid;
            /* 4 columns to save vertical space */
            grid-template-columns: repeat(4, 1fr); 
            gap: 12px;
            margin-bottom: 12px;
        }

        .pp-control-section {
            padding: 2px 0;
        }
        
        .pp-control-header {
            margin-bottom: 2px;
            font-size: 11px;
        }

        .pp-editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 8px;
            border-top: 1px solid #e5e5e5;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .pp-controls-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            #ppEditorVideo {
                max-width: 100%; 
            }
        }

        
        .pp-stage-mode-selector {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
            z-index: 10;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(12px);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .pp-mode-btn {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .pp-mode-btn.active {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .pp-mode-btn:hover:not(.active) {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
        }
        
        .pp-video-stage {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pp-stage-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 5;
        }
        
        .pp-grid-overlay {
            position: absolute;
            inset: 0;
        }
        
        .pp-grid-line {
            position: absolute;
            /* Grid lines must be visible on a light stage background (#f8f9fa)
               and also readable over darker previews.
            */
            background: rgba(0,0,0,0.28);
            box-shadow: 0 0 0 1px rgba(255,255,255,0.18);
        }
        
        .pp-grid-line.vertical {
            width: 2px;
            height: 100%;
            top: 0;
        }
        
        .pp-grid-line.horizontal {
            width: 100%;
            height: 2px;
            left: 0;
        }
        
        /* Safe Zone Overlay */
        .pp-safezone-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pp-safezone-rect {
            position: relative;
            border: 3px dashed #facc15;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.5), inset 0 0 0 2px rgba(0,0,0,0.5);
            background: rgba(250, 204, 21, 0.05);
            transition: border-color 150ms ease, border-width 150ms ease;
        }
        
        .pp-safezone-rect.boundary-warning {
            border-color: #f59e0b;
            border-width: 4px;
            animation: boundary-pulse 0.8s ease-in-out infinite;
        }
        
        @keyframes boundary-pulse {
            0%, 100% { 
                border-color: #f59e0b;
                box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.6), inset 0 0 0 2px rgba(245, 158, 11, 0.3);
            }
            50% { 
                border-color: #fb923c;
                box-shadow: 0 0 0 6px rgba(245, 158, 11, 0), inset 0 0 0 2px rgba(251, 146, 60, 0.3);
            }
        }
        
        .pp-safezone-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #facc15;
        }
        
        .pp-safezone-corner:nth-child(1) {
            border-right: none;
            border-bottom: none;
        }
        .pp-safezone-corner:nth-child(2) {
            border-left: none;
            border-bottom: none;
        }
        .pp-safezone-corner:nth-child(3) {
            border-right: none;
            border-top: none;
        }
        .pp-safezone-corner:nth-child(4) {
            border-left: none;
            border-top: none;
        }
        
        .pp-safezone-label {
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: #facc15;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* Video rotator container - centers video */
        #ppLocalPreviewRotator {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-origin: center center;
        }
        
        /* Video element - SCALE UP to fill container (Editor Only) */
        .pp-stage-container #ppLocalPreviewVideo {
            width: 100% !important;
            height: 100% !important;
            max-width: none !important;
            max-height: 100% !important;
            object-fit: contain !important;
            display: block;
        }
        
        .pp-stage-info {
            position: absolute;
            bottom: 12px;
            left: 12px;
            display: flex;
            gap: 6px;
            z-index: 10;
        }
        
        .pp-info-badge {
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            background: rgba(0,122,255,0.85);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .pp-info-resolution,
        .pp-info-fps {
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 600;
            color: rgba(255,255,255,0.9);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            font-variant-numeric: tabular-nums;
        }
        
        .pp-stage-split {
            display: flex;
            height: 360px;
        }
        
        .pp-split-before,
        .pp-split-after {
            position: relative;
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pp-split-divider {
            width: 4px;
            background: linear-gradient(180deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0.6) 100%);
            box-shadow: 0 0 12px rgba(255,255,255,0.5);
            cursor: ew-resize;
            position: relative;
        }
        
        .pp-split-divider::after {
            content: '<->';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 16px;
        }
        
        .pp-split-label {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        /* Smart Geometry Controls */
        .pp-preset-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
            padding: 4px;
            background: var(--pp-gray-50);
            border-radius: var(--pp-radius-md);
            border: 1px solid var(--pp-gray-200);
        }
        
        .pp-preset-btn {
            display: flex;
            flex-direction: row; /* Horizontal layout */
            align-items: center;
            justify-content: center; /* Center content */
            gap: 6px;
            padding: 4px 8px; /* Tighter padding */
            min-height: 32px; /* Fixed small height */
            font: var(--pp-font-caption);
            font-size: 11px; /* Smaller font */
            font-weight: 600;
            color: var(--pp-gray-700);
            background: white;
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .pp-preset-btn svg {
            width: 14px; /* Much smaller icons */
            height: 14px;
            color: var(--pp-gray-500);
            transition: color 0.15s ease;
        }
        
        .pp-preset-btn:hover {
            border-color: var(--pp-accent-blue);
            background: var(--pp-gray-50);
            transform: translateY(-1px);
            box-shadow: var(--pp-shadow-sm);
        }
        
        .pp-preset-btn:hover svg {
            color: var(--pp-accent-blue);
        }
        
        .pp-preset-btn:active {
            transform: translateY(0);
        }
        
        .pp-control-section {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--pp-gray-200);
        }
        
        .pp-control-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }
        
        .pp-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        
        .pp-control-title {
            font: var(--pp-font-caption);
            font-weight: 700;
            color: var(--pp-gray-800);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .pp-control-actions {
            display: flex;
            align-items: center;
            gap: var(--pp-space-2);
        }
        
        .pp-btn-icon-sm {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-sm);
            cursor: pointer;
            color: var(--pp-gray-600);
            transition: all 0.15s ease;
        }
        
        .pp-btn-icon-sm:hover {
            border-color: var(--pp-gray-400);
            background: var(--pp-gray-50);
            color: var(--pp-gray-800);
        }
        
        .pp-btn-icon-sm svg {
            width: 14px;
            height: 14px;
        }
        
        .pp-slider-modern {
            width: 100%;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: linear-gradient(90deg, var(--pp-gray-200) 0%, var(--pp-accent-blue) 50%, var(--pp-gray-200) 100%);
            background-size: 200% 100%;
            background-position: center;
            border-radius: var(--pp-radius-full);
            outline: none;
            cursor: pointer;
            transition: background 0.15s ease;
        }
        
        .pp-slider-modern:hover {
            background: linear-gradient(90deg, var(--pp-gray-300) 0%, var(--pp-accent-blue) 50%, var(--pp-gray-300) 100%);
        }
        
        .pp-slider-modern::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: white;
            border: 3px solid var(--pp-accent-blue);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: all 0.15s ease;
        }
        
        .pp-slider-modern::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
            border-width: 4px;
        }
        
        .pp-slider-modern::-webkit-slider-thumb:active {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,122,255,0.4);
        }
        
        .pp-slider-modern::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: white;
            border: 3px solid var(--pp-accent-blue);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            transition: all 0.15s ease;
        }
        
        .pp-slider-modern::-moz-range-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(0,122,255,0.3);
        }
        
        .pp-control-quick {
            display: flex;
            gap: var(--pp-space-2);
            margin-top: var(--pp-space-2);
        }
        
        .pp-control-quick button {
            flex: 1;
            padding: var(--pp-space-2);
            font-size: 11px;
            font-weight: 600;
            color: var(--pp-gray-700);
            background: white;
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            font-variant-numeric: tabular-nums;
        }
        
        .pp-control-quick button:hover {
            border-color: var(--pp-accent-blue);
            color: var(--pp-accent-blue);
            background: rgba(0,122,255,0.05);
        }
        
        .pp-control-quick button:active {
            transform: scale(0.95);
        }
        
        .pp-checkbox-modern {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 500;
            color: var(--pp-gray-700);
            cursor: pointer;
            user-select: none;
        }
        
        .pp-checkbox-modern input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--pp-accent-blue);
        }
        
        /* Auto-Suggestions Panel */
        .pp-auto-suggestions {
            background: linear-gradient(135deg, #fff9e6 0%, #fff3cc 100%);
            border: 1px solid #ffc107;
            border-radius: var(--pp-radius-md);
            padding: var(--pp-space-4);
            margin-top: var(--pp-space-6);
        }
        
        .pp-auto-suggestions[data-visible="false"] {
            display: none;
        }
        
        .pp-suggestion {
            display: flex;
            align-items: center;
            gap: var(--pp-space-3);
        }
        
        .pp-suggestion-icon {
            width: 32px;
            height: 32px;
            color: #f57c00;
            flex-shrink: 0;
        }
        
        .pp-suggestion-content {
            flex: 1;
        }
        
        .pp-suggestion-content strong {
            display: block;
            font: var(--pp-font-caption);
            font-weight: 700;
            color: #e65100;
            margin-bottom: 2px;
        }
        
        .pp-suggestion-content p {
            font: var(--pp-font-caption);
            color: #6d4c00;
            margin: 0;
        }
        
        .pp-btn-secondary-sm {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--pp-gray-700);
            background: white;
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        
        .pp-btn-secondary-sm:hover {
            border-color: var(--pp-accent-blue);
            color: var(--pp-accent-blue);
            background: rgba(0,122,255,0.05);
            transform: translateY(-1px);
            box-shadow: var(--pp-shadow-sm);
        }
        
        /* Color Grading Panel */
        .pp-color-grading {
            background: var(--pp-gray-50);
            border: 1px solid var(--pp-gray-200);
            border-radius: var(--pp-radius-md);
            padding: var(--pp-space-4);
            margin-top: var(--pp-space-4);
        }
        
        .pp-color-grading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--pp-space-4);
        }
        
        .pp-color-grading-title {
            font: var(--pp-font-caption);
            font-weight: 700;
            color: var(--pp-gray-800);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        .pp-toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }
        
        .pp-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .pp-toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: var(--pp-gray-300);
            border-radius: 24px;
            transition: 0.3s;
        }
        
        .pp-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .pp-toggle-switch input:checked + .pp-toggle-slider {
            background: var(--pp-accent-blue);
        }
        
        .pp-toggle-switch input:checked + .pp-toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Stabilization Toggle */
        .pp-stabilization-panel {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--pp-space-4);
            background: var(--pp-gray-50);
            border: 1px solid var(--pp-gray-200);
            border-radius: var(--pp-radius-md);
            margin-top: var(--pp-space-4);
        }
        
        .pp-stabilization-info {
            flex: 1;
        }
        
        .pp-stabilization-info strong {
            display: block;
            font: var(--pp-font-caption);
            font-weight: 700;
            color: var(--pp-gray-800);
            margin-bottom: 2px;
        }
        
        .pp-stabilization-info p {
            font: var(--pp-font-caption);
            color: var(--pp-gray-600);
            margin: 0;
        }
        
        /* Play button pulse hint when autoplay blocked */
        .pp-pulse-hint {
            animation: pp-pulse 1.5s infinite;
        }
        
        @keyframes pp-pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(102, 126, 234, 0.4);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
            }
        }

        /* ========================================
           EXTENDED PRODUCTION FEATURES
           Batch Operations, Filters, Grid View, Export, Undo/Redo
           ======================================== */
        
        /* Batch Operations Toolbar */
        .pp-batch-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--pp-radius-md);
            /* GAP 10 FIX: Sticky positioning instead of margin */
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .pp-batch-toolbar[data-batch-mode="false"] {
            display: none;
        }
        
        .pp-batch-info {
            display: flex;
            align-items: center;
            gap: var(--pp-space-3);
        }
        
        .pp-batch-count {
            font-weight: 700;
            font-size: 15px;
            letter-spacing: 0.02em;
        }
        
        .pp-batch-actions {
            display: flex;
            gap: var(--pp-space-2);
        }

        .pp-batch-actions select {
            padding: 6px 10px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: var(--pp-radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .pp-batch-actions select:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .pp-batch-actions select:focus {
            outline: none;
            box-shadow: var(--pp-shadow-focus);
        }

        .pp-batch-actions select option {
            color: var(--pp-gray-900);
            background: white;
        }
        
        .pp-batch-actions button {
            padding: 6px 14px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: var(--pp-radius-sm);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .pp-batch-actions button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .pp-batch-actions .pp-btn-destructive {
            background: rgba(255,59,48,0.9);
            border-color: rgba(255,59,48,1);
        }
        
        .pp-batch-actions .pp-btn-destructive:hover {
            background: var(--pp-accent-red);
        }
        
        /* Smart Filters & Search */
        .pp-library-filters {
            background: var(--pp-gray-50);
            border: 1px solid var(--pp-gray-200);
            border-radius: var(--pp-radius-md);
            padding: var(--pp-space-4);
            margin-bottom: var(--pp-space-4);
        }
        
        .pp-search-bar {
            position: relative;
            margin-bottom: var(--pp-space-3);
        }
        
        .pp-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--pp-gray-400);
            pointer-events: none;
        }
        
        .pp-search-bar input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            font: var(--pp-font-body);
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-md);
            background: white;
            transition: all 0.15s ease;
        }
        
        .pp-search-bar input:focus {
            outline: none;
            border-color: var(--pp-accent-blue);
            box-shadow: var(--pp-shadow-focus);
        }
        
        .pp-filter-chips {
            display: flex;
            gap: var(--pp-space-2);
            flex-wrap: wrap;
            margin-bottom: var(--pp-space-3);
        }
        
        .pp-chip {
            padding: 6px 12px;
            font: var(--pp-font-caption);
            font-weight: 600;
            color: var(--pp-gray-700);
            background: white;
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-full);
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }
        
        .pp-chip:hover {
            border-color: var(--pp-accent-blue);
            color: var(--pp-accent-blue);
            background: rgba(0,122,255,0.05);
        }
        
        .pp-chip.active {
            background: var(--pp-accent-blue);
            color: white;
            border-color: var(--pp-accent-blue);
        }
        
        .pp-chip-separator {
            color: var(--pp-gray-400);
            font-weight: 600;
            font-size: 14px;
            user-select: none;
            margin: 0 4px;
        }
        
        .pp-filter-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .pp-clear-filters {
            padding: 4px 12px;
            font-size: 13px;
            font-weight: 600;
            color: var(--pp-accent-blue);
            background: white;
            border: 1px solid var(--pp-accent-blue);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .pp-clear-filters:hover {
            background: var(--pp-accent-blue);
            color: white;
        }
        
        .pp-sort-options {
            display: flex;
            align-items: center;
            gap: var(--pp-space-2);
        }
        
        .pp-sort-options label {
            font: var(--pp-font-caption);
            font-weight: 600;
            color: var(--pp-gray-700);
        }
        
        .pp-sort-options select {
            padding: 6px 10px;
            font: var(--pp-font-caption);
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-sm);
            background: white;
            cursor: pointer;
        }
        
        .pp-filter-count {
            font: var(--pp-font-caption);
            color: var(--pp-gray-500);
            margin-left: auto;
        }
        
        /* Grid View Mode */
        .pp-view-mode-toggle {
            display: flex;
            gap: var(--pp-space-2);
            margin-bottom: var(--pp-space-4);
        }
        
        .pp-view-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font: var(--pp-font-caption);
            font-weight: 600;
            color: var(--pp-gray-600);
            background: white;
            border: 1px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
        }
        
        .pp-view-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .pp-view-btn:hover {
            border-color: var(--pp-gray-400);
            color: var(--pp-gray-800);
        }
        
        .pp-view-btn.active {
            background: var(--pp-accent-blue);
            color: white;
            border-color: var(--pp-accent-blue);
        }
        
        .pp-library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--pp-space-4);
        }
        
        .pp-grid-item {
            position: relative;
            border-radius: var(--pp-radius-md);
            overflow: hidden;
            background: white;
            border: 1px solid var(--pp-gray-200);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .pp-grid-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: var(--pp-accent-blue);
        }
        
        .pp-grid-thumbnail {
            position: relative;
            aspect-ratio: 16/9;
            background: #000;
            overflow: hidden;
        }
        
        .pp-grid-thumbnail video,
        .pp-grid-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .pp-grid-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .pp-grid-item:hover .pp-grid-overlay {
            opacity: 1;
        }
        
        .pp-grid-play {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 50%;
            color: var(--pp-accent-blue);
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pp-grid-play:hover {
            transform: scale(1.15);
        }
        
        .pp-grid-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            font-size: 11px;
        }
        
        .pp-grid-intent {
            font-weight: 700;
            color: var(--pp-accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pp-featured-star {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #fbbf24;
            font-size: 16px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.4);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        
        .pp-grid-duration {
            color: var(--pp-gray-500);
            font-variant-numeric: tabular-nums;
            font-weight: 600;
        }
        
        /* Export Presets Panel */
        .pp-export-panel {
            background: var(--pp-gray-50);
            border: 1px solid var(--pp-gray-200);
            border-radius: var(--pp-radius-md);
            padding: var(--pp-space-5);
            margin-top: var(--pp-space-4);
        }
        
        .pp-export-panel h3 {
            font: var(--pp-font-title);
            color: var(--pp-gray-900);
            margin: 0 0 var(--pp-space-4) 0;
        }
        
        .pp-export-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: var(--pp-space-3);
            margin-bottom: var(--pp-space-4);
        }
        
        .pp-export-preset {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--pp-space-2);
            padding: var(--pp-space-4);
            background: white;
            border: 2px solid var(--pp-gray-300);
            border-radius: var(--pp-radius-md);
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: center;
        }
        
        .pp-export-preset:hover {
            border-color: var(--pp-accent-blue);
            transform: translateY(-2px);
            box-shadow: var(--pp-shadow-md);
        }
        
        .pp-export-preset.active {
            border-color: var(--pp-accent-blue);
            background: rgba(0,122,255,0.05);
        }
        
        .pp-preset-icon {
            font-size: 32px;
            line-height: 1;
        }
        
        .pp-export-preset strong {
            font: var(--pp-font-caption);
            font-weight: 700;
            color: var(--pp-gray-900);
            display: block;
        }
        
        .pp-export-preset span {
            font: var(--pp-font-caption);
            color: var(--pp-gray-600);
            display: block;
        }
        
        /* Undo/Redo History Controls (Toolbar)
           NOTE: These buttons are rendered inside `.editor-toolbar`.
           Keep them in normal flow so they never overlay the stage/preview UI.
        */
        .pp-editor-history {
            display: flex;
            align-items: center;
            gap: 8px;
            position: static;
            z-index: auto;
        }
        
        /* ========================================
           UX IMPROVEMENTS - Status Bar, Tooltips, Feedback
           ======================================== */
        
        /* Modal Editor Overlay */
        .pp-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .pp-editor-modal.is-hidden {
            display: none;
        }

        .pp-editor-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .pp-editor-modal-content {
            position: relative;
            z-index: 1;
            background: #f4f4f7; 
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1300px; 
            max-height: 90vh; /* Increased height */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: auto;
        }

        .pp-editor-modal-header {
            display: none; /* Hide old header since we have a new one inside the card */
        }

        .pp-editor-modal-body {
            /* FIXED LAYOUT - Flex Container */
            padding: 0 !important;
            overflow: hidden !important; /* Disable body scroll */
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f4f4f7;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }
        
        .pp-editor-modal-body::-webkit-scrollbar { width: 8px; }
        .pp-editor-modal-body::-webkit-scrollbar-track { background: transparent; }
        .pp-editor-modal-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .pp-editor-modal-body::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ========================================
           MOBILE HARD PASS (iOS / Apple-first)
           ======================================== */

        :root {
            --pp-safe-top: env(safe-area-inset-top, 0px);
            --pp-safe-bottom: env(safe-area-inset-bottom, 0px);
            --pp-safe-left: env(safe-area-inset-left, 0px);
            --pp-safe-right: env(safe-area-inset-right, 0px);
        }

        /* Touch affordances for direct manipulation */
        .pp-stage-container,
        .pp-preview-frame {
            touch-action: none;
        }

        /* ProofPacks Upload: make the dropzone actually tappable and clean on mobile */
        #ppDropzone.dropzone {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: start;
        }

        #ppDropzone .pp-upload-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .pp-hidden-file-input {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
            opacity: 0 !important;
        }

        .pp-upload-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 14px;
            border-radius: 9999px;
            border: 1px solid #cbd5e1;
            background: #ffffff;
            color: #0f172a;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .pp-upload-chip:active {
            transform: translateY(1px);
        }

        /* iOS: avoid input zoom (>= 16px) */
        @media (max-width: 820px) {
            #proofpacks-pane input,
            #proofpacks-pane select,
            #proofpacks-pane textarea {
                font-size: 16px !important;
            }

            #proofpacks-pane button,
            #proofpacks-pane .btn,
            #proofpacks-pane .pp-btn-icon,
            #proofpacks-pane .pp-btn-icon-sm,
            #proofpacks-pane .editor-tool-btn {
                min-height: 44px;
            }

            /* Upload: mobile-first layout (no stacked buttons) */
            #ppDropzone.dropzone {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            #ppDropzone .pp-upload-actions {
                align-items: stretch;
            }

            .pp-mobile-capture-actions {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 10px;
            }

            .pp-mobile-capture-actions .pp-upload-chip {
                flex: 1;
                min-width: 120px;
            }

            /* Library cards: tighten + keep thumbs visible */
            .pp-library-item {
                gap: 12px;
                padding: 12px;
            }

            .pp-video-thumbnail {
                width: 132px;
                height: 74px;
            }

            .pp-library-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 12px;
            }

            /* Editor modal becomes true full-screen */
            .pp-editor-modal {
                padding: 0;
            }

            .pp-editor-modal-content {
                border-radius: 0;
                max-height: 100svh;
                height: 100svh;
                width: 100vw;
                max-width: 100vw;
                padding-left: var(--pp-safe-left);
                padding-right: var(--pp-safe-right);
            }

            /* Editor scroll area: iOS smooth scrolling + safe-area footer spacing */
            #ppEditorScrollArea {
                -webkit-overflow-scrolling: touch;
                padding-bottom: calc(64px + var(--pp-safe-bottom)) !important;
            }

            /* Stage height: keep in-view on phone */
            #ppStageContainer {
                height: min(48svh, 360px) !important;
                min-height: 260px !important;
            }

            /* Stack the live preview under controls (or above, based on grid rows) */
            .pp-editor-preview-layout {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }

            .pp-editor-live-preview {
                grid-row: 1;
            }

            .pp-editor-live-controls {
                grid-row: 2;
            }

            /* Footer safe area */
            .editor-footer {
                padding-bottom: calc(16px + var(--pp-safe-bottom)) !important;
            }
        }

        /* On touch devices: hover overlays should be visible */
        @media (hover: none) {
            .pp-play-overlay {
                opacity: 1;
            }
            .pp-grid-overlay {
                opacity: 1;
            }
        }

        /* Hint visibility when we force-show on touch */
        .pp-stage-container.pp-touch-hint .pp-stage-drag-hint {
            opacity: 1;
            transform: translateY(0);
        }

        /* Focal Point Styles */
        .focal-point-btn {
            width: 100%; height: 36px;
            border: 1px solid var(--pp-border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            color: var(--pp-text-muted);
            transition: all 150ms ease;
            display: flex; align-items: center; justify-content: center;
        }
        .focal-point-btn:hover { border-color: var(--pp-border-hover); background: var(--pp-bg-tertiary); }
        .focal-point-btn.active {
            border-color: var(--pp-primary); background: var(--pp-primary); color: white;
            box-shadow: 0 2px 6px rgba(0, 102, 255, 0.3);
        }
        
        /* Draggable Crosshair */
        .focal-crosshair {
            position: absolute;
            top: 50%; left: 50%;
            width: 30px; height: 30px;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
            background: rgba(0, 102, 255, 0.3);
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 20;
            pointer-events: auto;
        }
        .focal-crosshair::before, .focal-crosshair::after {
            content: ''; position: absolute; background: white;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .focal-crosshair::before { width: 100%; height: 2px; }
        .focal-crosshair::after { width: 2px; height: 100%; }
        
        /* Status Bar with Visual States */
        .pp-editor-status-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .pp-editor-status-bar[data-state="idle"] {
            background: #f8f9fa;
            color: #6c757d;
            border-color: #e9ecef;
        }
        
        .pp-editor-status-bar[data-state="saving"] {
            background: linear-gradient(90deg, #fff3cd 0%, #fff8e1 100%);
            color: #856404;
            border-color: #ffc107;
            animation: pp-status-pulse 1.5s infinite;
        }
        
        .pp-editor-status-bar[data-state="success"] {
            background: linear-gradient(90deg, #d4edda 0%, #d1f2eb 100%);
            color: #155724;
            border-color: #28a745;
        }
        
        .pp-editor-status-bar[data-state="error"] {
            background: linear-gradient(90deg, #f8d7da 0%, #ffe5e8 100%);
            color: #721c24;
            border-color: #dc3545;
        }
        
        .pp-status-icon {
            transition: transform 0.3s ease;
        }
        
        .pp-editor-status-bar[data-state="saving"] .pp-status-icon {
            animation: pp-spin 2s linear infinite;
        }
        
        .pp-editor-status-bar[data-state="success"] .pp-status-icon {
            animation: pp-checkmark-bounce 0.6s ease-out;
        }
        
        @keyframes pp-status-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        
        @keyframes pp-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pp-checkmark-bounce {
            0%, 20% { transform: scale(0.8); }
            50% { transform: scale(1.2); }
            80% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        
        /* Loop Indicator Badge */
        .pp-info-loop {
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            background: rgba(52, 199, 89, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border: 1px solid rgba(255,255,255,0.3);
            animation: pp-loop-fade-in 0.4s ease-out;
        }
        
        @keyframes pp-loop-fade-in {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Help Icon Tooltips */
        .pp-help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            color: #6c757d;
            font-size: 14px;
            cursor: help;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .pp-help-icon:hover {
            opacity: 1;
            color: var(--pp-accent-blue);
        }
        
        /* Inline Control Value Badges */
        .pp-control-value {
            display: inline-block;
            padding: 3px 8px;
            font-size: 11px;
            font-weight: 700;
            color: var(--pp-accent-blue);
            background: rgba(0,122,255,0.1);
            border-radius: 6px;
            font-variant-numeric: tabular-nums;
            min-width: 45px;
            text-align: center;
            transition: all 0.2s ease;
        }
        
        .pp-control-value.updating {
            animation: pp-value-pulse 0.3s ease-out;
        }
        
        @keyframes pp-value-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); background: rgba(0,122,255,0.2); }
            100% { transform: scale(1); }
        }
        
        /* Success Checkmark Animation */
        @keyframes pp-success-checkmark {
            0% {
                opacity: 0;
                transform: scale(0.5) rotate(-45deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }
        
        .pp-success-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            border-radius: 20px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            animation: pp-overlay-fade-in 0.3s ease-out;
        }
        
        .pp-success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pp-success-checkmark 0.6s ease-out;
        }
        
        .pp-success-icon svg {
            width: 50px;
            height: 50px;
            color: white;
        }
        
        .pp-success-message {
            color: white;
            font-size: 18px;
            font-weight: 700;
            text-align: center;
        }
        
        @keyframes pp-overlay-fade-in {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        /* Enhanced Timeline Handles (Increased Size & Touch Targets) */
        @media (hover: none) and (pointer: coarse) {
            /* Mobile/Touch Device Improvements */
            .pp-trim-handle {
                width: 24px; /* Increased from 16px */
                top: -8px;
                bottom: -8px;
            }
            
            .pp-trim-start {
                left: -12px;
            }
            
            .pp-trim-end {
                right: -12px;
            }
            
            .pp-preset-btn {
                min-height: 44px; /* Touch target minimum */
            }
            
            .pp-mode-btn {
                min-height: 44px;
                padding: 8px 16px;
            }
            
            .pp-control-quick button {
                min-height: 44px;
            }
            
            .pp-btn-icon-sm {
                width: 44px;
                height: 44px;
            }
        }
        
        /* Mobile Responsive Breakpoints */
        @media (max-width: 640px) {
            .pp-preset-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pp-control-section {
                padding-left: 8px;
                padding-right: 8px;
            }
            
            .pp-stage-mode-selector {
                top: 8px;
                right: 8px;
                padding: 2px;
            }
            
            .pp-mode-btn {
                padding: 4px 8px;
                font-size: 10px;
            }
            
            /* .pp-editor-history stays in the toolbar flow on mobile too */
            
            .pp-timeline-pro {
                height: 80px;
            }
            
            .pp-playhead-time {
                font-size: 10px;
                padding: 3px 6px;
            }
        }
        
        @media (max-width: 480px) {
            .pp-preset-bar {
                grid-template-columns: 1fr;
            }
            
            .pp-stage-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .pp-filter-chips {
                gap: 6px;
            }
            
            .pp-chip {
                font-size: 10px;
                padding: 4px 8px;
            }
        }
        
        /* Keyboard Shortcuts Panel */
        .pp-keyboard-hints {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .pp-hints-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            font: var(--pp-font-caption);
            font-weight: 600;
            color: white;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: var(--pp-radius-full);
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: var(--pp-shadow-lg);
        }
        
        .pp-hints-toggle:hover {
            background: rgba(0,0,0,0.9);
            transform: translateY(-2px);
        }
        
        .pp-hints-panel {
            position: absolute;
            bottom: calc(100% + 12px);
            right: 0;
            background: white;
            border: 1px solid var(--pp-gray-200);
            border-radius: var(--pp-radius-md);
            padding: var(--pp-space-4);
            box-shadow: var(--pp-shadow-lg);
            min-width: 280px;
        }
        
        .pp-hints-panel h4 {
            font: var(--pp-font-caption);
            font-weight: 700;
            color: var(--pp-gray-900);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0 0 var(--pp-space-3) 0;
        }
        
        .pp-hint {
            display: flex;
            align-items: center;
            gap: var(--pp-space-3);
            padding: var(--pp-space-2) 0;
            border-bottom: 1px solid var(--pp-gray-100);
        }
        
        .pp-hint:last-child {
            border-bottom: none;
        }
        
        .pp-hint kbd {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            color: var(--pp-gray-700);
            background: var(--pp-gray-100);
            border: 1px solid var(--pp-gray-300);
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .pp-hint span {
            font: var(--pp-font-caption);
            color: var(--pp-gray-600);
            flex: 1;
        }
        
        /* Editor Loading Skeleton */
        .pp-editor-skeleton {
            background: white;
            border-radius: var(--pp-radius-lg);
            padding: var(--pp-space-6);
            min-height: 600px;
        }
        
        .pp-skeleton-stage {
            aspect-ratio: 16/9;
            background: linear-gradient(90deg, var(--pp-gray-100) 25%, var(--pp-gray-200) 50%, var(--pp-gray-100) 75%);
            background-size: 200% 100%;
            animation: pp-shimmer 1.5s infinite;
            border-radius: var(--pp-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: var(--pp-space-3);
        }
        
        .pp-skeleton-text {
            color: var(--pp-gray-500);
            font: var(--pp-font-body);
            font-weight: 500;
        }
        
        .pp-skeleton-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--pp-gray-200);
            border-top-color: var(--pp-accent-blue);
            border-radius: 50%;
            animation: pp-spin 0.8s linear infinite;
        }
        
        @keyframes pp-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        @keyframes pp-spin {
            to { transform: rotate(360deg); }
        }
        
        .pp-skeleton-bar {
            height: 40px;
            background: var(--pp-gray-100);
            border-radius: var(--pp-radius-sm);
            margin: var(--pp-space-3) 0;
            animation: pp-shimmer 1.5s infinite;
        }
        
        .pp-skeleton-controls {
            margin-top: var(--pp-space-4);
            display: flex;
            flex-direction: column;
            gap: var(--pp-space-3);
        }
        
        /* Editor Error State */
        .pp-editor-error {
            background: white;
            border-radius: var(--pp-radius-lg);
            padding: var(--pp-space-8);
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--pp-space-4);
        }
        
        .pp-error-icon {
            opacity: 0.8;
        }
        
        .pp-editor-error h3 {
            font: var(--pp-font-h3);
            color: var(--pp-gray-900);
            margin: 0;
        }
        
        .pp-editor-error p {
            font: var(--pp-font-body);
            color: var(--pp-gray-600);
            margin: 0;
            max-width: 400px;
        }
        
        .pp-error-actions {
            display: flex;
            gap: var(--pp-space-3);
            margin-top: var(--pp-space-2);
        }

        /* =========================================
           PHASE 1: LIBRARY MODERNIZATION TOKENS
           ========================================= */
        :root {
            /* Colors */
            --pp-primary: #0066FF;
            --pp-text: #1F2937;
            --pp-text-muted: #6B7280;
            --pp-border: #E5E7EB;
            --pp-bg: #F9FAFB;
            --pp-card-bg: #FFFFFF;
            
            /* Status Colors */
            --pp-status-success-bg: #dcfce7;
            --pp-status-success-text: #166534;
            --pp-status-warn-bg: #fef3c7;
            --pp-status-warn-text: #92400e;
            --pp-status-error-bg: #fee2e2;
            --pp-status-error-text: #b91c1c;

            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            
            /* Shadows */
            --pp-shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --pp-shadow-md: 0 1px 3px rgba(0,0,0,0.08);
            --pp-shadow-lg: 0 4px 6px rgba(0,0,0,0.1);
            
            /* Radius */
            --pp-radius-sm: 4px;
            --pp-radius-md: 6px;
            --pp-radius-lg: 8px;
            
            /* Typography */
            --pp-font-heading: 600 24px/1.2 'Archivo', sans-serif;
            --pp-font-subheading: 400 14px/1.4 'Archivo', sans-serif;
            --pp-font-body: 400 14px/1.5 'Archivo', sans-serif;
            --pp-font-label: 600 12px/1 'Archivo', sans-serif;
            --pp-font-mono: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        /* Utils */
        .pp-library-header {
            margin-bottom: var(--spacing-lg);
            background: var(--pp-card-bg);
            padding: var(--spacing-md);
            border-radius: var(--pp-radius-lg);
            border: 1px solid var(--pp-border);
            box-shadow: var(--pp-shadow-sm);
        }
        
        .pp-library-title {
            font: var(--pp-font-heading);
            color: var(--pp-text);
            margin-bottom: 4px;
        }
        
        .pp-library-subtitle {
            font: var(--pp-font-subheading);
            color: var(--pp-text-muted);
        }

        .pp-stats-row {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .pp-stat-card {
            background: var(--pp-bg);
            border: 1px solid var(--pp-border);
            border-radius: var(--pp-radius-lg);
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-width: 140px;
            flex: 1;
        }
        
        .pp-stat-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            color: var(--pp-text-muted);
        }
        
        .pp-stat-content {
            display: flex;
            flex-direction: column;
        }
        
        .pp-stat-value {
            font-weight: 600;
            font-size: 15px;
            color: var(--pp-text);
        }
        
        .pp-stat-label {
            font-size: 11px;
            color: var(--pp-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            .pp-stats-row {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            .pp-stat-card {
                width: 100%;
            }
        }

        /* =========================================
           PHASE 3: FILTER TOOLBAR TOKENS
           ========================================= */
        
        /* Toolbar Container */
        .pp-toolbar-card {
            background: var(--pp-card-bg);
            border: 1px solid var(--pp-border);
            border-radius: var(--pp-radius-lg);
            padding: var(--spacing-lg);
            margin-top: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
            box-shadow: var(--pp-shadow-sm);
        }

        /* Search Enhanced */
        .pp-search-group {
            position: relative;
            width: 100%;
        }
        
        .pp-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--pp-text-muted);
            pointer-events: none;
            width: 20px;
            height: 20px;
        }
        
        .pp-search-input {
            width: 100%;
            height: 44px;
            padding-left: 44px; /* Icon width + padding */
            padding-right: 12px;
            border: 1px solid var(--pp-border);
            border-radius: var(--pp-radius-md);
            font: var(--pp-font-body);
            font-size: 15px;
            background: #fff;
            transition: all 0.2s ease;
        }
        
        .pp-search-input:focus {
            border-color: var(--pp-primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
            outline: none;
        }

        /* Filter Row */
        .pp-filters-row {
            display: flex;
            gap: 40px; /* Separation between groups */
            flex-wrap: wrap;
        }
        
        .pp-filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .pp-filter-label {
            font: var(--pp-font-label);
            color: var(--pp-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .pp-filter-options {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        /* Pills */
        .pp-pill {
            background: white;
            border: 1px solid var(--pp-border);
            border-radius: var(--pp-radius-sm);
            padding: 0 16px;
            height: 36px;
            font-size: 14px;
            font-weight: 500;
            color: var(--pp-text);
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .pp-pill:hover:not(.active) {
            background: #EBF5FF; /* Light blue hover */
            border-color: #BFDBFE;
            color: var(--pp-primary);
        }
        
        .pp-pill.active {
            background: var(--pp-primary);
            color: white;
            border-color: var(--pp-primary);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Controls Row */
        .pp-controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--pp-border);
            padding-top: var(--spacing-lg);
        }
        
        /* Custom Sort Select (Hidden Native) */
        .pp-select-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .pp-select-custom {
            appearance: none;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236B7280' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") no-repeat right 12px center;
            border: 1px solid var(--pp-border);
            border-radius: var(--pp-radius-sm);
            height: 36px;
            padding: 0 36px 0 12px;
            font-size: 14px;
            color: var(--pp-text);
            cursor: pointer;
            min-width: 140px;
        }
        
        .pp-select-custom:focus {
            outline: none;
            border-color: var(--pp-primary);
        }

        /* View Toggles */
        .pp-view-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .pp-view-toggles {
            display: flex;
            gap: 2px;
            background: var(--pp-bg);
            padding: 2px;
            border-radius: var(--pp-radius-sm);
        }
        
        .pp-view-btn {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--pp-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pp-view-btn.active {
            background: white;
            color: var(--pp-primary);
            box-shadow: var(--pp-shadow-sm);
        }

        .pp-asset-count-label {
            font-size: 13px;
            color: var(--pp-text-muted);
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .pp-filters-row {
                flex-direction: column;
                gap: 24px;
            }
            .pp-controls-row {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }
            .pp-view-group {
                justify-content: space-between;
            }
        }

/* OFFER BUILDER MODERNIZATION */
.ob-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 32px 24px;
  border-radius: 12px 12px 0 0;
  margin-bottom: 0; /* Integrated with steps below */
  color: white;
  position: relative;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  z-index: 10;
}

.ob-title {
  font-size: 28px;
  font-weight: 700;
  color: white !important;
  margin: 0 0 8px 0;
}

.ob-subtitle {
  font-size: 15px;
  color: rgba(255, 255, 255, 0.9) !important;
  margin: 0 0 24px 0;
  max-width: 600px;
  line-height: 1.5;
}

.ob-actions {
  display: flex;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
}

.ob-btn-primary {
  background: white;
  color: #6b21a8; /* Deep purple to match gradient */
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 15px;
  border: none;
  cursor: pointer;
  transition: all 150ms ease;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.ob-btn-primary:hover {
  background: #f3f4f6;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.ob-btn-secondary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.4);
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 150ms ease;
}

.ob-btn-secondary:hover {
  background: rgba(255, 255, 255, 0.3);
}

.ob-btn-tertiary {
  background: transparent;
  color: rgba(255, 255, 255, 0.8);
  border: none;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  transition: all 150ms ease;
}

.ob-btn-tertiary:hover {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.ob-help-icon {
  position: absolute;
  top: 24px;
  right: 24px;
  color: rgba(255, 255, 255, 0.7);
  cursor: pointer;
  transition: color 0.2s;
  background: rgba(255,255,255,0.1);
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.ob-help-icon:hover {
  color: white;
  background: rgba(255,255,255,0.2);
}

/* STEPPER */
.ob-stepper {
  display: flex;
  justify-content: space-between;
  margin: 0 0 32px 0;
  padding: 24px 48px;
  background: white;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  position: relative;
  z-index: 5;
}

.ob-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  position: relative;
  flex: 1;
  cursor: default;
}

.ob-step:not(:last-child)::after {
  content: '';
  position: absolute;
  top: 16px;
  left: 50%;
  width: 100%;
  height: 2px;
  background: #e2e8f0;
  z-index: 10;
}

.ob-step.completed::after {
  background: #10b981;
}

.ob-step-circle {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #e2e8f0;
  color: #94a3b8;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
  z-index: 20;
  position: relative;
  transition: all 0.3s ease;
  border: 4px solid white;
}

.ob-step.completed .ob-step-circle {
  background: #10b981;
  color: white;
}

.ob-step.current .ob-step-circle {
  background: #8b5cf6;
  color: white;
  box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
}

.ob-step-label {
  margin-top: 8px;
  font-size: 13px;
  font-weight: 500;
  color: #64748b;
  text-align: center;
}

.ob-step.current .ob-step-label {
  color: #8b5cf6;
  font-weight: 700;
}

.ob-step.completed .ob-step-label {
  color: #10b981;
}

/* CARDS & LAYOUT */
.ob-main-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 24px 48px 24px;
}

.ob-layout {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 32px;
  align-items: start;
}

.ob-cards-column {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.ob-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.02), 0 1px 2px rgba(0,0,0,0.03);
  margin-bottom: 0;
  border: 1px solid #f1f5f9;
  overflow: hidden;
  transition: transform 0.2s, box-shadow 0.2s;
}

.ob-card:hover {
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
}

.ob-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #f1f5f9;
  background: #ffffff;
}

.ob-card-title {
  font-size: 18px;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.ob-card-subtitle {
  font-size: 14px;
  color: #64748b;
  margin: 4px 0 0 0;
  font-weight: 400;
}

.ob-card-body {
  padding: 24px;
}

/* FORMS */
.ob-form-group {
  margin-bottom: 24px;
}

.ob-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #334155;
  margin-bottom: 8px;
}

.ob-required {
  color: #ef4444;
  margin-left: 2px;
}

.ob-input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  font-size: 15px;
  color: #0f172a;
  background-color: #f8fafc;
  transition: all 0.2s;
}

.ob-input:focus {
  outline: none;
  background-color: #fff;
  border-color: #8b5cf6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

.ob-price-input-group {
  display: flex;
  align-items: center;
  position: relative;
}

.ob-price-symbol {
  position: absolute;
  left: 16px;
  color: #64748b;
  font-weight: 600;
  font-size: 18px;
}

.ob-price-input {
  padding-left: 32px;
  font-size: 18px;
  font-weight: 700;
  color: #0f172a;
  letter-spacing: -0.02em;
}

.ob-btn-action {
  background: #f1f5f9;
  border: none;
  padding: 12px 20px;
  border-radius: 8px;
  color: #475569;
  font-weight: 600;
  cursor: pointer;
  margin-left: 12px;
  white-space: nowrap;
  transition: all 0.2s;
}

.ob-btn-action:hover {
  background: #e2e8f0;
  color: #1e293b;
}

/* SERVICE LIST */
.ob-service-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.ob-empty-state {
  text-align: center;
  padding: 48px 24px;
  background: #f8fafc;
  border-radius: 12px;
  border: 2px dashed #cbd5e1;
}

.ob-empty-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
  opacity: 0.5;
}

/* SIDEBAR */
.ob-sidebar {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.ob-info-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
  border: 1px solid #f1f5f9;
  overflow: hidden;
}

.ob-info-header {
  padding: 16px 20px;
  border-bottom: 1px solid #f1f5f9;
  display: flex;
  align-items: center;
  gap: 8px;
  background: #ffffff;
}

.ob-info-title {
  font-size: 15px;
  font-weight: 600;
  color: #1e293b;
  margin: 0;
}

.ob-stat-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #f1f5f9;
}

.ob-stat-row:last-child {
  border-bottom: none;
}

.ob-stat-label {
  font-size: 13px;
  color: #64748b;
}

.ob-stat-value {
  font-size: 16px;
  font-weight: 600;
  color: #0f172a;
}

.ob-tip-card {
  background: #fffbeb;
  border: 1px solid #fcd34d;
}

.ob-tip-header {
  background: #fef3c7;
  border-bottom-color: #fce7b0;
  color: #92400e;
}

.ob-accordion-summary {
  cursor: pointer;
  list-style: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  font-weight: 600;
  color: #1e293b;
  transition: background 0.2s;
}

.ob-accordion-summary:hover {
  background: #f8fafc;
}

.ob-accordion-summary::-webkit-details-marker {
  display: none;
}

.ob-chevron {
  transition: transform 0.2s;
}

details[open] .ob-chevron {
  transform: rotate(180deg);
}

@media (max-width: 1024px) {
  .ob-layout {
    grid-template-columns: 1fr;
  }
  .ob-sidebar {
    order: -1;
  }
}

/* ===== OFFER BUILDER FINAL OVERRIDES (Ensure readability + alignment) ===== */
/* These intentionally come last to override older unscoped styles above. */
#offerbuilder-pane .ob-container {
    max-width: 1100px !important;
    margin: 0 auto !important;
}

#offerbuilder-pane .ob-workspace {
    max-width: 1100px;
    margin: 0 auto;
}

#offerbuilder-pane #offerBuilderBuildOrder {
    max-width: 1100px;
    margin: 0 auto 24px;
}

#offerbuilder-pane #offerBuilderMainGrid {
    max-width: 1100px;
    margin: 0 auto;
    grid-template-columns: 1fr !important;
}

/* When we stack columns, ensure right column fills width and behaves normally */
#offerbuilder-pane #offerBuilderRightColumn {
    width: 100% !important;
    margin-top: 20px;
}

/* Disable sticky behavior in single-column layout (prevents weird empty areas) */
#offerbuilder-pane #offerBuilderStandards {
    position: relative !important;
    top: auto !important;
    max-height: none !important;
    overflow: visible !important;
}

#offerbuilder-pane #offerBuilderStandardsContent,
#offerbuilder-pane #offerBuilderResults {
    max-height: none !important;
    overflow: visible !important;
}

/* Stepper: high contrast + clear current step */
#offerbuilder-pane .ob-stepper {
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
    background: transparent !important;
    padding: 0 !important;
    box-shadow: none !important;
    border-radius: 0 !important;
}

#offerbuilder-pane .ob-stepper-title {
    color: var(--azure) !important;
    font-weight: 900 !important;
}

#offerbuilder-pane .ob-stepper-track {
    display: flex !important;
    justify-content: space-between !important;
    align-items: flex-start !important;
    gap: 8px !important;
}

#offerbuilder-pane .ob-step {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: flex-start !important;
    position: relative !important;
    flex: 1 1 0 !important;
    min-width: 0 !important;
    padding: 10px 8px !important;
    text-align: center !important;
    cursor: pointer !important;
}

#offerbuilder-pane .ob-step-circle {
    background: #ffffff !important;
    border-color: #94a3b8 !important;
    color: #1f2937 !important;
    font-weight: 900 !important;
}

#offerbuilder-pane .ob-step-label {
    color: #1f2937 !important;
    font-weight: 800 !important;
    margin-top: 8px !important;
    font-size: 12px !important;
    line-height: 1.2 !important;
}

/* Connector pills between steps */
#offerbuilder-pane .ob-step:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 16px;
    left: 50%;
    width: 100%;
    height: 4px;
    border-radius: 9999px;
    background: #e2e8f0;
    z-index: 0;
}

#offerbuilder-pane .ob-step.is-done:not(:last-child)::after {
    background: rgba(16, 185, 129, 0.35);
}

#offerbuilder-pane .ob-step.is-current:not(:last-child)::after {
    background: rgba(0, 102, 255, 0.22);
}

#offerbuilder-pane .ob-step-circle {
    z-index: 1;
}

@media (max-width: 768px) {
    #offerbuilder-pane #offerBuilderMainGrid {
        max-width: 100% !important;
    }
    #offerbuilder-pane .ob-step:not(:last-child)::after {
        display: none;
    }
    #offerbuilder-pane .ob-stepper-track {
        gap: 12px !important;
        overflow-x: auto !important;
        padding-bottom: 4px;
        -webkit-overflow-scrolling: touch;
    }
    #offerbuilder-pane .ob-step {
        flex: 0 0 128px !important;
    }
}

#offerbuilder-pane .ob-step.is-current .ob-step-circle {
    background: var(--azure) !important;
    border-color: var(--azure) !important;
    color: #ffffff !important;
    box-shadow: 0 0 0 4px rgba(0, 102, 255, 0.14) !important;
}

#offerbuilder-pane .ob-step.is-current .ob-step-label {
    color: var(--azure) !important;
}

#offerbuilder-pane .ob-step.is-done .ob-step-label {
    color: #059669 !important;
}
    </style>
    <!-- jsPDF Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body style="background: #0a2a5a !important; background-color: #0a2a5a !important;">

    <!-- USER SELECTION GATE -->
    <div id="userGate">
        <div class="user-gate-card">
            <img class="user-gate-logo" 
                 src="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png" 
                 alt="Home2Smart">
            <h2 class="user-gate-title">Welcome to Home2Smart</h2>
            <p class="user-gate-subtitle">Select your profile to continue</p>
            
            <div class="user-gate-select-wrapper">
                <select id="userSelect" class="user-gate-select">
                    <option value="">-- Select Your Name --</option>
                    <option value="ROSEL">Rosel</option>
                </select>
            </div>
            
            <button id="userGateBtn" class="user-gate-btn" disabled onclick="enterDashboard()">
                <span>Enter Dashboard</span>
            </button>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- CUSTOM MODAL DIALOG -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-dialog">
            <div class="modal-header" id="modalHeader">Confirm</div>
            <div class="modal-body" id="modalBody">Are you sure?</div>
            <div class="modal-actions" id="modalActions">
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="modalConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- APP SHELL WRAPPER -->
    <div id="h2s-app">
        <!-- TOP BAR -->
        <div class="app-topbar">
            <div class="app-topbar-left">
                <div class="app-topbar-logo">
                    <img src="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png" 
                         alt="Home2Smart Logo">
                    <span class="app-topbar-title">hiring dashboard</span>
                </div>
                <div class="app-topbar-area" id="currentAreaTitle">Pipeline</div>
            </div>
            <div class="app-topbar-right">
                <button class="logout-btn" onclick="logoutUser()" style="display: none;" id="logoutBtn">
                    Logout
                </button>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="app-sidebar">
            <nav class="app-sidebar-nav">
                <a class="app-sidebar-nav-item active" data-tab="pipeline" onclick="switchToTab('pipeline')">
                    Pipeline
                </a>
                <a class="app-sidebar-nav-item" data-tab="screening" onclick="switchToTab('screening')">
                    Screening Form
                </a>
                <a class="app-sidebar-nav-item" data-tab="techinterview" onclick="switchToTab('techinterview')">
                    Tech Interview
                </a>
                <a class="app-sidebar-nav-item" data-tab="hours" onclick="switchToTab('hours')">
                    Log Hours
                </a>
                <a class="app-sidebar-nav-item" data-tab="reports" onclick="switchToTab('reports')">
                    Candidate Review
                </a>
                <a class="app-sidebar-nav-item" data-tab="training" onclick="switchToTab('training')">
                    Training
                </a>
                <a class="app-sidebar-nav-item" data-tab="tasks" onclick="switchToTab('tasks')">
                    Tasks
                </a>
                <a class="app-sidebar-nav-item" data-tab="deliverables" onclick="switchToTab('deliverables')">
                    Deliverables
                </a>
                <a class="app-sidebar-nav-item" data-tab="offerbuilder" onclick="switchToTab('offerbuilder')">
                    Offer Builder
                </a>
                <div class="app-sidebar-nav-divider"></div>
                <div class="app-sidebar-nav-label">Admin</div>
                <a class="app-sidebar-nav-item" data-tab="admin" onclick="switchToTab('admin')">
                    Admin Dashboard
                </a>
                <a class="app-sidebar-nav-item" data-tab="proofpacks" onclick="switchToTab('proofpacks')">
                    Proof Packs
                </a>

                <div class="app-sidebar-nav-divider"></div>
                <div class="app-sidebar-nav-label">Feedback</div>
                <a class="app-sidebar-nav-item" href="#" onclick="bugReportsUI.openReportModal(); return false;">
                    Report Bugs
                </a>
            </nav>
        </div>

        <!-- MAIN CONTENT -->
        <div class="app-main">
            <div class="app-content">
                <!-- TABS (hidden, kept for compatibility) -->
                <nav class="tabs" style="display: none;">
                    <button class="tab active" data-tab="pipeline">Pipeline</button>
                    <button class="tab" data-tab="screening">Screening Form</button>
                    <button class="tab" data-tab="techinterview">Tech Interview Form</button>
                    <button class="tab" data-tab="hours">Log Hours</button>
                    <button class="tab" data-tab="reports">Candidate Review</button>
                    <button class="tab" data-tab="training">Training</button>
                    <button class="tab" data-tab="tasks">Tasks</button>
                    <button class="tab" data-tab="deliverables">Deliverables</button>
                </nav>

                <!-- PIPELINE PANE -->
                <div class="pane active" id="pipeline-pane">
                    <!-- Workbench Header -->
                    <div class="workbench-header">
                        <div class="workbench-search">
                            <input type="text" id="pipelineSearch" placeholder="Search candidates..." oninput="filterPipeline()">
                        </div>
                        <div class="workbench-actions">
                            <button onclick="bulkCleanupPipeline()" class="btn" style="background: var(--danger); color: white;">
                                Bulk Cleanup
                            </button>
                        </div>
                    </div>
                    <div id="pipelineContainer" class="pipeline">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- SCREENING FORM PANE -->
                <div class="pane" id="screening-pane">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div>
                                <h2 class="card-title" style="margin-bottom: 4px;">H2S Screening Form</h2>
                                <p style="color: var(--cobalt); margin: 0;">Initial VA-led screening form for service tech candidates.</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" onclick="fillScreeningSample()" class="btn" style="padding: 10px 20px; font-size: 14px;">
                                    Fill Sample
                                </button>
                                <button type="button" onclick="resetScreeningForm()" class="btn" style="padding: 10px 20px; font-size: 14px;">
                                    Reset Form
                                </button>
                            </div>
                        </div>

                        <form id="screeningForm" onsubmit="submitScreening(event)">
                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">First Name</label>
                                    <input class="form-input" id="screeningFirstName" type="text" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Last Name</label>
                                    <input class="form-input" id="screeningLastName" type="text" required>
                                </div>
                            </div>

                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Phone</label>
                                    <input class="form-input" id="screeningPhone" type="tel" placeholder="+1 (555) 555-5555" required>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Email</label>
                                    <input class="form-input" id="screeningEmail" type="email" placeholder="name@email.com">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Notes / Concerns</label>
                                <textarea class="form-textarea" id="screeningNotes" rows="4" placeholder="Key notes from the call..."></textarea>
                            </div>

                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Tools Requirements Met?</label>
                                    <select class="form-input" id="screeningToolsReq">
                                        <option value="">Unknown</option>
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Experience Level</label>
                                    <select class="form-input" id="screeningExperience">
                                        <option value="">Select</option>
                                        <option value=">2 years">&gt; 2 years</option>
                                        <option value="<2 years">&lt; 2 years</option>
                                        <option value="Unknown">Unknown</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Commute OK?</label>
                                    <select class="form-input" id="screeningCommuteOk">
                                        <option value="">Unknown</option>
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Weekday Daytime Available?</label>
                                    <select class="form-input" id="screeningWeekday">
                                        <option value="">Unknown</option>
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Evenings / Saturday Available?</label>
                                    <select class="form-input" id="screeningEveningSat">
                                        <option value="">Unknown</option>
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Screening Outcome</label>
                                    <select class="form-input" id="screeningOutcome" required>
                                        <option value="">Select</option>
                                        <option value="PASS">Pass</option>
                                        <option value="REJECT">Reject</option>
                                        <option value="FOLLOW_UP">Needs Follow-up</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Effort / Willingness To Take Interviews</label>
                                <select class="form-input" id="screeningInterviewEffort">
                                    <option value="">Select</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>

                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <button type="submit" class="btn" style="background: var(--cobalt); color: white;">
                                    Submit Screening
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- TECH INTERVIEW FORM PANE -->
                <div class="pane" id="techinterview-pane">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div>
                                <h2 class="card-title" style="margin-bottom: 4px;">Tech Interview Form</h2>
                                <p style="color: var(--cobalt); margin: 0;">Deep VA interview phase for technical assessment.</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button type="button" onclick="fillTechInterviewSample()" class="btn" style="padding: 10px 20px; font-size: 14px;">
                                    Fill Sample
                                </button>
                                <button type="button" onclick="resetTechInterviewForm()" class="btn" style="padding: 10px 20px; font-size: 14px;">
                                    Reset Form
                                </button>
                            </div>
                        </div>

                        <form id="techInterviewForm" onsubmit="submitTechInterview(event)">
                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Candidate First Name</label>
                                    <input class="form-input" id="techFirstName" type="text" placeholder="First name">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Candidate Last Name</label>
                                    <input class="form-input" id="techLastName" type="text" placeholder="Last name">
                                </div>
                            </div>

                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Candidate Email</label>
                                    <input class="form-input" id="techEmail" type="email" placeholder="name@email.com">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Candidate Phone</label>
                                    <input class="form-input" id="techPhone" type="tel" placeholder="+1 (555) 555-5555" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Job Types Confident In</label>
                                <textarea class="form-textarea" id="techJobTypes" rows="3" placeholder="What job types can they confidently handle?"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Judgment Criteria</label>
                                <textarea class="form-textarea" id="techJudgment" rows="3" placeholder="How do they make decisions on a job?"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Troubleshooting Scenario</label>
                                <textarea class="form-textarea" id="techTroubleshooting" rows="4" placeholder="Describe a troubleshooting example and how they handled it."></textarea>
                            </div>

                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Jobs Per Week Desired</label>
                                    <input class="form-input" id="techJobsPerWeek" type="number" min="0" step="1" placeholder="e.g., 10">
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Worked 1099 Before?</label>
                                    <select class="form-input" id="techWorked1099">
                                        <option value="">Unknown</option>
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Other Job?</label>
                                <select class="form-input" id="techHasOtherJob">
                                    <option value="">Unknown</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Balancing Both Jobs / Schedule Plan</label>
                                <textarea class="form-textarea" id="techBalancing" rows="3" placeholder="How will they balance availability and jobs?"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Responsibility Management</label>
                                <textarea class="form-textarea" id="techResponsibility" rows="3" placeholder="How do they manage responsibility, accountability, follow-through?"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Communication / Navigation</label>
                                <textarea class="form-textarea" id="techCommunication" rows="3" placeholder="How do they communicate and navigate issues?"></textarea>
                            </div>

                            <div class="form-row" style="gap: 12px; align-items: flex-end;">
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Interview Outcome</label>
                                    <select class="form-input" id="techOutcome" required>
                                        <option value="">Select</option>
                                        <option value="PASS">Pass</option>
                                        <option value="REJECT">Reject</option>
                                        <option value="FOLLOW_UP">Needs Follow-up</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex: 1;">
                                    <label class="form-label">Interview Notes</label>
                                    <input class="form-input" id="techNotes" type="text" placeholder="Short summary (optional)">
                                </div>
                            </div>

                            <div style="display: flex; gap: 12px; margin-top: 16px;">
                                <button type="submit" class="btn" style="background: var(--cobalt); color: white;">
                                    Submit Tech Interview
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- HOURS PANE -->
                <div class="pane" id="hours-pane">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 4px;">Hours Tracking</h2>
                        <p style="color: var(--cobalt); margin: 0;">Log your daily work with AI-powered productivity analysis.</p>
                    </div>
                    <button onclick="openHoursModal()" class="btn" style="padding: 14px 24px; font-size: 16px; background: var(--success); color: white;">
                        Log Today's Hours
                    </button>
                </div>
                
                <div id="hoursHistoryContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- HOURS LOGGING MODAL -->
        <div class="task-modal-overlay" id="hoursModal" onclick="closeHoursModal(event)">
            <div class="task-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                <div class="task-modal-header">
                    <div style="flex: 1;">
                        <div class="task-title" style="font-size: 24px; margin-bottom: 8px;">Log Hours</div>
                        <div style="color: var(--cobalt); font-size: 14px;">Record your work hours: Enter start and end times to calculate total hours worked</div>
                    </div>
                    <button class="task-modal-close" onclick="closeHoursModal()">X</button>
                </div>
                <div class="task-modal-body">
                    <form id="hoursForm">
                        <div class="form-row" style="margin-bottom: 20px; align-items: flex-end; gap: 12px;">
                            <div class="form-group" style="flex: 1.5;">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-input" id="hoursDate" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Start</label>
                                <input type="time" class="form-input" id="hoursStart" onchange="calculateDuration()" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">End</label>
                                <input type="time" class="form-input" id="hoursEnd" onchange="calculateDuration()" required>
                            </div>
                            <div class="form-group" style="flex: 0.8; text-align: center; background: #f1f3f4; border-radius: 8px; padding: 8px; height: 46px; display: flex; flex-direction: column; justify-content: center;" title="Calculated automatically from start and end times">
                                <div style="font-size: 10px; color: #5f6368; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Hours Worked</div>
                                <div id="durationDisplay" style="font-size: 16px; font-weight: 900; color: var(--azure); line-height: 1;">0h</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">1. What specific tasks did you complete today?</label>
                            <textarea class="form-textarea" id="hoursTasks" rows="4" placeholder="List the candidates screened, interviews booked, or admin tasks finished..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">2. What was your biggest win or learning today?</label>
                            <textarea class="form-textarea" id="hoursLearned" rows="3" placeholder="e.g., 'Learned how to handle objection X' or 'Found a great candidate for the North region'..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">3. Any blockers, questions, or support needed?</label>
                            <textarea class="form-textarea" id="hoursBlockers" rows="2" placeholder="e.g., 'Need access to X tool' or 'Unsure about Y process' (Leave blank if none)"></textarea>
                        </div>
                        
                        <div style="margin-top: 8px; color: #5f6368; font-size: 13px; font-style: italic;">
                            * Detailed logs help us track progress and remove blockers faster.
                        </div>
                    </form>
                </div>
                <div class="task-modal-actions">
                    <button type="button" class="task-action-btn task-close-btn" onclick="closeHoursModal()">Cancel</button>
                    <button type="button" class="task-action-btn task-complete-btn" onclick="submitHours()">Log Hours</button>
                </div>
            </div>
                </div>

                <!-- REPORTS PANE -->
                <div class="pane" id="reports-pane">
            <div class="card">
                <h2 class="card-title">Candidate Review</h2>
                <p style="color: var(--cobalt); margin-bottom: 20px;">AI-powered candidate evaluations with manual review capabilities.</p>
                
                <!-- Filter Buttons -->
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="pending" onclick="filterProfiles('pending')">
                        Pending Review
                    </button>
                    <button class="filter-btn" data-filter="passed" onclick="filterProfiles('passed')">
                        Passed
                    </button>
                    <button class="filter-btn" data-filter="all" onclick="filterProfiles('all')">
                        All Candidates
                    </button>
                    <button class="filter-btn" data-filter="failed" onclick="filterProfiles('failed')">
                        Failed
                    </button>
                </div>
                
                <div id="aiProfilesContainer">
                    <div class="spinner"></div>
                </div>
            </div>
                </div>

                <!-- TRAINING PANE -->
                <div class="pane" id="training-pane">
            <!-- Minimal Progress Summary -->
            <div class="card" id="knowledgeProfileCard" style="margin-bottom: 24px; display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 4px;">Your Training Progress</h2>
                        <p style="color: var(--cobalt); margin: 0; font-size: 14px;">Keep completing trainings to build your skills</p>
                    </div>
                    <div style="display: flex; gap: 24px; align-items: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 900; color: var(--azure);" id="totalTrainings">0</div>
                            <div style="font-size: 12px; color: #666;">Completed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 900; color: var(--success);" id="learningHours">0h</div>
                            <div style="font-size: 12px; color: #666;">Learning Time</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Training Resources Card -->
            <div class="card">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 4px;">Training Resources</h2>
                        <p style="color: var(--cobalt); margin: 0;">Complete trainings to build your knowledge base</p>
                    </div>
                    <button onclick="toggleAdminPanel()" class="btn" style="padding: 10px 20px; font-size: 14px; background: #eff6ff; color: var(--azure); border: 1px solid #bfdbfe; font-weight: 700; border-radius: 10px; transition: all 0.2s;">
                        Manage Training
                    </button>
                </div>

                <!-- Learning Path Tiers -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 32px;">
                    <button class="tier-btn active" data-tier="all" onclick="filterTrainingByTier('all')" style="padding: 20px; border-radius: 16px; border: 2px solid #0a2a5a; background: #0a2a5a; color: white; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(10,42,90,0.2);">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <div style="font-size: 16px;">All Training</div>
                    </button>
                    <button class="tier-btn" data-tier="Foundation" onclick="filterTrainingByTier('Foundation')" style="padding: 20px; border-radius: 16px; border: 3px solid #e0e0e0; background: white; color: var(--cobalt); font-weight: 700; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 8px;">Build</div>
                        <div style="font-size: 16px;">Foundation</div>
                        <div style="font-size: 12px; font-weight: 400; color: #666; margin-top: 4px;">Business basics, systems, ops</div>
                    </button>
                    <button class="tier-btn" data-tier="Core Skills" onclick="filterTrainingByTier('Core Skills')" style="padding: 20px; border-radius: 16px; border: 3px solid #e0e0e0; background: white; color: var(--cobalt); font-weight: 700; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 8px;">Work</div>
                        <div style="font-size: 16px;">Core Skills</div>
                        <div style="font-size: 12px; font-weight: 400; color: #666; margin-top: 4px;">Marketing, offers, customer work</div>
                    </button>
                    <button class="tier-btn" data-tier="Advanced" onclick="filterTrainingByTier('Advanced')" style="padding: 20px; border-radius: 16px; border: 3px solid #e0e0e0; background: white; color: var(--cobalt); font-weight: 700; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 8px;">Launch</div>
                        <div style="font-size: 16px;">Advanced</div>
                        <div style="font-size: 12px; font-weight: 400; color: #666; margin-top: 4px;">Web design, AI tools, tech skills</div>
                    </button>
                </div>

                <!-- Admin Panel (Hidden by default) -->
                <div id="trainingAdminPanel" style="display: none; margin-bottom: 24px; padding: 32px; background: linear-gradient(135deg, #0a2a5a 0%, #144a8a 100%); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h3 style="color: white; margin: 0; font-size: 24px; margin-bottom: 4px;">Training Management Console</h3>
                            <p style="color: rgba(255,255,255,0.9); margin: 0; font-size: 14px;">Upload videos, create SOPs, manage all training content</p>
                        </div>
                        <button onclick="toggleAdminPanel()" style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 10px; font-weight: 600; cursor: pointer;">
                            Close
                        </button>
                    </div>
                    
                    <!-- Quick Add Form -->
                    <form id="newTrainingForm" onsubmit="submitNewTraining(event)" style="background: white; padding: 32px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.12);">
                        <h4 style="color: var(--cobalt); margin-bottom: 24px; font-size: 22px; font-weight: 700;">Upload New Training</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Title -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Video Title</label>
                                <input type="text" id="newTrainingTitle" placeholder="e.g., How to Create Winning Marketing Offers" required style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; transition: all 0.2s; font-family: inherit;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>

                            <!-- Loom URL -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Loom Video URL</label>
                                <input type="url" id="newTrainingURL" placeholder="https://loom.com/share/abc123..." required style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; transition: all 0.2s; font-family: monospace;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                <p style="font-size: 12px; color: #999; margin-top: 6px; margin-bottom: 0;">Copy the share link from your Loom video</p>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Learning Category -->
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Training Category</label>
                                <select id="newTrainingCategory" required style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                    <option value="Marketing">Marketing & Lead Generation</option>
                                    <option value="CRM">CRM & Sales Management</option>
                                    <option value="Technical">Technical Implementation</option>
                                    <option value="Operations">Operations & Fulfillment</option>
                                    <option value="Home2Smart">Home2Smart</option>
                                </select>
                                <p style="font-size: 12px; color: #999; margin-top: 6px; margin-bottom: 0;">Choose the category that best fits this training</p>
                            </div>

                            <!-- Duration -->
                            <div style="margin-bottom: 28px;">
                                <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Video Length (minutes)</label>
                                <input type="number" id="newTrainingDuration" placeholder="e.g., 15" min="1" style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 15px; transition: all 0.2s;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                            </div>
                        </div>

                        <!-- Optional: Description -->
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; font-weight: 700; color: var(--cobalt); margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Description <span style="font-weight: 400; text-transform: none; color: #999;">(Optional)</span></label>
                            <textarea id="newTrainingDescription" rows="3" placeholder="Brief overview of what's covered..." style="width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 14px; font-family: inherit; resize: vertical; transition: all 0.2s;" onfocus="this.style.borderColor='var(--azure)'; this.style.boxShadow='0 0 0 3px rgba(20, 147, 255, 0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"></textarea>
                        </div>

                        <button type="submit" style="width: 100%; padding: 18px; background: linear-gradient(135deg, var(--azure) 0%, #667eea 100%); color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 17px; cursor: pointer; box-shadow: 0 6px 20px rgba(20, 147, 255, 0.4); transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(20, 147, 255, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(20, 147, 255, 0.4)'">
                            Upload Training Video
                        </button>
                    </form>

                    <!-- Manage Existing Resources -->
                    <div style="background: white; padding: 28px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                        <h4 style="color: var(--cobalt); margin-bottom: 16px; font-size: 18px;">Manage Existing Resources</h4>
                        <div id="adminTrainingList">
                            <div class="spinner"></div>
                        </div>

                <!-- Smart Filter Tabs -->
                <div style="display: flex; gap: 12px; margin-bottom: 24px; border-bottom: 2px solid #e5e7eb;">
                    <button class="training-filter-tab" data-filter="recommended" onclick="filterTrainingResources('recommended')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                        Recommended for You <span id="recommendedCount" style="background: #e5e7eb; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
                    </button>
                    <button class="training-filter-tab" data-filter="inprogress" onclick="filterTrainingResources('inprogress')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid transparent; color: #6b7280; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                        In Progress <span id="inprogressCount" style="background: #e5e7eb; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
                    </button>
                    <button class="training-filter-tab active" data-filter="all" onclick="filterTrainingResources('all')" style="padding: 12px 20px; background: none; border: none; border-bottom: 3px solid #0a2a5a; color: #0a2a5a; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;">
                        All Resources <span id="allCount" style="background: #0a2a5a; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
                    </button>
                </div>
                    </div>
                </div>

                <!-- Training Resources Grid -->
                <div id="trainingContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

                <!-- DELIVERABLES PANE -->
                <div class="pane" id="deliverables-pane">
            <div style="display: flex; gap: var(--gap-2); margin-bottom: var(--gap-2); flex-wrap: wrap;">
                <button class="btn" onclick="switchDeliverablesView('submission')" id="deliverablesTabSubmission" style="background: var(--cobalt); color: white;">
                    Submit
                </button>
                <button class="btn" onclick="switchDeliverablesView('review')" id="deliverablesTabReview">
                    Review Queue
                </button>
                <button class="btn" onclick="switchDeliverablesView('library')" id="deliverablesTabLibrary">
                    Library
                </button>
            </div>
            
            <!-- Submission View -->
            <div id="deliverablesSubmissionView" class="deliverables-view">
                <div class="card">
                    <h2 class="card-title">Submit Deliverable</h2>
                    <form id="deliverableSubmissionForm" onsubmit="submitDeliverable(event)">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--cobalt);">Title</label>
                            <input type="text" id="deliverableTitle" required style="width: 100%; height: 40px; padding: 0 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--cobalt);">Description</label>
                            <textarea id="deliverableDescription" required style="width: 100%; min-height: 120px; padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 15px; font-family: inherit;"></textarea>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--cobalt);">Attach File (optional)</label>
                            <div id="deliverableFileUpload" style="border: 2px dashed var(--border); border-radius: var(--radius); padding: var(--gap-2); text-align: center; background: var(--surface-2); cursor: pointer; transition: all 0.2s;" 
                                 ondrop="handleFileDrop(event)" 
                                 ondragover="handleDragOver(event)" 
                                 ondragleave="handleDragLeave(event)"
                                 onclick="document.getElementById('deliverableFileInput').click()">
                                <input type="file" id="deliverableFileInput" style="display: none;" onchange="handleFileSelect(event)" multiple>
                                <div id="deliverableFileDisplay" style="font-size: 14px; color: var(--muted);">
                                    <div style="margin-bottom: 8px;">Drag and drop files here, or click to browse</div>
                                    <div style="font-size: 12px; color: var(--muted);">Supports multiple files</div>
                                </div>
                                <div id="deliverableFileList" style="margin-top: var(--gap-1); text-align: left; display: none;"></div>
                            </div>
                        </div>
                        <button type="submit" class="btn" style="background: var(--cobalt); color: white;">
                            Submit for Review
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Review Queue View -->
            <div id="deliverablesReviewView" class="deliverables-view" style="display: none;">
                <div id="deliverablesReviewContainer">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <!-- Library View -->
            <div id="deliverablesLibraryView" class="deliverables-view" style="display: none;">
                <div id="deliverablesLibraryContainer">
                    <div class="spinner"></div>
                </div>
            </div>
                </div>

                <!-- TASKS PANE -->
                <div class="pane" id="tasks-pane">
            <div class="card">
                <div class="tasks-header-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div>
                        <h2 class="card-title">Tasks</h2>
                        <p style="color: var(--cobalt); margin: 0;">Active tasks, documents, and action items.</p>
                    </div>
                    <button onclick="openAddTaskModal()" class="btn" style="padding: 10px 20px; font-size: 14px; background: var(--azure); color: white;">
                        + Add Task
                    </button>
                </div>
                <div id="tasksContainer">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

                <!-- ADMIN DASHBOARD PANE -->
                <div class="pane" id="admin-pane">
                    <div style="max-width: 1600px; margin: 0 auto; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <h2 style="font-size: 28px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">Admin Dashboard</h2>
                                <p style="color: #6b7280; margin: 0; font-size: 14px;">Comprehensive overview of operations, deliverables, training, and productivity metrics</p>
            </div>
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <select id="adminDateRange" onchange="adminDashboard.refresh()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 13px; background: white; color: var(--cobalt); cursor: pointer;">
                                    <option value="all">All Time</option>
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                </select>
                                <button onclick="adminDashboard.refresh()" class="btn" style="padding: 8px 16px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    Refresh
                                </button>
                            </div>
                        </div>
                        <div id="adminDashboardContent">
                <div class="spinner"></div>
                        </div>
                    </div>
            </div>

                <!-- PROOF PACKS PANE -->
                <div class="pane" id="proofpacks-pane">
                    <div class="ds-content">
                        <div class="ds-page-header">
                            <div>
                                <div class="ds-page-header__title">Proof Packs</div>
                                <div class="ds-page-header__subtitle">Upload proof photos/videos for the bundles page. The system rotates them automatically.</div>
                            </div>
                            <div class="button-group u-flex u-wrap u-gap-12"></div>
                        </div>

                        <!-- Service Selection Only -->
                        <div class="card">
                            <div class="u-flex u-between u-center u-wrap u-gap-2">
                                <div>
                                    <div class="card-header u-mb-1" id="ppHeroTitle">Upload Proof</div>
                                    <div class="u-text-sm u-muted" id="ppHeroSubtitle">Upload images and videos.</div>
                                </div>
                                <div class="button-group u-flex u-wrap u-gap-12"></div>
                            </div>

                            <div class="card-content u-mt-2">
                                <div class="form-field" style="max-width:400px;">
                                    <label class="form-label" for="ppService">Service Category</label>
                                    <select id="ppService" class="form-select">
                                        <option value="tv_mounting" selected>TV Mounting</option>
                                        <option value="cameras">Cameras</option>
                                    </select>
                                </div>

                                <div class="form-field u-mt-2" style="max-width:400px;">
                                    <label class="form-label" for="ppIntent">Proof Type (Required)</label>
                                    <select id="ppIntent" class="form-select">
                                        <option value="" selected>Select proof type...</option>
                                        <option value="working_shot">Working Shot (tech visible working)</option>
                                        <option value="action_proof">Action Proof (process / motion)</option>
                                        <option value="result_proof">Result Proof (finished outcome)</option>
                                    </select>
                                    <div class="u-text-xs u-muted u-mt-1">Choose before upload so the asset is saved correctly.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden for backend -->
                        <input type="hidden" id="ppPackSelect" value="default" />
                        <input type="hidden" id="ppSurface" value="bundles" />
                        <input type="hidden" id="ppWeekOf" value="" />
                        <input type="hidden" id="ppPackTitle" value="" />

                        <!-- Mode selector: Upload vs Library -->
                        <div class="card u-mt-3">
                            <div class="u-flex u-between u-center u-wrap u-gap-2">
                                <div>
                                    <div class="card-header u-mb-1">Workspace</div>
                                    <div class="u-text-sm u-muted">Upload creates new assets. Library manages and edits existing assets.</div>
                                </div>
                                <div class="button-group u-flex u-wrap u-gap-12">
                                    <button id="ppModeUpload" class="btn btn-secondary" type="button">Upload</button>
                                    <button id="ppModeLibrary" class="btn btn-secondary" type="button">Library</button>
                                </div>
                            </div>
                        </div>

                        <div id="ppUploadWorkspace">


                        <!-- Primary action: Quick Upload -->
                        <div class="card u-mt-3">
                            <div class="u-flex u-between u-center u-wrap u-gap-2">
                                <div>
                                    <div class="card-header u-mb-1">Upload Files</div>
                                    <div class="u-text-sm u-muted" id="ppQuickMeta">Drop files or click to browse. Supports bulk upload.</div>
                                </div>
                                <div class="u-flex u-gap-1 u-wrap u-center">
                                    <span class="pill" id="ppCoverageVideos">Videos: -/-</span>
                                    <span class="pill" id="ppCoveragePhotos">Photos: -/-</span>
                                </div>
                            </div>

                            <div id="ppDropzone" class="dropzone u-mt-2" role="button" tabindex="0" aria-label="Upload files">
                                <div>
                                    <p class="dropzone-title">Drop files here or click to browse</p>
                                    <p class="dropzone-subtitle">Upload multiple files at once. Auto-detects orientation and optimizes for web.</p>
                                    <div id="ppConvertToMp4Wrapper" class="u-text-sm u-muted u-mt-1" style="display:none;">
                                        <label class="u-flex u-center u-gap-1" style="cursor:pointer; user-select:none;">
                                            <input id="ppConvertToMp4" type="checkbox" checked />
                                            Convert to MP4 (applies rotation/trim)
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <div class="pp-upload-actions">
                                        <input id="ppFileInput" class="pp-hidden-file-input" type="file" accept="image/*,video/*" />
                                        <input id="ppCameraPhotoInput" class="pp-hidden-file-input" type="file" accept="image/*" capture="environment" />
                                        <input id="ppCameraVideoInput" class="pp-hidden-file-input" type="file" accept="video/*" capture="environment" />
                                        <div class="pp-mobile-capture-actions" aria-label="Add media">
                                            <label class="pp-upload-chip" for="ppFileInput">Choose</label>
                                            <label class="pp-upload-chip" for="ppCameraPhotoInput">Photo</label>
                                            <label class="pp-upload-chip" for="ppCameraVideoInput">Video</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <input id="ppReplaceFileInput" type="file" accept="image/*,video/*" style="display:none;" />

                            <!-- Upload progress -->
                            <div id="ppUploadProgress" class="u-mt-2" style="display:none;">
                                <div style="background:#f1f5f9;border-radius:8px;height:4px;overflow:hidden;">
                                    <div id="ppUploadProgressBar" style="background:linear-gradient(90deg,#3b82f6,#2563eb);height:100%;width:0%;transition:width 0.3s ease;"></div>
                                </div>
                                <div class="u-text-xs u-muted u-mt-1" id="ppUploadProgressText" style="text-align:center;"></div>
                            </div>

                            <!-- File preview thumbnails -->
                            <div id="ppFilePreviews" class="u-mt-2" style="display:none;">
                                <div style="display:flex;gap:8px;flex-wrap:wrap;" id="ppPreviewGrid"></div>
                            </div>

                            <div class="u-text-sm u-muted u-mt-2" id="ppCoverageStatus"></div>
                            <div class="u-text-caption u-muted u-mt-1" id="ppCoverageHint"></div>

                            <!-- File summary and preview -->
                            <div id="ppFileSummary" class="card u-mt-3 u-p-4 is-hidden"></div>
                            
                            <!-- Quick Filters Panel -->
                            <div id="ppQuickFilters" class="card u-mt-3 u-p-3" style="display:none;background:#f8fafc;border:1px solid #e2e8f0;">
                                <div class="u-flex u-between u-center u-mb-2">
                                    <div class="u-text-sm" style="font-weight:600;color:#334155;">Quick Polish</div>
                                    <button onclick="proofPacks.resetFilters()" class="u-text-xs" style="background:none;border:none;color:#64748b;cursor:pointer;padding:4px 8px;">Reset</button>
                                </div>
                                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;">
                                    <div>
                                        <label class="u-text-xs u-muted" style="display:block;margin-bottom:4px;">Style</label>
                                        <select id="ppFilterPreset" class="form-select" style="font-size:13px;padding:6px 8px;">
                                            <option value="none">Original</option>
                                            <option value="bw">Black & White</option>
                                            <option value="warm">Warm Tint</option>
                                            <option value="cool">Cool Tint</option>
                                            <option value="vibrant">Vibrant</option>
                                            <option value="muted">Muted</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="u-text-xs u-muted" style="display:block;margin-bottom:4px;">Brightness</label>
                                        <input id="ppFilterBrightness" type="range" min="70" max="130" value="100" step="5" style="width:100%;" />
                                        <div class="u-text-xs u-muted" style="text-align:center;margin-top:2px;" id="ppFilterBrightnessVal">100%</div>
                                    </div>
                                    <div>
                                        <label class="u-text-xs u-muted" style="display:block;margin-bottom:4px;">Contrast</label>
                                        <input id="ppFilterContrast" type="range" min="80" max="120" value="100" step="5" style="width:100%;" />
                                        <div class="u-text-xs u-muted" style="text-align:center;margin-top:2px;" id="ppFilterContrastVal">100%</div>
                                    </div>
                                    <div>
                                        <label class="u-text-xs u-muted" style="display:block;margin-bottom:4px;">Saturation</label>
                                        <input id="ppFilterSaturation" type="range" min="80" max="120" value="100" step="5" style="width:100%;" />
                                        <div class="u-text-xs u-muted" style="text-align:center;margin-top:2px;" id="ppFilterSaturationVal">100%</div>
                                    </div>
                                </div>
                                <div class="u-text-xs u-muted u-mt-2" style="text-align:center;">
                                    <label style="cursor:pointer;">
                                        <input type="checkbox" id="ppApplyFilterToAll" style="margin-right:4px;" />
                                        Apply to all uploads in this session
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Hidden fields for backend compatibility -->
                            <input type="hidden" id="ppShotType" value="after" />
                            <div id="ppShotTypeHint" class="u-text-xs u-muted" style="margin-top:4px; padding:6px 10px; background:#f8fafc; border-left:3px solid #3b82f6; border-radius:4px; display:none;"></div>
                            <input type="hidden" id="ppTimeOfDay" value="day" />
                            <input type="hidden" id="ppSlotKey" value="mid_proof_rail" />
                            <input type="hidden" id="ppForceKind" value="" />
                            <input type="hidden" id="ppVideoRotate" value="0" />
                            <input type="hidden" id="ppTrimStartSec" value="" />
                            <input type="hidden" id="ppTrimEndSec" value="" />
                            <input type="hidden" id="ppFilterBw" value="0" />
                            <input type="hidden" id="ppFilterPresetVal" value="none" />
                            <input type="hidden" id="ppFilterBrightnessVal" value="100" />
                            <input type="hidden" id="ppFilterContrastVal" value="100" />
                            <input type="hidden" id="ppFilterSaturationVal" value="100" />

                            <!-- Upload action -->
                            <div class="button-group u-mt-3 u-flex u-wrap u-center u-gap-1">
                                <button onclick="proofPacks.uploadAndAssign()" class="btn btn-primary" id="ppUploadBtn" style="min-width:120px;transition:all 0.2s ease;">Upload</button>
                                <span id="ppUploadStatus" class="u-text-sm u-muted" style="transition:opacity 0.2s ease;"></span>
                            </div>
                            <div id="ppUploadWarning" class="u-text-sm" style="margin-top:8px;opacity:0;transition:opacity 0.3s ease;"></div>
                            <div id="ppDetectedKind" style="display:none;">Detected: -</div>

                            <div class="u-mt-3">
                                <div class="meter" id="ppCoverageVideoMeter">
                                    <div class="meter-label">
                                        <span>Video library</span>
                                        <span class="u-text-caption u-muted" id="ppCoverageVideoLabel">Target: 12</span>
                                    </div>
                                    <div class="meter-track" id="ppCoverageVideoTrack"></div>
                                </div>

                                <div class="meter u-mt-2">
                                    <div class="meter-label">
                                        <span>Photo library</span>
                                        <span class="u-text-caption u-muted" id="ppCoveragePhotoLabel">Target: 10</span>
                                    </div>
                                    <div class="meter-track is-ten" id="ppCoveragePhotoTrack"></div>
                                </div>

                                <div class="u-text-sm u-muted u-mt-2" id="ppMixGoals"></div>
                            </div>
                        </div>

                        </div> <!-- /ppUploadWorkspace -->

                        <div id="ppLibraryWorkspace" class="u-mt-3" style="display:none;">
                            <!-- Live Preview Section -->
                            <div id="ppLivePreview" class="pp-live-preview" style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:20px;margin-bottom:20px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                                    <div>
                                        <h3 style="font-size:16px;font-weight:600;color:#0f172a;margin:0;">Live on Bundles Page</h3>
                                        <p style="font-size:13px;color:#64748b;margin:4px 0 0;">Click any tile to edit or replace</p>
                                    </div>
                                </div>
                                <div id="ppLivePreviewContent" style="min-height:120px;">
                                    <div style="text-align:center;padding:40px;color:#94a3b8;">
                                        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1" viewBox="0 0 24 24" style="margin:0 auto 12px;opacity:0.5;"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                        <div>Loading live content...</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Modal Overlay Editor -->
                            <div id="ppLibraryEditor" class="pp-editor-modal is-hidden">
                                <div class="pp-editor-modal-backdrop" onclick="proofPacks.cancelEdit()"></div>
                                <div class="pp-editor-modal-content">
                                    <div class="pp-editor-modal-header">
                                        <div>
                                            <div class="card-header u-mb-1">Editor</div>
                                            <div class="u-text-sm u-muted" id="ppEditorSub">Select an asset in the library to edit.</div>
                                        </div>
                                        <div class="u-flex u-center u-wrap u-gap-1">
                                            <div id="ppEditorStatusBar" class="pp-editor-status-bar" data-state="idle">
                                                <svg class="pp-status-icon" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                    <circle cx="8" cy="8" r="7"/>
                                                </svg>
                                                <span class="pp-status-text" id="ppEditorStatus">Ready</span>
                                            </div>
                                            <button id="ppCloseEditor" class="btn btn-secondary" type="button">Close</button>
                                        </div>
                                    </div>
                                    <div class="pp-editor-modal-body" id="ppLibraryEditorBody"></div>
                                </div>
                            </div>

                            <div class="pp-library-header">
                                <div>
                                    <div class="pp-library-title">Proof Library</div>
                                    <div class="pp-library-subtitle" id="ppAssetsHint">Browse and manage all proof assets.</div>
                                </div>
                                
                                <div class="pp-stats-row">
                                    <!-- Total Assets -->
                                    <div class="pp-stat-card">
                                        <div class="pp-stat-icon">
                                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                        </div>
                                        <div class="pp-stat-content">
                                            <div class="pp-stat-value" id="ppAssetsCount">-</div>
                                            <div class="pp-stat-label">Total Assets</div>
                                        </div>
                                    </div>

                                    <!-- Video Key Stats -->
                                    <div class="pp-stat-card">
                                        <div class="pp-stat-icon">
                                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                                        </div>
                                        <div class="pp-stat-content">
                                            <div class="pp-stat-value" id="ppVideoStats">-</div>
                                            <div class="pp-stat-label">Videos</div>
                                        </div>
                                    </div>

                                    <!-- Photo Key Stats -->
                                    <div class="pp-stat-card">
                                        <div class="pp-stat-icon">
                                            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                                        </div>
                                        <div class="pp-stat-content">
                                            <div class="pp-stat-value" id="ppPhotoStats">-</div>
                                            <div class="pp-stat-label">Photos</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="pp-stat-label u-mt-2" id="ppAssetsStatus"></div>
                                <!-- Retired Legacy Summary: id="ppLibrarySummary" -->
                            </div>
                                
                                <!-- Batch Operations Toolbar -->
                                <div class="pp-batch-toolbar" id="ppBatchToolbar" data-batch-mode="false">
                                    <div class="pp-batch-info">
                                        <span class="pp-batch-count" id="ppBatchCount">0 selected</span>
                                        <button class="pp-btn-secondary-sm" onclick="proofPacks.clearSelection()">Clear</button>
                                    </div>
                                    <div class="pp-batch-actions">
                                        <select id="ppBatchIntent" aria-label="Set tag">
                                            <option value="working_shot">Working Shot</option>
                                            <option value="action_proof">Action Proof</option>
                                            <option value="result_proof">Result Proof</option>
                                            <option value="">Unclassified</option>
                                        </select>
                                        <button onclick="proofPacks.batchSetIntent()">Set Tag</button>
                                        <button onclick="proofPacks.batchRotate(90)">Rotate 90&deg;</button>
                                        <button onclick="proofPacks.batchToggleVisibility()">Toggle Visibility</button>
                                        <button class="pp-btn-destructive" onclick="proofPacks.batchDelete()">Delete Selected</button>
                                    </div>
                                </div>
                                
                                <!-- Modern Search & Filter Toolbar -->
                                <div class="pp-toolbar-card" id="ppLibraryFilters">
                                    <!-- Row 1: Search -->
                                    <div class="pp-search-group">
                                        <svg class="pp-search-icon" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                        </svg>
                                        <input type="text" class="pp-search-input" placeholder="Search assets..." oninput="proofPacks.filterLibrary(this.value)">
                                    </div>
                                    
                                    <!-- Row 2: Filters -->
                                    <div class="pp-filters-row" id="ppFilterChips">
                                        <!-- Service Group -->
                                        <!-- Live Status Group -->
                                        <div class="pp-filter-group">
                                            <div class="pp-filter-label">Status</div>
                                            <div class="pp-filter-options">
                                                <button class="pp-pill active" data-filter="live:all" onclick="proofPacks.toggleFilter('live', 'all', this)">All Assets</button>
                                                <button class="pp-pill" data-filter="live:yes" onclick="proofPacks.toggleFilter('live', 'yes', this)">Live Only</button>
                                                <button class="pp-pill" data-filter="live:no" onclick="proofPacks.toggleFilter('live', 'no', this)">Unused Only</button>
                                            </div>
                                        </div>

                                        <div class="pp-filter-group">
                                            <div class="pp-filter-label">Service</div>
                                            <div class="pp-filter-options">
                                                <button class="pp-pill active" data-filter="service:all" onclick="proofPacks.toggleFilter('service', 'all', this)">All Services</button>
                                                <button class="pp-pill" data-filter="service:tv_mounting" onclick="proofPacks.toggleFilter('service', 'tv_mounting', this)">TV Mounting</button>
                                                <button class="pp-pill" data-filter="service:cameras" onclick="proofPacks.toggleFilter('service', 'cameras', this)">Cameras</button>
                                            </div>
                                        </div>

                                        <!-- Media Group -->
                                        <div class="pp-filter-group">
                                            <div class="pp-filter-label">Media Type</div>
                                            <div class="pp-filter-options">
                                                <button class="pp-pill active" data-filter="media:all" onclick="proofPacks.toggleFilter('media', 'all', this)">All</button>
                                                <button class="pp-pill" data-filter="media:video" onclick="proofPacks.toggleFilter('media', 'video', this)">Videos</button>
                                                <button class="pp-pill" data-filter="media:photo" onclick="proofPacks.toggleFilter('media', 'photo', this)">Photos</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Row 3: Controls -->
                                    <div class="pp-controls-row">
                                        <!-- Sort Dropdown (Custom Style) -->
                                        <div class="pp-select-wrapper">
                                            <select class="pp-select-custom" onchange="proofPacks.sortLibrary(this.value)">
                                                <option value="date-desc">Newest First</option>
                                                <option value="date-asc">Oldest First</option>
                                            </select>
                                        </div>
                                        
                                        <!-- View Toggles & Count -->
                                        <div class="pp-view-group">
                                            <span class="pp-asset-count-label" id="ppFilterCount">20 of 20</span>
                                            
                                            <div class="pp-view-toggles">
                                                <button class="pp-view-btn active" data-view="list" onclick="proofPacks.setViewMode('list', this)" title="List View">
                                                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/></svg>
                                                </button>
                                                <button class="pp-view-btn" data-view="grid" onclick="proofPacks.setViewMode('grid', this)" title="Grid View">
                                                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Hidden legacy anchor that might be referenced by JS -->
                                <div id="ppAssetFilterTabs" style="display:none;"></div>
                                <!-- List View (default) -->
                                <div class="asset-list u-mt-2" id="ppAssetsList"></div>
                                
                                <!-- Grid View (hidden by default) -->
                                <div class="pp-library-grid u-mt-2" id="ppAssetsGrid" style="display:none;"></div>
                            </div>
                        </div>

                        <!-- Settings (collapsible) -->
                        <div class="collapse u-mt-3">
                            <button class="collapse-toggle" id="ppSettingsToggle" aria-expanded="false" onclick="proofPacks.toggleCollapse('ppSettingsBody','ppSettingsToggle')">
                                <div class="collapse-title">
                                    <span>Settings</span>
                                    <span class="u-text-sm u-muted">Backend connection</span>
                                </div>
                                <span class="collapse-chevron">&gt;</span>
                            </button>
                            <div class="collapse-body" id="ppSettingsBody">
                                <div class="collapse-inner">
                                    <div class="form-field">
                                        <label class="form-label" for="ppBackendUrl">Backend URL</label>
                                        <input id="ppBackendUrl" class="form-input" placeholder="https://h2s-backend.vercel.app" />
                                        <span class="form-help">Where the Proof Packs API is hosted.</span>
                                    </div>
                                    <div class="form-field u-mt-2">
                                        <label class="form-label" for="ppAdminKey">Admin key (optional)</label>
                                        <input id="ppAdminKey" class="form-input" type="password" placeholder="Only needed if uploads fail with Unauthorized" />
                                    </div>
                                    <div class="button-group u-mt-2 u-flex u-wrap u-end u-center u-gap-1">
                                        <button onclick="proofPacks.saveConfig()" class="btn btn-secondary">Save</button>
                                        <span id="ppConnStatus" class="u-text-sm u-muted"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OFFER BUILDER PANE -->
                <!-- 
                    DIAGNOSTIC: Pane Root Identification
                    ====================================
                    All pane roots use class="pane" with id="{tabname}-pane"
                    Tab switching: switchToTab() function hides ALL panes (display:none), then shows only target pane (display:block + .active class)
                    Pane roots found:
                    - #screening-pane, #techinterview-pane, #hours-pane, #reports-pane, #training-pane
                    - #deliverables-pane, #tasks-pane, #admin-pane, #offerbuilder-pane
                    Each pane is completely isolated - no shared DOM or event listeners between panes.
                    CSS scoping: All Offer Builder styles must be scoped to #offerbuilder-pane to prevent cross-tab bleed.
                -->
                <div class="pane" id="offerbuilder-pane" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background: var(--surface-2); padding-top: 24px;">
                    <div class="ob-container">
                        <div class="ob-header">
                            <div>
                                <h2 class="ob-title">Build Your Offer</h2>
                                <p class="ob-subtitle">Create service packages and bundles. Add services, set pricing, and generate a complete offer brief.</p>
                            </div>
                            <div class="ob-actions">
                                <button onclick="offerBuilder.showHelp()" class="ob-btn ob-btn--secondary ob-btn--icon" title="How to use" aria-label="How to use">
                                    ?
                                </button>
                                <button onclick="offerBuilder.recalculateOffer()" id="offerBuilderRecalcBtn" class="ob-btn ob-btn--secondary">
                                    Recalculate
                                </button>
                                <span id="offerBuilderLastUpdate" style="display: none;"></span>
                                <button onclick="offerBuilder.saveOffer()" id="offerBuilderSaveBtn" class="ob-btn ob-btn--primary">
                                    Save Offer
                                </button>
                                <button onclick="offerBuilder.generateBrief()" id="offerBuilderGenerateBriefBtn" class="ob-btn ob-btn--secondary">
                                    Generate Brief
                                </button>
                                <button onclick="offerBuilder.markReady()" id="offerBuilderMarkReadyBtn" class="ob-btn ob-btn--success" style="display: none;">
                                    Mark Ready
                                </button>
                                <button onclick="offerBuilder.generateSampleOffer()" id="offerBuilderSampleBtn" class="ob-btn ob-btn--tertiary">
                                    Sample Offer
                                </button>
                            </div>
                        </div>

                        <div class="ob-workspace">
                        <!-- Build Order Strip -->
                        <div id="offerBuilderBuildOrder" class="ob-strip">
                            <div class="ob-stepper" aria-label="Offer build steps">
                                <div class="ob-stepper-header">
                                    <div class="ob-stepper-title" id="offerBuilderStepLabel">Step 1 of 5: Add Services</div>
                                    <button type="button" class="ob-btn ob-btn--secondary ob-btn--small" onclick="offerBuilder.goToNextStep()" id="offerBuilderStepNextBtn">Next</button>
                                </div>
                                <div class="ob-stepper-track">
                                    <button type="button" class="ob-step" id="obStepBtn1" onclick="offerBuilder.goToStep(1)">
                                        <span class="ob-step-circle" id="obStepCircle1">1</span>
                                        <span class="ob-step-label">Add Services</span>
                                    </button>
                                    <button type="button" class="ob-step" id="obStepBtn2" onclick="offerBuilder.goToStep(2)">
                                        <span class="ob-step-circle" id="obStepCircle2">2</span>
                                        <span class="ob-step-label">Choose Pricing</span>
                                    </button>
                                    <button type="button" class="ob-step" id="obStepBtn3" onclick="offerBuilder.goToStep(3)">
                                        <span class="ob-step-circle" id="obStepCircle3">3</span>
                                        <span class="ob-step-label">Fill Messaging</span>
                                    </button>
                                    <button type="button" class="ob-step" id="obStepBtn4" onclick="offerBuilder.goToStep(4)">
                                        <span class="ob-step-circle" id="obStepCircle4">4</span>
                                        <span class="ob-step-label">Review Standards</span>
                                    </button>
                                    <button type="button" class="ob-step" id="obStepBtn5" onclick="offerBuilder.goToStep(5)">
                                        <span class="ob-step-circle" id="obStepCircle5">5</span>
                                        <span class="ob-step-label">Generate Brief</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                    <!-- Main Content -->
                        
                        <!-- 2-COLUMN GRID LAYOUT -->
                        <div id="offerBuilderMainGrid" style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; align-items: start;">
                            
                            <!-- ========== LEFT COLUMN ========== -->
                            <div style="display: flex; flex-direction: column; gap: 20px; min-width: 0;">

                                <!-- Offer Details -->
                                <div class="ob-card" id="offerBuilderDetailsCard">
                                    <div class="ob-card-header">
                                        <div>
                                            <h3 class="ob-card-title">Offer Details</h3>
                                            <p class="ob-card-subtitle">Name + price (auto-calculates unless you override)</p>
                                        </div>
                                    </div>

                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px; align-items: start;">
                                        <div style="min-width: 0;">
                                            <label style="display: block; font-size: 13px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Offer Name <span style="color: #ef4444;">*</span></label>
                                            <input type="text" id="offerBuilderName" placeholder="e.g., Spring Security Bundle" oninput="offerBuilder.updateOfferName(this.value); offerBuilder.recalculateOffer();" style="width: 100%; height: 42px; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
                                            <div id="offerBuilderNameGuidance" style="font-size: 11px; color: #6b7280; margin-top: 6px; display: none;">Enter a clear, descriptive offer name</div>
                                            <div style="font-size: 11px; color: #64748b; margin-top: 6px; visibility: hidden;">Spacer</div>
                                        </div>

                                        <div style="min-width: 0;" id="offerBuilderPriceCard">
                                            <label style="display: block; font-size: 13px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Offer Price</label>
                                            <div style="position: relative;">
                                                <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; font-weight: 800; color: #9ca3af; pointer-events: none;">$</span>
                                                <input type="number" id="offerBuilderDirectPrice" min="0" step="0.01" placeholder="299.00" oninput="offerBuilder.handleDirectPriceInput(this.value)" onkeydown="if(event.key==='Enter'){ event.preventDefault(); offerBuilder.applyDirectPrice(); }" style="width: 100%; height: 42px; padding: 10px 12px 10px 30px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 16px; font-weight: 800; color: var(--cobalt); text-align: right; transition: all 0.2s;" onfocus="this.style.borderColor='var(--cobalt)'; this.style.boxShadow='0 0 0 3px rgba(10,42,90,0.1)'" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                                            </div>
                                            <div style="font-size: 11px; color: #64748b; margin-top: 6px;">Press Enter to set a fixed package price (optional).</div>
                                        </div>
                                    </div>
                                    
                                    <div id="offerBuilderPriceHelp" style="margin-top: 12px; padding: 12px; background: #f9fafb; border-radius: 6px; font-size: 11px; color: #6b7280; display: none;">
                                        <!-- Dynamic help text will appear here -->
                                    </div>
                                    
                                    <div id="offerBuilderCurrentPrice" style="margin-top: 12px; padding: 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; display: none;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 11px; color: #0369a1; margin-bottom: 2px;">Current Offer Price</div>
                                                <div id="offerBuilderCurrentPriceDisplay" style="font-size: 20px; font-weight: 700; color: var(--cobalt);">$0</div>
                                            </div>
                                            <button onclick="offerBuilder.clearOfferPrice()" style="padding: 6px 12px; background: white; color: #6b7280; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.borderColor='#ef4444'; this.style.color='#ef4444'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#6b7280'">
                                                Clear
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Line Items -->
                                <div class="ob-card" id="offerBuilderServicesCard">
                                    <div class="ob-card-header">
                                        <div>
                                            <h3 class="ob-card-title">What's Included</h3>
                                            <p class="ob-card-subtitle">Services in this offer</p>
                                        </div>
                                        <button onclick="offerBuilder.showAddServiceModal()" class="ob-btn ob-btn--primary" id="offerBuilderAddServiceBtn">
                                            + Add Service
                                        </button>
                                    </div>
                                    <div id="offerBuilderTipBanner" class="ob-info-banner" style="display: none; margin-bottom: 14px;">
                                        <strong>Tip:</strong> Bundle 2-3 services for better customer value and clearer messaging.
                                    </div>
                                    <div id="offerBuilderLineItems" style="display: flex; flex-direction: column; gap: 16px;"></div>
                                    <div id="offerBuilderEmptyState" class="ob-empty">
                                        <div class="ob-empty-icon" aria-hidden="true">+</div>
                                        <div class="ob-empty-title">No services added yet</div>
                                        <div class="ob-empty-subtitle">Build your offer by adding services and add-ons.</div>
                                        <button type="button" class="ob-btn ob-btn--primary" style="padding: 12px 22px; font-size: 14px;" onclick="offerBuilder.showAddServiceModal()">+ Add Your First Service</button>
                                    </div>
                                </div>

                                <!-- Pricing Strategy (Optional/Advanced) -->
                                <div class="ob-card" id="offerBuilderAdvancedOptionsCard">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; cursor: pointer;" onclick="offerBuilder.toggleSection('pricingStrategySection')">
                                        <div>
                                            <h3 style="font-size: 15px; font-weight: 700; color: var(--cobalt); margin: 0;">Advanced Options</h3>
                                            <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">Optional pricing calculations</p>
                                        </div>
                                        <span id="pricingStrategySectionToggle" style="font-size: 18px; color: var(--cobalt);">+</span>
                                    </div>
                                    <div id="pricingStrategySection" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 2px solid #e5e7eb;">
                                        <p style="font-size: 12px; color: #6b7280; margin: 0 0 16px 0;">Let the system calculate your offer price by adding up individual service prices. Most people just set the price above instead.</p>
                                        <div style="display: flex; flex-direction: column; gap: 12px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--cobalt)'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                            <input type="radio" name="offerBuilderPricingStrategy" value="sum" checked onchange="offerBuilder.updatePricingStrategy('sum')" style="cursor: pointer;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; color: var(--cobalt); font-weight: 600;">Regular Pricing</div>
                                                <div style="font-size: 11px; color: #6b7280;">Add up all service prices (no discount)</div>
                                            </div>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--cobalt)'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                            <input type="radio" name="offerBuilderPricingStrategy" value="percentOff" onchange="offerBuilder.updatePricingStrategy('percentOff')" style="cursor: pointer;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; color: var(--cobalt); font-weight: 600;">Percentage Discount</div>
                                                <div style="font-size: 11px; color: #6b7280;">Take a % off the total (e.g., "20% off")</div>
                                            </div>
                                        </label>
                                        <div id="offerBuilderPercentOffContainer" style="display: none; margin-left: 24px; margin-top: -4px; margin-bottom: 8px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <input type="number" id="offerBuilderPercentOff" min="0" max="100" step="1" placeholder="20" oninput="offerBuilder.recalculateOffer()" style="width: 100px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                                <span style="font-size: 14px; color: #374151; font-weight: 500;">% off</span>
                                            </div>
                        </div>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--cobalt)'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                            <input type="radio" name="offerBuilderPricingStrategy" value="dollarOff" onchange="offerBuilder.updatePricingStrategy('dollarOff')" style="cursor: pointer;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; color: var(--cobalt); font-weight: 600;">Dollar Discount</div>
                                                <div style="font-size: 11px; color: #6b7280;">Take a fixed amount off (e.g., "$50 off")</div>
                                            </div>
                                        </label>
                                        <div id="offerBuilderDollarOffContainer" style="display: none; margin-left: 24px; margin-top: -4px; margin-bottom: 8px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="font-size: 18px; color: #374151;">$</span>
                                                <input type="number" id="offerBuilderDollarOff" min="0" step="0.01" placeholder="50.00" oninput="offerBuilder.recalculateOffer()" style="width: 120px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                                <span style="font-size: 14px; color: #374151; font-weight: 500;">off total</span>
                                            </div>
                                        </div>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f9fafb'; this.style.borderColor='var(--cobalt)'" onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'">
                                            <input type="radio" name="offerBuilderPricingStrategy" value="bundlePrice" onchange="offerBuilder.updatePricingStrategy('bundlePrice')" style="cursor: pointer;">
                                            <div style="flex: 1;">
                                                <div style="font-size: 14px; color: var(--cobalt); font-weight: 600;">Fixed Package Price</div>
                                                <div style="font-size: 11px; color: #6b7280;">Set one price for everything (ignores individual prices)</div>
                                            </div>
                                        </label>
                                        <div id="offerBuilderBundlePriceContainer" style="display: none; margin-left: 24px; margin-top: -4px; margin-bottom: 8px; padding: 12px; background: #f9fafb; border-radius: 6px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="font-size: 18px; color: #374151;">$</span>
                                                <input type="number" id="offerBuilderBundlePrice" min="0" step="0.01" placeholder="299.00" oninput="offerBuilder.recalculateOffer()" style="width: 120px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                                                <span style="font-size: 14px; color: #374151; font-weight: 500;">total</span>
                                            </div>
                                        </div>
                        </div>
                    </div>

                                <!-- Offer Messaging Section (Collapsible) -->
                                <div class="ob-card" id="offerBuilderMessagingCard">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; cursor: pointer;" onclick="offerBuilder.toggleSection('offerMessagingSection')">
                                        <div>
                                            <h3 style="font-size: 15px; font-weight: 700; color: var(--cobalt); margin: 0;">Messaging & Details</h3>
                                            <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">Optional marketing content</p>
                                        </div>
                                        <span id="offerMessagingSectionToggle" style="font-size: 18px; color: var(--cobalt);">+</span>
                                    </div>
                                    <div id="offerMessagingSection" style="display: none;">
                                        <!-- Tab Navigation -->
                                        <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
                                            <button onclick="offerBuilder.switchMessagingTab('snapshot')" id="messagingTabSnapshot" style="padding: 8px 16px; background: var(--cobalt); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Snapshot</button>
                                            <button onclick="offerBuilder.switchMessagingTab('value')" id="messagingTabValue" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Value Equation</button>
                                            <button onclick="offerBuilder.switchMessagingTab('messaging')" id="messagingTabMessaging" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Messaging Pack</button>
                                            <button onclick="offerBuilder.switchMessagingTab('creative')" id="messagingTabCreative" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Creative Angles</button>
                                            <button onclick="offerBuilder.switchMessagingTab('ops')" id="messagingTabOps" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Ops Notes</button>
                                            <button onclick="offerBuilder.switchMessagingTab('decision')" id="messagingTabDecision" style="padding: 8px 16px; background: #f3f4f6; color: var(--cobalt); border: none; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">Decision Notes</button>
                                        </div>
                                        
                                        <!-- Tab Content: Snapshot -->
                                        <div id="messagingTabContentSnapshot" class="messaging-tab-content">
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Category <span style="color: #ef4444;">*</span></label>
                                                    <select id="offerBuilderCategory" onchange="offerBuilder.updateField('category', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                        <option value="">Select...</option>
                                                        <option value="TV Mount">TV Mount</option>
                                                        <option value="Cameras">Cameras</option>
                                                        <option value="Doorbell">Doorbell</option>
                                                        <option value="WiFi">WiFi</option>
                                                        <option value="Bundle">Bundle</option>
                                                        <option value="Other">Other</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Market <span style="color: #ef4444;">*</span></label>
                                                    <input type="text" id="offerBuilderMarket" placeholder="City/Zip or 'All'" oninput="offerBuilder.updateField('market', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Primary Avatar <span style="color: #ef4444;">*</span></label>
                                                    <select id="offerBuilderPrimaryAvatar" onchange="offerBuilder.updateField('primaryAvatar', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                        <option value="">Select...</option>
                                                        <option value="homeowner">Homeowner</option>
                                                        <option value="renter">Renter</option>
                                                        <option value="property manager">Property Manager</option>
                                                        <option value="small biz">Small Biz</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Intended Goal <span style="color: #ef4444;">*</span></label>
                                                    <select id="offerBuilderIntendedGoal" onchange="offerBuilder.updateField('intendedGoal', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                        <option value="">Select...</option>
                                                        <option value="bookings">Bookings</option>
                                                        <option value="AOV lift">AOV Lift</option>
                                                        <option value="bundle attach">Bundle Attach</option>
                                                        <option value="speed to cash">Speed to Cash</option>
                                                        <option value="lead volume">Lead Volume</option>
                                                    </select>
                        </div>
                    </div>

                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Headline (Ad-Ready) <span style="color: #ef4444;">*</span></label>
                                                <input type="text" id="offerBuilderHeadline" placeholder="e.g., Get Your TV Mounted in 24 Hours" oninput="offerBuilder.updateField('headline', this.value); offerBuilder.validateHeadline(this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                <div id="offerBuilderHeadlineGuardrail" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: none;"></div>
                        </div>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">1-Sentence Promise <span style="color: #ef4444;">*</span></label>
                                                <input type="text" id="offerBuilderOneSentencePromise" placeholder="e.g., Professional installation in under 2 hours, guaranteed." oninput="offerBuilder.updateField('oneSentencePromise', this.value); offerBuilder.validatePromise(this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                <div id="offerBuilderPromiseGuardrail" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: none;"></div>
                        </div>
                                            
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Offer Start Date</label>
                                                    <input type="date" id="offerBuilderOfferStartDate" onchange="offerBuilder.updateField('offerStartDate', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                    </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Offer End Date</label>
                                                    <input type="date" id="offerBuilderOfferEndDate" onchange="offerBuilder.updateField('offerEndDate', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                </div>
            </div>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Scarcity Mechanism</label>
                                                <select id="offerBuilderScarcityMechanism" onchange="offerBuilder.updateField('scarcityMechanism', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                    <option value="">Select...</option>
                                                    <option value="deadline">Deadline</option>
                                                    <option value="limited slots">Limited Slots</option>
                                                    <option value="limited bundles">Limited Bundles</option>
                                                    <option value="price ends">Price Ends</option>
                                                </select>
        </div>
                                            
                                            <div style="margin-bottom: 16px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Risk Reversal</label>
                                                <textarea id="offerBuilderRiskReversal" placeholder="Warranty, guarantee, redo policy, etc." oninput="offerBuilder.updateField('riskReversal', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            
                                            <div style="border-top: 2px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
                                                <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px;">The Deal</h4>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">What's Included</label>
                                                    <textarea id="offerBuilderWhatsIncluded" placeholder="Exact services and items included" oninput="offerBuilder.updateField('whatsIncluded', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">What's Not Included / Upcharges</label>
                                                    <textarea id="offerBuilderWhatsNotIncluded" placeholder="Exclusions, additional costs, upcharges" oninput="offerBuilder.updateField('whatsNotIncluded', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Eligibility Rules</label>
                                                    <textarea id="offerBuilderEligibilityRules" placeholder="Distance, wall type, height, existing wiring limits, etc." oninput="offerBuilder.updateField('eligibilityRules', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Redemption Rules</label>
                                                    <textarea id="offerBuilderRedemptionRules" placeholder="Online only, booking link, promo code, etc." oninput="offerBuilder.updateField('redemptionRules', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Value Equation -->
                                        <div id="messagingTabContentValue" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Dream Outcome</label>
                                                <textarea id="offerBuilderDreamOutcome" placeholder="What result does the customer get?" oninput="offerBuilder.updateField('dreamOutcome', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Likelihood of Achievement (Proof, Process, Guarantees)</label>
                                                <textarea id="offerBuilderLikelihoodOfAchievement" placeholder="Why will this work? Proof, process, guarantees" oninput="offerBuilder.updateField('likelihoodOfAchievement', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Time Delay (How Fast They Get Results)</label>
                                                <input type="text" id="offerBuilderTimeDelay" placeholder="e.g., Same day, 24 hours, 2 hours" oninput="offerBuilder.updateField('timeDelay', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Effort + Sacrifice (What You Remove/Simplify)</label>
                                                <textarea id="offerBuilderEffortSacrifice" placeholder="What do you handle for them? What complexity do you remove?" oninput="offerBuilder.updateField('effortSacrifice', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            
                                            <div style="border-top: 2px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
                                                <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px;">Competitor Reality Check</h4>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Competitor Price Range Found</label>
                                                    <input type="text" id="offerBuilderCompetitorPriceRange" placeholder="e.g., $200-$400" oninput="offerBuilder.updateField('competitorPriceRange', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                </div>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">How We're Different (Not Cheaper, Better)</label>
                                                    <textarea id="offerBuilderHowWereDifferent" placeholder="What makes us better, not just cheaper?" oninput="offerBuilder.updateField('howWereDifferent', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Why Someone Chooses Us Even If Not Lowest Price</label>
                                                    <textarea id="offerBuilderWhyChooseUs" placeholder="Value proposition beyond price" oninput="offerBuilder.updateField('whyChooseUs', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Messaging Pack -->
                                        <div id="messagingTabContentMessaging" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Booking Page Microcopy (2-4 lines)</label>
                                                <textarea id="offerBuilderBookingPageMicrocopy" placeholder="Short copy for booking page" oninput="offerBuilder.updateField('bookingPageMicrocopy', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">SMS Confirmation Copy</label>
                                                <textarea id="offerBuilderSmsConfirmation" placeholder="SMS sent after booking" oninput="offerBuilder.updateField('smsConfirmation', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">SMS Reminder (24h)</label>
                                                <textarea id="offerBuilderSmsReminder24h" placeholder="SMS reminder 24h before" oninput="offerBuilder.updateField('smsReminder24h', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">If Customer Asks About Price Line</label>
                                                <textarea id="offerBuilderPriceQuestionLine" placeholder="Response to price questions" oninput="offerBuilder.updateField('priceQuestionLine', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Tech Broadcast Message</label>
                                                <textarea id="offerBuilderTechBroadcastMessage" placeholder="Message to techs about this offer" oninput="offerBuilder.updateField('techBroadcastMessage', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Creative Angles -->
                                        <div id="messagingTabContentCreative" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">5 Hooks (one per line, keep short)</label>
                                                <textarea id="offerBuilderHooks" placeholder="Hook 1&#10;Hook 2&#10;Hook 3&#10;Hook 4&#10;Hook 5" oninput="offerBuilder.updateField('hooks', this.value.split('\\n').filter(h => h.trim())); offerBuilder.validateHooks(this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 100px; resize: vertical;"></textarea>
                                                <div id="offerBuilderHooksGuardrail" style="font-size: 11px; color: #6b7280; margin-top: 4px; display: none;"></div>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">3 Primary Objections + Rebuttal (one per line)</label>
                                                <textarea id="offerBuilderObjectionsRebuttals" placeholder="Objection 1 + Rebuttal&#10;Objection 2 + Rebuttal&#10;Objection 3 + Rebuttal" oninput="offerBuilder.updateField('objectionsRebuttals', this.value.split('\\n').filter(o => o.trim())); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;"></textarea>
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">3 Proof Ideas (one per line)</label>
                                                <textarea id="offerBuilderProofIdeas" placeholder="Proof idea 1&#10;Proof idea 2&#10;Proof idea 3" oninput="offerBuilder.updateField('proofIdeas', this.value.split('\\n').filter(p => p.trim())); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;"></textarea>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Ops Notes -->
                                        <div id="messagingTabContentOps" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">What to Say In-Home (one per line)</label>
                                                <textarea id="offerBuilderWhatToSayInHome" placeholder="Point 1&#10;Point 2&#10;Point 3" oninput="offerBuilder.updateField('whatToSayInHome', this.value.split('\\n').filter(s => s.trim())); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Special Instructions</label>
                                                <textarea id="offerBuilderSpecialInstructions" placeholder="Photos, checklist, upsell rules, do-not-do" oninput="offerBuilder.updateField('specialInstructions', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Capacity Assumption</label>
                                                <input type="text" id="offerBuilderCapacityAssumption" placeholder="e.g., 3 jobs/day" oninput="offerBuilder.updateField('capacityAssumption', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                            </div>
                                            <div>
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Cancellation Risks</label>
                                                <textarea id="offerBuilderCancellationRisks" placeholder="What could cause cancellations or reschedules?" oninput="offerBuilder.updateField('cancellationRisks', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            
                                            <div style="border-top: 2px solid #e5e7eb; padding-top: 16px; margin-top: 16px;">
                                                <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px;">Unit Economics Notes</h4>
                                                <div style="margin-bottom: 12px;">
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Where Can This Break (Edge Cases That Destroy Margin)</label>
                                                    <textarea id="offerBuilderMarginBreakPoints" placeholder="Edge cases, risks to margin" oninput="offerBuilder.updateField('marginBreakPoints', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Safeguards to Prevent Margin Bleed</label>
                                                    <textarea id="offerBuilderSafeguards" placeholder="How to protect margin" oninput="offerBuilder.updateField('safeguards', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Content: Decision Notes -->
                                        <div id="messagingTabContentDecision" class="messaging-tab-content" style="display: none;">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Best-Case Outcome If This Works</label>
                                                <textarea id="offerBuilderBestCaseOutcome" placeholder="What's the best possible result?" oninput="offerBuilder.updateField('bestCaseOutcome', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Worst-Case Risk If This Fails</label>
                                                <textarea id="offerBuilderWorstCaseRisk" placeholder="What could go wrong?" oninput="offerBuilder.updateField('worstCaseRisk', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;"></textarea>
                                            </div>
                                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Confidence Score (1-10)</label>
                                                    <input type="number" id="offerBuilderConfidenceScore" min="1" max="10" step="1" placeholder="1-10" oninput="offerBuilder.updateField('confidenceScore', parseInt(this.value) || 0); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                </div>
                                                <div>
                                                    <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Why</label>
                                                    <input type="text" id="offerBuilderConfidenceWhy" placeholder="Why this score?" oninput="offerBuilder.updateField('confidenceWhy', this.value); offerBuilder.recalculateOffer();" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ========== RIGHT COLUMN ========== -->
                            <div id="offerBuilderRightColumn" style="display: flex; flex-direction: column; gap: 16px; position: relative; min-width: 0;">
                                
                                <!-- Standards Panel -->
                                <div id="offerBuilderStandards" class="ob-card" style="padding: 20px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">Standards Check</h3>
                                    <div id="offerBuilderStandardsContent">
                                        <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 12px;">
                                            Fill in details to check standards
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Offer Totals -->
                                <div id="offerBuilderTotals" class="ob-card" style="padding: 20px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px;">Pricing Breakdown</h3>
                                    <div id="offerBuilderResults">
                                        <div style="text-align: center; padding: 24px 16px; color: #9ca3af; font-size: 12px;">
                                            Add services to see totals
                                        </div>
                                    </div>
                                    <div id="offerBuilderWarnings" style="margin-top: 12px;"></div>
                                </div>

                                <!-- Insights & Suggestions (preview always visible) -->
                                <div class="ob-card" style="padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;" onclick="offerBuilder.toggleSection('offerBuilderInsights')">
                                        <div>
                                            <h3 style="font-size: 14px; font-weight: 800; color: var(--cobalt); margin: 0;">Insights & Suggestions</h3>
                                            <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">Quick tips + optional data</p>
                                        </div>
                                        <span id="offerBuilderInsightsToggle" style="font-size: 18px; color: var(--cobalt);">+</span>
                                    </div>
                                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; margin-bottom: 10px;">
                                        <div style="font-size: 12px; font-weight: 900; color: #0f172a; margin-bottom: 6px;">Preview</div>
                                        <div style="font-size: 12px; color: #475569; line-height: 1.5;">Bundle 3+ services to increase perceived value. Keep the offer name outcome-driven and time-bound.</div>
                                        <button type="button" class="ob-btn ob-btn--secondary ob-btn--small" style="margin-top: 10px;" onclick="offerBuilder.toggleSection('offerBuilderInsights')">See all insights</button>
                                    </div>
                                    <div id="offerBuilderInsights" style="display: none;">
                                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px; line-height: 1.6;">Get suggestions based on successful past offers and performance data.</p>

                                        <!-- Loading state -->
                                        <div id="offerBuilderInsightsLoading" style="display: none; padding: 32px; text-align: center;">
                                            <div style="width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top-color: var(--cobalt); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px;"></div>
                                            <p style="font-size: 13px; color: #6b7280; margin: 0;">Loading insights...</p>
                                        </div>

                                        <!-- Insights content -->
                                        <div id="offerBuilderInsightsContent" style="display: none;"></div>

                                        <!-- Empty state -->
                                        <div id="offerBuilderInsightsEmpty" style="display: none; padding: 24px; text-align: center; background: #f9fafb; border-radius: 8px; border: 1px dashed #e5e7eb;">
                                            <div style="font-size: 16px; margin-bottom: 8px; font-weight: 800; color: var(--cobalt);">Info</div>
                                            <p style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 8px 0;">No insights available yet</p>
                                            <p style="font-size: 12px; color: #6b7280; margin: 0;">As more offers are deployed and tracked, insights will appear here.</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Performance Feedback (preview always visible) -->
                                <div class="ob-card" style="padding: 20px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;" onclick="offerBuilder.toggleSection('offerBuilderPerformanceFeedback')">
                                        <div>
                                            <h3 style="font-size: 14px; font-weight: 800; color: var(--cobalt); margin: 0;">How This Offer Is Performing</h3>
                                            <p style="font-size: 11px; color: #6b7280; margin: 4px 0 0 0;">Metrics appear after deployment</p>
                                        </div>
                                        <span id="offerBuilderPerformanceFeedbackToggle" style="font-size: 18px; color: var(--cobalt);">+</span>
                                    </div>
                                    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; margin-bottom: 10px;">
                                        <div style="font-size: 12px; font-weight: 900; color: #0f172a; margin-bottom: 6px;">Preview</div>
                                        <div style="font-size: 12px; color: #475569; line-height: 1.5;">Save the offer and deploy it to start seeing page views and conversions. Tracking updates automatically once campaigns run.</div>
                                        <button type="button" class="ob-btn ob-btn--secondary ob-btn--small" style="margin-top: 10px;" onclick="offerBuilder.toggleSection('offerBuilderPerformanceFeedback')">View metrics</button>
                                    </div>
                                    <div id="offerBuilderPerformanceFeedback" style="display: none;">
                                        <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px; line-height: 1.6;">Light performance indicators based on campaign tracking. Data updates automatically as campaigns run.</p>

                                        <!-- Loading state -->
                                        <div id="offerBuilderPerformanceLoading" style="display: none; padding: 32px; text-align: center;">
                                            <div style="width: 32px; height: 32px; border: 3px solid #e5e7eb; border-top-color: var(--cobalt); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px;"></div>
                                            <p style="font-size: 13px; color: #6b7280; margin: 0;">Loading performance data...</p>
                                        </div>

                                        <!-- Performance summary -->
                                        <div id="offerBuilderPerformanceSummary" style="display: none;"></div>

                                        <!-- Empty state -->
                                        <div id="offerBuilderPerformanceEmpty" style="display: none; padding: 24px; text-align: center; background: #f9fafb; border-radius: 8px; border: 1px dashed #e5e7eb;">
                                            <div style="font-size: 16px; margin-bottom: 8px; font-weight: 800; color: var(--cobalt);">Stats</div>
                                            <p style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 8px 0;">No performance data yet</p>
                                            <p style="font-size: 12px; color: #6b7280; margin: 0;">Once this offer is deployed and campaigns are running, performance metrics will appear here.</p>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                            <!-- END RIGHT COLUMN -->
                            
                        </div>
                        <!-- END GRID -->
                        

                        
                    </div>
                    </div>
                    <!-- End offer builder workspace -->
                </div>
            </div>
        </div>

        <!-- Training Completion Modal -->
        <div id="completionModal" class="completion-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.60); z-index: 10000; align-items: center; justify-content: center;">
            <div class="completion-modal-content" style="background: #ffffff; border-radius: 16px; max-width: 820px; width: 94%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(10,42,90,0.30);">
                <div style="padding: 20px 24px; border-bottom: 1px solid rgba(10,42,90,0.12); background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%); position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); animation: shimmer 2s infinite;"></div>
                    <h3 style="color: #ffffff; font-size: 20px; font-weight: 900; margin: 0; position: relative; z-index: 1;" id="completionModalTitle">Training Completion Report</h3>
                    <p style="color: rgba(255,255,255,0.85); font-size: 13px; margin: 6px 0 0; position: relative; z-index: 1;">Detailed responses build your knowledge profile and unlock better recommendations.</p>
                </div>
                <div style="padding: 20px 24px;">
                    <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-left: 3px solid #0a2a5a; border-radius: 8px;">
                        <label style="display: block; font-weight: 900; color: #0a2a5a; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">1. What specific concept, tool, or process did you learn?</label>
                        <textarea id="conceptLearned" placeholder="Example: Learned how to build multi-step email automation in GoHighLevel. The process includes: 1) Create workflow in Automation tab, 2) Set up trigger (form submission or tag added), 3) Add email actions with delays between them, 4) Use merge fields for personalization, 5) Set up A/B testing for subject lines." style="width: 100%; min-height: 110px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#0a2a5a'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                        <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;"><strong>Be specific:</strong> Name the tool/feature, list the steps, mention settings or configurations.</p>
                    </div>
                    <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-left: 3px solid #0a2a5a; border-radius: 8px;">
                        <label style="display: block; font-weight: 900; color: #0a2a5a; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">2. How will you apply this to client work or internal operations?</label>
                        <textarea id="practicalApplication" placeholder="Example: Will use this to set up automated lead nurture sequences for HVAC clients. When a lead fills out ''Free Quote'' form, they''ll get: Day 1 = Welcome + service overview, Day 3 = Customer testimonials, Day 5 = Limited-time discount offer. This replaces manual follow-up emails and ensures no leads fall through cracks." style="width: 100%; min-height: 110px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#0a2a5a'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                        <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;"><strong>Real scenarios:</strong> Which client? What problem does it solve? What''s the outcome?</p>
                    </div>
                    <div style="margin-bottom: 20px; padding: 16px; background: #f8fafc; border-left: 3px solid #0a2a5a; border-radius: 8px;">
                        <label style="display: block; font-weight: 900; color: #0a2a5a; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">3. What''s your next action or what will change in your workflow?</label>
                        <textarea id="nextActions" placeholder="Example: Next steps: 1) Create template automation in our GHL agency account, 2) Document the setup process in ClickUp with screenshots, 3) Add ''Email Automation Setup'' to client onboarding checklist, 4) Test with 1-2 pilot clients before rolling out to all. This will save ~3 hours/week previously spent on manual follow-ups." style="width: 100%; min-height: 110px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#0a2a5a'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
                        <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;"><strong>Actionable steps:</strong> What will you build, test, or implement? What changes in your process?</p>
                    </div>
                    <div style="margin-bottom: 20px; padding: 16px; background: #fff7ed; border-left: 3px solid #f59e0b; border-radius: 8px;">
                        <label style="display: block; font-weight: 900; color: #f59e0b; margin-bottom: 10px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">4. What''s unclear or what do you need help with? (Optional)</label>
                        <textarea id="challengesQuestions" placeholder="Example: Not sure how to handle unsubscribes in the automation - do I need a separate workflow? Also unclear on best practice for email frequency (don''t want to spam). Need guidance on A/B testing setup - which metrics should I track?" style="width: 100%; min-height: 90px; padding: 12px; border: 2px solid #fed7aa; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical; transition: border-color 0.2s;" onfocus="this.style.borderColor='#f59e0b'" onblur="this.style.borderColor='#fed7aa'"></textarea>
                        <p style="color: #92400e; font-size: 12px; margin-top: 8px; margin-bottom: 0;"><strong>Flag gaps:</strong> What confused you? What needs clarification? What''s the next skill to learn?</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; font-weight: 800; color: #0a2a5a; margin-bottom: 8px; font-size: 13px;">Comprehension Level</label>
                            <div class="star-rating" id="starRating" style="display: flex; gap: 8px; align-items: center;">
                                <span class="star" data-rating="1" title="1 - Need to rewatch"></span>
                                <span class="star" data-rating="2" title="2 - Understood basics"></span>
                                <span class="star" data-rating="3" title="3 - Can explain it"></span>
                                <span class="star" data-rating="4" title="4 - Can apply with guidance"></span>
                                <span class="star" data-rating="5" title="5 - Can apply independently"></span>
                            </div>
                            <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;">1 = rewatch needed  5 = ready to implement</p>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 800; color: #0a2a5a; margin-bottom: 8px; font-size: 13px;">Time Spent (minutes)</label>
                            <input type="number" id="timeSpent" value="30" min="1" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;" onfocus="this.style.borderColor='#0a2a5a'" onblur="this.style.borderColor='#e5e7eb'">
                            <p style="color: #6b7280; font-size: 12px; margin-top: 8px; margin-bottom: 0;">Total time including pauses/rewatches</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                        <button onclick="closeCompletionModal()" style="padding: 14px 18px; background: #f3f4f6; color: #0a2a5a; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">Cancel</button>
                        <button onclick="submitTrainingCompletion()" style="padding: 14px 18px; background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%); color: #ffffff; border: none; border-radius: 10px; font-weight: 900; font-size: 14px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 8px 20px rgba(10,42,90,0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"><span style="position: relative; z-index: 1;">Submit Training Report</span></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADD TASK MODAL -->
        <div class="task-modal-overlay" id="addTaskModal" onclick="closeAddTaskModal(event)">
            <div class="task-modal" onclick="event.stopPropagation()" style="max-width: 600px;">
                <div class="task-modal-header">
                    <div style="flex: 1;">
                        <div class="task-title" style="font-size: 24px; margin-bottom: 8px;">Add New Task</div>
                        <div style="color: var(--cobalt); font-size: 14px;">Create a task or let AI write the SOP for you</div>
                    </div>
                    <button class="task-modal-close" onclick="closeAddTaskModal()">X</button>
                </div>
                <div class="task-modal-body">
                    <form id="addTaskForm" onsubmit="submitNewTask(event)">
                        <div class="form-group">
                            <label class="form-label">Task Title</label>
                            <input type="text" id="newTaskTitle" class="form-input" placeholder="e.g., Check candidate emails" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Priority</label>
                                <select id="newTaskPriority" class="form-select">
                                    <option value="HIGH">High</option>
                                    <option value="MEDIUM" selected>Medium</option>
                                    <option value="LOW">Low</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Due Date</label>
                                <div style="display:flex; gap:8px;">
                                    <input type="date" id="newTaskDueDate" class="form-input" style="flex:1;">
                                    <input type="time" id="newTaskDueTime" class="form-input" style="flex:1;">
                                    <button type="button" class="btn-secondary" onclick="openCalendarModal()" title="Schedule"><span style="font-weight:900;">Cal</span></button>
                                </div>
                            </div>
                        </div>

                        <div class="form-row" style="display: flex; gap: 16px;">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Recurrence</label>
                                <select id="newTaskRecurrence" class="form-select">
                                    <option value="none" selected>None</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Retention (days in Done)</label>
                                <select id="newTaskRetention" class="form-select">
                                    <option value="1">1 day</option>
                                    <option value="3">3 days</option>
                                    <option value="7" selected>7 days</option>
                                    <option value="14">14 days</option>
                                    <option value="30">30 days</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label class="form-label" style="margin-bottom: 0;">Description / Rough Notes</label>
                                <button type="button" onclick="polishTaskDescription()" class="btn-magic">AI Polish</button>
                            </div>
                            <textarea id="newTaskDescription" class="form-textarea" placeholder="Type a rough idea here (e.g., 'Check emails and reply to candidates') and click AI Polish to turn it into a full SOP."></textarea>
                        </div>

                        <div class="task-modal-actions">
                            <button type="button" class="btn-secondary" onclick="closeAddTaskModal()">Cancel</button>
                            <button type="submit" class="btn-primary">Create Task</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- CALENDAR SCHEDULING MODAL -->
        <div class="calendar-modal-overlay" id="calendarModal" onclick="closeCalendarModal(event)">
            <div class="calendar-modal" onclick="event.stopPropagation()">
                <div class="calendar-modal-header">Schedule Task</div>
                <div class="calendar-modal-body">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="calendarDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" id="calendarTime" class="form-input">
                    </div>
                </div>
                <div class="calendar-modal-actions">
                    <button class="btn-secondary" onclick="closeCalendarModal()">Cancel</button>
                    <button class="btn-primary" onclick="applyCalendarSelection()">Apply</button>
                </div>
            </div>
        </div>

        <!-- VIEW TASK MODAL -->
        <div class="task-modal-overlay" id="taskModal" onclick="closeTaskModal(event)">
            <div class="task-modal" onclick="event.stopPropagation()">
                <div class="task-modal-header">
                    <div style="flex: 1; padding-right: 20px;">
                        <div id="modalTaskTitle" class="task-title" style="font-size: 24px; margin-bottom: 12px;"></div>
                        <div id="modalTaskBadges" class="task-badges"></div>
                    </div>
                    <button class="task-modal-close" onclick="closeTaskModal()">X</button>
                </div>
                <div class="task-modal-body">
                    <div id="modalTaskDescription" class="task-description" style="font-size: 16px; margin-bottom: 24px;"></div>
                    <div id="modalTaskContent"></div>
                </div>
                <div class="task-modal-actions">
                    <button id="modalTaskAction" class="task-action-btn"></button>
                    <button class="task-action-btn task-close-btn" onclick="closeTaskModal()">Close</button>
                </div>
            </div>
            </div>
        </div>

        <!-- DETAIL DRAWER -->
        <div class="detail-drawer" id="detailDrawer">
            <div class="detail-drawer-header">
                <div class="detail-drawer-title" id="drawerTitle">Candidate Details</div>
                <button class="detail-drawer-close" onclick="closeDetailDrawer()">X</button>
            </div>
            <div class="detail-drawer-body" id="drawerBody">
                <!-- Content populated by viewCandidate() -->
            </div>
        </div>
    </div> <!-- End #h2s-app -->

    <script>
        // Configuration - H2S Backend API
        // Goal: when hosted on the portal alias, use same-origin (/api/*) so Vercel rewrites can proxy to backend.
        // This avoids CORS errors that only show up on hosted domains.
        const DEFAULT_API_HOST = 'https://h2s-backend.vercel.app';

        function isPortalHosted() {
            try {
                const host = String(location.hostname || '').toLowerCase();
                return host.endsWith('home2smart.com') || host.endsWith('.vercel.app');
            } catch {
                return false;
            }
        }

        const API_BASE = (() => {
            try {
                const maybe = (typeof window !== 'undefined' && typeof window.API_URL === 'string')
                    ? window.API_URL.trim()
                    : '';
                // If the page is templated, honor it.
                if (maybe && !maybe.includes('<?') && /^https?:\/\//i.test(maybe)) {
                    return new URL(maybe).origin;
                }

                // If we're on the portal alias / Vercel, prefer same-origin (proxied by rewrites).
                if (isPortalHosted()) return '';

                return DEFAULT_API_HOST;
            } catch {
                return DEFAULT_API_HOST;
            }
        })();

        const API_URL = `${API_BASE}/api/v1`;
        const TRACK_API = `${API_BASE}/api/track`;
        const TRACK_PING_API = `${API_BASE}/api/track-ping`;
        
        let candidates = [];
        let autoRefreshInterval = null;
        
        // Tracking Helper Functions - DISABLED FOR DASHBOARD (internal tool, not sales funnel)
        async function trackEvent(eventName, properties = {}) {
            // Tracking disabled - this is an internal dashboard, not a customer-facing funnel page
            // All trackEvent calls are no-ops to prevent polluting sales funnel analytics
            return { ok: true, tracked: false, reason: 'internal_dashboard' };
        }
        
        async function checkTrackingHealth() {
            try {
                const response = await fetch(TRACK_PING_API);
                const health = await response.json();
                return health;
            } catch (error) {
                console.error('Health check error:', error);
                return { ok: false, healthy: false };
            }
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? 'OK' : type === 'error' ? 'X' : 'i';
            
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-message">${message}</div>
            `;
            
            container.appendChild(toast);
            
            // Auto-remove after 4 seconds
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 4000);
        }

        // Custom Modal Dialog System
        let modalResolve = null;

        function showModal(title, message, options = {}) {
            return new Promise((resolve) => {
                modalResolve = resolve;
                
                const overlay = document.getElementById('modalOverlay');
                const header = document.getElementById('modalHeader');
                const body = document.getElementById('modalBody');
                const confirmBtn = document.getElementById('modalConfirmBtn');
                const actions = document.getElementById('modalActions');
                
                header.textContent = title;
                
                // Support HTML content - check if message contains HTML tags
                if (options.html !== false && typeof message === 'string' && (message.includes('<div') || message.includes('<p') || message.includes('<button') || message.includes('<span') || message.includes('<h'))) {
                    body.innerHTML = message;
                } else {
                body.textContent = message;
                }
                
                // Configure modal size
                const dialog = overlay.querySelector('.modal-dialog');
                if (options.width) {
                    dialog.style.maxWidth = options.width;
                }
                if (options.maxHeight) {
                    dialog.style.maxHeight = options.maxHeight;
                    dialog.style.overflowY = 'auto';
                }
                
                // Configure confirm button
                if (options.hideConfirm) {
                    confirmBtn.style.display = 'none';
                } else {
                    confirmBtn.style.display = 'block';
                confirmBtn.textContent = options.confirmText || 'Confirm';
                confirmBtn.className = 'modal-btn ' + (options.danger ? 'modal-btn-danger' : 'modal-btn-confirm');
                confirmBtn.onclick = () => {
                    closeModal(true);
                };
                }
                
                // Hide actions if needed
                if (options.hideActions) {
                    actions.style.display = 'none';
                } else {
                    actions.style.display = 'flex';
                }
                
                // Prevent body scroll and layout shift
                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                if (scrollbarWidth > 0) {
                    document.body.style.paddingRight = `${scrollbarWidth}px`;
                }
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Focus trap - focus first focusable element
                setTimeout(() => {
                    const firstFocusable = overlay.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                    if (firstFocusable) firstFocusable.focus();
                }, 100);
            });
        }

        function closeModal(confirmed = false) {
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
            overlay.classList.remove('active');
            }
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            if (modalResolve) {
                modalResolve(confirmed);
                modalResolve = null;
            }
        }
        
        // Custom Confirm Dialog (replaces native confirm)
        function showConfirm(title, message, options = {}) {
            return new Promise((resolve) => {
                const confirmText = options.confirmText || 'Confirm';
                const cancelText = options.cancelText || 'Cancel';
                const danger = options.danger || false;
                
                // Create a temporary modal resolver
                let tempResolve = null;
                const tempPromise = new Promise((r) => { tempResolve = r; });
                
                const confirmHtml = `
                    <div style="padding: 24px 0;">
                        <div style="font-size: 16px; line-height: 1.6; color: #374151; white-space: pre-line;">${message}</div>
                    </div>
                `;
                
                const overlay = document.getElementById('modalOverlay');
                const header = document.getElementById('modalHeader');
                const body = document.getElementById('modalBody');
                const confirmBtn = document.getElementById('modalConfirmBtn');
                const cancelBtn = document.querySelector('.modal-btn-cancel');
                const actions = document.getElementById('modalActions');
                
                header.textContent = title;
                body.innerHTML = confirmHtml;
                
                // Configure buttons
                confirmBtn.textContent = confirmText;
                confirmBtn.className = 'modal-btn ' + (danger ? 'modal-btn-danger' : 'modal-btn-confirm');
                confirmBtn.onclick = () => {
                    closeModal();
                    resolve(true);
                };
                
                if (cancelBtn) {
                    cancelBtn.textContent = cancelText;
                    cancelBtn.onclick = () => {
                        closeModal();
                        resolve(false);
                    };
                }
                
                actions.style.display = 'flex';
                confirmBtn.style.display = 'block';
                
                // Configure modal size
                const dialog = overlay.querySelector('.modal-dialog');
                if (options.width) {
                    dialog.style.maxWidth = options.width;
                }
                
                // Show modal
                const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                if (scrollbarWidth > 0) {
                    document.body.style.paddingRight = `${scrollbarWidth}px`;
                }
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Focus trap
                setTimeout(() => {
                    cancelBtn?.focus();
                }, 100);
            });
        }

        // Close modal on overlay click
        document.getElementById('modalOverlay')?.addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                closeModal(false);
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('modalOverlay');
                if (overlay && overlay.classList.contains('active')) {
                    closeModal(false);
                }
            }
        });

        // Guard against multiple initializations (GHL may inject script multiple times)
        let dashboardInitialized = false;
        let appInstanceId = null;

        // Initialize Dashboard (called after user gate)
        function initDashboard() {
            // Prevent duplicate initialization
            if (dashboardInitialized) {
                console.warn('Dashboard already initialized, skipping duplicate init');
                return;
            }

            // Check for duplicate app containers (GHL might inject multiple times)
            const existingApps = document.querySelectorAll('#h2s-app');
            if (existingApps.length > 1) {
                console.warn(`Found ${existingApps.length} app instances, removing duplicates`);
                // Keep only the first instance, remove others
                for (let i = 1; i < existingApps.length; i++) {
                    existingApps[i].remove();
                }
            }

            // Mark as initialized
            dashboardInitialized = true;
            appInstanceId = Date.now();

            setupTabs();
            // Only load pipeline if it's the active pane
            const pipelinePane = document.getElementById('pipeline-pane');
            if (pipelinePane && pipelinePane.classList.contains('active')) {
                loadPipeline();
            }
            initHoursForm();
            setupForms();
            startAutoRefresh();
            loadKnowledgeProfile(); // Load user-specific profile
            // Only load training if it's the active pane (unlikely on init, but safe)
            const trainingPane = document.getElementById('training-pane');
            if (trainingPane && trainingPane.classList.contains('active')) {
                loadTrainingResources();
            }
            // Only load tasks if it's the active pane
            const tasksPane = document.getElementById('tasks-pane');
            if (tasksPane && tasksPane.classList.contains('active')) {
                loadTasks();
            }
            
            // Show logout button when logged in
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) logoutBtn.style.display = 'block';
        }

        // Initialize on page load (user gate will show first)
        document.addEventListener('DOMContentLoaded', () => {
            // Track page load
            if (typeof trackEvent === 'function') {
                trackEvent('page_view', {
                    page_type: 'dashboard',
                    page_title: 'H2S Dashboard'
                });
            }
            
            // Set up user select change listener to enable/disable button
            const userSelect = document.getElementById('userSelect');
            const userGateBtn = document.getElementById('userGateBtn');
            if (userSelect && userGateBtn) {
                userSelect.addEventListener('change', (e) => {
                    userGateBtn.disabled = !e.target.value;
                });
            }
            
            // Check if user is already cached (auto-login)
            const isCached = checkCachedUser();
            
            // If no cached user, gate will show (default state)
            if (!isCached) {
                // User gate will show (default state)
            } else {
                // Restore last active tab from localStorage (intelligent persistence)
                const restoreActiveTab = () => {
                    try {
                        const savedTab = localStorage.getItem('h2s_active_tab');
                        const savedTimestamp = localStorage.getItem('h2s_active_tab_timestamp');
                        
                        // Check if tab was saved recently (within last 24 hours)
                        const isValid = savedTab && savedTimestamp && (Date.now() - parseInt(savedTimestamp)) < (24 * 60 * 60 * 1000);
                        
                        // Check for URL parameters that override saved tab
                        const urlParams = new URLSearchParams(window.location.search);
                        const urlTab = urlParams.get('tab');
                        
                        // Priority: URL param > Saved tab > Default (pipeline)
                        const targetTab = urlTab || (isValid ? savedTab : 'pipeline');
                        
                        // Validate tab exists
                        const validTabs = ['pipeline', 'screening', 'techinterview', 'hours', 'reports', 'training', 'tasks', 'deliverables', 'admin', 'offerbuilder', 'proofpacks'];
                        if (validTabs.includes(targetTab)) {
                            // Small delay to ensure DOM is ready
                            setTimeout(() => {
                                switchToTab(targetTab, { skipPersistence: true, smooth: false });
                                
                                // Clean up URL if it had a tab parameter
                                if (urlTab) {
                                    const newUrl = new URL(window.location);
                                    newUrl.searchParams.delete('tab');
                                    window.history.replaceState({}, '', newUrl);
                                }
                            }, 100);
                        }
                    } catch (e) {
                        console.warn('Could not restore active tab:', e);
                    }
                };
                
                // Check if Analytics wants to open a specific training
                const urlParams = new URLSearchParams(window.location.search);
                const trainingToOpen = urlParams.get('openTraining') || localStorage.getItem('h2s_open_training');

                if (trainingToOpen && currentUser) {
                    localStorage.removeItem('h2s_open_training'); // Clear flag
                    setTimeout(() => {
                        // Switch to training pane
                        switchToTab('training', { skipPersistence: false, smooth: true });
                        // Open completion modal for this training
                        setTimeout(() => {
                            // Fetch title from training resources if available
                            const trainingContainer = document.getElementById('trainingContainer');
                            let title = 'Training Completion Report';
                            if (trainingContainer) {
                                const resourceEl = trainingContainer.querySelector(`[data-resource-id="${trainingToOpen}"]`);
                                if (resourceEl) {
                                    const titleEl = resourceEl.querySelector('.training-title');
                                    if (titleEl) {
                                        title = titleEl.textContent || title;
                                    }
                                }
                            }
                            openCompletionModal(trainingToOpen, title);
                        }, 500);
                    }, 1000);
                } else {
                    // Restore active tab if no special training flow
                    restoreActiveTab();
                }
            }
        });

        // Auto-refresh data every 30 seconds
        function startAutoRefresh() {
            // Clear any existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Refresh every 30 seconds
            autoRefreshInterval = setInterval(() => {
                
                // Get currently active tab
                const activeTab = document.querySelector('.tab.active');
                if (!activeTab) return;
                
                const tabName = activeTab.dataset.tab;
                
                // Refresh the active tab's data silently (no loading spinner)
                switch(tabName) {
                    case 'pipeline':
                        refreshPipeline();
                        break;
                    case 'reports':
                        refreshAIProfiles();
                        break;
                    case 'training':
                        loadTrainingResources(true); // Silent
                        break;
                    case 'tasks':
                        loadTasks(true); // Silent
                        break;
                    case 'hours':
                        loadHoursHistory(true); // Silent - no spinner on refresh
                        break;
                }
            }, 30000); // 30 seconds
            
        }

        // Silent refresh for pipeline (no spinner)
        async function refreshPipeline() {
            try {
                const response = await fetch(`${API_URL}?action=candidates&stage=all`);
                const data = await response.json();
                
                if (data.ok && data.candidates) {
                    const newCount = data.candidates.length;
                    const oldCount = candidates.length;
                    
                    candidates = data.candidates;
                    renderPipeline(candidates);
                    
                    if (newCount !== oldCount) {
                    }
                }
            } catch (error) {
                console.error('Auto-refresh error:', error);
            }
        }

        // Silent refresh for AI profiles (no spinner)
        async function refreshAIProfiles() {
            try {
                const response = await fetch(`${API_URL}?action=aiProfiles`);
                const data = await response.json();
                
                if (data.ok && data.profiles) {
                    const newCount = data.profiles.length;
                    const oldCount = allProfiles.length;
                    
                    allProfiles = data.profiles;
                    filterProfiles(currentFilter);
                    
                    if (newCount !== oldCount) {
                    }
                }
            } catch (error) {
                console.error('Auto-refresh error:', error);
            }
        }

        // Tab Switching (updated for sidebar)
        function switchToTab(targetTab, options = {}) {
            const { skipPersistence = false, smooth = true } = options;
            
            // Shared gate: Admin Dashboard + Proof Packs use the same password/credential.
            const needsAdminGate = (targetTab === 'admin' || targetTab === 'proofpacks');
            if (needsAdminGate && !checkAdminAuth()) {
                promptAdminPassword((authenticated) => {
                    if (authenticated) {
                        // Retry switching after successful auth
                        switchToTab(targetTab, options);
                    }
                });
                return;
            }
            
            // Show loading indicator for smooth transitions
            if (smooth) {
                let indicator = document.getElementById('tabSwitchingIndicator');
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'tabSwitchingIndicator';
                    indicator.className = 'tab-switching-indicator';
                    document.body.appendChild(indicator);
                }
                indicator.classList.add('active');
                setTimeout(() => {
                    indicator.classList.remove('active');
                }, 400);
            }
            
            // Persist active tab to localStorage (unless explicitly skipped)
            if (!skipPersistence) {
                try {
                    localStorage.setItem('h2s_active_tab', targetTab);
                    localStorage.setItem('h2s_active_tab_timestamp', Date.now().toString());
                } catch (e) {
                    console.warn('Could not save active tab:', e);
                }
            }
            
            // Add smooth transition class to panes
            if (smooth) {
                document.querySelectorAll('.pane').forEach(p => {
                    p.style.transition = 'opacity 0.2s ease-out, transform 0.2s ease-out';
                    p.style.opacity = '0';
                    p.style.transform = 'translateY(4px)';
                });
            }
            
            // CRITICAL: First, hide ALL panes to prevent stacking
            document.querySelectorAll('.pane').forEach(p => {
                p.classList.remove('active');
                // Force hide with inline style as backup (in case CSS is overridden)
                p.style.display = 'none';
            });
            
            // Update sidebar nav with smooth transition
            document.querySelectorAll('.app-sidebar-nav-item').forEach(item => {
                item.classList.remove('active');
                item.style.transition = 'all 0.2s ease-out';
            });
            const navItem = document.querySelector(`.app-sidebar-nav-item[data-tab="${targetTab}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            // Update hidden tabs (for compatibility)
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const tabElement = document.querySelector(`.tab[data-tab="${targetTab}"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Show ONLY the target pane with smooth fade-in
            const paneElement = document.getElementById(targetTab + '-pane');
            if (paneElement) {
                paneElement.classList.add('active');
                // Force show with inline style as backup (CSS will override with !important)
                paneElement.style.display = 'block';
                
                // Track tab view event
                if (typeof trackEvent === 'function') {
                    trackEvent('tab_view', {
                        tab_name: targetTab,
                        page_type: 'dashboard'
                    });
                }
                
                // If switching to offer builder, load performance data
                if (targetTab === 'offerbuilder') {
                    // --- NUCLEAR LAYOUT RESET ---
                    const obPane = document.getElementById('offerbuilder-pane');
                    if (obPane) {
                        obPane.style.cssText = 'display: block !important; position: absolute !important; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background: var(--surface-2); padding-top: 24px; overflow-y: auto; box-sizing: border-box; margin: 0;';
                        
                        // Force children to top
                        Array.from(obPane.children).forEach(child => { 
                            if(child.style) {
                                child.style.marginTop = '0';
                                child.style.top = '0'; 
                            }
                        });
                        
                        // Scroll to top
                        obPane.scrollTop = 0;
                    }
                    // ----------------------------

                    setTimeout(() => {
                        if (typeof offerBuilder !== 'undefined' && typeof offerBuilder.loadOfferPerformanceData === 'function') {
                            offerBuilder.loadOfferPerformanceData();
                        }
                    }, 300);
                }
                
                // Smooth fade-in animation
                if (smooth) {
                    requestAnimationFrame(() => {
                        paneElement.style.opacity = '0';
                        paneElement.style.transform = 'translateY(4px)';
                        requestAnimationFrame(() => {
                            paneElement.style.opacity = '1';
                            paneElement.style.transform = 'translateY(0)';
                        });
                    });
                }
                
                // After a brief delay, remove inline style to let CSS take over
                // This ensures CSS !important rules work while also having a fallback
                setTimeout(() => {
                    if (paneElement.classList.contains('active')) {
                        paneElement.style.display = '';
                        if (!smooth) {
                            paneElement.style.opacity = '';
                            paneElement.style.transform = '';
                        }
                    }
                }, smooth ? 200 : 100);
                
                // Initialize features if needed
                setTimeout(() => {
                    if (typeof initFeatureIfNeeded === 'function') {
                        initFeatureIfNeeded(targetTab);
                    }
                }, smooth ? 250 : 150);
            } else {
                console.error(`Pane not found: ${targetTab}-pane`);
            }
            
            // Update top bar title
            const areaTitles = {
                'pipeline': 'Pipeline',
                'screening': 'Screening Form',
                'techinterview': 'Tech Interview',
                'hours': 'Log Hours',
                'reports': 'Candidate Review',
                'training': 'Training',
                'tasks': 'Tasks',
                'deliverables': 'Deliverables',
                'admin': 'Admin Dashboard',
                'offerbuilder': 'Offer Builder',
                'proofpacks': 'Proof Packs'
            };
            const titleEl = document.getElementById('currentAreaTitle');
            if (titleEl) {
                titleEl.style.transition = 'opacity 0.15s ease-out';
                titleEl.style.opacity = '0';
                setTimeout(() => {
                    titleEl.textContent = areaTitles[targetTab] || 'Dashboard';
                    titleEl.style.opacity = '1';
                }, 100);
            }
            
            // Close drawer if open
            closeDetailDrawer();
            
            // Scroll to top when switching tabs - scroll both window and app-content
            window.scrollTo({ top: 0, behavior: smooth ? 'smooth' : 'auto' });
            const appContent = document.querySelector('#h2s-app .app-content');
            if (appContent) {
                appContent.scrollTop = 0;
            }
            // Also scroll the active pane to top
            if (paneElement) {
                paneElement.scrollTop = 0;
            }
            
            // Load data when specific tabs are clicked (only if pane is now active)
            // Use setTimeout to ensure pane is visible before loading
            setTimeout(() => {
                const activePane = document.getElementById(targetTab + '-pane');
                if (!activePane || !activePane.classList.contains('active')) {
                    return; // Pane was switched away before load completed
                }

                if (targetTab === 'pipeline') {
                    loadPipeline();
                } else if (targetTab === 'reports') {
                    loadAIProfiles();
                } else if (targetTab === 'training') {
                    loadTrainingResources();
                } else if (targetTab === 'deliverables') {
                    // Initialize deliverables view when tab is clicked
                    if (typeof switchDeliverablesView === 'function') {
                        const view = currentDeliverablesView || 'submission';
                        switchDeliverablesView(view);
                    } else {
                        console.error('switchDeliverablesView function not found');
                    }
                    // Refresh deliverables data to show latest submissions
                    setTimeout(() => {
                        if (typeof loadDeliverablesReview === 'function') {
                            loadDeliverablesReview();
                        }
                        if (typeof loadDeliverablesLibrary === 'function') {
                            loadDeliverablesLibrary();
                        }
                    }, 200);
                } else if (targetTab === 'tasks') {
                    loadTasks();
                } else if (targetTab === 'hours') {
                    loadHoursHistory();
                }
            }, 50);
        }

        // Tab Switching (legacy, for compatibility)
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchToTab(tab.dataset.tab);
                });
            });
        }

        // Load Pipeline
        async function loadPipeline(silent = false) {
            const container = document.getElementById('pipelineContainer');
            
            // Only show spinner on initial load, not on refreshes
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
                container.style.display = 'grid';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=candidates&stage=all`);
                const data = await response.json();
                
                if (data.ok) {
                    // API returns { ok: true, data: [...] }
                    candidates = data.data || data.candidates || [];
                    if (candidates.length === 0) {
                        container.style.display = 'block';
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">No candidates yet. Submit a screening form to get started.</div>
                            </div>
                        `;
                    } else {
                        container.style.display = 'grid';
                        renderPipeline(candidates);
                    }
                } else {
                    container.style.display = 'block';
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text" style="color: var(--danger);">Error: ${data.error || 'Failed to load candidates'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.style.display = 'block';
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error loading candidates. Check console for details.</div>
                    </div>
                `;
            }
        }

        // Pagination state for each pipeline column
        const pipelinePages = {
            'SCREENED': 1,
            'INTERVIEWED': 1,
            'HIRED': 1,
            'REJECTED': 1
        };

        const PIPELINE_STAGES = [
            { key: 'SCREENED', label: 'Screened' },
            { key: 'INTERVIEWED', label: 'Interviewed' },
            { key: 'HIRED', label: 'Hired' },
            { key: 'REJECTED', label: 'Rejected' }
        ];

        const PIPELINE_PER_PAGE = 12;

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function parseFlexibleDate(input) {
            if (!input) return null;
            if (input instanceof Date && !isNaN(input.getTime())) return input;
            const str = String(input).trim();
            if (!str) return null;

            // YYYY-MM-DD or YYYY-MM-DDTHH:mm:ss
            let m = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (m) {
                const y = Number(m[1]);
                const mo = Number(m[2]);
                const d = Number(m[3]);
                const dt = new Date(y, mo - 1, d);
                if (!isNaN(dt.getTime())) return dt;
            }

            // YYYY:MM:DD HH:MM:SS
            m = str.match(/^(\d{4}):(\d{2}):(\d{2})\s+(\d{2}):(\d{2}):(\d{2})$/);
            if (m) {
                const y = Number(m[1]);
                const mo = Number(m[2]);
                const d = Number(m[3]);
                const hh = Number(m[4]);
                const mm = Number(m[5]);
                const ss = Number(m[6]);
                const dt = new Date(y, mo - 1, d, hh, mm, ss);
                if (!isNaN(dt.getTime())) return dt;
            }

            const dt = new Date(str);
            return isNaN(dt.getTime()) ? null : dt;
        }

        // Used by the candidate drawer + pipeline cards.
        function getDaysSince(dateLike) {
            const dt = parseFlexibleDate(dateLike);
            if (!dt) return 'Unknown';
            const now = new Date();
            const ms = now.getTime() - dt.getTime();
            const days = Math.floor(ms / (1000 * 60 * 60 * 24));
            if (!isFinite(days)) return 'Unknown';
            if (days <= 0) return 'Today';
            if (days === 1) return '1 day';
            return `${days} days`;
        }

        function normalizeStage(rawStage) {
            const raw = String(rawStage || '').trim().toUpperCase();
            if (!raw) return 'SCREENED';
            if (raw === 'SCREENED' || raw === 'SCREENING') return 'SCREENED';
            if (raw.includes('INTERVIEW')) return 'INTERVIEWED';
            if (raw.includes('HIRED') || raw.includes('HIRE')) return 'HIRED';
            if (raw.includes('REJECT') || raw.includes('FAIL') || raw.includes('DENY')) return 'REJECTED';
            if (raw === 'PASS') return 'INTERVIEWED';
            return (pipelinePages[raw] !== undefined) ? raw : 'SCREENED';
        }

        function getCandidateId(candidate) {
            const id = candidate?.Candidate_ID ?? candidate?.id ?? candidate?.candidateId ?? candidate?.CandidateId;
            return String(id ?? '').trim();
        }

        function getCandidateOutcome(candidate) {
            const raw = String(
                candidate?.screeningOutcome || candidate?.Screening_Outcome ||
                candidate?.interviewOutcome || candidate?.Interview_Outcome ||
                candidate?.Outcome || ''
            ).trim().toUpperCase();

            if (!raw) return null;
            if (raw === 'PASS') return { text: 'Pass', cls: 'candidate-outcome outcome-ready' };
            if (raw === 'FOLLOW_UP' || raw === 'FOLLOWUP') return { text: 'Follow-up', cls: 'candidate-outcome outcome-warm' };
            if (raw === 'REJECT' || raw === 'FAIL') return { text: 'Reject', cls: 'candidate-outcome outcome-not-match' };
            return { text: raw, cls: 'candidate-outcome outcome-hold' };
        }

        function computeCurrentPipelineList() {
            const term = String(document.getElementById('pipelineSearch')?.value || '').trim().toLowerCase();
            if (!term) return Array.isArray(candidates) ? candidates : [];
            // If filterPipeline() has run, prefer its cached list.
            if (Array.isArray(filteredCandidates)) return filteredCandidates;
            return (Array.isArray(candidates) ? candidates : []).filter(c => {
                const name = `${c.First_Name || ''} ${c.Last_Name || ''}`.toLowerCase();
                const phone = String(c.Phone || '').toLowerCase();
                const email = String(c.Email || '').toLowerCase();
                return name.includes(term) || phone.includes(term) || email.includes(term);
            });
        }

        function changePipelinePage(stageKey, delta) {
            const stage = normalizeStage(stageKey);
            const next = (pipelinePages[stage] || 1) + Number(delta || 0);
            pipelinePages[stage] = Math.max(1, next);
            renderPipeline(computeCurrentPipelineList());
        }

        // Main pipeline renderer (was missing in hosted builds).
        function renderPipeline(list) {
            const container = document.getElementById('pipelineContainer');
            const all = Array.isArray(list) ? list : [];

            const grouped = { SCREENED: [], INTERVIEWED: [], HIRED: [], REJECTED: [] };
            all.forEach(c => {
                const stage = normalizeStage(c?.Current_Stage || c?.currentStage);
                (grouped[stage] || grouped.SCREENED).push(c);
            });

            // Sort within each stage by Screening_Date desc (fallback to 0)
            Object.keys(grouped).forEach(stage => {
                grouped[stage].sort((a, b) => {
                    const da = parseFlexibleDate(a?.Screening_Date || a?.screeningDate || a?.Created_At || a?.createdAt) || new Date(0);
                    const db = parseFlexibleDate(b?.Screening_Date || b?.screeningDate || b?.Created_At || b?.createdAt) || new Date(0);
                    return db.getTime() - da.getTime();
                });
            });

            const html = PIPELINE_STAGES.map(({ key, label }) => {
                const items = grouped[key] || [];
                const total = items.length;
                const totalPages = Math.max(1, Math.ceil(total / PIPELINE_PER_PAGE));

                const rawPage = pipelinePages[key] || 1;
                const page = Math.max(1, Math.min(totalPages, rawPage));
                pipelinePages[key] = page;

                const startIdx = (page - 1) * PIPELINE_PER_PAGE;
                const endIdx = startIdx + PIPELINE_PER_PAGE;
                const slice = items.slice(startIdx, endIdx);

                const cards = slice.map(c => {
                    const id = getCandidateId(c);
                    const first = escapeHtml(c?.First_Name || '');
                    const last = escapeHtml(c?.Last_Name || '');
                    const phone = escapeHtml(c?.Phone || '');
                    const email = escapeHtml(c?.Email || '');
                    const dt = parseFlexibleDate(c?.Screening_Date || c?.screeningDate || c?.Created_At || c?.createdAt);
                    const dateText = dt ? dt.toLocaleDateString() : 'Unknown date';
                    const daysText = getDaysSince(dt);
                    const outcome = getCandidateOutcome(c);

                    const safeId = escapeHtml(id);
                    return `
                        <div class="candidate-card" onclick="viewCandidate('${safeId}')">
                            <div class="candidate-name">${first} ${last}</div>
                            <div class="candidate-info"><strong>Phone:</strong> ${phone || 'N/A'}</div>
                            <div class="candidate-info"><strong>Email:</strong> ${email || 'N/A'}</div>
                            <div class="candidate-date">${escapeHtml(dateText)} (${escapeHtml(daysText)} ago)</div>
                            ${outcome ? `<div class="${outcome.cls}">${escapeHtml(outcome.text)}</div>` : ''}
                        </div>
                    `;
                }).join('');

                const shownStart = total === 0 ? 0 : (startIdx + 1);
                const shownEnd = Math.min(endIdx, total);

                return `
                    <div class="pipeline-column" data-stage="${key}">
                        <div class="pipeline-header">
                            <span>${label}</span>
                            <span class="pipeline-count">${total}</span>
                        </div>
                        <div class="pipeline-cards-container">
                            ${cards || `<div class="empty-state" style="padding: 18px 8px;"><div class="empty-text" style="font-size: 13px;">No candidates</div></div>`}
                        </div>
                        <div class="pipeline-pagination">
                            <div class="pagination-info">${shownStart}-${shownEnd} of ${total}</div>
                            <div class="pagination-controls">
                                <button class="page-btn" onclick="changePipelinePage('${key}', -1)" ${page <= 1 ? 'disabled' : ''}>Prev</button>
                                <button class="page-btn" onclick="changePipelinePage('${key}', 1)" ${page >= totalPages ? 'disabled' : ''}>Next</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }


        const proofPacks = {
            // Helper alias to global toast
            showToast: typeof showToast === 'function' ? showToast : (msg) => console.log(msg),

            onPreviewMediaError(el, kind) {
                try {
                    const parent = el?.parentElement;
                    if (!parent) return;
                    const msg = (kind === 'image') ? 'Image failed to load' : 'Video failed to load';
                    const wrap = document.createElement('div');
                    wrap.style.padding = '20px';
                    wrap.style.textAlign = 'center';
                    wrap.style.color = '#6b7280';
                    wrap.style.fontSize = '12px';
                    wrap.textContent = msg;
                    parent.innerHTML = '';
                    parent.appendChild(wrap);
                } catch {
                    // ignore
                }
            },
            
            // GAP 3 FIX: Debounced toast system
            toastDebounce: {},
            showToastDebounced(message, type = 'info', debounceKey = null, delay = 500) {
                if (debounceKey) {
                    if (this.toastDebounce[debounceKey]) {
                        clearTimeout(this.toastDebounce[debounceKey]);
                    }
                    this.toastDebounce[debounceKey] = setTimeout(() => {
                        this.showToast(message, type);
                        delete this.toastDebounce[debounceKey];
                    }, delay);
                } else {
                    this.showToast(message, type);
                }
            },

            state: {
                mode: 'upload',
                _rotateFieldHome: null,
                _rotateFieldNext: null,
                _trimFieldHome: null,
                _trimFieldNext: null,
                file: null,
                analysis: null,
                previewUrl: '',
                replace: { assetId: '', asset: null },
                edit: { assetId: '', asset: null },
                packs: [],
                libraryPacks: { tv_mounting: [], cameras: [] },
                coverage: { loading: false, pack_id: null, videos: 0, photos: 0, targetVideos: 0, targetPhotos: 0 },
                assets: { loading: false, pack_id: null, items: [], scopeNote: '' },
                supabase: { loading: false, ok: false, url: '', anonKey: '' },
            },

            storageKeys: {
                backendUrl: 'h2s_proof_backend_url',
                adminKey: 'h2s_proof_admin_key',
                service: 'h2s_pp_service',
                mode: 'h2s_pp_mode',
                convertToMp4: 'h2s_pp_convert_to_mp4',
                rotateDeg: 'h2s_pp_video_rotate_deg',
                trimStartSec: 'h2s_pp_trim_start_sec',
                trimEndSec: 'h2s_pp_trim_end_sec',
                filterBw: 'h2s_pp_filter_bw',
                packPrefix: 'h2s_pp_pack',
                assetsCachePrefix: 'h2s_pp_assets_cache',
                coverageCachePrefix: 'h2s_pp_coverage_cache',
            },

            getPackStorageKey(surface, service) {
                const s = String(surface || 'bundles');
                const svc = String(service || '');
                return `${this.storageKeys.packPrefix}:${s}:${svc}`;
            },

            getAssetsCacheKey(packId, service) {
                const p = String(packId || '');
                const svc = String(service || '');
                return `${this.storageKeys.assetsCachePrefix}:${p}:${svc}`;
            },

            getCoverageCacheKey(packId, service) {
                const p = String(packId || '');
                const svc = String(service || '');
                return `${this.storageKeys.coverageCachePrefix}:${p}:${svc}`;
            },

            safeReadJson(key) {
                if (!key) return null;
                try {
                    const raw = localStorage.getItem(key);
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch {
                    return null;
                }
            },

            safeWriteJson(key, value) {
                if (!key) return;
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch {
                    // ignore quota/blocked storage
                }
            },

            safeSetItem(key, value) {
                if (!key) return;
                try { localStorage.setItem(key, String(value ?? '')); } catch { /* ignore */ }
            },

            safeGetItem(key) {
                if (!key) return '';
                try { return localStorage.getItem(key) || ''; } catch { return ''; }
            },

            clampNumber(n, min, max, fallback = 0) {
                const v = Number(n);
                if (!Number.isFinite(v)) return fallback;
                return Math.max(min, Math.min(max, v));
            },

            getAssetSmartCropDetails(asset) {
                const d = asset?.smart_crop_details;
                if (d && typeof d === 'object') return d;

                // Fallback: local cache (keeps UI consistent even if backend echo is delayed).
                const assetId = String(asset?.asset_id || '').trim();
                if (!assetId) return {};
                const cached = this.safeReadJson(`h2s_pp_asset_crop:${assetId}`);
                return (cached && typeof cached === 'object') ? cached : {};
            },

            buildAssetPreviewStyle(asset) {
                // This is the *resting card truth*: render using saved fields, not editor DOM state.
                const rotateBase = Number(asset?.video_rotate_deg || 0);
                const rotateDeg = (rotateBase === 90 || rotateBase === 180 || rotateBase === 270) ? rotateBase : 0;

                const smart = this.getAssetSmartCropDetails(asset);
                const mode = this.normalizeCropMode(smart?.mode);
                const objectFit = mode === 'contain' ? 'contain' : 'cover';
                const objectPosition = this.normalizeObjectPosition(smart?.objectPosition || '50% 50%');

                const geom = (smart && typeof smart.geometry === 'object') ? smart.geometry : {};
                const panX = this.clampNumber(geom?.pan_x_pct ?? geom?.panX ?? 0, -50, 50, 0);
                const panY = this.clampNumber(geom?.pan_y_pct ?? geom?.panY ?? 0, -50, 50, 0);
                const tilt = this.clampNumber(geom?.tilt_deg ?? geom?.tilt ?? 0, -45, 45, 0);
                const scalePct = this.clampNumber(geom?.scale_pct ?? geom?.scale ?? 100, 50, 250, 100);
                const scale = scalePct / 100;

                const transform = `translate(${panX}%, ${panY}%) rotate(${rotateDeg + tilt}deg) scale(${scale}) translateZ(0)`;

                // Filters (saved metadata)
                const filterParts = [];
                const bw = String(asset?.filter_bw || '') === '1' || asset?.filter_bw === true;
                if (bw) filterParts.push('grayscale(100%)');
                const b = Number(asset?.filter_brightness || 100);
                const c = Number(asset?.filter_contrast || 100);
                const s = Number(asset?.filter_saturation || 100);
                if (Number.isFinite(b) && b !== 100) filterParts.push(`brightness(${b}%)`);
                if (Number.isFinite(c) && c !== 100) filterParts.push(`contrast(${c}%)`);
                if (Number.isFinite(s) && s !== 100) filterParts.push(`saturate(${s}%)`);

                const needsTransform = rotateDeg !== 0 || tilt !== 0 || panX !== 0 || panY !== 0 || scale !== 1;
                const parts = [
                    `object-fit: ${objectFit}`,
                    `object-position: ${objectPosition}`,
                    needsTransform ? `transform: ${transform}` : '',
                    needsTransform ? 'will-change: transform' : '',
                    needsTransform ? 'backface-visibility: hidden' : '',
                    filterParts.length ? `filter: ${filterParts.join(' ')}` : ''
                ].filter(Boolean);

                return parts.length ? `${parts.join('; ')};` : '';
            },

            hydrateEditorFromAsset(asset) {
                try {
                    const a = asset || {};
                    const smart = this.getAssetSmartCropDetails(a);

                    // Rotation
                    const rotateBase = Number(a?.video_rotate_deg || 0);
                    const rotateDeg = (rotateBase === 90 || rotateBase === 180 || rotateBase === 270) ? rotateBase : 0;
                    const rotateEl = document.getElementById('ppVideoRotate');
                    if (rotateEl) rotateEl.value = String(rotateDeg);

                    // Crop mode + focal
                    const mode = this.normalizeCropMode(smart?.mode);
                    if (mode) {
                        // Update button UI
                        document.querySelectorAll('.crop-mode-btn').forEach(b => {
                            const bMode = this.normalizeCropMode(b.getAttribute('data-mode'));
                            b.classList.toggle('active', bMode === mode);
                        });

                        // Apply object-fit to both stage + live
                        const { stageMedia, liveMedia } = this.getActivePreviewElements();
                        const objectFit = mode === 'contain' ? 'contain' : 'cover';
                        if (stageMedia) stageMedia.style.objectFit = objectFit;
                        if (liveMedia) liveMedia.style.objectFit = objectFit;
                    }

                    // Drag-first: show crosshair for cover/contain, hide for manual
                    if (typeof this.toggleCrosshair === 'function') {
                        const crosshairMode = mode || 'cover';
                        this.toggleCrosshair(crosshairMode !== 'manual');
                    }

                    const posStrRaw = smart?.objectPosition;
                    const posStr = (posStrRaw && String(posStrRaw).trim()) ? this.normalizeObjectPosition(posStrRaw) : '';
                    if (posStr) {
                        const { stageMedia, liveMedia } = this.getActivePreviewElements();
                        if (stageMedia) stageMedia.style.objectPosition = posStr;
                        if (liveMedia) liveMedia.style.objectPosition = posStr;

                        // Keep inputs and crosshair synced
                        const [xStr, yStr] = posStr.split(' ');
                        const xVal = parseInt(xStr) || 50;
                        const yVal = parseInt(yStr) || 50;
                        const inpX = document.getElementById('ppFocalX');
                        const inpY = document.getElementById('ppFocalY');
                        if (inpX) inpX.value = String(xVal);
                        if (inpY) inpY.value = String(yVal);
                        if (typeof this.updateCrosshairPosition === 'function') {
                            this.updateCrosshairPosition(xVal, yVal);
                        }
                    }

                    // Geometry
                    const geom = (smart && typeof smart.geometry === 'object') ? smart.geometry : {};
                    const tilt = this.clampNumber(geom?.tilt_deg ?? 0, -10, 10, 0);
                    const scale = this.clampNumber(geom?.scale_pct ?? 100, 50, 200, 100);
                    const panX = this.clampNumber(geom?.pan_x_pct ?? 0, -50, 50, 0);
                    const panY = this.clampNumber(geom?.pan_y_pct ?? 0, -50, 50, 0);

                    const tiltEl = document.getElementById('ppTiltDeg');
                    const scaleEl = document.getElementById('ppScalePct');
                    const panXEl = document.getElementById('ppPanX');
                    const panYEl = document.getElementById('ppPanY');
                    if (tiltEl) tiltEl.value = String(tilt);
                    if (scaleEl) scaleEl.value = String(scale);
                    if (panXEl) panXEl.value = String(panX);
                    if (panYEl) panYEl.value = String(panY);

                    // Keep editor save payload consistent
                    this.state = this.state || {};
                    this.state.cropping = this.state.cropping || {};
                    if (mode) this.state.cropping.mode = mode;
                    if (posStr) this.state.cropping.objectPosition = posStr;
                    this.state.cropping.geometry = {
                        tilt_deg: tilt,
                        scale_pct: scale,
                        pan_x_pct: panX,
                        pan_y_pct: panY,
                    };
                } catch {
                    // ignore
                }
            },

            isTouchUi() {
                try {
                    if (window.matchMedia && window.matchMedia('(hover: none)').matches) return true;
                } catch {
                    // ignore
                }
                return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            },

            toggleThumbPlayback(el, ev) {
                try {
                    if (ev) {
                        ev.preventDefault();
                        ev.stopPropagation();
                    }

                    const container = el?.closest?.('.pp-video-thumbnail, .pp-grid-thumbnail')
                        || (el?.classList?.contains('pp-video-thumbnail') ? el : null)
                        || (el?.classList?.contains('pp-grid-thumbnail') ? el : null);
                    if (!container) return;

                    const video = container.querySelector('video');
                    if (!video) return;

                    video.muted = true;
                    video.playsInline = true;

                    if (video.paused) {
                        const p = video.play();
                        container.classList.add('is-playing');
                        if (p && typeof p.catch === 'function') p.catch(() => { /* ignore */ });
                    } else {
                        video.pause();
                        container.classList.remove('is-playing');
                    }
                } catch {
                    // ignore
                }
            },

            getModePreference() {
                const raw = String(this.safeGetItem(this.storageKeys.mode) || '').trim().toLowerCase();
                return (raw === 'library') ? 'library' : 'upload';
            },

            setMode(mode, { silent } = {}) {
                const next = (String(mode || '').toLowerCase() === 'library') ? 'library' : 'upload';
                this.state.mode = next;
                this.safeSetItem(this.storageKeys.mode, next);

                if (next === 'upload') {
                    this.restoreEditorFieldsHome();
                    const editor = document.getElementById('ppLibraryEditor');
                    if (editor) editor.classList.add('is-hidden');
                }

                const uploadWs = document.getElementById('ppUploadWorkspace');
                const libraryWs = document.getElementById('ppLibraryWorkspace');
                if (uploadWs) uploadWs.style.display = next === 'upload' ? '' : 'none';
                if (libraryWs) libraryWs.style.display = next === 'library' ? '' : 'none';

                const btnUpload = document.getElementById('ppModeUpload');
                const btnLibrary = document.getElementById('ppModeLibrary');
                if (btnUpload) btnUpload.className = `btn ${next === 'upload' ? 'btn-primary' : 'btn-secondary'}`;
                if (btnLibrary) btnLibrary.className = `btn ${next === 'library' ? 'btn-primary' : 'btn-secondary'}`;

                if (next === 'library') {
                    console.log('[Workspace] Switching to Library - auto-loading assets');
                    this.refreshAssets();
                    this.refreshLivePreview();
                }
            },

            restoreEditorFieldsHome() {
                const rotateField = document.getElementById('ppRotateField');
                const trimField = document.getElementById('ppTrimField');

                // If we hid the old trim UI for the unified editor timeline, restore it.
                const trimWrap = document.getElementById('ppTrimHandleWrap');
                const trimHelp = document.getElementById('ppTrimHelp');
                if (trimWrap) trimWrap.style.display = '';
                if (trimHelp) trimHelp.style.display = '';

                if (rotateField && this.state._rotateFieldHome) {
                    try {
                        this.state._rotateFieldHome.insertBefore(rotateField, this.state._rotateFieldNext || null);
                    } catch {
                        // ignore
                    }
                }
                if (trimField && this.state._trimFieldHome) {
                    try {
                        this.state._trimFieldHome.insertBefore(trimField, this.state._trimFieldNext || null);
                    } catch {
                        // ignore
                    }
                }
            },

            getConvertToMp4Preference() {
                const el = document.getElementById('ppConvertToMp4');
                if (el && typeof el.checked === 'boolean') return !!el.checked;
                const raw = this.safeGetItem(this.storageKeys.convertToMp4);
                return raw ? raw === '1' : true;
            },

            getRotateDegPreference() {
                const el = document.getElementById('ppVideoRotate');
                const raw = String((el?.value || this.safeGetItem(this.storageKeys.rotateDeg) || '0')).trim();
                const n = Number(raw);
                return (n === 90 || n === 180 || n === 270) ? String(n) : '0';
            },

            getTrimStartSecPreference() {
                const el = document.getElementById('ppTrimStartSec');
                const raw = String((el?.value || this.safeGetItem(this.storageKeys.trimStartSec) || '')).trim();
                return raw;
            },

            getTrimEndSecPreference() {
                const el = document.getElementById('ppTrimEndSec');
                const raw = String((el?.value || this.safeGetItem(this.storageKeys.trimEndSec) || '')).trim();
                return raw;
            },

            applyLocalPreviewRotation() {
                const v = document.getElementById('ppLocalPreviewVideo');
                const rotator = document.getElementById('ppLocalPreviewRotator');
                if (!v || !rotator) return;
                this.applyRotationLogic(v, rotator);
            },

            applyEditorRotation() {
                const v = document.getElementById('ppEditorVideo');
                const rotator = document.getElementById('ppEditorRotator');
                if (!v || !rotator) return;
                const result = this.applyRotationLogic(v, rotator);

                // Mirror transforms/filters into the right-side live preview so edits feel direct.
                const liveRotator = document.getElementById('ppLivePreviewRotator');
                const liveMedia = document.getElementById('ppPreviewMedia');
                if (liveRotator && result?.transform) {
                    liveRotator.style.transform = result.transform;
                    liveRotator.style.transformOrigin = 'center center';
                    liveRotator.style.willChange = 'transform';
                    liveRotator.style.backfaceVisibility = 'hidden';
                }
                if (liveMedia) {
                    // Match visual filters (brightness/contrast/sat/grayscale) from stage media.
                    liveMedia.style.filter = v.style.filter || 'none';
                }
            },

            applyRotationLogic(v, rotator) {
                // Base 90-degree rotation (Standard)
                const deg = Number(this.getRotateDegPreference() || 0);

                // Fine-tune Tilt (Straighten)
                const tiltEl = document.getElementById('ppTiltDeg');
                const tilt = Number(tiltEl?.value || 0);
                
                // Scale (Production Zoom)
                const scaleEl = document.getElementById('ppScalePct');
                const scale = Number(scaleEl?.value || 100) / 100;

                // Pan (Position)
                const panXEl = document.getElementById('ppPanX');
                const panYEl = document.getElementById('ppPanY');
                const panX = Number(panXEl?.value || 0);
                const panY = Number(panYEl?.value || 0);

                // Filters: Grayscale, Brightness, Contrast, Saturation
                const grayscaleEl = document.getElementById('ppFilterGrayscale');
                const brightnessEl = document.getElementById('ppBrightness');
                const contrastEl = document.getElementById('ppContrast');
                const saturationEl = document.getElementById('ppSaturation');

                const isGrayscale = grayscaleEl?.checked;
                const brightness = Number(brightnessEl?.value || 100);
                const contrast = Number(contrastEl?.value || 100);
                const saturation = Number(saturationEl?.value || 100);

                const filterParts = [];
                if (isGrayscale) filterParts.push('grayscale(100%)');
                if (brightness !== 100) filterParts.push(`brightness(${brightness}%)`);
                if (contrast !== 100) filterParts.push(`contrast(${contrast}%)`);
                if (saturation !== 100) filterParts.push(`saturate(${saturation}%)`);

                v.style.filter = filterParts.length > 0 ? filterParts.join(' ') : 'none';

                // Combine: Base Rotation + Tilt + Scale + Pan
                // translate -> rotate -> scale is typical for image manipulation.
                // Add translateZ(0) to force hardware acceleration and 3D rendering context
                const transform = `translate(${panX}%, ${panY}%) rotate(${deg + tilt}deg) scale(${scale}) translateZ(0)`;
                rotator.style.transform = transform;
                rotator.style.transformOrigin = 'center center';
                
                // Update Scale Indicator
                const indicator = document.getElementById('ppScaleIndicator');
                if (indicator) {
                    indicator.textContent = `${Math.round(scale * 100)}%`;
                    indicator.style.opacity = '1';
                    
                    if (this._scaleIndicatorTimer) clearTimeout(this._scaleIndicatorTimer);
                    this._scaleIndicatorTimer = setTimeout(() => {
                        indicator.style.opacity = '0';
                    }, 1500);
                }
                
                // Force repaint for images
                if (v.tagName === 'IMG') {
                    void rotator.offsetHeight;
                    requestAnimationFrame(() => {
                        rotator.style.willChange = 'transform';
                        requestAnimationFrame(() => {
                            rotator.style.willChange = 'auto';
                        });
                    });
                }
                
                // Hardware acceleration hints
                rotator.style.willChange = 'transform';
                rotator.style.backfaceVisibility = 'hidden';

                // Grayscale Filter
                const bwEl = document.getElementById('ppFilterBw');
                const bw = !!(bwEl && typeof bwEl.checked === 'boolean' && bwEl.checked);
                rotator.style.filter = bw ? 'grayscale(1)' : '';

                // Handle visual text updates
                const tiltVal = document.getElementById('ppTiltVal');
                if (tiltVal) tiltVal.textContent = `${tilt > 0 ? '+' : ''}${tilt} deg`;
                const scaleVal = document.getElementById('ppScaleVal');
                if (scaleVal) scaleVal.textContent = `${Math.round(scale * 100)}%`;
                
                const panXVal = document.getElementById('ppPanXVal');
                if (panXVal) panXVal.textContent = `${panX > 0 ? '+' : ''}${panX}%`;
                const panYVal = document.getElementById('ppPanYVal');
                if (panYVal) panYVal.textContent = `${panY > 0 ? '+' : ''}${panY}%`;

                return {
                    transform,
                    panX,
                    panY,
                    tilt,
                    deg,
                    scale,
                };

                // Render Aspect Ratio Guide (Production Display)
                const guide = document.getElementById('ppAspectGuideBox');
                const aspectSel = document.getElementById('ppAspectSelect');
                if (guide && aspectSel) {
                     const ratio = aspectSel.value;
                     if (ratio === 'none') {
                         guide.style.display = 'none';
                     } else {
                         guide.style.display = 'block';
                         // Reset
                         guide.style.width = ''; guide.style.height = ''; 
                         guide.style.aspectRatio = '';
                         guide.style.borderRadius = '0';
                         
                         // We are simulating "Window Size" or "Card". 
                         if (ratio === 'card') {
                             // Simulate the exact card shown in screenshot: rounded corners, slightly squarish
                             guide.style.aspectRatio = '4/3'; 
                             guide.style.width = '70%'; 
                             guide.style.borderRadius = '16px'; 
                         } else if (ratio === '16:9') {
                             guide.style.aspectRatio = '16/9';
                             guide.style.width = '80%';
                         } else if (ratio === '4:3') {
                             guide.style.aspectRatio = '4/3';
                             guide.style.height = '90%';
                         } else if (ratio === '9:16') {
                             guide.style.aspectRatio = '9/16';
                             guide.style.height = '90%';
                         } else if (ratio === '1:1') {
                             guide.style.aspectRatio = '1/1';
                             guide.style.height = '90%';
                         }
                     }
                }

                // Keep preview bounded and predictable even when rotated (90/270 swaps dimensions).
                v.style.objectFit = 'contain';
                v.style.width = 'auto';
                v.style.height = 'auto';
                v.style.maxHeight = '180px';
                
                const isPortrait = (deg === 90 || deg === 270);
                v.style.maxWidth = isPortrait ? '180px' : '100%';
            },

            bindMediaLoadIndicators() {
                // Editor stage
                const stageMedia = document.getElementById('ppEditorVideo')
                    || document.getElementById('ppVideoPreview')
                    || document.getElementById('ppLocalPreviewVideo');
                const stageLoad = document.getElementById('ppStageLoadOverlay');
                const stageErr = document.getElementById('ppStageErrorOverlay');

                // Live preview
                const liveMedia = document.getElementById('ppPreviewMedia');
                const liveLoad = document.getElementById('ppLiveLoadOverlay');
                const liveErr = document.getElementById('ppLiveErrorOverlay');

                const markLoading = (overlayEl, isLoading) => {
                    if (!overlayEl) return;
                    overlayEl.classList.toggle('is-visible', !!isLoading);
                };
                const markError = (overlayEl, isError) => {
                    if (!overlayEl) return;
                    overlayEl.style.display = isError ? 'flex' : 'none';
                };
                const markReady = (mediaEl, isReady) => {
                    if (!mediaEl) return;
                    mediaEl.classList.add('pp-media-fade');
                    mediaEl.classList.toggle('pp-media-ready', !!isReady);
                };

                const isMediaReadyNow = (mediaEl) => {
                    if (!mediaEl) return false;
                    if (mediaEl.tagName === 'IMG') {
                        return !!(mediaEl.complete && mediaEl.naturalWidth > 0);
                    }
                    if (mediaEl.tagName === 'VIDEO') {
                        return mediaEl.readyState >= 2; // HAVE_CURRENT_DATA
                    }
                    return false;
                };

                // Initial state: show loading until we know otherwise
                markReady(stageMedia, isMediaReadyNow(stageMedia));
                markLoading(stageLoad, !isMediaReadyNow(stageMedia));
                markError(stageErr, false);

                markReady(liveMedia, isMediaReadyNow(liveMedia));
                markLoading(liveLoad, !isMediaReadyNow(liveMedia));
                markError(liveErr, false);

                const bindOne = (mediaEl, loadOverlay, errOverlay, kind) => {
                    if (!mediaEl) return;
                    if (mediaEl.dataset.ppBoundLoad === 'true') return;
                    mediaEl.dataset.ppBoundLoad = 'true';

                    const onReady = () => {
                        markError(errOverlay, false);
                        markLoading(loadOverlay, false);
                        markReady(mediaEl, true);
                    };
                    const onLoading = () => {
                        markError(errOverlay, false);
                        markReady(mediaEl, false);
                        markLoading(loadOverlay, true);
                    };
                    const onError = () => {
                        markLoading(loadOverlay, false);
                        markReady(mediaEl, false);
                        markError(errOverlay, true);
                        console.warn(`[Editor] ${kind} media failed to load`, mediaEl);
                    };

                    if (mediaEl.tagName === 'IMG') {
                        mediaEl.addEventListener('load', onReady);
                        mediaEl.addEventListener('error', onError);
                        // If it was already cached and loaded
                        if (isMediaReadyNow(mediaEl)) onReady();
                        else onLoading();
                    } else if (mediaEl.tagName === 'VIDEO') {
                        mediaEl.addEventListener('loadstart', onLoading);
                        mediaEl.addEventListener('loadeddata', onReady);
                        mediaEl.addEventListener('canplay', onReady);
                        mediaEl.addEventListener('error', onError);
                        if (isMediaReadyNow(mediaEl)) onReady();
                        else onLoading();
                    }
                };

                bindOne(stageMedia, stageLoad, stageErr, 'stage');
                bindOne(liveMedia, liveLoad, liveErr, 'live');
            },

            bindStageDragPan() {
                const stageContainer = document.getElementById('ppStageContainer') || document.querySelector('.pp-stage-container');
                const liveFrame = document.getElementById('ppLivePreviewFrame') || document.querySelector('.pp-preview-frame');
                const panXEl = document.getElementById('ppPanX');
                const panYEl = document.getElementById('ppPanY');
                const showCrossEl = document.getElementById('ppShowCrosshair');
                if (!stageContainer || !panXEl || !panYEl) return;

                // Bind once (stage is sentinel)
                if (stageContainer.dataset.ppBoundDragPan === 'true') return;
                stageContainer.dataset.ppBoundDragPan = 'true';

                const hint = document.getElementById('ppStageDragHint');
                const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
                const minX = Number(panXEl.min || -50);
                const maxX = Number(panXEl.max || 50);
                const minY = Number(panYEl.min || -50);
                const maxY = Number(panYEl.max || 50);

                const isInteractiveTarget = (target) => {
                    if (!target) return false;
                    const el = target;
                    if (el.closest && el.closest('.focal-crosshair')) return true;
                    if (el.closest && el.closest('button, input, select, textarea, label, summary, a')) return true;
                    return false;
                };

                const getCropMode = () => {
                    const stateMode = this.normalizeCropMode(this.state?.cropping?.mode);
                    if (stateMode) return stateMode;
                    const activeBtn = document.querySelector('.crop-mode-btn.active');
                    const dataMode = activeBtn?.getAttribute('data-mode');
                    return this.normalizeCropMode(dataMode);
                };

                // Proof Packs UX: crosshair is always-on for cover/contain (drag-to-reframe).
                // Manual crop uses pan (no crosshair).
                const shouldShowCrosshair = () => showCrossEl ? !!showCrossEl.checked : true;

                const applyPan = (x, y) => {
                    // Apply Safe Zone constraints if Safe Zone is visible
                    const safeZoneOverlay = document.getElementById('ppSafeZoneOverlay');
                    const isSafeZoneActive = safeZoneOverlay && safeZoneOverlay.style.display === 'flex';
                    
                    if (isSafeZoneActive) {
                        const boundaries = this.getSafeZoneBoundaries?.();
                        if (boundaries) {
                            // Calculate constrained pan values
                            // Safe Zone defines the visible area - we need to keep the subject within it
                            // More restrictive constraints for Safe Zone mode
                            const constraintFactor = 0.7; // Allow 70% of normal range
                            const constrainedMinX = minX * constraintFactor;
                            const constrainedMaxX = maxX * constraintFactor;
                            const constrainedMinY = minY * constraintFactor;
                            const constrainedMaxY = maxY * constraintFactor;
                            
                            x = clamp(x, constrainedMinX, constrainedMaxX);
                            y = clamp(y, constrainedMinY, constrainedMaxY);
                            
                            // Visual feedback when near boundary
                            const threshold = 0.85;
                            const isNearBoundary = 
                                Math.abs(x) > (constrainedMaxX * threshold) ||
                                Math.abs(y) > (constrainedMaxY * threshold);
                            
                            const safeZoneRect = document.getElementById('ppSafeZoneRect');
                            if (safeZoneRect) {
                                if (isNearBoundary) {
                                    safeZoneRect.classList.add('boundary-warning');
                                } else {
                                    safeZoneRect.classList.remove('boundary-warning');
                                }
                            }
                        }
                    }
                    
                    panXEl.value = String(x);
                    panYEl.value = String(y);
                    panXEl.dispatchEvent(new Event('input', { bubbles: true }));
                    panYEl.dispatchEvent(new Event('input', { bubbles: true }));
                };

                const applyFocalFromEvent = (container, e) => {
                    const rect = container.getBoundingClientRect();
                    const x = rect.width ? ((e.clientX - rect.left) / rect.width) * 100 : 50;
                    const y = rect.height ? ((e.clientY - rect.top) / rect.height) * 100 : 50;
                    this.applyFocalPercent(x, y);
                };

                const ensureCrosshairVisible = () => {
                    const want = shouldShowCrosshair();
                    this.toggleCrosshair(!!want);
                };

                const bindContainer = (container, kind) => {
                    if (!container) return;
                    if (container.dataset.ppBoundDirectManip === 'true') return;
                    container.dataset.ppBoundDirectManip = 'true';

                    let dragging = false;
                    let mode = 'cover';
                    let startClientX = 0;
                    let startClientY = 0;
                    let startPanX = 0;
                    let startPanY = 0;
                    let raf = 0;
                    let pendingX = 0;
                    let pendingY = 0;

                    const scheduleApplyPan = () => {
                        if (raf) return;
                        raf = requestAnimationFrame(() => {
                            raf = 0;
                            applyPan(pendingX, pendingY);
                        });
                    };

                    const onMove = (e) => {
                        if (!dragging) return;
                        if (mode === 'manual') {
                            const rect = container.getBoundingClientRect();
                            const dx = e.clientX - startClientX;
                            const dy = e.clientY - startClientY;
                            const pctX = rect.width ? (dx / rect.width) * 100 : 0;
                            const pctY = rect.height ? (dy / rect.height) * 100 : 0;
                            
                            console.log(' [DRAG] dx:', dx.toFixed(1), 'dy:', dy.toFixed(1));
                            console.log(' [DRAG] pctX:', pctX.toFixed(2), 'pctY:', pctY.toFixed(2));
                            console.log(' [DRAG] startPanX:', startPanX, 'startPanY:', startPanY);
                            console.log(' [DRAG] minX:', minX, 'maxX:', maxX, 'minY:', minY, 'maxY:', maxY);
                            
                            pendingX = clamp(Math.round(startPanX + pctX), minX, maxX);
                            pendingY = clamp(Math.round(startPanY + pctY), minY, maxY);
                            
                            console.log(' [DRAG] pendingX:', pendingX, 'pendingY:', pendingY);
                            console.log(' [DRAG] Vertical movement working?', pendingY !== startPanY);
                            
                            scheduleApplyPan();
                        } else {
                            applyFocalFromEvent(container, e);
                            ensureCrosshairVisible();
                        }
                    };

                    const endDrag = () => {
                        dragging = false;
                        container.classList.remove('is-dragging');
                        try { container.releasePointerCapture?.(container._ppPointerId); } catch { /* ignore */ }
                        container._ppPointerId = null;
                    };

                    container.addEventListener('pointerdown', (e) => {
                        if (e.button !== 0) return;
                        if (isInteractiveTarget(e.target)) return;
                        if (e.ctrlKey || e.metaKey) return;

                        mode = getCropMode();
                        dragging = true;
                        startClientX = e.clientX;
                        startClientY = e.clientY;
                        startPanX = Number(panXEl.value || 0);
                        startPanY = Number(panYEl.value || 0);
                        container.classList.add('is-dragging');

                        container._ppPointerId = e.pointerId;
                        try { container.setPointerCapture(e.pointerId); } catch { /* ignore */ }
                        e.preventDefault();

                        if (mode !== 'manual') {
                            applyFocalFromEvent(container, e);
                            ensureCrosshairVisible();
                        } else if (kind === 'stage' && hint) {
                            hint.style.opacity = '0';
                        }
                    });

                    container.addEventListener('pointermove', onMove);
                    container.addEventListener('pointerup', endDrag);
                    container.addEventListener('pointercancel', endDrag);
                    container.addEventListener('lostpointercapture', endDrag);

                    container.addEventListener('dblclick', (e) => {
                        if (isInteractiveTarget(e.target)) return;
                        const m = getCropMode();
                        if (m === 'manual') {
                            applyPan(0, 0);
                            this.showToastDebounced('Position reset', 'info', 'pan-reset', 800);
                        } else {
                            this.applyFocalPercent(50, 50);
                            ensureCrosshairVisible();
                            this.showToastDebounced('Focal reset', 'info', 'focal-reset', 800);
                        }
                    });
                };

                bindContainer(stageContainer, 'stage');
                bindContainer(liveFrame, 'live');

                // Keep hint accurate when crop mode changes
                if (typeof this.updateStageDragHint === 'function') {
                    this.updateStageDragHint();
                    document.querySelectorAll('.crop-mode-btn').forEach(b => {
                        if (b.dataset.ppBoundHint === 'true') return;
                        b.dataset.ppBoundHint = 'true';
                        b.addEventListener('click', () => this.updateStageDragHint());
                    });
                }

                // Legacy checkbox removed (drag-first UX)
            },

            startContinuousRepaint(videoElement) {
                // REMOVED: Continuous repaint was killing performance
                // Modern browsers handle transform rendering efficiently without manual repaints
                // The aggressive requestAnimationFrame loop was causing stuttering, not fixing it
            },

            stopContinuousRepaint(videoElement) {
                // REMOVED: No-op since continuous repaint is disabled
            },

            startFreezeDetection(videoElement) {
                // REMOVED: Freeze detection was interrupting smooth playback
                // The pause/play recovery attempts caused more stuttering than they fixed
                // Browser's native playback handling is more reliable
            },

            stopFreezeDetection(videoElement) {
                // REMOVED: No-op since freeze detection is disabled
            },

            formatTimeSec(sec) {
                const s = Number(sec);
                if (!Number.isFinite(s) || s < 0) return '0:00';
                const total = Math.floor(s);
                const m = Math.floor(total / 60);
                const r = total % 60;
                return `${m}:${String(r).padStart(2, '0')}`;
            },

            initTrimTimeline(durationSec) {
                const startHandle = document.getElementById('ppTrimStartHandle');
                const endHandle = document.getElementById('ppTrimEndHandle');
                const startLabel = document.getElementById('ppTrimStartLabel');
                const endLabel = document.getElementById('ppTrimEndLabel');
                const startInput = document.getElementById('ppTrimStartSec');
                const endInput = document.getElementById('ppTrimEndSec');

                const dur = Number(durationSec);
                if (!startHandle || !endHandle || !startLabel || !endLabel || !startInput || !endInput) return;
                if (!Number.isFinite(dur) || dur <= 0) return;

                const durMs = Math.max(0, Math.floor(dur * 1000));
                startHandle.max = String(durMs);
                endHandle.max = String(durMs);

                const parseStored = (raw) => {
                    const s = String(raw ?? '').trim();
                    if (!s) return null;
                    const n = Number(s);
                    return Number.isFinite(n) ? n : null;
                };

                const storedStart = parseStored(this.safeGetItem(this.storageKeys.trimStartSec));
                const storedEnd = parseStored(this.safeGetItem(this.storageKeys.trimEndSec));

                const startSec = storedStart !== null ? Math.max(0, Math.min(dur, storedStart)) : 0;
                const endSec = storedEnd !== null ? Math.max(0, Math.min(dur, storedEnd)) : dur;

                startHandle.value = String(Math.floor(startSec * 1000));
                endHandle.value = String(Math.floor(endSec * 1000));

                // Apply to hidden inputs + labels
                startInput.value = storedStart !== null ? String(startSec.toFixed(1)) : '';
                endInput.value = storedEnd !== null ? String(endSec.toFixed(1)) : '';
                startLabel.textContent = this.formatTimeSec(startSec);
                endLabel.textContent = (storedEnd !== null && endSec < dur - 0.05) ? this.formatTimeSec(endSec) : 'end';
            },

            bindTrimTimeline(videoEl) {
                const startHandle = document.getElementById('ppTrimStartHandle');
                const endHandle = document.getElementById('ppTrimEndHandle');
                const startLabel = document.getElementById('ppTrimStartLabel');
                const endLabel = document.getElementById('ppTrimEndLabel');
                const startInput = document.getElementById('ppTrimStartSec');
                const endInput = document.getElementById('ppTrimEndSec');
                if (!startHandle || !endHandle || !startLabel || !endLabel || !startInput || !endInput) return;

                if (startHandle.dataset.bound === 'true') return;
                startHandle.dataset.bound = 'true';
                endHandle.dataset.bound = 'true';

                const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

                const sync = (which) => {
                    const dur = Number.isFinite(videoEl?.duration) ? videoEl.duration : 0;
                    const durMs = Math.max(0, Math.floor(dur * 1000));
                    if (durMs <= 0) return;

                    const gapMs = 100; // 0.1s minimum
                    let sMs = clamp(Number(startHandle.value || '0'), 0, durMs);
                    let eMs = clamp(Number(endHandle.value || String(durMs)), 0, durMs);

                    if (which === 'start' && sMs > eMs - gapMs) sMs = Math.max(0, eMs - gapMs);
                    if (which === 'end' && eMs < sMs + gapMs) eMs = Math.min(durMs, sMs + gapMs);

                    startHandle.value = String(sMs);
                    endHandle.value = String(eMs);

                    const sSec = sMs / 1000;
                    const eSec = eMs / 1000;

                    // Treat full-range as "no trim" (so we don't force conversion).
                    const nearStart = sSec <= 0.05;
                    const nearEnd = (dur - eSec) <= 0.05;

                    const startVal = nearStart ? '' : String(sSec.toFixed(1));
                    const endVal = nearEnd ? '' : String(eSec.toFixed(1));

                    startInput.value = startVal;
                    endInput.value = endVal;

                    this.safeSetItem(this.storageKeys.trimStartSec, startVal);
                    this.safeSetItem(this.storageKeys.trimEndSec, endVal);

                    startLabel.textContent = this.formatTimeSec(sSec);
                    endLabel.textContent = nearEnd ? 'end' : this.formatTimeSec(eSec);

                    // Nudge playback into range while scrubbing
                    try {
                        if (Number.isFinite(videoEl.currentTime)) {
                            if (!nearStart && videoEl.currentTime < sSec) videoEl.currentTime = sSec;
                            if (!nearEnd && videoEl.currentTime > eSec) videoEl.currentTime = sSec;
                        }
                    } catch {
                        // ignore
                    }
                };

                startHandle.addEventListener('input', () => {
                    sync('start');
                    this.updateAdvice();
                });
                endHandle.addEventListener('input', () => {
                    sync('end');
                    this.updateAdvice();
                });
            },

            bindPreviewEditor() {
                const v = document.getElementById('ppEditorVideo') || document.getElementById('ppLocalPreviewVideo');
                if (!v) return;

                // Mark as bound to prevent duplicate bindings (optional, but good practice)
                v.dataset.boundPreview = 'true';

                // --- 1. Control & Element Lookup ---
                // Basic Controls
                const playBtn = document.getElementById('ppPreviewPlayPause');
                const timeEl = document.getElementById('ppPreviewTime');
                
                // Timeline / Scrubbing Controls (Unified)
                const timeline = document.querySelector('.pp-timeline-pro');
                const rangeEl = document.getElementById('ppTrimRange');
                const playheadEl = document.getElementById('ppPlayhead');
                const handleStartEl = document.getElementById('ppTrimHandleStart');
                const handleEndEl = document.getElementById('ppTrimHandleEnd');
                const ticksEl = document.getElementById('ppTimelineMarkers');
                const labelsEl = null;

                // Legacy / Optional Controls
                const rotateLeftBtn = document.getElementById('ppRotateLeft');
                const rotateRightBtn = document.getElementById('ppRotateRight');
                const seek = document.getElementById('ppVideoSeek'); 
                const startInput = document.getElementById('ppTrimStartSec');
                const endInput = document.getElementById('ppTrimEndSec');

                const isVideo = v.tagName === 'VIDEO';
                const isImage = v.tagName === 'IMG';

                // --- 2. Input/Image State Handling ---
                if (isImage) {
                    if (playBtn) playBtn.style.display = 'none';
                    if (timeEl) timeEl.style.display = 'none';
                    return;
                }

                // Wait for metadata if needed
                if (isVideo && v.readyState < 1) {
                    console.warn('[Editor] Video metadata not loaded yet, waiting...');
                    v.addEventListener('loadedmetadata', () => this.bindPreviewEditor(), { once: true });
                    return;
                }

                // Initial Playback (Autoplay)
                // We do this immediately but safely catch errors
                if (isVideo) {
                    v.play().catch(() => { /* ignore autoplay blocks */ });
                }

                // --- 3. State & Helpers ---
                let isScrubbing = false;
                let playbackPending = false;
                let lastPlaybackError = null;
                let lastEnforcementTime = 0;

                const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
                const getDuration = () => (Number.isFinite(v.duration) ? v.duration : 0);

                // Helper: Trim preferences
                const readTrim = () => {
                    const startRaw = String(this.getTrimStartSecPreference() || '').trim();
                    const endRaw = String(this.getTrimEndSecPreference() || '').trim();
                    const start = startRaw ? Number(startRaw) : 0;
                    const end = endRaw ? Number(endRaw) : null;
                    return {
                        start: Number.isFinite(start) ? Math.max(0, start) : 0,
                        end: (end !== null && Number.isFinite(end)) ? Math.max(0, end) : null,
                    };
                };
                this.readTrim = readTrim; // Expose for other methods

                // Helper: Set trim inputs (if they exist) and storage
                const setTrimWindow = (startSecRaw, endSecRaw) => {
                    const dur = getDuration();
                    if (dur <= 0) return;

                    let startSec = Number(startSecRaw) || 0;
                    let endSec = Number(endSecRaw);
                    if (!Number.isFinite(endSec)) endSec = dur;

                    // Minimum gap logic
                    const gap = dur < 5 ? 0.05 : (dur < 10 ? 0.08 : 0.1);
                    startSec = clamp(startSec, 0, dur);
                    endSec = clamp(endSec, 0, dur);
                    if (startSec > endSec - gap) startSec = Math.max(0, endSec - gap);
                    if (endSec < startSec + gap) endSec = Math.min(dur, startSec + gap);

                    const nearStart = startSec <= 0.05;
                    const nearEnd = (dur - endSec) <= 0.05;
                    const startVal = nearStart ? '' : String(startSec.toFixed(1));
                    const endVal = nearEnd ? '' : String(endSec.toFixed(1));

                    if (startInput) startInput.value = startVal;
                    if (endInput) endInput.value = endVal;
                    
                    this.safeSetItem(this.storageKeys.trimStartSec, startVal);
                    this.safeSetItem(this.storageKeys.trimEndSec, endVal);
                    this.updateAdvice();
                };

                // Helper: Update Timeline Visuals
                const updateUnifiedTimelineUi = () => {
                    if (!timeline || !rangeEl || !playheadEl || !handleStartEl || !handleEndEl) return;
                    const dur = getDuration();
                    if (dur <= 0) return;

                    const cur = Number.isFinite(v.currentTime) ? v.currentTime : 0;
                    const { start, end } = readTrim();
                    const endSec = (end === null) ? dur : Math.min(dur, end);
                    const startSec = Math.min(dur, Math.max(0, start));

                    const pct = (sec) => `${clamp((sec / dur) * 100, 0, 100)}%`;
                    const startPct = clamp((startSec / dur) * 100, 0, 100);
                    const endPct = clamp((endSec / dur) * 100, 0, 100);

                    rangeEl.style.left = `${startPct}%`;
                    rangeEl.style.width = `${Math.max(0, endPct - startPct)}%`;
                    playheadEl.style.left = pct(cur);
                    handleStartEl.style.left = `calc(${startPct}% - 5px)`;
                    handleEndEl.style.left = `calc(${endPct}% - 5px)`;
                };

                // Helper: Sync UI (Controls + Timeline)
                const syncUi = () => {
                    const dur = Number.isFinite(v.duration) ? v.duration : 0;
                    const cur = Number.isFinite(v.currentTime) ? v.currentTime : 0;
                    
                    // Update Time Text
                    if (timeEl) {
                        timeEl.textContent = `${this.formatTimeSec(cur)} / ${this.formatTimeSec(dur)}`;
                    }

                    // Update Legacy Seek (if exists)
                    if (seek && !isScrubbing) {
                        seek.max = String(Math.max(0, Math.floor(dur * 1000)));
                        seek.value = String(Math.max(0, Math.floor(cur * 1000)));
                    }
                    
                    // Update Play Button State
                    if (playBtn) {
                        if (playbackPending) {
                            playBtn.textContent = '\u23F3'; // Hourglass
                            playBtn.title = 'Loading...';
                            playBtn.disabled = true;
                        } else {
                            playBtn.textContent = v.paused ? '\u25B6' : '\u23F8'; // Play / Pause
                            playBtn.title = v.paused ? 'Play (Space)' : 'Pause (Space)';
                            playBtn.disabled = false;
                            playBtn.style.color = (lastPlaybackError && v.paused) ? '#dc3545' : '';
                        }
                    }
                    
                    updateUnifiedTimelineUi();
                };

                // Helper: Enforce Trim Loop
                const enforceTrimLoop = () => {
                   if (isScrubbing || playbackPending) return;
                    const now = Date.now();
                    if (now - lastEnforcementTime < 100) return; // Throttle
                    lastEnforcementTime = now;

                    const { start, end } = readTrim();
                    const dur = getDuration();
                    const cur = Number.isFinite(v.currentTime) ? v.currentTime : 0;
                    
                    const hasRealTrim = (start > 0.1) || (end !== null && end < dur - 0.1);
                    const isShortVideo = dur > 0 && dur <= 6;
                    
                    // Short video optimization: use native looping if no trim is set
                    if (isShortVideo && !hasRealTrim) {
                        if (!v.loop) v.loop = true;
                        return;
                    }
                    
                    if (hasRealTrim) v.loop = false;
                    
                    // Loop enforcement
                    const tolerance = dur < 10 ? 0.15 : 0.05;
                    if (start > 0 && cur < start - tolerance) {
                         v.currentTime = start;
                    }
                    if (end !== null && cur > end + tolerance) {
                         v.currentTime = start;
                    }
                };

                // --- 4. Logic Implementation ---
                                
                // Bind window resize (Singleton)
                if (!window._ppResizeListenerBound) {
                    window.addEventListener('resize', () => {
                        if (this.resizeVideoToFitStage) this.resizeVideoToFitStage();
                    });
                    window._ppResizeListenerBound = true;
                }

                const syncTrimHandlesFromInputs = () => {
                    const startHandle = document.getElementById('ppTrimStartHandle');
                    const endHandle = document.getElementById('ppTrimEndHandle');
                    if (!startHandle || !endHandle) return;
                    const dur = getDuration();
                    if (dur <= 0) return;

                    const startRaw = String(this.getTrimStartSecPreference() || '').trim();
                    const endRaw = String(this.getTrimEndSecPreference() || '').trim();
                    const s = startRaw ? Number(startRaw) : 0;
                    const e = endRaw ? Number(endRaw) : dur;
                    const startSec = Number.isFinite(s) ? Math.max(0, Math.min(dur, s)) : 0;
                    const endSec = Number.isFinite(e) ? Math.max(0, Math.min(dur, e)) : dur;

                    startHandle.value = String(Math.floor(startSec * 1000));
                    endHandle.value = String(Math.floor(endSec * 1000));
                    startHandle.dispatchEvent(new Event('input'));
                    endHandle.dispatchEvent(new Event('input'));
                };

                const renderTicks = () => {
                    if (!timeline || !ticksEl) return;
                    const dur = getDuration();
                    if (!Number.isFinite(dur) || dur <= 0) return;

                    const chooseStep = (seconds) => {
                        const candidates = [0.5, 1, 2, 5, 10, 15, 30, 60, 120, 300];
                        for (const c of candidates) {
                            if (seconds / c <= 10) return c;
                        }
                        return candidates[candidates.length - 1];
                    };

                    const major = chooseStep(dur);
                    const minor = major >= 2 ? major / 2 : major;

                    const line = (leftPct, alpha) => (
                        `<div style="position:absolute; left:${leftPct}%; top:0; bottom:0; width:1px; background: rgba(0,0,0,${alpha});"></div>`
                    );

                    const label = (leftPct, text, align) => {
                        const xform = align === 'left' ? 'translateX(0)' : (align === 'right' ? 'translateX(-100%)' : 'translateX(-50%)');
                        return (
                            `<div style="position:absolute; left:${leftPct}%; top:0; transform:${xform};">${this.escapeHtml(text)}</div>`
                        );
                    };

                    const parts = [];

                    // Minor ticks
                    if (minor > 0 && minor !== major) {
                        for (let t = 0; t <= dur + 0.001; t += minor) {
                            const nearMajor = Math.abs((t / major) - Math.round(t / major)) < 0.001;
                            if (nearMajor) continue;
                            const pct = clamp((t / dur) * 100, 0, 100);
                            parts.push(line(pct, 0.10));
                        }
                    }

                    // Major ticks
                    for (let t = 0; t <= dur + 0.001; t += major) {
                        const pct = clamp((t / dur) * 100, 0, 100);
                        parts.push(line(pct, 0.22));
                    }

                    ticksEl.innerHTML = parts.join('');

                    if (labelsEl) {
                        const labels = [];
                        labels.push(label(0, this.formatTimeSec(0), 'left'));

                        const maxInterior = 3;
                        const candidates = [];
                        for (let t = major; t < dur - 0.001; t += major) candidates.push(t);
                        if (candidates.length <= maxInterior) {
                            for (const t of candidates) {
                                const pct = clamp((t / dur) * 100, 0, 100);
                                labels.push(label(pct, this.formatTimeSec(t), 'center'));
                            }
                        } else {
                            const points = [0.25, 0.5, 0.75];
                            for (const p of points) {
                                const t = dur * p;
                                const pct = clamp(p * 100, 0, 100);
                                labels.push(label(pct, this.formatTimeSec(t), 'center'));
                            }
                        }

                        labels.push(label(100, this.formatTimeSec(dur), 'right'));
                        labelsEl.innerHTML = labels.join('');
                    }
                };

                const bindUnifiedTimeline = () => {
                    if (!timeline || !rangeEl || !playheadEl || !handleStartEl || !handleEndEl) return;
                    if (timeline.dataset.bound === 'true') return;
                    timeline.dataset.bound = 'true';

                    let dragMode = null; // 'playhead' | 'start' | 'end'
                    let activePointer = null;

                    const getPctFromEvent = (ev) => {
                        const rect = timeline.getBoundingClientRect();
                        const x = (ev.clientX - rect.left);
                        return rect.width > 0 ? clamp(x / rect.width, 0, 1) : 0;
                    };

                    const applyDrag = (ev) => {
                        if (!dragMode || activePointer === null || ev.pointerId !== activePointer) return;
                        const dur = getDuration();
                        if (!Number.isFinite(dur) || dur <= 0) return;

                        const pct = getPctFromEvent(ev);
                        const t = pct * dur;

                        if (dragMode === 'playhead') {
                            isScrubbing = true;
                            try { v.currentTime = t; } catch { /* ignore */ }
                            syncUi();
                            return;
                        }

                        const { start, end } = readTrim();
                        const endSecCurrent = (end === null) ? dur : end;
                        // Dynamic gap based on video duration
                        const gap = dur < 5 ? 0.05 : (dur < 10 ? 0.08 : 0.1);
                        if (dragMode === 'start') {
                            const nextStart = Math.min(Math.max(0, t), endSecCurrent - gap);
                            setTrimWindow(nextStart, endSecCurrent);
                        }
                        if (dragMode === 'end') {
                            const nextEnd = Math.max(Math.min(dur, t), start + gap);
                            setTrimWindow(start, nextEnd);
                        }
                        enforceTrimLoop();
                        syncUi();
                    };

                    const endDrag = (ev) => {
                        if (activePointer === null || ev.pointerId !== activePointer) return;
                        dragMode = null;
                        activePointer = null;
                        isScrubbing = false;
                        enforceTrimLoop();
                        syncUi();
                        try { timeline.releasePointerCapture(ev.pointerId); } catch { /* ignore */ }
                    };

                    const startDrag = (mode, ev) => {
                        dragMode = mode;
                        activePointer = ev.pointerId;
                        try { timeline.setPointerCapture(ev.pointerId); } catch { /* ignore */ }
                        ev.preventDefault();
                        applyDrag(ev);
                    };

                    timeline.addEventListener('pointerdown', (ev) => startDrag('playhead', ev));
                    handleStartEl.addEventListener('pointerdown', (ev) => {
                        ev.stopPropagation();
                        startDrag('start', ev);
                    });
                    handleEndEl.addEventListener('pointerdown', (ev) => {
                        ev.stopPropagation();
                        startDrag('end', ev);
                    });

                    timeline.addEventListener('pointermove', applyDrag);
                    timeline.addEventListener('pointerup', endDrag);
                    timeline.addEventListener('pointercancel', endDrag);
                };

                v.addEventListener('loadedmetadata', () => {
                    // If the user already set a start, snap to it.
                    const { start } = readTrim();
                    if (start > 0 && Number.isFinite(v.duration) && start < v.duration) {
                        try { v.currentTime = start; } catch { /* ignore */ }
                    }

                    this.initTrimTimeline(v.duration);
                    this.bindTrimTimeline(v);

                    // Unified editor timeline (if present)
                    renderTicks();
                    bindUnifiedTimeline();

                    syncUi();
                });
                
                let lastTimeupdateCall = 0;
                let timeupdateCount = 0;
                v.addEventListener('timeupdate', () => {
                    const now = Date.now();
                    // Throttle timeupdate processing to every 50ms for smoother playback
                    if (now - lastTimeupdateCall < 50) return;
                    lastTimeupdateCall = now;
                    
                    timeupdateCount++;
                    if (timeupdateCount <= 5) {
                        console.log('[ProofPacks] Timeupdate #' + timeupdateCount + ' currentTime:', v.currentTime, 'paused:', v.paused);
                    }
                    
                    enforceTrimLoop();
                    syncUi();
                });
                
                // Handle all playback state changes
                v.addEventListener('play', () => {
                    console.log('[ProofPacks] Video PLAY event fired');
                    playbackPending = false;
                    lastPlaybackError = null;
                    
                    // REMOVED: Continuous repaint and freeze detection
                    // These aggressive workarounds were causing stuttering, not fixing it
                    // Modern browsers handle transformed video playback efficiently
                    
                    syncUi();
                });
                
                v.addEventListener('pause', () => {
                    console.log('[ProofPacks] Video PAUSE event fired');
                    playbackPending = false;
                    syncUi();
                });
                
                v.addEventListener('error', (e) => {
                    playbackPending = false;
                    const errMsg = v.error ? `Video error: ${v.error.code} - ${v.error.message}` : 'Unknown playback error';
                    lastPlaybackError = errMsg;
                    console.error('[ProofPacks] Video playback error:', errMsg, e);
                    syncUi();
                    this.showToast(errMsg, 'error');
                });
                
                v.addEventListener('ended', () => {
                    console.log('[ProofPacks] Video ended');
                    
                    // FIX 3: Prevent 'ended' event from stopping short videos
                    const dur = getDuration();
                    const isShortVideo = dur > 0 && dur <= 6;
                    
                    if (isShortVideo && v.loop) {
                        // Browser should auto-restart, but force it if needed
                        console.log('[Editor] Short video ended, restarting via loop');
                        v.currentTime = 0;
                        v.play().catch(err => {
                            console.warn('[Editor] Loop restart failed:', err);
                        });
                    }
                    
                    syncUi();
                });
                
                v.addEventListener('stalled', () => {
                    console.warn('[ProofPacks] Video playback stalled');
                });
                
                v.addEventListener('waiting', () => {
                    playbackPending = true;
                    syncUi();
                });
                
                v.addEventListener('canplay', () => {
                    if (playbackPending && !v.paused) {
                        playbackPending = false;
                        syncUi();
                    }
                });

                playBtn.addEventListener('click', async () => {
                    const dur = getDuration();
                    const isShortVideo = dur > 0 && dur <= 6;
                    
                    console.log('[ProofPacks] Play button clicked.', {
                        paused: v.paused,
                        readyState: v.readyState,
                        duration: dur.toFixed(2) + 's',
                        isShortVideo,
                        dimensions: `${v.videoWidth}x${v.videoHeight}`
                    });
                    
                    if (playbackPending) {
                        console.warn('[ProofPacks] Playback operation already pending');
                        return;
                    }
                    
                    if (v.paused) {
                        playbackPending = true;
                        
                        // FIX 1: For short videos, enable native loop immediately
                        const { start, end } = readTrim();
                        const hasRealTrim = (start > 0.1) || (end !== null && end < dur - 0.1);
                        
                        // CRITICAL: Always enable loop for short videos unless user explicitly set trim
                        if (isShortVideo && !hasRealTrim) {
                            v.loop = true;
                            console.log(`[Editor] Short video (${dur.toFixed(2)}s) - loop enabled`);
                        } else {
                            v.loop = false;
                            console.log(`[Editor] Loop disabled (hasRealTrim: ${hasRealTrim}, start: ${start}, end: ${end})`);
                        }
                        
                        // CRITICAL: Reset to start if at the end, BEFORE calling play()
                        const effectiveStart = hasRealTrim ? (start || 0) : 0;
                        const effectiveEnd = hasRealTrim ? (end === null ? dur : end) : dur;
                        
                        if (Number.isFinite(v.currentTime) && v.currentTime >= effectiveEnd - 0.1) {
                            console.log(`[Editor] Video at end (${v.currentTime.toFixed(2)}s), resetting to ${effectiveStart.toFixed(2)}s`);
                            v.currentTime = effectiveStart;
                        }
                        
                        try {
                            console.log('[ProofPacks] Calling v.play()...');
                            const playPromise = v.play();
                            if (playPromise !== undefined) {
                                await playPromise;
                                console.log('[Editor] Playback started via user gesture');
                                
                                // Remove pulse hint if present
                                playBtn.classList.remove('pp-pulse-hint');
                            }
                            playbackPending = false;
                            lastPlaybackError = null;
                        } catch (err) {
                            playbackPending = false;
                            console.error('[ProofPacks] Play failed:', err);
                            const errMsg = err.name || err.message || String(err);
                            
                            if (errMsg.includes('NotAllowedError')) {
                                this.showToast('Click the page first, then try play', 'warning');
                                playBtn.classList.add('pp-pulse-hint');
                            } else if (errMsg.includes('NotSupportedError')) {
                                this.showToast('Video format not supported', 'error');
                                lastPlaybackError = 'Unsupported format';
                            } else if (!errMsg.includes('AbortError')) {
                                this.showToast(`Play failed: ${errMsg}`, 'error');
                                lastPlaybackError = errMsg;
                            }
                        } finally {
                            syncUi();
                        }
                    } else {
                        v.pause();
                        playbackPending = false;
                        syncUi();
                    }
                });

                if (rotateLeftBtn) {
                    rotateLeftBtn.addEventListener('click', () => {
                        const rotateEl = document.getElementById('ppVideoRotate');
                        if (!rotateEl) return;
                        const current = Number(rotateEl.value || '0');
                        const next = (current + 270) % 360;
                        rotateEl.value = String(next);
                        this.applyLocalPreviewRotation();
                    });
                }

                if (rotateRightBtn) {
                    rotateRightBtn.addEventListener('click', () => {
                        const rotateEl = document.getElementById('ppVideoRotate');
                        if (!rotateEl) return;
                        const current = Number(rotateEl.value || '0');
                        const next = (current + 90) % 360;
                        rotateEl.value = String(next);
                        this.applyLocalPreviewRotation();
                    });
                }

                if (seek) {
                    seek.addEventListener('input', () => {
                        isScrubbing = true;
                        const ms = Number(seek.value || '0');
                        const t = Number.isFinite(ms) ? ms / 1000 : 0;
                        try { v.currentTime = t; } catch { /* ignore */ }
                        syncUi();
                    });
                    seek.addEventListener('change', () => {
                        isScrubbing = false;
                        enforceTrimLoop();
                        syncUi();
                    });
                }


                // Wired Geometry Controls
                const tiltInput = document.getElementById('ppTiltDeg');
                if (tiltInput) {
                    tiltInput.addEventListener('input', () => this.applyLocalPreviewRotation());
                }
                const scaleInput = document.getElementById('ppScalePct');
                if (scaleInput) {
                    scaleInput.addEventListener('input', () => this.applyLocalPreviewRotation());
                }
                const panXInput = document.getElementById('ppPanX');
                if (panXInput) {
                    panXInput.addEventListener('input', () => this.applyLocalPreviewRotation());
                }
                const panYInput = document.getElementById('ppPanY');
                if (panYInput) {
                    panYInput.addEventListener('input', () => this.applyLocalPreviewRotation());
                }
                const aspectSelect = document.getElementById('ppAspectSelect');
                if (aspectSelect) {
                    aspectSelect.addEventListener('change', () => this.applyLocalPreviewRotation());
                }
                const grayscaleInput = document.getElementById('ppFilterGrayscale');
                if (grayscaleInput) {
                    grayscaleInput.addEventListener('change', () => this.applyLocalPreviewRotation());
                }

                // Initial paint
                syncUi();
                this.applyLocalPreviewRotation();
                
                // FIX 5 & 6: Debug logging and health monitoring for short videos
                const dur = getDuration();
                const isShortVideo = dur > 0 && dur <= 6;
                
                if (isShortVideo) {
                    this.debugShortVideoPlayback(v);
                    this.monitorPlaybackHealth(v);
                    
                    console.log(`[Editor] Video loaded: ${dur.toFixed(2)}s`, {
                        isShortVideo: true,
                        dimensions: `${v.videoWidth}x${v.videoHeight}`,
                        readyState: v.readyState
                    });
                }
            },
            
            // FIX 5: Debug logging for short videos
            debugShortVideoPlayback(video) {
                if (!video || video.duration > 6) return;
                
                const startTime = performance.now();
                const events = [
                    'loadstart', 'loadedmetadata', 'loadeddata', 'canplay', 'canplaythrough',
                    'play', 'playing', 'pause', 'ended', 'waiting', 'stalled', 'suspend'
                ];
                
                events.forEach(eventName => {
                    video.addEventListener(eventName, () => {
                        const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
                        console.log(`[Editor] ${elapsed}s - ${eventName}`, {
                            currentTime: video.currentTime.toFixed(2),
                            duration: video.duration.toFixed(2),
                            paused: video.paused,
                            ended: video.ended,
                            loop: video.loop,
                            readyState: video.readyState
                        });
                    });
                });
            },
            
            // FIX 6: Monitor playback health and auto-recover from stalls
            monitorPlaybackHealth(video) {
                if (!video) return;
                
                let lastCurrentTime = video.currentTime;
                let stuckCounter = 0;
                
                const healthCheck = setInterval(() => {
                    // Stop monitoring if video unloaded
                    if (!video.src || video.src === '') {
                        clearInterval(healthCheck);
                        return;
                    }
                    
                    // Only check if video should be playing
                    if (!video.paused && video.currentTime === lastCurrentTime) {
                        stuckCounter++;
                        console.warn(`[Editor] Playback stuck (${stuckCounter}/3)`, {
                            currentTime: video.currentTime.toFixed(2),
                            duration: video.duration.toFixed(2),
                            readyState: video.readyState,
                            networkState: video.networkState,
                            loop: video.loop
                        });
                        
                        if (stuckCounter >= 3) {
                            console.error('[Editor] Playback critically stuck, forcing recovery');
                            // Try nudging playhead slightly
                            video.currentTime = Math.min(video.currentTime + 0.1, video.duration - 0.1);
                            video.play().catch(err => {
                                console.error('[Editor] Recovery play failed:', err);
                            });
                            stuckCounter = 0;
                        }
                    } else {
                        // Playback is healthy, reset counter
                        if (stuckCounter > 0) {
                            console.log('[Editor] Playback recovered');
                        }
                        stuckCounter = 0;
                    }
                    
                    lastCurrentTime = video.currentTime;
                }, 1000);
                
                // Store interval ID on video element for cleanup
                if (video._healthCheckInterval) {
                    clearInterval(video._healthCheckInterval);
                }
                video._healthCheckInterval = healthCheck;
            },

            validateTrimWindow({ media_kind, duration_seconds } = {}) {
                if (String(media_kind || '') !== 'video') {
                    return { ok: true, startSec: '', endSec: '' };
                }

                const startRaw = String(this.getTrimStartSecPreference() || '').trim();
                const endRaw = String(this.getTrimEndSecPreference() || '').trim();
                const parse = (v) => {
                    if (!v) return null;
                    const n = Number(v);
                    return Number.isFinite(n) ? n : NaN;
                };
                const start = parse(startRaw);
                const end = parse(endRaw);

                if (startRaw && !Number.isFinite(start)) return { ok: false, error: 'Trim start must be a number.' };
                if (endRaw && !Number.isFinite(end)) return { ok: false, error: 'Trim end must be a number.' };

                const startSec = start === null ? 0 : Math.max(0, start);
                const endSec = end === null ? null : Math.max(0, end);

                if (endSec !== null && endSec <= startSec) {
                    return { ok: false, error: 'Trim end must be greater than trim start.' };
                }

                if (typeof duration_seconds === 'number' && Number.isFinite(duration_seconds)) {
                    if (startSec > duration_seconds) return { ok: false, error: 'Trim start exceeds video duration.' };
                    if (endSec !== null && endSec > duration_seconds + 0.01) return { ok: false, error: 'Trim end exceeds video duration.' };
                }

                return { ok: true, startSec: startRaw, endSec: endRaw };
            },

            formatAge(ts) {
                const n = Number(ts || 0);
                if (!Number.isFinite(n) || n <= 0) return '';
                const deltaMs = Date.now() - n;
                const mins = Math.floor(deltaMs / (60 * 1000));
                if (mins < 1) return 'just now';
                if (mins < 60) return `${mins}m ago`;
                const hrs = Math.floor(mins / 60);
                if (hrs < 24) return `${hrs}h ago`;
                const days = Math.floor(hrs / 24);
                return `${days}d ago`;
            },

            countMedia(items, { visibleOnly } = {}) {
                const list = Array.isArray(items) ? items : [];
                const eligible = visibleOnly ? list.filter(a => a?.is_visible !== false) : list;
                const videos = eligible.filter(a => String(a?.media_kind || '') === 'video').length;
                const photos = eligible.filter(a => String(a?.media_kind || '') === 'photo').length;
                return { videos, photos, total: eligible.length };
            },

            getConfig() {
                const urlEl = document.getElementById('ppBackendUrl');
                const keyEl = document.getElementById('ppAdminKey');

                const storedUrl = (() => {
                    try { return localStorage.getItem(this.storageKeys.backendUrl) || ''; } catch { return ''; }
                })();
                const storedKey = (() => {
                    try { return localStorage.getItem(this.storageKeys.adminKey) || ''; } catch { return ''; }
                })();

                // Hosted congruence: when served from portal/vercel, force same-origin so rewrites can proxy.
                // This prevents CORS failures that can break Library load.
                let base = '';
                if (typeof isPortalHosted === 'function' && isPortalHosted()) {
                    base = String(location.origin || '').trim();
                    if (urlEl && !String(urlEl.value || '').trim()) urlEl.value = base;
                } else {
                    const raw = (urlEl?.value || storedUrl || DEFAULT_API_HOST || '').trim();
                    base = raw;
                    if (base && !/^https?:\/\//i.test(base)) base = `https://${base}`;
                    try {
                        base = new URL(base).origin;
                    } catch {
                        base = DEFAULT_API_HOST;
                    }
                }

                // Safety: prevent getting stuck on a known-broken preview deployment.
                // (It causes CORS preflight failures + ffmpeg ENOENT + 500s.)
                // Updated Jan 2026: Force reset to canonical prod if user is on any old preview aliased URL
                if (typeof base === 'string' && (base.includes('h2s-backend-mocqfhqw4-') || base.includes('h2s-backend-adql3lvdh-'))) {
                    console.warn('[Config] Detected stale backend URL. Resetting to production.');
                    base = 'https://h2s-backend.vercel.app';
                    if (urlEl) urlEl.value = base;
                    try { localStorage.setItem(this.storageKeys.backendUrl, base); } catch { /* ignore */ }
                }

                const adminKey = (keyEl?.value || storedKey || '').trim();
                return { base, adminKey };
            },

            getBackendUrl() {
                // Always return the actual backend URL, never portal origin
                // Used for APIs that don't have portal proxies (like proof-slots)
                const urlEl = document.getElementById('ppBackendUrl');
                const storedUrl = (() => {
                    try { return localStorage.getItem(this.storageKeys.backendUrl) || ''; } catch { return ''; }
                })();
                
                const raw = (urlEl?.value || storedUrl || DEFAULT_API_HOST || 'https://h2s-backend.vercel.app').trim();
                let url = raw;
                if (url && !/^https?:\/\//i.test(url)) url = `https://${url}`;
                
                try {
                    return new URL(url).origin;
                } catch {
                    return 'https://h2s-backend.vercel.app';
                }
            },

            saveConfig() {
                const { base, adminKey } = this.getConfig();
                const urlEl = document.getElementById('ppBackendUrl');
                if (urlEl) urlEl.value = base;

                try {
                    localStorage.setItem(this.storageKeys.backendUrl, base);
                    localStorage.setItem(this.storageKeys.adminKey, adminKey);
                } catch {
                    // ignore
                }

                const status = document.getElementById('ppConnStatus');
                if (status) status.textContent = `Saved. Using: ${base}`;
                showToast('Proof Packs config saved', 'success');
                // Async, best-effort: prove what backend is actually deployed.
                this.refreshBackendIdentity({ silent: true });
                this.refresh();
            },

            async fetchJson(path, options = {}) {
                const { base, adminKey } = this.getConfig();
                const headers = new Headers(options.headers || {});
                if (adminKey) headers.set('x-admin-key', adminKey);

                const res = await fetch(`${base}${path}`, {
                    ...options,
                    // Avoid Cache-Control request headers (they trigger CORS preflight on some previews).
                    cache: options.cache || 'no-store',
                    headers,
                });
                const contentType = res.headers.get('content-type') || '';
                const body = contentType.includes('application/json') ? await res.json() : await res.text();
                if (!res.ok) {
                    const msg = typeof body === 'string' ? body : (body?.error || 'Request failed');
                    const err = new Error(msg);
                    err.status = res.status;
                    throw err;
                }
                return body;
            },

            async refreshBackendIdentity({ silent } = {}) {
                const status = document.getElementById('ppConnStatus');
                const { base } = this.getConfig();
                if (!base) return;

                try {
                    const ctrl = new AbortController();
                    const t = setTimeout(() => ctrl.abort(), 6000);
                    const res = await fetch(`${base}/api/health`, {
                        method: 'GET',
                        cache: 'no-store',
                        signal: ctrl.signal,
                    });
                    clearTimeout(t);

                    const contentType = res.headers.get('content-type') || '';
                    const payload = contentType.includes('application/json') ? await res.json() : null;
                    const buildId = String(payload?.build_id || res.headers.get('x-build-id') || '').trim();
                    const envName = String(payload?.env_name || '').trim();

                    if (status) {
                        const parts = [`Using: ${base}`];
                        if (buildId) parts.push(`build: ${buildId}`);
                        if (envName) parts.push(`env: ${envName}`);
                        status.textContent = parts.join(' | ');
                    }
                } catch (e) {
                    // Keep the UI usable even if health check fails.
                    if (!silent && status) status.textContent = `Using: ${base} (health check failed)`;
                }
            },

            async ensureSupabaseConfig() {
                if (this.state.supabase?.ok && this.state.supabase?.url) return this.state.supabase;
                if (this.state.supabase?.loading) return this.state.supabase;

                this.state.supabase = { loading: true, ok: false, url: '', anonKey: '' };
                try {
                    const resp = await this.fetchJson('/api/get_supabase_config');
                    const url = String(resp?.url || '').trim();
                    const anonKey = String(resp?.anonKey || '').trim();
                    if (!resp?.ok || !url) {
                        this.state.supabase = { loading: false, ok: false, url: '', anonKey: '' };
                        return this.state.supabase;
                    }
                    this.state.supabase = { loading: false, ok: true, url, anonKey };
                    return this.state.supabase;
                } catch {
                    this.state.supabase = { loading: false, ok: false, url: '', anonKey: '' };
                    return this.state.supabase;
                }
            },

            publicStorageUrl(bucket, storagePath) {
                const base = String(this.state.supabase?.url || '').trim().replace(/\/+$/g, '');
                const b = String(bucket || '').trim();
                const pRaw = String(storagePath || '').trim();
                if (!base || !b || !pRaw) return '';

                const p = pRaw.replace(/^\/+/, '');
                const encodedBucket = encodeURIComponent(b);
                const encodedPath = p.split('/').map(seg => encodeURIComponent(seg)).join('/');
                return `${base}/storage/v1/object/public/${encodedBucket}/${encodedPath}`;
            },

            slotLabel(slotKey) {
                const key = String(slotKey || '').trim();
                if (key === 'hero') return 'Top banner (Hero)';
                if (key === 'mid_proof_rail') return 'Mid-page proof rail';
                if (key === 'pre_cta') return 'Near checkout (Pre-CTA)';
                return key || 'Auto';
            },

            toggleCollapse(bodyId, toggleId) {
                const body = document.getElementById(bodyId);
                const toggle = document.getElementById(toggleId);
                if (!body || !toggle) return;

                const isOpen = toggle.getAttribute('aria-expanded') === 'true';
                if (isOpen) {
                    toggle.setAttribute('aria-expanded', 'false');
                    body.style.maxHeight = '0px';
                    return;
                }

                toggle.setAttribute('aria-expanded', 'true');
                // Measure after expanding content.
                body.style.maxHeight = body.scrollHeight + 'px';
            },

            setHidden(el, hidden) {
                if (!el) return;
                el.classList.toggle('is-hidden', !!hidden);
            },

            updateProofTypeOptions() {
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                const shotEl = document.getElementById('ppShotType');
                if (!shotEl) return;

                // Minimum options, maximum signal.
                // Values are stored as simple tags (often multi-term) so backend ranking can use `includes()`.
                const options = (service === 'cameras')
                    ? [
                        { value: 'motion tracking', label: 'Motion tracking', hint: 'Show camera detecting motion with overlay' },
                        { value: 'pov', label: 'Camera view (POV)', hint: 'Live feed showing what the camera sees' },
                        { value: 'mount', label: 'Mounted (installed)', hint: 'Final mounted camera on wall/ceiling' },
                        { value: 'handheld third', label: 'Handheld (third-person)', hint: 'Wide shot showing install in progress' },
                        { value: 'bird', label: "Handheld (bird's-eye)", hint: 'Overhead view of installation area' },
                        { value: 'weather seal', label: 'Exterior / weather sealed', hint: 'Outdoor camera with weatherproofing visible' },
                    ]
                    : [
                        { value: 'after', label: 'Finished install (after)', hint: 'Clean final result - our most important shot' },
                        { value: 'stud level', label: 'Secure mount (stud + level)', hint: 'Shows mounting bracket attached to studs with level tool' },
                        { value: 'conceal', label: 'Wire conceal', hint: 'Hidden cables in wall or raceway' },
                        { value: 'before', label: 'Before', hint: 'Empty wall or old setup before our work' },
                        { value: 'during', label: 'During / in progress', hint: 'Action shot showing technician at work' },
                    ];

                const prev = shotEl.value;
                shotEl.innerHTML = '';
                const opt0 = document.createElement('option');
                opt0.value = '';
                opt0.textContent = 'Select...';
                shotEl.appendChild(opt0);
                options.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.value;
                    opt.textContent = o.label;
                    opt.dataset.hint = o.hint || '';
                    shotEl.appendChild(opt);
                });

                // Show hint for selected option
                const showHint = () => {
                    const hintEl = document.getElementById('ppShotTypeHint');
                    if (!hintEl) return;
                    const selected = shotEl.options[shotEl.selectedIndex];
                    if (!selected) return;
                    const hint = selected?.dataset?.hint || '';
                    hintEl.textContent = hint;
                    hintEl.style.display = hint ? '' : 'none';
                };
                shotEl.onchange = showHint;
                showHint();

                // Preserve selection if still valid
                if (prev) {
                    const ok = options.some(o => o.value === prev);
                    if (ok) {
                        shotEl.value = prev;
                        showHint();
                    }
                }
            },

            ensureDefaults() {
                // Make the UI "minimum sufficient": user shouldn't have to think about lighting/slot.
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                const todEl = document.getElementById('ppTimeOfDay');
                const slotEl = document.getElementById('ppSlotKey');
                const shotEl = document.getElementById('ppShotType');

                if (todEl && !todEl.value) {
                    todEl.value = (service === 'cameras') ? 'day' : 'indoor';
                }

                if (slotEl && !slotEl.value) {
                    const rec = this.recommendSlots();
                    if (rec?.recommended?.length) slotEl.value = rec.recommended[0];
                }

                // Proof type is optional UX-wise, but we still want a default for better rotation behavior.
                if (shotEl && !shotEl.value) {
                    const fallback = (service === 'cameras') ? 'mount' : 'after';
                    // Only set if the option exists for the current service.
                    const has = Array.from(shotEl.options || []).some(o => String(o.value) === fallback);
                    if (has) shotEl.value = fallback;
                }
            },

            init() {
                const pane = document.getElementById('proofpacks-pane');
                if (!pane) return;

                // Subtle, conditional refresh for Library mode: when the tab regains focus/visibility,
                // refresh only if the library is stale or empty. No manual button.
                if (!this._libraryAutoRefreshBound) {
                    if (!this._libraryAuto) this._libraryAuto = { lastAttemptAt: 0, failCount: 0, nextAttemptAt: 0 };

                    const isLibraryUiVisible = () => {
                        try {
                            if (String(this.state?.mode || '') !== 'library') return false;
                            const paneEl = document.getElementById('proofpacks-pane');
                            const ws = document.getElementById('ppLibraryWorkspace');
                            if (!paneEl || !ws) return false;
                            const paneOk = paneEl.classList.contains('active') && getComputedStyle(paneEl).display !== 'none';
                            const wsOk = getComputedStyle(ws).display !== 'none';
                            return paneOk && wsOk;
                        } catch {
                            return false;
                        }
                    };

                    const maybeRefresh = (reason = '') => {
                        try {
                            if (!isLibraryUiVisible()) return;
                            if (document.hidden) return;

                            const auto = this._libraryAuto || (this._libraryAuto = { lastAttemptAt: 0, failCount: 0, nextAttemptAt: 0 });
                            const now = Date.now();
                            if (auto.nextAttemptAt && now < auto.nextAttemptAt) return;
                            if ((now - Number(auto.lastAttemptAt || 0)) < 15_000) return;

                            const items = Array.isArray(this.state?.assets?.items) ? this.state.assets.items : [];
                            const last = Number(this.state?.assets?.lastFetchedAt || 0);
                            const stale = !last || (now - last) > 90_000;
                            const empty = items.length === 0;
                            if (stale || empty) {
                                auto.lastAttemptAt = now;
                                this.refreshAssets();
                            }
                        } catch {
                            // ignore
                        }
                    };

                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden) maybeRefresh();
                    });
                    window.addEventListener('focus', () => maybeRefresh());
                    window.addEventListener('online', () => maybeRefresh('online'));

                    // Gentle polling (only refreshes when stale/empty + visible).
                    this._libraryAutoRefreshTimer = setInterval(() => maybeRefresh('tick'), 30_000);
                    this._libraryAutoRefreshBound = true;
                }

                // Workspace mode (Upload vs Library)
                const btnUpload = document.getElementById('ppModeUpload');
                const btnLibrary = document.getElementById('ppModeLibrary');
                if (btnUpload && !btnUpload.dataset.bound) {
                    btnUpload.addEventListener('click', () => this.setMode('upload'));
                    btnUpload.dataset.bound = 'true';
                }
                if (btnLibrary && !btnLibrary.dataset.bound) {
                    btnLibrary.addEventListener('click', () => this.setMode('library'));
                    btnLibrary.dataset.bound = 'true';
                }

                const closeEditorBtn = document.getElementById('ppCloseEditor');
                if (closeEditorBtn && !closeEditorBtn.dataset.bound) {
                    closeEditorBtn.addEventListener('click', () => {
                        const editor = document.getElementById('ppLibraryEditor');
                        const body = document.getElementById('ppLibraryEditorBody');
                        if (body) body.innerHTML = '';
                        if (editor) editor.classList.add('is-hidden');
                        this.restoreEditorFieldsHome();
                        this.state.edit = { assetId: '', asset: null };
                        const status = document.getElementById('ppEditorStatus');
                        if (status) status.textContent = '';
                    });
                    closeEditorBtn.dataset.bound = 'true';
                }

                // Add escape key support for modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const editor = document.getElementById('ppLibraryEditor');
                        if (editor && !editor.classList.contains('is-hidden')) {
                            const closeBtn = document.getElementById('ppCloseEditor');
                            if (closeBtn) closeBtn.click();
                        }
                    }
                });

                const urlEl = document.getElementById('ppBackendUrl');
                if (urlEl && !urlEl.value) {
                    try {
                        const stored = localStorage.getItem('h2s_proof_backend_url');
                        if (stored) urlEl.value = stored;
                        else urlEl.value = DEFAULT_API_HOST;
                    } catch {
                        urlEl.value = DEFAULT_API_HOST;
                    }
                }

                const keyEl = document.getElementById('ppAdminKey');
                if (keyEl && !keyEl.value) {
                    try {
                        const storedKey = localStorage.getItem('h2s_proof_admin_key');
                        if (storedKey) keyEl.value = storedKey;
                    } catch {
                        // ignore
                    }
                }

                // Always show what backend we're actually using (avoids "I thought I was on preview" confusion).
                try {
                    const { base } = this.getConfig();
                    const status = document.getElementById('ppConnStatus');
                    if (status && base) status.textContent = `Using: ${base}`;
                } catch {
                    // ignore
                }

                // Async, best-effort: display build_id/env from the backend.
                this.refreshBackendIdentity({ silent: true });

                // Restore mode after we have base DOM.
                this.setMode(this.getModePreference(), { silent: true });

                const serviceEl = document.getElementById('ppService');
                const packEl = document.getElementById('ppPackSelect');
                const forceKindEl = document.getElementById('ppForceKind');
                const shotEl = document.getElementById('ppShotType');
                const todEl = document.getElementById('ppTimeOfDay');
                const slotEl = document.getElementById('ppSlotKey');
                const convertEl = document.getElementById('ppConvertToMp4');
                const trimStartEl = document.getElementById('ppTrimStartSec');
                const trimEndEl = document.getElementById('ppTrimEndSec');
                const bwEl = document.getElementById('ppFilterBw');

                // Initialize filter controls
                this.initFilterControls();

                // Restore last-used service (improves continuity across refresh/logins)
                if (serviceEl) {
                    const storedService = this.safeGetItem(this.storageKeys.service);
                    if (storedService && Array.from(serviceEl.options || []).some(o => String(o.value) === storedService)) {
                        serviceEl.value = storedService;
                    }
                }

                if (serviceEl && !serviceEl.dataset.bound) {
                    serviceEl.addEventListener('change', async () => {
                        this.safeSetItem(this.storageKeys.service, serviceEl.value || '');
                        this.updateProofTypeOptions();
                        this.ensureDefaults();
                        this.updateAdvice();
                        // Service category is upload metadata only. Library is independent.
                    });
                    serviceEl.dataset.bound = 'true';
                }
                if (packEl && !packEl.dataset.bound) {
                    packEl.addEventListener('change', () => {
                        console.log('[Pack Change] Dropdown changed to:', packEl.value);
                        
                        const surface = document.getElementById('ppSurface')?.value || 'bundles';
                        const service = document.getElementById('ppService')?.value || '';
                        this.safeSetItem(this.getPackStorageKey(surface, service), packEl.value || '');
                        this.ensureDefaults();
                        this.updateAdvice();
                        this.updateHeaderCopy();
                        this.refreshCoverage();
                        
                        console.log('[Pack Change] Calling refreshAssets...');
                        this.refreshAssets();
                    });
                    packEl.dataset.bound = 'true';
                }
                if (forceKindEl && !forceKindEl.dataset.bound) {
                    forceKindEl.addEventListener('change', () => this.updateAdvice());
                    forceKindEl.dataset.bound = 'true';
                }
                if (shotEl && !shotEl.dataset.bound) {
                    shotEl.addEventListener('change', () => {
                        this.ensureDefaults();
                        this.updateAdvice();
                    });
                    shotEl.dataset.bound = 'true';
                }
                if (todEl && !todEl.dataset.bound) {
                    todEl.addEventListener('change', () => this.updateAdvice());
                    todEl.dataset.bound = 'true';
                }
                if (slotEl && !slotEl.dataset.bound) {
                    slotEl.addEventListener('change', () => this.updateAdvice());
                    slotEl.dataset.bound = 'true';
                }

                if (convertEl) {
                    const stored = this.safeGetItem(this.storageKeys.convertToMp4);
                    if (stored) convertEl.checked = stored === '1';
                    if (!convertEl.dataset.bound) {
                        convertEl.addEventListener('change', () => {
                            this.safeSetItem(this.storageKeys.convertToMp4, convertEl.checked ? '1' : '0');
                            this.updateAdvice();
                        });
                        convertEl.dataset.bound = 'true';
                    }
                }

                const rotateEl = document.getElementById('ppVideoRotate');
                const rotateField = document.getElementById('ppRotateField');
                if (rotateEl) {
                    const stored = this.safeGetItem(this.storageKeys.rotateDeg);
                    if (stored) rotateEl.value = String(stored);
                    if (!rotateEl.dataset.bound) {
                        rotateEl.addEventListener('change', () => {
                            this.safeSetItem(this.storageKeys.rotateDeg, rotateEl.value || '0');
                            this.applyLocalPreviewRotation();
                            this.updateAdvice();
                        });
                        rotateEl.dataset.bound = 'true';
                    }
                }
                if (rotateField) rotateField.style.display = 'none';

                const trimField = document.getElementById('ppTrimField');
                if (trimStartEl) {
                    const stored = this.safeGetItem(this.storageKeys.trimStartSec);
                    if (stored) trimStartEl.value = String(stored);
                    if (!trimStartEl.dataset.bound) {
                        trimStartEl.addEventListener('change', () => {
                            this.safeSetItem(this.storageKeys.trimStartSec, String(trimStartEl.value || ''));
                            this.updateAdvice();
                        });
                        trimStartEl.dataset.bound = 'true';
                    }
                }
                if (trimEndEl) {
                    const stored = this.safeGetItem(this.storageKeys.trimEndSec);
                    if (stored) trimEndEl.value = String(stored);
                    if (!trimEndEl.dataset.bound) {
                        trimEndEl.addEventListener('change', () => {
                            this.safeSetItem(this.storageKeys.trimEndSec, String(trimEndEl.value || ''));
                            this.updateAdvice();
                        });
                        trimEndEl.dataset.bound = 'true';
                    }
                }
                if (trimField) trimField.style.display = 'none';

                if (bwEl) {
                    const stored = this.safeGetItem(this.storageKeys.filterBw);
                    if (stored) bwEl.checked = stored === '1';
                    if (!bwEl.dataset.bound) {
                        bwEl.addEventListener('change', () => {
                            this.safeSetItem(this.storageKeys.filterBw, bwEl.checked ? '1' : '0');
                            this.applyLocalPreviewRotation();
                        });
                        bwEl.dataset.bound = 'true';
                    }
                }

                const fileInput = document.getElementById('ppFileInput');
                if (fileInput && !fileInput.dataset.bound) {
                    fileInput.setAttribute('multiple', 'multiple');
                    fileInput.addEventListener('change', (e) => {
                        const files = Array.from(e.target?.files || []);
                        if (files.length === 0) return;
                        
                        if (files.length === 1) {
                            this.onFileSelected(files[0]);
                        } else {
                            this.onMultipleFilesSelected(files);
                        }
                        
                        // Reset input so same files can be selected again
                        e.target.value = '';
                    });
                    fileInput.dataset.bound = 'true';
                }

                const bindCaptureInput = (id) => {
                    const el = document.getElementById(id);
                    if (!el || el.dataset.bound) return;
                    el.addEventListener('change', (e) => {
                        const files = Array.from(e.target?.files || []);
                        if (files.length === 0) return;
                        if (files.length === 1) this.onFileSelected(files[0]);
                        else this.onMultipleFilesSelected(files);
                        e.target.value = '';
                    });
                    el.dataset.bound = 'true';
                };

                bindCaptureInput('ppCameraPhotoInput');
                bindCaptureInput('ppCameraVideoInput');

                const replaceInput = document.getElementById('ppReplaceFileInput');
                if (replaceInput && !replaceInput.dataset.bound) {
                    replaceInput.addEventListener('change', (e) => {
                        const file = e.target?.files?.[0] || null;
                        this.onReplaceFileSelected(file);
                    });
                    replaceInput.dataset.bound = 'true';
                }

                const dz = document.getElementById('ppDropzone');
                if (dz && !dz.dataset.bound) {
                    dz.addEventListener('click', (e) => {
                        // Ignore clicks on the explicit action chips (labels)
                        if (e?.target?.closest && e.target.closest('.pp-mobile-capture-actions')) return;
                        fileInput?.click();
                    });
                    dz.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            fileInput?.click();
                        }
                    });
                    dz.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dz.classList.add('is-active');
                    });
                    dz.addEventListener('dragleave', () => dz.classList.remove('is-active'));
                    dz.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dz.classList.remove('is-active');
                        const files = Array.from(e.dataTransfer?.files || []);
                        if (files.length === 0) return;
                        
                        if (files.length === 1) {
                            // Single file - use existing preview workflow
                            this.onFileSelected(files[0]);
                        } else {
                            // Multiple files - start bulk upload
                            this.onMultipleFilesSelected(files);
                        }
                    });
                    dz.dataset.bound = 'true';
                }

                this.updateProofTypeOptions();
                this.ensureDefaults();
                this.refresh();
            },

            updateHeaderCopy() {
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                const heroTitle = document.getElementById('ppHeroTitle');
                const heroSubtitle = document.getElementById('ppHeroSubtitle');
                const quickMeta = document.getElementById('ppQuickMeta');

                const serviceLabel = service === 'cameras' ? 'Cameras' : 'TV Mounting';
                
                if (heroTitle) heroTitle.textContent = `Upload Proof | ${serviceLabel}`;
                if (heroSubtitle) heroSubtitle.textContent = 'Upload images and videos to build your proof library.';
                if (quickMeta) quickMeta.textContent = 'Drop files or click to browse. Supports bulk upload.';
            },

            normalizePackTitle(title) {
                const t = String(title || '').trim();
                if (!t) return '';
                if (/^seed\s*pack$/i.test(t) || /seed\s*pack/i.test(t)) return 'Starter set';
                return t;
            },

            formatPackLabel(pack) {
                const base = pack?.week_of ? this.formatWeekLabel(pack.week_of) : 'Rotation week';
                const title = this.normalizePackTitle(pack?.title);
                // If the title is just the seed label, don't show it twice.
                if (title && title !== 'Starter set') return `${base} - ${title}`;
                if (title === 'Starter set') return `${base} - Starter set`;
                return base;
            },

            formatHumanLabel(str) {
                if (!str) return '';
                // Handle enum-like strings: "TV_MOUNTING" -> "TV Mounting"
                // "working_shot" -> "Working Shot"
                return String(str)
                    .toLowerCase()
                    .replace(/_/g, ' ')
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            },

            parseYmdDate(value) {
                const raw = String(value || '').trim();
                if (!raw) return null;
                try {
                    const d = new Date(raw + 'T00:00:00');
                    if (!Number.isNaN(d.getTime())) return d;
                } catch {
                    // ignore
                }
                return null;
            },

            pickDefaultPackId(packs) {
                const list = Array.isArray(packs) ? packs : [];
                if (!list.length) return '';

                const today = new Date();
                const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                const candidates = list
                    .map(p => ({ pack: p, d: this.parseYmdDate(p.week_of) }))
                    .filter(x => !!x.d);

                if (!candidates.length) {
                    return String(list[0]?.pack_id || '');
                }

                // Prefer the most recent week <= today; otherwise the soonest future week.
                const pastOrToday = candidates
                    .filter(x => x.d.getTime() <= todayStart.getTime())
                    .sort((a, b) => b.d.getTime() - a.d.getTime());
                if (pastOrToday.length) return String(pastOrToday[0].pack?.pack_id || '');

                const future = candidates
                    .filter(x => x.d.getTime() > todayStart.getTime())
                    .sort((a, b) => a.d.getTime() - b.d.getTime());
                if (future.length) return String(future[0].pack?.pack_id || '');

                return String(list[0]?.pack_id || '');
            },

            getPackIdCandidates(packs) {
                const list = Array.isArray(packs) ? packs : [];
                const ids = list
                    .map(p => String(p?.pack_id || '').trim())
                    .filter(Boolean);

                const picked = String(this.pickDefaultPackId(list) || '').trim();
                if (!picked) return ids;
                return [picked, ...ids.filter(id => id !== picked)];
            },

            formatYmd(d) {
                const dt = (d instanceof Date) ? d : new Date(d);
                const y = dt.getFullYear();
                const m = String(dt.getMonth() + 1).padStart(2, '0');
                const day = String(dt.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            },

            nextMondayYmd() {
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const day = start.getDay();
                // JS: 0=Sun..6=Sat. We want next Monday.
                const daysUntilMonday = (8 - day) % 7 || 7;
                start.setDate(start.getDate() + daysUntilMonday);
                return this.formatYmd(start);
            },

            renderMixGoals() {
                const el = document.getElementById('ppMixGoals');
                if (!el) return;

                const pack = this.getSelectedPack();
                if (!pack?.pack_id) {
                    el.innerHTML = '';
                    return;
                }

                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                const visible = items.filter(a => a?.is_visible !== false);

                const shotCounts = new Map();
                for (const a of visible) {
                    const shot = String(a?.shot_type || '').toLowerCase();
                    if (!shot) continue;
                    shotCounts.set(shot, (shotCounts.get(shot) || 0) + 1);
                }

                const goals = (service === 'cameras')
                    ? [
                        { key: 'motion tracking', label: 'Motion tracking', min: 1 },
                        { key: 'pov', label: 'POV', min: 1 },
                        { key: 'mount', label: 'Mounted', min: 1 },
                    ]
                    : [
                        { key: 'after', label: 'Finished install', min: 1 },
                        { key: 'stud level', label: 'Stud + level', min: 1 },
                        { key: 'conceal', label: 'Wire conceal', min: 1 },
                    ];

                const pills = goals.map(g => {
                    const have = shotCounts.get(g.key) || 0;
                    const ok = have >= g.min;
                    const cls = ok ? 'pill is-ok' : 'pill is-warn';
                    const text = ok ? `${g.label} OK` : `${g.label}: need ${g.min}`;
                    return `<span class="${cls}">${this.escapeHtml(text)}</span>`;
                });

                el.innerHTML = pills.length
                    ? `<div class="u-text-caption u-muted u-mb-1">Mix goals (recommended)</div><div class="asset-pills">${pills.join(' ')}</div>`
                    : '';
            },

            formatWeekLabel(weekOf) {
                const raw = String(weekOf || '').trim();
                // Supports YYYY-MM-DD. Display as a human label (no scary ranges/IDs).
                try {
                    const d = new Date(raw + 'T00:00:00');
                    if (!Number.isNaN(d.getTime())) {
                        const now = new Date();
                        const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const startD = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                        const diffDays = Math.round((startD.getTime() - startToday.getTime()) / (24 * 60 * 60 * 1000));

                        const nice = d.toLocaleDateString(undefined, {
                            month: 'short',
                            day: 'numeric',
                            ...(d.getFullYear() !== now.getFullYear() ? { year: 'numeric' } : {}),
                        });

                        // Relative labels when it's obviously near-term.
                        if (diffDays >= 0 && diffDays <= 6) return `This week (${nice})`;
                        if (diffDays >= 7 && diffDays <= 13) return `Next week (${nice})`;
                        if (diffDays <= -1 && diffDays >= -7) return `Last week (${nice})`;

                        return nice;
                    }
                } catch {
                    // ignore
                }
                return raw || 'Rotation week';
            },

            async refresh() {
                const status = document.getElementById('ppConnStatus');
                if (status) status.textContent = 'Loading...';

                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                const surface = document.getElementById('ppSurface')?.value || 'bundles';
                const packSelect = document.getElementById('ppPackSelect');

                try {
                    const isLibrary = String(this.state?.mode || '') === 'library';

                    if (isLibrary) {
                        // Library is independent of upload service: always load packs for both services.
                        await this.ensureLibraryPacksLoaded(surface);
                    } else {
                        const packsResp = await this.fetchJson(`/api/admin/proof-packs?surface=${encodeURIComponent(surface)}&service=${encodeURIComponent(service)}`);
                        const packs = Array.isArray(packsResp?.packs) ? packsResp.packs : (Array.isArray(packsResp) ? packsResp : []);
                        this.state.packs = packs;
                    }

                    if (packSelect) {
                        const prev = packSelect.value;
                        const storedPackId = this.safeGetItem(this.getPackStorageKey(surface, service));
                        packSelect.innerHTML = '';
                        const opt0 = document.createElement('option');
                        opt0.value = '';
                        const packs = Array.isArray(this.state?.packs) ? this.state.packs : [];
                        opt0.textContent = packs.length ? 'Select (optional)...' : 'No rotations found';
                        packSelect.appendChild(opt0);
                        packs.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.pack_id;
                            opt.textContent = this.formatPackLabel(p);
                            packSelect.appendChild(opt);
                        });

                        // Preserve previous selection if it still exists; otherwise default to the most relevant pack.
                        const prevExists = prev && packs.some(p => String(p.pack_id) === String(prev));
                        const storedExists = storedPackId && packs.some(p => String(p.pack_id) === String(storedPackId));
                        if (prevExists) packSelect.value = prev;
                        else if (storedExists) packSelect.value = storedPackId;
                        else {
                            const picked = this.pickDefaultPackId(packs);
                            if (picked) packSelect.value = picked;
                        }

                        // Persist whatever we ended up selecting (helps across sessions/logouts)
                        this.safeSetItem(this.getPackStorageKey(surface, service), packSelect.value || '');
                    }

                    if (status) status.textContent = 'Ready.';
                    this.updateProofTypeOptions();
                    this.ensureDefaults();
                    this.updateAdvice();
                    this.updateHeaderCopy();

                    // Library load lifecycle:
                    // - On first page load, `setMode('library')` can run before packs are fetched,
                    //   causing an initial `refreshAssets()` call to abort with no pack selected.
                    // - After packs are populated here, if we're currently in Library mode,
                    //   auto-load assets for the selected pack.
                    if (String(this.state?.mode || '') === 'library') {
                        this.refreshAssets();
                    }
                } catch (e) {
                    console.error(e);
                    if (e?.status === 404) {
                        if (status) status.textContent = 'Backend missing Proof Packs endpoints (404).';
                        // Don't spam toast on tab open; guide the user.
                    } else if (e?.status === 401) {
                        if (status) status.textContent = 'Unauthorized (set admin key).';
                        showToast('Proof Packs: unauthorized. Set the admin key and refresh.', 'error');
                    } else {
                        if (status) status.textContent = 'Connection failed.';
                        showToast(`Proof Packs refresh failed: ${e.message}`, 'error');
                    }
                }
            },

            async ensureLibraryPacksLoaded(surface) {
                const s = String(surface || 'bundles');
                try {
                    const [tvResp, camResp] = await Promise.all([
                        this.fetchJson(`/api/admin/proof-packs?surface=${encodeURIComponent(s)}&service=tv_mounting`),
                        this.fetchJson(`/api/admin/proof-packs?surface=${encodeURIComponent(s)}&service=cameras`),
                    ]);
                    const tv = Array.isArray(tvResp?.packs) ? tvResp.packs : (Array.isArray(tvResp) ? tvResp : []);
                    const cams = Array.isArray(camResp?.packs) ? camResp.packs : (Array.isArray(camResp) ? camResp : []);
                    this.state.libraryPacks = { tv_mounting: tv, cameras: cams };
                } catch {
                    // If this fails, refreshAssets() will handle fallback/cache per request.
                    this.state.libraryPacks = { tv_mounting: [], cameras: [] };
                }
            },

            getCoverageTargets() {
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                // Standard targets per service (simple + predictable).
                // The site will hide proof areas if empty; this is the "fill" target so it never gets stale.
                if (service === 'cameras') {
                    return { videos: 12, photos: 10, hint: 'Target: 12 short videos + 10 photos (keeps proof from getting stale).' };
                }
                return { videos: 6, photos: 10, hint: 'Target: 6 short videos + 10 photos (keeps proof fresh).' };
            },

            setAssetsUi(model) {
                const hintEl = document.getElementById('ppAssetsHint');
                const statusEl = document.getElementById('ppAssetsStatus');
                const listEl = document.getElementById('ppAssetsList');
                const countEl = document.getElementById('ppAssetsCount');
                // Phase 2: New stats elements
                const videoStatsEl = document.getElementById('ppVideoStats');
                const photoStatsEl = document.getElementById('ppPhotoStats');
                const filterTabsEl = document.getElementById('ppAssetFilterTabs');

                const packId = String(model?.pack_id || '');
                const loading = !!model?.loading;
                const limit = Number(model?.renderLimit || 20);
                const isLibrary = String(this.state?.mode || '') === 'library';
                
                // Get active filter (type only - no service filtering needed since we load everything)
                const activeFilter = this.state.assets?.filter || 'all';
                
                // Pure set of items
                let items = Array.isArray(model?.items) ? model.items : [];
                const scopeNote = String(model?.scopeNote || '');

                const targets = this.getCoverageTargets();
                const visibleCounts = this.countMedia(items, { visibleOnly: true });
                const missingVideos = Math.max(0, Number(targets.videos || 0) - visibleCounts.videos);
                const missingPhotos = Math.max(0, Number(targets.photos || 0) - visibleCounts.photos);
                
                // Update Badge Colors based on status
                const vidOk = !missingVideos;
                const phoOk = !missingPhotos;

                if (hintEl) {
                    if (isLibrary) {
                        hintEl.textContent = packId ? (scopeNote || 'Merged library') : 'Proof Library';
                    } else {
                        const pack = this.getSelectedPack();
                        hintEl.textContent = packId
                            ? `Week of ${this.formatPackLabel(pack || { week_of: null, title: null })}`
                            : 'Select a rotation week to see assets.';
                    }
                }
                
                if (countEl) countEl.textContent = loading ? '...' : items.length;
                
                if (videoStatsEl) {
                    if (loading) {
                        videoStatsEl.textContent = '...';
                    } else {
                        const style = vidOk ? 'color: var(--pp-status-success-text)' : 'color: var(--pp-status-warn-text)';
                        const icon = vidOk ? 'OK' : '!';
                        videoStatsEl.innerHTML = `<span style="${style}">${visibleCounts.videos}/${targets.videos || 6}</span>`;
                        // Update parent card border color subtly? No, keep clean.
                    }
                }
                
                if (photoStatsEl) {
                    if (loading) {
                        photoStatsEl.textContent = '...';
                    } else {
                        const style = phoOk ? 'color: var(--pp-status-success-text)' : 'color: var(--pp-status-warn-text)';
                        photoStatsEl.innerHTML = `<span style="${style}">${visibleCounts.photos}/${targets.photos || 10}</span>`;
                    }
                }

                if (statusEl) statusEl.textContent = loading ? 'Loading assets...' : '';
                
                // Render filter tabs (Videos / Photos / All) - clean and simple
                // Filter tabs removed - using chip-based multi-filter system instead
                if (filterTabsEl) {
                    filterTabsEl.innerHTML = '';
                }
                
                if (!listEl) return;

                if (!packId) {
                    listEl.innerHTML = '';
                    return;
                }

                if (loading) {
                    // Dramatic Solution: A real spinner, not just text
                    listEl.innerHTML = `
                        <div style="padding:40px; text-align:center;">
                            <div class="spinner" style="
                                width: 32px; height: 32px; 
                                border: 4px solid #e2e8f0; border-top-color: #3b82f6; 
                                border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px auto;">
                            </div>
                            <div class="u-muted">Loading assets...</div>
                            <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
                        </div>`;
                    return;
                }

                if (!items.length) {
                    listEl.innerHTML = isLibrary
                        ? '<div class="u-muted">No assets yet. Upload in the Upload tab to seed the library.</div>'
                        : '<div class="u-muted">No assets found. Upload a photo/video above to populate this pack.</div>';
                    this.renderMixGoals();
                    return;
                }

                // Render ALL items - chip filters will handle visibility via applyAllFilters()
                const totalCount = items.length;
                const visibleItems = items.slice(0, limit);
                const hasMore = totalCount > limit;

                const rows = visibleItems.map(a => {
                    // Robust null/undefined checks for all asset data
                    const assetId = String(a?.asset_id || '').trim();
                    const mediaKind = String(a?.media_kind || '').trim() || 'unknown';
                    const shot = String(a?.shot_type || '').trim();
                    const tod = String(a?.time_of_day || '').trim();
                    const service = String(a?.service || '').trim() || 'unknown';
                    const slotKey = String(a?.slot_key || '').trim();
                    const visible = a?.is_visible !== false;
                    const created = a?.created_at ? new Date(a.created_at).toLocaleString() : '';
                    const path = String(a?.storage_path || '').trim();
                    const bucket = String(a?.storage_bucket || 'proof').trim();
                    
                    const transformStyle = this.buildAssetPreviewStyle(a);

                    // Validate storage path before building URL
                    const previewUrl = path ? this.publicStorageUrl(bucket, path) : '';
                    
                    // Apple-grade custom play button SVG (consistent across ALL videos)
                    const customPlayButton = `
                        <div class="pp-play-overlay">
                            <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
                                <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
                                <path d="M26 20L44 32L26 44V20Z" fill="#007aff"/>
                            </svg>
                        </div>
                    `;
                    
                    // Build thumbnail with custom play overlay (NO native controls)
                    const preview = !path
                                                ? `<div class="pp-video-thumbnail" style="background: #fee2e2; border: 2px dashed #ef4444; display: flex; align-items: center; justify-content: center;">
                                                         <span style="color: #dc2626; font-size: 12px; font-weight: 700; text-align: center; padding: 8px;">Missing<br/>Storage Path</span>
                                                     </div>`
                                                : previewUrl
                                                ? (mediaKind === 'video'
                                                        ? `<div class="pp-video-thumbnail" onclick="proofPacks.toggleThumbPlayback(this, event)">
                                                                                                                                 <video src="${this.escapeHtml(previewUrl)}" muted playsinline preload="metadata" style="${transformStyle}" onerror="proofPacks.onPreviewMediaError(this, 'video')"></video>
                                                                 ${customPlayButton}
                                                             </div>`
                                                        : `<div class="pp-video-thumbnail">
                                                                                                                                 <img src="${this.escapeHtml(previewUrl)}" loading="lazy" style="${transformStyle}" onerror="proofPacks.onPreviewMediaError(this, 'image')" />
                                                             </div>`)
                        : `<div class="pp-video-thumbnail" style="background: #f3f4f6; display: flex; align-items: center; justify-content: center;">
                             <span style="color: #9ca3af; font-size: 12px;">No preview</span>
                           </div>`;

                    // Human-readable slot map
                    const slotMap = {
                        'content_body': 'Working/Body',
                        'mid_proof_rail': 'Rail',
                        'hero_carousel': 'Hero',
                        'pre_cta': 'Mini Strip',
                        'gallery': 'Gallery'
                    };
                    const slotLabel = slotMap[slotKey] || (slotKey ? this.formatHumanLabel(slotKey) : '');

                    // Parse potential explicit intent
                    let intentLabel = this.inferIntentLabelFromAsset(a) || '';
                    const intentDisplay = intentLabel ? this.formatHumanLabel(intentLabel) : '';
                    const serviceDisplay = this.formatHumanLabel(service);
                    const mediaDisplay = this.formatHumanLabel(mediaKind);

                    // Filename cleanup: Remove 'bundles/SERVICE/DATE/MEDIA/' prefix
                    const cleanFilename = path.split('/').pop() || path;

                    // Color-coded tags with icons - Modernized
                    const mediaIcon = mediaKind === 'video' 
                        ? '<svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M0 12V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm6.79-6.907A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/></svg>'
                        : '<svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/></svg>';

                    const tags = `
                        <span class="pp-tag pp-tag-media">${mediaIcon} ${this.escapeHtml(mediaDisplay)}</span>
                        ${serviceDisplay ? `<span class="pp-tag pp-tag-service">${this.escapeHtml(serviceDisplay)}</span>` : ''}
                        ${intentDisplay ? `<span class="pp-tag pp-tag-intent">${this.escapeHtml(intentDisplay)}</span>` : ''}
                        ${slotLabel ? `<span class="pp-tag">${this.escapeHtml(slotLabel)}</span>` : ''}
                        ${!visible ? '<span class="pp-tag pp-tag-hidden">Hidden</span>' : ''}
                        ${(Number(a?.video_rotate_deg || 0) === 90 || Number(a?.video_rotate_deg || 0) === 180 || Number(a?.video_rotate_deg || 0) === 270) ? `<span class="pp-tag pp-tag-rotation">Rot ${Number(a?.video_rotate_deg || 0)}&deg;</span>` : ''}
                    `;

                    const btnToggle = `<button class="pp-btn-icon ${!visible ? 'pp-btn-destructive' : ''}" onclick="proofPacks.toggleAssetVisible('${this.escapeHtml(assetId)}', ${visible ? 'false' : 'true'})" title="${visible ? 'Hide' : 'Show'}">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            ${visible 
                                ? '<path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>' 
                                : '<path d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7.028 7.028 0 0 0-2.79.588l.77.771A5.944 5.944 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.134 13.134 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755-.165.165-.337.328-.517.486l.708.709z"/><path d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829l.822.822zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829z"/><path d="M3.35 5.47c-.18.16-.353.322-.518.487A13.134 13.134 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7.029 7.029 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12-.708.708z"/>'}
                        </svg>
                    </button>`;
                    
                    const btnEdit = `<button class="pp-btn-icon" onclick="proofPacks.beginEditAssetMedia('${this.escapeHtml(assetId)}')" title="Edit media">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                            <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                        </svg>
                    </button>`;
                    
                    const btnDelete = `<button class="pp-btn-icon pp-btn-destructive" onclick="proofPacks.deleteAsset('${this.escapeHtml(assetId)}')" title="Delete">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                    </button>`;

                    return `
                        <div class="pp-library-item" 
                             data-asset-id="${this.escapeHtml(assetId)}"
                             data-filename="${this.escapeHtml(path)}"
                             data-intent="${this.escapeHtml(intentLabel)}"
                             data-media-type="${this.escapeHtml(mediaKind)}"
                             data-service="${this.escapeHtml(service)}"
                             data-visible="${visible}"
                             data-created="${this.escapeHtml(created)}">
                            <input type="checkbox" class="pp-library-item-checkbox" 
                                   data-asset-id="${this.escapeHtml(assetId)}"
                                   onchange="proofPacks.onItemCheckboxChange()">
                            ${preview}
                            <div class="pp-library-item-content">
                                <div class="pp-library-item-tags">${tags}</div>
                                <div class="pp-library-item-meta">
                                    <span class="pp-meta-id">${this.escapeHtml(assetId)}</span>
                                    ${(this.state.liveAssetIds && this.state.liveAssetIds.has(assetId)) 
                                        ? '<span style="background:#10b981;color:white;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-left:8px;">LIVE</span>' 
                                        : '<span style="background:#94a3b8;color:white;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-left:8px;">UNUSED</span>'}
                                    ${(this.state.assetUsageCounts && this.state.assetUsageCounts.has(assetId) && this.state.assetUsageCounts.get(assetId) > 1)
                                        ? `<span style="background:#f59e0b;color:white;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-left:4px;cursor:help;" title="This asset appears ${this.state.assetUsageCounts.get(assetId)} times on the live bundles page (used in multiple slots)">${this.state.assetUsageCounts.get(assetId)}x</span>`
                                        : ''}
                                    ${created ? `<span class="pp-meta-separator">|</span><span>${this.escapeHtml(created)}</span>` : ''}
                                </div>
                                ${path ? `<div class="pp-library-item-path" title="${this.escapeHtml(path)}">${this.escapeHtml(cleanFilename)}</div>` : '<div class="pp-library-item-path" style="color: #ef4444;">No storage path</div>'}
                            </div>
                            <div class="pp-library-item-actions">
                                ${btnToggle}
                                ${btnEdit}
                                ${btnDelete}
                            </div>
                        </div>
                    `;
                });

                if (hasMore) {
                    rows.push(`
                        <div style="text-align:center; margin-top: 24px; margin-bottom: 40px;" id="ppLoadMoreSentinel">
                            <button onclick="proofPacks.loadMoreAssets()" class="pp-btn-secondary pp-btn-load-more">
                                Load More Assets (${totalCount - visibleItems.length} remaining)
                            </button>
                        </div>
                    `);
                }

                listEl.innerHTML = rows.join('');
                
                // Initialize filters on first library render
                this.initLibraryFilters();

                // Pack/data changed: clear any stale chip filters that don't exist in this pack.
                this.reconcileLibraryFiltersWithItems(items);
                
                // Apply any active filters to newly rendered items
                this.applyAllFilters();

                // Smooth scrolling: auto-load more when the sentinel approaches the viewport.
                this.setupLibraryInfiniteScroll();
                
                // Debug: Log first few items' data attributes
                const sampleItems = Array.from(document.querySelectorAll('.pp-library-item')).slice(0, 3);
                console.log('[Library] Sample items data:', sampleItems.map(item => ({
                    id: item.dataset.assetId,
                    service: item.dataset.service,
                    intent: item.dataset.intent,
                    mediaType: item.getAttribute('data-media-type'),
                    visible: item.getAttribute('data-visible')
                })));

                // Filter count is handled by applyAllFilters() (true post-filter count)
                
                this.renderMixGoals();
            },

            // Old filter system removed - now using chip-based multi-filter system

            loadMoreAssets() {
                if (!this.state.assets) return;
                const current = Number(this.state.assets.renderLimit || 20);
                const total = Array.isArray(this.state.assets.items) ? this.state.assets.items.length : 0;
                const next = current + 20;
                this.state.assets.renderLimit = total ? Math.min(next, total) : next;
                this.setAssetsUi(this.state.assets);
            },

            setupLibraryInfiniteScroll() {
                try {
                    if (this._loadMoreObserver) {
                        this._loadMoreObserver.disconnect();
                        this._loadMoreObserver = null;
                    }

                    if (String(this.state?.mode || '') !== 'library') return;
                    const sentinel = document.getElementById('ppLoadMoreSentinel');
                    if (!sentinel) return;
                    if (!('IntersectionObserver' in window)) return;

                    this._loadMoreObserver = new IntersectionObserver((entries) => {
                        try {
                            const entry = entries && entries[0];
                            if (!entry || !entry.isIntersecting) return;
                            const now = Date.now();
                            if (this._loadMoreCooldownUntil && now < this._loadMoreCooldownUntil) return;
                            this._loadMoreCooldownUntil = now + 800;
                            this.loadMoreAssets();
                        } catch {
                            // ignore
                        }
                    }, { root: null, rootMargin: '400px 0px', threshold: 0 });

                    this._loadMoreObserver.observe(sentinel);
                } catch {
                    // ignore
                }
            },

            async refreshLivePreview() {
                const container = document.getElementById('ppLivePreviewContent');
                if (!container) return;

                try {
                    container.innerHTML = `
                        <div style="text-align:center;padding:20px;color:#64748b;">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="margin:0 auto 8px;animation:spin 1s linear infinite;">
                                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                            </svg>
                            <div>Loading live content...</div>
                        </div>
                        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
                    `;
                    
                    // Get actual backend URL (not portal proxy)
                    const backendUrl = this.getBackendUrl();
                    console.log('[Live Preview] Using backend URL:', backendUrl);
                    
                    const surface = 'bundles';
                    const url = `${backendUrl}/api/proof-slots?surface=${surface}&limit=6`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        credentials: 'omit',
                        cache: 'no-store',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => 'Unknown error');
                        throw new Error(`API returned ${response.status}: ${errorText}`);
                    }

                    const resp = await response.json();
                    
                    if (!resp?.ok) {
                        const msg = resp?.error || 'Failed to load live content';
                        container.innerHTML = `
                            <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:16px;">
                                <div style="color:#dc2626;font-weight:600;font-size:13px;margin-bottom:4px;"> Could not load live preview</div>
                                <div style="color:#991b1b;font-size:12px;">${msg}</div>
                            </div>
                        `;
                        return;
                    }

                    const slotsData = resp.slots || {};
                    
                    // Extract all sections
                    const heroTv = (slotsData.hero?.tv_mounting || [])[0];
                    const railTv = slotsData.mid_proof_rail?.tv_mounting || [];
                    const railCam = slotsData.mid_proof_rail?.cameras || [];
                    
                    // Build actual bundles page preview with proper styling
                    let html = `
                        <div style="max-width:1400px;margin:0 auto;">
                            <div style="background:#f1f5f9;border-radius:12px;padding:20px;margin-bottom:20px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                                    <h3 style="margin:0;font-size:16px;font-weight:700;color:#1e293b;">Live Bundles Page</h3>
                                    <a href="https://shop.home2smart.com/bundles" target="_blank" style="font-size:13px;color:#3b82f6;text-decoration:none;font-weight:600;">View Live &rarr;</a>
                                </div>
                    `;

                    // HERO BANNER
                    html += `<div style="margin-bottom:32px;">`;
                    html += `<div style="font-size:14px;font-weight:700;color:#475569;margin-bottom:12px;display:flex;align-items:center;gap:8px;">`;
                    html += `<span title="Full-width image at top of page">Hero Banner</span>`;
                    html += `<span style="background:#10b981;color:white;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;">LIVE</span>`;
                    html += `</div>`;
                    
                    if (heroTv) {
                        const url = this.buildAssetUrl(heroTv);
                        const style = this.buildProofMediaStyle(heroTv);
                        const isVideo = heroTv.media_kind === 'video';
                        const mediaHtml = isVideo ? 
                            `<video src="${url}" style="width:100%;height:100%;object-fit:cover;${style}" muted loop autoplay playsinline crossorigin="anonymous" onerror="console.error('[HERO LOAD FAIL] Asset ID: ${heroTv.asset_id}, URL: ${url}, Bucket: ${heroTv.storage_bucket}, Path: ${heroTv.storage_path}'); this.style.display='none';this.nextElementSibling.style.display='block'"></video><div style="display:none;padding:40px;text-align:center;color:#ef4444;background:#fee;">Video failed to load<br><small style='font-size:10px;margin-top:8px;display:block;'>Asset ID: ${heroTv.asset_id}</small></div>` :
                            `<img src="${url}" style="width:100%;height:100%;object-fit:cover;${style}" crossorigin="anonymous" loading="eager" onerror="console.error('[HERO LOAD FAIL] Asset ID: ${heroTv.asset_id}, URL: ${url}, Bucket: ${heroTv.storage_bucket}, Path: ${heroTv.storage_path}'); this.style.display='none';this.nextElementSibling.style.display='block'" /><div style="display:none;padding:40px;text-align:center;color:#ef4444;background:#fee;">Image failed to load<br><small style='font-size:10px;margin-top:8px;display:block;'>Asset ID: ${heroTv.asset_id}</small></div>`;
                        
                        html += `
                            <div onclick="proofPacks.editAssetFromLive('${heroTv.asset_id}', 'hero')" 
                                 oncontextmenu="proofPacks.showAssetContextMenu(event, '${heroTv.asset_id}', '${heroTv.service}', 'hero'); return false;"
                                 style="position:relative;width:100%;max-width:900px;aspect-ratio:16/9;border-radius:12px;overflow:hidden;cursor:pointer;border:3px solid #10b981;box-shadow:0 4px 16px rgba(0,0,0,0.15);background:#1a1a1a;transition:all 0.2s;"
                                 onmouseover="this.style.transform='scale(1.01)'"
                                 onmouseout="this.style.transform=''">
                                ${mediaHtml}
                                <div style="position:absolute;top:12px;right:12px;background:rgba(0,0,0,0.85);color:white;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;pointer-events:none;">
                                    ${heroTv.service === 'tv_mounting' ? 'TV Mounting' : 'Cameras'}
                                </div>
                                <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.95));padding:16px;color:white;pointer-events:none;">
                                    <div style="font-size:13px;font-weight:700;margin-bottom:4px;">Click to edit framing</div>
                                    <div style="font-size:11px;opacity:0.9;">${heroTv.shot_type || 'result'} | ${heroTv.width_px}x${heroTv.height_px}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `<div onclick="proofPacks.assignAssetToSlot('bundles', 'hero', 'tv_mounting')" style="padding:60px;text-align:center;border:3px dashed #cbd5e1;border-radius:12px;background:#f8fafc;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#f8fafc';this.style.transform='';this.style.boxShadow=''">
                            <div style="font-size:14px;font-weight:600;color:#3b82f6;margin-bottom:8px;">Click to Assign Hero Banner</div>
                            <div style="font-size:12px;color:#64748b;">Choose from compatible TV Mounting assets</div>
                            <div style="font-size:11px;color:#94a3b8;margin-top:4px;">16:9 aspect ratio &bull; result or lifestyle shots</div>
                        </div>`;
                    }
                    html += `</div>`;

                    // PROOF RAIL
                    const allRail = [...railTv, ...railCam];
                    html += `<div style="margin-bottom:32px;">`;
                    html += `<div style="font-size:14px;font-weight:700;color:#475569;margin-bottom:12px;display:flex;align-items:center;gap:8px;">`;
                    html += `<span title="Grid carousel showing recent completed jobs">Recent Installs</span>`;
                    html += `<span style="background:#10b981;color:white;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;">LIVE</span>`;
                    html += `<span style="color:#64748b;font-size:13px;margin-left:8px;">${allRail.length} assets</span>`;
                    html += `</div>`;
                    
                    if (allRail.length > 0) {
                        html += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;">`;
                        allRail.slice(0, 10).forEach(asset => {
                            const url = this.buildAssetUrl(asset);
                            const style = this.buildProofMediaStyle(asset);
                            const isVideo = asset.media_kind === 'video';
                            const svc = asset.service === 'tv_mounting' ? 'TV' : 'Camera';
                            const mediaHtml = isVideo ? 
                                `<video src="${url}" style="width:100%;height:100%;object-fit:cover;${style}" muted loop preload="metadata" crossorigin="anonymous" onerror="console.error('[RAIL LOAD FAIL] Asset ID: ${asset.asset_id}, URL: ${url}');"></video>` :
                                `<img src="${url}" style="width:100%;height:100%;object-fit:cover;${style}" crossorigin="anonymous" loading="lazy" onerror="console.error('[RAIL LOAD FAIL] Asset ID: ${asset.asset_id}, URL: ${url}'); this.style.opacity='0.3'; this.parentElement.style.background='#fee';" />`;
                            
                            html += `
                                <div onclick="proofPacks.editAssetFromLive('${asset.asset_id}', 'rail')" 
                                     oncontextmenu="proofPacks.showAssetContextMenu(event, '${asset.asset_id}', '${asset.service}', 'rail'); return false;"
                                     style="position:relative;aspect-ratio:4/3;border-radius:8px;overflow:hidden;cursor:pointer;border:2px solid #10b981;box-shadow:0 2px 8px rgba(16,185,129,0.2);background:#1a1a1a;transition:all 0.2s;"
                                     onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 16px rgba(16,185,129,0.3)'"
                                     onmouseout="this.style.transform='';this.style.boxShadow='0 2px 8px rgba(16,185,129,0.2)'">
                                    ${mediaHtml}
                                    <div style="position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.85);color:white;padding:4px 8px;border-radius:5px;font-size:10px;font-weight:700;pointer-events:none;">
                                        ${svc}
                                    </div>
                                    <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,0.9));padding:10px;color:white;pointer-events:none;">
                                        <div style="font-size:11px;font-weight:600;">${asset.shot_type || 'result'}</div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    } else {
                        html += `<div style="display:flex;gap:16px;">`;
                        html += `<div onclick="proofPacks.assignAssetToSlot('bundles', 'mid_proof_rail', 'tv_mounting')" style="flex:1;padding:40px;text-align:center;border:3px dashed #cbd5e1;border-radius:12px;background:#f8fafc;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#f8fafc';this.style.transform='';this.style.boxShadow=''">
                            <div style="font-size:13px;font-weight:600;color:#3b82f6;margin-bottom:6px;">Add TV Asset</div>
                            <div style="font-size:11px;color:#94a3b8;">4:3 aspect &bull; result shots</div>
                        </div>`;
                        html += `<div onclick="proofPacks.assignAssetToSlot('bundles', 'mid_proof_rail', 'cameras')" style="flex:1;padding:40px;text-align:center;border:3px dashed #cbd5e1;border-radius:12px;background:#f8fafc;cursor:pointer;transition:all 0.3s ease;" onmouseover="this.style.borderColor='#3b82f6';this.style.background='#eff6ff';this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(59,130,246,0.15)'" onmouseout="this.style.borderColor='#cbd5e1';this.style.background='#f8fafc';this.style.transform='';this.style.boxShadow=''">
                            <div style="font-size:13px;font-weight:600;color:#3b82f6;margin-bottom:6px;">Add Camera Asset</div>
                            <div style="font-size:11px;color:#94a3b8;">4:3 aspect &bull; result shots</div>
                        </div>`;
                        html += `</div>`;
                    }
                    html += `</div></div></div>`;
                    
                    container.innerHTML = html;

                } catch (e) {
                    console.error('[Live Preview] Error:', e);
                    container.innerHTML = `
                        <div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:16px;">
                            <div style="color:#dc2626;font-weight:600;font-size:13px;margin-bottom:8px;"> Failed to load live preview</div>
                            <div style="color:#991b1b;font-size:12px;margin-bottom:12px;">${this.escapeHtml(e?.message || 'Unknown error')}</div>
                            <button onclick="proofPacks.refreshLivePreview()" style="background:#3b82f6;color:white;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            },

            async generateBatchThumbnails() {
                const backendUrl = this.getBackendUrl();
                const limit = 10; // Process 10 videos at a time
                
                this.toast(`Generating thumbnails for up to ${limit} videos...`, 'info');
                
                try {
                    const response = await fetch(`${backendUrl}/api/admin/proof-batch-thumbnails?limit=${limit}`, {
                        method: 'POST',
                        credentials: 'omit',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`API returned ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success > 0) {
                        this.toast(` Generated ${result.success} thumbnails`, 'success');
                        // Refresh library to show new thumbnails
                        await this.refreshAssets();
                        await this.refreshLivePreview();
                    } else if (result.total === 0) {
                        this.toast('No videos without thumbnails found', 'info');
                    } else {
                        this.toast(` ${result.failed} failed, ${result.success} succeeded`, 'warning');
                    }
                } catch (e) {
                    console.error('[Batch Thumbnails] Error:', e);
                    this.toast(`Failed to generate thumbnails: ${e?.message}`, 'error');
                }
            },

            buildProofMediaStyle(asset) {
                try {
                    const smart = asset?.smart_crop_details;
                    if (!smart || typeof smart !== 'object') return '';
                    
                    const mode = String(smart.mode || 'cover').toLowerCase();
                    const objectFit = mode === 'contain' ? 'contain' : 'cover';
                    const objectPosition = String(smart.objectPosition || '50% 50%');
                    
                    const geom = smart.geometry || {};
                    const panX = Number(geom.pan_x_pct || 0);
                    const panY = Number(geom.pan_y_pct || 0);
                    const tilt = Number(geom.tilt_deg || 0);
                    const scale = Number(geom.scale_pct || 100) / 100;
                    const rotateDeg = Number(asset.video_rotate_deg || 0);
                    
                    const needsTransform = rotateDeg !== 0 || tilt !== 0 || panX !== 0 || panY !== 0 || scale !== 1;
                    const transform = needsTransform 
                        ? `translate(${panX}%, ${panY}%) rotate(${rotateDeg + tilt}deg) scale(${scale})`
                        : '';
                    
                    const filterParts = [];
                    if (asset.filter_bw) filterParts.push('grayscale(100%)');
                    const b = Number(asset.filter_brightness || 100);
                    const c = Number(asset.filter_contrast || 100);
                    const s = Number(asset.filter_saturation || 100);
                    if (b !== 100) filterParts.push(`brightness(${b}%)`);
                    if (c !== 100) filterParts.push(`contrast(${c}%)`);
                    if (s !== 100) filterParts.push(`saturate(${s}%)`);
                    
                    const parts = [
                        `object-fit: ${objectFit}`,
                        `object-position: ${objectPosition}`,
                        needsTransform ? `transform: ${transform}` : '',
                        filterParts.length ? `filter: ${filterParts.join(' ')}` : ''
                    ].filter(Boolean);
                    
                    return parts.join('; ');
                } catch {
                    return '';
                }
            },

            buildAssetUrl(asset) {
                if (!asset) {
                    console.warn('[buildAssetUrl] No asset provided');
                    return '';
                }
                if (asset.direct_url) return asset.direct_url;
                
                const bucket = asset.storage_bucket || 'proof';
                const path = asset.storage_path || '';
                if (!path) {
                    console.warn('[buildAssetUrl] No storage_path for asset:', asset.asset_id);
                    return '';
                }
                
                // Use Supabase public URL directly
                const supabaseHost = 'ulbzmgmxrqyipclrbohi.supabase.co';
                const url = `https://${supabaseHost}/storage/v1/object/public/${bucket}/${path}`;
                console.log('[buildAssetUrl] Built URL:', url);
                return url;
            },

            editAssetFromLive(assetId, placement = 'rail') {
                if (!assetId) return;
                
                // Store the placement context so we can set correct Safe Zone
                this.state = this.state || {};
                this.state._editPlacement = placement;
                
                // Find asset in current library
                const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                const asset = items.find(a => a.asset_id === assetId);
                
                if (asset) {
                    // Use the proper edit flow that opens the modal correctly
                    this.beginEditAssetMedia(assetId);
                } else {
                    showToast('Asset not found in library. Refreshing...', 'info');
                    // Refresh assets and try again
                    this.refreshAssets().then(() => {
                        const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                        const asset = items.find(a => a.asset_id === assetId);
                        if (asset) {
                            this.beginEditAssetMedia(assetId);
                        } else {
                            showToast('Asset not found', 'error');
                        }
                    });
                }
            },

            showAssetContextMenu(event, assetId, service, placement) {
                event.preventDefault();
                event.stopPropagation();
                
                // Remove existing menu
                const existing = document.getElementById('ppAssetContextMenu');
                if (existing) existing.remove();
                
                // Create context menu
                const menu = document.createElement('div');
                menu.id = 'ppAssetContextMenu';
                menu.style.cssText = `
                    position: fixed;
                    background: white;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
                    padding: 8px 0;
                    z-index: 10000;
                    min-width: 180px;
                `;
                menu.style.left = event.clientX + 'px';
                menu.style.top = event.clientY + 'px';
                
                // Get asset to check if it's a video
                const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                const asset = items.find(a => a.asset_id === assetId);
                const isVideo = asset && asset.media_kind === 'video';
                
                const menuItems = [
                    { 
                        label: 'Edit Framing', 
                        icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>',
                        action: () => this.editAssetFromLive(assetId) 
                    },
                    ...(isVideo ? [{ 
                        label: 'Set Thumbnail', 
                        icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/></svg>',
                        action: () => this.openThumbnailPicker(assetId, asset) 
                    }] : []),
                    { 
                        label: 'Replace Asset', 
                        icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>',
                        action: () => this.replaceAssetInSlot(assetId, service, placement) 
                    },
                    { 
                        label: 'View in Library', 
                        icon: '<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/></svg>',
                        action: () => this.jumpToAssetInLibrary(assetId) 
                    }
                ];
                
                menuItems.forEach(item => {
                    const btn = document.createElement('button');
                    btn.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        width: 100%;
                        padding: 10px 16px;
                        border: none;
                        background: transparent;
                        text-align: left;
                        font-size: 14px;
                        color: #1e293b;
                        cursor: pointer;
                        transition: background 0.15s;
                    `;
                    btn.innerHTML = `<span style="display:inline-flex;align-items:center;color:#64748b;">${item.icon}</span><span>${item.label}</span>`;
                    btn.onmouseover = () => btn.style.background = '#f1f5f9';
                    btn.onmouseout = () => btn.style.background = 'transparent';
                    btn.onclick = () => {
                        item.action();
                        menu.remove();
                    };
                    menu.appendChild(btn);
                });
                
                document.body.appendChild(menu);
                
                // Close on click outside
                const closeMenu = (e) => {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                        document.removeEventListener('scroll', closeOnScroll, true);
                    }
                };
                
                // Close on scroll
                const closeOnScroll = () => {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                    document.removeEventListener('scroll', closeOnScroll, true);
                };
                
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                    document.addEventListener('scroll', closeOnScroll, true);
                }, 0);
            },

            async replaceAssetInSlot(currentAssetId, service, placement) {
                this.toast('Opening asset picker...', 'info');
                // Filter library by service
                this.libraryFilters = this.libraryFilters || {};
                this.libraryFilters.service = service;
                this.applyAllFilters();
                // Switch to library tab
                this.switchMode('library');
                this.toast(`Select a ${service === 'tv_mounting' ? 'TV Mounting' : 'Cameras'} asset to replace with`, 'info');
            },

            jumpToAssetInLibrary(assetId) {
                // Switch to library and highlight asset
                this.switchMode('library');
                setTimeout(() => {
                    const item = document.querySelector(`[data-asset-id="${assetId}"]`);
                    if (item) {
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        item.style.animation = 'pulse 1s ease-in-out 2';
                    }
                }, 300);
            },

            openThumbnailPicker(assetId, asset) {
                if (!asset || asset.media_kind !== 'video') {
                    showToast('Thumbnail picker only works for videos', 'error');
                    return;
                }

                // Create minimal modal overlay
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0);z-index:10000;display:flex;align-items:center;justify-content:center;padding:40px;transition:background 0.3s ease;';
                
                const picker = document.createElement('div');
                picker.style.cssText = 'background:#1a1a1a;border-radius:16px;max-width:800px;width:100%;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.8);transform:scale(0.9);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);';
                
                const url = this.buildAssetUrl(asset);
                
                picker.innerHTML = `
                    <div style="padding:24px;border-bottom:1px solid #333;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <h3 style="margin:0;font-size:18px;font-weight:600;color:white;">Set Video Thumbnail</h3>
                            <button onclick="this.closest('[data-thumbnail-modal]').style.opacity='0';setTimeout(()=>this.closest('[data-thumbnail-modal]').remove(),300)" style="background:none;border:none;font-size:28px;color:#999;cursor:pointer;padding:4px 12px;line-height:1;transition:color 0.2s;border-radius:6px;" onmouseover="this.style.background='#333';this.style.color='white'" onmouseout="this.style.background='none';this.style.color='#999'">&times;</button>
                        </div>
                        <p style="margin:8px 0 0;font-size:13px;color:#999;">Drag the slider to choose which frame shows as the thumbnail</p>
                    </div>
                    <div style="padding:24px;">
                        <div style="position:relative;background:#000;border-radius:8px;overflow:hidden;margin-bottom:20px;">
                            <video id="thumbnailVideo" src="${url}" style="width:100%;height:auto;display:block;" crossorigin="anonymous"></video>
                        </div>
                        <div style="margin-bottom:24px;">
                            <input type="range" id="thumbnailSlider" min="0" max="100" value="5" style="width:100%;height:6px;border-radius:3px;background:#333;outline:none;-webkit-appearance:none;appearance:none;cursor:pointer;" />
                            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:#999;">
                                <span id="thumbnailTime">0:00</span>
                                <span id="thumbnailDuration">0:00</span>
                            </div>
                        </div>
                        <div style="display:flex;gap:12px;justify-content:flex-end;">
                            <button onclick="this.closest('[data-thumbnail-modal]').style.opacity='0';setTimeout(()=>this.closest('[data-thumbnail-modal]').remove(),300)" style="background:transparent;color:#999;border:1px solid #444;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#333';this.style.borderColor='#555'" onmouseout="this.style.background='transparent';this.style.borderColor='#444'">Cancel</button>
                            <button id="saveThumbnailBtn" style="background:#3b82f6;color:white;border:none;padding:10px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">Set Thumbnail</button>
                        </div>
                    </div>
                `;
                
                picker.setAttribute('data-thumbnail-modal', 'true');
                modal.appendChild(picker);
                modal.setAttribute('data-thumbnail-modal', 'true');
                document.body.appendChild(modal);
                
                // Animate in
                requestAnimationFrame(() => {
                    modal.style.background = 'rgba(0,0,0,0.9)';
                    picker.style.opacity = '1';
                    picker.style.transform = 'scale(1)';
                });
                
                // Setup video controls
                const video = picker.querySelector('#thumbnailVideo');
                const slider = picker.querySelector('#thumbnailSlider');
                const timeDisplay = picker.querySelector('#thumbnailTime');
                const durationDisplay = picker.querySelector('#thumbnailDuration');
                const saveBtn = picker.querySelector('#saveThumbnailBtn');
                
                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${mins}:${secs.toString().padStart(2, '0')}`;
                };
                
                video.addEventListener('loadedmetadata', () => {
                    slider.max = video.duration;
                    durationDisplay.textContent = formatTime(video.duration);
                    // Start at 1 second
                    video.currentTime = 1;
                    slider.value = 1;
                    timeDisplay.textContent = formatTime(1);
                });
                
                slider.addEventListener('input', (e) => {
                    video.currentTime = parseFloat(e.target.value);
                    timeDisplay.textContent = formatTime(video.currentTime);
                });
                
                saveBtn.addEventListener('click', async () => {
                    try {
                        saveBtn.disabled = true;
                        saveBtn.textContent = 'Capturing...';
                        
                        // Capture frame from video
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0);
                        
                        // Convert to blob
                        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
                        
                        // Upload to backend
                        showToast('Uploading thumbnail...', 'info');
                        
                        const { base } = this.getConfig();
                        const formData = new FormData();
                        formData.append('file', blob, `thumbnail_${assetId}.jpg`);
                        formData.append('asset_id', assetId);
                        formData.append('timestamp', video.currentTime);
                        
                        // Upload and update asset
                        const response = await fetch(`${base}/api/admin/proof-assets/set-thumbnail`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) throw new Error('Upload failed');
                        
                        showToast('Thumbnail set successfully!', 'success');
                        
                        // Close modal
                        modal.style.opacity = '0';
                        setTimeout(() => modal.remove(), 300);
                        
                        // Refresh preview
                        await this.refreshAssets();
                        await this.refreshLivePreview();
                        
                    } catch (e) {
                        console.error('[Set Thumbnail Error]', e);
                        showToast(`Failed to set thumbnail: ${e.message}`, 'error');
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Set Thumbnail';
                    }
                });
                
                // Close on background click
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.style.opacity = '0';
                        setTimeout(() => modal.remove(), 300);
                    }
                };
            },

            async fetchLiveAssetIds(surface) {
                try {
                    const backendUrl = this.getBackendUrl();
                    const url = `${backendUrl}/api/proof-slots?surface=${surface || 'bundles'}&limit=50`;
                    const response = await fetch(url, {
                        method: 'GET',
                        credentials: 'omit',
                        cache: 'no-store'
                    });
                    
                    if (!response.ok) return { ids: new Set(), counts: new Map() };
                    
                    const resp = await response.json();
                    if (!resp?.ok || !resp?.slots) return { ids: new Set(), counts: new Map() };
                    
                    const slotsData = resp.slots;
                    const assetIds = new Set();
                    const usageCounts = new Map();
                    
                    // Extract all asset_id values and count usage from nested structure
                    Object.values(slotsData).forEach(slotGroup => {
                        Object.values(slotGroup).forEach(serviceAssets => {
                            if (Array.isArray(serviceAssets)) {
                                serviceAssets.forEach(asset => {
                                    if (asset?.asset_id) {
                                        assetIds.add(asset.asset_id);
                                        usageCounts.set(asset.asset_id, (usageCounts.get(asset.asset_id) || 0) + 1);
                                    }
                                });
                            }
                        });
                    });
                    
                    console.log('[fetchLiveAssetIds] Found', assetIds.size, 'live assets, max usage:', Math.max(...Array.from(usageCounts.values()), 0));
                    return { ids: assetIds, counts: usageCounts };
                } catch (e) {
                    console.error('[fetchLiveAssetIds] Error:', e);
                    return { ids: new Set(), counts: new Map() };
                }
            },

            async assignAssetToSlot(surface, slotKey, service) {
                console.log(`[assignAssetToSlot] surface=${surface}, slotKey=${slotKey}, service=${service}`);
                
                // Show loading indicator
                const loadingToast = showToast('Loading compatible assets...', 'info');
                
                // Small delay to ensure assets are loaded
                if (!this.state.assets?.items || this.state.assets.items.length === 0) {
                    await this.refreshAssets();
                }
                
                // Show asset picker modal with filtered assets
                const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                
                // Smart filtering based on slot requirements
                const slotRequirements = {
                    'hero': {
                        shot_types: ['result', 'lifestyle', 'process'],
                        aspect_ratio_target: 16/9,
                        aspect_ratio_tolerance: 0.15
                    },
                    'mid_proof_rail': {
                        shot_types: ['result', 'lifestyle'],
                        aspect_ratio_target: 4/3,
                        aspect_ratio_tolerance: 0.2
                    }
                };
                
                const requirements = slotRequirements[slotKey] || {};
                
                // Filter assets by service and requirements
                const compatibleAssets = items.filter(asset => {
                    if (asset.service !== service) return false;
                    if (!asset.storage_path) return false; // Exclude broken assets
                    
                    // Check shot type if specified
                    if (requirements.shot_types && requirements.shot_types.length > 0) {
                        if (!requirements.shot_types.includes(asset.shot_type)) return false;
                    }
                    
                    // Check aspect ratio if specified
                    if (requirements.aspect_ratio_target && asset.width_px && asset.height_px) {
                        const assetAspect = asset.width_px / asset.height_px;
                        const targetAspect = requirements.aspect_ratio_target;
                        const tolerance = requirements.aspect_ratio_tolerance || 0.1;
                        const difference = Math.abs(assetAspect - targetAspect) / targetAspect;
                        if (difference > tolerance) return false;
                    }
                    
                    return true;
                });
                
                console.log(`[assignAssetToSlot] Found ${compatibleAssets.length} compatible assets`);
                
                if (compatibleAssets.length === 0) {
                    showToast(`No compatible ${service === 'tv_mounting' ? 'TV Mounting' : 'Cameras'} assets found. Upload assets matching requirements first.`, 'error');
                    return;
                }
                
                // Create picker modal
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;transition:background 0.3s ease;';
                
                const picker = document.createElement('div');
                picker.style.cssText = 'background:white;border-radius:16px;max-width:900px;width:100%;max-height:80vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.5);transform:scale(0.9);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);';
                
                const header = document.createElement('div');
                header.style.cssText = 'padding:20px 24px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(to bottom,#ffffff,#f9fafb);';
                header.innerHTML = `
                    <div>
                        <h3 style="margin:0;font-size:18px;font-weight:700;color:#111827;">Assign to ${slotKey === 'hero' ? 'Hero Banner' : 'Recent Installs'}</h3>
                        <p style="margin:4px 0 0;font-size:13px;color:#6b7280;">${compatibleAssets.length} compatible ${service === 'tv_mounting' ? 'TV Mounting' : 'Camera'} assets</p>
                    </div>
                    <button onclick="this.closest('[data-modal]').style.opacity='0';setTimeout(()=>this.closest('[data-modal]').remove(),300)" style="background:none;border:none;font-size:28px;color:#9ca3af;cursor:pointer;padding:4px 12px;line-height:1;transition:color 0.2s;border-radius:6px;" onmouseover="this.style.background='#f3f4f6';this.style.color='#111827'" onmouseout="this.style.background='none';this.style.color='#9ca3af'">&times;</button>
                `;
                
                const grid = document.createElement('div');
                grid.style.cssText = 'flex:1;overflow-y:auto;padding:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;scroll-behavior:smooth;';
                
                compatibleAssets.forEach((asset, index) => {
                    const url = this.buildAssetUrl(asset);
                    const isVideo = asset.media_kind === 'video';
                    const aspectRatio = asset.width_px && asset.height_px ? (asset.width_px / asset.height_px).toFixed(2) : 'unknown';
                    
                    const tile = document.createElement('div');
                    tile.style.cssText = `cursor:pointer;border:2px solid #e5e7eb;border-radius:8px;overflow:hidden;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);opacity:0;animation:fadeInUp 0.4s ease forwards;animation-delay:${index * 0.03}s;`;
                    tile.onmouseover = () => { tile.style.borderColor = '#3b82f6'; tile.style.transform = 'translateY(-4px) scale(1.02)'; tile.style.boxShadow = '0 8px 16px rgba(59,130,246,0.2)'; };
                    tile.onmouseout = () => { tile.style.borderColor = '#e5e7eb'; tile.style.transform = ''; tile.style.boxShadow = ''; };
                    
                    tile.innerHTML = `
                        <div style="aspect-ratio:4/3;background:#1a1a1a;position:relative;overflow:hidden;">
                            ${isVideo ? 
                                `<video src="${url}" style="width:100%;height:100%;object-fit:cover;" muted loop preload="metadata"></video>` :
                                `<img src="${url}" style="width:100%;height:100%;object-fit:cover;" loading="lazy" />`
                            }
                        </div>
                        <div style="padding:12px;background:white;">
                            <div style="font-size:12px;font-weight:600;color:#111827;margin-bottom:4px;">${asset.shot_type || 'result'}</div>
                            <div style="font-size:10px;color:#6b7280;">${asset.width_px}x${asset.height_px} (${aspectRatio})</div>
                        </div>
                    `;
                    
                    tile.onclick = async () => {
                        // Show loading state on tile
                        tile.style.opacity = '0.5';
                        tile.style.pointerEvents = 'none';
                        tile.innerHTML += '<div style="position:absolute;inset:0;background:rgba(255,255,255,0.9);display:flex;align-items:center;justify-content:center;"><div style="border:3px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;width:32px;height:32px;animation:spin 0.8s linear infinite;"></div></div>';
                        
                        // Smooth close modal
                        modal.style.background = 'rgba(0,0,0,0)';
                        picker.style.opacity = '0';
                        picker.style.transform = 'scale(0.9)';
                        
                        setTimeout(() => modal.remove(), 300);
                        await this.performSlotAssignment(surface, slotKey, service, asset.asset_id);
                    };
                    
                    grid.appendChild(tile);
                });
                
                picker.appendChild(header);
                picker.appendChild(grid);
                modal.appendChild(picker);
                modal.setAttribute('data-modal', 'true');
                
                // Close on background click
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.style.background = 'rgba(0,0,0,0)';
                        picker.style.opacity = '0';
                        picker.style.transform = 'scale(0.9)';
                        setTimeout(() => modal.remove(), 300);
                    }
                };
                
                // Add CSS animations if not already present
                if (!document.getElementById('modal-animations')) {
                    const style = document.createElement('style');
                    style.id = 'modal-animations';
                    style.textContent = `
                        @keyframes fadeInUp {
                            from { opacity: 0; transform: translateY(20px); }
                            to { opacity: 1; transform: translateY(0); }
                        }
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(modal);
                
                // Trigger animations
                requestAnimationFrame(() => {
                    modal.style.background = 'rgba(0,0,0,0.8)';
                    picker.style.opacity = '1';
                    picker.style.transform = 'scale(1)';
                });
            },

            async performSlotAssignment(surface, slotKey, service, assetId) {
                try {
                    const toast = showToast('Assigning asset...', 'info');
                    
                    const { base } = this.getConfig();
                    await this.fetchJson('/api/admin/proof-slots', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            surface,
                            slot_key: slotKey,
                            service,
                            asset_id: assetId,
                            priority: 100,
                            status: 'active'
                        })
                    });
                    
                    showToast('Asset assigned successfully!', 'success');
                    
                    // Smooth refresh with loading state
                    const livePreviewContainer = document.getElementById('ppLivePreview');
                    if (livePreviewContainer) {
                        livePreviewContainer.style.opacity = '0.5';
                        livePreviewContainer.style.transition = 'opacity 0.3s ease';
                    }
                    
                    // Refresh live preview to show the new assignment
                    await this.refreshLivePreview();
                    
                    // Fade back in
                    if (livePreviewContainer) {
                        setTimeout(() => {
                            livePreviewContainer.style.opacity = '1';
                        }, 100);
                    }
                    
                } catch (e) {
                    console.error('[performSlotAssignment] Error:', e);
                    showToast(`Assignment failed: ${e.message}`, 'error');
                }
            },

            async refreshAssets() {
                // Concurrency safety: if the user switches packs quickly (or refresh is triggered twice),
                // we must prevent out-of-order responses from overwriting the latest library state.
                // Abort the previous request and tag this request with a monotonically increasing id.
                try {
                    if (this.state._assetsAbortCtrl) this.state._assetsAbortCtrl.abort();
                } catch { /* ignore */ }
                const assetsReqId = Number(this.state._assetsReqId || 0) + 1;
                this.state._assetsReqId = assetsReqId;
                const ctrl = new AbortController();
                this.state._assetsAbortCtrl = ctrl;
                
                const surface = document.getElementById('ppSurface')?.value || 'bundles';
                const isLibrary = String(this.state?.mode || '') === 'library';

                let packId = '';
                let packIds = [];
                let tvCandidates = [];
                let camCandidates = [];
                if (isLibrary) {
                    await this.ensureLibraryPacksLoaded(surface);
                    const tvPacks = Array.isArray(this.state?.libraryPacks?.tv_mounting) ? this.state.libraryPacks.tv_mounting : [];
                    const camPacks = Array.isArray(this.state?.libraryPacks?.cameras) ? this.state.libraryPacks.cameras : [];
                    tvCandidates = this.getPackIdCandidates(tvPacks);
                    camCandidates = this.getPackIdCandidates(camPacks);
                    packIds = [tvCandidates[0], camCandidates[0]].filter(Boolean);
                    packId = (tvCandidates.length || camCandidates.length) ? 'merged' : '';
                } else {
                    const pack = this.getSelectedPack();
                    packId = pack?.pack_id || '';
                }
                const statusEl = document.getElementById('ppAssetsStatus');
                
                if (!packId) {
                    this.state.assets = { loading: false, pack_id: null, items: [], scopeNote: '' };
                    this.setAssetsUi(this.state.assets);
                    return;
                }

                const prevPackId = String(this.state?.assets?.pack_id || '');
                const prevLimit = Number(this.state?.assets?.renderLimit || 20);
                const keepLimit = prevPackId && String(prevPackId) === String(packId);
                const renderLimit = keepLimit ? prevLimit : 20;

                this.state.assets = { loading: true, pack_id: packId, items: [], scopeNote: '', renderLimit, filter: this.state.assets?.filter || 'all' };
                this.setAssetsUi(this.state.assets);

                try {
                    await this.ensureSupabaseConfig();
                    
// Fetch live asset IDs and usage counts from proof-slots API
                const liveData = await this.fetchLiveAssetIds(surface);
                this.state.liveAssetIds = liveData.ids;
                this.state.assetUsageCounts = liveData.counts;
                    
                    // Unified Library: Load ALL assets for this pack, ignoring the upload service selector
                    // This creates a "Smart Library" where users can browse everything
                    let items = [];
                    let scopeNote = '';
                    if (isLibrary) {
                        // Merge: choose the first non-empty pack for each service.
                        const fetchFirstNonEmpty = async (candidates) => {
                            const ids = Array.isArray(candidates) ? candidates.filter(Boolean) : [];
                            let lastId = ids[0] || '';
                            let lastItems = [];

                            for (const id of ids.slice(0, 6)) {
                                lastId = id;
                                const resp = await this.fetchJson(`/api/admin/proof-assets?pack_id=${encodeURIComponent(id)}&limit=500`, { signal: ctrl.signal });
                                const arr = Array.isArray(resp?.assets) ? resp.assets : [];
                                lastItems = arr;
                                if (arr.length > 0) {
                                    return { id, items: arr };
                                }
                            }

                            return { id: lastId, items: lastItems };
                        };

                        const [tvRes, camRes] = await Promise.all([
                            fetchFirstNonEmpty(tvCandidates),
                            fetchFirstNonEmpty(camCandidates),
                        ]);

                        packIds = [String(tvRes?.id || '').trim(), String(camRes?.id || '').trim()].filter(Boolean);
                        items = [];
                        if (Array.isArray(tvRes?.items)) items.push(...tvRes.items);
                        if (Array.isArray(camRes?.items)) items.push(...camRes.items);
                        scopeNote = packIds.length ? 'Merged library: TV Mounting + Cameras' : '';
                    } else {
                        const respScoped = await this.fetchJson(
                            `/api/admin/proof-assets?pack_id=${encodeURIComponent(packId)}&limit=500`,
                            { signal: ctrl.signal }
                        );
                        items = Array.isArray(respScoped?.assets) ? respScoped.assets : [];
                    }

                    // Ignore stale responses.
                    if (Number(this.state._assetsReqId || 0) !== assetsReqId) {
                        return;
                    }
                    
                    const fetchedAt = Date.now();

                    this.state.assets = { 
                        loading: false, 
                        pack_id: packId, 
                        items, 
                        scopeNote, 
                        renderLimit, 
                        filter: this.state.assets?.filter || 'all',
                        serviceFilter: this.state.assets?.serviceFilter || 'all',
                        lastFetchedAt: fetchedAt,
                        sourcePackIds: isLibrary ? packIds.slice() : [packId],
                    };

                    // Reset Library backoff on success.
                    if (isLibrary) {
                        if (!this._libraryAuto) this._libraryAuto = { lastAttemptAt: 0, failCount: 0, nextAttemptAt: 0 };
                        this._libraryAuto.failCount = 0;
                        this._libraryAuto.nextAttemptAt = 0;
                    }
                    
                    // Cache key (merged for library, or pack_id for scoped)
                    this.safeWriteJson(this.getAssetsCacheKey(packId, isLibrary ? 'merged' : 'all'), {
                        ts: Date.now(),
                        items,
                        scopeNote,
                    });
                    this.setAssetsUi(this.state.assets);
                } catch (e) {
                    // Ignore aborted requests (usually due to pack switching)
                    if (e?.name === 'AbortError' || String(e?.message || '').toLowerCase().includes('aborted')) {
                        return;
                    }

                    // Ignore stale failures.
                    if (Number(this.state._assetsReqId || 0) !== assetsReqId) {
                        return;
                    }

                    // Library: back off retries a bit to avoid hammering on transient failures.
                    if (isLibrary) {
                        if (!this._libraryAuto) this._libraryAuto = { lastAttemptAt: 0, failCount: 0, nextAttemptAt: 0 };
                        const now = Date.now();
                        this._libraryAuto.failCount = Math.min(6, Number(this._libraryAuto.failCount || 0) + 1);
                        const delay = Math.min(300_000, 5_000 * Math.pow(2, this._libraryAuto.failCount));
                        this._libraryAuto.nextAttemptAt = now + delay;
                    }
                    
                    // Fallback to all cache
                    const cached = this.safeReadJson(this.getAssetsCacheKey(packId, isLibrary ? 'merged' : 'all'));
                    const cachedItems = Array.isArray(cached?.items) ? cached.items : [];
                    const age = this.formatAge(cached?.ts);
                    
                    if (cachedItems.length) {
                        const note = `Using cached library${age ? ` (${age})` : ''}. Sign in to refresh.`;
                        this.state.assets = {
                            loading: false,
                            pack_id: packId,
                            items: cachedItems,
                            scopeNote: note,
                            renderLimit,
                            filter: this.state.assets?.filter || 'all',
                            serviceFilter: this.state.assets?.serviceFilter || 'all',
                            lastFetchedAt: Number(this.state?.assets?.lastFetchedAt || 0),
                            sourcePackIds: isLibrary ? packIds.slice() : [packId],
                        };
                        this.setAssetsUi(this.state.assets);
                        if (statusEl) statusEl.textContent = e?.status === 401 ? 'Unauthorized (showing cached).' : `Offline (showing cached): ${e.message}`;
                    } else {
                        this.state.assets = {
                            loading: false,
                            pack_id: packId,
                            items: [],
                            scopeNote: '',
                            renderLimit,
                            filter: this.state.assets?.filter || 'all',
                            serviceFilter: this.state.assets?.serviceFilter || 'all',
                            lastFetchedAt: Number(this.state?.assets?.lastFetchedAt || 0),
                            sourcePackIds: isLibrary ? packIds.slice() : [packId],
                        };
                        this.setAssetsUi(this.state.assets);
                        if (statusEl) statusEl.textContent = e?.status === 401 ? 'Unauthorized (set admin key).' : `Failed to load assets: ${e.message}`;
                    }
                }
            },

            async toggleAssetVisible(assetId, nextVisible) {
                const pack = this.getSelectedPack();
                if (!pack?.pack_id) {
                    showToast('Select a pack first', 'error');
                    return;
                }
                try {
                    await this.fetchJson('/api/admin/proof-assets', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ asset_id: assetId, is_visible: !!nextVisible }),
                    });
                    showToast(nextVisible ? 'Asset visible' : 'Asset hidden', 'success');
                    this.refreshAssets();
                    this.refreshCoverage();
                } catch (e) {
                    console.error(e);
                    showToast(`Update failed: ${e.message}`, 'error');
                }
            },

            async deleteAsset(assetId) {
                const ok = confirm('Delete this asset record? (This does not delete the file from storage.)');
                if (!ok) return;
                try {
                    await this.fetchJson(`/api/admin/proof-assets?asset_id=${encodeURIComponent(assetId)}`, { method: 'DELETE' });
                    showToast('Asset deleted', 'success');
                    this.refreshAssets();
                    this.refreshCoverage();
                } catch (e) {
                    console.error(e);
                    showToast(`Delete failed: ${e.message}`, 'error');
                }
            },

            async deleteCurrentAsset() {
                if (!this._currentEditingAssetId) {
                    showToast('No asset selected for deletion', 'error');
                    return;
                }
                
                const assetId = this._currentEditingAssetId;
                const ok = confirm(' DELETE THIS ASSET?\n\nThis will permanently remove the asset record from the database.\n\nThe media file will remain in storage but will no longer be accessible from the library.\n\nContinue?');
                if (!ok) return;
                
                try {
                    await this.fetchJson(`/api/admin/proof-assets?asset_id=${encodeURIComponent(assetId)}`, { method: 'DELETE' });
                    showToast('Asset deleted successfully', 'success');
                    
                    // Close editor
                    this.cancelEdit();
                    
                    // Refresh library
                    await this.refreshAssets();
                    await this.refreshCoverage();
                    await this.refreshLivePreview();
                } catch (e) {
                    console.error('[DELETE ERROR]', e);
                    showToast(`Delete failed: ${e.message}`, 'error');
                }
            },

            async beginEditAssetMedia(assetId) {
                console.log(`[Editor] Loading asset ${assetId}...`);
                
                // Store the current asset ID for delete button
                this._currentEditingAssetId = assetId;
                
                const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                const asset = items.find(a => String(a?.asset_id || '') === String(assetId));
                if (!asset) {
                    showToast('Asset not found. Refresh the library and try again.', 'error');
                    return;
                }

                const mediaKind = String(asset?.media_kind || '').trim();
                const isVideo = (mediaKind === 'video');

                // Ensure Supabase config is loaded so we can build a public preview URL.
                const sb = await this.ensureSupabaseConfig();
                if (!sb?.ok || !sb?.url) {
                    showToast('Supabase config unavailable (no preview URL). Click Refresh and verify backend env.', 'error');
                    return;
                }

                const bucket = String(asset?.storage_bucket || 'proof');
                const path = String(asset?.storage_path || '');
                const baseUrl = this.publicStorageUrl(bucket, path);
                const url = baseUrl ? `${baseUrl}?v=${Date.now()}` : '';
                if (!url) {
                    showToast('Missing preview URL (check Supabase config / storage path).', 'error');
                    return;
                }

                // Always open editor in the Library workspace.
                this.setMode('library');

                // Hide the upload summary while editing (no mixed modes).
                const uploadSummary = document.getElementById('ppFileSummary');
                if (uploadSummary) {
                    uploadSummary.innerHTML = '';
                    this.setHidden(uploadSummary, true);
                }

                const editorCard = document.getElementById('ppLibraryEditor');
                const editorBody = document.getElementById('ppLibraryEditorBody');
                if (!editorCard || !editorBody) {
                    showToast('Editor UI missing (refresh page).', 'error');
                    return;
                }

                // Show editor immediately with loading state - no skeleton flicker
                
                // REPARENT STRATEGY: Move to body to escape CSS transform isolation
                if (editorCard.parentNode !== document.body) {
                    console.log('[Modal] Reparenting to body from:', editorCard.parentElement?.id || editorCard.parentElement?.tagName);
                    // Store strict reference to original location
                    this.state._modalOriginalParent = editorCard.parentElement;
                    this.state._modalOriginalNext = editorCard.nextElementSibling;
                    
                    document.body.appendChild(editorCard);
                    console.log('[Modal] Moved to body.');
                } else {
                    console.warn('[Modal] Already in body, skipping reparent');
                }

                document.body.style.overflow = 'hidden';
                editorCard.classList.remove('is-hidden');
                // We'll render the full UI right away and let the media element load in background

                // Capture original field homes so we can restore later.
                const rotateField = document.getElementById('ppRotateField');
                const trimField = document.getElementById('ppTrimField');
                if (rotateField && !this.state._rotateFieldHome) {
                    this.state._rotateFieldHome = rotateField.parentElement;
                    this.state._rotateFieldNext = rotateField.nextSibling;
                }
                if (trimField && !this.state._trimFieldHome) {
                    this.state._trimFieldHome = trimField.parentElement;
                    this.state._trimFieldNext = trimField.nextSibling;
                }

                // Prepare editor state
                this.state.edit = { assetId: String(assetId), asset };
                this.state.file = null;
                this.state.analysis = null;
                
                // CRITICAL FIX: Clear trim inputs to prevent state contamination
                const trimStartEl = document.getElementById('ppTrimStartSec');
                const trimEndEl = document.getElementById('ppTrimEndSec');
                if (trimStartEl) trimStartEl.value = '';
                if (trimEndEl) trimEndEl.value = '';
                
                // Clear trim from localStorage for this asset
                try {
                    localStorage.removeItem(this.storageKeys.trimStartSec);
                    localStorage.removeItem(this.storageKeys.trimEndSec);
                } catch (e) {
                    console.warn('[ProofPacks] Failed to clear trim from localStorage:', e);
                }
                
                // Show these controls in editor.
                if (rotateField) rotateField.style.display = '';
                if (trimField) trimField.style.display = isVideo ? '' : 'none';

                // Reset editor controls to defaults
                const rotateEl = document.getElementById('ppVideoRotate');
                if (rotateEl) rotateEl.value = '0';
                const bwEl = document.getElementById('ppFilterBw');
                if (bwEl && typeof bwEl.checked === 'boolean') bwEl.checked = false;
                
                // Render editor HTML and bind controls immediately for instant interactivity
                await this.renderEditorUI(asset, url, isVideo, editorBody, rotateField, trimField);

                // Hydrate editor from saved metadata (smart_crop_details) so the UI matches the resting card.
                this.hydrateEditorFromAsset(asset);

                // Touch discoverability: show the drag hint briefly.
                try {
                    if (this.isTouchUi && this.isTouchUi()) {
                        const sc = document.getElementById('ppStageContainer') || document.querySelector('.pp-stage-container');
                        if (sc) {
                            sc.classList.add('pp-touch-hint');
                            setTimeout(() => sc.classList.remove('pp-touch-hint'), 2500);
                        }
                    }
                } catch {
                    // ignore
                }
                
                // Bind controls right away (no wait for media)
                this.bindPreviewEditor();
                this.applyLocalPreviewRotation();
                this.applyEditorRotation();
                // Use the placement context from where user clicked (hero vs rail)
                const contextMap = { hero: 'hero', rail: 'proof_rail' };
                const targetContext = contextMap[this.state._editPlacement] || 'proof_rail';
                if (typeof this.updatePreviewContext === 'function') this.updatePreviewContext(targetContext);
                this.bindModernTimeline();
                this.bindStageDisplayModes();
                this.bindPresetButtons();
                this.bindSmartControls();
                
                // Auto-show Safe Zone on load
                setTimeout(() => {
                    const safeZoneBtn = document.querySelector('[data-mode="safezone"]');
                    const safeZoneOverlay = document.getElementById('ppSafeZoneOverlay');
                    if (safeZoneBtn && safeZoneOverlay) {
                        safeZoneOverlay.style.display = 'flex';
                        safeZoneBtn.classList.add('active');
                        this.updateSafeZone();
                    }
                }, 100);
                
                if (isVideo) {
                    this.analyzeVideoAndSuggest();
                }
                
                const applyBtn = document.getElementById('ppApplyEdits');
                if (applyBtn && !applyBtn.dataset.bound) {
                    applyBtn.addEventListener('click', () => this.applyEditsToAsset());
                    applyBtn.dataset.bound = 'true';
                }
                
                console.log('[Editor] OK: Editor ready (media loading in background)');
                
                // Scroll editor into view immediately
                setTimeout(() => {
                    editorCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                }, 50);
                
                // Load media in background and show feedback when ready
                const mediaEl = document.getElementById('ppEditorVideo');
                if (mediaEl) {
                    if (isVideo) {
                        this.waitForVideoLoad(mediaEl).then(() => {
                            console.log('[Editor] OK: Video loaded');
                        }).catch(e => {
                            console.warn('[Editor] Video load warning:', e);
                        });
                    } else {
                        this.waitForImageLoad(mediaEl).then(() => {
                            console.log('[Editor] OK: Image loaded');
                        }).catch(e => {
                            console.warn('[Editor] Image load warning:', e);
                        });
                    }
                }
            },
            
            // Wait for video metadata to load
            async waitForVideoLoad(videoEl, timeout = 10000) {
                return new Promise((resolve, reject) => {
                    if (videoEl.readyState >= 1) {
                        resolve();
                        return;
                    }
                    
                    const onLoad = () => {
                        clearTimeout(timeoutId);
                        videoEl.removeEventListener('error', onError);
                        resolve();
                    };
                    
                    const onError = (e) => {
                        clearTimeout(timeoutId);
                        videoEl.removeEventListener('loadedmetadata', onLoad);
                        reject(new Error(`Video load failed: ${e.message || 'Network error'}`));
                    };
                    
                    const timeoutId = setTimeout(() => {
                        videoEl.removeEventListener('loadedmetadata', onLoad);
                        videoEl.removeEventListener('error', onError);
                        reject(new Error('Video load timeout (10s)'));
                    }, timeout);
                    
                    videoEl.addEventListener('loadedmetadata', onLoad, { once: true });
                    videoEl.addEventListener('error', onError, { once: true });
                });
            },
            
            // Wait for image to load
            async waitForImageLoad(imgEl, timeout = 10000) {
                return new Promise((resolve, reject) => {
                    if (imgEl.complete && imgEl.naturalWidth > 0) {
                        resolve();
                        return;
                    }
                    
                    const onLoad = () => {
                        clearTimeout(timeoutId);
                        imgEl.removeEventListener('error', onError);
                        resolve();
                    };
                    
                    const onError = (e) => {
                        clearTimeout(timeoutId);
                        imgEl.removeEventListener('load', onLoad);
                        reject(new Error(`Image load failed: ${e.message || 'Network error'}`));
                    };
                    
                    const timeoutId = setTimeout(() => {
                        imgEl.removeEventListener('load', onLoad);
                        imgEl.removeEventListener('error', onError);
                        reject(new Error('Image load timeout (10s)'));
                    }, timeout);
                    
                    imgEl.addEventListener('load', onLoad, { once: true });
                    imgEl.addEventListener('error', onError, { once: true });
                });
            },
            
            // Show error state in editor
            showEditorError(editorBody, error, assetId) {
                const errorMsg = this.getEditorErrorMessage(error);
                editorBody.innerHTML = `
                    <div class="pp-editor-error">
                        <svg class="pp-error-icon" width="64" height="64" viewBox="0 0 64 64">
                            <circle cx="32" cy="32" r="30" stroke="#ff3b30" stroke-width="4" fill="none"/>
                            <path d="M32 20v16M32 44v2" stroke="#ff3b30" stroke-width="4" stroke-linecap="round"/>
                        </svg>
                        <h3>Failed to load editor</h3>
                        <p>${this.escapeHtml(errorMsg)}</p>
                        <div class="pp-error-actions">
                            <button class="pp-btn-primary" onclick="proofPacks.beginEditAssetMedia('${this.escapeHtml(assetId)}')">Retry</button>
                            <button class="pp-btn-secondary" onclick="proofPacks.cancelEdit()">Close</button>
                        </div>
                    </div>
                `;
            },
            
            // Get user-friendly error message
            getEditorErrorMessage(error) {
                const msg = error?.message || String(error);
                
                if (msg.includes('timeout')) {
                    return 'Video took too long to load. Check your connection and try again.';
                }
                if (msg.includes('Network') || msg.includes('load failed')) {
                    return 'Network error. Video file may be corrupted or unavailable.';
                }
                if (msg.includes('CORS')) {
                    return 'Video cannot be loaded due to access restrictions.';
                }
                if (msg.includes('not found')) {
                    return 'Media element not found. Please refresh the page.';
                }
                
                return 'An unexpected error occurred. Please try again.';
            },
            
            // Render editor UI (extracted from beginEditAssetMedia)
            async renderEditorUI(asset, url, isVideo, editorBody, rotateField, trimField) {
                const assetId = String(asset?.asset_id || '');

                const previewEl = isVideo 
                    ? `<video id="ppLocalPreviewVideo" src="${this.escapeHtml(url)}" muted playsinline preload="auto" fetchpriority="high" style="width:calc(100% - 32px); max-width:900px; height:100%; margin:0 auto; display:block; object-fit:contain;"></video>`
                    : `<img id="ppLocalPreviewVideo" src="${this.escapeHtml(url)}" fetchpriority="high" style="width:calc(100% - 32px); max-width:900px; height:100%; margin:0 auto; display:block; object-fit:contain;" />`;

                // Modern Timeline Component (for videos only)
                const timelineContent = isVideo ? `
                    <div class="pp-timeline-pro">
                        <canvas class="pp-timeline-waveform" width="1000" height="50"></canvas>
                        <div class="pp-trim-range" id="ppTrimRange" style="left: 0%; width: 100%;">
                            <div class="pp-trim-handle pp-trim-start" id="ppTrimHandleStart"></div>
                            <div class="pp-trim-handle pp-trim-end" id="ppTrimHandleEnd"></div>
                        </div>
                        <div class="pp-playhead" id="ppPlayhead" style="left: 0%;">
                            <div class="pp-playhead-line"></div>
                            <div class="pp-playhead-time" id="ppPlayheadTime">0:00</div>
                        </div>
                        <div class="pp-timeline-markers" id="ppTimelineMarkers">
                            <span>0:00</span>
                            <span>0:01</span>
                            <span>0:02</span>
                            <span>0:03</span>
                            <span>0:04</span>
                        </div>
                    </div>
                ` : '';

                // Playback Controls
                const playbackControls = isVideo ? `
                    <div class="pp-playback-controls">
                        <button id="ppPreviewPlayPause" class="editor-tool-btn" type="button" title="Play/Pause (Space)" aria-label="Play/Pause">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display:block;"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <span id="ppPreviewTime" class="u-text-sm u-muted" style="font-variant-numeric: tabular-nums; margin-left: 12px;">0:00 / 0:00</span>
                        <div style="flex:1;"></div>
                        <div class="editor-toggle">
                            <label for="ppLoopTrim" style="margin-right:8px;">Loop Trim</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="ppLoopTrim">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                ` : '';

                const editorContent = `
                    <div class="pp-editor-card" style="border:none; box-shadow:none;">
                        
                        <!-- Header -->
                        <div class="editor-header">
                            <div>
                                <h3 class="editor-title">Edit Media</h3>
                                <div class="editor-subtitle">ID: ${assetId} | ${isVideo ? 'Video' : 'Image'} Asset</div>
                            </div>
                            <div class="editor-status">
                                <span class="editor-badge">${isVideo ? 'HD Video' : 'HQ Image'}</span>
                                <button class="editor-close" onclick="proofPacks.cancelEdit()" title="Close" aria-label="Close">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                </button>
                            </div>
                        </div>

                        <!-- SCROLLABLE CONTENT WRAPPER START -->
                        <div id="ppEditorScrollArea" style="flex: 1; overflow-y: auto; padding-bottom: 40px; display: flex; flex-direction: column;">

                        <!-- Toolbar -->
                        <div class="editor-toolbar">
                             <!-- Left: Safe Zone Toggle -->
                             <div class="editor-view-toggle">
                                <button class="editor-view-btn" data-mode="safezone" title="Toggle crop boundaries">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px; vertical-align:middle;">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <path d="M9 3v18M15 3v18M3 9h18M3 15h18"/>
                                    </svg>
                                    Safe Zone
                                </button>
                                <span style="margin-left:12px; font-size:11px; color:#64748b;">Shows exact crop for selected context below</span>
                             </div>
                             
                             <!-- Right: History Tools -->
                             <div class="pp-editor-history" style="display:flex; gap:8px; margin-left: auto;">
                                <button id="ppUndoBtn" disabled class="editor-tool-btn" title="Undo (Ctrl+Z)"><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/></svg></button>
                                <button id="ppRedoBtn" disabled class="editor-tool-btn" title="Redo (Ctrl+Y)"><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
                            </div>
                        </div>

                        <!-- Top: Flexible Video Stage -->
                        <div class="pp-stage-container" id="ppStageContainer" style="flex: none; height: 450px; min-height: 450px; width: 100%; display: flex; align-items: center; justify-content: center; background: #f8f9fa; position: relative; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 24px; overflow: hidden;">

                            <div class="pp-stage-drag-hint" id="ppStageDragHint">Drag to position</div>

                            <div class="pp-load-overlay is-visible" id="ppStageLoadOverlay">
                                <div class="pp-load-spinner"></div>
                                <div class="pp-load-title">Loading preview...</div>
                                <div class="pp-load-subtitle">Getting the stage ready</div>
                            </div>

                            <div class="pp-error-overlay" id="ppStageErrorOverlay">
                                <div class="pp-error-box">
                                    <div class="pp-error-title">Preview failed to load</div>
                                    <div class="pp-error-subtitle">Try a different file, or a shorter clip.</div>
                                </div>
                            </div>
                            
                            <!-- Scale Indicator -->
                            <div id="ppScaleIndicator" style="position:absolute; top:12px; right:12px; background:rgba(0,0,0,0.75); color:white; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600; z-index:50; pointer-events:none; opacity:0; transition:opacity 0.2s;">100%</div>

                            <div class="pp-video-stage" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                <div id="ppEditorRotator" style="display:flex; align-items:center; justify-content:center; width:100%; height:100%; transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: center center;">
                                    ${previewEl.replace('ppLocalPreviewVideo', 'ppEditorVideo')}
                                </div>
                                <div class="pp-stage-overlay" id="ppStageOverlay" style="display:none;">
                                    <div class="pp-grid-overlay">
                                        <div class="pp-grid-line vertical" style="left: 33.33%;"></div>
                                        <div class="pp-grid-line vertical" style="left: 66.66%;"></div>
                                        <div class="pp-grid-line horizontal" style="top: 33.33%;"></div>
                                        <div class="pp-grid-line horizontal" style="top: 66.66%;"></div>
                                    </div>
                                </div>
                                
                                <!-- Safe Zone Overlay -->
                                <div class="pp-safezone-overlay" id="ppSafeZoneOverlay" style="display:none;">
                                    <div class="pp-safezone-rect" id="ppSafeZoneRect">
                                        <div class="pp-safezone-corner" style="top:0; left:0;"></div>
                                        <div class="pp-safezone-corner" style="top:0; right:0;"></div>
                                        <div class="pp-safezone-corner" style="bottom:0; left:0;"></div>
                                        <div class="pp-safezone-corner" style="bottom:0; right:0;"></div>
                                        <div class="pp-safezone-label" id="ppSafeZoneLabel">Proof Rail | 4:3 | 160x120</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pp-stage-info" style="position: absolute; bottom: 12px; left: 12px;">
                                <span class="pp-info-badge">Edited</span>
                                <span class="pp-info-resolution" id="ppInfoResolution">-</span>
                                <span class="pp-info-fps" id="ppInfoFps">-</span>
                                <span class="pp-info-loop" id="ppInfoLoop" style="display:none;">Looping</span>
                            </div>
                        </div>

                        <!-- Bottom: Controls Block (Fixed/Scrollable as needed) -->
                        <div class="pp-editor-bottom-section">
                            ${playbackControls}
                            
                            <div class="pp-timeline-container">
                                ${timelineContent}
                            </div>
                            
                            <div class="pp-control-section">
                                <div class="editor-section-title">Quick Crops</div>
                                <div class="crop-presets">
                                    <button class="crop-preset-btn" data-preset="center-fill"><svg class="crop-preset-icon" viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="12" rx="1"/></svg>Center & Fill</button>
                                    <button class="crop-preset-btn" data-preset="top-third"><svg class="crop-preset-icon" viewBox="0 0 16 16"><rect x="2" y="2" width="12" height="4" rx="1"/><rect x="2" y="7" width="12" height="7" rx="1" opacity="0.3"/></svg>Top Third</button>
                                    <button class="crop-preset-btn" data-preset="cinematic"><svg class="crop-preset-icon" viewBox="0 0 16 16"><rect x="1" y="4" width="14" height="8" rx="1"/></svg>Cinematic</button>
                                    <button class="crop-preset-btn" data-preset="portrait"><svg class="crop-preset-icon" viewBox="0 0 16 16"><rect x="5" y="1" width="6" height="14" rx="1"/></svg>Portrait</button>
                                </div>
                            </div>
                            
                            <div class="pp-controls-grid">
                                <!-- Metadata & Classification -->
                                <div class="pp-control-section" style="grid-column: 1 / -1;">
                                    <div class="editor-section-title">Classification</div>
                                    <div style="display:grid; grid-template-columns: 2fr 1fr; gap:16px;">
                                        <div class="editor-select">
                                            <label>Intent</label>
                                            <div class="editor-select-trigger">
                                                <select id="ppEditIntent" style="border:none; width:100%; background:transparent; font-size:14px; outline:none; color:inherit;">
                                                    <option value="working_shot" ${(String(asset?.customer_intent || '') === 'working_shot') ? 'selected' : ''}>Working Shot</option>
                                                    <option value="action_proof" ${(String(asset?.customer_intent || '') === 'action_proof') ? 'selected' : ''}>Action Proof</option>
                                                    <option value="result_proof" ${(String(asset?.customer_intent || '') === 'result_proof') ? 'selected' : ''}>Result Proof</option>
                                                    <option value="" ${(String(asset?.customer_intent || '') === '') ? 'selected' : ''}>Unclassified</option>
                                                </select>
                                                <svg width="12" height="12" viewBox="0 0 12 12" style="opacity:0.5;"><path d="M2 4L6 8L10 4" stroke="currentColor" fill="none"/></svg>
                                            </div>
                                        </div>
                                        <div class="editor-toggle" style="flex-direction:column; align-items:flex-start; height:100%; justify-content:center;">
                                            <label style="margin-bottom:8px;">Priority</label>
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="ppEditFeatured" ${(Number(asset?.psychological_weight || 5) > 40) ? 'checked' : ''}>
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <div class="pp-control-section">
                                    <div class="editor-slider-label"><span>Rotation</span><button class="pp-btn-icon-sm" onclick="proofPacks.resetControl('rotation')" aria-label="Reset rotation"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><path d="M21 12a9 9 0 1 1-3-6.7"/><polyline points="21 3 21 9 15 9"/></svg></button><span id="ppRotationValue">0deg</span></div>
                                    <input id="ppVideoRotate" type="range" class="editor-slider" min="0" max="270" step="90" value="0">
                                </div>
                                <div class="pp-control-section">
                                    <div class="editor-slider-label"><span>Scale</span><button class="pp-btn-icon-sm" onclick="proofPacks.resetControl('scale')" aria-label="Reset scale"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><path d="M21 12a9 9 0 1 1-3-6.7"/><polyline points="21 3 21 9 15 9"/></svg></button><span id="ppScaleValue">100%</span></div>
                                    <input id="ppScalePct" type="range" class="editor-slider" min="50" max="200" step="5" value="100">
                                </div>
                                <div class="pp-control-section">
                                    <div class="editor-slider-label"><span>Tilt</span><button class="pp-btn-icon-sm" onclick="proofPacks.resetControl('tilt')" aria-label="Reset tilt"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><path d="M21 12a9 9 0 1 1-3-6.7"/><polyline points="21 3 21 9 15 9"/></svg></button><span id="ppTiltValue">0deg</span></div>
                                    <input id="ppTiltDeg" type="range" class="editor-slider" min="-10" max="10" step="0.5" value="0">
                                </div>
                                <div class="pp-control-section">
                                    <div class="editor-slider-label"><span>Position</span><button class="pp-btn-icon-sm" onclick="proofPacks.resetControl('position')" aria-label="Reset position"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><path d="M21 12a9 9 0 1 1-3-6.7"/><polyline points="21 3 21 9 15 9"/></svg></button><span id="ppPanValue">0, 0</span></div>
                                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                                        <input id="ppPanX" type="range" class="editor-slider" min="-50" max="50" step="1" value="0">
                                        <input id="ppPanY" type="range" class="editor-slider" min="-50" max="50" step="1" value="0">
                                    </div>
                                </div>

                                <!-- START FRONTEND PREVIEW -->
                                <div class="pp-control-section" style="grid-column: 1 / -1; margin-top: 24px; border-top: 1px solid var(--pp-border); padding-top: 24px;">
                                    <div class="editor-section-title" style="color: var(--pp-primary);">Frontend Preview & Placement</div>
                                    
                                    <div class="pp-editor-preview-layout" style="display: grid; grid-template-columns: 1fr 300px; gap: 24px; align-items: start;">
                                        
                                        <!-- Left: Controls -->
                                        <div class="pp-editor-live-controls" style="display: flex; flex-direction: column; gap: 24px;">
                                            
                                            <!-- Crop Mode -->
                                            <div>
                                                <label class="u-text-xs u-muted u-mb-1" style="display:block; margin-bottom:8px;">Crop Mode</label>
                                                <div style="display:flex;">
                                                    <button class="crop-mode-btn active" data-mode="cover" onclick="proofPacks.setCropMode('cover', this)">Fill (Cover)</button>
                                                    <button class="crop-mode-btn" data-mode="contain" onclick="proofPacks.setCropMode('contain', this)">Fit (Contain)</button>
                                                    <button class="crop-mode-btn" data-mode="manual" onclick="proofPacks.setCropMode('manual', this)">Custom</button>
                                                </div>
                                            </div>

                                            <!-- Reframe (drag-first) -->
                                            <div>
                                                <label class="u-text-xs u-muted u-mb-1" style="display:block; margin-bottom:8px;">Reframe</label>
                                                <div style="font-size:12px; color:#64748b; line-height:1.35;">
                                                    Drag on the stage or live preview to set the focal point. Double-click to reset.
                                                    <span style="display:block; margin-top:4px;">Custom mode: drag to pan the image.</span>
                                                </div>
                                                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
                                                    <button class="pp-btn-secondary-sm" type="button" onclick="proofPacks.applyFocalPercent(50, 50)">Reset center</button>
                                                </div>

                                                <details class="fine-tune-details" style="margin-top:12px; border:1px solid #e2e8f0; border-radius:8px; padding:8px; background:white;">
                                                    <summary style="font-size:12px; font-weight:500; color:#64748b; cursor:pointer; outline:none;">Advanced</summary>
                                                    <div style="padding-top:12px;">
                                                        <div style="font-size:12px; color:#64748b; margin-bottom:8px;">Precision coordinates (percent).</div>
                                                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px;">
                                                             <div>
                                                                 <label style="font-size:10px; color:#64748b; display:block; margin-bottom:4px;">X (%)</label>
                                                                 <input type="number" id="ppFocalX" class="pp-input" value="50" min="0" max="100" onchange="proofPacks.updateFocalFromInput()">
                                                             </div>
                                                             <div>
                                                                 <label style="font-size:10px; color:#64748b; display:block; margin-bottom:4px;">Y (%)</label>
                                                                 <input type="number" id="ppFocalY" class="pp-input" value="50" min="0" max="100" onchange="proofPacks.updateFocalFromInput()">
                                                             </div>
                                                        </div>
                                                    </div>
                                                </details>
                                            </div>

                                            <!-- Destinations -->
                                            <div>
                                                <label class="u-text-xs u-muted u-mb-1" style="display:block; margin-bottom:8px;">Frontend Destinations</label>
                                                <div class="destination-list" id="ppDestinationList">
                                                    <!-- Bundle Hero -->
                                                    <div class="destination-card" draggable="true" data-context="hero" data-priority="1">
                                                        <div class="drag-handle">::</div>
                                                        <div class="destination-info">
                                                            <span class="destination-name">Bundle Hero</span>
                                                            <span class="destination-meta">1200x600 | Priority: 1</span>
                                                        </div>
                                                        <div class="destination-actions">
                                                            <button class="btn-preview" onclick="proofPacks.updatePreviewContext('hero'); event.stopPropagation();">Preview</button>
                                                        </div>
                                                        <input type="hidden" class="pp-dest-check" value="hero">
                                                    </div>
                                                    
                                                    <!-- Gallery Grid -->
                                                    <div class="destination-card" draggable="true" data-context="gallery" data-priority="2">
                                                        <div class="drag-handle">::</div>
                                                        <div class="destination-info">
                                                            <span class="destination-name">Gallery Grid</span>
                                                            <span class="destination-meta">400x400 | Priority: 2</span>
                                                        </div>
                                                        <div class="destination-actions">
                                                            <button class="btn-preview" onclick="proofPacks.updatePreviewContext('gallery'); event.stopPropagation();">Preview</button>
                                                        </div>
                                                        <input type="hidden" class="pp-dest-check" value="gallery">
                                                    </div>

                                                    <!-- Grid -->
                                                    <div class="destination-card" draggable="true" data-context="grid" data-priority="3">
                                                        <div class="drag-handle">::</div>
                                                        <div class="destination-info">
                                                            <span class="destination-name">Grid</span>
                                                            <span class="destination-meta">400x400 | Priority: 3</span>
                                                        </div>
                                                        <div class="destination-actions">
                                                            <button class="btn-preview" onclick="proofPacks.updatePreviewContext('grid'); event.stopPropagation();">Preview</button>
                                                        </div>
                                                        <input type="hidden" class="pp-dest-check" value="grid">
                                                    </div>

                                                    <!-- Carousel -->
                                                    <div class="destination-card" draggable="true" data-context="carousel" data-priority="4">
                                                        <div class="drag-handle">::</div>
                                                        <div class="destination-info">
                                                            <span class="destination-name">Homepage Carousel</span>
                                                            <span class="destination-meta">1920x1080 | Priority: 4</span>
                                                        </div>
                                                        <div class="destination-actions">
                                                            <button class="btn-preview" onclick="proofPacks.updatePreviewContext('carousel'); event.stopPropagation();">Preview</button>
                                                        </div>
                                                        <input type="hidden" class="pp-dest-check" value="carousel">
                                                    </div>
                                                </div>
                                                <button class="btn-add-destination" style="margin-top:8px;" onclick="showToast('Add destination not implemented in demo', 'info')">+ Add Placement</button>
                                            </div>

                                        </div>

                                        <!-- Right: Live Preview -->
                                        <div class="pp-editor-live-preview">
                                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                                <label class="u-text-xs u-muted">Where will this appear?</label>
                                                <div class="editor-select-trigger" style="padding:4px 8px; width:auto;">
                                                    <select id="ppPreviewContext" onchange="proofPacks.updatePreviewContext(this.value)" style="font-size:12px; border:none; background:transparent; outline:none;">
                                                        <option value="proof_rail">Proof Tiles (4:3) - Main shop page</option>
                                                        <option value="hero">Hero Banner (2:1) - Top of bundle</option>
                                                        <option value="gallery">Gallery (1:1) - Photo grid</option>
                                                        <option value="carousel">Homepage (16:9) - Carousel</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div style="font-size:10px; color:#64748b; margin-bottom:8px; line-height:1.3;" id="ppPreviewContextHelp">
                                                Shows in customer-facing proof rail tiles (most important)
                                            </div>
                                            
                                            <div class="pp-preview-frame" id="ppLivePreviewFrame" data-ratio="4:3" style="background:#f1f5f9; border:2px solid #e2e8f0; border-radius:12px; overflow:hidden; position:relative; width:160px; height:120px; box-shadow: var(--pp-shadow-sm);">
                                                <div class="pp-load-overlay is-visible" id="ppLiveLoadOverlay">
                                                    <div class="pp-load-spinner"></div>
                                                    <div class="pp-load-title">Loading live preview...</div>
                                                    <div class="pp-load-subtitle">Applying destination framing</div>
                                                </div>

                                                <div class="pp-error-overlay" id="ppLiveErrorOverlay">
                                                    <div class="pp-error-box">
                                                        <div class="pp-error-title">Live preview failed</div>
                                                        <div class="pp-error-subtitle">The stage can still be edited.</div>
                                                    </div>
                                                </div>
                                                <div id="ppLivePreviewRotator" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; transform-origin:center center; will-change:transform;">
                                                    ${isVideo ? 
                                                        `<video id="ppPreviewMedia" src="${this.escapeHtml(url)}" style="width:100%; height:100%; object-fit:cover; object-position:center;" muted loop autoplay playsinline preload="auto" fetchpriority="low"></video>` :
                                                        `<img id="ppPreviewMedia" src="${this.escapeHtml(url)}" fetchpriority="low" style="width:100%; height:100%; object-fit:cover; object-position:center;" />`
                                                    }
                                                </div>
                                                <div class="pp-preview-overlay" style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.6); color:white; padding:4px 8px; font-size:11px;">
                                                    Desktop | 1200x600 | Cover
                                                </div>
                                            </div>
                                            <div id="ppQualityIndicator" style="margin-top:8px; font-size:11px; color:var(--pp-success); background:var(--pp-success-bg); padding:4px 8px; border-radius:12px; display:inline-block; font-weight:500;">
                                                <span style="display:inline-block; width:8px; height:8px; border-radius:999px; background:var(--pp-success); margin-right:6px; vertical-align:middle;"></span>High Quality
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <!-- END FRONTEND PREVIEW -->

                                <div class="pp-control-section" style="margin-top:24px;">
                                    <div class="editor-section-title">Adjustments <button class="pp-btn-icon-sm" onclick="proofPacks.resetControl('filters')" aria-label="Reset adjustments"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:block;"><path d="M21 12a9 9 0 1 1-3-6.7"/><polyline points="21 3 21 9 15 9"/></svg></button></div>
                                    <div style="margin-bottom:16px;">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="ppFilterGrayscale" ${(String(asset?.filter_bw || '') === '1') ? 'checked' : ''}>
                                            <span class="toggle-slider"></span>
                                        </label>
                                        <span style="font-size:13px; color:var(--pp-text-secondary); margin-left:8px;">Black & White</span>
                                    </div>
                                    
                                    <div class="editor-slider-label"> <!-- Brightness -->
                                        <span>Brightness</span>
                                        <span id="ppBrightnessValue">${Number(asset?.filter_brightness || 100)}%</span>
                                    </div>
                                    <input id="ppBrightness" type="range" class="editor-slider" min="50" max="150" step="5" value="${Number(asset?.filter_brightness || 100)}">

                                    <div class="editor-slider-label" style="margin-top:12px;"> <!-- Contrast -->
                                        <span>Contrast</span>
                                        <span id="ppContrastValue">${Number(asset?.filter_contrast || 100)}%</span>
                                    </div>
                                    <input id="ppContrast" type="range" class="editor-slider" min="50" max="150" step="5" value="${Number(asset?.filter_contrast || 100)}">

                                    <div class="editor-slider-label" style="margin-top:12px;"> <!-- Saturation -->
                                        <span>Saturation</span>
                                        <span id="ppSaturationValue">${Number(asset?.filter_saturation || 100)}%</span>
                                    </div>
                                    <input id="ppSaturation" type="range" class="editor-slider" min="0" max="200" step="5" value="${Number(asset?.filter_saturation || 100)}">
                                </div>
                            </div>
                        </div>

                        </div> <!-- END SCROLLABLE CONTENT WRAPPER -->

                        <!-- Static Footer (Outside Scroll Area) -->
                        <div class="editor-footer" style="flex-shrink: 0; background: #ffffff !important; opacity: 1 !important; border-top: 1px solid #e2e8f0; z-index: 1000; display: flex; align-items: center; padding: 16px 24px; gap: 12px;">
                            <button class="editor-delete" onclick="proofPacks.deleteCurrentAsset()" style="background:#ef4444;color:white;padding:8px 16px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" title="Delete this asset permanently">Delete Asset</button>
                            <span id="ppEditStatus" class="u-text-sm u-muted" style="margin-right:auto;"></span>
                            <button class="editor-cancel" onclick="proofPacks.cancelEdit()">Cancel</button>
                            <button id="ppApplyEdits" class="editor-save" style="min-width:140px;">Apply & Save</button>
                        </div>
                    </div>
                `;

                editorBody.innerHTML = editorContent;

                // Bindings
                if (typeof this.bindMediaLoadIndicators === 'function') this.bindMediaLoadIndicators();
                if (typeof this.bindStageDragPan === 'function') this.bindStageDragPan();
                if(this.bindVideoResizer) this.bindVideoResizer(); // Legacy hook kept, effectively no-op now
                this.bindPreviewEditor();
                this.applyEditorRotation();
                this.bindModernTimeline();
                this.bindStageDisplayModes();
                this.bindPresetButtons();
                this.bindSmartControls();
                if(this.initDragAndDrop) this.initDragAndDrop();
                
                // --- BIND VIEW TOGGLE BUTTONS (Start) ---
                const viewBtns = editorBody.querySelectorAll('.editor-view-btn');
                viewBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Deactivate all
                        viewBtns.forEach(b => b.classList.remove('active'));
                        // Activate clicked
                        btn.classList.add('active');
                        
                        const mode = btn.dataset.mode || 'preview';
                        const stageOverlay = document.getElementById('ppStageOverlay');
                        const previewVid = document.getElementById('ppEditorVideo');
                        const rotator = document.getElementById('ppEditorRotator');

                        if (mode === 'grid') {
                            if (stageOverlay) stageOverlay.style.display = 'block';
                            // Ensure edits are visible
                            if (rotator) rotator.style.transform = rotator.style.transform || ''; 
                        } else if (mode === 'original') {
                            if (stageOverlay) stageOverlay.style.display = 'none';
                            // Temporarily strip transform for "Original" view
                            if (rotator) {
                                rotator._savedTransform = rotator.style.transform;
                                rotator.style.transform = 'none';
                                rotator.style.filter = 'none';
                            }
                            if (previewVid) previewVid.style.filter = 'none';
                        } else {
                            // Preview Mode (Default)
                            if (stageOverlay) stageOverlay.style.display = 'none';
                            // Restore edits
                            if (rotator && rotator._savedTransform) {
                                rotator.style.transform = rotator._savedTransform;
                            } else {
                                this.applyEditorRotation(); // Re-calc if needed
                            }
                        }
                    });
                });
                // --- BIND VIEW TOGGLE BUTTONS (End) ---
                
                // Special handling for old controls if they were passed
                if (rotateField) rotateField.style.display = 'none';
                if (trimField) trimField.style.display = 'none';

                const applyBtn = document.getElementById('ppApplyEdits');
                if (applyBtn && !applyBtn.dataset.bound) {
                    applyBtn.addEventListener('click', () => this.applyEditsToAsset());
                    applyBtn.dataset.bound = 'true';
                }
            },
            
            // Video Resizer Logic (Updated - mainly for debug now, CSS handles layout)
            bindVideoResizer() {
                // No-op for layout, kept for compatibility if called elsewhere
            },

            // Modern Timeline Component Binding
            bindModernTimeline() {
                const timeline = document.getElementById('ppTrimRange');
                const handleStart = document.getElementById('ppTrimHandleStart');
                const handleEnd = document.getElementById('ppTrimHandleEnd');
                const playhead = document.getElementById('ppPlayhead');
                const v = document.getElementById('ppEditorVideo');
                
                if (!timeline || !v || !v.duration) return;
                
                let isDragging = false;
                let dragTarget = null;
                
                const updateTimelineFromVideo = () => {
                    if (!v.duration) return;
                    const percent = (v.currentTime / v.duration) * 100;
                    if (playhead) playhead.style.left = `${percent}%`;
                    
                    const playheadTime = document.getElementById('ppPlayheadTime');
                    if (playheadTime) {
                        playheadTime.textContent = this.formatTimeSec(v.currentTime);
                    }
                };
                
                if (v && !v.dataset.boundModernTimeline) {
                    v.addEventListener('timeupdate', updateTimelineFromVideo);
                    v.dataset.boundModernTimeline = 'true';
                }
                
                // Generate time markers
                const markers = document.getElementById('ppTimelineMarkers');
                if (markers && v.duration) {
                    const dur = v.duration;
                    const count = Math.min(6, Math.max(3, Math.ceil(dur)));
                    const html = [];
                    for (let i = 0; i <= count; i++) {
                        const time = (dur * i) / count;
                        html.push(`<span>${this.formatTimeSec(time)}</span>`);
                    }
                    markers.innerHTML = html.join('');
                }
            },
            
            // Stage Display Mode Selector
            bindStageDisplayModes() {
                const modeButtons = document.querySelectorAll('.editor-view-btn');
                const safeZoneOverlay = document.getElementById('ppSafeZoneOverlay');
                
                modeButtons.forEach(btn => {
                    if (btn.dataset.boundMode) return;
                    btn.addEventListener('click', () => {
                        const mode = btn.dataset.mode;
                        
                        if (mode === 'safezone') {
                            // Toggle Safe Zone on/off
                            const isVisible = safeZoneOverlay && safeZoneOverlay.style.display === 'flex';
                            
                            if (isVisible) {
                                // Hide it
                                if (safeZoneOverlay) safeZoneOverlay.style.display = 'none';
                                btn.classList.remove('active');
                            } else {
                                // Show it
                                if (safeZoneOverlay) safeZoneOverlay.style.display = 'flex';
                                this.updateSafeZone();
                                btn.classList.add('active');
                            }
                        }
                    });
                    btn.dataset.boundMode = 'true';
                });
            },
            
            // Preset Button Handlers
            bindPresetButtons() {
                const presets = {
                    'center-fill': { rotation: 0, scale: 100, panX: 0, panY: 0, tilt: 0 },
                    'top-third': { rotation: 0, scale: 110, panX: 0, panY: -15, tilt: 0 },
                    'cinematic': { rotation: 0, scale: 120, panX: 0, panY: 0, tilt: 0 },
                    'portrait': { rotation: 90, scale: 100, panX: 0, panY: 0, tilt: 0 }
                };
                
                document.querySelectorAll('.crop-preset-btn').forEach(btn => {
                    if (btn.dataset.boundPreset) return;
                    btn.addEventListener('click', () => {
                        const presetName = btn.dataset.preset;
                        const preset = presets[presetName];
                        if (!preset) return;
                        
                        // Apply preset values
                        const rotateEl = document.getElementById('ppVideoRotate');
                        const scaleEl = document.getElementById('ppScalePct');
                        const tiltEl = document.getElementById('ppTiltDeg');
                        const panXEl = document.getElementById('ppPanX');
                        const panYEl = document.getElementById('ppPanY');
                        
                        if (rotateEl) rotateEl.value = preset.rotation;
                        if (scaleEl) scaleEl.value = preset.scale;
                        if (tiltEl) tiltEl.value = preset.tilt;
                        if (panXEl) panXEl.value = preset.panX;
                        if (panYEl) panYEl.value = preset.panY;
                        
                        this.applyLocalPreviewRotation();
                        this.updateControlValues();
                        
                        // GAP 9 FIX: Force immediate visual update
                        const rotator = document.getElementById('ppLocalPreviewRotator');
                        if (rotator) {
                            void rotator.offsetHeight; // Force repaint
                            requestAnimationFrame(() => {
                                rotator.style.willChange = 'transform';
                                requestAnimationFrame(() => {
                                    rotator.style.willChange = 'auto';
                                });
                            });
                        }
                        
                        // GAP 3 FIX: Keep preset toast but make it less intrusive
                        this.showToastDebounced(`Preset "${presetName}" applied`, 'success', 'preset-apply', 300);
                    });
                    btn.dataset.boundPreset = 'true';
                });
            },
            
            // Smart Control Bindings
            bindSmartControls() {
                // Rotation control
                const rotateEl = document.getElementById('ppVideoRotate');
                const rotateValue = document.getElementById('ppRotationValue');
                if (rotateEl) {
                    rotateEl.addEventListener('input', () => {
                        if (rotateValue) {
                            rotateValue.textContent = `${rotateEl.value}deg`;
                            this.animateControlValue('ppRotationValue');
                        }
                        this.applyEditorRotation();
                        this.showToastDebounced(`Rotation: ${rotateEl.value}deg`, 'info', 'rotation-change', 800);
                    });
                }
                
                // Scale control
                const scaleEl = document.getElementById('ppScalePct');
                const scaleValue = document.getElementById('ppScaleValue');
                if (scaleEl) {
                    scaleEl.addEventListener('input', () => {
                        if (scaleValue) {
                            scaleValue.textContent = `${scaleEl.value}%`;
                            this.animateControlValue('ppScaleValue');
                        }
                        this.applyEditorRotation();
                    });
                }
                
                // Tilt control
                const tiltEl = document.getElementById('ppTiltDeg');
                const tiltValue = document.getElementById('ppTiltValue');
                if (tiltEl) {
                    tiltEl.addEventListener('input', () => {
                        if (tiltValue) {
                            tiltValue.textContent = `${tiltEl.value}deg`;
                            this.animateControlValue('ppTiltValue');
                        }
                        this.applyEditorRotation();
                    });
                }
                
                // Pan controls
                const panXEl = document.getElementById('ppPanX');
                const panYEl = document.getElementById('ppPanY');
                const panValue = document.getElementById('ppPanValue');
                const updatePanValue = () => {
                    if (panValue && panXEl && panYEl) {
                        panValue.textContent = `${panXEl.value}, ${panYEl.value}`;
                        this.animateControlValue('ppPanValue');
                    }
                    this.applyEditorRotation();
                };
                if (panXEl) panXEl.addEventListener('input', updatePanValue);
                if (panYEl) panYEl.addEventListener('input', updatePanValue);
                
                // Filter Controls (Brightness, Contrast, Saturation)
                ['Brightness', 'Contrast', 'Saturation'].forEach(name => {
                    const slider = document.getElementById(`pp${name}`);
                    const valueEl = document.getElementById(`pp${name}Value`);
                    if (slider) {
                        slider.addEventListener('input', () => {
                            if (valueEl) {
                                valueEl.textContent = `${slider.value}%`;
                                this.animateControlValue(`pp${name}Value`);
                            }
                            this.applyEditorRotation(); // Use unified logic
                        });
                    }
                });

                // Grayscale Toggle
                const grayscaleToggle = document.getElementById('ppFilterGrayscale');
                if (grayscaleToggle) {
                    grayscaleToggle.addEventListener('change', () => {
                        this.applyEditorRotation();
                    });
                }
                
                // Initialize values
                this.updateControlValues();
            },
            
            // Update all control value displays
            updateControlValues() {
                const controls = [
                    { id: 'ppVideoRotate', valueId: 'ppRotationValue', suffix: 'deg' },
                    { id: 'ppScalePct', valueId: 'ppScaleValue', suffix: '%' },
                    { id: 'ppTiltDeg', valueId: 'ppTiltValue', suffix: 'deg' },
                    { id: 'ppBrightness', valueId: 'ppBrightnessValue', suffix: '%' },
                    { id: 'ppContrast', valueId: 'ppContrastValue', suffix: '%' },
                    { id: 'ppSaturation', valueId: 'ppSaturationValue', suffix: '%' }
                ];
                
                controls.forEach(({ id, valueId, suffix }) => {
                    const el = document.getElementById(id);
                    const valueEl = document.getElementById(valueId);
                    if (el && valueEl) {
                        valueEl.textContent = `${el.value}${suffix}`;
                    }
                });
                
                const panXEl = document.getElementById('ppPanX');
                const panYEl = document.getElementById('ppPanY');
                const panValue = document.getElementById('ppPanValue');
                if (panXEl && panYEl && panValue) {
                    panValue.textContent = `${panXEl.value}, ${panYEl.value}`;
                }
            },
            
            // Apply color grading filters
            applyColorGrading() {
                const v = document.getElementById('ppLocalPreviewVideo');
                const enabled = document.getElementById('ppColorGradingEnabled')?.checked;
                
                if (!v || !enabled) {
                    if (v) v.style.filter = '';
                    return;
                }
                
                const brightness = document.getElementById('ppBrightness')?.value || 100;
                const contrast = document.getElementById('ppContrast')?.value || 100;
                const saturation = document.getElementById('ppSaturation')?.value || 100;
                
                v.style.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
            },
            
            // Analyze video and provide smart suggestions
            async analyzeVideoAndSuggest() {
                const v = document.getElementById('ppLocalPreviewVideo');
                const suggestionsPanel = document.getElementById('ppAutoSuggestions');
                const suggestionContent = document.getElementById('ppSuggestionContent');
                const applyBtn = document.getElementById('ppApplySuggestion');
                
                if (!v || !suggestionsPanel || v.tagName !== 'VIDEO') return;
                
                // Wait for metadata to load
                await new Promise(resolve => {
                    if (v.readyState >= 1) resolve();
                    else v.addEventListener('loadedmetadata', resolve, { once: true });
                });
                
                const width = v.videoWidth;
                const height = v.videoHeight;
                const duration = v.duration;

                  // Intelligent Placement Defaults
                  if (this.state && !this.state.placementDefaultsApplied) {
                      const isVertical = height > width;
                      const dHero = document.getElementById('ppDestHero');
                      const dGallery = document.getElementById('ppDestGallery');
                      const dCarousel = document.getElementById('ppDestCarousel');

                      if (dHero) dHero.checked = !isVertical;
                      if (dGallery) dGallery.checked = !isVertical;
                      if (dCarousel) dCarousel.checked = true;
                      
                      if (typeof this.updateDestinations === 'function') this.updateDestinations();
                      this.state.placementDefaultsApplied = true;
                  }
                // Detect vertical video
                if (height > width * 1.5) {
                    suggestion = {
                        title: 'Vertical video detected',
                        message: 'Rotate 90 deg for landscape orientation?',
                        action: () => {
                            const rotateEl = document.getElementById('ppVideoRotate');
                            if (rotateEl) {
                                rotateEl.value = 90;
                                this.applyLocalPreviewRotation();
                                this.updateControlValues();
                                showToast('Rotation applied', 'success');
                            }
                        }
                    };
                }
                // Detect unusual aspect ratio
                else if (width / height < 1.5 && width / height > 0.9) {
                    suggestion = {
                        title: 'Unusual aspect ratio detected',
                        message: 'Apply cinematic crop (16:9)?',
                        action: () => {
                            const scaleEl = document.getElementById('ppScalePct');
                            if (scaleEl) {
                                scaleEl.value = 120;
                                this.applyLocalPreviewRotation();
                                this.updateControlValues();
                                showToast('Cinematic preset applied', 'success');
                            }
                        }
                    };
                }
                // Detect very short video
                else if (duration < 2) {
                    suggestion = {
                        title: 'Very short video',
                        message: 'Consider adding more footage for better impact',
                        action: null
                    };
                }
                
                // Display suggestion
                if (suggestion) {
                    suggestionsPanel.setAttribute('data-visible', 'true');
                    if (suggestionContent) {
                        suggestionContent.innerHTML = `
                            <strong>${this.escapeHtml(suggestion.title)}</strong>
                            <p>${this.escapeHtml(suggestion.message)}</p>
                        `;
                    }
                    if (applyBtn && suggestion.action) {
                        applyBtn.style.display = 'block';
                        applyBtn.onclick = suggestion.action;
                    } else if (applyBtn) {
                        applyBtn.style.display = 'none';
                    }
                } else {
                    suggestionsPanel.setAttribute('data-visible', 'false');
                }
                
                // Update stage info
                const infoResolution = document.getElementById('ppInfoResolution');
                const infoFps = document.getElementById('ppInfoFps');
                if (infoResolution) infoResolution.textContent = `${width}x${height}`;
                if (infoFps) {
                    // Estimate FPS (most phone videos are 30fps)
                    infoFps.textContent = '30fps';
                }
            },
            
            // Reset individual control
            resetControl(controlName) {
                const resets = {
                    'rotation': { el: 'ppVideoRotate', value: 0 },
                    'scale': { el: 'ppScalePct', value: 100 },
                    'tilt': { el: 'ppTiltDeg', value: 0 },
                    'position': { els: ['ppPanX', 'ppPanY'], value: 0 },
                    'filters': { els: ['ppBrightness', 'ppContrast', 'ppSaturation'], value: 100, checks: ['ppFilterGrayscale'] }
                };
                
                const reset = resets[controlName];
                if (!reset) return;
                
                if (reset.els) {
                    reset.els.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.value = reset.value;
                    });
                } else if (reset.el) {
                    const el = document.getElementById(reset.el);
                    if (el) el.value = reset.value;
                }
                
                if (reset.checks) {
                    reset.checks.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.checked = false;
                    });
                }
                
                this.applyLocalPreviewRotation();
                this.updateControlValues();
                showToast(`${controlName} reset`, 'success');
            },
            
            // Quick rotation setter
            setQuickRotation(degrees) {
                const rotateEl = document.getElementById('ppVideoRotate');
                if (rotateEl) {
                    rotateEl.value = degrees;
                    this.applyLocalPreviewRotation();
                    this.updateControlValues();
                }
            },
            
            // Cancel editing
            cancelEdit() {
                // Restore regular scrolling
                document.body.style.overflow = '';

                const editorCard = document.getElementById('ppLibraryEditor');
                if (editorCard) {
                    editorCard.classList.add('is-hidden');
                    
                    // Restore to original parent if we moved it
                    if (this.state._modalOriginalParent && editorCard.parentNode === document.body) {
                        console.log('[Modal] Returning to:', this.state._modalOriginalParent.id || this.state._modalOriginalParent.tagName);
                        if (this.state._modalOriginalNext) {
                            this.state._modalOriginalParent.insertBefore(editorCard, this.state._modalOriginalNext);
                        } else {
                            this.state._modalOriginalParent.appendChild(editorCard);
                        }
                        // Clean up
                        this.state._modalOriginalParent = null;
                        this.state._modalOriginalNext = null;
                    }
                }
                
                // Only show "Editing cancelled" if save wasn't already successful
                const wasSaved = this.state._editSaved;
                this.state._editSaved = false; // Reset for next edit
                
                this.state.edit = null;
                
                if (!wasSaved) {
                    showToast('Editing cancelled', 'info');
                }
            },
            
            /* ============================================
               EXTENDED PRODUCTION FEATURES
               Batch Operations, Filters, Grid View, Undo/Redo
               ============================================ */
            
            // Batch Operations
            onItemCheckboxChange() {
                const checkboxes = document.querySelectorAll('.pp-library-item-checkbox');
                const checked = Array.from(checkboxes).filter(cb => cb.checked);
                const toolbar = document.getElementById('ppBatchToolbar');
                const countEl = document.getElementById('ppBatchCount');
                
                if (toolbar) {
                    toolbar.setAttribute('data-batch-mode', checked.length > 0 ? 'true' : 'false');
                }
                if (countEl) {
                    countEl.textContent = `${checked.length} selected`;
                }
            },
            
            clearSelection() {
                document.querySelectorAll('.pp-library-item-checkbox').forEach(cb => cb.checked = false);
                this.onItemCheckboxChange();
            },
            
            async batchRotate(degrees) {
                const checked = Array.from(document.querySelectorAll('.pp-library-item-checkbox:checked'));
                if (checked.length === 0) {
                    showToast('No items selected', 'error');
                    return;
                }
                
                const assetIds = checked.map(cb => cb.dataset.assetId);
                showToast(`Rotating ${assetIds.length} assets...`, 'info');
                
                try {
                    const promises = assetIds.map(assetId => 
                        this.fetchJson('/api/admin/proof-asset-edit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ asset_id: assetId, rotate_deg: degrees })
                        })
                    );
                    
                    await Promise.all(promises);
                    showToast(`Rotated ${assetIds.length} assets successfully`, 'success');
                    this.clearSelection();
                    await this.refreshAssets();
                } catch (err) {
                    showToast(`Batch rotation failed: ${err.message}`, 'error');
                }
            },
            
            async batchToggleVisibility() {
                const checked = Array.from(document.querySelectorAll('.pp-library-item-checkbox:checked'));
                if (checked.length === 0) {
                    showToast('No items selected', 'error');
                    return;
                }
                
                const assetIds = checked.map(cb => cb.dataset.assetId);
                showToast(`Toggling visibility for ${assetIds.length} assets...`, 'info');
                
                try {
                    const promises = assetIds.map(assetId => {
                        const item = document.querySelector(`.pp-library-item[data-asset-id="${assetId}"]`);
                        const currentVisible = (item?.dataset.visible || item?.getAttribute('data-visible')) === 'true';
                        return this.toggleAssetVisible(assetId, !currentVisible);
                    });
                    
                    await Promise.all(promises);
                    showToast(`Updated ${assetIds.length} assets`, 'success');
                    this.clearSelection();
                } catch (err) {
                    showToast(`Batch update failed: ${err.message}`, 'error');
                }
            },

            async batchSetIntent(intentValue) {
                const checked = Array.from(document.querySelectorAll('.pp-library-item-checkbox:checked'));
                if (checked.length === 0) {
                    showToast('No items selected', 'error');
                    return;
                }

                const selectEl = document.getElementById('ppBatchIntent');
                const intent = (typeof intentValue === 'string')
                    ? intentValue
                    : (selectEl ? String(selectEl.value || '') : '');

                const intentDisplayMap = {
                    'working_shot': 'Working Shot',
                    'action_proof': 'Action Proof',
                    'result_proof': 'Result Proof',
                    '': 'Unclassified'
                };

                const assetIds = checked.map(cb => cb.dataset.assetId).filter(Boolean);
                showToast(`Tagging ${assetIds.length} assets...`, 'info');

                try {
                    const promises = assetIds.map(assetId =>
                        this.fetchJson('/api/admin/proof-assets', {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ asset_id: assetId, customer_intent: intent }),
                        })
                    );

                    await Promise.all(promises);
                    showToast(`Tagged ${assetIds.length} assets: ${intentDisplayMap[intent] || intent}`, 'success');
                    this.clearSelection();
                    await this.refreshAssets();
                } catch (err) {
                    showToast(`Batch tagging failed: ${err.message}`, 'error');
                }
            },
            
            async batchDelete() {
                const checked = Array.from(document.querySelectorAll('.pp-library-item-checkbox:checked'));
                if (checked.length === 0) {
                    showToast('No items selected', 'error');
                    return;
                }
                
                const assetIds = checked.map(cb => cb.dataset.assetId);
                if (!confirm(`Delete ${assetIds.length} selected assets? This cannot be undone.`)) return;
                
                showToast(`Deleting ${assetIds.length} assets...`, 'info');
                
                try {
                    const promises = assetIds.map(assetId => this.deleteAsset(assetId));
                    await Promise.all(promises);
                    showToast(`Deleted ${assetIds.length} assets`, 'success');
                    this.clearSelection();
                } catch (err) {
                    showToast(`Batch delete failed: ${err.message}`, 'error');
                }
            },
            
            // ========================================================================
            // INTELLIGENT MULTI-FILTER SYSTEM
            // ========================================================================
            // Upload Controls (Service Category dropdown) are COMPLETELY DECOUPLED
            // from Library Filtering. The Service dropdown only sets metadata for 
            // new uploads - it does NOT change what you see in the library.
            //
            // Library Filtering is independent and intelligent:
            // - Multi-select: Intent (Action/Result/Working) & Service (TV/Cameras)
            // - Single-toggle: Media Type (Video/Photo) & Visibility (Visible/Hidden)
            // - Search: Debounced text search across filename, ID, intent, service
            // - Filters use AND logic across types, OR logic within types
            // - Active filters display with "Clear All" button
            // ========================================================================
            
            // Normalize service values for consistent matching
            normalizeService(service) {
                if (!service) return '';
                const normalized = String(service).toLowerCase().trim();
                
                // Schema only allows: tv_mounting, cameras
                if (normalized.includes('camera')) return 'cameras';
                if (normalized.includes('tv') || normalized.includes('mount')) return 'tv_mounting';
                
                // Return original if no match (for debugging)
                console.warn('[Filter] Unknown service value:', service);
                return normalized;
            },
            
            // Normalize intent values for consistent matching
            normalizeIntent(intent) {
                if (!intent) return '';
                const normalized = String(intent).toLowerCase().trim();
                
                // Handle variations
                if (normalized.includes('action')) return 'action_proof';
                if (normalized.includes('result')) return 'result_proof';
                if (normalized.includes('working')) return 'working_shot';
                
                return normalized;
            },

            inferIntentLabelFromAsset(asset) {
                const a = asset || {};
                let intentLabel = String(a?.customer_intent || '').trim();
                if (intentLabel) return intentLabel;

                const slotKey = String(a?.slot_key || '').trim();
                if (slotKey === 'content_body' || slotKey === 'pre_cta') return 'working_shot';
                if (slotKey === 'mid_proof_rail') return 'action_proof';
                if (slotKey === 'hero_carousel' || slotKey === 'hero') return 'result_proof';
                return '';
            },
            
            initLibraryFilters() {
                if (!this.libraryFilters) {
                    this.libraryFilters = {
                        search: '',
                        service: null,   // Single-toggle (tv_mounting/cameras/null)
                        media: null,     // Single-toggle (video/photo/null)
                        visibility: null, // Single-toggle (true/false/null)
                        live: null       // Single-toggle (yes/no/null)
                    };
                }
            },

            // If the pack changes, filters from the prior pack can become invalid (e.g. TV Mounting selected
            // while the new pack only contains Cameras). Reconcile active filters against the actual values
            // present in the newly loaded items to keep the library feeling fluid.
            reconcileLibraryFiltersWithItems(items) {
                this.initLibraryFilters();

                const list = Array.isArray(items) ? items : [];
                if (!list.length) return;

                const presentServices = new Set();
                const presentMedia = new Set();

                for (const a of list) {
                    const svc = this.normalizeService(a?.service);
                    const media = String(a?.media_kind || '').toLowerCase().trim();
                    if (svc) presentServices.add(svc);
                    if (media) presentMedia.add(media);
                }

                if (this.libraryFilters.service !== null) {
                    const wantSvc = this.normalizeService(this.libraryFilters.service);
                    if (wantSvc && !presentServices.has(wantSvc)) this.libraryFilters.service = null;
                }

                if (this.libraryFilters.media !== null) {
                    const want = String(this.libraryFilters.media || '').toLowerCase().trim();
                    if (want && !presentMedia.has(want)) this.libraryFilters.media = null;
                }

                // Sync chip UI to reconciled state
                const chips = Array.from(document.querySelectorAll('.pp-chip[data-filter]'));
                for (const chip of chips) {
                    const raw = String(chip.getAttribute('data-filter') || '');
                    const parts = raw.split(':');
                    const type = parts[0];
                    const value = parts[1];
                    if (!type || !value) continue;

                    let active = false;
                    if (type === 'service') {
                        if (value === 'all') active = this.libraryFilters.service === null;
                        else active = this.libraryFilters.service === value;
                    }
                    if (type === 'media') {
                        if (value === 'all') active = this.libraryFilters.media === null;
                        else active = this.libraryFilters.media === value;
                    }

                    chip.classList.toggle('active', !!active);
                }
            },
            
            filterLibrary(query) {
                this.initLibraryFilters();
                clearTimeout(this.searchDebounce);
                
                this.searchDebounce = setTimeout(() => {
                    this.libraryFilters.search = query.toLowerCase().trim();
                    this.applyAllFilters();
                }, 300);
            },
            
            toggleFilter(filterType, value, buttonEl) {
                this.initLibraryFilters();

                if (filterType === 'live') {
                    // Single-toggle live status. Special: 'all' clears.
                    document.querySelectorAll('[data-filter^="live:"]').forEach(btn => btn.classList.remove('active'));

                    if (value === 'all') {
                        this.libraryFilters.live = null;
                    } else if (this.libraryFilters.live === value) {
                        this.libraryFilters.live = null;
                    } else {
                        this.libraryFilters.live = value;
                    }

                    const key = this.libraryFilters.live ? `live:${this.libraryFilters.live}` : 'live:all';
                    const activeBtn = document.querySelector(`[data-filter="${key}"]`);
                    if (activeBtn) activeBtn.classList.add('active');
                } else if (filterType === 'media') {
                    // Single-toggle media. Special: 'all' clears.
                    document.querySelectorAll('[data-filter^="media:"]').forEach(btn => btn.classList.remove('active'));

                    if (value === 'all') {
                        this.libraryFilters.media = null;
                    } else if (this.libraryFilters.media === value) {
                        this.libraryFilters.media = null;
                    } else {
                        this.libraryFilters.media = value;
                    }

                    // Sync active state
                    const key = this.libraryFilters.media ? `media:${this.libraryFilters.media}` : 'media:all';
                    const activeBtn = document.querySelector(`[data-filter="${key}"]`);
                    if (activeBtn) activeBtn.classList.add('active');
                } else if (filterType === 'service') {
                    // Single-toggle service. Special: 'all' clears.
                    document.querySelectorAll('[data-filter^="service:"]').forEach(btn => btn.classList.remove('active'));

                    if (value === 'all') {
                        this.libraryFilters.service = null;
                    } else if (this.libraryFilters.service === value) {
                        this.libraryFilters.service = null;
                    } else {
                        this.libraryFilters.service = value;
                    }

                    const key = this.libraryFilters.service ? `service:${this.libraryFilters.service}` : 'service:all';
                    const activeBtn = document.querySelector(`[data-filter="${key}"]`);
                    if (activeBtn) activeBtn.classList.add('active');
                } else if (filterType === 'visibility') {
                    // Keep this support even if UI doesn't expose it yet.
                    if (this.libraryFilters.visibility === value) {
                        this.libraryFilters.visibility = null;
                        buttonEl?.classList?.remove('active');
                    } else {
                        document.querySelectorAll('[data-filter^="visibility:"]').forEach(btn => btn.classList.remove('active'));
                        this.libraryFilters.visibility = value;
                        buttonEl?.classList?.add('active');
                    }
                }
                
                this.applyAllFilters();
            },
            
            applyAllFilters() {
                const items = document.querySelectorAll('.pp-library-item');
                let visibleCount = 0;
                
                items.forEach(item => {
                    let shouldShow = true;
                    
                    // Search filter
                    if (this.libraryFilters.search) {
                        const filename = (item.dataset.filename || '').toLowerCase();
                        const id = (item.dataset.assetId || '').toLowerCase();
                        const intent = (item.dataset.intent || '').toLowerCase();
                        const service = (item.dataset.service || '').toLowerCase();
                        const searchText = `${filename} ${id} ${intent} ${service}`;
                        
                        if (!searchText.includes(this.libraryFilters.search)) {
                            shouldShow = false;
                        }
                    }
                    
                    // Media type filter
                    if (this.libraryFilters.media !== null) {
                        const itemMediaTypeRaw = item.dataset.mediaType || item.getAttribute('data-media-type') || '';
                        const itemMediaType = String(itemMediaTypeRaw).toLowerCase().trim();
                        const want = String(this.libraryFilters.media || '').toLowerCase().trim();
                        if (itemMediaType !== want) {
                            shouldShow = false;
                        }
                    }

                    // Service filter
                    if (this.libraryFilters.service !== null) {
                        const wantSvc = this.normalizeService(this.libraryFilters.service);
                        const itemSvc = this.normalizeService(item.dataset.service);
                        if (wantSvc && itemSvc !== wantSvc) {
                            shouldShow = false;
                        }
                    }
                    
                    // Live status filter
                    if (this.libraryFilters.live !== null) {
                        const assetId = item.dataset.assetId;
                        const isLive = this.state.liveAssetIds && this.state.liveAssetIds.has(assetId);
                        
                        if (this.libraryFilters.live === 'yes' && !isLive) {
                            shouldShow = false;
                        } else if (this.libraryFilters.live === 'no' && isLive) {
                            shouldShow = false;
                        }
                    }
                    
                    // Visibility filter
                    if (this.libraryFilters.visibility !== null) {
                        const isVisible = (item.dataset.visible || item.getAttribute('data-visible')) === 'true';
                        if (isVisible !== this.libraryFilters.visibility) {
                            shouldShow = false;
                        }
                    }

                    // Persist filter decision so Grid view can derive from it even when the list container is hidden.
                    item.dataset.matchesFilters = shouldShow ? '1' : '0';

                    // Don't force display:flex (can break layout assumptions); let CSS decide when visible.
                    item.style.display = shouldShow ? '' : 'none';
                    if (shouldShow) visibleCount++;
                });
                
                this.updateFilterDisplay(visibleCount, items.length);

                // Keep Grid view in sync: filters operate on list items; grid is derived from list visibility.
                const gridEl = document.getElementById('ppAssetsGrid');
                if (gridEl && getComputedStyle(gridEl).display !== 'none') {
                    this.renderGridView();
                }
            },
            
            clearAllFilters() {
                this.initLibraryFilters();
                
                // Reset filter state
                this.libraryFilters.search = '';
                this.libraryFilters.service = null;
                this.libraryFilters.media = null;
                this.libraryFilters.visibility = null;
                this.libraryFilters.live = null;
                
                // Clear search input
                const searchInput = document.querySelector('.pp-search-bar input');
                if (searchInput) searchInput.value = '';
                
                // Deactivate all chips
                document.querySelectorAll('.pp-chip.active').forEach(chip => {
                    chip.classList.remove('active');
                });

                // Default to "All"
                const allChip = document.querySelector('.pp-chip[data-filter="media:all"]');
                if (allChip) allChip.classList.add('active');

                const svcAllChip = document.querySelector('.pp-chip[data-filter="service:all"]');
                if (svcAllChip) svcAllChip.classList.add('active');

                const liveAllChip = document.querySelector('[data-filter="live:all"]');
                if (liveAllChip) liveAllChip.classList.add('active');
                
                // Show all items
                const items = document.querySelectorAll('.pp-library-item');
                items.forEach(item => {
                    item.dataset.matchesFilters = '1';
                    item.style.display = '';
                });
                
                this.updateFilterDisplay(items.length, items.length);

                const gridEl = document.getElementById('ppAssetsGrid');
                if (gridEl && getComputedStyle(gridEl).display !== 'none') {
                    this.renderGridView();
                }
            },
            
            updateFilterDisplay(visibleCount, totalCount) {
                const countEl = document.getElementById('ppFilterCount');
                const clearBtn = document.getElementById('ppClearFilters');
                
                if (countEl) {
                    countEl.textContent = `Showing ${visibleCount} of ${totalCount} assets`;
                }
                
                // Show clear button if any filters active
                if (clearBtn && this.libraryFilters) {
                    const hasActiveFilters = 
                        this.libraryFilters.search ||
                        this.libraryFilters.service !== null ||
                        this.libraryFilters.media !== null ||
                        this.libraryFilters.visibility !== null;
                    
                    clearBtn.style.display = hasActiveFilters ? 'inline-block' : 'none';
                }
            },
            
            sortLibrary(sortBy) {
                const listEl = document.getElementById('ppAssetsList');
                if (!listEl) return;
                
                const items = Array.from(listEl.querySelectorAll('.pp-library-item'));
                
                items.sort((a, b) => {
                    switch(sortBy) {
                        case 'date-desc':
                            return new Date(b.dataset.created || 0) - new Date(a.dataset.created || 0);
                        case 'date-asc':
                            return new Date(a.dataset.created || 0) - new Date(b.dataset.created || 0);
                        default:
                            return 0;
                    }
                });
                
                items.forEach(item => listEl.appendChild(item));
                // GAP 3 FIX: Remove toast spam from sort (no notification needed)
                // showToast(`Sorted by ${sortBy}`, 'success');
            },
            
            updateFilterCount() {
                const countEl = document.getElementById('ppFilterCount');
                if (!countEl) return;
                
                const items = document.querySelectorAll('.pp-library-item');
                const visible = Array.from(items).filter(item => 
                    item.style.display !== 'none' && 
                    getComputedStyle(item).display !== 'none'
                ).length;
                
                countEl.textContent = `Showing ${visible} of ${items.length} assets`;
            },
            
            // View Mode Toggle (List/Grid)
            setViewMode(mode, buttonEl) {
                const listEl = document.getElementById('ppAssetsList');
                const gridEl = document.getElementById('ppAssetsGrid');
                const buttons = document.querySelectorAll('.pp-view-btn');
                
                buttons.forEach(btn => btn.classList.remove('active'));
                if (buttonEl) buttonEl.classList.add('active');
                
                if (mode === 'grid') {
                    if (listEl) listEl.style.display = 'none';
                    if (gridEl) {
                        gridEl.style.display = 'grid';
                        this.renderGridView();
                    }
                } else {
                    if (listEl) listEl.style.display = 'block';
                    if (gridEl) gridEl.style.display = 'none';
                }
            },
            
            renderGridView() {
                const gridEl = document.getElementById('ppAssetsGrid');
                const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                
                if (!gridEl || !items.length) return;
                
                // Filter items based on list filter decisions (NOT computedStyle).
                // In grid mode, the list container is display:none, so computedStyle lies.
                const listItems = Array.from(document.querySelectorAll('.pp-library-item'));
                const visibleAssetIds = listItems
                    .filter(item => (item.dataset.matchesFilters || '1') === '1')
                    .map(item => String(item.dataset.assetId || ''));
                
                const filteredItems = items.filter(a => visibleAssetIds.includes(String(a?.asset_id || '')));
                
                const gridItems = filteredItems.map(a => {
                    const assetId = String(a?.asset_id || '').trim();
                    const mediaKind = String(a?.media_kind || '').trim();
                    const path = String(a?.storage_path || '').trim();
                    const bucket = String(a?.storage_bucket || 'proof').trim();
                    const intentLabel = String(a?.customer_intent || '').trim();
                    const duration = Number(a?.duration_seconds || 0);
                    
                    const previewUrl = path ? this.publicStorageUrl(bucket, path) : '';
                    const transformStyle = this.buildAssetPreviewStyle(a);
                    
                    const intentDisplayMap = {
                        'working_shot': 'Working Shot',
                        'action_proof': 'Action Proof',
                        'result_proof': 'Result Proof'
                    };
                    const intentDisplay = intentDisplayMap[intentLabel] || ''; // Hide if unknown
                    
                    // Duration or Type Badge
                    let durationDisplay = '-';
                    if (mediaKind === 'video') {
                        durationDisplay = duration ? this.formatTimeSec(duration) : '0:00';
                    } else {
                        durationDisplay = 'PHOTO'; // Clearer than dash
                    }
                    
                    return `
                        <div class="pp-grid-item" data-asset-id="${this.escapeHtml(assetId)}">
                            <div class="pp-grid-thumbnail">
                                ${mediaKind === 'video' 
                                    ? `<video src="${this.escapeHtml(previewUrl)}" muted loop playsinline preload="metadata" style="${transformStyle}" onerror="proofPacks.onPreviewMediaError(this, 'video')"></video>`
                                    : `<img src="${this.escapeHtml(previewUrl)}" style="${transformStyle}" />`}
                                <div class="pp-grid-overlay">
                                    ${mediaKind === 'video' ? '<button type="button" class="pp-grid-play" onclick="proofPacks.toggleThumbPlayback(this, event)" aria-label="Play"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="display:block;"><path d="M8 5v14l11-7z"/></svg></button>' : ''}
                                    ${Number(a?.psychological_weight || 0) > 40 ? '<span class="pp-featured-star">*</span>' : ''}
                                </div>
                            </div>
                            <div class="pp-grid-info">
                                <span class="pp-grid-intent" style="${!intentDisplay ? 'display:none;' : ''}">${this.escapeHtml(intentDisplay)}</span>
                                <span class="pp-grid-duration">${this.escapeHtml(durationDisplay)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                gridEl.innerHTML = gridItems;
                
                // GAP 11 FIX: Bind click handlers with stopPropagation
                setTimeout(() => {
                    gridEl.querySelectorAll('.pp-grid-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            if (e.target.type === 'checkbox') return;
                            e.stopPropagation();
                            const assetId = item.dataset.assetId;
                            this.beginEditAssetMedia(assetId);
                        });
                    });
                }, 50);
            },
            
            // Export Presets
            EXPORT_PRESETS: {
                'web-optimized': {
                    label: 'Web Optimized',
                    description: '720p, H.264, 2 Mbps - Best for social media & web',
                    params: { resolution: '1280x720', codec: 'h264', bitrate: '2M', format: 'mp4' }
                },
                'mobile-friendly': {
                    label: 'Mobile Friendly',
                    description: '480p, H.264, 1 Mbps - Small size, fast streaming',
                    params: { resolution: '854x480', codec: 'h264', bitrate: '1M', format: 'mp4' }
                },
                'high-quality': {
                    label: 'High Quality',
                    description: '1080p, H.265, 5 Mbps - Maximum quality',
                    params: { resolution: '1920x1080', codec: 'h265', bitrate: '5M', format: 'mp4' }
                },
                'gif-export': {
                    label: 'Animated GIF',
                    description: '480p, 10 FPS - Perfect for previews',
                    params: { resolution: '854x480', fps: '10', format: 'gif' }
                }
            },
            
            async exportWithPreset(presetName) {
                const assetId = String(this.state.edit?.assetId || '').trim();
                if (!assetId) {
                    showToast('No asset selected for export', 'error');
                    return;
                }
                
                const preset = this.EXPORT_PRESETS[presetName];
                if (!preset) {
                    showToast('Invalid export preset', 'error');
                    return;
                }
                
                showToast(`Exporting with ${preset.label}...`, 'info');
                
                try {
                    const response = await this.fetchJson('/api/admin/export-asset', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            asset_id: assetId,
                            preset: presetName,
                            params: preset.params
                        })
                    });
                    
                    if (response?.export_url) {
                        window.open(response.export_url, '_blank');
                        showToast('Export completed successfully', 'success');
                    } else {
                        showToast('Export completed (no download URL)', 'success');
                    }
                } catch (err) {
                    showToast(`Export failed: ${err.message}`, 'error');
                }
            },
            
            // Undo/Redo System
            initEditHistory() {
                if (!this.editHistory) {
                    this.editHistory = new EditHistory(this);
                }
            },
            
            pushEditState(description) {
                this.initEditHistory();
                const state = {
                    assetId: this.state.edit?.assetId,
                    rotateDeg: this.getRotateDegPreference(),
                    trimStartSec: this.getTrimStartSecPreference(),
                    trimEndSec: this.getTrimEndSecPreference(),
                    filterBw: document.getElementById('ppFilterGrayscale')?.checked || false,
                    filterBrightness: document.getElementById('ppBrightness')?.value || 100,
                    filterContrast: document.getElementById('ppContrast')?.value || 100,
                    filterSaturation: document.getElementById('ppSaturation')?.value || 100,
                    timestamp: Date.now(),
                    description
                };
                this.editHistory.push(state);
            },
            
            undoEdit() {
                this.initEditHistory();
                this.editHistory.undo();
            },
            
            redoEdit() {
                this.initEditHistory();
                this.editHistory.redo();
            },

            getCacheBustedUrl(baseUrl) {
                if (!baseUrl) return '';
                const cacheBuster = `v=${Date.now()}_${Math.random().toString(36).substring(7)}`;
                return `${baseUrl}?${cacheBuster}`;
            },

            async reloadPreviewAfterEdit(asset, changes) {
                const bucket = String(asset?.storage_bucket || 'proof');
                const path = String(asset?.storage_path || '');
                const baseUrl = this.publicStorageUrl(bucket, path);
                const v = document.getElementById('ppLocalPreviewVideo');
                
                if (!v || !baseUrl) {
                    console.warn('[Editor] Cannot reload preview - missing element or URL');
                    return;
                }
                
                const newSrc = this.getCacheBustedUrl(baseUrl);
                const isVideo = v.tagName === 'VIDEO';
                
                console.log(`[Editor] Reloading ${isVideo ? 'video' : 'image'} preview:`, newSrc);
                
                return new Promise((resolve) => {
                    const onSuccess = () => {
                        console.log(`[Editor] Preview loaded successfully`);
                        this.setEditorStatus('success', 'Saved successfully!', {
                            detail: `Applied: ${changes.join(', ') || 'saved'}`,
                            resetAfterMs: 3000
                        });
                        this.showSuccessAnimation();
                        
                        // Re-bind controls and apply transforms
                        this.bindPreviewEditor();
                        this.applyLocalPreviewRotation();
                        
                        // For videos, restore trim position if set
                        if (isVideo && this.readTrim) {
                            const { start } = this.readTrim();
                            if (start > 0 && Number.isFinite(v.duration) && start < v.duration) {
                                try { v.currentTime = start; } catch (e) { console.warn('Failed to restore position:', e); }
                            }
                        }
                        
                        resolve();
                    };
                    
                    const onError = (e) => {
                        console.error('[Editor] Preview load failed:', e);
                        this.setEditorStatus('error', 'Preview failed', {
                            detail: 'Preview failed to load'
                        });
                        showToast('Preview reload failed - asset may still be processing', 'warning');
                        resolve(); // Don't block on preview failure
                    };
                    
                    if (isVideo) {
                        // Replace video element for clean reload
                        const newV = document.createElement('video');
                        newV.id = 'ppLocalPreviewVideo';
                        newV.src = newSrc;
                        newV.muted = true;
                        newV.playsInline = true;
                        newV.preload = 'auto';
                        newV.controls = false;
                        newV.style.cssText = v.style.cssText;
                        
                        newV.addEventListener('loadedmetadata', onSuccess, { once: true });
                        newV.addEventListener('error', onError, { once: true });
                        v.replaceWith(newV);
                    } else {
                        v.addEventListener('load', onSuccess, { once: true });
                        v.addEventListener('error', onError, { once: true });
                        v.src = newSrc;
                    }
                });
            },

            // Detect what changed in editor (for both payload construction and success messages)
            detectEditorChanges(formData, currentAsset) {
                const changes = [];
                const { rotateDeg, trimStartSec, trimEndSec, filterBw, brightness, contrast, saturation,
                        updateIntent, updateWeight, tilt, scale, panX, panY } = formData;
                
                // Get current values with safe fallbacks
                const currentIntent = currentAsset?.customer_intent ?? '';
                const currentWeight = currentAsset ? Number(currentAsset.psychological_weight ?? 5) : 5;
                const currentRotateDeg = currentAsset ? String(currentAsset.video_rotate_deg ?? 0) : '0';
                
                // Geometry transforms
                if (rotateDeg && rotateDeg !== '0' && rotateDeg !== currentRotateDeg) {
                    changes.push({ field: 'rotation', oldValue: currentRotateDeg, newValue: rotateDeg, displayText: `Rotated ${rotateDeg} deg` });
                }
                if (tilt !== 0) {
                    changes.push({ field: 'tilt', oldValue: 0, newValue: tilt, displayText: `Tilt ${tilt} deg` });
                }
                if (scale !== 100) {
                    changes.push({ field: 'scale', oldValue: 100, newValue: scale, displayText: `Zoom ${scale}%` });
                }
                if (panX !== 0 || panY !== 0) {
                    changes.push({ field: 'pan', oldValue: [0, 0], newValue: [panX, panY], displayText: `Pan (${panX}%, ${panY}%)` });
                }
                
                // Color adjustments
                if (brightness !== 100) {
                    changes.push({ field: 'brightness', oldValue: 100, newValue: brightness, displayText: `Brightness ${brightness}%` });
                }
                if (contrast !== 100) {
                    changes.push({ field: 'contrast', oldValue: 100, newValue: contrast, displayText: `Contrast ${contrast}%` });
                }
                if (saturation !== 100) {
                    changes.push({ field: 'saturation', oldValue: 100, newValue: saturation, displayText: `Saturation ${saturation}%` });
                }
                if (filterBw) {
                    changes.push({ field: 'filter_bw', oldValue: false, newValue: true, displayText: 'Black & white filter' });
                }
                
                // Trim window
                if (trimStartSec || trimEndSec) {
                    const start = trimStartSec ? `${trimStartSec}s` : '0s';
                    const end = trimEndSec ? `${trimEndSec}s` : 'end';
                    changes.push({ field: 'trim', oldValue: null, newValue: [trimStartSec, trimEndSec], displayText: `Trimmed ${start} to ${end}` });
                }
                
                // Classification
                if (updateIntent !== null && updateIntent !== currentIntent) {
                    changes.push({ field: 'intent', oldValue: currentIntent, newValue: updateIntent, displayText: `Intent: ${updateIntent || 'unclassified'}` });
                }
                if (updateWeight !== null && updateWeight !== currentWeight) {
                    const text = updateWeight > 40 ? 'Marked Featured' : 'Unmarked Featured';
                    changes.push({ field: 'weight', oldValue: currentWeight, newValue: updateWeight, displayText: text });
                }
                
                return changes;
            },

            // Format changes array into user-friendly summary text
            formatChangesSummary(changes) {
                if (!Array.isArray(changes) || changes.length === 0) return '';
                return changes.map(c => c.displayText).join(', ');
            },

            setEditorStatus(state, message, options = {}) {
                const statusBar = document.getElementById('ppEditorStatusBar');
                const headerStatusEl = document.getElementById('ppEditorStatus');
                const statusEl = document.getElementById('ppEditStatus');
                const applyBtn = document.getElementById('ppApplyEdits');
                
                // Cancel any pending status resets
                if (this._statusResetTimeout) {
                    clearTimeout(this._statusResetTimeout);
                    this._statusResetTimeout = null;
                }
                
                // Update all status elements atomically
                if (statusBar) statusBar.dataset.state = state;
                if (headerStatusEl) headerStatusEl.textContent = message;
                if (statusEl) statusEl.textContent = options.detail || '';
                
                // Update button state via data-state attribute (CSS-driven)
                if (applyBtn && options.buttonState) {
                    const { state: btnState, disabled } = options.buttonState;
                    if (btnState !== undefined) applyBtn.dataset.state = btnState;
                    if (disabled !== undefined) applyBtn.disabled = disabled;
                }
                
                // Auto-reset to idle after delay if specified
                if (options.resetAfterMs) {
                    this._statusResetTimeout = setTimeout(() => {
                        if (statusBar) statusBar.dataset.state = 'idle';
                        if (headerStatusEl) headerStatusEl.textContent = 'Ready';
                        if (statusEl) statusEl.textContent = '';
                        if (applyBtn) {
                            applyBtn.dataset.state = 'idle';
                            applyBtn.disabled = false;
                        }
                        this._statusResetTimeout = null;
                    }, options.resetAfterMs);
                }
            },

            /**
             * Determines the correct API endpoint and payload for asset edits.
             * 
             * Routing Rules:
             * 1. Video Re-encoding (/api/admin/proof-asset-edit):
             *    - Required when structural changes occur: rotation, trim, format conversion
             *    - Triggered if asset is video AND (rotation != 0 OR trim set OR b/w filter)
             *    - Returns { ok, asset, ... }
             * 
             * 2. Metadata Update (PATCH /api/admin/proof-assets):
             *    - used for non-destructuve metadata updates
             *    - used for Photo assets (all edits)
             *    - used for Video assets when only metadata changes (intent, weight)
             *    - Returns { ok, asset }
             * 
             * @param {Object} asset - The original asset object
             * @param {Object} edits - The proposed edits { assetId, rotateDeg, trimStartSec, ... }
             * @return {Object} { endpoint, method, payload, requiresReencode, description }
             */
            determineEditEndpoint(asset, edits) {
                const mediaKind = String(asset?.media_kind || '').trim();
                const isVideo = (mediaKind === 'video');
                
                // Extract edits with defaults
                const {
                    assetId,
                    rotateDeg = '0',
                    trimStartSec,
                    trimEndSec,
                    filterBw = false,
                    intent = null,
                    weight = null,
                    brightness = 100,
                    contrast = 100,
                    saturation = 100,
                    cropping = {},
                    destinations = []
                } = edits;
                
                const structuralChange = isVideo && (
                    rotateDeg !== '0' || 
                    trimStartSec || 
                    trimEndSec || 
                    filterBw
                );

                if (structuralChange) {
                    console.info('[Router] Routing to RE-ENCODE endpoint (structural video change detected)');
                    return {
                        endpoint: '/api/admin/proof-asset-edit',
                        method: 'POST',
                        requiresReencode: true,
                        payload: {
                            asset_id: assetId,
                            rotate_deg: rotateDeg,
                            trim_start_sec: trimStartSec || undefined,
                            trim_end_sec: trimEndSec || undefined,
                            filter_bw: filterBw ? '1' : '0',
                        },
                        description: 'Video Re-encode'
                    };
                }

                // If not re-encoding, use PATCH
                console.info('[Router] Routing to METADATA PATCH endpoint (no structural video changes)');
                
                const patchPayload = { asset_id: assetId };
                
                const currentIntent = asset?.customer_intent ?? '';
                const currentWeight = asset ? Number(asset.psychological_weight ?? 5) : 5;
                const currentRotateDeg = asset ? String(asset.video_rotate_deg ?? 0) : '0';
                
                // FORCE UPDATE: Always include intent/weight if present to ensure payload is never empty.
                // This prevents "400 - No fields to update" when only metadata changes or when state is stale.
                if (intent !== null) patchPayload.customer_intent = intent;
                if (weight !== null) patchPayload.psychological_weight = weight;
                
                // Rotation metadata update (only if not re-encoding)
                if (rotateDeg && rotateDeg !== '0' && rotateDeg !== currentRotateDeg) {
                     patchPayload.video_rotate_deg = Number(rotateDeg);
                }
                
                if (brightness !== 100) patchPayload.filter_brightness = brightness;
                if (contrast !== 100) patchPayload.filter_contrast = contrast;
                if (saturation !== 100) patchPayload.filter_saturation = saturation;
                if (filterBw) patchPayload.filter_bw = '1';

                  // Add Placement Intelligence fields
                  if (cropping && Object.keys(cropping).length > 0) {
                      patchPayload.smart_crop_details = cropping;
                  }
                  if (destinations && destinations.length > 0) {
                      patchPayload.frontend_destinations = destinations;
                  }
                return {
                    endpoint: '/api/admin/proof-assets',
                    method: 'PATCH',
                    requiresReencode: false,
                    payload: patchPayload,
                    description: 'Metadata Patch'
                };
            },

            async applyEditsToAsset() {
                const assetId = String(this.state.edit?.assetId || '').trim();
                if (!assetId) {
                    showToast('No asset selected for editing', 'error');
                    return;
                }

                // SYNCHRONOUS VALIDATION: Gather all form data and validate BEFORE any UI state changes
                const rotateDeg = this.getRotateDegPreference();
                const trimStartSec = this.getTrimStartSecPreference();
                const trimEndSec = this.getTrimEndSecPreference();
                const bwEl = document.getElementById('ppFilterGrayscale');
                const filterBw = !!(bwEl && typeof bwEl.checked === 'boolean' && bwEl.checked);
                const brightnessEl = document.getElementById('ppBrightness');
                const contrastEl = document.getElementById('ppContrast');
                const saturationEl = document.getElementById('ppSaturation');
                
                const brightness = brightnessEl ? Number(brightnessEl.value || 100) : 100;
                const contrast = contrastEl ? Number(contrastEl.value || 100) : 100;
                const saturation = saturationEl ? Number(saturationEl.value || 100) : 100;

                // Classification: Read and validate intent/weight
                const intentEl = document.getElementById('ppEditIntent');
                const featuredEl = document.getElementById('ppEditFeatured');
                
                // Validate intent is a valid enum value
                const VALID_INTENTS = ['working_shot', 'action_proof', 'result_proof', ''];
                let updateIntent = intentEl ? intentEl.value : null;
                if (updateIntent !== null && !VALID_INTENTS.includes(updateIntent)) {
                    console.warn('[Editor] Invalid intent value:', updateIntent, '- resetting to empty');
                    updateIntent = '';
                }
                
                // Validate weight is in valid range (5 = normal, 50 = featured)
                let updateWeight = featuredEl ? (featuredEl.checked ? 50 : 5) : null;
                if (updateWeight !== null && updateWeight !== 5 && updateWeight !== 50) {
                    console.warn('[Editor] Invalid weight value:', updateWeight, '- resetting to 5');
                    updateWeight = 5;
                }

                // Production Geometry
                const tiltEl = document.getElementById('ppTiltDeg');
                const tilt = tiltEl ? Number(tiltEl.value || 0) : 0;
                const scaleEl = document.getElementById('ppScalePct');
                const scale = scaleEl ? Number(scaleEl.value || 100) : 100;
                const panXEl = document.getElementById('ppPanX');
                const panX = panXEl ? Number(panXEl.value || 0) : 0;
                const panYEl = document.getElementById('ppPanY');
                const panY = panYEl ? Number(panYEl.value || 0) : 0;

                // Persist the *visual truth* (what the editor shows) into smart_crop_details.
                // This makes the resting asset card match the saved edit, even before re-opening the editor.
                this.state = this.state || {};
                this.state.cropping = this.state.cropping || {};
                this.state.cropping.geometry = {
                    tilt_deg: tilt,
                    scale_pct: scale,
                    pan_x_pct: panX,
                    pan_y_pct: panY,
                };

                // CRITICAL: Always persist explicit crop defaults to prevent cross-session drift.
                // If mode/objectPosition are omitted, different browsers/CSS defaults can re-interpret framing.
                try {
                    const smart = this.getAssetSmartCropDetails(this.state.edit?.asset || {});
                    const { stageMedia, liveMedia } = this.getActivePreviewElements();

                    const domFit = String(stageMedia?.style?.objectFit || liveMedia?.style?.objectFit || '').toLowerCase();
                    const domModeHint = domFit === 'contain' ? 'contain' : (domFit === 'cover' ? 'cover' : '');
                    const mode = this.normalizeCropMode(this.state.cropping.mode || smart?.mode || domModeHint || 'cover');
                    this.state.cropping.mode = mode;

                    const domPos = stageMedia?.style?.objectPosition || liveMedia?.style?.objectPosition || '';
                    const posRaw = this.state.cropping.objectPosition || smart?.objectPosition || domPos || '50% 50%';
                    this.state.cropping.objectPosition = this.normalizeObjectPosition(posRaw);
                } catch {
                    if (!this.state.cropping.mode) this.state.cropping.mode = 'cover';
                    if (!this.state.cropping.objectPosition) this.state.cropping.objectPosition = '50% 50%';
                }

                // Local fallback cache so the resting preview remains stable.
                try {
                    this.safeWriteJson(`h2s_pp_asset_crop:${assetId}`, this.state.cropping);
                } catch {
                    // ignore
                }

                // Validate trim window BEFORE any async operations or UI state changes
                const v = document.getElementById('ppLocalPreviewVideo');
                const previewDuration = Number.isFinite(v?.duration) ? v.duration : null;
                const assetDuration = Number(this.state.edit?.asset?.duration_seconds);
                const durationSeconds = (previewDuration !== null) ? previewDuration : (Number.isFinite(assetDuration) ? assetDuration : undefined);

                const tv = this.validateTrimWindow({ media_kind: 'video', duration_seconds: durationSeconds });
                if (!tv?.ok) {
                    showToast(String(tv?.error || 'Invalid trim window'), 'error');
                    // Highlight the trim controls to show validation error
                    const trimStartEl = document.getElementById('ppTrimStartSec');
                    const trimEndEl = document.getElementById('ppTrimEndSec');
                    if (trimStartEl) {
                        trimStartEl.style.outline = '2px solid #ef4444';
                        setTimeout(() => { trimStartEl.style.outline = ''; }, 2000);
                    }
                    if (trimEndEl) {
                        trimEndEl.style.outline = '2px solid #ef4444';
                        setTimeout(() => { trimEndEl.style.outline = ''; }, 2000);
                    }
                    return;
                }

                // All validation passed - NOW set loading state
                this.setEditorStatus('saving', 'Saving...', {
                    detail: 'Saving changes...',
                    buttonState: {
                        state: 'loading',
                        disabled: true
                    }
                });

                const asset = this.state.edit?.asset;
                
                try {
                    // Centralized routing logic
const cropping = this.state.cropping || {};
                  const destinations = this.state.destinations || [];

                  const route = this.determineEditEndpoint(asset, {
                          assetId,
                          rotateDeg,
                          trimStartSec,
                          trimEndSec,
                          filterBw,
                          intent: updateIntent,
                          weight: updateWeight,
                          brightness,
                          contrast,
                          saturation,
                          cropping,
                          destinations
                    });
                    
                        // Log the actual payload being sent
                        console.log('[Editor] Sending PATCH payload:', JSON.stringify(route.payload));

                        let resp = await this.fetchJson(route.endpoint, {
                            method: route.method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(route.payload),
                        });

                    // Normalize response structure (backend inconsistency fix)
                    // If backend returns asset but forgets ok:true, treat as success
                    if (!resp.ok && resp.asset) {
                        resp.ok = true; 
                    }

                    if (!resp?.ok) throw new Error(resp?.error || 'Save failed');

                    if (resp?.noop) {
                        showToast('No changes detected', 'info');
                        this.setEditorStatus('idle', 'Ready', {
                            buttonState: {
                                state: 'idle',
                                disabled: false
                            }
                        });
                        return;
                    }

                    // Detect all changes using centralized method
                    const formData = { rotateDeg, trimStartSec, trimEndSec, filterBw, brightness, contrast, saturation,
                                       updateIntent, updateWeight, tilt, scale, panX, panY };
                    const changes = this.detectEditorChanges(formData, asset);
                    const changeSummary = changes.length > 0 ? `: ${this.formatChangesSummary(changes)}` : '';

                    // Update local edit state with the returned asset (new storage path)
                    if (resp?.asset?.asset_id) {
                        // If backend doesn't echo back smart_crop_details, keep our saved framing locally.
                        try {
                            const merged = Object.assign({}, (resp.asset.smart_crop_details && typeof resp.asset.smart_crop_details === 'object') ? resp.asset.smart_crop_details : {}, cropping);
                            resp.asset.smart_crop_details = merged;
                        } catch {
                            // ignore
                        }

                        this.state.edit.asset = resp.asset;

                        // Immediately update the library/resting card data so the preview reflects the saved edit.
                        try {
                            const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                            const idx = items.findIndex(a => String(a?.asset_id || '') === String(resp.asset.asset_id || ''));
                            if (idx >= 0) {
                                items[idx] = resp.asset;
                                if (this.state.assets) this.state.assets.items = items;
                                this.setAssetsUi(this.state.assets);
                            }
                        } catch {
                            // ignore
                        }
                        
                        // Separate Partial Failure Handling: Preview Reload
                        try {
                             await this.reloadPreviewAfterEdit(resp.asset, changes);
                        } catch (previewErr) {
                             console.warn('[Editor] Save succeeded but preview reload failed:', previewErr);
                             showToast('Saved successfully, but preview failed to load. Try refreshing.', 'warning');
                             
                             // Set a warning status but keep it functional
                             this.setEditorStatus('warning', 'Saved (Preview Error)', {
                                 detail: 'Saved, but preview failed to load',
                                 buttonState: {
                                    state: 'warning', 
                                    disabled: false
                                 },
                                 resetAfterMs: 5000
                             });
                             
                             // Force asset list refresh even if preview failed
                             this.refreshAssets(); 
                             this.refreshCoverage();
                             return; // Exit success flow (preview failed branch)
                        }
                    }

                    showToast(`Edits applied successfully${changeSummary}`, 'success');
                    
                    // Mark that we successfully saved - so closing won't show "Editing cancelled"
                    this.state._editSaved = true;
                    
                    // Set success state with auto-reset after 2s
                    const timestamp = new Date().toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit' });
                    this.setEditorStatus('success', `Updated at ${timestamp}`, {
                        detail: `Applied: ${this.formatChangesSummary(changes) || 'saved'}`,
                        buttonState: { state: 'success' },
                        resetAfterMs: 2000
                    });
                    
                    this.refreshAssets();
                    this.refreshCoverage();
                } catch (e) {
                    console.error('Apply edits error:', e);
                    const status = e?.status ? ` (HTTP ${e.status})` : '';
                    
                    showToast(`Edit failed: ${e?.message || 'Unknown error'}${status}`, 'error');
                    
                    // Set error state with auto-reset after 4s
                    this.setEditorStatus('error', 'Save failed', {
                        buttonState: {
                            state: 'error',
                            disabled: false
                        },
                        resetAfterMs: 4000
                    });
                }
            },

            // Show success animation overlay
            showSuccessAnimation() {
                const overlay = document.createElement('div');
                overlay.className = 'pp-success-overlay';
                overlay.innerHTML = `
                    <div class="pp-success-icon">
                        <svg fill="currentColor" viewBox="0 0 16 16">
                            <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                        </svg>
                    </div>
                    <div class="pp-success-message">Changes saved!</div>
                `;
                
                document.body.appendChild(overlay);
                
                // Fade out and remove after 1.5 seconds
                setTimeout(() => {
                    overlay.style.transition = 'opacity 0.3s ease-out';
                    overlay.style.opacity = '0';
                    setTimeout(() => overlay.remove(), 300);
                }, 1500);
            },
            
            // Resize video to fill stage - scale UP
            resizeVideoToFitStage() {
                const video = document.getElementById('ppEditorVideo');
                if (!video) return;
                
                // Ensure proper sizing (should be handled by CSS usually, but just in case)
                video.style.width = '100%';
                video.style.height = '100%'; 
                video.style.objectFit = 'contain';
                
                // Log dimensions after metadata loads
                if (video.tagName === 'VIDEO' && video.videoWidth) {
                    console.log('[Stage] OK: Video scaled to fit container:', {
                        video: `${video.videoWidth}x${video.videoHeight}`,
                        display: `${video.offsetWidth}x${video.offsetHeight}`
                    });
                    
                    const resolutionBadge = document.getElementById('ppInfoResolution');
                    if (resolutionBadge) {
                        resolutionBadge.textContent = `${video.videoWidth}x${video.videoHeight}`;
                    }
                }
            },
            
            // Animate control value badge on change
            animateControlValue(valueElementId) {
                const el = document.getElementById(valueElementId);
                if (!el) return;
                
                el.classList.remove('updating');
                void el.offsetWidth; // Force reflow
                el.classList.add('updating');
                
                setTimeout(() => el.classList.remove('updating'), 300);
            },

            beginReplaceAssetMedia(assetId) {
                const items = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                const asset = items.find(a => String(a?.asset_id || '') === String(assetId));
                if (!asset) {
                    showToast('Asset not found. Refresh the library and try again.', 'error');
                    return;
                }

                const input = document.getElementById('ppReplaceFileInput');
                if (!input) {
                    showToast('Replace input missing in UI', 'error');
                    return;
                }

                this.state.replace = { assetId: String(assetId), asset };
                input.value = '';
                const kind = String(asset?.media_kind || '').trim();
                input.accept = (kind === 'video') ? 'video/*' : 'image/*';
                input.click();
            },

            async onReplaceFileSelected(file) {
                const statusEl = document.getElementById('ppAssetsStatus');
                const targetAssetId = String(this.state.replace?.assetId || '').trim();
                const targetAsset = this.state.replace?.asset || null;

                if (!file) return;
                if (!targetAssetId) {
                    showToast('No replacement target selected', 'error');
                    return;
                }

                try {
                    if (statusEl) statusEl.textContent = 'Replacing media...';

                    const pack = this.getSelectedPack();
                    if (!pack?.pack_id) throw new Error('Select a pack first');

                    const surface = document.getElementById('ppSurface')?.value || 'bundles';
                    const service = String(targetAsset?.service || document.getElementById('ppService')?.value || '').trim();

                    const analysis = await this.analyzeFile(file);
                    const media_kind = String(analysis?.media_kind || '').trim() || (file?.type?.startsWith('video/') ? 'video' : 'photo');

                    const existingKind = String(targetAsset?.media_kind || '').trim();
                    if (existingKind && existingKind !== media_kind) {
                        const ok = confirm(`This asset is currently marked as "${existingKind}", but the selected file is "${media_kind}". Replace anyway? (This will update the asset's media_kind.)`);
                        if (!ok) {
                            if (statusEl) statusEl.textContent = '';
                            return;
                        }
                    }

                    const rotateDeg = (media_kind === 'video') ? this.getRotateDegPreference() : '0';
                    const trimStartSec = (media_kind === 'video') ? this.getTrimStartSecPreference() : '';
                    const trimEndSec = (media_kind === 'video') ? this.getTrimEndSecPreference() : '';

                    const tv = this.validateTrimWindow({ media_kind, duration_seconds: analysis?.duration_seconds });
                    if (!tv?.ok) {
                        if (statusEl) statusEl.textContent = '';
                        showToast(String(tv?.error || 'Invalid trim window'), 'error');
                        return;
                    }

                    const convertToMp4 = (media_kind === 'video' && (rotateDeg !== '0' || !!trimStartSec || !!trimEndSec || this.getConvertToMp4Preference())) ? '1' : '0';

                    const payloadLimitBytes = 4 * 1024 * 1024;
                    const shouldStage = (media_kind === 'video') || ((file?.size || 0) > payloadLimitBytes);

                    let upload;
                    if (shouldStage) {
                        const init = await this.fetchJson('/api/admin/proof-upload-init', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                surface,
                                service,
                                week_of: pack.week_of || '',
                                bucket: 'proof',
                                filename: file?.name || 'upload',
                                mime: file?.type || '',
                                media_kind,
                                convert_to_mp4: convertToMp4,
                                rotate_deg: rotateDeg,
                                trim_start_sec: trimStartSec || undefined,
                                trim_end_sec: trimEndSec || undefined,
                            }),
                        });

                        if (!init?.ok || !init?.signed_url || !init?.raw_path) {
                            throw new Error('Staged upload init failed');
                        }

                        const putRes = await fetch(String(init.signed_url), {
                            method: 'PUT',
                            headers: { 'Content-Type': file?.type || 'application/octet-stream' },
                            body: file,
                        });
                        if (!putRes.ok) {
                            const t = await putRes.text().catch(() => '');
                            const err = new Error(`Staged upload failed (HTTP ${putRes.status})${t ? `: ${t}` : ''}`);
                            err.status = putRes.status;
                            throw err;
                        }

                        upload = await this.fetchJson('/api/admin/proof-upload-finalize', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bucket: 'proof',
                                raw_path: init.raw_path,
                                filename: file?.name || 'upload',
                                mime: file?.type || '',
                                surface,
                                service,
                                week_of: pack.week_of || '',
                                media_kind,
                                convert_to_mp4: convertToMp4,
                                rotate_deg: rotateDeg,
                                trim_start_sec: trimStartSec || undefined,
                                trim_end_sec: trimEndSec || undefined,
                            }),
                        });
                    } else {
                        const fd = new FormData();
                        fd.append('file', file);
                        fd.append('surface', surface);
                        fd.append('service', service);
                        fd.append('week_of', pack.week_of || '');
                        fd.append('bucket', 'proof');
                        fd.append('convert_to_mp4', convertToMp4);
                        fd.append('rotate_deg', rotateDeg);
                        if (trimStartSec) fd.append('trim_start_sec', trimStartSec);
                        if (trimEndSec) fd.append('trim_end_sec', trimEndSec);

                        upload = await this.fetchJson('/api/admin/proof-upload', {
                            method: 'POST',
                            body: fd,
                        });
                    }

                    const patch = {
                        asset_id: targetAssetId,
                        storage_bucket: upload?.bucket || 'proof',
                        storage_path: upload?.path || '',
                        content_type: upload?.content_type || file?.type || null,
                        file_size_kb: upload?.file_size_kb || analysis?.file_size_kb || Math.round((file.size || 0) / 1024) || null,
                        width_px: analysis?.width_px || null,
                        height_px: analysis?.height_px || null,
                        duration_seconds: analysis?.duration_seconds ?? null,
                        media_kind,
                        thumbnail_storage_path: upload?.thumbnail_storage_path || null,
                    };

                    if (!patch.storage_path) throw new Error('Upload did not return storage path');

                    await this.fetchJson('/api/admin/proof-assets', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(patch),
                    });

                    showToast('Asset media replaced', 'success');
                    if (statusEl) statusEl.textContent = '';
                    this.state.replace = { assetId: '', asset: null };
                    this.refreshAssets();
                    this.refreshCoverage();
                } catch (e) {
                    console.error(e);
                    if (statusEl) statusEl.textContent = '';
                    showToast(`Replace failed: ${e?.message || 'Unknown error'}`, 'error');
                }
            },

            renderCoverageSlots(trackEl, targetCount, filledCount, loading, tenCol) {
                if (!trackEl) return;
                const n = Math.max(0, Math.min(24, Number(targetCount || 0)));
                trackEl.classList.toggle('is-ten', !!tenCol);
                const safeFilled = Math.max(0, Math.min(n, Number(filledCount || 0)));
                const parts = [];
                for (let i = 0; i < n; i++) {
                    if (loading) parts.push('<div class="meter-slot is-ghost"></div>');
                    else if (i < safeFilled) parts.push('<div class="meter-slot is-filled"></div>');
                    else parts.push('<div class="meter-slot"></div>');
                }
                trackEl.innerHTML = parts.join('');
            },

            setCoverageUi(coverage) {
                const hintEl = document.getElementById('ppCoverageHint');
                const statusEl = document.getElementById('ppCoverageStatus');
                const vPill = document.getElementById('ppCoverageVideos');
                const pPill = document.getElementById('ppCoveragePhotos');
                const vTrack = document.getElementById('ppCoverageVideoTrack');
                const pTrack = document.getElementById('ppCoveragePhotoTrack');
                const vLabel = document.getElementById('ppCoverageVideoLabel');
                const pLabel = document.getElementById('ppCoveragePhotoLabel');

                const targets = this.getCoverageTargets();
                const targetVideos = targets.videos;
                const targetPhotos = targets.photos;
                const loading = !!coverage?.loading;
                const packId = String(coverage?.pack_id || '');
                const scopeNote = String(coverage?.scopeNote || '');

                if (hintEl) hintEl.textContent = packId ? targets.hint : 'Select a pack to see coverage targets.';
                if (statusEl) statusEl.textContent = loading ? 'Measuring pack...' : '';

                const videos = Number(coverage?.videos || 0);
                const photos = Number(coverage?.photos || 0);

                const missingVideos = Math.max(0, targetVideos - videos);
                const missingPhotos = Math.max(0, targetPhotos - photos);
                const vDone = targetVideos > 0 && missingVideos === 0;
                const pDone = missingPhotos === 0;

                if (vPill) vPill.textContent = targetVideos ? `Videos: ${loading ? '-' : videos}/${targetVideos}${(!loading && vDone) ? ' OK' : ''}` : 'Videos: n/a';
                if (pPill) pPill.textContent = `Photos: ${loading ? '-' : photos}/${targetPhotos}${(!loading && pDone) ? ' OK' : ''}`;

                if (vLabel) vLabel.textContent = targetVideos
                    ? `Target: ${targetVideos}${loading ? '' : (vDone ? ' - Complete' : ` - Need ${missingVideos}`)}`
                    : 'Target: 0';
                if (pLabel) pLabel.textContent = `Target: ${targetPhotos}${loading ? '' : (pDone ? ' - Complete' : ` - Need ${missingPhotos}`)}`;

                if (vPill) vPill.style.display = targetVideos ? '' : 'none';
                if (vTrack) vTrack.style.display = targetVideos ? '' : 'none';
                if (vLabel && vLabel.parentElement) vLabel.parentElement.style.display = targetVideos ? '' : 'none';

                this.renderCoverageSlots(vTrack, targetVideos, videos, loading, false);
                this.renderCoverageSlots(pTrack, targetPhotos, photos, loading, true);

                if (!loading && statusEl && packId) {
                    const extraVideos = Math.max(0, videos - targetVideos);
                    const extraPhotos = Math.max(0, photos - targetPhotos);

                    if (targetVideos === 0 && missingPhotos === 0) {
                        statusEl.textContent = scopeNote ? `Coverage OK. ${scopeNote}` : 'Coverage OK.';
                        return;
                    }

                    const parts = [];
                    if (targetVideos > 0) {
                        if (missingVideos > 0) parts.push(`Need ${missingVideos} more videos`);
                        else parts.push('Videos OK');
                    }
                    if (missingPhotos > 0) parts.push(`Need ${missingPhotos} more photos`);
                    else parts.push('Photos OK');

                    if (missingVideos === 0 && missingPhotos === 0) {
                        statusEl.textContent = `Coverage complete. ${scopeNote ? scopeNote : ''}`.trim();
                        return;
                    }

                    const extras = [];
                    if (extraVideos > 0) extras.push(`+${extraVideos} extra videos (more rotation options)`);
                    if (extraPhotos > 0) extras.push(`+${extraPhotos} extra photos (more rotation options)`);

                    let next = '';
                    if (targetVideos > 0 && (missingVideos > 0 || missingPhotos > 0)) {
                        if (missingVideos >= missingPhotos && missingVideos > 0) next = 'Next: upload a short video.';
                        else if (missingPhotos > 0) next = 'Next: upload a photo.';
                    } else if (missingPhotos > 0) {
                        next = 'Next: upload a photo.';
                    }

                    statusEl.textContent = `${parts.join(' | ')}${extras.length ? ' | ' + extras.join(' | ') : ''}${next ? ' | ' + next : ''}${scopeNote ? ' | ' + scopeNote : ''}`;
                }
            },

            async refreshCoverage() {
                const pack = this.getSelectedPack();
                const targets = this.getCoverageTargets();
                const packId = pack?.pack_id || '';

                if (!packId) {
                    this.state.coverage = { loading: false, pack_id: null, videos: 0, photos: 0, targetVideos: targets.videos, targetPhotos: targets.photos };
                    this.setCoverageUi(this.state.coverage);
                    return;
                }

                this.state.coverage = { loading: true, pack_id: packId, videos: 0, photos: 0, targetVideos: targets.videos, targetPhotos: targets.photos, scopeNote: '' };
                this.setCoverageUi(this.state.coverage);

                try {
                    // Load ALL visible assets for this pack (no service filtering)
                    const respScoped = await this.fetchJson(
                        `/api/admin/proof-assets?pack_id=${encodeURIComponent(packId)}&is_visible=true&limit=500`
                    );
                    let assets = Array.isArray(respScoped?.assets) ? respScoped.assets : [];
                    let scopeNote = '';

                    const videos = assets.filter(a => String(a?.media_kind || '') === 'video').length;
                    const photos = assets.filter(a => String(a?.media_kind || '') === 'photo').length;
                    this.state.coverage = { loading: false, pack_id: packId, videos, photos, targetVideos: targets.videos, targetPhotos: targets.photos, scopeNote };
                    this.safeWriteJson(this.getCoverageCacheKey(packId, 'all'), {
                        ts: Date.now(),
                        videos,
                        photos,
                        scopeNote,
                    });
                    this.setCoverageUi(this.state.coverage);
                } catch (e) {
                    // Keep UI usable even if assets endpoint is locked/misconfigured.
                    const cached = this.safeReadJson(this.getCoverageCacheKey(packId, 'all'));
                    const age = this.formatAge(cached?.ts);

                    if (cached && (Number.isFinite(Number(cached?.videos)) || Number.isFinite(Number(cached?.photos)))) {
                        const note = `Using cached coverage${age ? ` (${age})` : ''}. Sign in to refresh.`;
                        this.state.coverage = {
                            loading: false,
                            pack_id: packId,
                            videos: Number(cached?.videos || 0),
                            photos: Number(cached?.photos || 0),
                            targetVideos: targets.videos,
                            targetPhotos: targets.photos,
                            scopeNote: note,
                        };
                        this.setCoverageUi(this.state.coverage);
                        const statusEl = document.getElementById('ppCoverageStatus');
                        if (statusEl) statusEl.textContent = e?.status === 401 ? 'Unauthorized (showing cached).' : `Coverage offline (showing cached): ${e.message}`;
                        return;
                    }

                    // Fallback: derive coverage from cached library if present
                    const cachedAssets = this.safeReadJson(this.getAssetsCacheKey(packId, 'all'));
                    const cachedItems = Array.isArray(cachedAssets?.items) ? cachedAssets.items : [];
                    if (cachedItems.length) {
                        const counts = this.countMedia(cachedItems, { visibleOnly: true });
                        const note = `Coverage from cached library${age ? ` (${age})` : ''}. Sign in to refresh.`;
                        this.state.coverage = { loading: false, pack_id: packId, videos: counts.videos, photos: counts.photos, targetVideos: targets.videos, targetPhotos: targets.photos, scopeNote: note };
                        this.setCoverageUi(this.state.coverage);
                        const statusEl = document.getElementById('ppCoverageStatus');
                        if (statusEl) statusEl.textContent = e?.status === 401 ? 'Unauthorized (showing cached).' : `Coverage offline (showing cached): ${e.message}`;
                        return;
                    }

                    this.state.coverage = { loading: false, pack_id: packId, videos: 0, photos: 0, targetVideos: targets.videos, targetPhotos: targets.photos, scopeNote: '' };
                    this.setCoverageUi(this.state.coverage);
                    const statusEl = document.getElementById('ppCoverageStatus');
                    if (statusEl) statusEl.textContent = 'Coverage unavailable (check admin key).';
                }
            },

            async onMultipleFilesSelected(files) {
                if (files.length === 0) return;
                
                // Filter for supported files
                let supported = files.filter(f => {
                    const mime = (f.type || '').toLowerCase();
                    return mime.includes('image/') || mime.includes('video/');
                });
                
                if (supported.length === 0) {
                    this.showToast('No supported files found (images or videos only)', 'error');
                    return;
                }

                // FILE DUPE INTELLIGENCE
                const skipped = [];
                const libraryItems = Array.isArray(this.state.assets?.items) ? this.state.assets.items : [];
                
                supported = supported.filter(file => {
                    // Check 1: Is it already in Staging? (Prevent double-drop)
                    const existingStage = (this.state.stagedFiles || []).find(s => s.name === file.name && s.size === file.size);
                    if (existingStage) {
                        skipped.push(file.name);
                        return false;
                    }

                    // Check 2: Is it already in the Library? (Prevent re-upload)
                    // Note: 'storage_path' usually ends with the filename.
                    const existingLib = libraryItems.find(item => {
                        return String(item.storage_path || '').endsWith(file.name);
                    });
                    
                    if (existingLib) {
                         skipped.push(`${file.name} (already in library)`);
                         return false;
                    }
                    
                    return true;
                });
                
                if (skipped.length > 0) {
                    console.warn('Skipped duplicates:', skipped);
                    this.showToast(`Skipped ${skipped.length} duplicate file(s).`, 'warning');
                }

                if (supported.length === 0) return;
                
                if (supported.length < files.length && skipped.length === 0) {
                    this.showToast(`Skipped ${files.length - supported.length} unsupported file(s)`, 'warning');
                }
                
                // STAGING MODE: Append valid files to staging
                // "It can't just reappend" -> We handled the "same images" case.
                // We DO want to append *new* distinctive images to the staging list so user can build a batch.
                const currentStaged = this.state.stagedFiles || [];
                this.state.stagedFiles = [...currentStaged, ...supported];
                this.renderStagingUI();
            },

            renderStagingUI() {
                const files = this.state.stagedFiles || [];
                const container = document.getElementById('ppFilePreviews');
                const grid = document.getElementById('ppPreviewGrid');
                const uploadBtn = document.getElementById('ppUploadBtn');
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                
                if (!container || !grid) return;
                
                grid.innerHTML = '';
                container.style.display = 'block';
                
                // Use a proper grid layout for "consolidation"
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
                grid.style.gap = '12px';
                
                // Determine available options based on service
                const isTv = service === 'tv_mounting';
                
                files.forEach((file, idx) => {
                    const isImage = file.type.startsWith('image/');
                    const card = document.createElement('div');
                    card.style.cssText = `
                        background: #fff;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
                        opacity: 0;
                        transform: translateY(10px);
                        transition: all 0.3s ease;
                    `;
                    
                    // Thumbnail Area
                    const thumbRow = document.createElement('div');
                    thumbRow.style.cssText = "height: 120px; background: #f1f5f9; position: relative; overflow: hidden; border-bottom: 1px solid #e2e8f0; display:flex; align-items:center; justify-content:center;";
                    
                    if (isImage) {
                        const url = URL.createObjectURL(file);
                        thumbRow.innerHTML = `<img src="${this.escapeHtml(url)}" style="width:100%; height:100%; object-fit: cover;" />`;
                    } else {
                        thumbRow.innerHTML = `<span style="font-size:14px; font-weight:900; letter-spacing:0.08em; color:#334155;">VID</span>`;
                    }
                    
                    // Overlay Status (Checkmark/X)
                    const statusOverlay = document.createElement('div');
                    statusOverlay.id = `ppStagedStatus_${idx}`;
                    statusOverlay.style.cssText = "position:absolute; inset:0; background:rgba(255,255,255,0.9); display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; pointer-events:none;";
                    thumbRow.appendChild(statusOverlay);
                    
                    // Metadata/Controls Area
                    const controls = document.createElement('div');
                    controls.style.padding = '10px';
                    
                    const metaRow = document.createElement('div');
                    metaRow.style.cssText = "display:flex; justify-content:space-between; margin-bottom: 6px; font-size:11px; color:#64748b;";
                    metaRow.innerHTML = `<span>${Math.round(file.size/1024)} KB</span>`;
                    controls.appendChild(metaRow);
                    
                    // Shot Type Selector
                    const shotWrap = document.createElement('div');
                    shotWrap.style.marginBottom = '6px';
                    const shotSel = document.createElement('select');
                    shotSel.id = `ppStagedShot_${idx}`;
                    shotSel.className = 'form-select';
                    shotSel.style.cssText = "font-size:12px; padding:4px 6px; width:100%; border:1px solid #cbd5e1; border-radius:4px;";
                    
                    const mainShot = document.getElementById('ppShotType');
                    if (mainShot) {
                        Array.from(mainShot.options).forEach(opt => {
                            if (opt.value) { 
                                const o = document.createElement('option');
                                o.value = opt.value;
                                o.textContent = opt.textContent;
                                shotSel.appendChild(o);
                            }
                        });
                        shotSel.value = mainShot.value || 'after';
                    }
                    shotWrap.appendChild(shotSel);
                    controls.appendChild(shotWrap);

                    // ---------------------------------------------------------
                    // DIRECTOR'S CHAIR UI (Asset Intent Classification)
                    // ---------------------------------------------------------
                    const intentWrap = document.createElement('div');
                    intentWrap.style.cssText = "margin-bottom:8px; padding-top:4px; border-top:1px dashed #e2e8f0;";
                    
                    // 1. WHAT (Intent)
                    const intentLabel = document.createElement('div');
                    intentLabel.style.cssText = "font-size:10px; font-weight:700; color:#475569; margin-bottom:2px; text-transform:uppercase; letter-spacing:0.5px;";
                    intentLabel.textContent = "Psychological Role (Intent)";
                    intentWrap.appendChild(intentLabel);

                    const intentSel = document.createElement('select');
                    intentSel.id = `ppStagedIntent_${idx}`;
                    intentSel.className = 'form-select';
                    intentSel.style.cssText = "font-size:12px; padding:4px 6px; width:100%; border:1px solid #cbd5e1; border-radius:4px; margin-bottom:6px;";
                    
                    const intentOptions = [
                        { val: '', label: 'Select Proof Type...' },
                        { val: 'working_shot', label: 'Working Shot (tech visible working)' },
                        { val: 'action_proof', label: 'Action Proof (process/motion)' },
                        { val: 'result_proof', label: 'Result Proof (finished outcome)' }
                    ];
                    intentOptions.forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt.val;
                        o.textContent = opt.label;
                        intentSel.appendChild(o);
                    });

                    // Auto-classify Heuristic
                    const fName = file.name.toLowerCase();
                    if (fName.includes('working') || fName.includes('tech') || fName.includes('installer')) intentSel.value = 'working_shot';
                    else if (fName.includes('during') || fName.includes('action') || fName.includes('drill') || fName.includes('pov') || fName.includes('motion')) intentSel.value = 'action_proof';
                    else if (fName.includes('final') || fName.includes('after') || fName.includes('result')) intentSel.value = 'result_proof';
                    else intentSel.value = 'result_proof'; // Default
                    
                    intentWrap.appendChild(intentSel);

                    // 2. WHERE (Destinations) - Simulated Multi-select via Checkboxes
                    const destLabel = document.createElement('div');
                    destLabel.style.cssText = "font-size:10px; font-weight:700; color:#475569; margin-bottom:2px; text-transform:uppercase; letter-spacing:0.5px;";
                    destLabel.textContent = "Frontend Destination(s)";
                    intentWrap.appendChild(destLabel);

                    const destContainer = document.createElement('div');
                    destContainer.style.cssText = "background:#f8fafc; border:1px solid #e2e8f0; border-radius:4px; padding:6px; margin-bottom:6px; display:grid; grid-template-columns: 1fr 1fr; gap:4px;";
                    
                    const destinations = [
                        { key: 'hero', label: 'Hero Carousel' },
                        { key: 'proof_rail', label: 'Proof Rail' },
                        { key: 'content_body', label: 'Body/Behind-Scenes' },
                        { key: 'gallery', label: 'Detail Grid' }
                    ];

                    destinations.forEach(d => {
                        const dWrap = document.createElement('label');
                        dWrap.style.cssText = "display:flex; align-items:center; gap:4px; font-size:11px; cursor:pointer;";
                        
                        const chk = document.createElement('input');
                        chk.type = 'checkbox';
                        chk.value = d.key;
                        chk.id = `ppStagedDest_${idx}_${d.key}`;
                        
                        // Smart defaults based on intent
                        if (intentSel.value === 'result_proof' && (d.key === 'proof_rail' || d.key === 'hero')) chk.checked = true;
                        if (intentSel.value === 'action_proof' && d.key === 'proof_rail') chk.checked = true;
                        if (intentSel.value === 'working_shot' && d.key === 'content_body') chk.checked = true;
                        if (intentSel.value === 'detail_proof' && d.key === 'gallery') chk.checked = true;

                        dWrap.appendChild(chk);
                        dWrap.appendChild(document.createTextNode(d.label));
                        destContainer.appendChild(dWrap);
                    });
                    intentWrap.appendChild(destContainer);

                    // 3. IMPACT (Weight)
                    const weightLabel = document.createElement('div');
                    weightLabel.style.cssText = "font-size:10px; font-weight:700; color:#475569; margin-bottom:2px; text-transform:uppercase; letter-spacing:0.5px; display:flex; justify-content:space-between;";
                    weightLabel.innerHTML = `<span>Conversion Impact</span> <span id="ppStagedWeightVal_${idx}" style="color:#3b82f6;">5</span>`;
                    intentWrap.appendChild(weightLabel);

                    const weightRange = document.createElement('input');
                    weightRange.type = 'range';
                    weightRange.min = '1';
                    weightRange.max = '10';
                    weightRange.value = '5';
                    weightRange.className = 'form-range';
                    weightRange.id = `ppStagedWeight_${idx}`;
                    weightRange.style.width = '100%';
                    weightRange.oninput = (e) => {
                        document.getElementById(`ppStagedWeightVal_${idx}`).textContent = e.target.value;
                    };
                    intentWrap.appendChild(weightRange);

                    controls.appendChild(intentWrap);

                    // Time of Day (Conditional)
                    if (!isTv) {
                         const todSel = document.createElement('select');
                         todSel.id = `ppStagedTod_${idx}`;
                         todSel.className = 'form-select';
                         todSel.style.cssText = "font-size:12px; padding:4px 6px; width:100%; border:1px solid #cbd5e1; border-radius:4px;";
                         todSel.innerHTML = `<option value="day">Day</option><option value="night">Night</option>`;
                         todSel.value = 'day';
                         controls.appendChild(todSel);
                    } else {
                         // Hidden input to keep logic simple
                         const hiddenTod = document.createElement('input');
                         hiddenTod.type = 'hidden';
                         hiddenTod.id = `ppStagedTod_${idx}`;
                         hiddenTod.value = 'indoor'; // Default for TV
                         controls.appendChild(hiddenTod);
                    }
                    
                    card.appendChild(thumbRow);
                    card.appendChild(controls);
                    
                    grid.appendChild(card);
                    
                    setTimeout(() => {
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, idx * 30);

                    // Async: Try to intelligent-guess Time of Day from EXIF
                    if (isImage) {
                        this.readExifData(file).then(exif => {
                            if (exif?.time_of_day) {
                                const todEl = document.getElementById(`ppStagedTod_${idx}`);
                                if (todEl && !isTv) { // Only override if visible/relevant
                                    todEl.value = exif.time_of_day;
                                    todEl.style.borderColor = '#3b82f6'; // Highlight change
                                }
                            }
                        });
                    }
                });
                
                // Update upload button
                if (uploadBtn) {
                     // Cloning to remove old listeners is safer, but just unbinding via property reset works for simple handlers
                     uploadBtn.textContent = `Upload ${files.length} Assets`;
                     uploadBtn.onclick = (e) => {
                         e.preventDefault(); 
                         e.stopPropagation();
                         this.startBackgroundUpload(); 
                     };
                     uploadBtn.classList.remove('btn-secondary');
                     uploadBtn.classList.add('btn-primary');
                }

                // Show "Staged" status
                const statusEl = document.getElementById('ppUploadStatus');
                if (statusEl) {
                    statusEl.textContent = `${files.length} files ready. Review and click Upload.`;
                }
            },

            async startBackgroundUpload(filesInput) { // params changed to support direct call or state
                const files = filesInput || this.state.stagedFiles || [];
                if (!files.length) return;
                
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                
                // Silent UI feedback
                this.showUploadProgress(true);
                // Don't re-render previews if we are using Staged mode (they are already there)
                if (!this.state.stagedFiles) {
                     this.renderFilePreviews(files);
                }
                
                console.log(`[ProofPacks] Starting background upload of ${files.length} files`);
                
                const statusEl = document.getElementById('ppUploadStatus');
                const warnEl = document.getElementById('ppUploadWarning');
                const progressBar = document.getElementById('ppUploadProgressBar');
                const progressText = document.getElementById('ppUploadProgressText');
                const uploadBtn = document.getElementById('ppUploadBtn');
                
                if (uploadBtn) {
                    uploadBtn.style.opacity = '0.7';
                    uploadBtn.innerHTML = '<span style=\"font-size:11px;\">\u23f3</span> Uploading...';
                    uploadBtn.disabled = true;
                }
                
                if (statusEl) {
                    statusEl.textContent = `${files.length} file(s) queued`;
                    statusEl.style.opacity = '1';
                }
                if (warnEl) warnEl.style.opacity = '0';
                
                let succeeded = 0;
                let failed = 0;
                const errors = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const progress = `[${i + 1}/${files.length}]`;
                    const percentComplete = Math.round(((i) / files.length) * 100);
                    
                    if (progressBar) progressBar.style.width = `${percentComplete}%`;
                    if (progressText) progressText.textContent = `${i}/${files.length} complete`;
                    
                    if (statusEl) {
                        statusEl.textContent = `${progress} Processing ${file.name}...`;
                    }
                    
                    try {
                        // INTELLIGENT OVERRIDES: Read from Staging UI if available
                        const stagedShot = document.getElementById(`ppStagedShot_${i}`);
                        const stagedTod = document.getElementById(`ppStagedTod_${i}`);
                        // NEW fields
                        const stagedIntent = document.getElementById(`ppStagedIntent_${i}`);
                        const stagedWeight = document.getElementById(`ppStagedWeight_${i}`);
                        
                        // Collect destinations
                        const dests = [];
                        ['hero', 'proof_rail', 'content_body', 'gallery'].forEach(k => {
                            const chk = document.getElementById(`ppStagedDest_${i}_${k}`);
                            if (chk && chk.checked) dests.push(k);
                        });
                        
                        // Temporarily hijack the global inputs so uploadAndAssignInternal picks them up
                        // This is a bit hacky but avoids rewriting the entire upload logic stack
                        const globalShot = document.getElementById('ppShotType');
                        const globalTod = document.getElementById('ppTimeOfDay');
                        const globalSlot = document.getElementById('ppSlotKey');

                        const oldShot = globalShot?.value;
                        const oldTod = globalTod?.value;
                        const oldSlot = globalSlot?.value;
                        
                        if (globalShot && stagedShot) globalShot.value = stagedShot.value;
                        if (globalTod && stagedTod) globalTod.value = stagedTod.value;
                        
                        // BACKWARD COMPATIBILITY with slot_key logic
                        // If we have an "Intent" system, we assume slot_key handles the Primary Destination for legacy reasons, 
                        // OR we send this new data via a special mechanism.
                        // For Phase 1, we will map the *primary* destination to slot_key so the frontend at least works.
                        if (globalSlot) {
                             if (dests.includes('content_body')) globalSlot.value = 'content_body';
                             else if (dests.includes('hero')) globalSlot.value = 'hero_carousel';
                             else if (dests.includes('proof_rail')) globalSlot.value = 'mid_proof_rail';
                             else if (dests.includes('gallery')) globalSlot.value = 'gallery';
                             else globalSlot.value = 'mid_proof_rail'; // Default
                        }

                        // Set state file for uploadAndAssign
                        this.state.file = file;
                        this.state.analysis = await this.analyzeFile(file);
                        
                        // Temporarily attach extended metadata to the file object itself so uploadAndAssignInternal can read it if modified
                        this.state.file._intentMeta = {
                            customer_intent: stagedIntent?.value || 'result_proof',
                            frontend_destinations: dests,
                            psychological_weight: stagedWeight?.value || 5
                        };

                        await this.uploadAndAssignInternal();
                        succeeded++;
                        
                         // Restore properties (optional, mainly for sanitation)
                        if (globalShot) globalShot.value = oldShot;
                        if (globalTod) globalTod.value = oldTod;
                        if (globalSlot) globalSlot.value = oldSlot;

                        if (statusEl) {
                            statusEl.textContent = `${progress} OK ${file.name}`;
                            statusEl.style.color = '#10b981';
                        }
                        
                        // Update staged card status
                        const statusOverlay = document.getElementById(`ppStagedStatus_${i}`);
                        if (statusOverlay) {
                            statusOverlay.style.opacity = '1';
                            statusOverlay.innerHTML = '<span style="font-size:16px; color:#10b981; font-weight:900; letter-spacing:0.08em;">OK</span>';
                        } else {
                            // Fallback to old method
                            this.updatePreviewStatus(i, 'success');
                        }
                        
                        // Brief pause
                        await new Promise(resolve => setTimeout(resolve, 100));
                    } catch (err) {
                        failed++;
                        const errMsg = err?.message || String(err);
                        errors.push(`${file.name}: ${errMsg}`);
                        console.error(`[ProofPacks] Upload failed for ${file.name}:`, err);
                        
                        const statusOverlay = document.getElementById(`ppStagedStatus_${i}`);
                        if (statusOverlay) {
                            statusOverlay.style.opacity = '1';
                            statusOverlay.innerHTML = '<span style="font-size:16px; color:#ef4444; font-weight:900; letter-spacing:0.08em;">ERR</span>';
                        } else {
                            this.updatePreviewStatus(i, 'error');
                        }
                    }
                }
                
                // Complete progress bar
                if (progressBar) progressBar.style.width = '100%';
                if (progressText) progressText.textContent = 'Complete';
                
                // Reset button
                if (uploadBtn) {
                    uploadBtn.style.opacity = '1';
                    uploadBtn.innerHTML = 'Upload Complete';
                    uploadBtn.disabled = false;
                    setTimeout(() => { uploadBtn.innerHTML = 'Upload'; }, 2000);
                }
                
                // Clear state
                this.state.stagedFiles = null;
                this.state.file = null;
                this.state.analysis = null;
                
                if (succeeded > 0) {
                    this.showToast(`Batch complete: ${succeeded} uploaded`, 'success');
                    await this.refreshAssets(); // Refresh library
                }
                
                if (failed === 0) {
                    // Nice fade out of grid if all good
                    // setTimeout(() => { document.getElementById('ppFilePreviews').style.display = 'none'; }, 3000);
                }
            },

            async onFileSelected(file) {
                // Validate file before processing
                const validation = this.validateFile(file);
                if (!validation.valid) {
                    const warnEl = document.getElementById('ppUploadWarning');
                    if (warnEl) {
                        warnEl.innerHTML = `<span class="error-text" style="color:#dc2626; font-weight:800;"> ${this.escapeHtml(validation.error)}</span>`;
                    }
                    if (typeof showToast === 'function') {
                        showToast(validation.error, 'error');
                    }
                    return;
                }

                // Clean up previous preview URL (avoid leaking object URLs)
                try {
                    if (this.state.previewUrl) URL.revokeObjectURL(this.state.previewUrl);
                } catch {
                    // ignore
                }
                this.state.previewUrl = '';

                this.state.file = file;
                this.state.analysis = null;

                const summary = document.getElementById('ppFileSummary');
                const detectedKind = document.getElementById('ppDetectedKind');
                const warnEl = document.getElementById('ppUploadWarning');

                if (warnEl) warnEl.textContent = '';

                if (!file) {
                    if (summary) this.setHidden(summary, true);
                    if (detectedKind) detectedKind.textContent = 'Detected: -';
                    const rotateEl = document.getElementById('ppVideoRotate');
                    const rotateField = document.getElementById('ppRotateField');
                    const trimField = document.getElementById('ppTrimField');
                    const trimStartEl = document.getElementById('ppTrimStartSec');
                    const trimEndEl = document.getElementById('ppTrimEndSec');
                    const mp4Wrapper = document.getElementById('ppConvertToMp4Wrapper');
                    if (rotateEl) rotateEl.value = '0';
                    if (rotateField) rotateField.style.display = 'none';
                    if (trimField) trimField.style.display = 'none';
                    if (trimStartEl) trimStartEl.value = '';
                    if (trimEndEl) trimEndEl.value = '';
                    if (mp4Wrapper) mp4Wrapper.style.display = 'none';
                    this.ensureDefaults();
                    this.updateAdvice();
                    return;
                }

                try {
                    const analysis = await this.analyzeFile(this.state.file);
                    this.state.analysis = analysis;

                    // Auto-apply EXIF rotation if detected
                    const rotateEl = document.getElementById('ppVideoRotate');
                    if (analysis.exif_rotation && analysis.exif_rotation !== 0 && rotateEl) {
                        rotateEl.value = String(analysis.exif_rotation);
                        this.safeSetItem(this.storageKeys.rotateDeg, String(analysis.exif_rotation));
                        console.log(`[ProofPacks] Auto-applied EXIF rotation: ${analysis.exif_rotation} deg`);
                        if (typeof this.showToast === 'function') {
                            this.showToast(`Auto-corrected orientation: ${analysis.exif_rotation} deg rotation applied`, 'info');
                        } else if (typeof showToast === 'function') {
                            showToast(`Auto-corrected orientation: ${analysis.exif_rotation} deg rotation applied`, 'info');
                        }
                    }
                    
                    // Show/hide MP4 conversion checkbox based on media type
                    const mp4Wrapper = document.getElementById('ppConvertToMp4Wrapper');
                    if (mp4Wrapper) {
                        mp4Wrapper.style.display = (analysis.media_kind === 'video') ? '' : 'none';
                    }

                    if (detectedKind) detectedKind.textContent = `Detected: ${analysis.media_kind || 'unknown'}`;
                    if (summary) {
                        this.setHidden(summary, false);
                        const bits = [];
                        const srcName = String(this.state.file?.name || 'upload');
                        const srcMime = String(analysis.mime || this.state.file?.type || 'unknown');
                        bits.push(`<div><strong>Selected:</strong> ${this.escapeHtml(srcName)}</div>`);
                        bits.push(`<div><strong>Selected type:</strong> ${this.escapeHtml(srcMime)}</div>`);

                        const rotateField = document.getElementById('ppRotateField');
                        const trimField = document.getElementById('ppTrimField');
                        const trimStartEl = document.getElementById('ppTrimStartSec');
                        const trimEndEl = document.getElementById('ppTrimEndSec');
                        if (analysis.media_kind === 'video') {
                            if (rotateField) rotateField.style.display = '';
                            if (rotateEl) {
                                const stored = this.safeGetItem(this.storageKeys.rotateDeg);
                                if (stored) rotateEl.value = String(stored);
                            }

                            if (trimField) trimField.style.display = '';
                            if (trimStartEl) {
                                const stored = this.safeGetItem(this.storageKeys.trimStartSec);
                                if (stored) trimStartEl.value = String(stored);
                            }
                            if (trimEndEl) {
                                const stored = this.safeGetItem(this.storageKeys.trimEndSec);
                                if (stored) trimEndEl.value = String(stored);
                            }
                        } else {
                            if (rotateEl) rotateEl.value = '0';
                            if (rotateField) rotateField.style.display = 'none';
                            if (trimField) trimField.style.display = 'none';
                            if (trimStartEl) trimStartEl.value = '';
                            if (trimEndEl) trimEndEl.value = '';
                        }

                        // Preview what will be stored (even though the local file is still the original).
                        if (analysis.media_kind === 'video' && this.getConvertToMp4Preference()) {
                            const willBeMp4 = !/\.mp4$/i.test(srcName) && !/video\/mp4/i.test(srcMime);
                            const baseName = srcName.replace(/\.[^.]+$/g, '');
                            const plannedName = willBeMp4 ? `${baseName || 'upload'}.mp4` : srcName;
                            const plannedType = willBeMp4 ? 'video/mp4' : srcMime;
                            bits.push(`<div class="u-mt-1"><strong>Will store as:</strong> ${this.escapeHtml(plannedName)}</div>`);
                            bits.push(`<div><strong>Will store type:</strong> ${this.escapeHtml(plannedType)}</div>`);
                        }

                        bits.push(`<div><strong>Size:</strong> ${analysis.file_size_kb} KB</div>`);
                        if (analysis.width_px && analysis.height_px) {
                            bits.push(`<div><strong>Dimensions:</strong> ${analysis.width_px}x${analysis.height_px}</div>`);
                            if (analysis.media_kind === 'video' && Number(analysis.height_px) > Number(analysis.width_px)) {
                                bits.push(`<div class="u-text-sm u-muted">Portrait video detected. If it looks sideways, use Video rotation.</div>`);
                            }
                        }
                        
                        // Show EXIF rotation for photos too
                        if (analysis.media_kind === 'photo' && analysis.exif_rotation && analysis.exif_rotation !== 0) {
                            bits.push(`<div class="u-text-sm u-muted u-mt-1">EXIF orientation corrected: ${analysis.exif_rotation} deg rotation will be applied</div>`);
                        }
                        if (analysis.media_kind === 'video' && typeof analysis.duration_seconds === 'number') {
                            bits.push(`<div><strong>Duration:</strong> ${analysis.duration_seconds.toFixed(2)}s</div>`);
                        }

                        if (analysis.media_kind === 'video') {
                            const startV = String(trimStartEl?.value || '').trim();
                            const endV = String(trimEndEl?.value || '').trim();
                            if (startV || endV) {
                                bits.push(`<div class="u-text-sm u-muted u-mt-1">Trim on upload: ${this.escapeHtml(startV || '0')}s to ${this.escapeHtml(endV || 'end')} (forces MP4 conversion)</div>`);
                            }
                        }

                        if (analysis.media_kind === 'video') {
                            const deg = this.getRotateDegPreference();
                            if (deg !== '0') {
                                const reason = analysis.exif_rotation && analysis.exif_rotation === Number(deg) 
                                    ? ' (auto-detected from EXIF)' 
                                    : '';
                                bits.push(`<div class="u-text-sm u-muted u-mt-1">Rotate on upload: ${this.escapeHtml(deg)} deg${reason} (forces MP4 conversion)</div>`);
                            }
                            try {
                                const url = URL.createObjectURL(this.state.file);
                                this.state.previewUrl = url;
                                bits.push(
                                    `<div class="u-mt-2">` +
                                    `<div id="ppLocalPreviewFrame" style="width:100%; height:240px; display:flex; align-items:center; justify-content:center; overflow:hidden;">` +
                                    `<div id="ppLocalPreviewRotator" style="display:flex; align-items:center; justify-content:center;">` +
                                    `<video id="ppLocalPreviewVideo" src="${this.escapeHtml(url)}" muted playsinline preload="metadata" style="max-width:100%; max-height:240px; object-fit:contain;"></video>` +
                                    `</div>` +
                                    `</div>` +
                                    `<div class="u-mt-1" style="display:flex; align-items:center; gap:8px;">` +
                                    `<button id="ppPreviewPlayPause" class="btn btn-secondary" type="button">Play</button>` +
                                    `<input id="ppPreviewSeek" type="range" min="0" max="0" value="0" style="flex:1;" />` +
                                    `<span id="ppPreviewTime" class="u-text-sm u-muted" style="min-width:92px; text-align:right;">0:00 / 0:00</span>` +
                                    `</div>` +
                                    `<div class="u-mt-1" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">` +
                                    `<button id="ppPreviewSetStart" class="btn btn-secondary" type="button">Set start</button>` +
                                    `<button id="ppPreviewSetEnd" class="btn btn-secondary" type="button">Set end</button>` +
                                    `<button id="ppPreviewPlayWindow" class="btn btn-secondary" type="button">Play window</button>` +
                                    `<span class="u-text-sm u-muted">(uses Trim window fields)</span>` +
                                    `</div>` +
                                    `</div>`
                                );
                            } catch {
                                // ignore
                            }
                        }
                        summary.innerHTML = bits.join('');
                        // Bind custom preview controls + apply rotation after the preview is in the DOM.
                        this.bindPreviewEditor();
                    }

                    this.ensureDefaults();
                    this.updateAdvice();
                } catch (e) {
                    console.error(e);
                    if (detectedKind) detectedKind.textContent = 'Detected: unknown';
                    const rotateEl = document.getElementById('ppVideoRotate');
                    const rotateField = document.getElementById('ppRotateField');
                    const trimField = document.getElementById('ppTrimField');
                    if (rotateEl) rotateEl.value = '0';
                    if (rotateField) rotateField.style.display = 'none';
                    if (trimField) trimField.style.display = 'none';
                    if (summary) {
                        this.setHidden(summary, false);
                        summary.innerHTML = `<div class="warning-text">Could not read media metadata. If this is a video, try MP4 (H.264) or re-export.</div>`;
                    }
                    this.ensureDefaults();
                    this.updateAdvice();
                }
            },

            checkImageQuality(analysis) {
                const w = analysis?.width_px || 0;
                const h = analysis?.height_px || 0;
                const warnEl = document.getElementById('ppUploadWarning');
                
                if (!w || !h || !warnEl) return;
                
                const context = document.getElementById('ppPreviewContext')?.value || 'proof_rail';
                const minDimensions = {
                    proof_rail: 800,
                    hero: 1200,
                    gallery: 600,
                    grid: 600,
                    carousel: 1920
                };
                
                const minRequired = minDimensions[context] || 800;
                const minDim = Math.min(w, h);
                
                if (minDim < minRequired) {
                    warnEl.innerHTML = `<span class="warning-text" style="color:#f59e0b; font-weight:800;"> Low resolution: ${w}x${h}px. Recommended minimum: ${minRequired}px for sharp display in ${context} context.</span>`;
                    if (typeof showToast === 'function') {
                        showToast(`Low resolution image detected (${w}x${h}). Consider using ${minRequired}px+ for best quality.`, 'warning');
                    }
                } else {
                    warnEl.innerHTML = '';
                }
            },

            validateFile(file) {
                if (!file) {
                    return { valid: false, error: 'No file selected' };
                }

                const maxSizeMB = 15;
                const sizeMB = file.size / (1024 * 1024);
                if (sizeMB > maxSizeMB) {
                    return { 
                        valid: false, 
                        error: `File too large: ${sizeMB.toFixed(1)}MB (max ${maxSizeMB}MB). Please compress or resize the image.`
                    };
                }

                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/heic', 'image/heif', 'video/mp4', 'video/quicktime', 'video/x-msvideo'];
                if (!validTypes.includes(file.type)) {
                    return {
                        valid: false,
                        error: `Invalid file type: ${file.type}. Please upload JPG, PNG, WebP, HEIC, or MP4 files.`
                    };
                }

                return { valid: true };
            },

            async analyzeFile(file) {
                const mime = (file.type || '').trim() || null;
                const name = file.name || 'upload';
                const file_size_kb = Math.round((file.size || 0) / 1024);

                // Read EXIF data for images (orientation + capture time for day/night detection)
                let exifRotation = null;
                let exifTimeOfDay = null;
                if (mime && mime.startsWith('image/') && !mime.includes('svg')) {
                    const exifData = await this.readExifData(file);
                    exifRotation = exifData?.rotation || null;
                    exifTimeOfDay = exifData?.time_of_day || null;
                    
                    if (exifRotation !== null && exifRotation !== 0) {
                        console.log(`[ProofPacks] EXIF orientation detected: ${exifRotation} deg for ${name}`);
                    }
                    if (exifTimeOfDay) {
                        console.log(`[ProofPacks] EXIF time_of_day detected: ${exifTimeOfDay} for ${name}`);
                    }
                }

                let media_kind = 'photo';
                if (/^video\//i.test(mime)) media_kind = 'video';
                else if (/^image\//i.test(mime)) media_kind = 'photo';
                else if (/\.(mp4|webm|mov)$/i.test(name)) media_kind = 'video';

                const base = { mime, media_kind, file_size_kb, width_px: null, height_px: null, duration_seconds: null };

                if (media_kind === 'photo') {
                    try {
                        const bitmap = await createImageBitmap(file);
                        const result = { 
                            ...base, 
                            width_px: bitmap.width, 
                            height_px: bitmap.height,
                            exif_rotation: exifRotation,
                            exif_time_of_day: exifTimeOfDay
                        };
                        
                        // Quality check and warnings
                        this.checkImageQuality(result);
                        
                        return result;
                    } catch {
                        // Safari/older browsers: createImageBitmap may fail.
                        return { ...base, exif_rotation: exifRotation, exif_time_of_day: exifTimeOfDay };
                    }
                }

                // video metadata via <video>
                const url = URL.createObjectURL(file);
                try {
                    const v = document.createElement('video');
                    v.preload = 'metadata';
                    v.muted = true;
                    v.src = url;

                    await new Promise((resolve, reject) => {
                        const onLoaded = () => {
                            cleanup();
                            resolve();
                        };
                        const onErr = () => {
                            cleanup();
                            reject(new Error('Video metadata unavailable'));
                        };
                        const cleanup = () => {
                            v.removeEventListener('loadedmetadata', onLoaded);
                            v.removeEventListener('error', onErr);
                        };
                        v.addEventListener('loadedmetadata', onLoaded);
                        v.addEventListener('error', onErr);
                    });

                    return {
                        ...base,
                        width_px: v.videoWidth || null,
                        height_px: v.videoHeight || null,
                        duration_seconds: Number.isFinite(v.duration) ? v.duration : null,
                        exif_rotation: exifRotation,
                        exif_time_of_day: exifTimeOfDay,
                    };
                } finally {
                    URL.revokeObjectURL(url);
                }
            },

            async readExifData(file) {
                // Read EXIF data from image file: orientation + capture time
                // Returns { rotation: 0|90|180|270, time_of_day: 'day'|'night'|null }
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const view = new DataView(e.target.result);
                            const result = { rotation: null, time_of_day: null };
                            
                            // Check for JPEG signature
                            if (view.getUint16(0, false) !== 0xFFD8) {
                                resolve({ rotation: null, time_of_day: null });
                                return;
                            }
                            
                            const length = view.byteLength;
                            let offset = 2;
                            
                            // Find EXIF marker
                            while (offset < length) {
                                if (view.getUint16(offset + 2, false) <= 8) {
                                    resolve(result);
                                    return;
                                }
                                const marker = view.getUint16(offset, false);
                                offset += 2;
                                
                                if (marker === 0xFFE1) {
                                    // EXIF marker found
                                    const exifOffset = offset + 2;
                                    
                                    // Check for "Exif" identifier
                                    if (view.getUint32(exifOffset, false) !== 0x45786966) {
                                        resolve(result);
                                        return;
                                    }
                                    
                                    const tiffOffset = exifOffset + 6;
                                    const littleEndian = view.getUint16(tiffOffset, false) === 0x4949;
                                    
                                    // Get first IFD offset
                                    const ifdOffset = view.getUint32(tiffOffset + 4, littleEndian);
                                    const tagCount = view.getUint16(tiffOffset + ifdOffset, littleEndian);
                                    
                                    // Search for orientation (0x0112) and DateTime (0x0132) tags
                                    for (let i = 0; i < tagCount; i++) {
                                        const tagOffset = tiffOffset + ifdOffset + 2 + (i * 12);
                                        const tag = view.getUint16(tagOffset, littleEndian);
                                        
                                        if (tag === 0x0112) {
                                            // Found orientation tag
                                            const orientation = view.getUint16(tagOffset + 8, littleEndian);
                                            
                                            // Convert EXIF orientation to rotation degrees
                                            const rotationMap = {
                                                1: 0,   // Normal
                                                2: 0,   // Flipped horizontal (not supported, treat as normal)
                                                3: 180, // Rotated 180 deg
                                                4: 0,   // Flipped vertical (not supported, treat as normal)
                                                5: 0,   // Flipped horizontal + 90 deg CW (not supported)
                                                6: 270, // Rotated 90 deg CW (need to rotate 270 deg to correct)
                                                7: 0,   // Flipped horizontal + 90 deg CCW (not supported)
                                                8: 90,  // Rotated 90 deg CCW (need to rotate 90 deg to correct)
                                            };
                                            
                                            result.rotation = rotationMap[orientation] || null;
                                        }
                                        
                                        if (tag === 0x0132) {
                                            // Found DateTime tag (format: \"YYYY:MM:DD HH:MM:SS\")
                                            const dataType = view.getUint16(tagOffset + 2, littleEndian);
                                            if (dataType === 2) { // ASCII string
                                                const strOffset = view.getUint32(tagOffset + 8, littleEndian);
                                                try {
                                                    let dateStr = '';
                                                    for (let j = 0; j < 19 && j < 100; j++) {
                                                        const charCode = view.getUint8(tiffOffset + strOffset + j);
                                                        if (charCode === 0) break;
                                                        dateStr += String.fromCharCode(charCode);
                                                    }
                                                    // Parse \"YYYY:MM:DD HH:MM:SS\" -> detect hour
                                                    const parts = dateStr.match(/^(\\d{4}):(\\d{2}):(\\d{2}) (\\d{2}):(\\d{2}):(\\d{2})$/);
                                                    if (parts) {
                                                        const hour = parseInt(parts[4], 10);
                                                        // Daytime: 6am-7pm (6-19), Night: 7pm-6am (19-6)
                                                        result.time_of_day = (hour >= 6 && hour < 19) ? 'day' : 'night';
                                                    }
                                                } catch (e) {
                                                    // Ignore DateTime parsing errors
                                                }
                                            }
                                        }
                                    }
                                    
                                    resolve(result);
                                    return;
                                }
                                
                                offset += view.getUint16(offset, false);
                            }
                            
                            resolve(null);
                        } catch (err) {
                            console.warn('[ProofPacks] Failed to read EXIF orientation:', err);
                            resolve(null);
                        }
                    };
                    
                    reader.onerror = () => resolve({ rotation: null, time_of_day: null });
                    
                    // Only read first 64KB (EXIF is typically in first few KB)
                    const blob = file.slice(0, 64 * 1024);
                    reader.readAsArrayBuffer(blob);
                });
            },

            escapeHtml(input) {
                return String(input || '').replace(/[&<>"']/g, (ch) => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[ch]));
            },

            showUploadProgress(show) {
                const progressContainer = document.getElementById('ppUploadProgress');
                const progressBar = document.getElementById('ppUploadProgressBar');
                if (progressContainer) {
                    progressContainer.style.display = show ? 'block' : 'none';
                    if (!show && progressBar) progressBar.style.width = '0%';
                }
            },

            renderFilePreviews(files) {
                const container = document.getElementById('ppFilePreviews');
                const grid = document.getElementById('ppPreviewGrid');
                if (!container || !grid) return;

                grid.innerHTML = '';
                container.style.display = 'block';

                files.forEach((file, idx) => {
                    const isImage = file.type.startsWith('image/');
                    const preview = document.createElement('div');
                    preview.id = `ppPreview${idx}`;
                    preview.style.cssText = `
                        position:relative;
                        width:80px;
                        height:80px;
                        border-radius:8px;
                        overflow:hidden;
                        background:#f1f5f9;
                        border:2px solid #e2e8f0;
                        opacity:0;
                        transform:scale(0.9);
                        transition:all 0.3s ease;
                    `;

                    if (isImage) {
                        const url = URL.createObjectURL(file);
                        const img = document.createElement('img');
                        img.src = url;
                        img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                        img.onload = () => URL.revokeObjectURL(url);
                        preview.appendChild(img);
                    } else {
                        const icon = document.createElement('div');
                        icon.textContent = 'VID';
                        icon.style.cssText = 'display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:12px;font-weight:900;letter-spacing:0.08em;color:#334155;';
                        preview.appendChild(icon);
                    }

                    grid.appendChild(preview);

                    // Fade in with stagger
                    setTimeout(() => {
                        preview.style.opacity = '1';
                        preview.style.transform = 'scale(1)';
                    }, idx * 50);
                });
            },

            updatePreviewStatus(index, status) {
                const preview = document.getElementById(`ppPreview${index}`);
                if (!preview) return;

                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position:absolute;
                    top:0;
                    left:0;
                    right:0;
                    bottom:0;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    background:rgba(0,0,0,0.6);
                    color:white;
                    font-size:24px;
                    animation:fadeIn 0.2s ease;
                `;
                overlay.textContent = status === 'success' ? 'OK' : 'ERR';
                preview.appendChild(overlay);

                if (status === 'success') {
                    preview.style.borderColor = '#10b981';
                } else {
                    preview.style.borderColor = '#ef4444';
                }
            },

            initFilterControls() {
                // Initialize filter UI and bind events
                const presetEl = document.getElementById('ppFilterPreset');
                const brightnessEl = document.getElementById('ppFilterBrightness');
                const contrastEl = document.getElementById('ppFilterContrast');
                const saturationEl = document.getElementById('ppFilterSaturation');
                
                const brightnessVal = document.getElementById('ppFilterBrightnessVal');
                const contrastVal = document.getElementById('ppFilterContrastVal');
                const saturationVal = document.getElementById('ppFilterSaturationVal');

                // Update value displays
                if (brightnessEl && brightnessVal) {
                    brightnessEl.addEventListener('input', (e) => {
                        brightnessVal.textContent = `${e.target.value}%`;
                        this.updateFilterPreview();
                    });
                }
                
                if (contrastEl && contrastVal) {
                    contrastEl.addEventListener('input', (e) => {
                        contrastVal.textContent = `${e.target.value}%`;
                        this.updateFilterPreview();
                    });
                }
                
                if (saturationEl && saturationVal) {
                    saturationEl.addEventListener('input', (e) => {
                        saturationVal.textContent = `${e.target.value}%`;
                        this.updateFilterPreview();
                    });
                }

                if (presetEl) {
                    presetEl.addEventListener('change', () => {
                        this.applyFilterPreset(presetEl.value);
                        this.updateFilterPreview();
                    });
                }

                // Show filter panel when files selected
                const fileInput = document.getElementById('ppFileInput');
                if (fileInput) {
                    const originalHandler = fileInput.onchange;
                    fileInput.onchange = (e) => {
                        if (originalHandler) originalHandler.call(fileInput, e);
                        this.showQuickFilters(true);
                    };
                }
            },

            applyFilterPreset(preset) {
                const brightnessEl = document.getElementById('ppFilterBrightness');
                const contrastEl = document.getElementById('ppFilterContrast');
                const saturationEl = document.getElementById('ppFilterSaturation');
                const bwEl = document.getElementById('ppFilterBw');

                const brightnessVal = document.getElementById('ppFilterBrightnessVal');
                const contrastVal = document.getElementById('ppFilterContrastVal');
                const saturationVal = document.getElementById('ppFilterSaturationVal');

                // Reset to defaults first
                if (brightnessEl) { brightnessEl.value = 100; brightnessVal.textContent = '100%'; }
                if (contrastEl) { contrastEl.value = 100; contrastVal.textContent = '100%'; }
                if (saturationEl) { saturationEl.value = 100; saturationVal.textContent = '100%'; }
                if (bwEl) bwEl.value = '0';

                // Apply preset
                switch(preset) {
                    case 'bw':
                        if (saturationEl) { saturationEl.value = 0; saturationVal.textContent = '0%'; }
                        if (contrastEl) { contrastEl.value = 110; contrastVal.textContent = '110%'; }
                        if (bwEl) bwEl.value = '1';
                        break;
                    case 'warm':
                        if (contrastEl) { contrastEl.value = 105; contrastVal.textContent = '105%'; }
                        if (saturationEl) { saturationEl.value = 110; saturationVal.textContent = '110%'; }
                        break;
                    case 'cool':
                        if (contrastEl) { contrastEl.value = 105; contrastVal.textContent = '105%'; }
                        if (saturationEl) { saturationEl.value = 95; saturationVal.textContent = '95%'; }
                        break;
                    case 'vibrant':
                        if (contrastEl) { contrastEl.value = 110; contrastVal.textContent = '110%'; }
                        if (saturationEl) { saturationEl.value = 120; saturationVal.textContent = '120%'; }
                        if (brightnessEl) { brightnessEl.value = 105; brightnessVal.textContent = '105%'; }
                        break;
                    case 'muted':
                        if (contrastEl) { contrastEl.value = 95; contrastVal.textContent = '95%'; }
                        if (saturationEl) { saturationEl.value = 85; saturationVal.textContent = '85%'; }
                        if (brightnessEl) { brightnessEl.value = 98; brightnessVal.textContent = '98%'; }
                        break;
                }
            },

            updateFilterPreview() {
                // Apply CSS filters to preview thumbnails in real-time
                const grid = document.getElementById('ppPreviewGrid');
                if (!grid) return;

                const brightness = document.getElementById('ppFilterBrightness')?.value || 100;
                const contrast = document.getElementById('ppFilterContrast')?.value || 100;
                const saturation = document.getElementById('ppFilterSaturation')?.value || 100;

                const filterStr = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
                
                const thumbnails = grid.querySelectorAll('[id^=\"ppPreview\"]');
                thumbnails.forEach(thumb => {
                    const img = thumb.querySelector('img');
                    if (img) img.style.filter = filterStr;
                });

                // Store values for upload
                document.getElementById('ppFilterBrightnessVal').value = brightness;
                document.getElementById('ppFilterContrastVal').value = contrast;
                document.getElementById('ppFilterSaturationVal').value = saturation;
            },

            resetFilters() {
                const presetEl = document.getElementById('ppFilterPreset');
                if (presetEl) presetEl.value = 'none';
                this.applyFilterPreset('none');
                this.updateFilterPreview();
            },

            showQuickFilters(show) {
                const panel = document.getElementById('ppQuickFilters');
                if (panel) {
                    panel.style.display = show ? 'block' : 'none';
                }
            },

            getSelectedPack() {
                // No more pack selection UI - always use a default pack
                // Backend expects pack_id and week_of, so provide defaults
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                
                // Try to find existing pack or create default structure
                if (this.state.packs && this.state.packs.length > 0) {
                    // Use first pack if exists
                    return this.state.packs[0];
                }
                
                // Return minimal pack structure for backend compatibility
                return {
                    pack_id: 'default',
                    week_of: this.getCurrentWeekOf(),
                    title: service,
                    service: service,
                };
            },
            
            getCurrentWeekOf() {
                // Return current week in YYYY-MM-DD format (Monday of current week)
                const now = new Date();
                const day = now.getDay();
                const diff = day === 0 ? -6 : 1 - day; // Adjust to Monday
                const monday = new Date(now);
                monday.setDate(now.getDate() + diff);
                return monday.toISOString().split('T')[0];
            },

            effectiveMediaKind() {
                const forced = document.getElementById('ppForceKind')?.value || '';
                if (forced === 'photo' || forced === 'video') return forced;
                if (this.state.analysis?.media_kind) return this.state.analysis.media_kind;
                if (this.state.file?.type?.startsWith('video/')) return 'video';
                return 'photo';
            },

            recommendSlots() {
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                const shot = document.getElementById('ppShotType')?.value || '';
                const tod = document.getElementById('ppTimeOfDay')?.value || '';
                const media_kind = this.effectiveMediaKind();

                const shotLower = String(shot || '').toLowerCase();
                const isPov = shotLower.includes('pov') || shotLower.includes('view');
                const isMotion = shotLower.includes('motion') || shotLower.includes('track');
                const isAfter = shotLower.includes('after') || shotLower.includes('finish') || shotLower.includes('clean');
                const isBefore = shotLower.includes('before');
                const isDuring = shotLower.includes('during') || shotLower.includes('progress');
                const isConceal = shotLower.includes('conceal') || shotLower.includes('wire');
                const isStud = shotLower.includes('stud') || shotLower.includes('level') || shotLower.includes('secure');
                const isWeather = shotLower.includes('weather') || shotLower.includes('exterior');

                const duration = this.state.analysis?.duration_seconds;
                const fileSizeKb = Number(this.state.analysis?.file_size_kb || Math.round((this.state.file?.size || 0) / 1024));
                const width = Number(this.state.analysis?.width_px || 0);
                const height = Number(this.state.analysis?.height_px || 0);
                const warnings = [];
                const reasons = [];
                let heroOk = true;
                let confidence = 'medium';

                // Global quality guardrails (honest + practical)
                if (Number.isFinite(fileSizeKb) && fileSizeKb > 30000) {
                    warnings.push('Large file: consider compressing (faster load on the bundles page).');
                }
                if (Number.isFinite(fileSizeKb) && fileSizeKb > 60000) {
                    warnings.push('Very large file: upload may be slow; consider trimming/compressing.');
                }

                if (width && height) {
                    const minSide = Math.min(width, height);
                    if (minSide < 720) {
                        const dims = (width && height) ? ` (${width}x${height})` : '';
                        warnings.push(`Lower resolution${dims}: may look a bit soft if shown large (usually fine for small tiles). If it looks distorted, re-export/upload a higher-res copy.`);
                    }

                    const ratio = width / height;
                    if (ratio < 0.70) warnings.push('Very tall framing: the top banner may crop this.');
                    if (ratio > 2.20) warnings.push('Very wide framing: the top banner may crop this.');
                }

                if (media_kind === 'video') {
                    if (typeof duration === 'number' && duration > 15) heroOk = false;
                    if (!Number.isFinite(duration)) warnings.push('Video duration unknown; avoid hero unless you verify it is short.');
                    if (typeof duration === 'number' && duration <= 12) reasons.push('Short videos work well in high-visibility placements.');
                    if (typeof duration === 'number' && duration > 15) reasons.push('Longer videos are better lower on the page.');

                    if (typeof duration === 'number' && duration > 30) {
                        warnings.push('Recommended: keep videos short (about 6-12 seconds). Consider trimming this.');
                    }
                    if (typeof duration === 'number' && duration < 2) {
                        warnings.push('Very short clip: make sure it clearly shows the install/result.');
                    }
                    if (this.getConvertToMp4Preference()) {
                        reasons.push('Videos are converted to MP4 on upload for reliable playback.');
                    }
                } else {
                    // Photos
                    if (width && height) {
                        const minSide = Math.min(width, height);
                        if (minSide < 900) warnings.push('Recommended: upload higher-res photos when possible (sharper on large screens).');
                    }
                }

                if (service === 'cameras' && (tod === 'night' || isPov)) {
                    heroOk = false;
                    reasons.push('We avoid the top banner for night footage and POV clips.');
                }

                if (!shot) warnings.push('Select a proof type for best slot guidance.');
                if (!tod) warnings.push('Lighting not set; defaulting is recommended.');

                if (!shot) confidence = 'low';
                else if (shot && tod) confidence = 'high';
                else confidence = 'medium';

                const recommended = [];
                // Explainable, service-aware heuristics (non-AI).
                if (service === 'tv_mounting') {
                    if (isConceal) {
                        recommended.push('pre_cta');
                        reasons.push('Wire conceal details convert best near checkout.');
                    }
                    if (isStud) {
                        recommended.push('mid_proof_rail');
                        reasons.push('Stud/level proof supports quality mid-page.');
                    }
                    if (isBefore || isDuring) {
                        recommended.push('mid_proof_rail');
                        reasons.push('Before/during shots are supportive proof; keep them mid-page.');
                    }
                    if (heroOk && isAfter) {
                        recommended.unshift('hero');
                        reasons.push('Clean finished installs earn trust immediately; best at the top.');
                    }
                } else {
                    // cameras
                    if (isMotion) {
                        recommended.push('pre_cta');
                        reasons.push('Motion tracking is premium proof; place it near checkout.');
                    }
                    if (isPov) {
                        recommended.push('pre_cta');
                        reasons.push('POV clips convert best closer to the decision point.');
                    }
                    if (service === 'cameras' && tod === 'night') {
                        recommended.push('pre_cta');
                        reasons.push('Night footage performs better lower on the page.');
                    }
                    if (isWeather) {
                        recommended.push('mid_proof_rail');
                        reasons.push('Exterior/weather-seal proof reads well mid-page.');
                    }
                    if (heroOk && isAfter) {
                        recommended.unshift('hero');
                        reasons.push('Finished installs can work in the top banner.');
                    }
                }

                // default recs
                recommended.push('mid_proof_rail');
                if (isPov || isMotion) recommended.unshift('pre_cta');

                // allowed: keep hero optional but warn if not ok
                const allowed = heroOk ? ['hero', 'mid_proof_rail', 'pre_cta'] : ['mid_proof_rail', 'pre_cta'];

                return {
                    allowed,
                    recommended: [...new Set(recommended)],
                    heroOk,
                    warnings,
                    reasons: [...new Set(reasons)].slice(0, 4),
                    confidence,
                };
            },

            updateAdvice() {
                const adviceEl = document.getElementById('ppSlotAdvice');
                const warnEl = document.getElementById('ppUploadWarning');
                const slotEl = document.getElementById('ppSlotKey');

                const hasFile = !!this.state.file;
                if (!hasFile) {
                    if (adviceEl) adviceEl.textContent = 'Upload a file to get a suggested placement.';
                    if (warnEl) warnEl.textContent = '';
                    return;
                }

                const rec = this.recommendSlots();
                const chosen = slotEl?.value || '';

                if (adviceEl) {
                    const labels = (rec.recommended.length ? rec.recommended : ['mid_proof_rail', 'pre_cta']).map(k => this.slotLabel(k));
                    const primary = labels[0] || 'Mid-page proof rail';
                    const rest = labels.slice(1);

                    const why = [];
                    if (Array.isArray(rec.reasons) && rec.reasons.length) why.push(...rec.reasons);
                    if (!rec.heroOk) why.push('We avoid the top banner for this file/context.');
                    const whyText = why.length ? ` Reason: ${why.join(' ')}` : '';
                    const conf = rec.confidence ? ` Confidence: ${rec.confidence}.` : '';

                    adviceEl.textContent = `Suggested: ${primary}${rest.length ? ` (also ok: ${rest.join(', ')})` : ''}.${conf}${whyText}`;
                }

                const warningBits = [];
                rec.warnings.forEach(w => warningBits.push(w));
                if (chosen && !rec.allowed.includes(chosen)) {
                    warningBits.push(`"${this.slotLabel(chosen)}" is not recommended for this file/context.`);
                }
                if (warnEl) {
                    warnEl.innerHTML = warningBits.length
                        ? `<span class="warning-text">${this.escapeHtml(warningBits.join(' '))}</span>`
                        : '';
                }
            },

            async uploadAndAssign() {
                const file = this.state.file;
                if (!file) {
                    showToast('Select a file first', 'error');
                    return;
                }

                const intent = (document.getElementById('ppIntent')?.value || '').trim();
                if (!intent) {
                    showToast('Pick a proof type (Result / Action / Working Shot) before uploading', 'error');
                    return;
                }
                
                await this.uploadAndAssignInternal();
            },
            
            async uploadAndAssignInternal() {
                const statusEl = document.getElementById('ppUploadStatus');
                const warnEl = document.getElementById('ppUploadWarning');
                const service = document.getElementById('ppService')?.value || '';
                const surface = document.getElementById('ppSurface')?.value || 'bundles';
                const pack = this.getSelectedPack(); // Now always returns a pack

                const file = this.state.file;
                if (!file) {
                    throw new Error('No file selected');
                }

                let shot_type = document.getElementById('ppShotType')?.value || '';
                let time_of_day = document.getElementById('ppTimeOfDay')?.value || '';
                let slot_key = document.getElementById('ppSlotKey')?.value || '';

                // Make intent operational for single uploads: auto-pick the placement slot.
                // - working_shot: near CTA (human/crew builds trust at decision point)
                // - action_proof: mid-page proof rail (process)
                // - result_proof: hero (strongest outcome)
                const globalIntent = (document.getElementById('ppIntent')?.value || '').trim();
                if (globalIntent) {
                    if (globalIntent === 'working_shot') slot_key = 'pre_cta';
                    else if (globalIntent === 'action_proof') slot_key = 'mid_proof_rail';
                    else if (globalIntent === 'result_proof') slot_key = 'hero';
                    const slotEl = document.getElementById('ppSlotKey');
                    if (slotEl) slotEl.value = slot_key;
                }

                if (!shot_type) {
                    // Keep it low-friction: default a reasonable type so upload remains one-step.
                    // Default: cameras -> 'mount', TV mounting -> 'after' (cleanest finished work)
                    shot_type = (service === 'cameras') ? 'mount' : 'after';
                    const shotEl = document.getElementById('ppShotType');
                    if (shotEl) shotEl.value = shot_type;
                    if (warnEl) {
                        const types = service === 'cameras' 
                            ? 'mount, pov_view, motion_track, night_vision' 
                            : 'after, during, before, wire_conceal, stud_secure';
                        warnEl.innerHTML = `<span class="warning-text">Shot type auto-selected: "${this.escapeHtml(shot_type)}". Change for better placement: ${this.escapeHtml(types)}</span>`;
                    }
                }

                // Default lighting + slot if user didn't touch them.
                // Use EXIF-detected time_of_day if available
                if (!time_of_day) {
                    const exifTimeOfDay = this.state.analysis?.exif_time_of_day;
                    if (exifTimeOfDay === 'day' || exifTimeOfDay === 'night') {
                        time_of_day = exifTimeOfDay;
                        console.log(`[ProofPacks] Using EXIF-detected time_of_day: ${time_of_day}`);
                    } else {
                        time_of_day = 'day';
                    }
                    const todEl = document.getElementById('ppTimeOfDay');
                    if (todEl) todEl.value = time_of_day;
                }
                if (!slot_key) {
                    const rec0 = this.recommendSlots()?.recommended?.[0] || 'mid_proof_rail';
                    slot_key = rec0;
                    const slotEl = document.getElementById('ppSlotKey');
                    if (slotEl) slotEl.value = slot_key;
                }

                const rec = this.recommendSlots();
                if (!rec.allowed.includes(slot_key)) {
                    const proceed = confirm(`"${this.slotLabel(slot_key)}" is not recommended for this file/context. Proceed anyway?`);
                    if (!proceed) return;
                }

                if (statusEl) statusEl.textContent = 'Uploading...';
                if (warnEl) warnEl.textContent = '';

                const analysis = this.state.analysis || { file_size_kb: Math.round((file.size || 0) / 1024) };
                const media_kind = this.effectiveMediaKind();

                // Hard guardrails: allow but force an explicit confirmation.
                const hard = [];
                const fileSizeKb = Number(analysis.file_size_kb || Math.round((file.size || 0) / 1024));
                if (Number.isFinite(fileSizeKb) && fileSizeKb > 60000) {
                    hard.push(`File is very large (${Math.round(fileSizeKb / 1024)} MB).`);
                }
                if (media_kind === 'video') {
                    const dur = analysis.duration_seconds;
                    if (typeof dur === 'number' && dur > 60) {
                        hard.push(`Video is long (${dur.toFixed(1)}s). Recommended is ~6-12s.`);
                    }
                }
                if (hard.length) {
                    const ok = confirm(`${hard.join('\n')}\n\nUpload anyway?`);
                    if (!ok) {
                        if (warnEl) warnEl.innerHTML = `<span class="warning-text">Upload canceled. Consider trimming/compressing first.</span>`;
                        return;
                    }
                }

                try {
                    const rotateDeg = this.getRotateDegPreference();
                    const trimStartSec = this.getTrimStartSecPreference();
                    const trimEndSec = this.getTrimEndSecPreference();
                    this.safeSetItem(this.storageKeys.trimStartSec, trimStartSec);
                    this.safeSetItem(this.storageKeys.trimEndSec, trimEndSec);

                    const tv = this.validateTrimWindow({ media_kind, duration_seconds: analysis.duration_seconds });
                    if (!tv?.ok) {
                        if (statusEl) statusEl.textContent = 'Fix trim window.';
                        showToast(String(tv?.error || 'Invalid trim window'), 'error');
                        return;
                    }

                    // Rotation requires re-encode; force MP4 so output is predictable.
                    const convertToMp4 = (rotateDeg !== '0' || !!trimStartSec || !!trimEndSec || this.getConvertToMp4Preference()) ? '1' : '0';

                    // Vercel serverless has a strict request payload limit; large uploads are rejected
                    // BEFORE our API route runs (which looks like a CORS error in the browser).
                    // Use a staged upload for larger files:
                    // 1) request signed upload URL (small JSON)
                    // 2) PUT file directly to Supabase Storage
                    // 3) finalize: backend downloads, converts (optional), stores final asset, deletes raw
                    const payloadLimitBytes = 4 * 1024 * 1024; // keep headroom under Vercel limit
                    const shouldStage = (media_kind === 'video') || ((file?.size || 0) > payloadLimitBytes);

                    let upload;
                    if (shouldStage) {
                        if (statusEl) statusEl.textContent = 'Uploading (staged)...';
                        let init;
                        try {
                            init = await this.fetchJson('/api/admin/proof-upload-init', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    surface,
                                    service,
                                    week_of: pack.week_of || '',
                                    bucket: 'proof',
                                    filename: file?.name || 'upload',
                                    mime: file?.type || '',
                                    media_kind,
                                    convert_to_mp4: convertToMp4,
                                    rotate_deg: rotateDeg,
                                    trim_start_sec: trimStartSec || undefined,
                                    trim_end_sec: trimEndSec || undefined,
                                }),
                            });
                        } catch (e) {
                            const status = Number(e?.status || 0);
                            const { base } = this.getConfig();
                            if (status === 404 || status === 405) {
                                throw new Error(
                                    `Backend does not support staged uploads yet (status ${status}). ` +
                                    `Current Backend URL: ${base}. Use your Vercel preview backend URL and click Save.`,
                                );
                            }
                            throw e;
                        }

                        if (!init?.ok || !init?.signed_url || !init?.raw_path) {
                            throw new Error('Staged upload init failed');
                        }

                        if (statusEl) statusEl.textContent = 'Uploading to storage...';
                        // IMPORTANT: Supabase signed upload expects raw bytes, not multipart/form-data.
                        // Using FormData here can cause the upload to silently fail or store invalid content.
                        const putRes = await fetch(String(init.signed_url), {
                            method: 'PUT',
                            headers: { 'Content-Type': file?.type || 'application/octet-stream' },
                            body: file,
                        });
                        if (!putRes.ok) {
                            const t = await putRes.text().catch(() => '');
                            const err = new Error(`Staged upload failed (HTTP ${putRes.status})${t ? `: ${t}` : ''}`);
                            err.status = putRes.status;
                            throw err;
                        }

                        if (statusEl) statusEl.textContent = 'Finalizing (convert/store)...';
                        upload = await this.fetchJson('/api/admin/proof-upload-finalize', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bucket: 'proof',
                                raw_path: init.raw_path,
                                filename: file?.name || 'upload',
                                mime: file?.type || '',
                                surface,
                                service,
                                week_of: pack.week_of || '',
                                media_kind,
                                convert_to_mp4: convertToMp4,
                                rotate_deg: rotateDeg,
                                trim_start_sec: trimStartSec || undefined,
                                trim_end_sec: trimEndSec || undefined,
                            }),
                        });
                    } else {
                        const fd = new FormData();
                        fd.append('file', file);
                        fd.append('surface', surface);
                        fd.append('service', service);
                        fd.append('week_of', pack.week_of || '');
                        fd.append('bucket', 'proof');
                        fd.append('convert_to_mp4', convertToMp4);
                        fd.append('rotate_deg', rotateDeg);
                        if (trimStartSec) fd.append('trim_start_sec', trimStartSec);
                        if (trimEndSec) fd.append('trim_end_sec', trimEndSec);

                        upload = await this.fetchJson('/api/admin/proof-upload', {
                            method: 'POST',
                            body: fd,
                        });
                    }

                    // Make it unmistakable what we stored vs what we selected locally.
                    const summary = document.getElementById('ppFileSummary');
                    if (summary) {
                        this.setHidden(summary, false);
                        const srcName = this.escapeHtml(String(file?.name || 'upload'));
                        const srcMime = this.escapeHtml(String(file?.type || this.state.analysis?.mime || 'unknown'));
                        const storedMime = this.escapeHtml(String(upload?.content_type || 'unknown'));
                        const storedPath = this.escapeHtml(String(upload?.path || ''));
                        const converted = !!upload?.converted_to_mp4;
                        const receivedFlag = String(upload?.received_convert_to_mp4);

                        const bits = [];
                        bits.push(`<div><strong>Selected:</strong> ${srcName}</div>`);
                        bits.push(`<div><strong>Selected type:</strong> ${srcMime}</div>`);
                        if (storedPath) bits.push(`<div class="u-mt-1"><strong>Stored as:</strong> ${storedPath}</div>`);
                        bits.push(`<div><strong>Stored type:</strong> ${storedMime}</div>`);
                        if (converted) bits.push(`<div class="u-text-sm u-muted u-mt-1">Converted to MP4 on the server.</div>`);
                        if (!converted && receivedFlag === 'true' && /video\//i.test(String(file?.type || ''))) {
                            bits.push(`<div class="u-text-sm u-muted u-mt-1">MP4 conversion was requested; file was already MP4 or conversion was not needed.</div>`);
                        }
                        summary.innerHTML = bits.join('');
                    }

                    if (warnEl && Array.isArray(upload?.warnings) && upload.warnings.length) {
                        warnEl.innerHTML = `<span class="warning-text">${this.escapeHtml(upload.warnings.join(' '))}</span>`;
                    }

                    const intentMeta = this.state.file?._intentMeta || {};
                    const assetPayload = {
                        pack_id: pack.pack_id,
                        service,
                        media_kind,
                        shot_type,
                        time_of_day,
                        storage_bucket: upload.bucket,
                        storage_path: upload.path,
                        content_type: upload.content_type || file.type || null,
                        file_size_kb: upload.file_size_kb || analysis.file_size_kb || Math.round((file.size || 0) / 1024) || null,
                        width_px: analysis.width_px || null,
                        height_px: analysis.height_px || null,
                        duration_seconds: analysis.duration_seconds || null,
                        // -- Asset Intent (Jan 2026) --
                        customer_intent: intentMeta.customer_intent || globalIntent || 'result_proof',
                        frontend_destinations: intentMeta.frontend_destinations || ['bundles_carousel'],
                        psychological_weight: (intentMeta.psychological_weight ? Number(intentMeta.psychological_weight) * 10 : 50),
                        // -- Video thumbnail --
                        thumbnail_storage_path: upload.thumbnail_storage_path || null,
                    };

                    const created = await this.fetchJson('/api/admin/proof-assets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(assetPayload),
                    });

                    const assetId = created?.asset?.asset_id || created?.asset_id;
                    if (!assetId) throw new Error('Asset creation failed');

                    // Slot assignment strategy:
                    // - hero: pin a single best asset (asset_id)
                    // - mid_proof_rail / pre_cta: point slot to the pack so multiple assets can rotate in
                    const usePackForSlot = (slot_key === 'mid_proof_rail' || slot_key === 'pre_cta');
                    await this.fetchJson('/api/admin/proof-slots', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            surface,
                            service,
                            slot_key,
                            ...(usePackForSlot ? { pack_id: pack.pack_id } : { asset_id: assetId }),
                        }),
                    });

                    if (statusEl) statusEl.textContent = 'Done.';
                    showToast('Uploaded + assigned', 'success');
                    this.refreshCoverage();
                    this.refreshAssets();
                } catch (e) {
                    console.error(e);
                    if (statusEl) statusEl.textContent = 'Failed.';
                    const msg = String(e?.message || 'Upload failed');
                    const status = Number(e?.status || 0);
                    if (status === 413) {
                        showToast('Upload failed: video too large/complex to convert in time. Try a shorter clip or lower resolution.', 'error');
                    } else if (status === 504 || /timeout/i.test(msg)) {
                        showToast('Upload failed: conversion is taking too long. Try a shorter clip or lower resolution.', 'error');
                    } else {
                        showToast(`Upload failed: ${msg}`, 'error');
                    }
                }
            },

            async createPack() {
                const status = document.getElementById('ppConnStatus');
                const service = document.getElementById('ppService')?.value || 'tv_mounting';
                const surface = document.getElementById('ppSurface')?.value || 'bundles';
                const weekEl = document.getElementById('ppWeekOf');
                let weekOf = weekEl?.value || '';
                const title = (document.getElementById('ppPackTitle')?.value || '').trim();

                if (!weekOf) {
                    weekOf = this.nextMondayYmd();
                    if (weekEl) weekEl.value = weekOf;
                }

                try {
                    if (status) status.textContent = 'Creating pack...';
                    const resp = await this.fetchJson('/api/admin/proof-packs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            surface,
                            service,
                            week_of: weekOf,
                            title: title || null,
                            status: 'draft',
                        }),
                    });

                    const newPackId = resp?.pack?.pack_id;
                    await this.refresh();
                    if (newPackId) {
                        const packSelect = document.getElementById('ppPackSelect');
                        if (packSelect) packSelect.value = newPackId;
                    }

                    this.refreshCoverage();
                    this.refreshAssets();

                    if (status) status.textContent = 'Ready.';
                    showToast('Pack created', 'success');
                } catch (e) {
                    console.error(e);
                    if (status) status.textContent = 'Pack create failed.';
                    showToast(`Create pack failed: ${e.message}`, 'error');
                }
            },

            getActivePreviewElements() {
                // Editor stage media (main preview)
                const stageMedia = document.getElementById('ppEditorVideo')
                    || document.getElementById('ppVideoPreview')
                    || document.getElementById('ppLocalPreviewVideo');

                // Live preview media (right-side frame)
                const liveMedia = document.getElementById('ppPreviewMedia');
                const liveFrame = document.getElementById('ppLivePreviewFrame')
                    || document.querySelector('.pp-preview-frame');

                return { stageMedia, liveMedia, liveFrame };
            },

            normalizeCropMode(mode) {
                const m = String(mode || '').toLowerCase();
                if (m === 'fill') return 'cover';
                if (m === 'fit') return 'contain';
                if (m === 'cover' || m === 'contain' || m === 'manual') return m;
                return 'cover';
            },

            normalizeObjectPosition(pos) {
                const raw = String(pos || '').trim().toLowerCase();
                if (!raw || raw === 'center') return '50% 50%';

                const clampPct = (n) => {
                    const v = Number(n);
                    if (!Number.isFinite(v)) return 50;
                    return Math.max(0, Math.min(100, Math.round(v)));
                };

                const parseToken = (tok, axis) => {
                    const t = String(tok || '').trim().toLowerCase();
                    if (!t) return null;
                    if (t.endsWith('%')) return clampPct(parseFloat(t));
                    if (axis === 'x') {
                        if (t === 'left') return 0;
                        if (t === 'center') return 50;
                        if (t === 'right') return 100;
                    }
                    if (axis === 'y') {
                        if (t === 'top') return 0;
                        if (t === 'center') return 50;
                        if (t === 'bottom') return 100;
                    }
                    return null;
                };

                const parts = raw.split(/\s+/).filter(Boolean);
                if (parts.length === 1) {
                    const x = parseToken(parts[0], 'x');
                    const y = parseToken(parts[0], 'y');
                    if (x !== null) return `${x}% 50%`;
                    if (y !== null) return `50% ${y}%`;
                    return '50% 50%';
                }

                const x = parseToken(parts[0], 'x');
                const y = parseToken(parts[1], 'y');
                return `${(x !== null ? x : 50)}% ${(y !== null ? y : 50)}%`;
            },

            setCropMode(mode, btn) {
                const normalizedMode = this.normalizeCropMode(mode);
                const { stageMedia, liveMedia } = this.getActivePreviewElements();
                if (!stageMedia && !liveMedia) return;

                this.state = this.state || {};
                this.state.cropping = this.state.cropping || {};
                this.state.cropping.mode = normalizedMode;

                // Update UI buttons (use data-mode + passed button, avoid fragile onclick selectors)
                document.querySelectorAll('.crop-mode-btn').forEach(b => {
                    const bMode = this.normalizeCropMode(b.getAttribute('data-mode'));
                    if (b === btn || bMode === normalizedMode) b.classList.add('active');
                    else b.classList.remove('active');
                });

                const objectFit = normalizedMode === 'contain' ? 'contain' : 'cover';
                if (stageMedia) stageMedia.style.objectFit = objectFit;
                if (liveMedia) liveMedia.style.objectFit = objectFit;

                // Keep live preview overlay in sync if available
                if (typeof this.updatePreviewContext === 'function') {
                    this.updatePreviewContext(this.state.previewContext);
                }

                // Update stage hint + drag behaviors (cover/contain = reframe focal, manual = pan)
                if (typeof this.updateStageDragHint === 'function') {
                    this.updateStageDragHint();
                }

                // Drag behavior:
                // - cover/contain: drag to set focal point (crosshair shown)
                // - manual: drag to pan (crosshair hidden)
                if (typeof this.toggleCrosshair === 'function') {
                    this.toggleCrosshair(normalizedMode !== 'manual');
                }

                if (normalizedMode === 'manual') {
                    this.showToast('Custom crop: drag to position', 'info');
                }
            },

            setFocalPoint(pos, btn) {
                const { stageMedia, liveMedia } = this.getActivePreviewElements();
                if (!stageMedia && !liveMedia) return;

                const map = {
                    'top-left': '0% 0%',    'top-center': '50% 0%',    'top-right': '100% 0%',
                    'center-left': '0% 50%','center': '50% 50%',       'center-right': '100% 50%',
                    'bottom-left': '0% 100%','bottom-center': '50% 100%','bottom-right': '100% 100%',
                    // Legacy maps for safety
                    'mid-left': '0% 50%',   'mid-right': '100% 50%',
                    'btm-left': '0% 100%',  'btm-center': '50% 100%',  'btm-right': '100% 100%'
                };

                const objectPos = map[pos] || '50% 50%';
                const [xStr, yStr] = objectPos.split(' ');
                const xVal = parseInt(xStr) || 50;
                const yVal = parseInt(yStr) || 50;

                this.state = this.state || {};
                this.state.cropping = this.state.cropping || {};
                this.state.cropping.focalPoint = pos;

                this.applyFocalPercent(xVal, yVal);
                
                // Update UI Buttons
                document.querySelectorAll('.focal-point-btn').forEach(b => {
                     // Check matching data-pos OR matching click handler (legacy)
                     const bPos = b.getAttribute('data-pos');
                     if (b === btn || bPos === pos) {
                         b.classList.add('active');
                     } else {
                         b.classList.remove('active');
                     }
                });

                // applyFocalPercent updates inputs + crosshair

                // Keep live preview overlay in sync if available
                if (typeof this.updatePreviewContext === 'function') {
                    this.updatePreviewContext(this.state.previewContext);
                }
            },

            updateFocalFromInput() {
                const { stageMedia, liveMedia } = this.getActivePreviewElements();
                const inpX = document.getElementById('ppFocalX');
                const inpY = document.getElementById('ppFocalY');
                if ((!stageMedia && !liveMedia) || !inpX || !inpY) return;

                const x = Math.max(0, Math.min(100, Number(inpX.value)));
                const y = Math.max(0, Math.min(100, Number(inpY.value)));
                this.applyFocalPercent(x, y);
                
                // Clear grid selection since we are in potentially custom coordinates
                document.querySelectorAll('.focal-point-btn').forEach(b => b.classList.remove('active'));

                // Keep live preview overlay in sync if available
                if (typeof this.updatePreviewContext === 'function') {
                    this.updatePreviewContext(this.state.previewContext);
                }
            },

            applyFocalPercent(xPctRaw, yPctRaw) {
                const { stageMedia, liveMedia } = this.getActivePreviewElements();
                if (!stageMedia && !liveMedia) return;

                const xPct = Math.max(0, Math.min(100, Math.round(Number(xPctRaw))));
                const yPct = Math.max(0, Math.min(100, Math.round(Number(yPctRaw))));
                const posStr = `${xPct}% ${yPct}%`;

                if (stageMedia) stageMedia.style.objectPosition = posStr;
                if (liveMedia) liveMedia.style.objectPosition = posStr;

                this.state = this.state || {};
                this.state.cropping = this.state.cropping || {};
                this.state.cropping.objectPosition = posStr;

                const inpX = document.getElementById('ppFocalX');
                const inpY = document.getElementById('ppFocalY');
                if (inpX) inpX.value = String(xPct);
                if (inpY) inpY.value = String(yPct);

                this.updateCrosshairPosition(xPct, yPct);
            },

            toggleCrosshair(show) {
                const { stageMedia, liveMedia } = this.getActivePreviewElements();
                const liveFrame = document.getElementById('ppLivePreviewFrame') || document.querySelector('.pp-preview-frame');
                const stageContainer = stageMedia ? (stageMedia.closest('.pp-video-stage') || stageMedia.parentElement) : null;
                if (!stageContainer && !liveFrame) return;

                const ensureCrosshair = (container) => {
                    if (!container) return null;
                    let crosshair = container.querySelector('.focal-crosshair');
                    if (!crosshair) {
                        crosshair = document.createElement('div');
                        crosshair.className = 'focal-crosshair';
                        if (getComputedStyle(container).position === 'static') container.style.position = 'relative';
                        container.appendChild(crosshair);
                    }
                    const currentPos = stageMedia.style.objectPosition
                        || (liveMedia && liveMedia.style.objectPosition)
                        || this.state?.cropping?.objectPosition
                        || '50% 50%';
                    const [xStr, yStr] = String(currentPos).split(' ');
                    const xVal = parseInt(xStr) || 50;
                    const yVal = parseInt(yStr) || 50;
                    crosshair.style.left = `${xVal}%`;
                    crosshair.style.top = `${yVal}%`;
                    return crosshair;
                };

                if (show) {
                    const stageCross = ensureCrosshair(stageContainer);
                    const liveCross = ensureCrosshair(liveFrame);
                    if (stageCross) this.initCrosshairDraggable(stageCross, stageContainer, stageMedia, liveMedia);
                    if (liveCross) this.initCrosshairDraggable(liveCross, liveFrame, stageMedia, liveMedia);
                } else {
                    if (stageContainer) stageContainer.querySelectorAll('.focal-crosshair').forEach(el => el.remove());
                    if (liveFrame) liveFrame.querySelectorAll('.focal-crosshair').forEach(el => el.remove());
                }
            },

            updateCrosshairPosition(xPct, yPct) {
                const { stageMedia } = this.getActivePreviewElements();
                if (!stageMedia) return;
                const stageContainer = stageMedia.closest('.pp-video-stage') || stageMedia.parentElement;
                const liveFrame = document.getElementById('ppLivePreviewFrame') || document.querySelector('.pp-preview-frame');
                if (stageContainer) {
                    const crosshair = stageContainer.querySelector('.focal-crosshair');
                    if (crosshair) {
                        crosshair.style.left = `${xPct}%`;
                        crosshair.style.top = `${yPct}%`;
                    }
                }
                if (liveFrame) {
                    const crosshair = liveFrame.querySelector('.focal-crosshair');
                    if (crosshair) {
                        crosshair.style.left = `${xPct}%`;
                        crosshair.style.top = `${yPct}%`;
                    }
                }
            },

            initCrosshairDraggable(el, container, stageMedia, liveMedia) {
                let isDragging = false;
                const onMove = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    
                    const rect = container.getBoundingClientRect();
                    const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                    // Calculate position relative to container
                    let newX = clientX - rect.left;
                    let newY = clientY - rect.top;

                    // Clamping
                    newX = Math.max(0, Math.min(newX, rect.width));
                    newY = Math.max(0, Math.min(newY, rect.height));

                    const pctX = Math.round((newX / rect.width) * 100);
                    const pctY = Math.round((newY / rect.height) * 100);

                    el.style.left = `${pctX}%`;
                    el.style.top = `${pctY}%`;
                    
                    this.applyFocalPercent(pctX, pctY);
                    
                    // Clear grid
                    document.querySelectorAll('.focal-point-btn').forEach(b => b.classList.remove('active'));
                    
                    // Update state
                    // applyFocalPercent updates state
                };

                const onEnd = () => {
                    isDragging = false;
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                    document.removeEventListener('touchmove', onMove);
                    document.removeEventListener('touchend', onEnd);
                };

                const onStart = (e) => {
                    isDragging = true;
                    // e.preventDefault(); // allow focus interactions elsewhere if needed
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onEnd);
                    document.addEventListener('touchmove', onMove);
                    document.addEventListener('touchend', onEnd);
                };

                el.addEventListener('mousedown', onStart);
                el.addEventListener('touchstart', onStart);
            },

            updateStageDragHint() {
                const hint = document.getElementById('ppStageDragHint');
                if (!hint) return;
                const mode = this.normalizeCropMode(this.state?.cropping?.mode);
                hint.textContent = (mode === 'manual') ? 'Drag to position' : 'Drag to reframe';
            },

            updatePreviewContext(contextName) {
                this.state = this.state || {};
                if (contextName) {
                    this.state.previewContext = contextName;
                } else {
                    contextName = this.state.previewContext || 'proof_rail';
                }

                const frame = document.getElementById('ppLivePreviewFrame') || document.querySelector('.pp-preview-frame');
                if (!frame) return;

                const previewSel = document.getElementById('ppPreviewContext');
                if (previewSel) previewSel.value = contextName;
                
                // Update help text based on context
                const helpText = document.getElementById('ppPreviewContextHelp');
                const helpTexts = {
                    proof_rail: 'Shows in customer-facing proof rail tiles (most important)',
                    hero: 'Large banner image at top of bundle detail page',
                    gallery: 'Square photo grid in gallery view',
                    carousel: 'Full-width homepage carousel slides'
                };
                if (helpText) {
                    helpText.textContent = helpTexts[contextName] || helpTexts.proof_rail;
                }

                const contexts = {
                    proof_rail: { label: 'Proof Rail', ratio: '4 / 3', dims: '160x120', width: '160px', height: '120px' },
                    hero: { label: 'Bundle Hero', ratio: '2 / 1', dims: '1200x600', width: '400px', height: '200px' },
                    gallery: { label: 'Gallery', ratio: '1 / 1', dims: '400x400', width: '300px', height: '300px' },
                    grid: { label: 'Grid', ratio: '1 / 1', dims: '400x400', width: '300px', height: '300px' },
                    carousel: { label: 'Homepage Carousel', ratio: '16 / 9', dims: '1920x1080', width: '400px', height: '225px' }
                };

                const ctx = contexts[contextName] || contexts.proof_rail;
                
                // For proof_rail, use exact frontend dimensions
                if (contextName === 'proof_rail') {
                    frame.style.width = ctx.width;
                    frame.style.height = ctx.height;
                    frame.style.aspectRatio = '';
                } else {
                    frame.style.width = ctx.width;
                    frame.style.height = ctx.height;
                    frame.style.aspectRatio = '';
                }
                
                frame.dataset.ratio = ctx.ratio.replace(/\s*/g, '').replace('/', ':');

                // Sync media styling with current crop state - APPLY ALL FRONTEND TRANSFORMS
                const media = document.getElementById('ppPreviewMedia');
                if (media && this.state) {
                    // Get all the same transform logic from buildProofMediaStyle
                    const rotateBase = Number(this.state?.video_rotate_deg || 0);
                    const rotateDeg = (rotateBase === 90 || rotateBase === 180 || rotateBase === 270) ? rotateBase : 0;
                    
                    const cropMode = this.normalizeCropMode(this.state?.cropping?.mode);
                    const objectFit = cropMode === 'contain' ? 'contain' : 'cover';
                    const objectPosition = this.state?.cropping?.objectPosition || '50% 50%';
                    
                    const geom = this.state?.cropping?.geometry || {};
                    const panX = this.clampNumber(geom?.pan_x_pct ?? 0, -50, 50, 0);
                    const panY = this.clampNumber(geom?.pan_y_pct ?? 0, -50, 50, 0);
                    const tilt = this.clampNumber(geom?.tilt_deg ?? 0, -45, 45, 0);
                    const scalePct = this.clampNumber(geom?.scale_pct ?? 100, 50, 250, 100);
                    const scale = scalePct / 100;
                    
                    // Filters
                    const filterParts = [];
                    if (this.state?.filter_bw === '1' || this.state?.filter_bw === true) {
                        filterParts.push('grayscale(100%)');
                    }
                    const b = Number(this.state?.filter_brightness || 100);
                    const c = Number(this.state?.filter_contrast || 100);
                    const s = Number(this.state?.filter_saturation || 100);
                    if (b !== 100) filterParts.push(`brightness(${b}%)`);
                    if (c !== 100) filterParts.push(`contrast(${c}%)`);
                    if (s !== 100) filterParts.push(`saturate(${s}%)`);
                    
                    // Apply all styles to match frontend exactly
                    media.style.objectFit = objectFit;
                    media.style.objectPosition = objectPosition;
                    
                    const needsTransform = rotateDeg !== 0 || tilt !== 0 || panX !== 0 || panY !== 0 || scale !== 1;
                    if (needsTransform) {
                        media.style.transform = `translate(${panX}%, ${panY}%) rotate(${rotateDeg + tilt}deg) scale(${scale})`;
                        media.style.willChange = 'transform';
                        media.style.backfaceVisibility = 'hidden';
                    } else {
                        media.style.transform = '';
                        media.style.willChange = '';
                        media.style.backfaceVisibility = '';
                    }
                    
                    if (filterParts.length) {
                        media.style.filter = filterParts.join(' ');
                    } else {
                        media.style.filter = '';
                    }
                }

                // Overlay text
                const overlay = frame.querySelector('.pp-preview-overlay');
                if (overlay) {
                    const cropMode = this.normalizeCropMode(this.state?.cropping?.mode);
                    const cropLabel = cropMode === 'contain' ? 'Contain' : (cropMode === 'manual' ? 'Custom' : 'Cover');
                    // For proof_rail, show minimal text
                    if (contextName === 'proof_rail') {
                        overlay.textContent = `${ctx.dims} (Live)`;
                        overlay.style.fontSize = '9px';
                        overlay.style.padding = '3px 6px';
                    } else {
                        overlay.textContent = `${ctx.label} | ${ctx.dims} | ${cropLabel}`;
                        overlay.style.fontSize = '';
                        overlay.style.padding = '';
                    }
                }

                // Keep any existing advice system updated
                if (typeof this.updateAdvice === 'function') this.updateAdvice();
                
                // If Safe Zone is currently visible, update it to match new context
                const safeZoneOverlay = document.getElementById('ppSafeZoneOverlay');
                if (safeZoneOverlay && safeZoneOverlay.style.display === 'flex') {
                    this.updateSafeZone();
                }
            },
            
            getSafeZoneBoundaries() {
                const rect = document.getElementById('ppSafeZoneRect');
                if (!rect || rect.style.display === 'none') return null;
                
                const bounds = rect.getBoundingClientRect();
                return {
                    left: bounds.left,
                    right: bounds.right,
                    top: bounds.top,
                    bottom: bounds.bottom,
                    width: bounds.width,
                    height: bounds.height,
                    centerX: bounds.left + bounds.width / 2,
                    centerY: bounds.top + bounds.height / 2
                };
            },
            
            updateSafeZone() {
                const container = document.getElementById('ppStageContainer');
                const rect = document.getElementById('ppSafeZoneRect');
                const label = document.getElementById('ppSafeZoneLabel');
                if (!container || !rect || !label) return;
                
                // Get current preview context
                const contextName = this.state?.previewContext || 'proof_rail';
                
                console.log(' [SAFE ZONE] ========================================');
                console.log(' [SAFE ZONE] Context:', contextName);
                console.log(' [SAFE ZONE] Placement from click:', this.state?._editPlacement);
                
                // FIXED: Use exact frontend tile dimensions (from bundles.html .proof-tile CSS)
                // Frontend uses: width: 160px; height: 120px; aspect-ratio: 4/3;
                // Safe Zone must match this EXACTLY
                
                const FRONTEND_TILE_DIMENSIONS = {
                    proof_rail: { width: 160, height: 120 },
                    hero: { width: 1200, height: 600 },
                    gallery: { width: 400, height: 400 },
                    carousel: { width: 1920, height: 1080 }
                };
                
                const targetDims = FRONTEND_TILE_DIMENSIONS[contextName] || FRONTEND_TILE_DIMENSIONS.proof_rail;
                const targetRatio = targetDims.width / targetDims.height;
                
                console.log(' [SAFE ZONE] Frontend tile dimensions:', targetDims.width + 'x' + targetDims.height);
                console.log(' [SAFE ZONE] Target ratio:', targetRatio.toFixed(3));
                
                // USER REQUIREMENT: EXPLICIT PIXEL DIMENSIONS - NO SCALING TO CONTAINER
                // The Safe Zone must render at the exact pixel size of the frontend output (e.g., 160x120).
                // DO NOT scale to fit container. DO NOT use percentages.
                
                let safeWidth = targetDims.width;
                let safeHeight = targetDims.height;
                
                console.log(' [SAFE ZONE] Setting EXACT Dimensions:', safeWidth + 'px x ' + safeHeight + 'px');
                
                // Note: We previously applied 'scaleMultiplier' here to shrink the box for zoomed assets.
                // However, user reports indicate the box was already too large.
                // We are strictly adhering to the "Make it actually 160x120" instruction.
                // If specific zoom handling is needed, it must not inflate the base size first.
                
                const asset = this.state?.edit?.asset;
                const geom = asset?.smart_crop_details?.geometry || {};
                const scalePct = Number(geom?.scale_pct || 100);
                
                console.log(' [SAFE ZONE] Asset scale:', scalePct + '%');
                
                // Apply dimensions
                rect.style.boxSizing = 'border-box';
                rect.style.width = `${safeWidth}px`;
                rect.style.height = `${safeHeight}px`;
                
                // FORCE correct orientation with visual debugging
                rect.style.minWidth = `${safeWidth}px`;
                rect.style.maxWidth = `${safeWidth}px`;
                rect.style.minHeight = `${safeHeight}px`;
                rect.style.maxHeight = `${safeHeight}px`;
                
                // Visual debug: color-code the borders so we can see orientation
                // Top/bottom = BLUE (shorter edges for landscape)
                // Left/right = RED (longer edges for landscape)
                rect.style.borderTop = `5px solid #3b82f6`;    // BLUE = short edge
                rect.style.borderBottom = `5px solid #3b82f6`; // BLUE = short edge  
                rect.style.borderLeft = `5px solid #ef4444`;   // RED = long edge
                rect.style.borderRight = `5px solid #ef4444`;  // RED = long edge
                rect.style.boxShadow = `0 0 0 3px #facc15, 0 0 20px rgba(250, 204, 21, 0.5)`;
                
                // Verify what's actually rendered
                setTimeout(() => {
                    const actualWidth = rect.clientWidth;
                    const actualHeight = rect.clientHeight;
                    const actualComputedWidth = window.getComputedStyle(rect).width;
                    const actualComputedHeight = window.getComputedStyle(rect).height;
                    console.log(' [SAFE ZONE VERIFY] clientWidth:', actualWidth, 'clientHeight:', actualHeight);
                    console.log(' [SAFE ZONE VERIFY] computed width:', actualComputedWidth, 'height:', actualComputedHeight);
                    console.log(' [SAFE ZONE VERIFY] Actual ratio:', (actualWidth / actualHeight).toFixed(3));
                    console.log(' [SAFE ZONE VERIFY] Is ACTUALLY wider than tall?', actualWidth > actualHeight);
                }, 50);
                
                console.log(' [SAFE ZONE] ========================================');
                
                // Update label
                const contextLabels = {
                    proof_rail: 'Proof Rail',
                    hero: 'Bundle Hero',
                    gallery: 'Gallery',
                    carousel: 'Carousel'
                };
                const ratioLabel = targetRatio === 4/3 ? '4:3' : targetRatio === 2 ? '2:1' : targetRatio === 1 ? '1:1' : '16:9';
                const dimsLabel = targetDims.width + 'x' + targetDims.height;
                label.innerHTML = `${contextLabels[contextName] || 'Proof Rail'} &bull; ${ratioLabel} &bull; ${dimsLabel}<br><span style="font-size:10px;opacity:0.8;">Matches frontend tile size ${scalePct !== 100 ? '(scaled ' + scalePct + '%)' : ''}</span>`;
            },

            updateDestinations() {
                 const dests = [];
                 document.querySelectorAll('.destination-card').forEach(card => {
                     dests.push({
                         context: card.dataset.context,
                         priority: parseInt(card.dataset.priority) || 99
                     });
                 });
                 
                 this.state = this.state || {};
                 this.state.destinations = dests;
            },

            initDragAndDrop() {
                const list = document.getElementById('ppDestinationList');
                if (!list) return;
                
                let draggedElement = null;

                const updatePriorities = () => {
                   const cards = list.querySelectorAll('.destination-card');
                   cards.forEach((card, index) => {
                       const priority = index + 1;
                       card.dataset.priority = priority;
                       const meta = card.querySelector('.destination-meta');
                       if (meta) {
                           meta.textContent = meta.textContent.replace(/Priority: \d+/, `Priority: ${priority}`);
                       }
                   });
                   this.updateDestinations();
                };

                list.querySelectorAll('.destination-card').forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                       draggedElement = card;
                       card.classList.add('dragging');
                       e.dataTransfer.effectAllowed = 'move';
                    });
                    
                    card.addEventListener('dragend', () => {
                       card.classList.remove('dragging');
                       draggedElement = null;
                       updatePriorities();
                    });
                });
                
                list.addEventListener('dragover', (e) => {
                   e.preventDefault(); 
                   const afterElement = getDragAfterElement(list, e.clientY);
                   if (afterElement == null) {
                       list.appendChild(draggedElement);
                   } else {
                       list.insertBefore(draggedElement, afterElement);
                   }
                });

                function getDragAfterElement(container, y) {
                    const draggableElements = [...container.querySelectorAll('.destination-card:not(.dragging)')];

                    return draggableElements.reduce((closest, child) => {
                        const box = child.getBoundingClientRect();
                        const offset = y - box.top - (box.height / 2);
                        if (offset < 0 && offset > closest.offset) {
                            return { offset, element: child };
                        }
                        return closest;
                    }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
                }
            }
        };

        function formatRelativeDate(dateString) {
            if (!dateString) return 'No date';
            const parseMaybeLocalDate = (s) => {
                if (!s) return null;
                const str = String(s).trim();
                const m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (m) {
                    const y = parseInt(m[1], 10);
                    const mo = parseInt(m[2], 10) - 1;
                    const d = parseInt(m[3], 10);
                    const dt = new Date(y, mo, d);
                    return isNaN(dt.getTime()) ? null : dt;
                }
                const dt = new Date(str);
                return isNaN(dt.getTime()) ? null : dt;
            };

            const date = parseMaybeLocalDate(dateString);
            if (!date) return 'No date';
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            return `${Math.floor(diffDays / 30)} months ago`;
        }

        // Delete candidate (archive with reason)
        async function deleteCandidate(candidateId, candidateName) {
            const confirmed = await showModal(
                'Delete Candidate',
                `Are you sure you want to delete "${candidateName}"? This will move them to the archive. This is useful for removing test data or candidates who should no longer be in the pipeline.`,
                { confirmText: 'Delete', danger: true }
            );
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(
                    `${API_URL}?action=archiveCandidate&candidateId=${encodeURIComponent(candidateId)}&reason=${encodeURIComponent('Manually deleted - cleanup')}`,
                    { method: 'GET' }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    showToast(`Deleted: ${candidateName}`, 'success');
                    // Reload pipeline silently (no spinner)
                    loadPipeline(true);
                } else {
                    // More detailed error message
                    const errorMsg = result.error || 'Unknown error occurred';
                    showToast('Failed to delete: ' + errorMsg, 'error');
                    
                    // If it's a sheet not found error, suggest creating it
                    if (errorMsg.toLowerCase().includes('sheet') || errorMsg.toLowerCase().includes('not found')) {
                        await showModal(
                            'Archive Sheet Missing',
                            'The Candidate_Archive sheet needs to be created. Click OK to run the auto-archive function which will create it.',
                            { confirmText: 'OK' }
                        );
                    }
                }
            } catch (error) {
                showToast('Network or server error: ' + error.message, 'error');
            }
        }

        // Bulk cleanup - find and delete test candidates
        async function bulkCleanupPipeline() {
            const testKeywords = ['test', 'demo', 'sample', 'fake', 'example', 'asdf', 'qwer', 'zzz', 'xxx'];
            
            const testCandidates = candidates.filter(c => {
                const fullName = `${c.First_Name} ${c.Last_Name}`.toLowerCase();
                const phone = (c.Phone || '').toLowerCase();
                const email = (c.Email || '').toLowerCase();
                
                return testKeywords.some(keyword => 
                    fullName.includes(keyword) || 
                    phone.includes(keyword) || 
                    email.includes(keyword)
                );
            });
            
            if (testCandidates.length === 0) {
                await showModal(
                    'No Test Data Found',
                    'No candidates detected with test keywords (test, demo, sample, etc.). Your pipeline looks clean!',
                    { confirmText: 'OK' }
                );
                return;
            }
            
            const names = testCandidates.map(c => `${c.First_Name} ${c.Last_Name}`).join(', ');
            
            const confirmed = await showModal(
                'Bulk Cleanup',
                `Found ${testCandidates.length} potential test candidates:\n\n${names}\n\nDelete all of these?`,
                { confirmText: `Delete ${testCandidates.length}`, danger: true }
            );
            
            if (!confirmed) return;
            
            let deleted = 0;
            let failed = 0;
            
            for (const candidate of testCandidates) {
                try {
                    const response = await fetch(
                        `${API_URL}?action=archiveCandidate&candidateId=${encodeURIComponent(candidate.Candidate_ID)}&reason=${encodeURIComponent('Bulk cleanup - test data')}`,
                        { method: 'GET' }
                    );
                    
                    const result = await response.json();
                    
                    if (result.ok) {
                        deleted++;
                    } else {
                        failed++;
                    }
                } catch (error) {
                    failed++;
                }
            }
            
            showToast(`Bulk cleanup complete: ${deleted} deleted, ${failed} failed`, deleted > 0 ? 'success' : 'error');
            loadPipeline(true); // Silent reload
        }

        // Detail Drawer Functions
        function openDetailDrawer() {
            document.getElementById('detailDrawer').classList.add('open');
        }

        function closeDetailDrawer() {
            document.getElementById('detailDrawer').classList.remove('open');
        }

        function viewCandidate(candidateId) {
            const needle = String(candidateId ?? '');
            const candidate = candidates.find(c => String(c.Candidate_ID || c.id || '') === needle);
            if (!candidate) {
                showToast('Candidate not found', 'error');
                return;
            }

            const drawerBody = document.getElementById('drawerBody');
            const drawerTitle = document.getElementById('drawerTitle');
            
            drawerTitle.textContent = `${candidate.First_Name} ${candidate.Last_Name}`;
            
            const daysSince = getDaysSince(candidate.Screening_Date);
            
            drawerBody.innerHTML = `
                <div class="detail-section">
                    <div class="detail-section-title">Profile</div>
                    <div class="detail-field">
                        <div class="detail-field-label">Name</div>
                        <div class="detail-field-value">${candidate.First_Name} ${candidate.Last_Name}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Phone</div>
                        <div class="detail-field-value">${candidate.Phone || 'N/A'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Email</div>
                        <div class="detail-field-value">${candidate.Email || 'N/A'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Current Stage</div>
                        <div class="detail-field-value">${candidate.Current_Stage || 'N/A'}</div>
                    </div>
                    <div class="detail-field">
                        <div class="detail-field-label">Days Since Screening</div>
                        <div class="detail-field-value">${daysSince}</div>
                    </div>
                </div>
                <div class="detail-section">
                    <div class="detail-section-title">Actions</div>
                    <button class="btn" onclick="deleteCandidate('${candidate.Candidate_ID}', '${candidate.First_Name} ${candidate.Last_Name}'); closeDetailDrawer();" style="background: var(--danger); color: white; width: 100%; margin-bottom: 8px;">
                        Delete Candidate
                    </button>
                </div>
            `;
            
            openDetailDrawer();
        }

        // Pipeline Search Filter
        let filteredCandidates = [];
        function filterPipeline() {
            const searchTerm = document.getElementById('pipelineSearch').value.toLowerCase();
            if (!searchTerm) {
                renderPipeline(candidates);
                return;
            }
            
            filteredCandidates = candidates.filter(c => {
                const name = `${c.First_Name} ${c.Last_Name}`.toLowerCase();
                const phone = (c.Phone || '').toLowerCase();
                const email = (c.Email || '').toLowerCase();
                return name.includes(searchTerm) || phone.includes(searchTerm) || email.includes(searchTerm);
            });
            
            renderPipeline(filteredCandidates);
        }

        // Deliverables Functions
        let currentDeliverablesView = 'submission';
        
        function switchDeliverablesView(view) {
            currentDeliverablesView = view;
            
            // Hide all views
            document.getElementById('deliverablesSubmissionView').style.display = 'none';
            document.getElementById('deliverablesReviewView').style.display = 'none';
            document.getElementById('deliverablesLibraryView').style.display = 'none';
            
            // Reset tab buttons
            document.querySelectorAll('[id^="deliverablesTab"]').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
            });
            
            // Show selected view and activate tab
            if (view === 'submission') {
                document.getElementById('deliverablesSubmissionView').style.display = 'block';
                document.getElementById('deliverablesTabSubmission').style.background = 'var(--cobalt)';
                document.getElementById('deliverablesTabSubmission').style.color = 'white';
            } else if (view === 'review') {
                document.getElementById('deliverablesReviewView').style.display = 'block';
                document.getElementById('deliverablesTabReview').style.background = 'var(--cobalt)';
                document.getElementById('deliverablesTabReview').style.color = 'white';
                loadDeliverablesReview();
            } else if (view === 'library') {
                document.getElementById('deliverablesLibraryView').style.display = 'block';
                document.getElementById('deliverablesTabLibrary').style.background = 'var(--cobalt)';
                document.getElementById('deliverablesTabLibrary').style.color = 'white';
                loadDeliverablesLibrary();
            }
        }
        
        // File upload state
        let selectedFiles = [];
        
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = 'var(--azure)';
            event.currentTarget.style.background = 'var(--surface)';
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = 'var(--border)';
            event.currentTarget.style.background = 'var(--surface-2)';
        }
        
        function handleFileDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.style.borderColor = 'var(--border)';
            event.currentTarget.style.background = 'var(--surface-2)';
            
            const files = Array.from(event.dataTransfer.files);
            addFiles(files);
        }
        
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }
        
        function addFiles(files) {
            selectedFiles = [...selectedFiles, ...files];
            updateFileDisplay();
        }
        
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileDisplay();
            // Reset file input
            document.getElementById('deliverableFileInput').value = '';
        }
        
        function updateFileDisplay() {
            const display = document.getElementById('deliverableFileDisplay');
            const list = document.getElementById('deliverableFileList');
            
            if (selectedFiles.length === 0) {
                display.innerHTML = `
                    <div style="margin-bottom: 8px;">Drag and drop files here, or click to browse</div>
                    <div style="font-size: 12px; color: var(--muted);">Supports multiple files</div>
                `;
                list.style.display = 'none';
            } else {
                display.innerHTML = `<div style="font-size: 14px; color: var(--text); font-weight: 600;">${selectedFiles.length} file(s) selected</div>`;
                list.style.display = 'block';
                list.innerHTML = selectedFiles.map((file, index) => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: var(--surface); border-radius: 4px; margin-bottom: 4px;">
                        <div style="flex: 1; font-size: 13px; color: var(--text);">
                            <div style="font-weight: 600;">${file.name}</div>
                            <div style="font-size: 11px; color: var(--muted);">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                        <button type="button" onclick="removeFile(${index})" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                    </div>
                `).join('');
            }
        }
        
        async function submitDeliverable(event) {
            event.preventDefault();
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            
            const title = document.getElementById('deliverableTitle').value.trim();
            const description = document.getElementById('deliverableDescription').value.trim();
            
            if (!title || !description) {
                showToast('Please fill in title and description', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                return;
            }
            
            // Handle file uploads - convert to base64 data URLs
            let fileLinks = null;
            if (selectedFiles.length > 0) {
                submitBtn.textContent = 'Processing files...';
                try {
                    const fileData = await Promise.all(selectedFiles.map(async (file) => {
                        const reader = new FileReader();
                        const dataUrl = await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(file);
                        });
                        return {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            dataUrl: dataUrl
                        };
                    }));
                    fileLinks = JSON.stringify(fileData);
                } catch (error) {
                    showToast(`Error processing files: ${error.message}`, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_URL}?action=submitDeliverable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        description,
                        fileLink: fileLinks,
                        submittedBy: currentUser || 'ROSEL'
                    })
                });
                
                const data = await response.json();
                
                if (data.ok && data.result) {
                    showToast('Deliverable submitted for review!', 'success');
                    document.getElementById('deliverableSubmissionForm').reset();
                    selectedFiles = [];
                    updateFileDisplay();
                    // Refresh review queue if it's open
                    if (currentDeliverablesView === 'review') {
                        loadDeliverablesReview();
                    }
                } else {
                    showToast(data.error || 'Failed to submit deliverable', 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        async function loadDeliverablesReview() {
            const container = document.getElementById('deliverablesReviewContainer');
            container.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch(`${API_URL}?action=deliverables&status=pending`);
                const data = await response.json();
                
                if (data.ok && data.deliverables && data.deliverables.length > 0) {
                    container.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: var(--gap-2);">
                            ${data.deliverables.map(d => `
                                <div class="card">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--gap-1);">
                                        <div style="flex: 1;">
                                            <h3 style="font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: var(--gap-1);">${d.Title || 'Untitled'}</h3>
                                            <p style="font-size: 14px; color: var(--muted); margin-bottom: var(--gap-1);">${d.Description || ''}</p>
                                            ${d.AI_Summary ? `
                                                    <div style="background: var(--surface-2); padding: var(--gap-2); border-radius: var(--radius); margin-bottom: var(--gap-1); border-left: 3px solid var(--azure);">
                                                    <div style="font-size: 12px; font-weight: 600; color: var(--azure); margin-bottom: 4px;">AI Analysis</div>
                                                    <div style="font-size: 13px; color: var(--text); margin-bottom: 8px;">${d.AI_Summary}</div>
                                                    ${d.AI_Quality_Score !== null ? `<div style="font-size: 12px; color: var(--muted);">Quality Score: <strong style="color: ${d.AI_Quality_Score >= 70 ? '#10b981' : d.AI_Quality_Score >= 50 ? '#f59e0b' : '#ef4444'}">${d.AI_Quality_Score}/100</strong></div>` : ''}
                                                            </div>
                                                        ` : ''}
                                            <div style="font-size: 13px; color: var(--muted);">
                                                <div>Submitted by: ${d.Submitted_By || 'Unknown'}</div>
                                                <div>Submitted: ${new Date(d.Created_At).toLocaleDateString()}</div>
                                                ${d.File_Link ? `
                                                    <div style="margin-top: 8px;">
                                                        ${(() => {
                                                            try {
                                                                const files = JSON.parse(d.File_Link);
                                                                if (Array.isArray(files)) {
                                                                    return files.map(f => `
                                                                        <div style="margin-bottom: 4px;">
                                                                            <a href="${f.dataUrl}" download="${f.name}" target="_blank" style="color: var(--azure); font-size: 12px;">${f.name} (${(f.size / 1024).toFixed(1)} KB)</a>
                                                                        </div>
                                                                    `).join('');
                                                                }
                                                            } catch (e) {
                                                                // Legacy format - just a URL string
                                                                return `<a href="${d.File_Link}" target="_blank" style="color: var(--azure);">View File/Link ></a>`;
                                                            }
                                                        })()}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: var(--gap-1); flex-shrink: 0; margin-left: var(--gap-2);">
                                            <button class="btn btn-success" onclick="approveDeliverable('${d.Deliverable_ID}')" style="min-width: 100px;">Approve</button>
                                            <button class="btn btn-danger" onclick="rejectDeliverable('${d.Deliverable_ID}')" style="min-width: 100px;">Reject</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">No deliverables pending review.</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error loading review queue: ${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function loadDeliverablesLibrary() {
            const container = document.getElementById('deliverablesLibraryContainer');
            container.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch(`${API_URL}?action=deliverables&status=published`);
                const data = await response.json();
                
                if (data.ok && data.deliverables && data.deliverables.length > 0) {
                    container.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--gap-2);">
                            ${data.deliverables.map(d => `
                                <div class="card">
                                    <h3 style="font-size: 18px; font-weight: 700; color: var(--text); margin-bottom: var(--gap-1);">${d.Title || 'Untitled'}</h3>
                                    <p style="font-size: 14px; color: var(--muted); margin-bottom: var(--gap-1); line-height: 1.5;">${d.Description || ''}</p>
                                    ${d.AI_Summary ? `
                                            <div style="background: var(--surface-2); padding: var(--gap-2); border-radius: var(--radius); margin-bottom: var(--gap-1); border-left: 3px solid var(--azure);">
                                            <div style="font-size: 12px; font-weight: 600; color: var(--azure); margin-bottom: 4px;">AI Analysis</div>
                                            <div style="font-size: 13px; color: var(--text); margin-bottom: 8px;">${d.AI_Summary}</div>
                                            ${d.AI_Quality_Score !== null ? `<div style="font-size: 12px; color: var(--muted);">Quality Score: <strong style="color: ${d.AI_Quality_Score >= 70 ? '#10b981' : d.AI_Quality_Score >= 50 ? '#f59e0b' : '#ef4444'}">${d.AI_Quality_Score}/100</strong></div>` : ''}
                                                </div>
                                                ` : ''}
                                    <div style="font-size: 13px; color: var(--muted); margin-bottom: var(--gap-1);">
                                        <div>By: ${d.Submitted_By || 'Unknown'}</div>
                                        <div>Published: ${d.Published_At ? new Date(d.Published_At).toLocaleDateString() : 'N/A'}</div>
                                    </div>
                                    ${d.File_Link ? `
                                        <div style="margin-top: var(--gap-1);">
                                            ${(() => {
                                                try {
                                                    const files = JSON.parse(d.File_Link);
                                                    if (Array.isArray(files)) {
                                                        return files.map(f => `
                                                            <a href="${f.dataUrl}" download="${f.name}" target="_blank" class="btn" style="background: var(--azure); color: white; width: 100%; margin-bottom: 4px; display: block; text-align: center; padding: 8px;">Download ${f.name}</a>
                                                        `).join('');
                                                    }
                                                } catch (e) {
                                                    // Legacy format
                                                    return `<a href="${d.File_Link}" target="_blank" class="btn" style="background: var(--azure); color: white; width: 100%; margin-top: var(--gap-1);">View ></a>`;
                                                }
                                            })()}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text">No published deliverables yet.</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error loading library: ${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function approveDeliverable(deliverableId) {
            if (!confirm('Approve and publish this deliverable? It will be moved to the library.')) return;
            
            try {
                // First approve
                const approveResponse = await fetch(`${API_URL}?action=approveDeliverable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deliverableId,
                        reviewedBy: currentUser || 'ADMIN'
                    })
                });
                
                const approveData = await approveResponse.json();
                
                if (approveData.ok) {
                    // Then publish
                    const publishResponse = await fetch(`${API_URL}?action=publishDeliverable`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            deliverableId
                        })
                    });
                    
                    const publishData = await publishResponse.json();
                    
                    if (publishData.ok) {
                        showToast('Deliverable approved and published!', 'success');
                        loadDeliverablesReview();
                        loadDeliverablesLibrary();
                    } else {
                        showToast(publishData.error || 'Approved but failed to publish', 'error');
                        loadDeliverablesReview();
                    }
                } else {
                    showToast(approveData.error || 'Failed to approve deliverable', 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function rejectDeliverable(deliverableId) {
            const notes = prompt('Rejection reason (optional):');
            if (notes === null) return; // User cancelled
            
            try {
                const response = await fetch(`${API_URL}?action=rejectDeliverable`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deliverableId,
                        reviewedBy: currentUser || 'ADMIN',
                        reviewNotes: notes || null
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showToast('Deliverable rejected', 'success');
                    loadDeliverablesReview();
                } else {
                    showToast(data.error || 'Failed to reject deliverable', 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        // Initialize deliverables view - will be called when tab is clicked
        // No need to initialize on page load since it's hidden by default

        // Store all profiles for filtering
        let allProfiles = [];
        let currentFilter = 'pending'; // Default to pending review

        // Load AI Profiles
        async function loadAIProfiles(silent = false) {
            const container = document.getElementById('aiProfilesContainer');
            
            // Only show spinner on initial load
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
            }
            
            try {
                // Fetch candidates and extract profiles since aiProfiles endpoint might be unavailable
                const response = await fetch(`${API_URL}?action=candidates&stage=all`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                if (data.ok) {
                    const candidates = data.data || data.candidates || [];
                    
                    // Transform candidates to profiles format
                    allProfiles = candidates
                        .filter(c => c.AI_Candidate_Profiles && (Object.keys(c.AI_Candidate_Profiles).length > 0 || c.AI_Candidate_Profiles.Fit_Score))
                        .map(c => ({
                            ...c.AI_Candidate_Profiles,
                            Candidate_ID: c.Candidate_ID,
                            Candidate_Name: `${c.First_Name} ${c.Last_Name}`,
                            First_Name: c.First_Name,
                            Last_Name: c.Last_Name,
                            Phone: c.Phone,
                            Email: c.Email,
                            Current_Stage: c.Current_Stage,
                            Interview_Date: c.Interview_Date
                        }));

                    if (allProfiles.length > 0) {
                        filterProfiles(currentFilter); // Apply current filter
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">No AI profiles generated yet. Profiles are automatically created when tech interview forms are submitted.</div>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text" style="color: var(--danger);">Error: ${data.error || 'Failed to load AI profiles'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error loading AI profiles. Check console for details.</div>
                    </div>
                `;
            }
        }

        // Filter profiles by decision status
        function filterProfiles(filter) {
            currentFilter = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            // Filter profiles based on Manual_Decision
            let filteredProfiles = allProfiles;
            
            if (filter === 'pending') {
                // Show only profiles without a decision
                filteredProfiles = allProfiles.filter(p => !p.Manual_Decision || p.Manual_Decision === '');
            } else if (filter === 'passed') {
                // Show only PASSED profiles
                filteredProfiles = allProfiles.filter(p => p.Manual_Decision === 'PASS');
            } else if (filter === 'failed') {
                // Show only FAILED profiles
                filteredProfiles = allProfiles.filter(p => p.Manual_Decision === 'FAIL');
            }
            // 'all' shows everything (no filtering)
            
            renderAIProfiles(filteredProfiles);
        }

        // Make decision on a candidate (PASS or FAIL)
        async function makeDecision(candidateId, decision) {
            let notes = '';
            
            // For FAIL decisions, collect feedback/reason (feedback loop) - REQUIRED
            if (decision === 'FAIL') {
                // Use a custom modal that validates the field
                const modalResult = await new Promise((resolve) => {
                    const modalHtml = `
                        <div style="padding: 20px 0;">
                            <p style="margin-bottom: 16px; color: #374151; font-size: 14px; line-height: 1.6;">
                                Why is this candidate being rejected? <span style="color: #ef4444; font-weight: 700; font-size: 18px;">*</span>
                            </p>
                            <p style="margin-bottom: 12px; font-size: 12px; color: #6b7280; font-style: italic;">
                                This feedback is <strong style="color: #ef4444;">required</strong> and helps improve our screening process.
                            </p>
                            <textarea 
                                id="rejectionFeedback" 
                                placeholder="e.g., Missing required tools, unclear communication, scheduling conflicts, not available for required hours, etc."
                                required
                                style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                                onfocus="this.style.borderColor='#0a2a5a'"
                                onblur="this.style.borderColor='#e5e7eb'"
                            ></textarea>
                            <p id="rejectionFeedbackError" style="margin-top: 8px; font-size: 12px; color: #ef4444; display: none; font-weight: 600;">Please provide a rejection reason</p>
                        </div>
                    `;
                    
                    // Show modal and set up validation
                    showModal('Reject Candidate - Provide Feedback', modalHtml, {
                        width: '500px',
                        html: true,
                        confirmText: 'Reject',
                        danger: true
                    });
                    
                    // Override confirm button to validate before closing
                    setTimeout(() => {
                        const confirmBtn = document.getElementById('modalConfirmBtn');
                        if (confirmBtn) {
                            // Store original handler
                            const originalOnClick = confirmBtn.onclick;
                            
                            // Replace with validation handler
                            confirmBtn.onclick = () => {
                                const feedbackEl = document.getElementById('rejectionFeedback');
                                const errorEl = document.getElementById('rejectionFeedbackError');
                                const feedbackValue = feedbackEl ? feedbackEl.value.trim() : '';
                                
                                if (!feedbackValue) {
                                    // Show error and prevent closing
                                    if (errorEl) errorEl.style.display = 'block';
                                    if (feedbackEl) {
                                        feedbackEl.style.borderColor = '#ef4444';
                                        feedbackEl.focus();
                                    }
                                    showToast('Please provide a rejection reason', 'error');
                                    return false; // Prevent modal from closing
                                }
                                
                                // Valid - store value globally and proceed
                                window._pendingRejectionNotes = feedbackValue;
                                if (originalOnClick) originalOnClick();
                            };
                        }
                        
                        // Focus textarea when modal opens
                        const feedbackEl = document.getElementById('rejectionFeedback');
                        if (feedbackEl) feedbackEl.focus();
                    }, 150);
                    
                    // Wait for modal to close (check if overlay is hidden)
                    const checkModalClosed = () => {
                        const checkInterval = setInterval(() => {
                            const overlay = document.getElementById('modalOverlay');
                            if (overlay && !overlay.classList.contains('active')) {
                                clearInterval(checkInterval);
                                
                                // Get the notes if modal was confirmed (check if notes were stored)
                                const notes = window._pendingRejectionNotes || null;
                                if (notes) {
                                    delete window._pendingRejectionNotes;
                                    resolve(notes);
                                } else {
                                    resolve(null); // User cancelled
                                }
                            }
                        }, 100);
                    };
                    
                    checkModalClosed();
                });
                
                if (!modalResult) return; // User cancelled or validation failed
                notes = modalResult;
            } else {
                // For PASS, simple confirmation
                const title = 'Pass Candidate';
                const message = 'Mark this candidate as PASSED?';
                
                const confirmed = await showModal(title, message, {
                    confirmText: 'Pass',
                    danger: false
                });
                
                if (!confirmed) return;
            }
            
            // Find the profile card for smooth animation
            const profileCards = document.querySelectorAll('.ai-profile-card');
            let targetCard = null;
            profileCards.forEach(card => {
                if (card.dataset.candidateId === candidateId) {
                    targetCard = card;
                }
            });
            
            // Add fade-out animation
            if (targetCard) {
                targetCard.style.transition = 'all 0.4s ease';
                targetCard.style.opacity = '0';
                targetCard.style.transform = 'scale(0.95)';
            }
            
            try {
                // Include notes/feedback in the request (backend already supports this)
                const urlParams = new URLSearchParams({
                    action: 'updateDecision',
                    candidateId: candidateId,
                    decision: decision
                });
                
                // Add notes if provided (especially for FAIL decisions)
                if (notes) {
                    urlParams.append('notes', notes);
                }
                
                const url = `${API_URL}?${urlParams.toString()}`;
                
                const response = await fetch(url, { 
                    method: 'GET',
                    redirect: 'follow'
                });
                
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    // Wait for animation, then smoothly remove card
                    setTimeout(() => {
                        if (targetCard) {
                            targetCard.remove();
                        }
                        // Update the count without full reload
                        const container = document.getElementById('aiProfilesContainer');
                        const remainingCards = container.querySelectorAll('.ai-profile-card');
                        if (remainingCards.length === 0) {
                            container.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-text">No candidates pending review</div>
                                </div>
                            `;
                        }
                        
                        // If PASSED, refresh the pipeline to show them in HIRED
                        if (decision === 'PASS') {
                            showToast('Candidate moved to HIRED', 'success');
                            // Silently refresh pipeline in background
                            loadPipeline(true);
                        } else {
                            showToast(`Candidate marked as ${decision}`, 'success');
                        }
                    }, 400);
                } else {
                    if (targetCard) {
                        targetCard.style.opacity = '1';
                        targetCard.style.transform = 'scale(1)';
                    }
                    showToast('Error: ' + result.error, 'error');
                }
            } catch (error) {
                if (targetCard) {
                    targetCard.style.opacity = '1';
                    targetCard.style.transform = 'scale(1)';
                }
                showToast('Failed to update: ' + error.message, 'error');
            }
        }

        // Edit rejection reason for a candidate
        async function editRejectionReason(candidateId, currentNotes) {
            const modalHtml = `
                <div style="padding: 20px 0;">
                    <p style="margin-bottom: 16px; color: #374151; font-size: 14px; line-height: 1.6;">
                        Edit Rejection Reason <span style="color: #ef4444; font-weight: 700; font-size: 18px;">*</span>
                    </p>
                    <textarea 
                        id="editRejectionFeedback" 
                        placeholder="e.g., Missing required tools, unclear communication, scheduling conflicts, not available for required hours, etc."
                        style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; font-family: inherit; resize: vertical; box-sizing: border-box;"
                        onfocus="this.style.borderColor='#0a2a5a'"
                        onblur="this.style.borderColor='#e5e7eb'"
                    >${(currentNotes || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                    <p id="editRejectionFeedbackError" style="margin-top: 8px; font-size: 12px; color: #ef4444; display: none; font-weight: 600;">Please provide a rejection reason</p>
                </div>
            `;
            
            const confirmed = await showModal('Edit Rejection Reason', modalHtml, {
                width: '500px',
                html: true,
                confirmText: 'Save',
                danger: false
            });
            
            if (!confirmed) return;
            
            // Validate and update
            const feedbackEl = document.getElementById('editRejectionFeedback');
            const errorEl = document.getElementById('editRejectionFeedbackError');
            const notes = feedbackEl ? feedbackEl.value.trim() : '';
            
            if (!notes) {
                if (errorEl) errorEl.style.display = 'block';
                if (feedbackEl) {
                    feedbackEl.style.borderColor = '#ef4444';
                    feedbackEl.focus();
                }
                showToast('Please provide a rejection reason', 'error');
                return;
            }
            
            // Update via API
            try {
                const urlParams = new URLSearchParams({
                    action: 'updateDecision',
                    candidateId: candidateId,
                    decision: 'FAIL',
                    notes: notes
                });
                
                const response = await fetch(`${API_URL}?${urlParams.toString()}`, {
                    method: 'GET',
                    redirect: 'follow'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    showToast('Rejection reason updated', 'success');
                    // Reload profiles to show updated reason
                    loadAIProfiles();
                } else {
                    showToast('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Failed to update: ' + error.message, 'error');
            }
        }

        function renderAIProfiles(profiles) {
            // Sort by fit score descending (best first)
            profiles.sort((a, b) => (b.Fit_Score || 0) - (a.Fit_Score || 0));
            
            const html = profiles.map(profile => {
                const recommendation = (profile.Recommendation || 'MAYBE').toUpperCase();
                const recClass = recommendation === 'HIRE' ? 'rec-hire' : 
                                recommendation === 'PASS' ? 'rec-pass' : 'rec-maybe';
                
                const fitScore = profile.Fit_Score || 0;
                const scoreClass = `score-${fitScore}`;
                
                const strengths = (profile.Strengths || 'No strengths listed').split('\n').filter(s => s.trim());
                const concerns = (profile.Concerns || 'No concerns listed').split('\n').filter(s => s.trim());
                
                // Safely get candidate name and contact info
                const candidateName = profile.Candidate_Name || `Candidate ${profile.Candidate_ID || 'Unknown'}`;
                const phone = profile.Phone || 'N/A';
                const email = profile.Email || 'N/A';
                
                return `
                    <div class="ai-profile-card" data-candidate-id="${profile.Candidate_ID}">
                        <div class="ai-profile-header">
                            <div>
                                <div class="ai-profile-name">${candidateName}</div>
                                <div class="ai-profile-contact"><strong>Phone:</strong> ${phone}</div>
                                <div class="ai-profile-contact"><strong>Email:</strong> ${email}</div>
                            </div>
                            <div class="ai-fit-score">
                                <div class="ai-score-number ${scoreClass}">${fitScore}</div>
                                <div class="ai-score-label">Fit Score</div>
                            </div>
                        </div>
                        
                        <div class="ai-recommendation ${recClass}">
                            ${recommendation}
                        </div>
                        
                        <div class="ai-section">
                            <div class="ai-section-title">Summary</div>
                            <div class="ai-summary">${profile.Profile_Summary || 'No summary available'}</div>
                        </div>
                        
                        <div class="ai-section">
                            <div class="ai-section-title">Strengths</div>
                            <ul class="ai-list">
                                ${strengths.map(s => `<li>${s.replace(/^[\u2022\-\*]\s*/, '')}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div class="ai-section">
                            <div class="ai-section-title">Concerns</div>
                            <ul class="ai-list">
                                ${concerns.map(c => `<li>${c.replace(/^[\u2022\-\*]\s*/, '')}</li>`).join('')}
                            </ul>
                        </div>
                        
                        ${profile.Manual_Decision && profile.Manual_Decision !== '' ? `
                            <div class="decision-badge ${profile.Manual_Decision.toLowerCase()}">
                                ${profile.Manual_Decision === 'PASS' ? 'PASSED' : 'FAILED'} by ${profile.Decision_By || 'ROSEL'}
                                <small>Decision made: ${formatDate(profile.Decision_Date)}</small>
                                ${profile.Manual_Decision === 'FAIL' && profile.Decision_Notes ? `
                                    <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); border-radius: 6px;">
                                        <div style="font-size: 12px; font-weight: 700; color: var(--danger); margin-bottom: 6px;">Rejection Reason:</div>
                                        <div style="font-size: 13px; color: #374151; line-height: 1.5;">${profile.Decision_Notes}</div>
                                        <button onclick="editRejectionReason('${profile.Candidate_ID}', '${profile.Decision_Notes.replace(/'/g, "\\'")}')" style="margin-top: 8px; padding: 6px 12px; background: white; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fee'; this.style.borderColor='#dc2626'" onmouseout="this.style.background='white'; this.style.borderColor='var(--danger)'">Edit Reason</button>
                                    </div>
                                ` : profile.Manual_Decision === 'FAIL' ? `
                                    <div style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); border-radius: 6px;">
                                        <div style="font-size: 12px; color: #6b7280; font-style: italic;">No rejection reason provided</div>
                                        <button onclick="editRejectionReason('${profile.Candidate_ID}', '')" style="margin-top: 8px; padding: 6px 12px; background: white; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#fee'; this.style.borderColor='#dc2626'" onmouseout="this.style.background='white'; this.style.borderColor='var(--danger)'">Add Reason</button>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="ai-profile-actions">
                                <button class="action-btn pass-btn" onclick="makeDecision('${profile.Candidate_ID}', 'PASS')">
                                    PASS
                                </button>
                                <button class="action-btn fail-btn" onclick="makeDecision('${profile.Candidate_ID}', 'FAIL')">
                                    FAIL
                                </button>
                            </div>
                        `}
                        
                        <div class="ai-profile-footer">
                            <span>Generated: ${formatDate(profile.Profile_Generated_At)}</span>
                            <span class="ai-model-badge">${profile.AI_Model_Used || 'GPT-4'}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Handle empty state with filter context
            if (profiles.length === 0) {
                const filterName = currentFilter === 'pending' ? 'pending review' : 
                                  currentFilter === 'passed' ? 'passed' : 
                                  currentFilter === 'failed' ? 'failed' : 'this filter';
                document.getElementById('aiProfilesContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">No candidates ${filterName}</div>
                    </div>
                `;
            } else {
                document.getElementById('aiProfilesContainer').innerHTML = `<div class="ai-profiles-grid">${html}</div>`;
            }
        }

        // Setup Forms
        function setupForms() {
            // Hours form is now modal-based, no inline form to setup
        }

        // Hours Modal Functions
        function openHoursModal() {
            document.getElementById('hoursModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Set defaults
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('hoursDate').value = today;
            document.getElementById('hoursStart').value = '09:00';
            document.getElementById('hoursEnd').value = '17:00';
            
            // Clear text areas
            document.getElementById('hoursTasks').value = '';
            document.getElementById('hoursLearned').value = '';
            document.getElementById('hoursBlockers').value = '';
            
            calculateDuration();
        }

        function calculateDuration() {
            const startVal = document.getElementById('hoursStart').value;
            const endVal = document.getElementById('hoursEnd').value;
            const display = document.getElementById('durationDisplay');
            
            if (!startVal || !endVal) {
                display.textContent = '--';
                return;
            }
            
            const start = new Date(`2000-01-01T${startVal}`);
            const end = new Date(`2000-01-01T${endVal}`);
            let diff = (end - start) / (1000 * 60 * 60);
            
            if (diff < 0) diff += 24; // Handle overnight shifts
            
            // Format to 1 decimal place, ensure it's precise
            const hours = Math.round(diff * 10) / 10;
            
            // Display with clear labeling
            display.textContent = hours.toFixed(1) + 'h';
            display.style.color = diff > 0 ? 'var(--azure)' : 'var(--danger)';
            
            // Update tooltip to show calculation details
            display.title = `Work duration: ${startVal} to ${endVal} = ${hours.toFixed(1)} hours`;
        }

        function closeHoursModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('hoursModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function submitHours() {
            const submitBtn = document.querySelector('#hoursModal button[onclick="submitHours()"]');
            const originalBtnText = submitBtn?.textContent || 'Log Hours';
            
            // Generate request ID for tracing
            const requestId = `hours_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Client-side logging
            const date = document.getElementById('hoursDate').value;
            const startTime = document.getElementById('hoursStart').value;
            const endTime = document.getElementById('hoursEnd').value;
            const tasksInput = document.getElementById('hoursTasks').value;
            const learnedInput = document.getElementById('hoursLearned').value;
            const blockersInput = document.getElementById('hoursBlockers').value || 'None';
            
            // Validation
            if (!date || !startTime || !endTime || !tasksInput || !learnedInput) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Validate user identity
            if (!currentUser || currentUser === 'DEMO') {
                showToast('Please select a user before logging hours', 'error');
                return;
            }
            
            // Calculate duration
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            let diff = (end - start) / (1000 * 60 * 60);
            
            if (diff <= 0) {
                showToast('End time must be after start time', 'error');
                return;
            }
            
            if (diff > 24) {
                showToast('Hours cannot exceed 24 hours. Please check your times.', 'error');
                return;
            }
            
            const hours = Math.round(diff * 100) / 100;
            
            // Combine into structured format
            const combinedLog = `[SHIFT: ${startTime} - ${endTime} (${hours}h)]\n\n[TASKS]\n${tasksInput}\n\n[WINS/LEARNINGS]\n${learnedInput}\n\n[BLOCKERS]\n${blockersInput}`;
            
            const data = { 
                date, 
                hours, 
                vaName: String(currentUser || '').trim().toUpperCase(),
                tasks: combinedLog,
                analysisPrompt: `Analyze this work log with focus on: 1) Specific outcomes achieved (revenue-generating tasks prioritized?), 2) Learning and skill development demonstrated, 3) Process improvements or blockers to address, 4) Priorities for tomorrow based on today's patterns. Be direct and constructive.`,
                requestId: requestId
            };
            
            // Disable button and show loading
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Logging...';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=logHours`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.ok) {
                    showToast('Hours logged successfully!', 'success');
                    closeHoursModal();
                    loadHoursHistory();
                    
                    // Refresh Admin Dashboard if it's currently visible
                    const adminPane = document.getElementById('admin-pane');
                    if (adminPane && adminPane.classList.contains('active')) {
                        setTimeout(() => {
                            if (typeof adminDashboard !== 'undefined' && adminDashboard.refresh) {
                                adminDashboard.refresh();
                            }
                        }, 500);
                    }
                } else {
                    const errorMsg = result.error || 'Unknown error occurred';
                    let userMessage = 'Failed to log hours. ';
                    
                    if (errorMsg.includes('duplicate') || errorMsg.includes('already exists')) {
                        userMessage += 'You have already logged hours for this date. Please check your history or contact support if you need to update.';
                    } else if (errorMsg.includes('validation') || errorMsg.includes('invalid')) {
                        userMessage += 'Please check your input and try again.';
                    } else if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
                        userMessage += 'Network error. Please check your connection and try again.';
                    } else {
                        userMessage += errorMsg;
                    }
                    
                    showToast(userMessage, 'error');
                }
            } catch (error) {
                const errorMsg = error.message || 'Network error';
                showToast(`Failed to log hours: ${errorMsg}. Please check your connection and try again.`, 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            }
        }

        // Load Hours History
        async function loadHoursHistory(silent = false) {
            const container = document.getElementById('hoursHistoryContainer');
            
            // Only show spinner on initial load, not on auto-refresh
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
            }
            
            try {
                // Pass vaName query param to filter by user (if not DEMO)
                const currentUserKey = currentUser ? String(currentUser).trim().toUpperCase() : '';
                const vaNameParam = currentUserKey && currentUserKey !== 'DEMO' 
                    ? `&vaName=${encodeURIComponent(currentUserKey)}` 
                    : '';
                const response = await fetch(`${API_URL}?action=hours${vaNameParam}`);
                
                // Check HTTP status
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.ok) {
                    const entries = data.hours || [];
                    if (entries.length > 0) {
                        renderHoursHistory(entries);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">No hours logged yet. Click "Log Today's Hours" to get started.</div>
                            </div>
                        `;
                    }
                } else {
                    // Only show error if not silent
                    if (!silent) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text" style="color: var(--danger);">Error loading hours: ${data.error || 'Unknown error'}. Please refresh the page.</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                if (!silent) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text" style="color: var(--danger);">Network error loading hours. Please check your connection and refresh.</div>
                        </div>
                    `;
                }
            }
        }

        // Add Task Modal Functions
        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
            document.getElementById('newTaskDueDate').valueAsDate = new Date();
            // Reset recurrence defaults
            document.getElementById('newTaskRecurrence').value = 'none';
            document.getElementById('newTaskRetention').value = '7';
            document.getElementById('newTaskDueTime').value = '09:00';
        }
        // Calendar modal controls
        function openCalendarModal() {
            const dateEl = document.getElementById('newTaskDueDate');
            const timeEl = document.getElementById('newTaskDueTime');
            document.getElementById('calendarDate').value = dateEl.value || new Date().toISOString().split('T')[0];
            document.getElementById('calendarTime').value = timeEl.value || '09:00';
            document.getElementById('calendarModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCalendarModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('calendarModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function applyCalendarSelection() {
            const date = document.getElementById('calendarDate').value;
            const time = document.getElementById('calendarTime').value;
            if (date) document.getElementById('newTaskDueDate').value = date;
            if (time) document.getElementById('newTaskDueTime').value = time;
            closeCalendarModal();
        }

        function closeAddTaskModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('addTaskModal').classList.remove('active');
            document.getElementById('addTaskForm').reset();
        }

        async function polishTaskDescription() {
            const title = document.getElementById('newTaskTitle').value;
            const description = document.getElementById('newTaskDescription').value;
            const btn = document.querySelector('button[onclick="polishTaskDescription()"]');
            
            if (!description) {
                showToast('Please enter some rough notes first', 'error');
                return;
            }
            
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Polishing...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}?action=refineTask&title=${encodeURIComponent(title)}&description=${encodeURIComponent(description)}`);
                const data = await response.json();
                
                if (data.ok) {
                    document.getElementById('newTaskDescription').value = data.refinedDescription;
                    showToast('Task polished by AI!', 'success');
                } else {
                    showToast('Failed to polish task: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function submitNewTask(event) {
            event.preventDefault();
            
            const btn = event.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Creating...';
            btn.disabled = true;
            
            const taskData = {
                title: document.getElementById('newTaskTitle').value,
                description: document.getElementById('newTaskDescription').value,
                priority: document.getElementById('newTaskPriority').value,
                dueDate: document.getElementById('newTaskDueDate').value,
                dueTime: document.getElementById('newTaskDueTime').value,
                recurrence: document.getElementById('newTaskRecurrence').value, // none|daily|weekly
                retentionDays: parseInt(document.getElementById('newTaskRetention').value || '7', 10) // how long it stays in Done
            };
            
            try {
                const response = await fetch(`${API_URL}?action=addTask`, {
                    method: 'POST',
                    body: JSON.stringify(taskData)
                });
                const data = await response.json();
                
                if (data.ok) {
                    showToast('Task created successfully!', 'success');
                            closeAddTaskModal();
                    loadTasks(); // Refresh list
                    } else {
                    showToast('Failed to create task: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        function renderHoursHistory(entries) {
            const parseMaybeLocalDate = (dateStr) => {
                if (!dateStr) return null;
                const s = String(dateStr).trim();
                const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (m) {
                    const y = parseInt(m[1], 10);
                    const mo = parseInt(m[2], 10) - 1;
                    const d = parseInt(m[3], 10);
                    const dt = new Date(y, mo, d);
                    return isNaN(dt.getTime()) ? null : dt;
                }
                const dt = new Date(s);
                return isNaN(dt.getTime()) ? null : dt;
            };

            // Normalize field names (backend returns capital case)
            const normalizedEntries = entries.map(entry => ({
                date: entry.Date || entry.date,
                hours: entry.Hours || entry.hours,
                tasks: entry.Tasks || entry.tasks,
                aiSummary: entry.AI_Summary || entry.aiSummary,
                loggedBy: entry.Logged_By || entry.loggedBy
            }));
            
            // Filter to only show entries from last 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            sevenDaysAgo.setHours(0, 0, 0, 0);
            
            const recentEntries = normalizedEntries.filter(entry => {
                if (!entry.date) return false;
                const entryDate = parseMaybeLocalDate(entry.date);
                if (!entryDate) return false;
                const entryDateOnly = new Date(entryDate);
                entryDateOnly.setHours(0, 0, 0, 0);
                return entryDateOnly >= sevenDaysAgo;
            });
            
            // If no recent entries after filtering, show message
            if (recentEntries.length === 0) {
                document.getElementById('hoursHistoryContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text">No hours logged in the last 7 days. Click "Log Today's Hours" to get started.</div>
                    </div>
                `;
                return;
            }
            
            const html = `
                <table class="hours-table">
                    <thead>
                        <tr>
                            <th style="width: 120px;">Date</th>
                            <th style="width: 80px;">Hours</th>
                            <th>Daily Summary</th>
                        </tr>
                    </thead>
                    <tbody>
                    ${recentEntries.map(entry => {
                        // Safely get loggedBy as string
                        let loggedByName = 'ROSEL';
                        if (entry.loggedBy) {
                            if (typeof entry.loggedBy === 'string') {
                                loggedByName = entry.loggedBy;
                            } else {
                                loggedByName = 'ROSEL'; // Default if it's an object
                            }
                        }
                        
                        return `
                                <tr>
                                    <td>
                                        <div class="hours-date">${formatDate(entry.date)}</div>
                                        <div style="font-size: 11px; color: #5f6368; margin-top: 4px;">${loggedByName}</div>
                                    </td>
                                    <td>
                                        <div class="hours-amount">${entry.hours || 0}h</div>
                                    </td>
                                    <td>
                                        <div class="hours-summary">${entry.aiSummary || entry.tasks || 'No summary available'}</div>
                                    </td>
                                </tr>
                        `;
                    }).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('hoursHistoryContainer').innerHTML = html;
        }

        async function handleHoursSubmit(e) {
            e.preventDefault();
            
            const data = {
                date: document.getElementById('hoursDate').value,
                hours: parseFloat(document.getElementById('hoursWorked').value),
                tasks: document.getElementById('tasks').value,
                vaName: String(currentUser || 'ROSEL').trim().toUpperCase() // Include vaName for proper attribution
            };

            try {
                const response = await fetch(`${API_URL}?action=logHours`, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    alert('Hours logged successfully!');
                    e.target.reset();
                    initHoursForm();
                    // Reload hours history if function exists
                    if (typeof loadHoursHistory === 'function') {
                        loadHoursHistory();
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error logging hours: ' + error);
            }
        }

        function initHoursForm() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('hoursDate').value = today;
        }

        function parseTriBool(selectValue) {
            const v = String(selectValue || '').trim().toLowerCase();
            if (v === 'true') return true;
            if (v === 'false') return false;
            return null;
        }

        function resetScreeningForm() {
            const form = document.getElementById('screeningForm');
            if (form) form.reset();
        }

        let lastSampleCandidate = null;

        function makeSampleCandidate() {
            const suffix = `${Date.now()}${Math.floor(Math.random() * 1000)}`;
            const email = `test.candidate.${suffix}@example.com`;
            const phone = `+1555${String(Math.floor(Math.random() * 9000000) + 1000000)}`;
            return {
                firstName: 'Test',
                lastName: `Candidate${String(suffix).slice(-4)}`,
                email,
                phone
            };
        }

        function setValue(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }

        function fillScreeningSample() {
            const c = makeSampleCandidate();
            lastSampleCandidate = c;

            setValue('screeningFirstName', c.firstName);
            setValue('screeningLastName', c.lastName);
            setValue('screeningPhone', c.phone);
            setValue('screeningEmail', c.email);
            setValue('screeningNotes', 'Sample screening submission for quick testing.');
            setValue('screeningToolsReq', 'true');
            setValue('screeningExperience', '>2 years');
            setValue('screeningCommuteOk', 'true');
            setValue('screeningWeekday', 'true');
            setValue('screeningEveningSat', 'false');
            setValue('screeningOutcome', 'PASS');
            setValue('screeningInterviewEffort', 'High');

            showToast('Sample screening data filled', 'success');
        }

        function resetTechInterviewForm() {
            const form = document.getElementById('techInterviewForm');
            if (form) form.reset();
        }

        function fillTechInterviewSample() {
            const c = lastSampleCandidate || makeSampleCandidate();
            lastSampleCandidate = c;

            setValue('techFirstName', c.firstName);
            setValue('techLastName', c.lastName);
            setValue('techEmail', c.email);
            setValue('techPhone', c.phone);
            setValue('techJobTypes', 'Rekey, smart lock installs, troubleshooting keypad locks');
            setValue('techJudgment', 'Start with quick checks, confirm symptoms, isolate root cause, escalate only with clear evidence.');
            setValue('techTroubleshooting', 'Customer reports lock not pairing. Verified power, reset, checked app permissions, re-paired successfully.');
            setValue('techJobsPerWeek', '10');
            setValue('techWorked1099', 'true');
            setValue('techHasOtherJob', 'false');
            setValue('techBalancing', 'No other job; fully available. Will block calendar and confirm jobs daily.');
            setValue('techResponsibility', 'On-time, communicates delays early, documents every job, owns mistakes.');
            setValue('techCommunication', 'Calls customer on arrival, uses clear updates, follows dispatcher instructions.');
            setValue('techOutcome', 'PASS');
            setValue('techNotes', 'Sample tech interview submission for quick testing.');

            showToast('Sample tech interview data filled', 'success');
        }

        async function submitScreening(event) {
            event.preventDefault();

            if (!currentUser || currentUser === 'DEMO') {
                showToast('Please select a user first', 'error');
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
            }

            try {
                const payload = {
                    submittedBy: String(currentUser || 'ROSEL').trim().toUpperCase(),
                    candidate: {
                        firstName: document.getElementById('screeningFirstName')?.value?.trim() || '',
                        lastName: document.getElementById('screeningLastName')?.value?.trim() || '',
                        phone: document.getElementById('screeningPhone')?.value?.trim() || '',
                        email: document.getElementById('screeningEmail')?.value?.trim() || ''
                    },
                    notesConcerns: document.getElementById('screeningNotes')?.value?.trim() || '',
                    toolsRequirementsMet: parseTriBool(document.getElementById('screeningToolsReq')?.value),
                    experienceLevel: document.getElementById('screeningExperience')?.value || '',
                    commuteOk: parseTriBool(document.getElementById('screeningCommuteOk')?.value),
                    weekdayDaytimeAvailable: parseTriBool(document.getElementById('screeningWeekday')?.value),
                    eveningSaturdayAvailable: parseTriBool(document.getElementById('screeningEveningSat')?.value),
                    screeningOutcome: document.getElementById('screeningOutcome')?.value || '',
                    interviewEffort: document.getElementById('screeningInterviewEffort')?.value || ''
                };

                const res = await fetch(`${API_URL}?action=logScreening`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!data.ok) {
                    showToast(data.error || 'Failed to submit screening', 'error');
                    return;
                }

                showToast('Screening saved', 'success');
                resetScreeningForm();
                loadPipeline(true);
            } catch (e) {
                showToast('Error submitting screening', 'error');
                console.error(e);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        }

        async function submitTechInterview(event) {
            event.preventDefault();

            if (!currentUser || currentUser === 'DEMO') {
                showToast('Please select a user first', 'error');
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn ? submitBtn.textContent : '';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Submitting...';
            }

            try {
                const payload = {
                    submittedBy: String(currentUser || 'ROSEL').trim().toUpperCase(),
                    candidate: {
                        firstName: document.getElementById('techFirstName')?.value?.trim() || '',
                        lastName: document.getElementById('techLastName')?.value?.trim() || '',
                        email: document.getElementById('techEmail')?.value?.trim() || '',
                        phone: document.getElementById('techPhone')?.value?.trim() || ''
                    },
                    interviewOutcome: document.getElementById('techOutcome')?.value || '',
                    interviewNotes: document.getElementById('techNotes')?.value?.trim() || '',
                    technicalAssessment: {
                        jobTypesConfident: document.getElementById('techJobTypes')?.value?.trim() || '',
                        judgmentCriteria: document.getElementById('techJudgment')?.value?.trim() || '',
                        troubleshootingScenario: document.getElementById('techTroubleshooting')?.value?.trim() || '',
                        jobsPerWeekDesired: document.getElementById('techJobsPerWeek')?.value || '',
                        worked1099Before: parseTriBool(document.getElementById('techWorked1099')?.value),
                        hasOtherJob: parseTriBool(document.getElementById('techHasOtherJob')?.value),
                        balancingPlan: document.getElementById('techBalancing')?.value?.trim() || '',
                        responsibilityManagement: document.getElementById('techResponsibility')?.value?.trim() || '',
                        communicationNavigation: document.getElementById('techCommunication')?.value?.trim() || ''
                    }
                };

                const res = await fetch(`${API_URL}?action=logTechInterview`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (!data.ok) {
                    showToast(data.error || 'Failed to submit tech interview', 'error');
                    return;
                }

                showToast('Tech interview saved', 'success');
                resetTechInterviewForm();
                loadPipeline(true);
            } catch (e) {
                showToast('Error submitting tech interview', 'error');
                console.error(e);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const s = String(dateStr).trim();
            const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            const date = m
                ? new Date(parseInt(m[1], 10), parseInt(m[2], 10) - 1, parseInt(m[3], 10))
                : new Date(s);
            if (isNaN(date.getTime())) return '';
            return date.toLocaleDateString();
        }

        // Refresh GHL form iframe (reload without full page refresh)
        function refreshForm(iframeId) {
            const iframe = document.getElementById(iframeId);
            if (iframe) {
                // Force iframe reload by resetting src
                const currentSrc = iframe.src;
                iframe.src = '';
                setTimeout(() => {
                    iframe.src = currentSrc;
                }, 100);
            }
        }

        // Load Training Resources
        function renderTrainingResources(resources) {
            const html = resources.map(resource => {
                const type = (resource.Type || 'VIDEO').toUpperCase();
                const typeClass = type === 'VIDEO' ? 'type-video' : type === 'PDF' ? 'type-pdf' : 'type-sop';
                
                // Check if completed
                const completions = resource.completions || [];
                const isCompleted = completions.length > 0;
                const latestCompletion = isCompleted ? completions[0] : null;
                const analysisStatus = latestCompletion && (latestCompletion.AI_Analysis_Raw || latestCompletion.AI_Extracted_Concepts || latestCompletion.AI_Knowledge_Gaps)
                    ? `Analyzed ${formatDate(latestCompletion.Completed_At)}`
                    : (isCompleted ? 'Pending AI analysis' : 'Not started');

                // Course status badge
                let statusLabel = 'Not Started';
                let statusClass = 'status-not-started';
                
                if (isCompleted) {
                    statusLabel = 'Completed';
                    statusClass = 'status-completed';
                } else if (resource.Progress && Number(resource.Progress) > 0) {
                    statusLabel = 'In Progress';
                    statusClass = 'status-in-progress';
                }
                
                // Parse skills and difficulty
                const skills = resource.Skills_Taught ? resource.Skills_Taught.split(',').map(s => s.trim()) : [];
                const difficulty = resource.Difficulty_Level || 'BEGINNER';
                
                let content = '';

                if (type === 'VIDEO' && resource.URL) {
                    // Support both Loom and YouTube
                    let videoId = '';
                    let platform = 'loom';
                    
                    if (resource.URL.includes('youtube.com') || resource.URL.includes('youtu.be')) {
                        platform = 'youtube';
                        const ytMatch = resource.URL.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]+)/);
                        if (ytMatch) videoId = ytMatch[1];
                    } else if (resource.URL.includes('loom.com/share/')) {
                        videoId = resource.URL.split('loom.com/share/')[1].split('?')[0];
                    } else if (resource.URL.includes('loom.com/embed/')) {
                        videoId = resource.URL.split('loom.com/embed/')[1].split('?')[0];
                    }
                    
                    if (videoId && platform === 'youtube') {
                        content = `
                            <div style="position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <iframe 
                                    src="https://www.youtube.com/embed/${videoId}"
                                    style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0;"
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen
                                ></iframe>
                            </div>
                        `;
                    } else if (videoId && platform === 'loom') {
                        content = `
                            <div style="position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <iframe 
                                    src="https://www.loom.com/embed/${videoId}?hide_title=true&hide_owner=true"
                                    allow="fullscreen; picture-in-picture"
                                    style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0; display: block;"
                                ></iframe>
                            </div>
                        `;
                    } else {
                        content = `<div style="padding: 32px; text-align: center; background: #f8f9fa; border-radius: 8px; border: 2px dashed #e0e0e0;">
                            <a href="${resource.URL}" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--cobalt); color: #fff; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 14px; transition: transform 0.2s;">
                                Open Video Link
                            </a>
                        </div>`;
                    }
                } else if (type === 'PDF' && resource.URL) {
                    const preview = (resource.Description || '').substring(0, 180);
                    content = `
                        <div style="padding: 24px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                            <div style="display:flex; align-items:center; gap:10px; font-weight:800; color:var(--cobalt); font-size:16px; margin-bottom:12px;">
                                PDF Document
                            </div>
                            <p style="color:#4b5563; font-size:14px; line-height:1.6; margin-bottom: 16px;">${preview || 'No description available.'}</p>
                            <a href="${resource.URL}" target="_blank" class="btn" style="background: white; color: var(--cobalt); border: 2px solid var(--cobalt); width: 100%; justify-content: center;">
                                Open PDF
                            </a>
                        </div>`;
                } else if (type === 'SOP' && resource.URL) {
                    const preview = (resource.Description || '').substring(0, 200);
                    content = `
                        <div style="padding: 24px; background: #f0f7ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                            <div style="display:flex; align-items:center; gap:10px; font-weight:800; color:var(--azure); font-size:16px; margin-bottom:12px;">
                                Standard Operating Procedure
                            </div>
                            <p style="color:#1e3a8a; font-size:14px; line-height:1.6; margin-bottom: 16px;">${preview || 'No description available.'}</p>
                            <a href="${resource.URL}" target="_blank" class="btn" style="background: var(--azure); color: white; width: 100%; justify-content: center;">
                                View SOP
                            </a>
                        </div>`;
                }
                
                return `
                    <div class="training-card" data-resource-id="${resource.Resource_ID}" style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 20px; transition: transform 0.2s, box-shadow 0.2s;">
                        
                        <!-- Header -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 16px; margin-bottom: 12px;">
                                <h3 style="font-size: 18px; font-weight: 800; color: var(--cobalt); line-height: 1.4; margin: 0;">${resource.Title || 'Untitled Resource'}</h3>
                                ${isCompleted ? `<span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 700; white-space: nowrap;">Done</span>` : ''}
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="background: #f3f4f6; color: #4b5563; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;">${resource.Category || 'General'}</span>
                                <span style="background: #f3f4f6; color: #4b5563; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;">${resource.Estimated_Minutes || '?'} min</span>
                                <span style="background: #eff6ff; color: var(--azure); padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700;">${type}</span>
                            </div>
                        </div>

                        <!-- Content -->
                        <div style="flex: 1;">
                            ${content}
                        </div>
                        
                        <!-- Description -->
                        ${resource.Description ? `<p style="color: #6b7280; font-size: 14px; line-height: 1.6; margin: 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${resource.Description}</p>` : ''}
                        
                        <!-- Footer / Action -->
                        <div style="padding-top: 20px; border-top: 1px solid #f3f4f6; display: flex; flex-direction: column; gap: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 12px; color: #9ca3af; font-weight: 500;">
                                    ${isCompleted ? `Completed ${formatDate(latestCompletion.Completed_At)}` : 'Not completed yet'}
                                </div>
                            </div>
                            
                            ${!isCompleted ? `
                                <button 
                                    onclick="openCompletionModal('${resource.Resource_ID}', '${resource.Title.replace(/'/g, "\\'")}')"
                                    style="padding: 14px 20px; background: var(--cobalt); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(10, 42, 90, 0.2); width: 100%; text-align: center;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(10, 42, 90, 0.3)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(10, 42, 90, 0.2)'"
                                >
                                    Complete Learnings
                                </button>
                            ` : `
                                <button disabled style="padding: 14px 20px; background: #f3f4f6; color: #9ca3af; border: none; border-radius: 12px; font-size: 15px; font-weight: 700; cursor: not-allowed; width: 100%; text-align: center;">
                                    Completed
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('trainingContainer').innerHTML = `<div class="training-grid">${html}</div>`;
            
            // Update counts
            const allCount = resources.length;
            const completedCount = resources.filter(r => (r.completions || []).length > 0).length;
            document.getElementById('allCount').textContent = allCount;
            document.getElementById('inprogressCount').textContent = completedCount;
            
            // Load recommendations and apply default filter
            loadRecommendationsForFilter().then(() => {
                // If no recommendations found, default to showing all training
                if (currentFilterMode === 'recommended' && recommendedResourceIds.length === 0) {
                    currentFilterMode = 'all';
                }
                filterTrainingResources(currentFilterMode);
            });
        }

        // Knowledge Profile Functions
        let currentFilterMode = 'all'; // Track current filter (recommended, inprogress, all)
        let recommendedResourceIds = []; // Store recommended Resource_IDslet currentUser = null; // Set via user gate or localStorage

        // User Gate Logic with localStorage persistence
        const STORAGE_KEY = 'h2s_current_user';
        const SESSION_DURATION = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        // Shared admin password/credential: uses the same key as Proof Packs admin key.
        const ADMIN_CREDENTIAL_KEY = 'h2s_proof_admin_key';
        const ADMIN_AUTH_KEY = 'h2s_admin_authenticated';

        // Check if admin is authenticated
        function checkAdminAuth() {
            try {
                const authState = sessionStorage.getItem(ADMIN_AUTH_KEY);
                if (authState === 'true') return true;
                const key = (localStorage.getItem(ADMIN_CREDENTIAL_KEY) || '').trim();
                return !!key;
            } catch (e) {
                return false;
            }
        }

        // Set admin authentication state
        function setAdminAuth(authenticated) {
            try {
                sessionStorage.setItem(ADMIN_AUTH_KEY, authenticated ? 'true' : 'false');
            } catch (e) {
                console.warn('Could not save admin auth state:', e);
            }
        }

        // Prompt for admin password
        function promptAdminPassword(callback) {
            const overlay = document.getElementById('modalOverlay');
            const header = document.getElementById('modalHeader');
            const body = document.getElementById('modalBody');
            const confirmBtn = document.getElementById('modalConfirmBtn');
            const cancelBtn = document.querySelector('.modal-btn-cancel');
            const actions = document.getElementById('modalActions');
            const dialog = overlay.querySelector('.modal-dialog');
            
            header.textContent = 'Admin Access Required';
            body.innerHTML = `
                <div style="padding: 24px 0;">
                    <div style="font-size: 16px; line-height: 1.6; color: #374151; margin-bottom: 16px;">
                        Enter the shared admin password (same as Proof Packs admin key):
                    </div>
                    <input 
                        type="password" 
                        id="adminPasswordInput" 
                        placeholder="Password" 
                        style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                        autocomplete="off"
                    />
                </div>
            `;
            
            // Set modal width
            if (dialog) {
                dialog.style.maxWidth = '400px';
            }
            
            actions.style.display = 'flex';
            confirmBtn.style.display = 'block';
            confirmBtn.textContent = 'Enter';
            confirmBtn.className = 'modal-btn modal-btn-confirm';
            
            // Lock body scroll
            const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
            if (scrollbarWidth > 0) {
                document.body.style.paddingRight = `${scrollbarWidth}px`;
            }
            document.body.style.overflow = 'hidden';
            
            const passwordInput = document.getElementById('adminPasswordInput');
            if (passwordInput) {
                // Focus after a short delay to ensure modal is visible
                setTimeout(() => {
                    passwordInput.focus();
                }, 100);
                
                const handleConfirm = () => {
                    const password = passwordInput.value.trim();
                    if (!password) {
                        showToast('Password required', 'error');
                        passwordInput.value = '';
                        setTimeout(() => passwordInput.focus(), 100);
                        return;
                    }

                    try { localStorage.setItem(ADMIN_CREDENTIAL_KEY, password); } catch (e) { /* ignore */ }
                    const ppKeyEl = document.getElementById('ppAdminKey');
                    if (ppKeyEl) ppKeyEl.value = password;

                    setAdminAuth(true);
                    closeModal();
                    callback(true);
                    showToast('Admin access granted', 'success');
                };
                
                const handleCancel = () => {
                    closeModal();
                    callback(false);
                };
                
                // Clear previous event listeners by cloning
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                newConfirmBtn.onclick = handleConfirm;
                
                if (cancelBtn) {
                    const newCancelBtn = cancelBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                    newCancelBtn.onclick = handleCancel;
                }
                
                // Allow Enter key to submit, Escape to cancel
                passwordInput.onkeydown = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleConfirm();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        handleCancel();
                    }
                };
            }
            
            overlay.classList.add('active');
        }

        // Check for cached user on page load
        function checkCachedUser() {
            try {
                const cached = localStorage.getItem(STORAGE_KEY);
                if (cached) {
                    const { user, timestamp } = JSON.parse(cached);
                    const now = Date.now();
                    
                    // If session is still valid (within 24 hours)
                    if (now - timestamp < SESSION_DURATION) {
                        currentUser = user;
                        document.getElementById('userGate').style.display = 'none';
                        initDashboard();
                        return true;
                    } else {
                        // Session expired, clear storage
                        localStorage.removeItem(STORAGE_KEY);
                    }
                }
            } catch (e) {
            }
            return false;
        }

        function enterDashboard() {
            const selected = document.getElementById('userSelect').value;
            if (!selected) return;
            
            currentUser = selected;
            
            // Cache user selection with timestamp
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    user: currentUser,
                    timestamp: Date.now()
                }));
            } catch (e) {
            }
            
            // Smooth transition
            const gate = document.getElementById('userGate');
                gate.classList.add('hidden');
                
                setTimeout(() => {
                    gate.style.display = 'none';
                }, 300);
            
            // Initialize dashboard with user context
            initDashboard();
        }

        // Add logout function for manual session clearing
        function logoutUser() {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        function safeParseJSON(text, fallback) {
            if (!text || typeof text !== 'string') return fallback;
            try { return JSON.parse(text); } catch { return fallback; }
        }

        async function loadKnowledgeProfile() {
            try {
                const response = await fetch(`${API_URL}?action=vaKnowledgeProfile&vaName=${encodeURIComponent(currentUser)}`);
                const data = await response.json();
                
                if (data.ok && data.vaKnowledgeProfile) {
                    const profile = data.vaKnowledgeProfile;
                    renderKnowledgeProfile(profile);
                    renderRecommendations(profile);
                    renderActionableTasks(profile);
                }
            } catch (error) {
                console.error('Error loading knowledge profile:', error);
            }
        }

        // ===== KNOWLEDGE PROFILE TRACKING =====
        // Relies on completion feedback: user submits notes, comprehension rating, time spent
        // AI analyzes and updates VA_Knowledge_Profile with extracted concepts, gaps, and recommendations
        function renderRecommendations(profile) {
            const container = document.getElementById('recommendedTrainingList');
            const raw = profile.Recommended_Trainings || '[]';
            const items = safeParseJSON(raw, []);
            if (!container) return;
            if (!items || items.length === 0) {
                container.innerHTML = '<div style="color:#6b7280;">No recommendations yet. Complete a training to generate guidance.</div>';
                return;
            }
            container.innerHTML = items.slice(0,3).map(it => {
                const title = it.title || 'Recommended Training';
                const pillar = it.pillar || 'General';
                const reason = it.reason || 'High ROI next step.';
                const resId = it.resourceId || '';
                return `
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:8px;">
                        <div style="min-width:0;">
                            <div style="font-weight:800; color:#0a2a5a;">${title}</div>
                            <div style="font-size:12px; color:#6b7280;">${pillar} | ${reason}</div>
                            </div>
                        <button style="padding:8px 12px; background:#0a2a5a; color:#fff; border:none; border-radius:8px; font-weight:700; font-size:12px;" onclick="focusTraining('${resId}')">Start</button>
                    </div>
                `;
            }).join('');
        }

        function renderActionableTasks(profile) {
            const container = document.getElementById('knowledgeGapsList');
            if (!container) return;
            const concepts = safeParseJSON(profile.AI_Extracted_Concepts || '[]', []);
            const gaps = safeParseJSON(profile.Top_Skill_Gaps || '[]', []);
            const tasks = [];
            concepts.slice(0,5).forEach(c => {
                const skill = (c.skill || c.name || '').trim();
                if (!skill) return;
                        tasks.push({
                    title: `Apply ${skill}: create a 1-page summary and implement on 3 examples`,
                            pillar: c.pillar || 'Training',
                    reason: 'Reinforce learning by immediate application.'
                });
            });
            gaps.slice(0,3).forEach(g => {
                const skill = (g.skill || g.name || '').trim();
                if (!skill) return;
                        tasks.push({
                    title: `Close gap in ${skill}: draft SOP and run a 5-case test`,
                            pillar: g.pillar || 'Fulfillment',
                    reason: 'Addresses a current weakness with measurable output.'
                });
            });
            if (tasks.length === 0) {
                container.innerHTML = '<div style="color:#6b7280;">No actionable tasks yet. Complete a training first.</div>';
                return;
            }
            container.innerHTML = tasks.slice(0,5).map(t => `
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; background:#ffffff; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:8px;">
                    <div style="min-width:0;">
                        <div style="font-weight:700; color:#0a2a5a;">${t.title}</div>
                        <div style="font-size:12px; color:#6b7280;">${t.pillar} | ${t.reason}</div>
                                </div>
                    <button style="padding:8px 12px; background:#0a2a5a; color:#fff; border:none; border-radius:8px; font-weight:700; font-size:12px;" onclick="createTaskFromSuggestion('${t.title.replace(/'/g, "\\'")}', '${t.pillar}')">Create Task</button>
                </div>
            `).join('');
        }

        async function createTaskFromSuggestion(title, pillar) {
            try {
                const body = { title, description: title, pillar, assignedTo: currentUser };
                const resp = await fetch(`${API_URL}?action=createTask`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
                });
                const data = await resp.json();
                if (data.ok) {
                    showToast('Task created from recommendation', 'success');
                } else {
                    showToast('Failed to create task', 'error');
                }
            } catch (e) {
                showToast('Error creating task', 'error');
            }
        }

        function focusTraining(resourceId) {
            // Scroll to training card and highlight (basic implementation)
            const el = document.querySelector(`[onclick*="openCompletionModal('${resourceId}'"]`);
            if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        }

        function renderKnowledgeProfile(profile) {
            const skillCompetencies = profile.Skill_Competencies ? JSON.parse(profile.Skill_Competencies) : {};
            const topSkillGaps = profile.Top_Skill_Gaps ? JSON.parse(profile.Top_Skill_Gaps) : [];
            
            // Get top 3 skills
            const skills = Object.entries(skillCompetencies)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            const masteryScore = profile.Overall_Mastery_Score || 0;
            const totalTrainings = profile.Total_Trainings_Completed || 0;
            const learningHours = (profile.Total_Learning_Hours || 0).toFixed(1);
            
            const html = `
                <div class="knowledge-profile">
                    <div class="knowledge-header">
                        <div class="knowledge-title">
                            ROSEL's Learning Profile
                        </div>
                        <div style="text-align: center;">
                            <div class="mastery-score">${masteryScore}%</div>
                            <div class="mastery-label">Overall Mastery</div>
                        </div>
                    </div>

                    <div style="font-size: 13px; color: #5f6368; margin-top: -8px; margin-bottom: 12px;">
                        Feedback loop: Watch -> Write learnings -> AI analyzes -> Profile updates.
                    </div>
                    
                    <div class="knowledge-stats">
                        <div class="knowledge-stat">
                            <span class="stat-value">${totalTrainings}</span>
                            <span class="stat-label">Trainings Completed</span>
                        </div>
                        <div class="knowledge-stat">
                            <span class="stat-value">${learningHours}</span>
                            <span class="stat-label">Learning Hours</span>
                        </div>
                        <div class="knowledge-stat">
                            <span class="stat-value">${skills.length}</span>
                            <span class="stat-label">Skills Mastered</span>
                        </div>
                    </div>
                    
                    ${skills.length > 0 ? `
                        <div class="skills-section">
                            <div class="skills-label">Strong Skills</div>
                            <div class="skills-badges">
                                ${skills.map(([skill, score]) => `
                                    <div class="skill-badge strong">
                                        ${skill} <span class="skill-score">${score}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${topSkillGaps.length > 0 ? `
                        <div class="skills-section">
                            <div class="skills-label">Needs Work</div>
                            <div class="skills-badges">
                                ${topSkillGaps.slice(0, 3).map(gap => `
                                    <div class="skill-badge gap">${gap}</div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('knowledgeProfile').innerHTML = html;
            document.getElementById('knowledgeProfile').style.display = 'block';
        }

        // Training Completion Modal Functions
        let currentCompletionResourceId = null;

        function openCompletionModal(resourceId, title) {
            if (!resourceId) return;
            
            currentCompletionResourceId = resourceId;
            
            // Set title if provided, otherwise fetch it
            if (title) {
                document.getElementById('completionModalTitle').textContent = title;
            } else {
                // Try to get title from training resources
                const trainingContainer = document.getElementById('trainingContainer');
                if (trainingContainer) {
                    const resourceEl = trainingContainer.querySelector(`[data-resource-id="${resourceId}"]`);
                    if (resourceEl) {
                        const titleEl = resourceEl.querySelector('.training-title');
                        if (titleEl) {
                            document.getElementById('completionModalTitle').textContent = titleEl.textContent || 'Training Completion Report';
                        }
                    }
                }
            }
            
            const modal = document.getElementById('completionModal');
            if (!modal) return;
            modal.style.display = 'flex';
            
            // Reset form fields
            const conceptField = document.getElementById('conceptLearned');
            const practicalField = document.getElementById('practicalApplication');
            const nextActionsField = document.getElementById('nextActions');
            const challengesField = document.getElementById('challengesQuestions');
            const timeSpentField = document.getElementById('timeSpent');
            
            if (conceptField) conceptField.value = '';
            if (practicalField) practicalField.value = '';
            if (nextActionsField) nextActionsField.value = '';
            if (challengesField) challengesField.value = '';
            if (timeSpentField) timeSpentField.value = '30';
            
            setStarRating(0);
            
            // Setup star rating - attach click handlers directly to each star
            setTimeout(() => {
                const stars = document.querySelectorAll('#starRating .star');
                if (stars.length === 0) return;
                
                stars.forEach((star) => {
                    // Remove any existing handlers
                    star.onclick = null;
                    star.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const rating = parseInt(this.dataset.rating);
                        if (rating >= 1 && rating <= 5) {
                            setStarRating(rating);
                        }
                    }, false);
                    star.style.cursor = 'pointer';
                    star.style.pointerEvents = 'auto';
                });
            }, 50);
        }

        function closeCompletionModal() {
            document.getElementById('completionModal').style.display = 'none';
            // Reset all form fields
            document.getElementById('conceptLearned').value = '';
            document.getElementById('practicalApplication').value = '';
            document.getElementById('nextActions').value = '';
            document.getElementById('challengesQuestions').value = '';
            document.getElementById('timeSpent').value = '30';
            document.querySelectorAll('#starRating .star').forEach(star => {
                star.classList.remove('active');
                star.style.color = '#d1d5db';
                star.style.opacity = '0.3';
            });
            currentCompletionResourceId = null;
        }

        function setStarRating(rating) {
            const stars = document.querySelectorAll('#starRating .star');
            if (stars.length === 0) return;
            
            // Normalize rating
            if (!rating || rating < 1 || rating > 5) {
                rating = 0;
            }
            
            stars.forEach((star) => {
                const starRating = parseInt(star.dataset.rating);
                if (rating > 0 && starRating <= rating) {
                    star.classList.add('active');
                    star.style.color = '#fbbf24';
                    star.style.opacity = '1';
                } else {
                    star.classList.remove('active');
                    star.style.color = '#d1d5db';
                    star.style.opacity = '0.3';
                }
            });
        }

        async function submitTrainingCompletion() {
            const conceptLearned = document.getElementById('conceptLearned').value.trim();
            const practicalApplication = document.getElementById('practicalApplication').value.trim();
            const nextActions = document.getElementById('nextActions').value.trim();
            const challengesQuestions = document.getElementById('challengesQuestions').value.trim();
            const timeSpent = parseInt(document.getElementById('timeSpent').value);
            const rating = document.querySelectorAll('#starRating .star.active').length;
            
            if (!conceptLearned || !practicalApplication || !nextActions) {
                showToast('Please answer questions 1-3 (Question 4 is optional)', 'error');
                return;
            }
            
            if (rating === 0) {
                showToast('Please rate your comprehension', 'error');
                return;
            }
            
            // Combine all responses into structured format
            const structuredNotes = `CONCEPT LEARNED:\n${conceptLearned}\n\nPRACTICAL APPLICATION:\n${practicalApplication}\n\nNEXT ACTIONS:\n${nextActions}${challengesQuestions ? `\n\nCHALLENGES/QUESTIONS:\n${challengesQuestions}` : ''}`;
            
            const completionData = {
                resourceId: currentCompletionResourceId,
                completedBy: currentUser,
                notesLearned: structuredNotes,
                comprehensionRating: rating,
                timeSpentMinutes: timeSpent
            };
            
            try {
                closeCompletionModal();
                showToast('AI is analyzing your learnings...', 'info');
                
                const response = await fetch(`${API_URL}?action=completeTraining`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(completionData)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    // Extract and display AI insights
                    const insights = result.result || result.completion || {};
                    let extractedConcepts = [];
                    let confidenceScore = 0;
                    let knowledgeGaps = [];
                    
                    try {
                        if (insights.AI_Extracted_Concepts) {
                            if (typeof insights.AI_Extracted_Concepts === 'string') {
                                extractedConcepts = JSON.parse(insights.AI_Extracted_Concepts);
                            } else {
                                extractedConcepts = insights.AI_Extracted_Concepts;
                            }
                        }
                        if (insights.AI_Knowledge_Gaps) {
                            if (typeof insights.AI_Knowledge_Gaps === 'string') {
                                knowledgeGaps = JSON.parse(insights.AI_Knowledge_Gaps);
                            } else {
                                knowledgeGaps = insights.AI_Knowledge_Gaps;
                            }
                        }
                        confidenceScore = insights.AI_Confidence_Score || 0;
                    } catch (e) {
                        // Parse error - continue without AI insights
                    }
                    
                    // Show detailed insight modal if we have data
                    if (extractedConcepts.length > 0 || knowledgeGaps.length > 0 || confidenceScore > 0) {
                        showAIInsightModal(extractedConcepts, confidenceScore, knowledgeGaps);
                    }
                    
                    // Show toast with extracted concepts
                    if (extractedConcepts.length > 0) {
                        const conceptList = extractedConcepts.slice(0, 3).join(', ');
                        showToast(`Detected: ${conceptList}${extractedConcepts.length > 3 ? ` +${extractedConcepts.length - 3} more` : ''}`, 'success');
                    } else {
                        showToast('Training completed. Your knowledge profile has been updated.', 'success');
                    }
                    
                    // Reload training resources and knowledge profile
                    setTimeout(() => {
                        loadTrainingResources(true);
                        loadAndDisplayKnowledgeProfile();
                    }, 1000);
                } else {
                    showToast('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error submitting completion: ' + error.message, 'error');
            }
        }

        // Show AI Insight Modal
        function showAIInsightModal(concepts, confidence, gaps) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;';
            
            const conceptHTML = concepts.length > 0 
                ? concepts.map(c => `<div style="padding: 8px 12px; background: #dcfce7; color: #166534; border-radius: 8px; font-weight: 600; font-size: 13px;">${c}</div>`).join('')
                : '<div style="color: #6b7280; font-size: 13px;">AI is still analyzing...</div>';
            
            const gapHTML = gaps && gaps.length > 0
                ? `<div style="margin-top: 16px; padding: 12px; background: #fff7ed; border-left: 3px solid #f59e0b; border-radius: 8px;">
                                        <div style="font-weight: 700; color: #92400e; font-size: 13px; margin-bottom: 8px;">Identified Learning Gaps:</div>
                                        ${gaps.map(g => `<div style="color: #92400e; font-size: 12px; margin: 4px 0;">- ${g}</div>`).join('')}
                  </div>`
                : '';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 520px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;">
                    <div style="padding: 20px 24px; background: linear-gradient(135deg, #00ff88 0%, #00cc6f 100%); border-radius: 16px 16px 0 0;">
                        <h3 style="color: #0a2a5a; font-size: 18px; font-weight: 900; margin: 0;">AI Analysis Complete</h3>
                        <p style="color: rgba(10,42,90,0.8); font-size: 13px; margin: 6px 0 0;">Skills added to your knowledge profile</p>
                    </div>
                    <div style="padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: #0a2a5a; font-size: 14px;">Detected Skills:</div>
                            ${confidence > 0 ? `<div style="background: linear-gradient(135deg, #0a2a5a, #1a4a8a); color: white; padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 13px;">Confidence: ${confidence}%</div>` : ''}
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${conceptHTML}
                        </div>
                        ${gapHTML}
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: #0a2a5a; color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#1a4a8a'" onmouseout="this.style.background='#0a2a5a'">Got it!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                if (modal.parentElement) modal.remove();
            }, 8000);
        }
        
        // Show AI Insight Modal
        function showAIInsightModal(concepts, confidence, gaps) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;';
            
            const conceptHTML = concepts.length > 0 
                ? concepts.map(c => `<div style="padding: 8px 12px; background: #dcfce7; color: #166534; border-radius: 8px; font-weight: 600; font-size: 13px;">${c}</div>`).join('')
                : '<div style="color: #6b7280; font-size: 13px;">AI is still analyzing...</div>';
            
            const gapHTML = gaps && gaps.length > 0
                ? `<div style="margin-top: 16px; padding: 12px; background: #fff7ed; border-left: 3px solid #f59e0b; border-radius: 8px;">
                                        <div style="font-weight: 700; color: #92400e; font-size: 13px; margin-bottom: 8px;">Identified Learning Gaps:</div>
                                        ${gaps.map(g => `<div style="color: #92400e; font-size: 12px; margin: 4px 0;">- ${g}</div>`).join('')}
                  </div>`
                : '';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; max-width: 520px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;">
                    <div style="padding: 20px 24px; background: linear-gradient(135deg, #00ff88 0%, #00cc6f 100%); border-radius: 16px 16px 0 0;">
                        <h3 style="color: #0a2a5a; font-size: 18px; font-weight: 900; margin: 0;">AI Analysis Complete</h3>
                        <p style="color: rgba(10,42,90,0.8); font-size: 13px; margin: 6px 0 0;">Skills added to your knowledge profile</p>
                    </div>
                    <div style="padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: #0a2a5a; font-size: 14px;">Detected Skills:</div>
                            ${confidence > 0 ? `<div style="background: linear-gradient(135deg, #0a2a5a, #1a4a8a); color: white; padding: 6px 12px; border-radius: 8px; font-weight: 800; font-size: 13px;">Confidence: ${confidence}%</div>` : ''}
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${conceptHTML}
                        </div>
                        ${gapHTML}
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 12px; background: #0a2a5a; color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#1a4a8a'" onmouseout="this.style.background='#0a2a5a'">Got it!</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-close after 8 seconds
            setTimeout(() => {
                if (modal.parentElement) modal.remove();
            }, 8000);
        }
        
        // Helper: Get category icon
        function getCategoryIcon(category) {
            const icons = {
                'Foundation': '',
                'Core Skills': '',
                'Advanced': ''
            };
            return icons[category] || '';
        }

        // Filter training resources by mode (recommended/inprogress/all)
        function filterTrainingResources(mode) {
            currentFilterMode = mode;
    
    // Update tab UI
    document.querySelectorAll('.training-filter-tab').forEach(tab => {
        const isActive = tab.dataset.filter === mode;
        tab.classList.toggle('active', isActive);
        if (isActive) {
            tab.style.color = '#0a2a5a';
            tab.style.borderBottomColor = '#0a2a5a';
        } else {
            tab.style.color = '#6b7280';
            tab.style.borderBottomColor = 'transparent';
        }
    });
    
    // Filter training grid items
    const trainingItems = document.querySelectorAll('.training-card');
    trainingItems.forEach(item => {
        const resourceId = item.dataset.resourceId;
        let shouldShow = false;
        
        if (mode === 'all') {
            shouldShow = true;
        } else if (mode === 'recommended') {
            shouldShow = recommendedResourceIds.includes(resourceId);
        } else if (mode === 'inprogress') {
            // In progress = has completions but not fully mastered
            const isCompleted = item.querySelector('.training-completed-badge') !== null;
            shouldShow = isCompleted;
        }
        
        item.classList.toggle('hidden', !shouldShow);
    });

    // Show empty state if no items visible
    const visibleCount = document.querySelectorAll('.training-card:not(.hidden)').length;
    const container = document.querySelector('.training-grid');
    
    // Remove existing empty message if any
    const existingMsg = document.getElementById('trainingEmptyMsg');
    if (existingMsg) existingMsg.remove();
    
    if (visibleCount === 0 && container) {
        const emptyMsg = document.createElement('div');
        emptyMsg.id = 'trainingEmptyMsg';
        emptyMsg.className = 'empty-state';
        emptyMsg.style.gridColumn = '1 / -1';
        emptyMsg.style.padding = '40px';
        
        if (mode === 'recommended') {
            emptyMsg.innerHTML = '<div class="empty-icon">i</div><div class="empty-text">No specific recommendations yet.<br>Check out "All Training" to get started!</div>';
        } else if (mode === 'inprogress') {
            emptyMsg.innerHTML = '<div class="empty-icon"></div><div class="empty-text">No training history found.<br>Start a course from the "All" tab.</div>';
        } else {
            emptyMsg.innerHTML = '<div class="empty-icon">i</div><div class="empty-text">No training resources found.</div>';
        }
        container.appendChild(emptyMsg);
    }
}

// Fetch recommendations from Analytics API and update counts
async function loadRecommendationsForFilter() {
    if (!currentUser) return;
    
    try {
        // Use vaKnowledgeProfile endpoint instead of missing recommendations endpoint
        const response = await fetch(`${API_URL}?action=vaKnowledgeProfile&vaName=${encodeURIComponent(currentUser)}`);
        const data = await response.json();
        
        if (data.ok && data.vaKnowledgeProfile) {
            const profile = data.vaKnowledgeProfile;
            const raw = profile.Recommended_Trainings || '[]';
            const recommendations = safeParseJSON(raw, []);
            
            // Extract Resource_IDs from recommendations
            recommendedResourceIds = recommendations
                .filter(r => r.resourceId)
                .map(r => r.resourceId);
            
            // Update recommended count
            document.getElementById('recommendedCount').textContent = recommendedResourceIds.length;
        }
    } catch (error) {
    }
}

        // Load Training Resources
        async function loadTrainingResources(silent = false) {
            const container = document.getElementById('trainingContainer');
            
            // Only show spinner on initial load
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=training`);
                const data = await response.json();
                
                if (data.ok) {
                    const resources = data.training || data.resources || [];
                    allTrainingResources = resources; // Store globally for filtering
                    
                    if (resources.length > 0) {
                        renderTrainingResources(resources);
                        loadAndDisplayKnowledgeProfile(); // Load VA's knowledge profile
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon"></div>
                                <div class="empty-text">No training resources yet. Click "Manage Training" to add your first resource!</div>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">!</div>
                            <div class="empty-text" style="color: var(--danger);">Error: ${data.error || 'Failed to load training resources'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">!</div>
                        <div class="empty-text" style="color: var(--danger);">Error loading training resources. Check console for details.</div>
                    </div>
                `;
            }
        }

        // Toggle Admin Panel
        function toggleAdminPanel() {
            const panel = document.getElementById('trainingAdminPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                loadAdminTrainingList();
            }
        }

        // Load Admin Training List
        async function loadAdminTrainingList() {
            const container = document.getElementById('adminTrainingList');
            container.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch(`${API_URL}?action=training`);
                const data = await response.json();
                
                if (data.ok) {
                    const resources = data.training || [];
                    if (resources.length === 0) {
                        container.innerHTML = '<p style="color: #666;">No training resources yet.</p>';
                        return;
                    }
                    
                    const html = resources.map(resource => `
                        <div style="padding: 20px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 16px; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);">
                            <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                        <h4 style="color: var(--cobalt); font-size: 16px; font-weight: 700; margin: 0;">${resource.Title}</h4>
                                        <span style="background: #f3f4f6; color: #4b5563; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${resource.Type}</span>
                                    </div>
                                    
                                    <div style="display: flex; gap: 12px; font-size: 13px; color: #6b7280; margin-bottom: 10px;">
                                        <span>${getCategoryIcon(resource.Category)} ${resource.Category}</span>
                                        <span>&bull;</span>
                                        <span>${resource.Difficulty_Level || 'BEGINNER'}</span>
                                        <span>&bull;</span>
                                        <span>${resource.Estimated_Minutes || '?'} min</span>
                                    </div>
                                    
                                    <p style="font-size: 14px; color: #4b5563; margin-bottom: 12px; line-height: 1.5;">${resource.Description || 'No description'}</p>
                                    
                                    <a href="${resource.URL}" target="_blank" style="font-size: 13px; color: var(--azure); font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                                        View Resource <span>></span>
                                    </a>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 8px; min-width: 100px;">
                                    <button onclick="editTraining('${resource.Resource_ID}')" class="btn" style="padding: 8px 16px; font-size: 13px; background: white; color: var(--azure); border: 1px solid var(--azure); width: 100%; justify-content: center; border-radius: 8px; font-weight: 600;">
                                        Edit
                                    </button>
                                    <button onclick="deleteTraining('${resource.Resource_ID}', '${resource.Title}')" class="btn" style="padding: 8px 16px; font-size: 13px; background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; width: 100%; justify-content: center; border-radius: 8px; font-weight: 600;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                container.innerHTML = '<p style="color: var(--danger);">Error loading training list</p>';
                console.error(error);
            }
        }

        // Get Category Icon
        function getCategoryIcon(category) {
            const icons = {
                'Onboarding': '',
                'Safety': '',
                'Technical': '',
                'Product': '',
                'Customer Service': '',
                'Tools': '',
                'Troubleshooting': '',
                'Business': '',
                'Home2Smart': ''
            };
            return icons[category] || '';
        }

        // Submit New Training
        async function submitNewTraining(event) {
            event.preventDefault();
            
            // Ensure API_URL is available
            const endpoint = (typeof API_URL !== 'undefined') ? API_URL : `${DEFAULT_API_HOST}/api/v1`;

            const formData = {
                title: document.getElementById('newTrainingTitle').value,
                type: 'Video', // Always video for now
                url: document.getElementById('newTrainingURL').value,
                description: document.getElementById('newTrainingDescription').value || null,
                category: document.getElementById('newTrainingCategory').value,
                difficultyLevel: 'BEGINNER', // Default
                estimatedMinutes: parseInt(document.getElementById('newTrainingDuration').value) || null,
                skillsTaught: null, // Will be extracted by AI
                order: 0,
                createdBy: 'Tabari'
            };
            
            try {
                showToast('\ud83d\udce4 Uploading training video...', 'info');
                
                const response = await fetch(`${endpoint}?action=createTraining`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showToast('\u2705 Training uploaded successfully!', 'success');
                    document.getElementById('newTrainingForm').reset();
                    loadAdminTrainingList();
                    loadTrainingResources(true); // Refresh main view
                } else {
                    showToast(`\u274c Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast('\u274c Failed to upload training', 'error');
                console.error(error);
            }
        }

        // Delete Training
        async function deleteTraining(resourceId, title) {
            if (!confirm(`Are you sure you want to delete "${title}"? This will also delete all completion records.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}?action=deleteTraining`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ resourceId })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    showToast('Training resource deleted', 'success');
                    loadAdminTrainingList();
                    loadTrainingResources(true);
                } else {
                    showToast(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast('Failed to delete training resource', 'error');
                console.error(error);
            }
        }

        // Edit Training (TODO: Add edit modal)
        function editTraining(resourceId) {
            showToast('Edit functionality coming soon! For now, delete and recreate.', 'info');
        }



        // Filter Training by Tier
        let allTrainingResources = [];

        function filterTrainingByTier(tier) {
            // Update active button
            document.querySelectorAll('.tier-btn').forEach(btn => {
                if (btn.dataset.tier === tier) {
                    btn.style.background = 'linear-gradient(135deg, var(--azure) 0%, #667eea 100%)';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'var(--azure)';
                    btn.style.boxShadow = '0 4px 15px rgba(20, 147, 255, 0.3)';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = 'var(--cobalt)';
                    btn.style.borderColor = '#e0e0e0';
                    btn.style.boxShadow = 'none';
                }
            });

            // Map tiers to specific categories found in data
            // Foundation (Build): Business basics, systems, ops
            // Core Skills (Work): Marketing, offers, customer work
            // Advanced (Launch): Tech skills, AI
            const tierMapping = {
                'Foundation': ['Operations', 'Home2Smart', 'Business', 'Onboarding', 'Admin', 'Foundation'],
                'Core Skills': ['Marketing', 'CRM', 'Sales', 'Customer Service', 'Hiring Process', 'Fulfillment', 'Core Skills'],
                'Advanced': ['Technical', 'Web Design', 'AI', 'Automation', 'Development', 'Advanced']
            };

            // Filter resources
            if (tier === 'all') {
                renderTrainingResources(allTrainingResources);
            } else {
                const allowed = tierMapping[tier] || [tier];
                const filtered = allTrainingResources.filter(r => {
                     const cat = (r.Category || 'General');
                     // Match exact category OR if category contains the keyword (e.g. "Technical Skills" matches "Technical")
                     return allowed.includes(cat) || allowed.some(a => cat.indexOf(a) !== -1);
                });
                renderTrainingResources(filtered);
            }
        }

        // Load and Display Knowledge Profile
        async function loadAndDisplayKnowledgeProfile() {
            try {
                const response = await fetch(`${API_URL}?action=trainingCompletions&vaName=ROSEL`);
                const data = await response.json();
                
                if (data.ok && data.trainingCompletions) {
                    const completions = data.trainingCompletions;
                    
                    if (completions.length === 0) {
                        document.getElementById('knowledgeProfileCard').style.display = 'none';
                        return;
                    }

                    // Calculate stats
                    const totalTrainings = completions.length;
                    const totalMinutes = completions.reduce((sum, c) => sum + (c.Time_Spent_Minutes || 0), 0);
                    const learningHours = (totalMinutes / 60).toFixed(1);

                    // Update minimal stats
                    document.getElementById('totalTrainings').textContent = totalTrainings;
                    document.getElementById('learningHours').textContent = `${learningHours}h`;

                    // Show the profile card
                    document.getElementById('knowledgeProfileCard').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading knowledge profile:', error);
            }
        }

        // Load Tasks
        async function loadTasks(silent = false) {
            const container = document.getElementById('tasksContainer');
            
            // Only show spinner on initial load
            if (!silent) {
                container.innerHTML = '<div class="spinner"></div>';
            }
            
            try {
                const response = await fetch(`${API_URL}?action=tasks`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.ok) {
                    const tasks = data.tasks || [];
                    if (tasks.length > 0) {
                        renderTasks(tasks);
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-text">No tasks yet. Add tasks to the Tasks sheet.</div>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-text" style="color: var(--danger);">Error: ${data.error || 'Failed to load tasks'}</div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-text" style="color: var(--danger);">Error: ${error.message}</div>
                    </div>
                `;
            }
        }

        // Store tasks globally for modal access
        let currentTasks = [];

        function renderTasks(tasks) {
            currentTasks = tasks;

            const parseMaybeLocalDate = (dateStr) => {
                if (!dateStr) return null;
                const s = String(dateStr).trim();
                const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (m) {
                    const y = parseInt(m[1], 10);
                    const mo = parseInt(m[2], 10) - 1;
                    const d = parseInt(m[3], 10);
                    const dt = new Date(y, mo, d);
                    return isNaN(dt.getTime()) ? null : dt;
                }
                const dt = new Date(s);
                return isNaN(dt.getTime()) ? null : dt;
            };
            
            // Split tasks into To Do and Done
            const now = new Date();
            const todoTasks = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() !== 'COMPLETED');
            let doneTasks = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() === 'COMPLETED');
            // Client-side retention pruning based on Retention_Days
            doneTasks = doneTasks.filter(t => {
                const days = parseInt(t.Retention_Days || t.retentionDays || '7', 10);
                const completedAt = t.Completed_At || t.completedAt || t.Completed_Date || t.completedDate;
                if (!completedAt) return true; // keep if no timestamp
                const completedDate = parseMaybeLocalDate(completedAt);
                if (!completedDate) return true;
                const diffDays = Math.floor((now - completedDate) / (1000 * 60 * 60 * 24));
                return diffDays <= days;
            });
            
            const html = `
                <div class="tasks-columns">
                    <div class="tasks-column">
                        <div class="tasks-column-header">
                            <span>To Do</span>
                            <span class="tasks-column-count">${todoTasks.length}</span>
                        </div>
                        <div class="tasks-grid">
                            ${todoTasks.length === 0 ? `
                                <div class="empty-state" style="padding: 40px 20px;">
                                    <div class="empty-icon">OK</div>
                                    <div class="empty-text">All caught up!</div>
                                </div>
                            ` : todoTasks.map(task => renderTaskCard(task)).join('')}
                        </div>
                    </div>
                    <div class="tasks-column">
                        <div class="tasks-column-header">
                            <span>Done</span>
                            <span class="tasks-column-count">${doneTasks.length}</span>
                        </div>
                        <div class="tasks-grid">
                            ${doneTasks.length === 0 ? `
                                <div class="empty-state" style="padding: 40px 20px;">
                                    <div class="empty-icon">i</div>
                                    <div class="empty-text">No completed tasks yet</div>
                                </div>
                            ` : doneTasks.map(task => renderTaskCard(task)).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('tasksContainer').innerHTML = html;
        }

        function renderTaskCard(task) {
            // Determine actual type from data
            let type = 'LINK';
            if (task.Content && task.Content.trim()) {
                type = 'TEXT';
            } else if (task.URL && (task.URL.includes('docs.google.com') || task.URL.includes('drive.google.com'))) {
                type = 'DOCUMENT';
            } else if (task.URL) {
                type = 'LINK';
            }
            
            const status = (task.Status || 'PENDING').toUpperCase();
            
            // Handle Priority as either string or number
            let priority = task.Priority || 2;
            if (typeof priority === 'number') {
                priority = priority === 1 ? 'HIGH' : priority === 2 ? 'MEDIUM' : 'LOW';
            }
            priority = String(priority).toUpperCase();
            
            const priorityClass = `priority-${priority.toLowerCase()}`;
            const statusClass = `status-${status.toLowerCase().replace(' ', '-')}`;
            const priorityBadgeClass = `priority-${priority.toLowerCase()}-badge`;
            
            // Build footer metadata
            const footerItems = [];
            if (task.Assigned_To) footerItems.push(`Assigned: ${task.Assigned_To}`);
            if (task.Due_Date) footerItems.push(`Due: ${formatDate(task.Due_Date)}`);
            if (task.Completed_At) footerItems.push(`Done: ${formatDate(task.Completed_At)}`);
            
            return `
                <div class="task-card ${priorityClass} ${statusClass}" onclick="openTaskModal('${task.Task_ID}')">
                    <div class="task-header">
                        <div style="flex: 1;">
                            <div class="task-title">${task.Title || task.title || 'Untitled Task'}</div>
                            ${task.Category ? `<span class="task-category" style="margin-top: 6px;">${task.Category}</span>` : ''}
                        </div>
                        <span class="task-priority-badge ${priorityBadgeClass}">${priority}</span>
                    </div>
                    ${task.Description ? `<div class="task-description" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${task.Description.substring(0, 100)}${task.Description.length > 100 ? '...' : ''}</div>` : ''}
                    ${footerItems.length > 0 ? `
                    <div class="task-footer" style="margin-top: 12px; padding-top: 12px;">
                        <div class="task-meta">
                            ${footerItems.join(' | ')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function openTaskModal(taskId) {
            const task = currentTasks.find(t => t.Task_ID === taskId);
            if (!task) return;
            
            // Determine actual type from data
            let type = 'LINK';
            if (task.Content && task.Content.trim()) {
                type = 'TEXT';
            } else if (task.URL && (task.URL.includes('docs.google.com') || task.URL.includes('drive.google.com'))) {
                type = 'DOCUMENT';
            } else if (task.URL) {
                type = 'LINK';
            }
            
            const status = (task.Status || 'PENDING').toUpperCase();
            
            // Handle Priority as either string or number
            let priority = task.Priority || 2;
            if (typeof priority === 'number') {
                priority = priority === 1 ? 'HIGH' : priority === 2 ? 'MEDIUM' : 'LOW';
            }
            priority = String(priority).toUpperCase();
            
            const priorityBadgeClass = `priority-${priority.toLowerCase()}-badge`;
            const isCompleted = status === 'COMPLETED';
            
            // Set title and badges
            document.getElementById('modalTaskTitle').textContent = task.Title || task.title || 'Untitled Task';
            document.getElementById('modalTaskBadges').innerHTML = `
                <span class="task-priority-badge ${priorityBadgeClass}">${priority}</span>
                ${task.Category ? `<span class="task-category">${task.Category}</span>` : ''}
            `;
            
            // Set description
            document.getElementById('modalTaskDescription').innerHTML = task.Description ? task.Description.replace(/\n/g, '<br>') : '';
            
            // Set content based on type
            let content = '';
            if (type === 'DOCUMENT' && task.URL) {
                let embedUrl = task.URL;
                if (task.URL.includes('/view')) {
                    embedUrl = task.URL.replace('/view', '/preview');
                } else if (task.URL.includes('/edit')) {
                    embedUrl = task.URL.replace('/edit', '/preview');
                }
                content = `
                    <iframe 
                        src="${embedUrl}" 
                        frameborder="0"
                        class="task-embed">
                    </iframe>
                    <a href="${task.URL}" target="_blank" class="task-link-btn" style="margin-top: 12px;">Open in New Tab</a>
                `;
            } else if (type === 'LINK' && task.URL) {
                content = `<a href="${task.URL}" target="_blank" class="task-link-btn">Open ${task.Category || 'Link'}</a>`;
            } else if (type === 'TEXT' && task.Content) {
                content = `<div class="task-content">${task.Content}</div>`;
            }
            
            // Add metadata
            const footerItems = [];
            if (task.Assigned_To) footerItems.push(`Assigned to: ${task.Assigned_To}`);
            if (task.Due_Date) footerItems.push(`Due: ${formatDate(task.Due_Date)}`);
            if (task.Completed_At) footerItems.push(`Completed: ${formatDate(task.Completed_At)}`);
            
            if (footerItems.length > 0) {
                content += `<div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid var(--border); color: #5f6368; font-size: 14px;">${footerItems.join(' | ')}</div>`;
            }
            
            document.getElementById('modalTaskContent').innerHTML = content;
            
            // Set action button
            const actionBtn = document.getElementById('modalTaskAction');
            if (isCompleted) {
                actionBtn.textContent = 'Mark as To Do';
                actionBtn.className = 'task-action-btn task-uncomplete-btn';
                actionBtn.onclick = () => toggleTaskStatus(taskId, false);
            } else {
                actionBtn.textContent = 'Mark as Done';
                actionBtn.className = 'task-action-btn task-complete-btn';
                actionBtn.onclick = () => toggleTaskStatus(taskId, true);
            }

            // Add Refine Button
            const actionsContainer = document.querySelector('#taskModal .task-modal-actions');
            let refineBtn = document.getElementById('modalRefineBtn');
            if (!refineBtn) {
                refineBtn = document.createElement('button');
                refineBtn.id = 'modalRefineBtn';
                refineBtn.className = 'btn-magic';
                refineBtn.style.marginRight = 'auto'; // Push to left
                refineBtn.innerHTML = 'Clarify with AI';
                actionsContainer.insertBefore(refineBtn, actionsContainer.firstChild);
            }
            refineBtn.style.display = 'inline-flex'; // Ensure visible
            refineBtn.onclick = () => openRefineInput(taskId);
            
            // CLEANUP: Remove any stale refine containers from previous opens
            const staleContainer = document.getElementById('refineContainer');
            if (staleContainer) staleContainer.remove();

            // Show modal
            document.getElementById('taskModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function openRefineInput(taskId) {
            const descEl = document.getElementById('modalTaskDescription');
            
            // Double check cleanup
            const existing = document.getElementById('refineContainer');
            if (existing) existing.remove();

            // Create input area
            const container = document.createElement('div');
            container.id = 'refineContainer';
            container.style.marginTop = '20px';
            container.style.padding = '20px';
            container.style.background = '#ffffff';
            container.style.borderRadius = '12px';
            container.style.border = '2px solid #e0e0e0';
            container.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label class="form-label" style="color: #202124; margin: 0;">What needs clarification?</label>
                    <button onclick="closeRefineInput()" style="background:none; border:none; cursor:pointer; font-size: 18px; color: #5f6368;">X</button>
                </div>
                <textarea id="refineFeedback" class="form-textarea" 
                    style="min-height: 120px; margin-bottom: 16px; font-family: inherit; line-height: 1.5; resize: vertical; overflow-y: auto;" 
                    placeholder="e.g. 'She thinks this is about X, but it's about Y. Mention that she needs to check the Z folder.'"></textarea>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="closeRefineInput()" style="padding: 10px 20px;">Cancel</button>
                    <button class="btn-magic" onclick="submitRefineTask('${taskId}')" style="margin: 0; padding: 10px 20px;">Update Task</button>
                </div>
            `;
            
            // Insert after description
            descEl.parentNode.insertBefore(container, descEl.nextSibling);
            document.getElementById('refineFeedback').focus();
            
            // Hide the main refine button temporarily
            document.getElementById('modalRefineBtn').style.display = 'none';
        }

        function closeRefineInput() {
            const container = document.getElementById('refineContainer');
            if (container) container.remove();
            const btn = document.getElementById('modalRefineBtn');
            if (btn) btn.style.display = 'inline-flex';
        }

        async function submitRefineTask(taskId) {
            const feedback = document.getElementById('refineFeedback').value;
            if (!feedback) return;
            
            const btn = document.querySelector('#refineContainer .btn-magic');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Refining...';
            btn.disabled = true;
            
            try {
                const response = await fetch(`${API_URL}?action=refineExistingTask&taskId=${encodeURIComponent(taskId)}&feedback=${encodeURIComponent(feedback)}`);
                const result = await response.json();
                
                if (result.ok) {
                    // Update UI immediately
                    document.getElementById('modalTaskDescription').innerHTML = result.newDescription.replace(/\n/g, '<br>');
                    closeRefineInput(); // Use the cleanup function
                    showToast('Task clarified and updated!', 'success');
                    
                    // Reload tasks in background
                    loadTasks(true);
                } else {
                    showToast('Error: ' + result.error, 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function closeTaskModal(event) {
            if (event && event.target !== event.currentTarget) return;
            
            // CLEANUP: Ensure refine container is gone when closing modal
            closeRefineInput();
            
            document.getElementById('taskModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        async function toggleTaskStatus(taskId, markComplete) {
            const newStatus = markComplete ? 'COMPLETED' : 'PENDING';

            const parseMaybeLocalDate = (dateStr) => {
                if (!dateStr) return null;
                const s = String(dateStr).trim();
                const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (m) {
                    const y = parseInt(m[1], 10);
                    const mo = parseInt(m[2], 10) - 1;
                    const d = parseInt(m[3], 10);
                    const dt = new Date(y, mo, d);
                    return isNaN(dt.getTime()) ? null : dt;
                }
                const dt = new Date(s);
                return isNaN(dt.getTime()) ? null : dt;
            };
            
            try {
                const response = await fetch(
                    `${API_URL}?action=updateTaskStatus&taskId=${encodeURIComponent(taskId)}&status=${newStatus}`,
                    { method: 'GET' }
                );
                
                const result = await response.json();
                
                if (result.ok) {
                    // If the task was a recurring one and just completed, create the next instance client-side
                    try {
                        const task = currentTasks.find(t => t.Task_ID === taskId);
                        if (markComplete && task && (task.Recurrence || task.recurrence)) {
                            const recur = (task.Recurrence || task.recurrence || 'none').toLowerCase();
                            if (recur === 'daily' || recur === 'weekly') {
                                const due = parseMaybeLocalDate(task.Due_Date || task.dueDate) || new Date();
                                const nextDue = new Date(due);
                                nextDue.setDate(due.getDate() + (recur === 'daily' ? 1 : 7));
                                const payload = {
                                    title: task.Title,
                                    description: task.Description,
                                    priority: task.Priority,
                                    dueDate: nextDue.toISOString().slice(0,10),
                                    recurrence: recur,
                                    retentionDays: task.Retention_Days || task.retentionDays || 7
                                };
                                // Fire-and-forget create next task; do not block UI
                                fetch(`${API_URL}?action=addTask`, { method: 'POST', body: JSON.stringify(payload) })
                                    .then(() => loadTasks(true))
                                    .catch(() => {});
                            }
                        }
                    } catch (_) { /* noop */ }

                    closeTaskModal();
                    loadTasks(true); // Silent reload - no spinner
                    showToast(`Task marked as ${markComplete ? 'completed' : 'pending'}`, 'success');
                } else {
                    showToast('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error updating task: ' + error, 'error');
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTaskModal();
            }
        });

        // Force background color after GoHighLevel scripts load
        function enforceBackground() {
            document.documentElement.style.setProperty('background', '#0a2a5a', 'important');
            document.documentElement.style.setProperty('background-color', '#0a2a5a', 'important');
            document.body.style.setProperty('background', '#0a2a5a', 'important');
            document.body.style.setProperty('background-color', '#0a2a5a', 'important');
        }
        
        // Run immediately and on DOMContentLoaded
        enforceBackground();
        document.addEventListener('DOMContentLoaded', enforceBackground);
        
        // Watch for DOM mutations that might override styles
        const observer = new MutationObserver(enforceBackground);
        observer.observe(document.documentElement, { 
            attributes: true, 
            attributeFilter: ['style', 'class'],
            subtree: false 
        });
        observer.observe(document.body, { 
            attributes: true, 
            attributeFilter: ['style', 'class'],
            subtree: false 
        });
        
        // Also run after a delay to catch async script injections
        setTimeout(enforceBackground, 100);
        setTimeout(enforceBackground, 500);
        setTimeout(enforceBackground, 1000);

        /* ===== GHL PARENT CONTAINER CONSTRAINT NEUTRALIZER ===== */
        function neutralizeGHLConstraints() {
            const app = document.getElementById('h2s-app');
            if (!app) return;

            // Ensure app itself expands
            app.style.setProperty('width', '100%', 'important');
            app.style.setProperty('max-width', 'none', 'important');
            app.style.setProperty('margin-left', '0', 'important');
            app.style.setProperty('margin-right', '0', 'important');
            app.style.setProperty('display', 'block', 'important');

            // Walk up the DOM tree and neutralize parent constraints
            let parent = app.parentElement;
            let depth = 0;
            const maxDepth = 10; // Safety limit

            while (parent && parent !== document.body && depth < maxDepth) {
                // Check for width constraints
                const computedStyle = window.getComputedStyle(parent);
                const maxWidth = computedStyle.maxWidth;
                const width = computedStyle.width;

                // If parent has a max-width that's not 'none', neutralize it
                if (maxWidth && maxWidth !== 'none' && maxWidth !== '100%') {
                    parent.style.setProperty('max-width', 'none', 'important');
                }

                // If parent has a fixed width that's constraining, override it
                if (width && width !== 'auto' && width !== '100%' && !width.includes('calc')) {
                    // Only override if it's a pixel value that seems constraining
                    if (width.includes('px')) {
                        const pxValue = parseInt(width);
                        if (pxValue < window.innerWidth * 0.9) {
                            parent.style.setProperty('width', '100%', 'important');
                        }
                    }
                }

                // Override any centering margins that create narrow columns
                const marginLeft = computedStyle.marginLeft;
                const marginRight = computedStyle.marginRight;
                if (marginLeft === 'auto' && marginRight === 'auto') {
                    parent.style.setProperty('margin-left', '0', 'important');
                    parent.style.setProperty('margin-right', '0', 'important');
                }

                parent = parent.parentElement;
                depth++;
            }

            // Ensure pipeline containers expand (only set width, never display)
            const pipelinePane = document.getElementById('pipeline-pane');
            if (pipelinePane) {
                // Only set width properties, never touch display
                pipelinePane.style.setProperty('width', '100%', 'important');
                pipelinePane.style.setProperty('max-width', '100%', 'important');
                // Explicitly do NOT set display - let CSS .pane.active handle it
            }

            const pipeline = document.querySelector('#h2s-app .pipeline');
            if (pipeline) {
                pipeline.style.setProperty('width', '100%', 'important');
                pipeline.style.setProperty('max-width', '100%', 'important');
            }

            const appMain = document.querySelector('#h2s-app .app-main');
            if (appMain) {
                appMain.style.setProperty('width', 'calc(100% - 240px)', 'important');
                appMain.style.setProperty('max-width', 'none', 'important');
            }

            const appContent = document.querySelector('#h2s-app .app-content');
            if (appContent) {
                appContent.style.setProperty('width', '100%', 'important');
                appContent.style.setProperty('max-width', 'none', 'important');
            }

            // DO NOT touch pane display - let CSS handle it via .active class
            // This ensures tab switching works correctly
        }

        // Run immediately and on DOM ready
        neutralizeGHLConstraints();
        document.addEventListener('DOMContentLoaded', neutralizeGHLConstraints);

        // Watch for DOM mutations (GHL might inject containers dynamically)
        // But exclude pane elements to avoid interfering with tab switching
        const constraintObserver = new MutationObserver((mutations) => {
            // Only run if the mutation doesn't involve pane elements
            const hasPaneMutation = mutations.some(mutation => {
                if (mutation.target.classList && mutation.target.classList.contains('pane')) {
                    return true;
                }
                if (mutation.target.closest && mutation.target.closest('.pane')) {
                    return true;
                }
                return false;
            });
            
            if (!hasPaneMutation) {
                neutralizeGHLConstraints();
            }
        });
        constraintObserver.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });

        // Also run after delays to catch late injections
        setTimeout(neutralizeGHLConstraints, 100);
        setTimeout(neutralizeGHLConstraints, 500);
        setTimeout(neutralizeGHLConstraints, 1000);
        setTimeout(neutralizeGHLConstraints, 2000);

        /* ===== ADMIN DASHBOARD ===== */
        const bugReportsUI = {
            cache: { reports: [], meta: null, digest: null, lastUpdated: null },

            getCurrentTab() {
                try {
                    const active = document.querySelector('.app-sidebar-nav-item.active');
                    const tab = active?.getAttribute('data-tab') || '';
                    return tab || (localStorage.getItem('h2s_active_tab') || '').trim();
                } catch {
                    return '';
                }
            },

            getAdminToken() {
                try {
                    // Use the same shared admin credential as the Admin gate / Proof Packs.
                    const token = (localStorage.getItem(ADMIN_CREDENTIAL_KEY) || '').trim();
                    return token;
                } catch {
                    return '';
                }
            },

            getBrowserString() {
                try {
                    return navigator.userAgent || '';
                } catch {
                    return '';
                }
            },

            getBuildIdBestEffort() {
                try {
                    // Best-effort: admin area already knows how to probe backend build id.
                    const status = document.getElementById('ppConnStatus');
                    const text = String(status?.textContent || '');
                    const m = text.match(/build:\s*([^\u2022]+)\s*(?:\u2022|$)/i);
                    return m ? m[1].trim() : '';
                } catch {
                    return '';
                }
            },

            setCache(payload) {
                try {
                    if (payload) {
                        this.cache.reports = payload.reports || [];
                        this.cache.meta = payload.meta || null;
                        this.cache.lastUpdated = new Date().toISOString();
                    }
                } catch {
                    // ignore
                }
            },

            setDigest(digestData) {
                try {
                    this.cache.digest = digestData || null;
                } catch {
                    // ignore
                }
            },

            openReportModal() {
                const tab = this.getCurrentTab();
                const pagePath = (typeof location !== 'undefined') ? String(location.pathname || '') : '';
                const url = (typeof location !== 'undefined') ? String(location.href || '') : '';
                const submittedBy = String(currentUser || '').trim().toUpperCase() || 'UNKNOWN';

                const html = `
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <div style="font-size:13px; color:#6b7280;">Quickly report glitches or broken flows. This goes straight into the admin dashboard.</div>

                        <div style="display:grid; grid-template-columns:1fr 160px; gap:12px; align-items:start;">
                            <div style="min-width:0;">
                                <div style="font-size:12px; font-weight:800; color: var(--cobalt); margin-bottom:6px;">What broke? <span style="color:#ef4444;">*</span></div>
                                <input id="bugReportTitle" type="text" placeholder="Short title (e.g., Offer Builder stepper overlaps on Safari)" style="width:100%; height:42px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; box-sizing:border-box;" />
                            </div>
                            <div>
                                <div style="font-size:12px; font-weight:800; color: var(--cobalt); margin-bottom:6px;">Severity</div>
                                <select id="bugReportSeverity" style="width:100%; height:42px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; background:#fff;">
                                    <option value="LOW">Low</option>
                                    <option value="MEDIUM" selected>Medium</option>
                                    <option value="HIGH">High</option>
                                    <option value="CRITICAL">Critical</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <div style="font-size:12px; font-weight:800; color: var(--cobalt); margin-bottom:6px;">Details <span style="color:#ef4444;">*</span></div>
                            <textarea id="bugReportDescription" placeholder="What happened? What did you click? Any errors you saw?" style="width:100%; min-height:120px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; box-sizing:border-box; resize:vertical;"></textarea>
                        </div>

                        <details style="border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px; background:#fafafa;">
                            <summary style="cursor:pointer; font-weight:800; color: var(--cobalt);">Optional: steps + expected/actual</summary>
                            <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;">
                                <textarea id="bugReportSteps" placeholder="Steps to reproduce" style="width:100%; min-height:80px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; box-sizing:border-box; resize:vertical;"></textarea>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                    <textarea id="bugReportExpected" placeholder="Expected" style="width:100%; min-height:70px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; box-sizing:border-box; resize:vertical;"></textarea>
                                    <textarea id="bugReportActual" placeholder="Actual" style="width:100%; min-height:70px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; box-sizing:border-box; resize:vertical;"></textarea>
                                </div>
                            </div>
                        </details>

                        <div style="display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-top:6px;">
                            <button type="button" onclick="closeModal();" style="padding:10px 14px; border:1px solid #e5e7eb; background:#fff; color:#374151; border-radius:10px; font-weight:800; cursor:pointer;">Cancel</button>
                            <button type="button" onclick="bugReportsUI.submitReport();" style="padding:10px 14px; border:1px solid var(--azure); background:var(--azure); color:#fff; border-radius:10px; font-weight:900; cursor:pointer;">Send report</button>
                        </div>

                        <div style="font-size:11px; color:#6b7280; margin-top:2px;">Context captured: user=${submittedBy}, tab=${tab || 'unknown'}, path=${pagePath || 'unknown'}</div>
                    </div>
                `;

                showModal('Report a bug', html, { width: '760px', hideConfirm: true, hideActions: true });

                // Don't prefill anything - let user type clean titles
                setTimeout(() => {
                    const titleEl = document.getElementById('bugReportTitle');
                    const descEl = document.getElementById('bugReportDescription');
                    if (titleEl) titleEl.focus();
                }, 0);
            },

            async submitReport() {
                const title = String(document.getElementById('bugReportTitle')?.value || '').trim();
                const description = String(document.getElementById('bugReportDescription')?.value || '').trim();
                const steps = String(document.getElementById('bugReportSteps')?.value || '').trim();
                const expected = String(document.getElementById('bugReportExpected')?.value || '').trim();
                const actual = String(document.getElementById('bugReportActual')?.value || '').trim();
                const severity = String(document.getElementById('bugReportSeverity')?.value || 'MEDIUM').trim();

                if (!title || !description) {
                    showToast('Title + Details are required', 'error');
                    return;
                }

                const payload = {
                    submittedBy: String(currentUser || '').trim().toUpperCase() || 'UNKNOWN',
                    title,
                    description,
                    steps,
                    expected,
                    actual,
                    severity,
                    tab: this.getCurrentTab(),
                    pagePath: (typeof location !== 'undefined') ? String(location.pathname || '') : '',
                    url: (typeof location !== 'undefined') ? String(location.href || '') : '',
                    buildId: this.getBuildIdBestEffort(),
                    browser: this.getBrowserString()
                };

                // Show loading feedback
                const submitBtn = event?.target?.closest('button') || document.querySelector('button[onclick*="submitReport"]');
                const originalText = submitBtn ? submitBtn.textContent : '';
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                    submitBtn.style.opacity = '0.6';
                    submitBtn.style.cursor = 'wait';
                }

                try {
                    const res = await fetch(`${API_URL}?action=bug_report_submit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok || !data?.ok) {
                        const msg = data?.error || `Failed (${res.status})`;
                        showToast(msg, 'error');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                            submitBtn.style.opacity = '1';
                            submitBtn.style.cursor = 'pointer';
                        }
                        return;
                    }

                    // Success feedback
                    if (submitBtn) {
                        submitBtn.textContent = 'Submitted!';
                        submitBtn.style.background = 'var(--emerald)';
                        submitBtn.style.borderColor = 'var(--emerald)';
                    }

                    showToast('Bug report submitted successfully', 'success');

                    // Auto-run digest in background to keep metrics fresh
                    this.autoRunDigest().catch(e => console.error('[Bug Reports] Auto-digest failed:', e));

                    // Refresh admin data if in admin tab
                    const active = document.querySelector('.app-sidebar-nav-item.active')?.getAttribute('data-tab');
                    if (active === 'admin' && typeof adminDashboard !== 'undefined' && adminDashboard.refresh) {
                        setTimeout(() => adminDashboard.refresh(), 100);
                    }

                    setTimeout(() => closeModal(), 800);
                } catch (e) {
                    showToast(`Submit failed: ${e.message || e}`, 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';
                    }
                }
            },

            async openAdminModal() {
                // Cache expires after 2 minutes
                const cacheExpired = !this.cache?.lastUpdated || 
                    (Date.now() - new Date(this.cache.lastUpdated).getTime() > 2 * 60 * 1000);
                
                // Fetch fresh data if cache is empty or expired
                if (!this.cache?.reports || this.cache.reports.length === 0 || cacheExpired) {
                    showToast('Loading bug reports...', 'info');
                    const adminToken = this.getAdminToken();
                    const headers = adminToken ? { 'x-h2s-admin-token': adminToken } : {};
                    const daysParam = '365'; // Show all reports from last year
                    
                    try {
                        const res = await fetch(`${API_URL}?action=bug_reports&days=${encodeURIComponent(daysParam)}&limit=50`, { headers });
                        const data = await res.json().catch(() => ({}));
                        console.log('[Bug Reports] Raw API response:', { ok: data?.ok, hasReports: !!data?.bug_reports, reportsCount: data?.bug_reports?.reports?.length });
                        if (res.ok && data?.ok && data?.bug_reports) {
                            this.setCache(data.bug_reports);
                            console.log('[Bug Reports] Cache updated:', { reportsCount: this.cache?.reports?.length, meta: this.cache?.meta });
                        } else if (res.status === 401 || res.status === 403) {
                            showToast('Admin token required (open Admin Dashboard to authenticate)', 'error');
                            return;
                        } else {
                            console.error('[Bug Reports] Invalid response:', { status: res.status, data });
                        }
                    } catch (e) {
                        console.error('[Bug Reports] Failed to fetch:', e);
                    }
                }

                const reports = Array.isArray(this.cache?.reports) ? this.cache.reports : [];
                const meta = this.cache?.meta || {};
                const digest = this.cache?.digest || null;

                console.log('[Bug Reports] Rendering modal with:', { reportsCount: reports.length, meta, hasDigest: !!digest });

                const adminToken = this.getAdminToken();
                const tokenHint = adminToken
                    ? '<span style="color:#059669; font-weight:800;">Admin token present</span>'
                    : '<span style="color:#b45309; font-weight:800;">Admin token missing</span> - set it by opening Admin Dashboard (password prompt)';

                // Build summary metrics from meta and reports array
                const totalReports = reports.length;
                const byStatus = meta?.by_status || {};
                const openCount = byStatus.OPEN || 0;
                const closedCount = byStatus.CLOSED || 0;
                
                // Calculate severity counts from actual reports (meta doesn't include by_severity)
                const criticalCount = reports.filter(r => String(r?.Severity || '').toUpperCase() === 'CRITICAL').length;
                const highCount = reports.filter(r => String(r?.Severity || '').toUpperCase() === 'HIGH').length;

                // Build digest preview
                let digestPreview = '';
                if (digest && digest.bullet_report) {
                    const lines = String(digest.bullet_report).split('\n').slice(0, 8).join('\n');
                    digestPreview = `
                        <details style="margin-top:12px; border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fafafa;">
                            <summary style="cursor:pointer; font-weight:800; color:var(--cobalt); font-size:13px;">AI Analysis Preview</summary>
                            <pre style="margin:10px 0 0 0; font-size:11px; color:#374151; white-space:pre-wrap; font-family:ui-monospace, monospace;">${lines.replace(/</g, '&lt;')}</pre>
                            <button type="button" onclick="bugReportsUI.showFullDigest();" style="margin-top:8px; padding:6px 10px; border:1px solid var(--cobalt); background:#fff; color:var(--cobalt); border-radius:8px; font-size:12px; font-weight:800; cursor:pointer;">View full digest</button>
                        </details>
                    `;
                }

                const summaryMetrics = `
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(100px, 1fr)); gap:12px; padding:12px; background:#f9fafb; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:24px; font-weight:900; color:var(--cobalt);">${totalReports}</div>
                            <div style="font-size:11px; color:#6b7280; font-weight:600;">Total Reports</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:24px; font-weight:900; color:#059669;">${openCount}</div>
                            <div style="font-size:11px; color:#6b7280; font-weight:600;">Open</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:24px; font-weight:900; color:${(criticalCount + highCount) > 0 ? '#dc2626' : '#6b7280'};">${criticalCount + highCount}</div>
                            <div style="font-size:11px; color:#6b7280; font-weight:600;">High/Critical</div>
                        </div>
                        ${closedCount > 0 ? `
                        <div style="text-align:center;">
                            <div style="font-size:24px; font-weight:900; color:#6b7280;">${closedCount}</div>
                            <div style="font-size:11px; color:#6b7280; font-weight:600;">Closed</div>
                        </div>
                        ` : ''}
                    </div>
                    ${digestPreview}
                `;

                const rows = reports.slice(0, 25).map(r => {
                    const at = r.Submitted_At ? new Date(r.Submitted_At).toLocaleString() : '';
                    const sev = String(r.Severity || 'MEDIUM').toUpperCase();
                    const st = String(r.Status || 'OPEN').toUpperCase();
                    const title = String(r.Title || '').replace(/</g, '&lt;');
                    const summary = String(r.AI_Summary || r.Description || '').replace(/</g, '&lt;');
                    return `
                        <div style="border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fff;">
                            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                                <div style="min-width:0;">
                                    <div style="font-weight:900; color:var(--cobalt); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title || '(untitled)'}</div>
                                    <div style="font-size:12px; color:#6b7280; margin-top:2px;">${at} | ${(r.Submitted_By || 'UNKNOWN')} | ${(r.Tab || '-')}</div>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center; flex:0 0 auto;">
                                    <span style="font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:#f3f4f6; color:#111827;">${sev}</span>
                                    <span style="font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#1e3a8a;">${st}</span>
                                </div>
                            </div>
                            <div style="font-size:13px; color:#374151; margin-top:8px; line-height:1.4;">${summary.slice(0, 260)}${summary.length > 260 ? '...' : ''}</div>
                        </div>
                    `;
                }).join('');

                const html = `
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
                            <div style="font-size:13px; color:#6b7280;">${tokenHint}</div>
                            <div style="display:flex; gap:10px;">
                                <button type="button" onclick="bugReportsUI.runDigest();" style="padding:10px 12px; border:1px solid var(--cobalt); background:var(--cobalt); color:#fff; border-radius:10px; font-weight:900; cursor:pointer;">Run digest</button>
                                <button type="button" onclick="bugReportsUI.refreshAndReopen();" style="padding:10px 12px; border:1px solid #e5e7eb; background:#fff; color:#111827; border-radius:10px; font-weight:900; cursor:pointer;">Refresh</button>
                            </div>
                        </div>
                        ${summaryMetrics}
                        <details style="border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fafafa;">
                            <summary style="cursor:pointer; font-weight:800; color:var(--cobalt); font-size:13px;">Recent Reports (${Math.min(25, reports.length)} of ${(meta.returned || reports.length)})</summary>
                            <div style="display:flex; flex-direction:column; gap:10px; max-height:420px; overflow:auto; padding-right:4px; margin-top:10px;">${rows || '<div style="color:#6b7280;">No bug reports yet.</div>'}</div>
                        </details>
                        <div style="display:flex; justify-content:flex-end; gap:10px;">
                            <button type="button" onclick="closeModal();" style="padding:10px 14px; border:1px solid #e5e7eb; background:#fff; color:#374151; border-radius:10px; font-weight:900; cursor:pointer;">Close</button>
                        </div>
                    </div>
                `;

                showModal('Bug Reports', html, { width: '920px', hideConfirm: true, hideActions: true, maxHeight: '80vh' });
            },

            async autoRunDigest() {
                // Silent background digest update after submission
                const adminToken = this.getAdminToken();
                const days = '365'; // Analyze all reports from last year
                
                try {
                    const headers = adminToken ? { 'x-h2s-admin-token': adminToken } : {};
                    const res = await fetch(`${API_URL}?action=bug_reports_digest&days=${encodeURIComponent(days)}&limit=250`, {
                        method: 'GET',
                        headers
                    });
                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data?.ok && data?.bug_reports_digest) {
                        this.setDigest(data.bug_reports_digest);
                    }
                } catch (e) {
                    // Silent fail - don't interrupt user flow
                    console.error('[Bug Reports] Auto-digest error:', e);
                }
            },

            showFullDigest() {
                const digest = this.cache?.digest;
                if (!digest || !digest.bullet_report) {
                    showToast('No digest available', 'error');
                    return;
                }

                const pretty = String(digest.bullet_report);
                const html = `
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <div style="font-size:13px; color:#6b7280;">AI-generated bullet report (copy/paste into an issue or ops log).</div>
                        <textarea readonly style="width:100%; min-height:360px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; white-space:pre;">${pretty.replace(/</g, '&lt;')}</textarea>
                        <div style="display:flex; justify-content:flex-end; gap:10px;">
                            <button type="button" onclick="closeModal();" style="padding:10px 14px; border:1px solid #e5e7eb; background:#fff; color:#374151; border-radius:10px; font-weight:900; cursor:pointer;">Close</button>
                        </div>
                    </div>
                `;
                showModal('Bug Digest', html, { width: '980px', hideConfirm: true, hideActions: true, maxHeight: '80vh' });
            },

            async runDigest() {
                const adminToken = this.getAdminToken();
                const days = '365'; // Analyze all reports from last year
                try {
                    showToast('Running digest...', 'info');
                    const headers = adminToken ? { 'x-h2s-admin-token': adminToken } : {};
                    const res = await fetch(`${API_URL}?action=bug_reports_digest&days=${encodeURIComponent(days)}&limit=250`, {
                        method: 'GET',
                        headers
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok || !data?.ok) {
                        const msg = data?.error || `Digest failed (${res.status})`;
                        if (res.status === 401 || res.status === 403) {
                            showToast('Admin token required for digest (open Admin Dashboard to authenticate)', 'error');
                            return;
                        }
                        showToast(msg, 'error');
                        return;
                    }

                    // Store digest in cache
                    if (data?.bug_reports_digest) {
                        this.setDigest(data.bug_reports_digest);
                    }

                    const bullet = data?.bug_reports_digest?.bullet_report || data?.bullet_report || data?.result?.bullet_report || null;
                    const digest = data?.bug_reports_digest?.digest || data?.digest || data?.result?.digest || null;
                    const pretty = bullet ? String(bullet) : (digest ? JSON.stringify(digest, null, 2) : JSON.stringify(data, null, 2));
                    
                    showToast('Digest updated', 'success');
                    
                    const html = `
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            <div style="font-size:13px; color:#6b7280;">AI-generated bullet report (copy/paste into an issue or ops log).</div>
                            <textarea readonly style="width:100%; min-height:360px; padding:12px; border:1px solid #e5e7eb; border-radius:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; white-space:pre;">${pretty.replace(/</g, '&lt;')}</textarea>
                            <div style="display:flex; justify-content:flex-end; gap:10px;">
                                <button type="button" onclick="closeModal();" style="padding:10px 14px; border:1px solid #e5e7eb; background:#fff; color:#374151; border-radius:10px; font-weight:900; cursor:pointer;">Close</button>
                            </div>
                        </div>
                    `;
                    showModal('Bug Digest', html, { width: '980px', hideConfirm: true, hideActions: true, maxHeight: '80vh' });
                } catch (e) {
                    showToast(`Digest failed: ${e.message || e}`, 'error');
                }
            },

            async refreshAndReopen() {
                closeModal();
                showToast('Refreshing bug reports...', 'info');
                
                const adminToken = this.getAdminToken();
                const headers = adminToken ? { 'x-h2s-admin-token': adminToken } : {};
                const daysParam = '365'; // Show all reports from last year
                
                try {
                    const res = await fetch(`${API_URL}?action=bug_reports&days=${encodeURIComponent(daysParam)}&limit=50`, { headers });
                    const data = await res.json().catch(() => ({}));
                    if (res.ok && data?.ok && data?.bug_reports) {
                        this.setCache(data.bug_reports);
                        // Also refresh admin dashboard if it's open
                        const active = document.querySelector('.app-sidebar-nav-item.active')?.getAttribute('data-tab');
                        if (active === 'admin' && typeof adminDashboard !== 'undefined' && adminDashboard.refresh) {
                            adminDashboard.refresh();
                        }
                    } else if (res.status === 401 || res.status === 403) {
                        showToast('Admin token required', 'error');
                        return;
                    }
                } catch (e) {
                    console.error('[Bug Reports] Refresh failed:', e);
                }
                
                // Reopen the modal with fresh data
                await this.openAdminModal();
            }
        };

        const adminDashboard = {
            dateRange: '30',

            // Parse dates safely across browsers/timezones.
            // Important: YYYY-MM-DD should be treated as a *local* date, not UTC.
            parseMaybeLocalDate(dateStr) {
                if (!dateStr) return null;
                const s = String(dateStr).trim();
                const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (m) {
                    const y = parseInt(m[1], 10);
                    const mo = parseInt(m[2], 10) - 1;
                    const d = parseInt(m[3], 10);
                    const dt = new Date(y, mo, d);
                    return isNaN(dt.getTime()) ? null : dt;
                }
                const dt = new Date(s);
                return isNaN(dt.getTime()) ? null : dt;
            },

            // Calendar week range (Monday 00:00 local -> now)
            getWeekStart(now = new Date()) {
                const d = new Date(now);
                d.setHours(0, 0, 0, 0);
                const day = d.getDay();
                // JS: 0=Sun..6=Sat; make Monday start.
                const diff = (day === 0 ? -6 : 1 - day);
                d.setDate(d.getDate() + diff);
                return d;
            },
            
            async refresh() {
                const container = document.getElementById('adminDashboardContent');
                if (!container) return;
                
                container.innerHTML = '<div class="spinner"></div>';
                this.dateRange = document.getElementById('adminDateRange')?.value || '30';
                
                try {
                const daysParam = (this.dateRange === 'all') ? 'all' : this.dateRange;
                const adminToken = bugReportsUI.getAdminToken();
                const adminHeaders = adminToken ? { 'x-h2s-admin-token': adminToken } : {};

                const [deliverablesRes, trainingRes, tasksRes, candidatesRes, hoursRes, bugReportsRes] = await Promise.all([
                    fetch(`${API_URL}?action=deliverables&status=all`).catch((e) => { console.error('[Admin] Deliverables fetch error:', e); return { ok: false }; }),
                    fetch(`${API_URL}?action=trainingCompletions&vaName=all`).catch((e) => { console.error('[Admin] Training fetch error:', e); return { ok: false }; }),
                    fetch(`${API_URL}?action=tasks`).catch((e) => { console.error('[Admin] Tasks fetch error:', e); return { ok: false }; }),
                    fetch(`${API_URL}?action=candidates&stage=all`).catch((e) => { console.error('[Admin] Candidates fetch error:', e); return { ok: false }; }),
                    // CRITICAL: Use same endpoint format as Log Hours tab, but with vaName=all for admin view
                    fetch(`${API_URL}?action=hours&vaName=all`).catch((e) => { console.error('[Admin] Hours fetch error:', e); return { ok: false }; }),
                    fetch(`${API_URL}?action=bug_reports&days=${encodeURIComponent(daysParam)}&limit=50`, { headers: adminHeaders })
                        .catch((e) => { console.error('[Admin] Bug reports fetch error:', e); return { ok: false }; })
                ]);
                
                // Debug: Log hours response status
                if (!hoursRes.ok) {
                    console.warn('[Admin Dashboard] Hours fetch failed:', hoursRes.status, hoursRes.statusText);
                }

                    const deliverables = deliverablesRes.ok ? await deliverablesRes.json().catch(() => ({ deliverables: [] })) : { deliverables: [] };
                    const training = trainingRes.ok ? await trainingRes.json().catch(() => ({ trainingCompletions: [] })) : { trainingCompletions: [] };
                    const tasks = tasksRes.ok ? await tasksRes.json().catch(() => ({ tasks: [] })) : { tasks: [] };
                    const candidates = candidatesRes.ok ? await candidatesRes.json().catch(() => ({ data: [], candidates: [] })) : { data: [], candidates: [] };

                    let bugReportsPayloadForRender = { reports: [], meta: null };
                    if (bugReportsRes && bugReportsRes.ok) {
                        try {
                            const bugReportsData = await bugReportsRes.json();
                            bugReportsPayloadForRender = (bugReportsData && bugReportsData.ok && bugReportsData.bug_reports)
                                ? bugReportsData.bug_reports
                                : { reports: [], meta: null };
                        } catch {
                            bugReportsPayloadForRender = { reports: [], meta: null };
                        }
                    } else if (bugReportsRes && (bugReportsRes.status === 401 || bugReportsRes.status === 403)) {
                        bugReportsPayloadForRender = { reports: [], meta: { auth_error: 'Bug reports require admin token (open Admin Dashboard to authenticate).' } };
                    }
                    
                    // CRITICAL: Use same response structure as Log Hours tab
                    let hoursData = null;
                    try {
                        hoursData = hoursRes.ok ? await hoursRes.json() : { ok: false, hours: [] };
                    } catch (e) {
                        console.error('[Admin Dashboard] Failed to parse hours JSON:', e);
                        hoursData = { ok: false, hours: [] };
                    }
                    
                    // Extract hours array - handle both { ok: true, hours: [...] } and { hours: [...] } formats
                    // This matches exactly how loadHoursHistory() processes the response
                    let allHours = [];
                    if (hoursData && hoursData.ok && Array.isArray(hoursData.hours)) {
                        allHours = hoursData.hours;
                    } else if (hoursData && Array.isArray(hoursData.hours)) {
                        allHours = hoursData.hours;
                    } else if (Array.isArray(hoursData)) {
                        allHours = hoursData;
                    } else if (hoursData && hoursData.data && Array.isArray(hoursData.data)) {
                        allHours = hoursData.data;
                    }
                    
                    // Debug logging to help diagnose
                    console.log('[Admin Dashboard] Hours data:', {
                        responseOk: hoursRes.ok,
                        responseStatus: hoursRes.status,
                        dataStructure: hoursData,
                        hoursCount: allHours.length,
                        sampleEntry: allHours[0] || null
                    });
                    
                    if (allHours.length === 0 && hoursRes.ok) {
                        console.warn('[Admin Dashboard] No hours found. Response structure:', hoursData);
                    }

                    // Keep ALL hours for accurate "Total Hours" calculation
                    // Date range filter is only for other context-specific views, not for hours totals
                    const hours = allHours; // Use all hours for calculations

                    this.render(
                        deliverables.deliverables || [],
                        training.trainingCompletions || [],
                        tasks.tasks || [],
                        candidates.candidates || candidates.data || [],
                        hours,
                        bugReportsPayloadForRender
                    );
                } catch (error) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-text" style="color: var(--danger);">Error: ${error.message}</div></div>`;
                }
            },
            
            render(deliverables, trainingCompletions, tasks, candidates, hours, bugReportsPayload) {
                const container = document.getElementById('adminDashboardContent');
                if (!container) return;

                // Don't cache bug reports during render - let View button fetch fresh data
                // bugReportsUI.setCache(bugReportsPayload || { reports: [], meta: null });

                const now = new Date();
                const weekStart = this.getWeekStart(now);

                // Deliverables: compute weekly totals based on Created_At
                const deliverablesWithDates = (deliverables || []).map(d => ({
                    raw: d,
                    createdAt: this.parseMaybeLocalDate(d.Created_At || d.createdAt || d.CreatedAt || null),
                    status: String(d.Status || d.status || '').toLowerCase()
                }));

                const weeklyDeliverables = deliverablesWithDates.filter(x => x.createdAt && x.createdAt >= weekStart);
                const deliverablesCountWeekly = weeklyDeliverables.length;
                const pendingDeliverablesWeekly = weeklyDeliverables.filter(x => x.status === 'pending').length;
                const deliverablesCountAllTime = (deliverables || []).length;

                const trainingCount = trainingCompletions.length;
                const totalTasks = tasks.length;
                const completedTasks = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() === 'COMPLETED').length;
                const candidatesCount = candidates.length;
                
                // DEBUG: Log initial hours data
                console.log('[Admin Dashboard] render() - Hours calculation START:', {
                    hoursArrayLength: hours.length,
                    firstEntry: hours[0] || null,
                    firstEntryKeys: hours[0] ? Object.keys(hours[0]) : [],
                    sampleEntries: hours.slice(0, 3).map(h => ({
                        keys: Object.keys(h),
                        hoursField: h.Hours || h.hours || h.Hours_Logged || h.hoursLogged || 'NOT_FOUND',
                        dateField: h.Date || h.date || h.Logged_At || h.loggedAt || 'NOT_FOUND',
                        loggedBy: h.Logged_By || h.loggedBy || h.VA_Name || h.vaName || 'NOT_FOUND'
                    }))
                });
                
                // Helper function to extract hours value from entry (matches Log Hours tab logic)
                const getHoursValue = (h) => {
                    const val = h.Hours || h.hours || h.Hours_Logged || h.hoursLogged || 0;
                    const parsed = parseFloat(val);
                    const result = isNaN(parsed) ? 0 : parsed;
                    if (result === 0 && val !== 0 && val !== '0') {
                        console.warn('[Admin Dashboard] Failed to parse hours value:', { val, h });
                    }
                    return result;
                };
                
                // Helper function to extract date from entry
                const getEntryDate = (h) => {
                    const dateStr = h.Date || h.date || h.Logged_At || h.loggedAt;
                    if (!dateStr) return null;
                    const date = adminDashboard.parseMaybeLocalDate(dateStr);
                    return date;
                };
                
                // Calculate total hours - ALL time (use all hours entries)
                const totalHours = hours.reduce((sum, h) => {
                    const hoursValue = getHoursValue(h);
                    return sum + hoursValue;
                }, 0);
                
                console.log('[Admin Dashboard] Total hours calculated:', totalHours);
                
                // Pipeline stats
                const byStage = { SCREENED: 0, INTERVIEWED: 0, HIRED: 0, REJECTED: 0 };
                candidates.forEach(c => {
                    const stage = (c.Current_Stage || c.currentStage || 'SCREENED').toUpperCase();
                    if (byStage[stage] !== undefined) byStage[stage]++;
                });
                const total = candidates.length;
                const screenedToInterview = byStage.SCREENED > 0 ? ((byStage.INTERVIEWED / byStage.SCREENED) * 100).toFixed(1) : 0;
                const interviewToHire = byStage.INTERVIEWED > 0 ? ((byStage.HIRED / byStage.INTERVIEWED) * 100).toFixed(1) : 0;
                const overallConversion = total > 0 ? ((byStage.HIRED / total) * 100).toFixed(1) : 0;
                
                // Task stats
                const todo = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() !== 'COMPLETED');
                const done = tasks.filter(t => (t.Status || 'PENDING').toUpperCase() === 'COMPLETED');
                const byPriority = { high: 0, medium: 0, low: 0 };
                todo.forEach(t => {
                    const p = ((t.Priority || 'medium').toLowerCase());
                    if (byPriority[p] !== undefined) byPriority[p]++;
                });
                const completionRate = tasks.length > 0 ? ((done.length / tasks.length) * 100).toFixed(1) : 0;
                
                // Hours stats by VA - group all hours by team member
                const byVA = {};
                hours.forEach(h => {
                    const va = h.Logged_By || h.loggedBy || h.VA_Name || h.vaName || h.VA || 'Unknown';
                    const hoursValue = getHoursValue(h);
                    
                    if (!byVA[va]) byVA[va] = { total: 0, count: 0 };
                    byVA[va].total += hoursValue;
                    byVA[va].count++;
                });
                
                // Average hours per entry (across all entries)
                const avgHoursPerEntry = hours.length > 0 ? (totalHours / hours.length) : 0;
                
                // Calculate weekly hours (calendar week) - from Monday 00:00 local
                console.log('[Admin Dashboard] Weekly hours filter:', {
                    now: now.toISOString(),
                    weekStart: weekStart.toISOString()
                });
                
                let weeklyEntriesCount = 0;
                const weeklyHours = hours.reduce((sum, h) => {
                    const entryDate = getEntryDate(h);
                    if (!entryDate) return sum;

                    const entryDateOnly = new Date(entryDate);
                    entryDateOnly.setHours(0, 0, 0, 0);

                    if (entryDateOnly >= weekStart) {
                        weeklyEntriesCount++;
                        const hoursValue = getHoursValue(h);
                        return sum + hoursValue;
                    }
                    return sum;
                }, 0);
                
                console.log('[Admin Dashboard] Weekly hours calculated:', {
                    weeklyHours,
                    weeklyEntriesCount,
                    totalEntries: hours.length
                });
                
                const sortedVAs = Object.entries(byVA).sort((a, b) => b[1].total - a[1].total);

                // Don't use bugReportsPayload at all - it's stale
                const bugReports = [];
                const bugMeta = {};
                const bugAuthError = '';
                const openCount = 0;
                const highCount = bugReports.filter(r => String(r?.Severity || '').toUpperCase() === 'HIGH' || String(r?.Severity || '').toUpperCase() === 'CRITICAL').length;
                const bugWindowLabel = (this.dateRange === 'all') ? 'All time' : `Last ${this.dateRange} days`;

                // Compact bullet intelligence for the dashboard card (no extra API calls).
                const severityRank = { CRITICAL: 4, HIGH: 3, MEDIUM: 2, LOW: 1 };
                const keyForBug = (r) => String(r?.Fingerprint || r?.Bug_ID || r?.Title || '').trim();
                const topPatterns = (() => {
                    const map = new Map();
                    for (const r of (bugReports || [])) {
                        const key = keyForBug(r);
                        if (!key) continue;
                        const sev = String(r?.Severity || 'MEDIUM').toUpperCase();
                        const sevScore = severityRank[sev] || 2;
                        const at = r?.Submitted_At ? new Date(r.Submitted_At).getTime() : 0;
                        const cur = map.get(key) || { key, count: 0, sev: sev, sevScore: sevScore, lastAt: 0, title: '', category: '' };
                        cur.count += 1;
                        if (sevScore > cur.sevScore) { cur.sevScore = sevScore; cur.sev = sev; }
                        if (at > cur.lastAt) cur.lastAt = at;
                        if (!cur.title) cur.title = String(r?.Title || '').trim();
                        if (!cur.category) cur.category = String(r?.AI_Category || '').trim();
                        map.set(key, cur);
                    }
                    return Array.from(map.values())
                        .sort((a, b) => (b.sevScore - a.sevScore) || (b.count - a.count) || (b.lastAt - a.lastAt))
                        .slice(0, 4);
                })();

                const patternsHtml = topPatterns.length ? `
                    <ul style="margin:10px 0 0 18px; padding:0; color:#374151; font-size:13px; line-height:1.45;">
                        ${topPatterns.map(p => {
                            const title = String(p.title || '(untitled)').replace(/</g, '&lt;');
                            const cat = p.category ? String(p.category).replace(/</g, '&lt;') : 'general';
                            const sev = String(p.sev || 'MEDIUM');
                            const count = Number(p.count || 0);
                            const label = (count >= 2) ? `${count}x` : '1x';
                            const sevColor = (sev === 'CRITICAL' || sev === 'HIGH') ? 'var(--danger)' : 'var(--cobalt)';
                            return `<li style="margin:0 0 6px 0;"><span style="font-weight:900; color:${sevColor};">${sev}</span> <span style="font-weight:900; color:#111827;">${label}</span> - ${title} <span style="color:#6b7280;">(${cat})</span></li>`;
                        }).join('')}
                    </ul>
                ` : '';

                const bugPreview = bugReports.slice(0, 5).map(r => {
                    const title = String(r?.Title || '(untitled)').replace(/</g, '&lt;');
                    const sev = String(r?.Severity || 'MEDIUM').toUpperCase();
                    const at = r?.Submitted_At ? new Date(r.Submitted_At).toLocaleDateString() : '';
                    return `<div style="display:flex; justify-content:space-between; gap:10px; padding:10px 0; border-top:1px solid #f1f5f9;">
                        <div style="min-width:0;">
                            <div style="font-weight:900; color:var(--cobalt); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${title}</div>
                            <div style="font-size:12px; color:#6b7280;">${at} | ${(r?.Submitted_By || 'UNKNOWN')} | ${(r?.Tab || '-')}</div>
                        </div>
                        <div style="flex:0 0 auto; font-size:11px; font-weight:900; padding:4px 8px; border-radius:999px; background:#f3f4f6; color:#111827; align-self:flex-start;">${sev}</div>
                    </div>`;
                }).join('');

                const bugEmptyState = bugAuthError
                    ? `<div style="color:#b45309; padding-top:10px; font-weight:800;">${String(bugAuthError).replace(/</g, '&lt;')}</div>`
                    : '<div style="color:#6b7280; padding-top:10px;">No bug reports in this window.</div>';

                // Intelligence: Calculate productivity ratio
                const productivityRatio = weeklyHours > 0.5 ? (deliverablesCountWeekly / weeklyHours).toFixed(1) : 'N/A';
                
                // DEBUG: Final calculated values
                console.log('[Admin Dashboard] Final calculations:', {
                    totalHours,
                    weeklyHours,
                    productivityRatio,
                    avgHoursPerEntry,
                    hoursCount: hours.length,
                    byVACount: Object.keys(byVA).length,
                    sortedVAs: sortedVAs.map(([va, stats]) => ({ va, total: stats.total, count: stats.count }))
                });

                container.innerHTML = `
                    <!-- Key Metrics Row -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 32px;">
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;" onclick="adminDashboard.showDeliverablesDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--cobalt); margin-bottom: 8px; line-height: 1;">${deliverablesCountWeekly}</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Deliverables (This Week)</div>
                            <div style="font-size: 12px; color: #6b7280;">${pendingDeliverablesWeekly} pending | all time: ${deliverablesCountAllTime}</div>
                    </div>
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;" onclick="adminDashboard.showTrainingDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--cobalt); margin-bottom: 8px; line-height: 1;">${trainingCount}</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Training Completions</div>
                            <div style="font-size: 12px; color: #6b7280;">Across all team</div>
                    </div>
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;" onclick="adminDashboard.showTasksDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--cobalt); margin-bottom: 8px; line-height: 1;">${totalTasks}</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Total Tasks</div>
                            <div style="font-size: 12px; color: #6b7280;">${completedTasks} completed</div>
                    </div>
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer;" onclick="adminDashboard.showCandidatesDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--cobalt); margin-bottom: 8px; line-height: 1;">${candidatesCount}</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Candidates</div>
                            <div style="font-size: 12px; color: #6b7280;">In pipeline</div>
                    </div>
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: all 0.2s; cursor: pointer; border-left: 4px solid var(--azure);" onclick="adminDashboard.showHoursDetail()" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                            <div style="font-size: 36px; font-weight: 900; color: var(--azure); margin-bottom: 8px; line-height: 1;">${weeklyHours.toFixed(1)}h</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">This Week's Hours</div>
                            <div style="font-size: 12px; color: #6b7280;">All time: ${totalHours.toFixed(1)}h</div>
                            ${productivityRatio !== 'N/A' ? `<div style="font-size: 11px; color: var(--emerald); font-weight: 600; margin-top: 4px;">Efficiency: ${productivityRatio} deliv/hr</div>` : ''}
                        </div>
                    </div>

                    <!-- Main Dashboard Grid -->
                    <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">
                        <!-- Bug Reports -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
                                <div>
                                    <h3 style="font-size: 20px; font-weight: 800; color: var(--cobalt); margin: 0 0 6px 0;">Bug Reports</h3>
                                    <div style="font-size: 12px; color: #6b7280;">${bugWindowLabel} | open: <span style="font-weight:900; color: var(--cobalt);">${openCount}</span> | high/critical: <span style="font-weight:900; color: ${highCount > 0 ? 'var(--danger)' : 'var(--emerald)'};">${highCount}</span></div>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button onclick="bugReportsUI.openReportModal()" class="btn" style="padding: 8px 14px; font-size: 13px; background: #f8fafc; color: var(--cobalt); border: 1px solid #e5e7eb; border-radius: 10px; font-weight: 800;">+ Report</button>
                                    <button onclick="bugReportsUI.cache = { reports: [], meta: null, digest: null, lastUpdated: null }; bugReportsUI.openAdminModal();" class="btn" style="padding: 8px 14px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 10px; font-weight: 900;">View</button>
                                </div>
                            </div>
                            <div style="margin-top: 12px;">
                                ${bugReports.length ? bugPreview : bugEmptyState}
                                ${patternsHtml}
                            </div>
                        </div>

                        <!-- Pipeline Intelligence -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 20px 0;">Pipeline Intelligence</h3>
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${total}</div>
                                        <div style="font-size: 12px; color: #6b7280;">Total Candidates</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${overallConversion}%</div>
                                        <div style="font-size: 12px; color: #6b7280;">Overall Conversion</div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${byStage.SCREENED}</div>
                                        <div style="font-size: 10px; color: #6b7280;">Screened</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${byStage.INTERVIEWED}</div>
                                        <div style="font-size: 10px; color: #6b7280;">Interviewed</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${byStage.HIRED}</div>
                                        <div style="font-size: 10px; color: #6b7280;">Hired</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 6px; text-align: center; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${byStage.REJECTED}</div>
                                        <div style="font-size: 10px; color: #6b7280;">Rejected</div>
                                    </div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">Conversion Rates</div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                            <span style="color: #6b7280;">Screened -> Interviewed</span>
                                            <span style="font-weight: 600; color: var(--cobalt);">${screenedToInterview}%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 12px;">
                                            <span style="color: #6b7280;">Interviewed -> Hired</span>
                                            <span style="font-weight: 600; color: var(--cobalt);">${interviewToHire}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Task Ecosystem -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 20px 0;">Task Ecosystem</h3>
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${todo.length}</div>
                                        <div style="font-size: 12px; color: #6b7280;">To Do</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${done.length}</div>
                                        <div style="font-size: 12px; color: #6b7280;">Completed</div>
                                    </div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">Completion Rate</div>
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${completionRate}%</div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">Priority Breakdown (To Do)</div>
                                    <div style="display: flex; flex-direction: column; gap: 8px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">
                                            <span style="color: var(--cobalt); font-weight: 600;">High</span>
                                            <span style="font-weight: 700; color: var(--cobalt);">${byPriority.high}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">
                                            <span style="color: var(--cobalt); font-weight: 600;">Medium</span>
                                            <span style="font-weight: 700; color: var(--cobalt);">${byPriority.medium}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; padding: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 4px;">
                                            <span style="color: var(--cobalt); font-weight: 600;">Low</span>
                                            <span style="font-weight: 700; color: var(--cobalt);">${byPriority.low}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Productivity & Capacity -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 20px 0;">Productivity & Capacity</h3>
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; border-left: 4px solid var(--azure);">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--azure); margin-bottom: 4px;">${weeklyHours.toFixed(1)}h</div>
                                        <div style="font-size: 12px; color: #6b7280; font-weight: 600;">This Week</div>
                                        <div style="font-size: 10px; color: #9ca3af; margin-top: 2px;">Hours worked (since Monday)</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${totalHours.toFixed(1)}h</div>
                                        <div style="font-size: 12px; color: #6b7280;">Total Hours</div>
                                        <div style="font-size: 10px; color: #9ca3af; margin-top: 2px;">All time</div>
                                    </div>
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin-bottom: 4px;">${avgHoursPerEntry.toFixed(1)}h</div>
                                        <div style="font-size: 12px; color: #6b7280;">Avg per Entry</div>
                                        <div style="font-size: 10px; color: #9ca3af; margin-top: 2px;">Per work day</div>
                                    </div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 12px;">Hours by Team Member</div>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        ${sortedVAs.length === 0 ? '<div style="color: #6b7280; font-size: 12px;">No hours logged yet</div>' : sortedVAs.map(([va, stats]) => `
                                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                                <div>
                                                    <div style="font-weight: 600; font-size: 14px; color: var(--cobalt);">${va}</div>
                                                    <div style="font-size: 11px; color: #6b7280;">${stats.count} entries</div>
                                                </div>
                                                <div style="font-size: 18px; font-weight: 900; color: var(--cobalt);">${stats.total.toFixed(1)}h</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Learning & Knowledge -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 20px 0;">Learning & Knowledge</h3>
                            <div style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 48px; margin-bottom: 16px;">Stats</div>
                                <p style="color: #6b7280; margin-bottom: 20px; font-size: 15px;">Advanced learning analytics, pattern analysis, and scenario simulation</p>
                                <a href="https://home2smart.com/analytics" target="_blank" class="btn" style="padding: 12px 24px; font-size: 14px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; text-decoration: none; display: inline-block; font-weight: 600;">
                                    Open Analytics Dashboard >
                                </a>
                            </div>
                        </div>

                        <!-- Forecast / Simulation -->
                        <div class="card" style="background: white; border: 1px solid #e5e7eb; padding: 24px; border-radius: 12px; margin-top: 24px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 24px 0;">Forecast / Simulation</h3>
                            <div id="adminForecastCalculator"></div>
                        </div>
                    </div>
                `;
                
                // Initialize forecast calculator after rendering
                setTimeout(async () => {
                    if (typeof adminForecastCalculator !== 'undefined' && adminForecastCalculator) {
                        await adminForecastCalculator.init();
                    }
                }, 100);
            },
            
            async showDeliverablesDetail() {
            try {
                const response = await fetch(`${API_URL}?action=deliverables&status=all`);
                const data = await response.json();
                    const deliverables = data.deliverables || [];
                    
                    showModal('All Deliverables', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${deliverables.length === 0 ? '<div style="text-align: center; padding: 40px; color: #6b7280;">No deliverables found</div>' : deliverables.map(d => `
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-weight: 700; font-size: 15px; color: var(--cobalt); margin-bottom: 8px;">${d.Title || 'Untitled'}</div>
                                        <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">${(d.Description || '').substring(0, 200)}${(d.Description || '').length > 200 ? '...' : ''}</div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 12px;">
                                            <span style="color: #6b7280;">By: ${d.Submitted_By || 'Unknown'}</span>
                                        <span style="background: ${d.Status === 'pending' ? '#fef3c7' : d.Status === 'published' ? '#d1fae5' : '#fee2e2'}; color: ${d.Status === 'pending' ? '#92400e' : d.Status === 'published' ? '#065f46' : '#991b1b'}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                            ${d.Status || 'unknown'}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        </div>
                    `, { width: '800px' });
            } catch (error) {
                    showToast('Error loading deliverables: ' + error.message, 'error');
            }
            },

            async showTrainingDetail() {
            try {
                const response = await fetch(`${API_URL}?action=trainingCompletions&vaName=all`);
                const data = await response.json();
                    const completions = data.trainingCompletions || [];
                    
                    const byVA = {};
                    completions.forEach(c => {
                        const va = c.VA_Name || 'Unknown';
                        if (!byVA[va]) byVA[va] = [];
                        byVA[va].push(c);
                    });
                    
                    showModal('Training Completions', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                                ${Object.keys(byVA).length === 0 ? '<div style="text-align: center; padding: 40px; color: #6b7280;">No training completions found</div>' : Object.entries(byVA).map(([va, comps]) => {
                                const totalMinutes = comps.reduce((sum, c) => sum + (c.Time_Spent_Minutes || 0), 0);
                                const avgComprehension = comps.reduce((sum, c) => sum + (c.Comprehension_Level || 0), 0) / comps.length;
                                return `
                                        <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                            <div style="font-weight: 700; font-size: 16px; color: var(--cobalt); margin-bottom: 12px;">${va}</div>
                                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                                            <div>
                                                    <div style="font-size: 24px; font-weight: 900; color: var(--cobalt);">${comps.length}</div>
                                                    <div style="font-size: 11px; color: #6b7280;">Completed</div>
                                            </div>
                                            <div>
                                                    <div style="font-size: 24px; font-weight: 900; color: var(--cobalt);">${(totalMinutes / 60).toFixed(1)}h</div>
                                                    <div style="font-size: 11px; color: #6b7280;">Learning Time</div>
                                            </div>
                                            <div>
                                                    <div style="font-size: 24px; font-weight: 900; color: var(--cobalt);">${avgComprehension.toFixed(1)}/5</div>
                                                    <div style="font-size: 11px; color: #6b7280;">Avg Comprehension</div>
                                            </div>
                                        </div>
                                            <div style="font-size: 12px; color: #6b7280;">Recent: ${comps.slice(0, 3).map(c => c.Training_Title || 'Untitled').join(', ')}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        </div>
                    `, { width: '800px' });
                } catch (error) {
                    showToast('Error loading training: ' + error.message, 'error');
                }
            },
            
            async showTasksDetail() {
                try {
                    const response = await fetch(`${API_URL}?action=tasks`);
                    const data = await response.json();
                    const tasks = data.tasks || [];
                    
                    showModal('All Tasks', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${tasks.length === 0 ? '<div style="text-align: center; padding: 40px; color: #6b7280;">No tasks found</div>' : tasks.map(t => `
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div style="font-weight: 700; font-size: 15px; color: var(--cobalt);">${t.Title || 'Untitled'}</div>
                                            <span style="background: ${(t.Status || 'PENDING').toUpperCase() === 'COMPLETED' ? '#d1fae5' : '#fef3c7'}; color: ${(t.Status || 'PENDING').toUpperCase() === 'COMPLETED' ? '#065f46' : '#92400e'}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                                ${t.Status || 'PENDING'}
                                            </span>
                                        </div>
                                        <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">${(t.Description || '').substring(0, 150)}${(t.Description || '').length > 150 ? '...' : ''}</div>
                                        <div style="display: flex; gap: 8px; font-size: 12px; color: #6b7280;">
                                            <span>Priority: ${(t.Priority || 'medium').toUpperCase()}</span>
                                            <span>&bull;</span>
                                            <span>Assigned: ${t.Assigned_To || 'Unassigned'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `, { width: '800px' });
            } catch (error) {
                    showToast('Error loading tasks: ' + error.message, 'error');
                }
            },
            
            async showCandidatesDetail() {
                try {
                    const response = await fetch(`${API_URL}?action=candidates&stage=all`);
                    const data = await response.json();
                    const candidates = data.candidates || data.data || [];
                    
                    const byStage = { SCREENED: 0, INTERVIEWED: 0, HIRED: 0, REJECTED: 0 };
                    candidates.forEach(c => {
                        const stage = (c.Current_Stage || c.currentStage || 'SCREENED').toUpperCase();
                        if (byStage[stage] !== undefined) byStage[stage]++;
                    });
                    
                    showModal('All Candidates', `
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${byStage.SCREENED}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Screened</div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${byStage.INTERVIEWED}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Interviewed</div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${byStage.HIRED}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Hired</div>
                                </div>
                                <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; text-align: center;">
                                    <div style="font-size: 28px; font-weight: 900; color: var(--cobalt);">${byStage.REJECTED}</div>
                                    <div style="font-size: 12px; color: #6b7280;">Rejected</div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${candidates.slice(0, 20).map(c => `
                                    <div style="background: #f9fafb; padding: 12px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="font-weight: 600; font-size: 14px; color: var(--cobalt);">${c.First_Name || ''} ${c.Last_Name || ''}</div>
                                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${c.Phone || 'No phone'} | ${c.Email || 'No email'} | Stage: ${c.Current_Stage || 'UNKNOWN'}</div>
                                    </div>
                                `).join('')}
                                ${candidates.length > 20 ? `<div style="text-align: center; padding: 16px; color: #6b7280; font-size: 13px;">... and ${candidates.length - 20} more candidates</div>` : ''}
                            </div>
                        </div>
                    `, { width: '900px' });
                } catch (error) {
                    showToast('Error loading candidates: ' + error.message, 'error');
                }
            },
            
            async showHoursDetail() {
                try {
                    const response = await fetch(`${API_URL}?action=hours&vaName=all`);
                    const data = await response.json();
                    let hours = data.hours || [];
                    
                    // Robust helper (matches render logic)
                    const getHoursValue = (h) => {
                        const val = h.Hours || h.hours || h.Hours_Logged || h.hoursLogged || 0;
                        const parsed = parseFloat(val);
                        return isNaN(parsed) ? 0 : parsed;
                    };

                    const getEntryDate = (h) => {
                        const dateStr = h.Date || h.date || h.Logged_At || h.loggedAt;
                        if (!dateStr) return null;
                        // Use local date parser if available in scope context, or fallback
                        return adminDashboard.parseMaybeLocalDate(dateStr) || new Date(dateStr);
                    };

                    // Calculate Week Start for comparison
                    const now = new Date();
                    const day = now.getDay();
                    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                    const weekStart = new Date(now);
                    weekStart.setDate(diff);
                    weekStart.setHours(0, 0, 0, 0);
                    
                    // Apply date range filter if set
                    if (this.dateRange && this.dateRange !== 'all') {
                        const days = parseInt(this.dateRange);
                        const cutoffDate = new Date();
                        cutoffDate.setDate(cutoffDate.getDate() - days);
                        cutoffDate.setHours(0, 0, 0, 0);
                        
                        hours = hours.filter(h => {
                            const d = getEntryDate(h);
                            return d && d >= cutoffDate;
                        });
                    }
                    
                    const byVA = {};
                    hours.forEach(h => {
                        const va = h.Logged_By || h.loggedBy || h.VA_Name || h.vaName || 'Unknown';
                        if (!byVA[va]) byVA[va] = { total: 0, weekly: 0, entries: [] };
                        
                        const val = getHoursValue(h);
                        byVA[va].total += val;
                        
                        const entryDate = getEntryDate(h);
                        if (entryDate) {
                             const entryDateOnly = new Date(entryDate);
                             entryDateOnly.setHours(0,0,0,0);
                             if (entryDateOnly >= weekStart) {
                                 byVA[va].weekly += val;
                             }
                        }

                        byVA[va].entries.push(h);
                    });
                    
                    const sortedVAs = Object.entries(byVA).sort((a, b) => b[1].total - a[1].total);
                    
                    showModal(`Hours Logged (${this.dateRange === 'all' ? 'All Time' : 'Last ' + this.dateRange + ' Days'})`, `
                        <div style="max-height: 60vh; overflow-y: auto;">
                            <!-- Header showing intelligence -->
                            <div style="margin-bottom: 20px; display: flex; justify-content: flex-end; align-items: center; gap: 8px;">
                                <div style="font-size: 12px; color: #6b7280; font-style: italic;">Compounding contributors for current pay period</div>
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                ${sortedVAs.length === 0 ? '<div style="text-align: center; padding: 40px; color: #6b7280;">No hours logged yet</div>' : sortedVAs.map(([va, stats]) => `
                                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                            <div style="font-weight: 700; font-size: 16px; color: var(--cobalt);">${va}</div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 20px; font-weight: 900; color: var(--cobalt);">${stats.total.toFixed(1)}h <span style="font-size: 12px; font-weight: normal; color: #6b7280;">total</span></div>
                                                ${stats.weekly > 0 ? `<div style="font-size: 12px; color: var(--azure); font-weight: 600;">+${stats.weekly.toFixed(1)}h this week</div>` : ''}
                                            </div>
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">${stats.entries.length} entries</div>
                                        <div style="display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto;">
                                            ${stats.entries.slice(0, 10).map(e => `
                                                <div style="display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px; border-radius: 6px; font-size: 12px; border: 1px solid #e5e7eb;">
                                                    <div>
                                                        <span style="font-weight: 600; color: var(--cobalt); display: inline-block; width: 40px;">${getHoursValue(e).toFixed(1)}h</span>
                                                        <span style="color: #6b7280; margin-left: 8px;">${e.Tasks || e.tasks || 'No description'}</span>
                                                    </div>
                                                    <div style="color: #9ca3af; font-size: 11px;">
                                                        ${(getEntryDate(e) || new Date()).toLocaleDateString(undefined, {month:'numeric', day:'numeric'})}
                                                    </div>
                                                </div>
                                            `).join('')}
                                            ${stats.entries.length > 10 ? `<div style="text-align: center; padding: 8px; color: #6b7280; font-size: 11px;">... and ${stats.entries.length - 10} more entries</div>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `, { width: '800px' });
                } catch (error) {
                    showToast('Error loading hours: ' + error.message, 'error');
                }
            }
        };

        /* ===== ADMIN FORECAST CALCULATOR (Inside Admin Dashboard) ===== */
        const adminForecastCalculator = {
            inputs: {
                cities: 1,
                techs: 2,
                jobsPerTechPerDay: 3,
                workDaysPerMonth: 22,
                rampFactor: 100,
                aov: 300,
                grossMargin: 40,
                techPayoutPct: 35,
                equipCostPerJob: 50,
                overheadPerJob: 10,
                dailyAdSpend: 20, // Updated to $20/day baseline
                cpm: 0,
                cpc: 15,
                leadToBookingRate: 25,
                bookingToCompletedRate: 85,
                cancelRate: 5,
                // Extracted metadata fields (aligned with extraction schema)
                market: null, // Location extracted from scenario (e.g., "Greenville, South Carolina")
                services: [], // Services extracted from scenario (e.g., ["TV mounting", "camera mounting"])
                creatives: null // Number of creatives extracted
            },
            // Store conversation context including location
            conversationContext: {
                location: null, // e.g., "Greenville, South Carolina" or "Dallas, TX"
                previousInputs: null // Last parsed scenario text for context
            },
            
            updateStickyPositioning() {
                // Simplified: Standards is sticky at top, Totals flows naturally
                // No need for complex calculations - CSS handles the layout
                const standardsEl = document.getElementById('offerBuilderStandards');
                const totalsEl = document.getElementById('offerBuilderTotals');
                
                if (!standardsEl || !totalsEl) return;
                
                // On mobile, disable sticky behavior
                if (window.innerWidth <= 768) {
                    standardsEl.style.position = 'relative';
                    standardsEl.style.top = 'auto';
                    standardsEl.style.maxHeight = 'none';
                    return;
                }
                
                // Desktop: Standards is sticky, Totals flows naturally
                // No overlap because Totals is not sticky
            },
            
            initStickyPositioningObserver() {
                // Set up ResizeObserver to watch for height changes in both panels and their content
                const standardsEl = document.getElementById('offerBuilderStandards');
                const totalsEl = document.getElementById('offerBuilderTotals');
                if (!standardsEl || !totalsEl || this.stickyObserver) return;
                
                // Create ResizeObserver to watch panel heights
                this.stickyObserver = new ResizeObserver(() => {
                    // Debounce updates to avoid excessive recalculations
                    clearTimeout(this.stickyUpdateTimer);
                    this.stickyUpdateTimer = setTimeout(() => {
                        this.updateStickyPositioning();
                    }, 100);
                });
                
                // Observe both panels and their content areas
                this.stickyObserver.observe(standardsEl);
                this.stickyObserver.observe(totalsEl);
                const standardsContent = standardsEl.querySelector('#offerBuilderStandardsContent');
                const totalsResults = totalsEl.querySelector('#offerBuilderResults');
                if (standardsContent) this.stickyObserver.observe(standardsContent);
                if (totalsResults) this.stickyObserver.observe(totalsResults);
                
                // Also watch for select dropdown interactions and any DOM changes in right column
                const rightColumn = document.getElementById('offerBuilderRightColumn');
                if (rightColumn && !this.selectInteractionHandler) {
                    this.selectInteractionHandler = (e) => {
                        // When any select in the right column is interacted with
                        if (e.target.tagName === 'SELECT') {
                            // Update immediately, then again after a delay to catch dropdown render
                            this.updateStickyPositioning();
                            clearTimeout(this.stickyUpdateTimer);
                            this.stickyUpdateTimer = setTimeout(() => {
                                this.updateStickyPositioning();
                            }, 200);
                        }
                    };
                    // Listen for clicks, focus, and changes on select elements
                    rightColumn.addEventListener('click', this.selectInteractionHandler, true);
                    rightColumn.addEventListener('change', this.selectInteractionHandler, true);
                    rightColumn.addEventListener('focus', this.selectInteractionHandler, true);
                    rightColumn.addEventListener('blur', this.selectInteractionHandler, true);
                }
                
                // Watch for DOM mutations in the right column (content changes, attribute changes)
                if (rightColumn && !this.mutationObserver) {
                    this.mutationObserver = new MutationObserver(() => {
                        clearTimeout(this.stickyUpdateTimer);
                        this.stickyUpdateTimer = setTimeout(() => {
                            this.updateStickyPositioning();
                        }, 100);
                    });
                    this.mutationObserver.observe(rightColumn, {
                        childList: true,
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['style', 'class']
                    });
                }
                
                // CRITICAL: Watch LEFT column for accordion expansions that change height
                // This ensures sticky positioning recalculates when accordions expand/collapse
                const leftColumn = document.querySelector('#offerbuilder-pane #offerBuilderMainGrid > div:first-child');
                if (leftColumn && !this.leftColumnObserver) {
                    this.leftColumnObserver = new ResizeObserver(() => {
                        clearTimeout(this.stickyUpdateTimer);
                        this.stickyUpdateTimer = setTimeout(() => {
                            this.updateStickyPositioning();
                        }, 100);
                    });
                    this.leftColumnObserver.observe(leftColumn);
                    
                    // Also watch for accordion content changes via MutationObserver
                    this.leftColumnMutationObserver = new MutationObserver((mutations) => {
                        // Only trigger if display style changes (accordion toggle)
                        const hasDisplayChange = mutations.some(m => 
                            m.type === 'attributes' && 
                            m.attributeName === 'style' &&
                            (m.target.style.display === 'block' || m.target.style.display === 'none')
                        );
                        if (hasDisplayChange) {
                            clearTimeout(this.stickyUpdateTimer);
                            this.stickyUpdateTimer = setTimeout(() => {
                                this.updateStickyPositioning();
                            }, 150);
                        }
                    });
                    this.leftColumnMutationObserver.observe(leftColumn, {
                        childList: true,
                        subtree: true,
                        attributes: true,
                        attributeFilter: ['style']
                    });
                }
                
                // Watch window resize
                if (!this.windowResizeHandler) {
                    this.windowResizeHandler = () => {
                        clearTimeout(this.stickyUpdateTimer);
                        this.stickyUpdateTimer = setTimeout(() => {
                            this.updateStickyPositioning();
                        }, 150);
                    };
                    window.addEventListener('resize', this.windowResizeHandler);
                }
            },
            
            async init() {
                // Calculate intelligent defaults before loading saved values
                await this.calculateIntelligentDefaults();
                this.loadFromStorage();
                
                // Initialize sticky positioning observer
                setTimeout(() => {
                    this.initStickyPositioningObserver();
                    this.updateStickyPositioning();
                }, 200);
                
                this.render();
                this.attachListeners();
                setTimeout(() => this.loadOfferPresets(), 100);
            },
            
            async calculateIntelligentDefaults(extractedText) {
                // GAP FIX #1: Expanded auto-population intelligence + GAP FIX #14: Extraction-driven intelligence
                try {
                    // GAP FIX #14: Detect business stage and adjust defaults
                    if (extractedText) {
                        const businessStage = this.detectBusinessStage(extractedText);
                        if (businessStage === 'early') {
                            // Early stage: Lower expectations, adjust defaults
                            if (!this.inputs.leadToBookingRate || this.inputs.leadToBookingRate === 25) {
                                this.inputs.leadToBookingRate = 15; // Conservative for early stage
                            }
                            if (!this.inputs.bookingToCompletedRate || this.inputs.bookingToCompletedRate === 85) {
                                this.inputs.bookingToCompletedRate = 70; // Lower for new business
                            }
                        } else if (businessStage === 'scaling') {
                            // Scaling: Optimistic defaults
                            if (!this.inputs.leadToBookingRate || this.inputs.leadToBookingRate === 25) {
                                this.inputs.leadToBookingRate = 30; // Higher for scaling
                            }
                        }
                    }
                    
                    try {
                        // 1. AOV from saved offers or performance data
                        const savedOffers = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                        if (savedOffers.length > 0) {
                            const aovs = savedOffers
                                .filter(o => o.totals && o.totals.customerPrice > 0)
                                .map(o => o.totals.customerPrice);
                            
                            if (aovs.length > 0) {
                                const avgAOV = aovs.reduce((sum, aov) => sum + aov, 0) / aovs.length;
                                this.inputs.aov = Math.round(avgAOV);
                            }
                        }
                        
                        // Try to get AOV from performance data
                        try {
                            const perfResponse = await fetch(`${API_URL}?action=offer_performance&days=90`);
                            if (perfResponse.ok) {
                                const perfData = await perfResponse.json();
                                const data = perfData.offer_performance || perfData;
                                if (data.summary && data.summary.avg_order_value > 0) {
                                    this.inputs.aov = Math.round(data.summary.avg_order_value);
                                }
                            }
                        } catch (e) {
                            // Fallback to default
                        }
                        
                        // 2. GAP FIX: Service-specific AOV if services extracted
                        if (this.inputs.services && this.inputs.services.length > 0) {
                            const serviceAOVs = {
                                'TV Mount': 300,
                                'TV mounting': 300,
                                'Cameras': 800,
                                'Camera': 800,
                                'camera mounting': 800,
                                'Doorbell': 400,
                                'WiFi': 300,
                                'Network': 300,
                                'Bundle': 1200
                            };
                            
                            const serviceValues = this.inputs.services
                                .map(s => serviceAOVs[s] || serviceAOVs[Object.keys(serviceAOVs).find(k => s.toLowerCase().includes(k.toLowerCase()))] || 300)
                                .filter(v => v);
                            
                            if (serviceValues.length > 0) {
                                const weightedAOV = serviceValues.reduce((sum, v) => sum + v, 0) / serviceValues.length;
                                // Use service AOV if it's significantly different from current
                                if (Math.abs(weightedAOV - this.inputs.aov) > 50) {
                                    this.inputs.aov = Math.round(weightedAOV);
                                }
                            }
                        }
                        
                        // 3. GAP FIX: Fetch actual CPC from tracking/revenue data
                        try {
                            const revenueResponse = await fetch(`${API_URL}?action=revenue`);
                            if (revenueResponse.ok) {
                                const revData = await revenueResponse.json();
                                // Try to calculate CPC from tracking events if available
                                // This would need tracking events endpoint to provide CPC data
                            }
                        } catch (e) {
                            // Fallback
                        }
                        
                        // 4. GAP FIX: Calculate jobs-per-tech from hours logged data
                        try {
                            const hoursResponse = await fetch(`${API_URL}?action=hours&vaName=all`);
                            if (hoursResponse.ok) {
                                const hoursData = await hoursResponse.json();
                                const hours = hoursData.hours || [];
                                
                                if (hours.length > 0 && this.inputs.techs > 0) {
                                    // Calculate average hours per entry in last 30 days
                                    const thirtyDaysAgo = new Date();
                                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                                    
                                    const recentHours = hours.filter(h => {
                                        const date = new Date(h.Date || h.date || h.Logged_At);
                                        return date >= thirtyDaysAgo;
                                    });
                                    
                                    if (recentHours.length > 0) {
                                        const totalHours = recentHours.reduce((sum, h) => {
                                            return sum + (parseFloat(h.Hours || h.hours || 0));
                                        }, 0);
                                        
                                        // Estimate: 4 hours per job on average
                                        const avgJobsPerDay = (totalHours / 30) / 4 / this.inputs.techs;
                                        
                                        if (avgJobsPerDay > 0 && avgJobsPerDay < 10) {
                                            this.inputs.jobsPerTechPerDay = Math.round(avgJobsPerDay * 10) / 10;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            // Fallback
                        }
                    } catch (e) {
                        console.warn('Could not calculate intelligent defaults (inner)', e);
                    }
                } catch (e) {
                    console.warn('Could not calculate intelligent defaults (outer)', e);
                }
            },
            
            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('h2s_admin_forecast_inputs_v1');
                    if (saved) {
                        const savedData = JSON.parse(saved);
                        // Load inputs
                        if (savedData.inputs) {
                            Object.keys(savedData.inputs).forEach(key => {
                                if (savedData.inputs[key] !== undefined && savedData.inputs[key] !== null) {
                                    this.inputs[key] = savedData.inputs[key];
                                }
                            });
                        } else {
                            // Legacy format - just inputs object
                            Object.keys(savedData).forEach(key => {
                                if (savedData[key] !== undefined && savedData[key] !== null && key !== 'location') {
                                    this.inputs[key] = savedData[key];
                                }
                            });
                        }
                        // Load conversation context
                        if (savedData.context) {
                            if (savedData.context.location) {
                                this.conversationContext.location = savedData.context.location;
                            }
                            if (savedData.context.previousInputs) {
                                this.conversationContext.previousInputs = savedData.context.previousInputs;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Could not load saved forecast inputs', e);
                }
            },
            
            saveToStorage() {
                try {
                    // Save both inputs and conversation context
                    localStorage.setItem('h2s_admin_forecast_inputs_v1', JSON.stringify({
                        inputs: this.inputs,
                        context: this.conversationContext
                    }));
                } catch (e) {
                    console.warn('Could not save forecast inputs', e);
                }
            },
            
            attachListeners() {
                const container = document.getElementById('adminForecastCalculator');
                if (!container) return;
                
                // Debounced update
                let updateTimer;
                container.addEventListener('input', (e) => {
                    if (e.target.dataset.forecastInput) {
                        clearTimeout(updateTimer);
                        updateTimer = setTimeout(() => {
                            this.updateInput(e.target.dataset.forecastInput, e.target.value);
                            this.recalculate();
                        }, 300);
                    }
                });
                
                container.addEventListener('change', (e) => {
                    if (e.target.dataset.forecastInput) {
                        this.updateInput(e.target.dataset.forecastInput, e.target.value);
                        this.recalculate();
                    }
                });
            },
            
            async parseNaturalLanguage() {
                const inputEl = document.getElementById('forecastNaturalLanguageInput');
                const resultEl = document.getElementById('forecastParseResult');
                if (!inputEl || !resultEl) return;
                
                const text = inputEl.value.trim();
                if (!text) {
                    showToast('Please describe your scenario first', 'error');
                    return;
                }
                
                // Show loading
                resultEl.style.display = 'block';
                resultEl.innerHTML = '<div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid #bae6fd;"><div style="display: flex; align-items: center; gap: 8px;"><div class="spinner" style="width: 16px; height: 16px;"></div><span style="color: #075985; font-size: 13px;">Parsing scenario with AI...</span></div></div>';
                
                try {
                    // Use AI to extract metrics with location context awareness
                    const extracted = await this.extractForecastMetricsWithAI(text);
                    
                    // Update conversation context with location if found
                    if (extracted.market) {
                        this.conversationContext.location = extracted.market;
                    }
                    this.conversationContext.previousInputs = text;
                    
                    // Show extracted values for confirmation
                    const extractedSummary = this.formatExtractedMetrics(extracted);
                    const extractedJSON = this.formatExtractedJSON(extracted);
                    resultEl.innerHTML = `
                        <div style="background: white; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px;">
                            <div style="font-size: 14px; font-weight: 700; color: #0c4a6e; margin-bottom: 12px;">Extracted Metrics</div>
                            <div style="font-size: 12px; color: #075985; line-height: 1.6; margin-bottom: 16px; white-space: pre-wrap;">${extractedSummary}</div>
                            
                            <details style="margin-bottom: 16px;">
                                <summary style="font-size: 12px; font-weight: 600; color: #0c4a6e; cursor: pointer; padding: 8px; background: #f0f9ff; border-radius: 6px;">View JSON Response</summary>
                                <pre style="margin-top: 8px; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px; overflow-x: auto; max-height: 300px; overflow-y: auto; color: #334155; font-family: 'Courier New', monospace;">${extractedJSON}</pre>
                            </details>
                            
                            <div style="display: flex; gap: 8px;">
                                <button id="applyExtractedBtn" style="padding: 8px 16px; font-size: 13px; background: #0ea5e9; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Apply These Values</button>
                                <button onclick="document.getElementById('forecastParseResult').style.display='none'" style="padding: 8px 16px; font-size: 13px; background: #e5e7eb; color: #374151; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>
                    `;
                    // Attach event listener with extracted data
                    const applyBtn = document.getElementById('applyExtractedBtn');
                    if (applyBtn) {
                        applyBtn.onclick = () => {
                            this.applyExtractedMetrics(extracted);
                        };
                    }
                } catch (error) {
                    resultEl.innerHTML = `<div style="padding: 12px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca; color: #991b1b; font-size: 13px;">Error parsing: ${error.message}</div>`;
                }
            },
            
            async extractForecastMetricsWithAI(text) {
                // The actual extraction happens on the backend with improved prompt
                // Frontend just calls the API

                try {
                    const response = await fetch(`${API_URL}?action=parseForecast`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            context: this.conversationContext
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Handle both response formats: data.result.extracted or data.extracted
                        const extracted = data.result?.extracted || data.extracted;
                        if (data.ok && extracted) {
                            console.log('[Forecast] AI extraction successful:', extracted);
                            return extracted;
                        } else {
                            console.warn('[Forecast] AI extraction returned invalid response:', data);
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('[Forecast] API error:', response.status, errorText);
                    }
                    
                    // Fallback to regex-based extraction if API fails
                    console.warn('[Forecast] AI extraction failed, using regex fallback');
                    return this.extractForecastMetrics(text);
                } catch (error) {
                    console.error('[Forecast] AI extraction error:', error);
                    console.warn('[Forecast] Using regex fallback due to error');
                    return this.extractForecastMetrics(text);
                }
            },
            
            extractForecastMetrics(text) {
                const lower = text.toLowerCase();
                const extracted = {
                    dailyAdSpend: null,
                    services: [],
                    market: null,
                    techs: null,
                    jobsPerTechPerDay: null,
                    aov: null,
                    cpc: null,
                    leadToBookingRate: null,
                    bookingToCompletedRate: null,
                    cities: null,
                    creatives: null
                };
                
                // Extract daily ad spend (e.g., "$20/day", "20 dollars a day", "spending 20")
                const adSpendPatterns = [
                    /\$(\d+)\s*(?:per\s*day|\/day|a\s*day|daily)/i,
                    /spending\s*\$?(\d+)/i,
                    /ad\s*spend.*?\$?(\d+)/i,
                    /\$?(\d+)\s*(?:dollars?|bucks?)\s*(?:per\s*day|\/day|a\s*day|daily)/i
                ];
                for (const pattern of adSpendPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.dailyAdSpend = parseFloat(match[1]);
                        break;
                    }
                }
                
                // Extract services mentioned - dynamic approach (extract any service/product mentioned)
                // Look for common patterns: "for X", "doing X", "X services", "X jobs", etc.
                const servicePatterns = [
                    /(?:for|doing|offering|providing|selling)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:services?|jobs?|installations?|work)/gi,
                    /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:mounting|installation|service|repair|consulting)/gi,
                    /(?:services?|products?):\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*(?:\s*,\s*[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)*)/gi
                ];
                
                servicePatterns.forEach(pattern => {
                    const matches = [...text.matchAll(pattern)];
                    matches.forEach(match => {
                        const service = match[1].trim();
                        if (service && service.length > 2 && !extracted.services.includes(service)) {
                            extracted.services.push(service);
                        }
                    });
                });
                
                // Also check for comma-separated service lists
                const serviceListPattern = /(?:services?|products?|offerings?):\s*([^,]+(?:,\s*[^,]+)+)/i;
                const listMatch = text.match(serviceListPattern);
                if (listMatch) {
                    const services = listMatch[1].split(',').map(s => s.trim()).filter(s => s.length > 2);
                    services.forEach(service => {
                        if (!extracted.services.includes(service)) {
                            extracted.services.push(service);
                        }
                    });
                }
                
                // Extract market/location - improved to handle states properly
                // First try to match "City, State" or "City, ST" format
                const locationPatterns = [
                    // Full format: "in Greenville, South Carolina" or "Greenville, SC"
                    /(?:in|at|for)\s+([A-Z][a-zA-Z\s]+?),\s*([A-Z][a-zA-Z]+|[A-Z]{2})\b/gi,
                    // Direct mention: "Greenville, South Carolina" or "Greenville, SC"
                    /\b([A-Z][a-zA-Z\s]+?),\s*([A-Z][a-zA-Z]+|[A-Z]{2})\b/g
                ];
                
                let locationFound = false;
                for (const pattern of locationPatterns) {
                    const matches = [...text.matchAll(pattern)];
                    if (matches.length > 0) {
                        const city = matches[0][1].trim();
                        const state = matches[0][2].trim();
                        // Use previous context if we have it and city matches
                        if (this.conversationContext.location && city.toLowerCase().includes(this.conversationContext.location.split(',')[0].toLowerCase())) {
                            extracted.market = this.conversationContext.location;
                        } else {
                            extracted.market = `${city}, ${state}`;
                        }
                        locationFound = true;
                        break;
                    }
                }
                
                // If no full format found, look for city names and use context if available
                if (!locationFound) {
                    // Check if we have previous location context and the city name appears
                    if (this.conversationContext.location) {
                        const prevCity = this.conversationContext.location.split(',')[0].toLowerCase();
                        const cityPattern = new RegExp(`\\b${prevCity}\\b`, 'i');
                        if (cityPattern.test(text)) {
                            extracted.market = this.conversationContext.location;
                            locationFound = true;
                        }
                    }
                    
                    // Don't default to any specific location - only use what's explicitly mentioned or from context
                }
                
                // Extract number of techs
                const techPatterns = [
                    /(\d+)\s*(?:tech|technician|worker|installer)/i,
                    /(?:have|with|using)\s*(\d+)\s*(?:tech|technician)/i
                ];
                for (const pattern of techPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.techs = parseInt(match[1]);
                        break;
                    }
                }
                
                // Extract jobs per tech per day
                const jobsPatterns = [
                    /(\d+(?:\.\d+)?)\s*(?:jobs?|installations?)\s*(?:per\s*tech|per\s*technician|per\s*day)/i,
                    /(?:doing|handling|completing)\s*(\d+(?:\.\d+)?)\s*(?:jobs?|installations?)\s*(?:per\s*day)/i
                ];
                for (const pattern of jobsPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.jobsPerTechPerDay = parseFloat(match[1]);
                        break;
                    }
                }
                
                // Extract AOV (average order value)
                const aovPatterns = [
                    /(?:aov|average\s*order|order\s*value).*?\$?(\d+)/i,
                    /\$?(\d+)\s*(?:per\s*order|per\s*job|average)/i
                ];
                for (const pattern of aovPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const val = parseFloat(match[1]);
                        if (val > 50 && val < 5000) { // Reasonable range
                            extracted.aov = val;
                            break;
                        }
                    }
                }
                
                // Extract CPC/Cost per lead
                const cpcPatterns = [
                    /(?:cpc|cost\s*per\s*lead).*?\$?(\d+)/i,
                    /\$?(\d+)\s*(?:per\s*lead|per\s*click)/i
                ];
                for (const pattern of cpcPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.cpc = parseFloat(match[1]);
                        break;
                    }
                }
                
                // Extract conversion rates
                const leadToBookingPatterns = [
                    /(?:lead.*?booking|booking\s*rate).*?(\d+)%/i,
                    /(\d+)%\s*(?:lead.*?booking|conversion)/i
                ];
                for (const pattern of leadToBookingPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.leadToBookingRate = parseFloat(match[1]);
                        break;
                    }
                }
                
                // Extract number of creatives
                const creativePatterns = [
                    /(\d+)\s*(?:creative|ad|campaign)/i,
                    /(?:have|running|deploy).*?(\d+)\s*(?:creative|ad)/i
                ];
                for (const pattern of creativePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.creatives = parseInt(match[1]);
                        break;
                    }
                }
                
                // Extract cities
                const citiesPatterns = [
                    /(\d+)\s*(?:cities?|markets?|areas?)/i,
                    /(?:in|across)\s*(\d+)\s*(?:cities?|markets?)/i
                ];
                for (const pattern of citiesPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        extracted.cities = parseInt(match[1]);
                        break;
                    }
                }
                
                return extracted;
            },
            
            formatExtractedMetrics(extracted) {
                const found = [];
                const notFound = [];
                
                if (extracted.dailyAdSpend !== null && extracted.dailyAdSpend !== undefined) {
                    found.push(`OK Daily Ad Spend: $${extracted.dailyAdSpend}/day`);
                } else {
                    notFound.push('Daily Ad Spend');
                }
                
                if (extracted.services && extracted.services.length > 0) {
                    found.push(`OK Services: ${extracted.services.join(', ')}`);
                } else {
                    notFound.push('Services');
                }
                
                if (extracted.market) {
                    found.push(`OK Market/Location: ${extracted.market}`);
                } else {
                    notFound.push('Market/Location');
                }
                
                if (extracted.techs !== null && extracted.techs !== undefined) {
                    found.push(`OK Techs/Workers: ${extracted.techs}`);
                } else {
                    notFound.push('Techs/Workers');
                }
                
                if (extracted.jobsPerTechPerDay !== null && extracted.jobsPerTechPerDay !== undefined) {
                    found.push(`OK Jobs per Tech/Day: ${extracted.jobsPerTechPerDay}`);
                } else {
                    notFound.push('Jobs per Tech/Day');
                }
                
                if (extracted.aov !== null && extracted.aov !== undefined) {
                    found.push(`OK AOV (Avg Order Value): $${extracted.aov}`);
                } else {
                    notFound.push('AOV');
                }
                
                if (extracted.cpc !== null && extracted.cpc !== undefined) {
                    found.push(`OK CPC (Cost per Lead): $${extracted.cpc}`);
                } else {
                    notFound.push('CPC');
                }
                
                if (extracted.leadToBookingRate !== null && extracted.leadToBookingRate !== undefined) {
                    found.push(`OK Lead to Booking Rate: ${extracted.leadToBookingRate}%`);
                } else {
                    notFound.push('Lead to Booking Rate');
                }
                
                if (extracted.bookingToCompletedRate !== null && extracted.bookingToCompletedRate !== undefined) {
                    found.push(`OK Booking to Completed Rate: ${extracted.bookingToCompletedRate}%`);
                } else {
                    notFound.push('Booking to Completed Rate');
                }
                
                if (extracted.cities !== null && extracted.cities !== undefined) {
                    found.push(`OK Cities/Markets: ${extracted.cities}`);
                } else {
                    notFound.push('Cities');
                }
                
                if (extracted.creatives !== null && extracted.creatives !== undefined) {
                    found.push(`OK Creatives/Ads: ${extracted.creatives}`);
                } else {
                    notFound.push('Creatives');
                }
                
                let output = '';
                if (found.length > 0) {
                    output += found.join('\n');
                }
                
                if (notFound.length > 0 && found.length > 0) {
                    output += `\n\nNot found (will use current defaults):\n${notFound.map(m => `- ${m}`).join('\n')}`;
                } else if (notFound.length > 0) {
                    output = `No metrics extracted. Please be more specific. Mention:\n${notFound.map(m => `- ${m}`).join('\n')}`;
                }
                
                return output || 'No metrics could be extracted. Try being more specific.';
            },
            
            formatExtractedJSON(extracted) {
                // Create a clean JSON representation showing what was extracted vs defaults
                const json = {
                    extracted: {},
                    defaults: {},
                    willApply: {}
                };
                
                // Add extracted values (only non-null)
                if (extracted.dailyAdSpend !== null && extracted.dailyAdSpend !== undefined) {
                    json.extracted.dailyAdSpend = extracted.dailyAdSpend;
                }
                if (extracted.services && extracted.services.length > 0) {
                    json.extracted.services = extracted.services;
                }
                if (extracted.market) {
                    json.extracted.market = extracted.market;
                }
                if (extracted.techs !== null && extracted.techs !== undefined) {
                    json.extracted.techs = extracted.techs;
                }
                if (extracted.jobsPerTechPerDay !== null && extracted.jobsPerTechPerDay !== undefined) {
                    json.extracted.jobsPerTechPerDay = extracted.jobsPerTechPerDay;
                }
                if (extracted.aov !== null && extracted.aov !== undefined) {
                    json.extracted.aov = extracted.aov;
                }
                if (extracted.cpc !== null && extracted.cpc !== undefined) {
                    json.extracted.cpc = extracted.cpc;
                }
                if (extracted.leadToBookingRate !== null && extracted.leadToBookingRate !== undefined) {
                    json.extracted.leadToBookingRate = extracted.leadToBookingRate;
                }
                if (extracted.bookingToCompletedRate !== null && extracted.bookingToCompletedRate !== undefined) {
                    json.extracted.bookingToCompletedRate = extracted.bookingToCompletedRate;
                }
                if (extracted.cities !== null && extracted.cities !== undefined) {
                    json.extracted.cities = extracted.cities;
                }
                if (extracted.creatives !== null && extracted.creatives !== undefined) {
                    json.extracted.creatives = extracted.creatives;
                }
                
                // Add current defaults (what will be used if not extracted)
                json.defaults = { ...this.inputs };
                
                // Calculate what will actually be applied (extracted overrides defaults)
                json.willApply = { ...this.inputs };
                if (extracted.dailyAdSpend !== null && extracted.dailyAdSpend !== undefined && !isNaN(extracted.dailyAdSpend)) {
                    json.willApply.dailyAdSpend = parseFloat(extracted.dailyAdSpend);
                }
                if (extracted.techs !== null && extracted.techs !== undefined && !isNaN(extracted.techs)) {
                    json.willApply.techs = parseInt(extracted.techs);
                }
                if (extracted.jobsPerTechPerDay !== null && extracted.jobsPerTechPerDay !== undefined && !isNaN(extracted.jobsPerTechPerDay)) {
                    json.willApply.jobsPerTechPerDay = parseFloat(extracted.jobsPerTechPerDay);
                }
                if (extracted.aov !== null && extracted.aov !== undefined && !isNaN(extracted.aov) && extracted.aov > 0) {
                    json.willApply.aov = parseFloat(extracted.aov);
                }
                if (extracted.cpc !== null && extracted.cpc !== undefined && !isNaN(extracted.cpc) && extracted.cpc > 0) {
                    json.willApply.cpc = parseFloat(extracted.cpc);
                }
                if (extracted.leadToBookingRate !== null && extracted.leadToBookingRate !== undefined && !isNaN(extracted.leadToBookingRate)) {
                    json.willApply.leadToBookingRate = parseFloat(extracted.leadToBookingRate);
                }
                if (extracted.bookingToCompletedRate !== null && extracted.bookingToCompletedRate !== undefined && !isNaN(extracted.bookingToCompletedRate)) {
                    json.willApply.bookingToCompletedRate = parseFloat(extracted.bookingToCompletedRate);
                }
                if (extracted.cities !== null && extracted.cities !== undefined && !isNaN(extracted.cities) && extracted.cities > 0) {
                    json.willApply.cities = parseInt(extracted.cities);
                }
                
                return JSON.stringify(json, null, 2);
            },
            
            applyExtractedMetrics(extracted) {
                let appliedCount = 0;
                const appliedItems = [];
                
                // Only apply non-null, non-undefined values
                if (extracted.dailyAdSpend !== null && extracted.dailyAdSpend !== undefined && !isNaN(extracted.dailyAdSpend)) {
                    this.inputs.dailyAdSpend = parseFloat(extracted.dailyAdSpend);
                    appliedItems.push('Daily Ad Spend');
                    appliedCount++;
                }
                
                if (extracted.techs !== null && extracted.techs !== undefined && !isNaN(extracted.techs)) {
                    this.inputs.techs = parseInt(extracted.techs);
                    appliedItems.push('Techs');
                    appliedCount++;
                }
                
                if (extracted.jobsPerTechPerDay !== null && extracted.jobsPerTechPerDay !== undefined && !isNaN(extracted.jobsPerTechPerDay)) {
                    this.inputs.jobsPerTechPerDay = parseFloat(extracted.jobsPerTechPerDay);
                    appliedItems.push('Jobs per Tech/Day');
                    appliedCount++;
                }
                
                if (extracted.aov !== null && extracted.aov !== undefined && !isNaN(extracted.aov) && extracted.aov > 0) {
                    this.inputs.aov = parseFloat(extracted.aov);
                    appliedItems.push('AOV');
                    appliedCount++;
                }
                
                if (extracted.cpc !== null && extracted.cpc !== undefined && !isNaN(extracted.cpc) && extracted.cpc > 0) {
                    this.inputs.cpc = parseFloat(extracted.cpc);
                    appliedItems.push('CPC');
                    appliedCount++;
                }
                
                if (extracted.leadToBookingRate !== null && extracted.leadToBookingRate !== undefined && !isNaN(extracted.leadToBookingRate) && extracted.leadToBookingRate >= 0 && extracted.leadToBookingRate <= 100) {
                    this.inputs.leadToBookingRate = parseFloat(extracted.leadToBookingRate);
                    appliedItems.push('Lead to Booking Rate');
                    appliedCount++;
                }
                
                if (extracted.bookingToCompletedRate !== null && extracted.bookingToCompletedRate !== undefined && !isNaN(extracted.bookingToCompletedRate) && extracted.bookingToCompletedRate >= 0 && extracted.bookingToCompletedRate <= 100) {
                    this.inputs.bookingToCompletedRate = parseFloat(extracted.bookingToCompletedRate);
                    appliedItems.push('Booking to Completed Rate');
                    appliedCount++;
                }
                
                if (extracted.cities !== null && extracted.cities !== undefined && !isNaN(extracted.cities) && extracted.cities > 0) {
                    this.inputs.cities = parseInt(extracted.cities);
                    appliedItems.push('Cities');
                    appliedCount++;
                }
                
                if (extracted.creatives !== null && extracted.creatives !== undefined && !isNaN(extracted.creatives) && extracted.creatives > 0) {
                    this.inputs.creatives = parseInt(extracted.creatives);
                    appliedItems.push('Creatives');
                    appliedCount++;
                }
                
                // Store extracted metadata (market, services) even if not directly used in calculations
                if (extracted.market) {
                    this.inputs.market = extracted.market;
                    this.conversationContext.location = extracted.market; // Also update context
                    appliedItems.push('Market/Location');
                    appliedCount++;
                }
                
                if (extracted.services && Array.isArray(extracted.services) && extracted.services.length > 0) {
                    this.inputs.services = extracted.services;
                    appliedItems.push('Services');
                    appliedCount++;
                }
                
                // Save and re-render
                this.saveToStorage();
                this.render();
                this.recalculate();
                
                // Hide parse result
                document.getElementById('forecastParseResult').style.display = 'none';
                
                if (appliedCount > 0) {
                    showToast(`Applied ${appliedCount} metric(s): ${appliedItems.join(', ')}`, 'success');
                } else {
                    showToast('No valid metrics found to apply', 'error');
                }
            },
            
            estimateServiceAOV(services) {
                // GAP FIX #3: Service-specific AOV estimation
                const serviceAOVs = {
                    'TV Mount': 300, 'TV mounting': 300, 'TV': 300,
                    'Cameras': 800, 'Camera': 800, 'camera mounting': 800, 'Security': 800,
                    'Doorbell': 400, 'Ring': 400,
                    'WiFi': 300, 'Network': 300, 'Mesh': 350,
                    'Bundle': 1200, 'Package': 1200
                };
                
                if (!services || services.length === 0) return 300;
                
                const values = services
                    .map(s => {
                        const key = Object.keys(serviceAOVs).find(k => 
                            s.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(s.toLowerCase())
                        );
                        return serviceAOVs[key] || 300;
                    })
                    .filter(v => v);
                
                return values.length > 0 ? Math.round(values.reduce((a, b) => a + b, 0) / values.length) : 300;
            },
            
            // GAP FIX #6: What-If Scenario Modeling
            generateScenarios() {
                const i = this.inputs;
                const base = this.calculate();
                
                // Conservative scenario (-10% conversion rates, +10% costs)
                const conservative = {
                    leadToBookingRate: i.leadToBookingRate * 0.9,
                    bookingToCompletedRate: i.bookingToCompletedRate * 0.9,
                    cpc: i.cpc * 1.1,
                    aov: i.aov * 0.95
                };
                
                // Aggressive scenario (+15% conversion, -10% costs)
                const aggressive = {
                    leadToBookingRate: Math.min(100, i.leadToBookingRate * 1.15),
                    bookingToCompletedRate: Math.min(100, i.bookingToCompletedRate * 1.05),
                    cpc: i.cpc * 0.9,
                    aov: i.aov * 1.05
                };
                
                // Calculate each scenario
                const calcScenario = (mods) => {
                    const modInputs = { ...i, ...mods };
                    const dailyCapacity = modInputs.techs * modInputs.jobsPerTechPerDay * (modInputs.rampFactor / 100);
                    const monthlyCapacity = dailyCapacity * modInputs.workDaysPerMonth;
                    const completedJobs = monthlyCapacity;
                    const bookings = completedJobs / (modInputs.bookingToCompletedRate / 100);
                    const leads = bookings / (modInputs.leadToBookingRate / 100);
                    const monthlyAdSpend = modInputs.dailyAdSpend * 30;
                    const revenue = completedJobs * modInputs.aov;
                    const profit = revenue - (completedJobs * modInputs.aov * 0.35) - (completedJobs * modInputs.equipCostPerJob) - (completedJobs * modInputs.overheadPerJob) - monthlyAdSpend;
                    return { revenue, profit, margin: revenue > 0 ? (profit / revenue) * 100 : 0, leads };
                };
                
                return {
                    conservative: { ...calcScenario(conservative), label: 'Conservative (-10%)' },
                    base: { ...base, label: 'Base Case' },
                    aggressive: { ...calcScenario(aggressive), label: 'Aggressive (+15%)' }
                };
            },
            
            // GAP FIX #9: Industry Benchmark Comparison
            getIndustryBenchmarks() {
                return {
                    cpc: { avg: 18, good: 12, excellent: 8 },
                    leadToBookingRate: { avg: 25, good: 30, excellent: 35 },
                    bookingToCompletedRate: { avg: 80, good: 85, excellent: 90 },
                    netMargin: { avg: 10, good: 15, excellent: 20 },
                    adSpendPercent: { avg: 25, good: 20, excellent: 15 }
                };
            },
            
            // GAP FIX #8: Early Warning System
            generateEarlyWarnings(results) {
                const i = this.inputs;
                const warnings = [];
                const benchmarks = this.getIndustryBenchmarks();
                
                // Early warnings at 80% of thresholds
                if (i.leadToBookingRate < benchmarks.leadToBookingRate.avg * 0.8) {
                    warnings.push({ level: 'warning', message: `Booking rate (${i.leadToBookingRate}%) approaching threshold - optimize follow-up` });
                }
                
                if (i.bookingToCompletedRate < benchmarks.bookingToCompletedRate.avg * 0.8) {
                    warnings.push({ level: 'warning', message: `Show rate (${i.bookingToCompletedRate}%) approaching threshold - review booking process` });
                }
                
                if (results.netMargin < benchmarks.netMargin.avg * 0.8 && results.netMargin > 0) {
                    warnings.push({ level: 'warning', message: `Margin (${results.netMargin.toFixed(1)}%) below target - review costs` });
                }
                
                const adSpendPercent = results.monthlyRevenue > 0 ? (results.monthlyAdSpend / results.monthlyRevenue) * 100 : 0;
                if (adSpendPercent > benchmarks.adSpendPercent.avg * 0.8 && adSpendPercent < benchmarks.adSpendPercent.avg) {
                    warnings.push({ level: 'info', message: `Ad spend at ${adSpendPercent.toFixed(1)}% of revenue - monitor efficiency` });
                }
                
                // Capacity utilization warning
                const capacityUtil = (i.jobsPerTechPerDay / 5) * 100; // 5 jobs/day = 100% utilization
                if (capacityUtil < 50) {
                    warnings.push({ level: 'info', message: `Low capacity utilization (${capacityUtil.toFixed(0)}%) - consider adding jobs or reducing techs` });
                } else if (capacityUtil > 90) {
                    warnings.push({ level: 'warning', message: `High capacity utilization (${capacityUtil.toFixed(0)}%) - risk of burnout or delays` });
                }
                
                return warnings;
            },
            
            // GAP FIX #14: Extraction-Driven Intelligence
            detectBusinessStage(extractedText) {
                const lower = extractedText.toLowerCase();
                const indicators = {
                    early: ['first customers', 'getting started', 'just starting', 'looking to acquire', 'early stage', 'new'],
                    scaling: ['scale', 'growing', 'expanding', 'adding', 'increase', 'ramp up'],
                    established: ['current', 'existing', 'running', 'operating', 'active']
                };
                
                for (const [stage, keywords] of Object.entries(indicators)) {
                    if (keywords.some(kw => lower.includes(kw))) {
                        return stage;
                    }
                }
                return 'unknown';
            },
            
            // GAP FIX #11: Intelligent Default Ranges
            getDefaultRanges(field) {
                const ranges = {
                    cpc: { min: 10, max: 30, typical: '15-20', unit: '$' },
                    leadToBookingRate: { min: 15, max: 40, typical: '20-30', unit: '%' },
                    bookingToCompletedRate: { min: 70, max: 95, typical: '80-90', unit: '%' },
                    jobsPerTechPerDay: { min: 1, max: 6, typical: '2-4', unit: 'jobs' },
                    aov: { min: 200, max: 1500, typical: '300-800', unit: '$' },
                    netMargin: { min: 5, max: 25, typical: '10-15', unit: '%' }
                };
                return ranges[field] || null;
            },
            
            // Scenario Analysis
            runScenarioAnalysis(inputs) {
                const scenarios = {
                    conservative: { modifier: 0.8, label: 'Conservative' },
                    expected: { modifier: 1.0, label: 'Expected' },
                    optimistic: { modifier: 1.2, label: 'Optimistic' }
                };
                const results = {};
                
                Object.keys(scenarios).forEach(key => {
                    const mod = scenarios[key].modifier;
                    const i = { ...inputs };
                    
                    // Adjust key variables
                    i.leadToBookingRate = Math.min(100, i.leadToBookingRate * mod);
                    i.bookingToCompletedRate = Math.min(100, i.bookingToCompletedRate * mod);
                    i.dailyAdSpend = i.dailyAdSpend * mod;
                    
                    // Recalculate
                    const dailyCapacity = i.techs * i.jobsPerTechPerDay * (i.rampFactor / 100);
                    const monthlyCapacity = dailyCapacity * i.workDaysPerMonth;
                    const completedJobsNeeded = monthlyCapacity;
                    const bookingsNeeded = completedJobsNeeded / (i.bookingToCompletedRate / 100) / (1 - i.cancelRate / 100);
                    const leadsNeeded = bookingsNeeded / (i.leadToBookingRate / 100);
                    const monthlyAdSpend = i.dailyAdSpend * 30;
                    const cpl = i.cpc || (monthlyAdSpend / leadsNeeded);
                    const cac = cpl / (i.leadToBookingRate / 100);
                    const monthlyRevenue = completedJobsNeeded * i.aov;
                    const techPayoutTotal = completedJobsNeeded * (i.aov * i.techPayoutPct / 100);
                    const equipCostTotal = completedJobsNeeded * i.equipCostPerJob;
                    const overheadTotal = completedJobsNeeded * i.overheadPerJob;
                    const grossProfit = monthlyRevenue - techPayoutTotal - equipCostTotal;
                    const netProfit = grossProfit - overheadTotal - monthlyAdSpend;
                    const netMargin = monthlyRevenue > 0 ? (netProfit / monthlyRevenue) * 100 : 0;
                    
                    results[key] = {
                        label: scenarios[key].label,
                        monthlyRevenue: monthlyRevenue,
                        netProfit: netProfit,
                        netMargin: netMargin,
                        leadsNeeded: leadsNeeded,
                        monthlyAdSpend: monthlyAdSpend
                    };
                });
                
                return results;
            },
            
            // GAP FIX #8: Early Warning System
            generateEarlyWarnings(inputs, results) {
                const warnings = [];
                
                // Ad spend approaching 30% threshold
                if (results.monthlyRevenue > 0) {
                    const adSpendPct = (results.monthlyAdSpend / results.monthlyRevenue) * 100;
                    if (adSpendPct >= 24 && adSpendPct < 30) {
                        warnings.push({
                            type: 'warning',
                            message: `Ad spend at ${adSpendPct.toFixed(1)}% of revenue - approaching 30% threshold`,
                            suggestion: 'Optimize CPC or improve conversion rates to reduce ad spend ratio'
                        });
                    }
                }
                
                // Margin approaching 10% target
                if (results.netMargin >= 8 && results.netMargin < 10) {
                    warnings.push({
                        type: 'warning',
                        message: `Net margin at ${results.netMargin.toFixed(1)}% - close to 10% target`,
                        suggestion: `Increase margin by ${(10 - results.netMargin).toFixed(1)}% to hit target`
                    });
                }
                
                // Conversion rates approaching thresholds
                if (results.leadToBookingRate >= 18 && results.leadToBookingRate < 20) {
                    warnings.push({
                        type: 'warning',
                        message: `Lead-to-booking rate at ${results.leadToBookingRate}% - approaching 20% threshold`,
                        suggestion: 'Optimize follow-up process or improve offer clarity'
                    });
                }
                
                if (results.bookingToCompletedRate >= 76 && results.bookingToCompletedRate < 80) {
                    warnings.push({
                        type: 'warning',
                        message: `Show rate at ${results.bookingToCompletedRate}% - approaching 80% threshold`,
                        suggestion: 'Add booking confirmations or reduce booking window'
                    });
                }
                
                // CAC approaching break-even
                if (results.cac > 0 && results.breakEvenCAC > 0) {
                    const ratio = results.cac / results.breakEvenCAC;
                    if (ratio >= 0.9 && ratio < 1.0) {
                        warnings.push({
                            type: 'warning',
                            message: `CAC at ${(ratio * 100).toFixed(0)}% of break-even - optimize soon`,
                            suggestion: `Reduce CPC by $${((results.cac - results.breakEvenCAC) * 0.8).toFixed(2)} to get below break-even`
                        });
                    }
                }
                
                return warnings;
            },
            
            // GAP FIX #9: Industry Benchmark Comparison
            compareToBenchmarks(inputs, metrics) {
                // Industry benchmarks for service businesses
                const benchmarks = {
                    cpc: { avg: 18, good: 12, excellent: 8 },
                    leadToBookingRate: { avg: 25, good: 30, excellent: 35 },
                    bookingToCompletedRate: { avg: 82, good: 85, excellent: 90 },
                    netMargin: { avg: 12, good: 15, excellent: 20 }
                };
                
                const comparisons = {};
                
                // Compare CPC
                if (metrics.cpc) {
                    const avg = benchmarks.cpc.avg;
                    comparisons.cpc = {
                        value: metrics.cpc,
                        benchmark: avg,
                        status: metrics.cpc <= benchmarks.cpc.excellent ? 'excellent' :
                               metrics.cpc <= benchmarks.cpc.good ? 'good' :
                               metrics.cpc <= avg ? 'average' : 'below',
                        message: metrics.cpc <= avg ? 
                            `Good: ${avg - metrics.cpc}% below industry average` :
                            `Watch: ${((metrics.cpc - avg) / avg * 100).toFixed(0)}% above industry average`
                    };
                }
                
                // Compare conversion rates
                if (metrics.leadToBookingRate) {
                    const avg = benchmarks.leadToBookingRate.avg;
                    comparisons.leadToBookingRate = {
                        value: metrics.leadToBookingRate,
                        benchmark: avg,
                        status: metrics.leadToBookingRate >= benchmarks.leadToBookingRate.excellent ? 'excellent' :
                               metrics.leadToBookingRate >= benchmarks.leadToBookingRate.good ? 'good' :
                               metrics.leadToBookingRate >= avg ? 'average' : 'below',
                        message: metrics.leadToBookingRate >= avg ?
                            `Good: ${((metrics.leadToBookingRate - avg) / avg * 100).toFixed(0)}% above industry average` :
                            `Watch: ${(avg - metrics.leadToBookingRate).toFixed(0)}% below industry average`
                    };
                }
                
                if (metrics.bookingToCompletedRate) {
                    const avg = benchmarks.bookingToCompletedRate.avg;
                    comparisons.bookingToCompletedRate = {
                        value: metrics.bookingToCompletedRate,
                        benchmark: avg,
                        status: metrics.bookingToCompletedRate >= benchmarks.bookingToCompletedRate.excellent ? 'excellent' :
                               metrics.bookingToCompletedRate >= benchmarks.bookingToCompletedRate.good ? 'good' :
                               metrics.bookingToCompletedRate >= avg ? 'average' : 'below',
                        message: metrics.bookingToCompletedRate >= avg ?
                            `Good: ${((metrics.bookingToCompletedRate - avg) / avg * 100).toFixed(0)}% above industry average` :
                            `Watch: ${(avg - metrics.bookingToCompletedRate).toFixed(0)}% below industry average`
                    };
                }
                
                // Compare margin
                if (metrics.netMargin !== undefined) {
                    const avg = benchmarks.netMargin.avg;
                    comparisons.netMargin = {
                        value: metrics.netMargin,
                        benchmark: avg,
                        status: metrics.netMargin >= benchmarks.netMargin.excellent ? 'excellent' :
                               metrics.netMargin >= benchmarks.netMargin.good ? 'good' :
                               metrics.netMargin >= avg ? 'average' : 'below',
                        message: metrics.netMargin >= avg ?
                            `Good: ${((metrics.netMargin - avg) / avg * 100).toFixed(0)}% above industry average` :
                            `Watch: ${(avg - metrics.netMargin).toFixed(1)}% below industry average`
                    };
                }
                
                return comparisons;
            },
            
            // GAP FIX #14: Analyze business stage from extracted text
            analyzeBusinessStage(text, extracted) {
                const lower = text.toLowerCase();
                const context = { stage: null, adjustments: {} };
                
                // Detect early stage indicators
                if (lower.includes('first customers') || 
                    lower.includes('getting started') || 
                    lower.includes('just starting') ||
                    lower.includes('acquiring first') ||
                    lower.includes('launching')) {
                    context.stage = 'early';
                    context.adjustments = {
                        leadToBookingRate: null, // Early stage = no data yet
                        bookingToCompletedRate: null,
                        note: 'Early stage business - rates unknown, use industry benchmarks'
                    };
                }
                
                // Detect scaling/growth stage
                if (lower.includes('scaling') || 
                    lower.includes('growing') || 
                    lower.includes('expanding') ||
                    lower.includes('ramping up')) {
                    context.stage = 'scaling';
                    context.adjustments = {
                        rampFactor: 85, // Lower utilization during growth
                        note: 'Scaling phase - capacity may be partially utilized'
                    };
                }
                
                // Detect mature/optimized stage
                if (lower.includes('optimized') || 
                    lower.includes('established') || 
                    lower.includes('mature') ||
                    lower.includes('efficient')) {
                    context.stage = 'mature';
                    context.adjustments = {
                        rampFactor: 95, // Higher utilization
                        note: 'Mature operation - higher capacity utilization expected'
                    };
                }
                
                return context;
            },
            
            // GAP FIX #14: Apply stage-specific defaults
            applyStageDefaults(stage, extracted) {
                if (stage === 'early') {
                    // For early stage, don't override rates if null (they're unknown)
                    // But set realistic industry defaults if they weren't extracted
                    if (!extracted.leadToBookingRate) {
                        this.inputs.leadToBookingRate = 20; // Conservative for early stage
                    }
                    if (!extracted.bookingToCompletedRate) {
                        this.inputs.bookingToCompletedRate = 75; // Lower for early stage
                    }
                } else if (stage === 'scaling') {
                    if (this.inputs.rampFactor > 90) {
                        this.inputs.rampFactor = 85; // Account for growth inefficiency
                    }
                }
            },
            
            // GAP FIX #11: Intelligent Default Ranges
            getInputRange(field, currentValue) {
                const ranges = {
                    jobsPerTechPerDay: { typical: '2-4', excellent: '4-5', note: 'Typical: 2-4 jobs/day, Excellent: 4-5 jobs/day' },
                    leadToBookingRate: { typical: '20-30%', excellent: '30-35%', note: 'Industry average: 25%, Good: 30%+' },
                    bookingToCompletedRate: { typical: '80-85%', excellent: '85-90%', note: 'Industry average: 82%, Good: 85%+' },
                    cpc: { typical: '$12-20', excellent: '$8-12', note: 'Industry average: $18, Good: <$12' },
                    netMargin: { typical: '10-15%', excellent: '15-20%', note: 'Industry average: 12%, Good: 15%+' },
                    dailyAdSpend: { typical: '$20-50', excellent: '$50-100+', note: 'Growth range: $20-100/day' }
                };
                
                if (ranges[field]) {
                    const range = ranges[field];
                    let status = '';
                    if (field === 'jobsPerTechPerDay') {
                        if (currentValue >= 4) status = ' (Excellent)';
                        else if (currentValue >= 2) status = ' (Typical)';
                        else status = ' (Below typical)';
                    } else if (field.includes('Rate') || field === 'netMargin') {
                        const match = range.typical.match(/(\d+)-(\d+)/);
                        if (match && currentValue >= parseFloat(match[1]) && currentValue <= parseFloat(match[2])) {
                            status = ' (In typical range)';
                        } else if (currentValue < parseFloat(match[1])) {
                            status = ' (Below typical)';
                        }
                    }
                    return range.note + status;
                }
                return '';
            },
            
            updateInput(key, value) {
                const numValue = parseFloat(value) || 0;
                if (key in this.inputs) {
                    this.inputs[key] = numValue;
                    this.saveToStorage();
                }
            },
            
            calculate() {
                const i = this.inputs;
                
                // Capacity calculations
                const dailyCapacity = i.techs * i.jobsPerTechPerDay * (i.rampFactor / 100);
                const monthlyCapacity = dailyCapacity * i.workDaysPerMonth;
                
                // Funnel calculations
                const completedJobsNeeded = monthlyCapacity; // Use capacity as target
                const bookingsNeeded = completedJobsNeeded / (i.bookingToCompletedRate / 100) / (1 - i.cancelRate / 100);
                const leadsNeeded = bookingsNeeded / (i.leadToBookingRate / 100);
                
                // Cost calculations
                const monthlyAdSpend = i.dailyAdSpend * 30;
                const cpl = i.cpc || (monthlyAdSpend / leadsNeeded);
                const cac = cpl / (i.leadToBookingRate / 100);
                
                // Revenue calculations
                const monthlyRevenue = completedJobsNeeded * i.aov;
                const techPayoutTotal = completedJobsNeeded * (i.aov * i.techPayoutPct / 100);
                const equipCostTotal = completedJobsNeeded * i.equipCostPerJob;
                const overheadTotal = completedJobsNeeded * i.overheadPerJob;
                const grossProfit = monthlyRevenue - techPayoutTotal - equipCostTotal;
                const netProfit = grossProfit - overheadTotal - monthlyAdSpend;
                const grossMarginActual = monthlyRevenue > 0 ? (grossProfit / monthlyRevenue) * 100 : 0;
                const netMargin = monthlyRevenue > 0 ? (netProfit / monthlyRevenue) * 100 : 0;
                
                // Daily/Weekly breakdowns
                const dailyRevenue = monthlyRevenue / 30;
                const weeklyRevenue = monthlyRevenue / 4.33;
                const dailyProfit = netProfit / 30;
                const weeklyProfit = netProfit / 4.33;
                
                // Required jobs per day/tech
                const requiredJobsPerDay = completedJobsNeeded / i.workDaysPerMonth;
                const requiredJobsPerTech = requiredJobsPerDay / i.techs;
                
                // Break-even CAC
                const breakEvenCAC = (grossProfit - overheadTotal) / leadsNeeded;
                
                // What has to be true constraints
                const constraints = [];
                const recommendations = []; // GAP FIX #2: Dynamic recommendations
                
                if (requiredJobsPerTech > i.jobsPerTechPerDay) {
                    constraints.push(`Need ${requiredJobsPerTech.toFixed(1)} jobs/tech/day (currently ${i.jobsPerTechPerDay})`);
                    // GAP FIX: Add recommendation
                    const additionalJobs = requiredJobsPerTech - i.jobsPerTechPerDay;
                    recommendations.push(`Increase capacity: Add ${additionalJobs.toFixed(1)} jobs/tech/day OR add ${Math.ceil((requiredJobsPerTech / i.jobsPerTechPerDay) - 1)} more techs`);
                }
                
                if (cac > breakEvenCAC) {
                    constraints.push(`CAC ($${cac.toFixed(2)}) exceeds break-even ($${breakEvenCAC.toFixed(2)})`);
                    // GAP FIX: Calculate target CPC
                    const maxCPC = breakEvenCAC * (i.leadToBookingRate / 100);
                    recommendations.push(`Reduce CPC to $${maxCPC.toFixed(2)} or improve booking rate to ${Math.ceil((i.cpc / breakEvenCAC) * 100)}%`);
                }
                
                if (i.leadToBookingRate < 20) {
                    constraints.push(`Lead-to-booking rate (${i.leadToBookingRate}%) is below 20% threshold`);
                    recommendations.push(`Improve booking rate by ${(20 - i.leadToBookingRate).toFixed(1)}%: Review follow-up process, offer clarity, or scheduling ease`);
                }
                
                if (i.bookingToCompletedRate < 80) {
                    constraints.push(`Booking-to-completed rate (${i.bookingToCompletedRate}%) is below 80% threshold`);
                    recommendations.push(`Improve show rate by ${(80 - i.bookingToCompletedRate).toFixed(1)}%: Add reminders, confirmations, or reduce booking window`);
                }
                
                if (netMargin < 10) {
                    constraints.push(`Net margin (${netMargin.toFixed(1)}%) is below 10% target`);
                    // GAP FIX: Calculate what needs to change
                    const targetProfit = monthlyRevenue * 0.1;
                    const currentProfit = netProfit;
                    const gap = targetProfit - currentProfit;
                    if (gap > 0) {
                        const reduceBy = (gap / monthlyRevenue) * 100;
                        recommendations.push(`Increase margin by ${reduceBy.toFixed(1)}%: Reduce costs by $${Math.ceil(gap)}/month OR increase AOV by $${Math.ceil(gap / completedJobsNeeded)}`);
                    }
                }
                
                if (monthlyAdSpend > monthlyRevenue * 0.3) {
                    constraints.push(`Ad spend (${(monthlyAdSpend / monthlyRevenue * 100).toFixed(1)}% of revenue) exceeds 30% threshold`);
                    const targetSpend = monthlyRevenue * 0.3;
                    recommendations.push(`Reduce ad spend to $${Math.ceil(targetSpend)}/month OR improve efficiency: CPC reduction of ${((monthlyAdSpend - targetSpend) / leadsNeeded).toFixed(2)} would work`);
                }
                
                // GAP FIX #5: Input validation intelligence
                if (i.techs === 0 && i.jobsPerTechPerDay > 0) {
                    constraints.push(`Invalid: Techs = 0 but jobs/tech/day > 0`);
                }
                
                if (monthlyAdSpend > monthlyRevenue && monthlyRevenue > 0) {
                    constraints.push(`Warning: Ad spend ($${monthlyAdSpend.toFixed(0)}) exceeds revenue ($${monthlyRevenue.toFixed(0)})`);
                }
                
                if (i.dailyAdSpend > 0 && leadsNeeded === 0) {
                    constraints.push(`Warning: Ad spend set but no leads needed (check capacity)`);
                }
                
                // GAP FIX #8: Early warnings (proactive alerts)
                const earlyWarnings = this.generateEarlyWarnings({
                    netMargin,
                    monthlyAdSpend,
                    monthlyRevenue
                });
                
                // GAP FIX #13: Auto-Optimization Engine - Rank suggestions by ROI impact
                if (recommendations.length > 1) {
                    // Calculate impact score for each recommendation
                    const optimizedRecs = recommendations.map(rec => {
                        let impactScore = 1; // Default
                        
                        // Revenue impact
                        if (rec.includes('Reduce costs') || rec.includes('increase AOV')) {
                            const costMatch = rec.match(/\$(\d+)/);
                            if (costMatch) impactScore = parseFloat(costMatch[1]) / 100; // Higher impact = higher score
                        }
                        
                        // Conversion impact
                        if (rec.includes('Improve booking rate') || rec.includes('Improve show rate')) {
                            const rateMatch = rec.match(/(\d+(?:\.\d+)?)%/);
                            if (rateMatch) impactScore = parseFloat(rateMatch[1]) / 10;
                        }
                        
                        // Capacity impact
                        if (rec.includes('Add') && rec.includes('techs')) {
                            impactScore = 3; // High impact
                        }
                        
                        return { text: rec, impact: impactScore };
                    }).sort((a, b) => b.impact - a.impact);
                    
                    // Update recommendations with ranked list (top 3)
                    recommendations.length = 0;
                    recommendations.push(...optimizedRecs.slice(0, 5).map(r => r.text));
                }
                
                if (constraints.length === 0) {
                    constraints.push('All constraints met [OK]');
                }
                
                // GAP FIX #6: Generate What-If Scenarios (Conservative, Base, Aggressive)
                const scenarios = this.generateScenarios(i, {
                    dailyCapacity,
                    monthlyCapacity,
                    completedJobsNeeded,
                    bookingsNeeded,
                    leadsNeeded,
                    monthlyAdSpend,
                    cpl,
                    cac,
                    breakEvenCAC,
                    monthlyRevenue,
                    grossProfit,
                    netProfit,
                    grossMarginActual,
                    netMargin
                });
                
                // GAP FIX #8: Early Warning System (proactive alerts)
                const warnings = this.generateEarlyWarnings(i, {
                    monthlyAdSpend,
                    monthlyRevenue,
                    netMargin,
                    cac,
                    breakEvenCAC,
                    leadToBookingRate: i.leadToBookingRate,
                    bookingToCompletedRate: i.bookingToCompletedRate
                });
                
                // GAP FIX #9: Industry Benchmark Comparison
                const benchmarks = this.compareToBenchmarks(i, {
                    cpc: i.cpc,
                    leadToBookingRate: i.leadToBookingRate,
                    bookingToCompletedRate: i.bookingToCompletedRate,
                    netMargin
                });
                
                return {
                    dailyCapacity,
                    monthlyCapacity,
                    completedJobsNeeded,
                    bookingsNeeded,
                    leadsNeeded,
                    monthlyAdSpend,
                    cpl,
                    cac,
                    breakEvenCAC,
                    monthlyRevenue,
                    dailyRevenue,
                    weeklyRevenue,
                    grossProfit,
                    netProfit,
                    dailyProfit,
                    weeklyProfit,
                    grossMarginActual,
                    netMargin,
                    techPayoutTotal,
                    equipCostTotal,
                    overheadTotal,
                    requiredJobsPerDay,
                    requiredJobsPerTech,
                    constraints,
                    recommendations, // GAP FIX #2: Add recommendations to results
                    scenarios, // GAP FIX #6: What-if scenarios
                    warnings, // GAP FIX #8: Early warnings
                    benchmarks // GAP FIX #9: Industry benchmarks
                };
            },
            
            recalculate() {
                const results = this.calculate();
                const outputsEl = document.getElementById('forecastOutputs');
                const chartsEl = document.getElementById('forecastCharts');
                
                if (outputsEl) {
                    outputsEl.outerHTML = this.renderOutputs(results);
                }
                if (chartsEl) {
                    chartsEl.outerHTML = this.renderCharts(results);
                }
                
                // GAP FIX #7: Auto-save forecast for tracking (debounced)
                clearTimeout(this.saveTimer);
                this.saveTimer = setTimeout(() => {
                    this.saveForecastScenario();
                }, 5000); // Save 5 seconds after last change
            },
            
            render() {
                const container = document.getElementById('adminForecastCalculator');
                if (!container) return;
                
                    container.innerHTML = `
                    <!-- Natural Language Input -->
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <div style="font-size: 18px; font-weight: 700; color: #0c4a6e;">Describe Your Scenario</div>
                            <div style="flex: 1;"></div>
                            <button onclick="adminForecastCalculator.parseNaturalLanguage()" class="btn" style="padding: 8px 16px; font-size: 13px; background: #0ea5e9; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Parse & Apply
                            </button>
                        </div>
                        <textarea id="forecastNaturalLanguageInput" placeholder="Example: We're spending $20/day on ads, have 3 creatives running for TV mounting and camera mounting jobs in Dallas, TX. We have 2 techs available..." style="width: 100%; padding: 12px; border: 1px solid #bae6fd; border-radius: 8px; font-size: 14px; min-height: 80px; resize: vertical; font-family: inherit;" onkeydown="if(event.key==='Enter' && event.ctrlKey) adminForecastCalculator.parseNaturalLanguage()"></textarea>
                        <div style="font-size: 11px; color: #075985; margin-top: 8px;">Tip: Describe your ad spend, services, location, and team size. Press Ctrl+Enter to parse.</div>
                        <div id="forecastParseResult" style="margin-top: 12px; display: none;"></div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;" id="forecastMainGrid">
                        <!-- LEFT: Inputs -->
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            ${this.renderInputs()}
                        </div>
                        
                        <!-- RIGHT: Outputs + Charts -->
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            ${this.renderOutputs(this.calculate())}
                            ${this.renderCharts(this.calculate())}
                        </div>
                    </div>
                    <style>
                        @media (max-width: 768px) {
                            #forecastMainGrid {
                                grid-template-columns: 1fr !important;
                            }
                        }
                    </style>
                `;
                
                this.attachListeners();
            },
            
            renderInputs() {
                const i = this.inputs;
                return `
                    <!-- Markets / Scale -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">A) Markets / Scale</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            ${i.market ? `
                            <div style="background: #dbeafe; padding: 10px; border-radius: 6px; border: 1px solid #93c5fd;">
                                <div style="font-size: 11px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">Market Location</div>
                                <div style="font-size: 13px; color: #1e3a8a; font-weight: 600;">${i.market}</div>
                                <div style="font-size: 10px; color: #3b82f6; margin-top: 4px;">Extracted from scenario</div>
                            </div>
                            ` : ''}
                            ${i.services && i.services.length > 0 ? `
                            <div style="background: #dbeafe; padding: 10px; border-radius: 6px; border: 1px solid #93c5fd;">
                                <div style="font-size: 11px; font-weight: 600; color: #1e40af; margin-bottom: 4px;">Services</div>
                                <div style="font-size: 12px; color: #1e3a8a;">${i.services.join(', ')}</div>
                                <div style="font-size: 10px; color: #3b82f6; margin-top: 4px;">Extracted from scenario</div>
                            </div>
                            ` : ''}
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Cities Active</label>
                                <input type="number" data-forecast-input="cities" value="${i.cities}" min="1" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Techs Active</label>
                                <input type="number" data-forecast-input="techs" value="${i.techs}" min="1" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Jobs per Tech per Day</label>
                                <input type="number" data-forecast-input="jobsPerTechPerDay" value="${i.jobsPerTechPerDay}" min="0" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Work Days per Month</label>
                                <input type="number" data-forecast-input="workDaysPerMonth" value="${i.workDaysPerMonth}" min="1" max="31" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Ramp Factor (%)</label>
                                <input type="number" data-forecast-input="rampFactor" value="${i.rampFactor}" min="0" max="100" step="5" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Partial utilization factor</div>
                            </div>
                        </div>
                    </div>

                    <!-- Offer Economics -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">B) Offer Economics</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Offer Preset</label>
                                <select id="forecastOfferPreset" onchange="adminForecastCalculator.applyOfferPreset(this.value)" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                    <option value="">Custom</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Avg Order Value (AOV)</label>
                                <input type="number" data-forecast-input="aov" value="${i.aov}" min="0" step="10" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                    ${i.services && i.services.length > 0 ? 
                                        `Based on ${i.services.join(', ')}: Typical range $${this.estimateServiceAOV(i.services)}-${this.estimateServiceAOV(i.services) + 100}` :
                                        'Auto-calculated from saved offers or performance data. Adjust as needed.'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Gross Margin (%)</label>
                                <input type="number" data-forecast-input="grossMargin" value="${i.grossMargin}" min="0" max="100" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Default: 40%</div>
                            </div>
                            <div style="background: #fef3c7; padding: 12px; border-radius: 6px; border: 1px solid #fde68a;">
                                <div style="font-size: 12px; color: #92400e; font-weight: 600;">Tech Payout</div>
                                <div style="font-size: 11px; color: #a16207; margin-top: 2px;">Fixed at 35% of original base price (not discounted)</div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Equipment Cost per Job</label>
                                <input type="number" data-forecast-input="equipCostPerJob" value="${i.equipCostPerJob}" min="0" step="5" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Overhead per Job</label>
                                <input type="number" data-forecast-input="overheadPerJob" value="${i.overheadPerJob}" min="0" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                        </div>
                    </div>

                    <!-- Ads + Funnel -->
                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">C) Ads + Funnel (Meta)</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Daily Ad Spend</label>
                                <input type="number" data-forecast-input="dailyAdSpend" value="${i.dailyAdSpend}" min="0" step="5" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">${this.getInputRange('dailyAdSpend', i.dailyAdSpend) || 'Current baseline: $20/day. Target scale: $100/day. Adjust to match your actual spend.'}</div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">CPC / Cost per Lead</label>
                                <input type="number" data-forecast-input="cpc" value="${i.cpc}" min="0" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                    ${i.market ? `Typical CPC for ${i.market}: $10-$25 (service industry)` : 'Industry average: $15-$20 per lead'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Lead to Booking Rate (%)</label>
                                <input type="number" data-forecast-input="leadToBookingRate" value="${i.leadToBookingRate}" min="0" max="100" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: ${i.leadToBookingRate < 20 ? '#dc2626' : '#6b7280'}; margin-top: 4px;">
                                    ${i.leadToBookingRate < 20 ? 'Below 20% threshold - optimize follow-up process' : 'Industry benchmark: 20-30%'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Booking to Completed Rate (%)</label>
                                <input type="number" data-forecast-input="bookingToCompletedRate" value="${i.bookingToCompletedRate}" min="0" max="100" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                                <div style="font-size: 11px; color: ${i.bookingToCompletedRate < 80 ? '#dc2626' : '#6b7280'}; margin-top: 4px;">
                                    ${i.bookingToCompletedRate < 80 ? 'Below 80% threshold - improve show rate' : 'Industry benchmark: 80-90%'}
                                </div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Cancel/Refund Rate (%)</label>
                                <input type="number" data-forecast-input="cancelRate" value="${i.cancelRate}" min="0" max="100" step="1" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">
                            </div>
                        </div>
                    </div>
                `;
            },
            
            renderOutputs(results) {
                const r = results;
                return `
                    <div id="forecastOutputs" style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                        <h4 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">Outputs</h4>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <!-- Revenue Breakdown -->
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Revenue</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Daily</div>
                                        <div style="font-size: 16px; font-weight: 700; color: var(--cobalt);">$${r.dailyRevenue.toFixed(0)}</div>
                                </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Weekly</div>
                                        <div style="font-size: 16px; font-weight: 700; color: var(--cobalt);">$${r.weeklyRevenue.toFixed(0)}</div>
                                </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Monthly</div>
                                        <div style="font-size: 18px; font-weight: 900; color: var(--cobalt);">$${r.monthlyRevenue.toFixed(0)}</div>
                            </div>
                                    </div>
                                    </div>
                            
                            <!-- Profit Breakdown -->
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Profit</div>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Daily</div>
                                        <div style="font-size: 16px; font-weight: 700; color: ${r.dailyProfit >= 0 ? '#10b981' : '#ef4444'};">$${r.dailyProfit.toFixed(0)}</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Weekly</div>
                                        <div style="font-size: 16px; font-weight: 700; color: ${r.weeklyProfit >= 0 ? '#10b981' : '#ef4444'};">$${r.weeklyProfit.toFixed(0)}</div>
                                    </div>
                                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px;">Monthly</div>
                                        <div style="font-size: 18px; font-weight: 900; color: ${r.netProfit >= 0 ? '#10b981' : '#ef4444'};">$${r.netProfit.toFixed(0)}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Key Metrics -->
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Key Metrics</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Gross Profit:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">$${r.grossProfit.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Net Profit:</span>
                                        <span style="font-weight: 600; color: ${r.netProfit >= 0 ? '#10b981' : '#ef4444'};">$${r.netProfit.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Gross Margin:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.grossMarginActual.toFixed(1)}%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Net Margin:</span>
                                        <span style="font-weight: 600; color: ${r.netMargin >= 0 ? '#10b981' : '#ef4444'};">${r.netMargin.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Funnel Requirements -->
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Funnel Requirements</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Leads Needed:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.leadsNeeded.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Bookings Needed:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.bookingsNeeded.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Completed Jobs:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.completedJobsNeeded.toFixed(0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Jobs/Day Required:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.requiredJobsPerDay.toFixed(1)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Jobs/Tech/Day Required:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">${r.requiredJobsPerTech.toFixed(1)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CAC / Break-even -->
                            <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">CAC Analysis</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Current CPL:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">$${r.cpl.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Current CAC:</span>
                                        <span style="font-weight: 600; color: var(--cobalt);">$${r.cac.toFixed(2)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #6b7280;">Break-even CAC:</span>
                                        <span style="font-weight: 600; color: ${r.cac <= r.breakEvenCAC ? '#10b981' : '#ef4444'};">$${r.breakEvenCAC.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- What Has to Be True -->
                            <div style="background: ${r.constraints.some(c => !c.includes('[OK]')) ? '#fef2f2' : '#d1fae5'}; padding: 12px; border-radius: 6px; border: 1px solid ${r.constraints.some(c => !c.includes('[OK]')) ? '#fecaca' : '#a7f3d0'};">
                                <div style="font-size: 13px; font-weight: 600; color: ${r.constraints.some(c => !c.includes('[OK]')) ? '#991b1b' : '#065f46'}; margin-bottom: 8px;">What Has to Be True</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: ${r.constraints.some(c => !c.includes('[OK]')) ? '#991b1b' : '#065f46'}; line-height: 1.6;">
                                    ${r.constraints.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                                </div>
                            </div>
                            
                            ${r.recommendations && r.recommendations.length > 0 ? `
                            <!-- GAP FIX #2: Dynamic Recommendations -->
                            <div style="background: #eff6ff; padding: 12px; border-radius: 6px; border: 1px solid #93c5fd;">
                                <div style="font-size: 13px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">Recommendations</div>
                                <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #1e3a8a; line-height: 1.6;">
                                    ${r.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                    `;
            },
            
            renderCharts(results) {
                const r = results;
                return `
                    <div id="forecastCharts" style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Chart 1: Monthly Revenue vs Profit -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                            <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">Monthly Revenue vs Profit</h4>
                            <div style="display: flex; align-items: flex-end; gap: 8px; height: 200px;">
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                                    <div style="width: 100%; background: var(--cobalt); height: ${Math.max(10, (r.monthlyRevenue / Math.max(r.monthlyRevenue, Math.abs(r.netProfit)) * 180))}px; border-radius: 4px 4px 0 0; margin-bottom: 4px;"></div>
                                    <div style="font-size: 11px; color: #6b7280; font-weight: 600;">Revenue</div>
                                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">$${(r.monthlyRevenue / 1000).toFixed(0)}k</div>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                                    <div style="width: 100%; background: ${r.netProfit >= 0 ? '#10b981' : '#ef4444'}; height: ${Math.max(10, (Math.abs(r.netProfit) / Math.max(r.monthlyRevenue, Math.abs(r.netProfit)) * 180))}px; border-radius: 4px 4px 0 0; margin-bottom: 4px;"></div>
                                    <div style="font-size: 11px; color: #6b7280; font-weight: 600;">Profit</div>
                                    <div style="font-size: 10px; color: #6b7280; margin-top: 2px;">$${(r.netProfit / 1000).toFixed(0)}k</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart 2: Sensitivity (CPL impact) -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                            <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">Sensitivity: CPL Impact on Profit</h4>
                            <div style="display: flex; align-items: flex-end; gap: 4px; height: 150px;">
                                ${[5, 10, 15, 20, 25, 30].map(cpl => {
                                    const testCAC = cpl / (this.inputs.leadToBookingRate / 100);
                                    const testAdSpend = r.leadsNeeded * cpl;
                                    const testProfit = r.grossProfit - r.overheadTotal - testAdSpend;
                                    const height = Math.max(5, (testProfit / Math.max(Math.abs(r.netProfit), 10000) * 140));
                                    return `
                                        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                                            <div style="width: 100%; background: ${testProfit >= 0 ? '#10b981' : '#ef4444'}; height: ${height}px; border-radius: 2px 2px 0 0; margin-bottom: 4px;"></div>
                                            <div style="font-size: 9px; color: #6b7280; writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg);">$${cpl}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div style="text-align: center; font-size: 11px; color: #6b7280; margin-top: 8px;">CPL ($)</div>
                        </div>
                        
                        <!-- Chart 3: Capacity vs Required -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 20px; border-radius: 8px;">
                            <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin: 0 0 16px 0;">Capacity vs Required Jobs</h4>
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="flex: 1; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: #6b7280;">${r.monthlyCapacity.toFixed(0)}</div>
                                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Available Capacity</div>
                                    </div>
                                    <div style="width: 2px; height: 40px; background: #e5e7eb; margin: 0 16px;"></div>
                                    <div style="flex: 1; text-align: center;">
                                        <div style="font-size: 24px; font-weight: 700; color: ${r.completedJobsNeeded <= r.monthlyCapacity ? '#10b981' : '#ef4444'};">${r.completedJobsNeeded.toFixed(0)}</div>
                                        <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Required Jobs</div>
                                    </div>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; margin-top: 12px;">
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Utilization</div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; background: #f3f4f6; border-radius: 4px; height: 24px; overflow: hidden; position: relative;">
                                            <div style="background: ${r.completedJobsNeeded <= r.monthlyCapacity ? 'linear-gradient(90deg, #10b981, #059669)' : 'linear-gradient(90deg, #ef4444, #dc2626)'}; height: 100%; width: ${Math.min(100, (r.completedJobsNeeded / Math.max(r.monthlyCapacity, 1)) * 100)}%; transition: width 0.3s ease; border-radius: 4px;"></div>
                                        </div>
                                        <div style="font-size: 13px; font-weight: 700; color: ${r.completedJobsNeeded <= r.monthlyCapacity ? '#10b981' : '#ef4444'}; min-width: 50px; text-align: right;">
                                            ${((r.completedJobsNeeded / Math.max(r.monthlyCapacity, 1)) * 100).toFixed(0)}%
                                        </div>
                                    </div>
                                    ${r.completedJobsNeeded > r.monthlyCapacity ? `
                                        <div style="font-size: 11px; color: #ef4444; margin-top: 8px; padding: 8px; background: #fef2f2; border-radius: 4px; border-left: 3px solid #ef4444;">
                                            <strong>Warning:</strong> Required jobs (${r.completedJobsNeeded.toFixed(0)}) exceed available capacity (${r.monthlyCapacity.toFixed(0)}). Consider adding techs or increasing jobs per tech.
                                        </div>
                                    ` : r.completedJobsNeeded < r.monthlyCapacity * 0.5 ? `
                                        <div style="font-size: 11px; color: #f59e0b; margin-top: 8px; padding: 8px; background: #fffbeb; border-radius: 4px; border-left: 3px solid #f59e0b;">
                                            <strong>Note:</strong> Capacity utilization is low. You have room to scale up.
                                        </div>
                                    ` : `
                                        <div style="font-size: 11px; color: #10b981; margin-top: 8px; padding: 8px; background: #d1fae5; border-radius: 4px; border-left: 3px solid #10b981;">
                                            <strong>Good:</strong> Capacity and requirements are well-balanced.
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Assumptions Panel -->
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px;">
                            <h4 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Key Assumptions</h4>
                            <div style="display: flex; flex-direction: column; gap: 6px; font-size: 11px; color: #6b7280; line-height: 1.5;">
                                <div>- Revenue = Completed Jobs x AOV</div>
                                <div>- Tech Payout = 35% of AOV (original price)</div>
                                <div>- Gross Profit = Revenue - Tech Payout - Equipment</div>
                                <div>- Net Profit = Gross Profit - Overhead - Ad Spend</div>
                                <div>- Leads = Bookings / Lead-to-Booking Rate</div>
                                <div>- Bookings = Completed Jobs / Booking-to-Completed Rate</div>
                                <div>- Break-even CAC = (Gross Profit - Overhead) / Leads</div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            applyOfferPreset(presetId) {
                if (!presetId) return;
                
                try {
                    const savedOffers = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                    const preset = savedOffers.find(o => o.id === presetId || o.timestamp === presetId);
                    
                    if (preset && preset.totals) {
                        this.inputs.aov = preset.totals.customerPrice || this.inputs.aov;
                        this.inputs.equipCostPerJob = (preset.totals.equipCostTotal / (preset.lineItems.reduce((sum, item) => sum + item.qty, 0) || 1)) || this.inputs.equipCostPerJob;
                        this.render();
                        this.recalculate();
                    }
                } catch (e) {
                    console.warn('Could not load offer preset', e);
                }
            },
            
            loadOfferPresets() {
                try {
                    const savedOffers = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                    const select = document.getElementById('forecastOfferPreset');
                    if (!select) return;
                    
                    select.innerHTML = '<option value="">Custom</option>';
                    savedOffers.slice(-10).reverse().forEach((offer, idx) => {
                        const option = document.createElement('option');
                        option.value = offer.timestamp || offer.id || idx;
                        option.textContent = `Offer ${savedOffers.length - idx} ($${offer.totals?.customerPrice?.toFixed(0) || 'N/A'})`;
                        select.appendChild(option);
                    });
                } catch (e) {
                    console.warn('Could not load offer presets', e);
                }
            }
        };

        /* ===== FORECAST CALCULATOR (Separate Tab) ===== */
        const forecastCalculator = {
            scenarios: [],
            
            init() {
                this.loadScenariosFromStorage();
            },
            
            loadScenariosFromStorage() {
                try {
                    this.scenarios = JSON.parse(localStorage.getItem('h2s_forecast_scenarios_v1') || '[]');
                } catch (e) {
                    this.scenarios = [];
                }
            },
            
            saveScenario() {
                const scenarioName = prompt('Enter a name for this scenario:');
                if (!scenarioName) return;
                
                const scenario = {
                    id: Date.now().toString(),
                    name: scenarioName,
                    timestamp: new Date().toISOString(),
                    inputs: {
                        // Store current forecast inputs if they exist
                        adSpend: 0,
                        cpl: 0,
                        bookingRate: 0,
                        cancelRate: 0,
                        techs: 0,
                        jobsPerTech: 0,
                        workdays: 0
                    }
                };
                
                this.scenarios.push(scenario);
                localStorage.setItem('h2s_forecast_scenarios_v1', JSON.stringify(this.scenarios));
                showToast('Scenario saved successfully!', 'success');
            },
            
            loadScenarios() {
                if (this.scenarios.length === 0) {
                    showModal('Saved Scenarios', '<div style="text-align: center; padding: 40px; color: #6b7280;">No saved scenarios yet</div>');
                    return;
                }
                
                const html = this.scenarios.map(s => `
                    <div style="background: #f9fafb; padding: 16px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 700; font-size: 15px; color: var(--cobalt); margin-bottom: 4px;">${s.name}</div>
                                <div style="font-size: 12px; color: #6b7280;">${new Date(s.timestamp).toLocaleString()}</div>
                            </div>
                            <button onclick="forecastCalculator.applyScenario('${s.id}')" style="padding: 6px 12px; background: var(--cobalt); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                Load
                            </button>
                        </div>
                    </div>
                `).join('');
                
                showModal('Saved Forecast Scenarios', `<div style="max-height: 60vh; overflow-y: auto;">${html}</div>`, { width: '600px' });
            },
            
            applyScenario(scenarioId) {
                const scenario = this.scenarios.find(s => s.id === scenarioId);
                if (!scenario) return;
                
                showToast('Scenario loaded!', 'success');
                closeModal();
            }
        };

        /* ===== OFFER BUILDER - CART-BASED MULTI-SERVICE SYSTEM ===== */
        const offerBuilder = {
            offer: {
                name: '',
                lineItems: [],
                pricingStrategy: 'sum',
                percentOff: 0,
                dollarOff: 0,
                bundlePrice: 0,
                briefGenerated: false,
                // Offer Snapshot
                category: '',
                market: '',
                primaryAvatar: '',
                intendedGoal: '',
                headline: '',
                oneSentencePromise: '',
                offerStartDate: '',
                offerEndDate: '',
                scarcityMechanism: '',
                riskReversal: '',
                // The Deal
                whatsIncluded: '',
                whatsNotIncluded: '',
                eligibilityRules: '',
                redemptionRules: '',
                // Unit Economics (computed + notes)
                expectedAOV: 0,
                techPayoutRate: 35,
                estimatedMaterialsCost: 0,
                paymentProcessingFees: 0,
                travelOtherVariableCost: 0,
                marginBreakPoints: '',
                safeguards: '',
                // Value Equation
                dreamOutcome: '',
                likelihoodOfAchievement: '',
                timeDelay: '',
                effortSacrifice: '',
                // Competitor Reality Check
                competitorPriceRange: '',
                howWereDifferent: '',
                whyChooseUs: '',
                // Ops Notes
                whatToSayInHome: [],
                specialInstructions: '',
                capacityAssumption: '',
                cancellationRisks: '',
                // Messaging Pack
                bookingPageMicrocopy: '',
                smsConfirmation: '',
                smsReminder24h: '',
                priceQuestionLine: '',
                techBroadcastMessage: '',
                // Creative Angles
                hooks: [],
                objectionsRebuttals: [],
                proofIdeas: [],
                // Decision Notes
                bestCaseOutcome: '',
                worstCaseRisk: '',
                confidenceScore: 0,
                confidenceWhy: ''
            },
            
            serviceCatalog: [
                { id: 'tv-install', name: 'TV Installation', basePrice: 150, defaultEquipCost: 0, benchmarkPrice: 'Industry: $120-$200', benchmarkEquip: 'Customer provides TV' },
                { id: 'tv-mount-wall', name: 'TV Wall Mount (Basic)', basePrice: 125, defaultEquipCost: 0, benchmarkPrice: 'Industry: $100-$175', benchmarkEquip: 'Mount included or customer provides' },
                { id: 'tv-mount-ceiling', name: 'TV Ceiling Mount', basePrice: 200, defaultEquipCost: 0, benchmarkPrice: 'Industry: $175-$275', benchmarkEquip: 'Mount included or customer provides' },
                { id: 'soundbar-mount', name: 'Soundbar Mount', basePrice: 75, defaultEquipCost: 0, benchmarkPrice: 'Industry: $60-$100', benchmarkEquip: 'Customer provides soundbar' },
                { id: 'doorbell-camera', name: 'Doorbell Camera Install', basePrice: 200, defaultEquipCost: 150, benchmarkPrice: 'Industry: $150-$250', benchmarkEquip: 'Camera: $100-$200 (Ring, Nest, etc.)' },
                { id: 'security-system', name: 'Security System Install', basePrice: 500, defaultEquipCost: 300, benchmarkPrice: 'Industry: $400-$800', benchmarkEquip: 'Per camera: $100-$250 (wired), $150-$300 (wireless)' },
                { id: 'security-camera-single', name: 'Single Security Camera', basePrice: 175, defaultEquipCost: 150, benchmarkPrice: 'Industry: $125-$225', benchmarkEquip: 'Camera: $100-$200' },
                { id: 'smart-lock', name: 'Smart Lock Install', basePrice: 100, defaultEquipCost: 80, benchmarkPrice: 'Industry: $75-$150', benchmarkEquip: 'Lock: $50-$200 (August, Schlage, etc.)' },
                { id: 'wifi-setup', name: 'WiFi Setup / Mesh Network', basePrice: 250, defaultEquipCost: 0, benchmarkPrice: 'Industry: $200-$350', benchmarkEquip: 'Customer provides router/mesh system' },
                { id: 'wifi-troubleshoot', name: 'WiFi Troubleshooting', basePrice: 150, defaultEquipCost: 0, benchmarkPrice: 'Industry: $100-$200', benchmarkEquip: 'No equipment needed' },
                { id: 'wire-management', name: 'Wire Management / Hide Cables', basePrice: 100, defaultEquipCost: 25, benchmarkPrice: 'Industry: $75-$150', benchmarkEquip: 'Cable management kit: $20-$50' },
                { id: 'smart-switch', name: 'Smart Switch Install', basePrice: 85, defaultEquipCost: 35, benchmarkPrice: 'Industry: $60-$120', benchmarkEquip: 'Switch: $25-$60 (Lutron, TP-Link, etc.)' },
                { id: 'smart-thermostat', name: 'Smart Thermostat Install', basePrice: 150, defaultEquipCost: 200, benchmarkPrice: 'Industry: $125-$200', benchmarkEquip: 'Thermostat: $150-$300 (Nest, Ecobee, etc.)' }
            ],
            
            init() {
                // Ensure idempotent - check if already initialized
                const container = document.getElementById('offerbuilder-pane');
                if (container && container.dataset.initialized) return;
                if (container) container.dataset.initialized = 'true';
                
                // Update sticky positioning on init (if not already set up)
                const self = this;
                if (!this.stickyObserver) {
                    setTimeout(() => {
                        if (self.initStickyPositioningObserver) {
                            self.initStickyPositioningObserver();
                        }
                        if (self.updateStickyPositioning) {
                            self.updateStickyPositioning();
                        }
                    }, 300);
                }
                
                this.renderLineItems();
                this.recalculateOffer();
                
                // Auto-update on input change (idempotent - remove old listeners if any)
                if (container) {
                    const debounceTimer = {};
                    const inputHandler = (e) => {
                        if (e.target.closest('#offerbuilder-pane')) {
                            clearTimeout(debounceTimer[e.target.id]);
                            debounceTimer[e.target.id] = setTimeout(() => {
                                this.recalculateOffer();
                            }, 300);
                        }
                    };
                    const changeHandler = (e) => {
                        if (e.target.closest('#offerbuilder-pane')) {
                            this.recalculateOffer();
                        }
                    };
                    
                    // Remove existing listeners if any (idempotent)
                    container.removeEventListener('input', inputHandler);
                    container.removeEventListener('change', changeHandler);
                    
                    // Add fresh listeners
                    container.addEventListener('input', inputHandler);
                    container.addEventListener('change', changeHandler);
                }
                
                // Initialize messaging tab to 'snapshot'
                this.switchMessagingTab('snapshot');
            },

            goToStep(step) {
                const s = Number(step) || 1;
                const targets = {
                    1: 'offerBuilderServicesCard',
                    2: 'offerBuilderDetailsCard',
                    3: 'offerBuilderMessagingCard',
                    4: 'offerBuilderStandards',
                    5: 'offerBuilderGenerateBriefBtn'
                };

                if (s === 3) {
                    const section = document.getElementById('offerMessagingSection');
                    if (section && section.style.display === 'none') {
                        this.toggleSection('offerMessagingSection');
                    }
                }

                const id = targets[s] || targets[1];
                const el = document.getElementById(id);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            },

            goToNextStep() {
                const next = Math.min(5, (this._currentStep || 1) + 1);
                this.goToStep(next);
            },
            
            addLineItem(serviceId = null) {
                const allServices = [...this.serviceCatalog, ...this.getCustomServices()];
                const service = serviceId ? allServices.find(s => s.id === serviceId) : allServices[0];
                if (!service) return;
                
                // Create line item with zero prices - user must enter their own pricing
                const lineItem = {
                    id: Date.now().toString(),
                    serviceId: service.id,
                    name: service.name,
                    qty: 1,
                    baseUnitPrice: 0,  // User enters their own price
                    equipCostPerUnit: 0,  // User enters their own equipment cost
                    equipMode: 'BYO',  // Default to customer provides equipment
                    isIncludedInOffer: true,
                    notes: service.notes || ''
                };
                
                this.offer.lineItems.push(lineItem);
                this.renderLineItems();
                this.recalculateOffer();
                
                // Track service addition
                if (typeof trackEvent === 'function') {
                    trackEvent('service_added_to_offer', {
                        service_name: service.name,
                        service_id: service.id,
                        offer_name: this.offer.name || 'Unnamed',
                        total_services: this.offer.lineItems.length
                    });
                }
            },
            
            removeLineItem(itemId) {
                this.offer.lineItems = this.offer.lineItems.filter(item => item.id !== itemId);
                this.renderLineItems();
                this.recalculateOffer();
            },
            
            updateLineItem(itemId, field, value) {
                const item = this.offer.lineItems.find(i => i.id === itemId);
                if (!item) return;
                
                if (field === 'qty') {
                    item.qty = Math.max(1, parseInt(value) || 1);
                } else if (field === 'equipMode') {
                    item.equipMode = value;
                    if (value === 'BYO') {
                        item.equipCostPerUnit = 0;
                        item.equipEstimate = null; // Clear estimate when switching to BYO
                    }
                } else if (field === 'equipCostPerUnit') {
                    item.equipCostPerUnit = parseFloat(value) || 0;
                } else if (field === 'baseUnitPrice') {
                    item.baseUnitPrice = parseFloat(value) || 0;
                } else if (field === 'name') {
                    item.name = value;
                } else if (field === 'notes') {
                    item.notes = value;
                }
                
                this.renderLineItems();
                this.recalculateOffer();
            },
            
            async estimateEquipmentCost(itemId) {
                const item = this.offer.lineItems.find(i => i.id === itemId);
                if (!item) return;
                
                if (item.equipMode === 'BYO') {
                    showToast('Equipment cost estimation is not needed when customer provides equipment', 'info');
                    return;
                }
                
                // Show loading state
                showToast('Estimating equipment cost...', 'info');
                
                try {
                    const allServices = [...this.serviceCatalog, ...this.getCustomServices()];
                    const service = allServices.find(s => s.id === item.serviceId);
                    const category = this.offer.category || service?.category || '';
                    const serviceDescription = service?.description || item.notes || '';
                    
                    const params = new URLSearchParams({
                        serviceName: item.name,
                        category: category,
                        serviceDescription: serviceDescription
                    });
                    
                    const response = await fetch(`${API_URL}?action=estimateEquipmentCost&${params.toString()}`);
                    const data = await response.json();
                    
                    // Handle both response formats: { ok: true, estimateEquipmentCost: {...} } or direct result
                    const estimate = data.estimateEquipmentCost || (data.ok ? data : null);
                    
                    if (estimate && estimate.estimatedCost !== undefined) {
                        item.equipEstimate = {
                            estimatedCost: estimate.estimatedCost,
                            costRange: estimate.costRange || { min: 0, max: 0 },
                            confidence: estimate.confidence || 'medium',
                            notes: estimate.notes || '',
                            equipmentItems: estimate.equipmentItems || []
                        };
                        this.renderLineItems();
                        showToast('Equipment cost estimated successfully!', 'success');
                    } else {
                        showToast('Failed to estimate equipment cost: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Equipment cost estimation error:', error);
                    showToast('Error estimating equipment cost: ' + error.message, 'error');
                }
            },
            
            applyEquipmentEstimate(itemId) {
                const item = this.offer.lineItems.find(i => i.id === itemId);
                if (!item || !item.equipEstimate) return;
                
                item.equipCostPerUnit = item.equipEstimate.estimatedCost;
                item.equipEstimate = null; // Clear estimate after applying
                this.renderLineItems();
                this.recalculateOffer();
                showToast('Equipment cost applied!', 'success');
            },
            
            clearEquipmentEstimate(itemId) {
                const item = this.offer.lineItems.find(i => i.id === itemId);
                if (!item) return;
                
                item.equipEstimate = null;
                this.renderLineItems();
            },
            
            updateOfferName(name) {
                this.offer.name = name;
                // Show/hide guidance
                const guidance = document.getElementById('offerBuilderNameGuidance');
                if (guidance) {
                    guidance.style.display = (!name || name.trim() === '') ? 'block' : 'none';
                }
            },
            
            updateField(field, value) {
                this.offer[field] = value;
            },
            
            toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const toggle = document.getElementById(sectionId + 'Toggle');
                if (section && toggle) {
                    const isHidden = section.style.display === 'none';
                    section.style.display = isHidden ? 'block' : 'none';
                    toggle.textContent = isHidden ? '-' : '+';
                    
                    // CRITICAL: Recalculate sticky positioning when accordion expands/collapses
                    // This ensures right column panels adjust when left column content changes height
                    if (typeof this.updateStickyPositioning === 'function') {
                        // Use requestAnimationFrame to ensure DOM has updated
                        requestAnimationFrame(() => {
                            this.updateStickyPositioning();
                            // Also recalculate after a brief delay to catch any async content loading
                            setTimeout(() => {
                                this.updateStickyPositioning();
                            }, 150);
                        });
                    }
                    
                    // Smooth scroll expanded section into view if it's partially off-screen
                    if (isHidden && section.style.display === 'block') {
                        requestAnimationFrame(() => {
                            const sectionRect = section.getBoundingClientRect();
                            const viewportHeight = window.innerHeight;
                            const headerHeight = 80; // Approximate header height
                            
                            // Check if section is partially or fully off-screen
                            if (sectionRect.top < headerHeight || sectionRect.bottom > viewportHeight) {
                                // Scroll the section header (parent element) into view
                                const sectionHeader = section.previousElementSibling;
                                if (sectionHeader) {
                                    sectionHeader.scrollIntoView({ 
                                        block: 'nearest', 
                                        behavior: 'smooth' 
                                    });
                                } else {
                                    // Fallback: scroll the section itself
                                    section.scrollIntoView({ 
                                        block: 'nearest', 
                                        behavior: 'smooth' 
                                    });
                                }
                            }
                        });
                    }
                    
                    // Load data when section is opened
                    if (sectionId === 'offerBuilderPerformanceFeedback' && isHidden) {
                        this.loadPerformanceData();
                    }
                    if (sectionId === 'offerBuilderInsights' && isHidden) {
                        this.loadInsights();
                    }
                }
            },
            
            updatePricingStrategy(strategy) {
                this.offer.pricingStrategy = strategy;
                
                document.getElementById('offerBuilderPercentOffContainer').style.display = 
                    strategy === 'percentOff' ? 'block' : 'none';
                document.getElementById('offerBuilderDollarOffContainer').style.display = 
                    strategy === 'dollarOff' ? 'block' : 'none';
                document.getElementById('offerBuilderBundlePriceContainer').style.display = 
                    strategy === 'bundlePrice' ? 'block' : 'none';
                
                this.recalculateOffer();
            },
            
            handleDirectPriceInput(value) {
                const price = parseFloat(value) || 0;
                const helpEl = document.getElementById('offerBuilderPriceHelp');
                
                if (price > 0) {
                    const techPayout = price * 0.35;
                    const remaining = price - techPayout;
                    helpEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px; font-size: 11px;">
                            <div>
                                <span style="color: #9ca3af;">Tech earns:</span>
                                <strong style="color: var(--cobalt); margin-left: 4px;">$${techPayout.toFixed(2)}</strong>
                                <span style="color: #d1d5db; margin: 0 6px;">|</span>
                                <span style="color: #9ca3af;">Your budget:</span>
                                <strong style="color: var(--cobalt); margin-left: 4px;">$${remaining.toFixed(2)}</strong>
                            </div>
                            <span style="color: #d1d5db; font-size: 10px;">(35% tech payout)</span>
                        </div>
                    `;
                    helpEl.style.display = 'block';
                } else {
                    helpEl.style.display = 'none';
                }
            },
            
            applyDirectPrice() {
                const priceInput = document.getElementById('offerBuilderDirectPrice');
                const price = parseFloat(priceInput.value) || 0;
                
                if (price <= 0) {
                    showToast('Please enter a price greater than $0', 'error');
                    return;
                }
                
                // Set to fixed bundle price mode
                this.offer.pricingStrategy = 'bundlePrice';
                this.offer.bundlePrice = price;
                
                // Update radio button
                const bundleRadio = document.querySelector('input[name="offerBuilderPricingStrategy"][value="bundlePrice"]');
                if (bundleRadio) bundleRadio.checked = true;
                
                // Show the bundle price input and set its value
                document.getElementById('offerBuilderBundlePriceContainer').style.display = 'block';
                const bundlePriceInput = document.getElementById('offerBuilderBundlePrice');
                if (bundlePriceInput) bundlePriceInput.value = price;
                
                // Show current price indicator
                const currentPriceDisplay = document.getElementById('offerBuilderCurrentPrice');
                const currentPriceValue = document.getElementById('offerBuilderCurrentPriceDisplay');
                if (currentPriceDisplay && currentPriceValue) {
                    currentPriceValue.textContent = `$${price.toFixed(2)}`;
                    currentPriceDisplay.style.display = 'block';
                }
                
                // Recalculate
                this.recalculateOffer();
                
                showToast(`Offer price set to $${price.toFixed(2)}`, 'success');
                
                // Clear the direct price input
                priceInput.value = '';
                document.getElementById('offerBuilderPriceHelp').style.display = 'none';
            },
            
            clearOfferPrice() {
                this.offer.pricingStrategy = 'sum';
                this.offer.bundlePrice = 0;
                
                // Reset radio to sum
                const sumRadio = document.querySelector('input[name="offerBuilderPricingStrategy"][value="sum"]');
                if (sumRadio) sumRadio.checked = true;
                
                // Hide current price indicator
                const currentPriceDisplay = document.getElementById('offerBuilderCurrentPrice');
                if (currentPriceDisplay) currentPriceDisplay.style.display = 'none';
                
                // Hide bundle price container
                document.getElementById('offerBuilderBundlePriceContainer').style.display = 'none';
                
                this.recalculateOffer();
                showToast('Offer price cleared - now calculating from services', 'info');
            },
            
            calculateTotals() {
                const { lineItems, pricingStrategy, percentOff, dollarOff, bundlePrice } = this.offer;
                
                const subtotalBase = lineItems.reduce((sum, item) => {
                    return sum + (item.baseUnitPrice * item.qty);
                }, 0);
                
                // Equipment cost (only for items where equipMode != "BYO")
                const equipCostTotal = lineItems.reduce((sum, item) => {
                    if (item.equipMode !== 'BYO') {
                        return sum + (item.equipCostPerUnit * item.qty);
                    }
                    return sum;
                }, 0);
                
                // Customer price based on pricing strategy
                let customerPrice = subtotalBase;
                if (pricingStrategy === 'bundlePrice' && bundlePrice > 0) {
                    customerPrice = bundlePrice;
                } else if (pricingStrategy === 'percentOff' && percentOff > 0) {
                    customerPrice = subtotalBase * (1 - percentOff / 100);
                } else if (pricingStrategy === 'dollarOff' && dollarOff > 0) {
                    customerPrice = Math.max(0, subtotalBase - dollarOff);
                }
                
                // Tech payout is 35% of what WE get paid (customer price)
                const techPayoutTotal = customerPrice * 0.35;
                
                const profit = customerPrice - techPayoutTotal - equipCostTotal;
                const marginPct = customerPrice > 0 ? (profit / customerPrice) * 100 : 0;
                
                return {
                    subtotalBase,
                    techPayoutTotal,
                    equipCostTotal,
                    customerPrice,
                    profit,
                    marginPct
                };
            },
            
            recalculateOffer() {
                if (this.offer.lineItems.length === 0) {
                    document.getElementById('offerBuilderResults').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6b7280; font-size: 14px;">
                            Add services to see calculations
                        </div>
                    `;
                    document.getElementById('offerBuilderWarnings').innerHTML = '';
                    this.renderStandards();
                    return;
                }
                
                // Get current pricing strategy values
                this.offer.percentOff = parseFloat(document.getElementById('offerBuilderPercentOff')?.value || 0);
                this.offer.dollarOff = parseFloat(document.getElementById('offerBuilderDollarOff')?.value || 0);
                this.offer.bundlePrice = parseFloat(document.getElementById('offerBuilderBundlePrice')?.value || 0);
                
                const totals = this.calculateTotals();
                const warnings = this.validateOffer();
                const standards = this.evaluateStandards(totals);
                
                // Update Standards panel
                this.renderStandards(standards);
                
                // Update button states
                this.updateButtonStates(standards);
                
                // Update sticky positioning after content changes
                const self = this;
                setTimeout(() => {
                    if (self.updateStickyPositioning) {
                        self.updateStickyPositioning();
                    }
                }, 150);
                
                document.getElementById('offerBuilderResults').innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <span style="font-size: 14px; color: #6b7280;">Subtotal (Base)</span>
                            <span style="font-size: 16px; font-weight: 700; color: var(--cobalt);">$${totals.subtotalBase.toFixed(2)}</span>
                            </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <div>
                                <span style="font-size: 14px; color: #6b7280;">Customer Price</span>
                                <div style="font-size: 11px; color: #9ca3af; margin-top: 2px;">Final price customer pays</div>
                                </div>
                            <span style="font-size: 20px; font-weight: 900; color: var(--cobalt);">$${totals.customerPrice.toFixed(2)}</span>
                                </div>
                        <div style="border-top: 2px solid #e5e7eb; padding-top: 12px; margin-top: 4px;">
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: #fef3c7; border-radius: 8px; margin-bottom: 8px; border: 1px solid #fde68a;">
                                <div>
                                    <span style="font-size: 14px; color: #92400e; font-weight: 600;">Tech Payout</span>
                                    <div style="font-size: 11px; color: #a16207; margin-top: 2px;">35% of customer price</div>
                                </div>
                                <span style="font-size: 16px; font-weight: 700; color: #92400e;">$${totals.techPayoutTotal.toFixed(2)}</span>
                                </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <span style="font-size: 14px; color: #6b7280;">Equipment Cost</span>
                                <span style="font-size: 16px; font-weight: 700; color: var(--cobalt);">$${totals.equipCostTotal.toFixed(2)}</span>
                            </div>
                        </div>
                        <div style="border-top: 2px solid #e5e7eb; padding-top: 12px; margin-top: 4px;">
                            <div style="display: flex; justify-content: space-between; padding: 16px; background: ${totals.profit >= 0 ? '#d1fae5' : '#fee2e2'}; border-radius: 8px; margin-bottom: 8px; border: 1px solid ${totals.profit >= 0 ? '#a7f3d0' : '#fecaca'};">
                                <span style="font-size: 16px; font-weight: 700; color: ${totals.profit >= 0 ? '#065f46' : '#991b1b'};">Profit</span>
                                <span style="font-size: 20px; font-weight: 900; color: ${totals.profit >= 0 ? '#065f46' : '#991b1b'};">$${totals.profit.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                <span style="font-size: 14px; color: #6b7280;">Margin</span>
                                <span style="font-size: 18px; font-weight: 700; color: ${totals.marginPct >= 40 ? '#10b981' : totals.marginPct >= 20 ? '#f59e0b' : '#ef4444'};">
                                    ${totals.marginPct.toFixed(1)}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                
                if (warnings.length > 0) {
                    document.getElementById('offerBuilderWarnings').innerHTML = `
                        <div style="padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: #991b1b; margin-bottom: 8px;">Warnings</div>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #991b1b; line-height: 1.6;">
                                ${warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    document.getElementById('offerBuilderWarnings').innerHTML = '';
                }
                
                const updateEl = document.getElementById('offerBuilderLastUpdate');
                if (updateEl) {
                    updateEl.textContent = 'Updated just now';
                    updateEl.style.display = 'inline-block';
                    setTimeout(() => {
                        updateEl.style.display = 'none';
                    }, 3000);
                }
            },
            
            validateOffer() {
                const warnings = [];
                const totals = this.calculateTotals();
                
                this.offer.lineItems.forEach((item, index) => {
                    // Check if service price is not entered
                    if (!item.baseUnitPrice || item.baseUnitPrice <= 0) {
                        warnings.push(`Service "${item.name}" needs a price entered.`);
                    }
                    
                    // Check if equipment mode requires cost but none is set
                    if (item.equipMode !== 'BYO' && (!item.equipCostPerUnit || item.equipCostPerUnit <= 0)) {
                        warnings.push(`Service "${item.name}" has equipment included but no equipment cost set.`);
                    }
                });
                
                if (totals.profit < 0) {
                    warnings.push(`Offer is unprofitable ($${Math.abs(totals.profit).toFixed(2)} loss).`);
                }
                
                if (totals.marginPct < 40 && totals.profit >= 0) {
                    warnings.push(`Margin is below 40% threshold (currently ${totals.marginPct.toFixed(1)}%).`);
                }
                
                if (totals.customerPrice <= 0) {
                    warnings.push('Customer price is zero or negative. Check pricing strategy.');
                }
                
                return warnings;
            },
            
            evaluateStandards(totals) {
                const issues = [];
                const hardFails = [];
                const softWarnings = [];
                let score = 100;
                
                // Hard-fail triggers (block export/mark ready)
                if (!this.offer.name || this.offer.name.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Offer name is required', fix: 'Enter an offer name' });
                    score -= 20;
                }
                
                if (this.offer.lineItems.length === 0) {
                    hardFails.push({ type: 'hard', message: 'No services selected', fix: 'Add at least one service' });
                    score -= 20;
                }
                
                // New required fields for deployable offer
                if (!this.offer.headline || this.offer.headline.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Headline is required', fix: 'Enter ad-ready headline' });
                    score -= 15;
                }
                
                if (!this.offer.oneSentencePromise || this.offer.oneSentencePromise.trim() === '') {
                    hardFails.push({ type: 'hard', message: '1-Sentence Promise is required', fix: 'Enter 1-sentence promise' });
                    score -= 15;
                }
                
                if (!this.offer.category || this.offer.category.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Category is required', fix: 'Select offer category' });
                    score -= 10;
                }
                
                if (!this.offer.primaryAvatar || this.offer.primaryAvatar.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Primary Avatar is required', fix: 'Select primary avatar' });
                    score -= 10;
                }
                
                if (!this.offer.intendedGoal || this.offer.intendedGoal.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Intended Goal is required', fix: 'Select intended goal' });
                    score -= 10;
                }
                
                if (!this.offer.market || this.offer.market.trim() === '') {
                    hardFails.push({ type: 'hard', message: 'Market is required', fix: 'Enter market (City/Zip or All)' });
                    score -= 10;
                }
                
                // Check pricing strategy completeness
                if (this.offer.pricingStrategy === 'percentOff' && (!this.offer.percentOff || this.offer.percentOff <= 0)) {
                    hardFails.push({ type: 'hard', message: 'Percentage off value missing', fix: 'Enter discount percentage' });
                    score -= 15;
                }
                if (this.offer.pricingStrategy === 'dollarOff' && (!this.offer.dollarOff || this.offer.dollarOff <= 0)) {
                    hardFails.push({ type: 'hard', message: 'Dollar off value missing', fix: 'Enter discount amount' });
                    score -= 15;
                }
                if (this.offer.pricingStrategy === 'bundlePrice' && (!this.offer.bundlePrice || this.offer.bundlePrice <= 0)) {
                    hardFails.push({ type: 'hard', message: 'Bundle price missing', fix: 'Enter bundle price' });
                    score -= 15;
                }
                
                // Missing equipment costs
                this.offer.lineItems.forEach((item, idx) => {
                    // Check if service price is missing (new requirement)
                    if (!item.baseUnitPrice || item.baseUnitPrice <= 0) {
                        hardFails.push({ type: 'hard', message: `"${item.name}" needs a price`, fix: `Enter your price for ${item.name}` });
                        score -= 10;
                    }
                    
                    // Check equipment cost
                    if (item.equipMode !== 'BYO' && (!item.equipCostPerUnit || item.equipCostPerUnit <= 0)) {
                        hardFails.push({ type: 'hard', message: `"${item.name}" missing equipment cost`, fix: `Set equipment cost for ${item.name}` });
                        score -= 10;
                    }
                });
                
                // Negative profit check is handled above in Economics validity section
                
                // Economics validity (40 points)
                if (totals.customerPrice <= 0) {
                    hardFails.push({ type: 'hard', message: 'Customer price is zero or negative', fix: 'Check pricing strategy' });
                    score -= 15;
                } else {
                    // Margin checks
                    if (totals.marginPct < 30) {
                        softWarnings.push({ type: 'soft', message: `Low margin: ${totals.marginPct.toFixed(1)}%`, fix: 'Aim for 30%+ margin', impact: 10 });
                        score -= 10;
                    } else if (totals.marginPct < 40) {
                        softWarnings.push({ type: 'soft', message: `Margin below target: ${totals.marginPct.toFixed(1)}%`, fix: 'Target 40%+ margin', impact: 5 });
                        score -= 5;
                    }
                }
                
                // Completeness of offer definition (20 points)
                if (!this.offer.whatsIncluded || this.offer.whatsIncluded.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing "What\'s Included"', fix: 'Define what\'s included', impact: 5 });
                    score -= 5;
                }
                if (!this.offer.eligibilityRules || this.offer.eligibilityRules.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing eligibility rules', fix: 'Define eligibility rules', impact: 3 });
                    score -= 3;
                }
                if (!this.offer.redemptionRules || this.offer.redemptionRules.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing redemption rules', fix: 'Define redemption rules', impact: 3 });
                    score -= 3;
                }
                
                // Copy + deployability (20 points)
                if (!this.offer.bookingPageMicrocopy || this.offer.bookingPageMicrocopy.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing booking page microcopy', fix: 'Add booking page copy', impact: 5 });
                    score -= 5;
                }
                if (!this.offer.smsConfirmation || this.offer.smsConfirmation.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing SMS confirmation', fix: 'Add SMS confirmation copy', impact: 3 });
                    score -= 3;
                }
                if (!this.offer.priceQuestionLine || this.offer.priceQuestionLine.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing price question response', fix: 'Add price question line', impact: 3 });
                    score -= 3;
                }
                
                // Credibility stack (20 points)
                if (!this.offer.scarcityMechanism || this.offer.scarcityMechanism.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing scarcity mechanism', fix: 'Select scarcity mechanism', impact: 5 });
                    score -= 5;
                }
                if (!this.offer.riskReversal || this.offer.riskReversal.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing risk reversal', fix: 'Add risk reversal (warranty, guarantee)', impact: 5 });
                    score -= 5;
                }
                if (!this.offer.marginBreakPoints || this.offer.marginBreakPoints.trim() === '') {
                    softWarnings.push({ type: 'soft', message: 'Missing margin break points', fix: 'Document where this can break', impact: 5 });
                    score -= 5;
                }
                if (this.offer.hooks.length === 0) {
                    softWarnings.push({ type: 'soft', message: 'Missing creative hooks', fix: 'Add 5 hooks for ads', impact: 3 });
                    score -= 3;
                }
                if (this.offer.objectionsRebuttals.length === 0) {
                    softWarnings.push({ type: 'soft', message: 'Missing objections + rebuttals', fix: 'Add 3 objections + rebuttals', impact: 3 });
                    score -= 3;
                }
                
                // Determine status
                let status = 'Draft';
                if (hardFails.length > 0) {
                    status = 'Incomplete';
                } else if (score < 70) {
                    status = 'Needs Fixes';
                } else if (score < 85) {
                    status = 'Risky';
                } else {
                    status = 'Up to Standard';
                }
                
                // Get next fix (highest impact)
                let nextFix = null;
                if (hardFails.length > 0) {
                    nextFix = hardFails[0];
                } else if (softWarnings.length > 0) {
                    // Sort by impact
                    const sorted = [...softWarnings].sort((a, b) => (b.impact || 0) - (a.impact || 0));
                    nextFix = sorted[0];
                }
                
                // Get top 3-6 issues affecting score
                const allIssues = [...hardFails, ...softWarnings].slice(0, 6);
                
                return {
                    status,
                    score: Math.max(0, score),
                    hardFails,
                    softWarnings,
                    nextFix,
                    issues: allIssues
                };
            },
            
            renderStandards(standards = null) {
                const container = document.getElementById('offerBuilderStandardsContent');
                if (!container) return;
                
                const self = this; // Capture 'this' for setTimeout callbacks
                
                if (!standards) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #6b7280; font-size: 13px;">
                            Add services to begin evaluation
                        </div>
                    `;
                    // Update sticky positioning after rendering
                    setTimeout(() => {
                        if (self.updateStickyPositioning) {
                            self.updateStickyPositioning();
                        }
                    }, 50);
                    return;
                }
                
                // Continue with standards rendering - 'self' already declared above
                
                const { status, score, hardFails, softWarnings, nextFix, issues } = standards;
                
                // Status badge colors
                const statusColors = {
                    'Draft': { bg: '#f3f4f6', text: '#374151', border: '#d1d5db' },
                    'Incomplete': { bg: '#fee2e2', text: '#991b1b', border: '#fecaca' },
                    'Needs Fixes': { bg: '#fef3c7', text: '#92400e', border: '#fde68a' },
                    'Risky': { bg: '#fef3c7', text: '#92400e', border: '#fde68a' },
                    'Up to Standard': { bg: '#d1fae5', text: '#065f46', border: '#a7f3d0' }
                };
                
                const statusColor = statusColors[status] || statusColors['Draft'];
                const scoreColor = score >= 85 ? '#10b981' : score >= 70 ? '#f59e0b' : '#ef4444';
                const isPass = status === 'Up to Standard';
                
                // Map issues to field IDs for scrolling
                const fieldMap = {
                    'Offer name is required': 'offerBuilderName',
                    'No services selected': 'offerBuilderLineItems',
                    'Headline is required': 'offerBuilderHeadline',
                    '1-Sentence Promise is required': 'offerBuilderOneSentencePromise',
                    'Category is required': 'offerBuilderCategory',
                    'Primary Avatar is required': 'offerBuilderPrimaryAvatar',
                    'Intended Goal is required': 'offerBuilderIntendedGoal',
                    'Market is required': 'offerBuilderMarket',
                    'Percentage off value missing': 'offerBuilderPercentOff',
                    'Dollar off value missing': 'offerBuilderDollarOff',
                    'Bundle price missing': 'offerBuilderBundlePrice'
                };
                
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Status Badge -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${statusColor.bg}; border: 2px solid ${statusColor.border}; border-radius: 8px;">
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: ${statusColor.text}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Status</div>
                                <div style="font-size: 16px; font-weight: 700; color: ${statusColor.text};">${isPass ? 'Pass' : status}</div>
                                </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; font-weight: 600; color: ${statusColor.text}; margin-bottom: 4px;">Score</div>
                                <div style="font-size: 20px; font-weight: 900; color: ${scoreColor};">${score}</div>
                            </div>
                        </div>
                        
                        ${nextFix ? `
                            <!-- Next Fix -->
                            <div style="padding: 12px; background: #f9fafb; border-left: 4px solid ${nextFix.type === 'hard' ? '#ef4444' : '#f59e0b'}; border-radius: 6px;">
                                <div style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin-bottom: 6px;">Next Fix</div>
                                <button onclick="offerBuilder.scrollToField('${fieldMap[nextFix.message] || ''}')" style="width: 100%; text-align: left; padding: 0; background: none; border: none; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">${nextFix.fix}</button>
                                <div style="font-size: 12px; color: #6b7280; line-height: 1.4;">${nextFix.message}</div>
                                ${nextFix.suggestion ? `<div style="font-size: 11px; color: #059669; margin-top: 6px; font-weight: 600;">Tip: ${nextFix.suggestion}</div>` : ''}
                            </div>
                        ` : ''}
                        
                        ${issues.length > 0 ? `
                            <!-- Top Issues -->
                            <div>
                                <div style="font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Issues (${issues.length})</div>
                                <div style="display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto;">
                                    ${issues.slice(0, 5).map((issue, idx) => {
                                        const fieldId = fieldMap[issue.message] || '';
                                        return `
                                            <div style="padding: 8px; background: ${issue.type === 'hard' ? '#fee2e2' : '#fef3c7'}; border-radius: 6px; border-left: 3px solid ${issue.type === 'hard' ? '#ef4444' : '#f59e0b'}; ${fieldId ? 'cursor: pointer;' : ''}" ${fieldId ? `onclick="offerBuilder.scrollToField('${fieldId}')"` : ''}>
                                                <div style="font-size: 11px; font-weight: 600; color: ${issue.type === 'hard' ? '#991b1b' : '#92400e'}; ${fieldId ? 'text-decoration: underline;' : ''}">${issue.message}</div>
                        </div>
                    `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <div style="padding: 12px; background: #d1fae5; border-radius: 6px; text-align: center;">
                                <div style="font-size: 12px; color: #065f46; font-weight: 600;">All checks passed</div>
                            </div>
                        `}
                    </div>
                `;
                
                // Update sticky positioning after rendering standards (content height changed)
                // Note: 'self' already declared at function start
                setTimeout(() => {
                    if (self.updateStickyPositioning) {
                        self.updateStickyPositioning();
                    }
                }, 50);
            },
            
            scrollToField(fieldId) {
                if (!fieldId) return;
                const field = document.getElementById(fieldId);
                if (field) {
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => field.focus(), 300);
                }
            },
            
            validateHeadline(value) {
                const guardrail = document.getElementById('offerBuilderHeadlineGuardrail');
                if (!guardrail) return;
                
                if (!value || value.trim() === '') {
                    guardrail.style.display = 'none';
                    return;
                }
                
                const hasOutcome = /install|mount|setup|protect|secure|fast|complete/i.test(value);
                const hasTime = /\d+\s*(hour|day|minute|today|same|24)/i.test(value);
                const hasPain = /no|without|avoid|save|easy|simple|guarantee/i.test(value);
                
                if (!hasOutcome || (!hasTime && !hasPain)) {
                    guardrail.style.display = 'block';
                    guardrail.style.color = '#f59e0b';
                    guardrail.textContent = 'Tip: Include a concrete outcome AND either a time reference or pain removed.';
                } else {
                    guardrail.style.display = 'none';
                }
            },
            
            validatePromise(value) {
                const guardrail = document.getElementById('offerBuilderPromiseGuardrail');
                if (!guardrail) return;
                
                if (!value || value.trim() === '') {
                    guardrail.style.display = 'none';
                    return;
                }
                
                const minLength = 30;
                const hasOutcome = /install|mount|setup|protect|secure|guarantee|complete|working/i.test(value);
                
                if (value.length < minLength || !hasOutcome) {
                    guardrail.style.display = 'block';
                    guardrail.style.color = '#f59e0b';
                    guardrail.textContent = `Tip: Promise should be at least ${minLength} characters and include an outcome keyword.`;
                } else {
                    guardrail.style.display = 'none';
                }
            },
            
            validateHooks(value) {
                const guardrail = document.getElementById('offerBuilderHooksGuardrail');
                if (!guardrail) return;
                
                if (!value || value.trim() === '') {
                    guardrail.style.display = 'none';
                    return;
                }
                
                const hooks = value.split('\\n').filter(h => h.trim());
                const maxLength = 60;
                const longHooks = hooks.filter(h => h.length > maxLength);
                
                if (longHooks.length > 0) {
                    guardrail.style.display = 'block';
                    guardrail.style.color = '#f59e0b';
                    guardrail.textContent = `Tip: Keep hooks short (<=${maxLength} chars). ${longHooks.length} hook(s) too long.`;
                } else {
                    guardrail.style.display = 'none';
                }
            },
            
            switchMessagingTab(tab) {
                const tabs = ['snapshot', 'value', 'messaging', 'creative', 'ops', 'decision'];
                tabs.forEach(t => {
                    const tabBtn = document.getElementById(`messagingTab${t.charAt(0).toUpperCase() + t.slice(1)}`);
                    const tabContent = document.getElementById(`messagingTabContent${t.charAt(0).toUpperCase() + t.slice(1)}`);
                    if (tabBtn) {
                        if (t === tab) {
                            tabBtn.style.background = 'var(--cobalt)';
                            tabBtn.style.color = 'white';
                        } else {
                            tabBtn.style.background = '#f3f4f6';
                            tabBtn.style.color = 'var(--cobalt)';
                        }
                    }
                    if (tabContent) {
                        tabContent.style.display = t === tab ? 'block' : 'none';
                    }
                });
            },
            
            updateButtonStates(standards) {
                const generateBtn = document.getElementById('offerBuilderGenerateBriefBtn');
                const markReadyBtn = document.getElementById('offerBuilderMarkReadyBtn');
                
                if (!standards) {
                    // Generate Brief is always enabled (just warns if incomplete)
                    if (generateBtn) {
                        generateBtn.disabled = false;
                        generateBtn.style.opacity = '1';
                        generateBtn.style.cursor = 'pointer';
                    }
                    if (markReadyBtn) markReadyBtn.style.display = 'none';
                    return;
                }
                
                const canMarkReady = standards.status === 'Up to Standard' && standards.hardFails.length === 0;
                
                // Generate Brief is always enabled - preview is always available
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.style.opacity = '1';
                    generateBtn.style.cursor = 'pointer';
                }
                
                if (markReadyBtn) {
                    markReadyBtn.style.display = canMarkReady ? 'block' : 'none';
                    markReadyBtn.disabled = !canMarkReady;
                }
                
                // Update build order
                this.updateBuildOrder(standards);
            },
            
            updateBuildOrder(standards) {
                const servicesComplete = this.offer.lineItems.length > 0;
                const pricingComplete = this.offer.pricingStrategy && 
                    (this.offer.pricingStrategy === 'sum' || 
                     (this.offer.pricingStrategy === 'percentOff' && this.offer.percentOff > 0) ||
                     (this.offer.pricingStrategy === 'dollarOff' && this.offer.dollarOff > 0) ||
                     (this.offer.pricingStrategy === 'bundlePrice' && this.offer.bundlePrice > 0));
                const messagingComplete = this.offer.headline && this.offer.oneSentencePromise;
                const standardsComplete = standards && standards.status === 'Up to Standard';
                const briefComplete = this.offer.briefGenerated || false;

                // Legacy support (no-op if elements removed)
                const updateIcon = (id, complete) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = complete ? '[x]' : '[ ]';
                };
                updateIcon('buildOrderServices', servicesComplete);
                updateIcon('buildOrderPricing', pricingComplete);
                updateIcon('buildOrderMessaging', messagingComplete);
                updateIcon('buildOrderStandards', standardsComplete);
                updateIcon('buildOrderBrief', briefComplete);

                // New stepper
                let currentStep = 1;
                if (servicesComplete) currentStep = 2;
                if (servicesComplete && pricingComplete) currentStep = 3;
                if (servicesComplete && pricingComplete && messagingComplete) currentStep = 4;
                if (servicesComplete && pricingComplete && messagingComplete && standardsComplete) currentStep = 5;

                this._currentStep = currentStep;

                const labels = {
                    1: 'Add Services',
                    2: 'Choose Pricing',
                    3: 'Fill Messaging',
                    4: 'Review Standards',
                    5: 'Generate Brief'
                };

                const stepLabel = document.getElementById('offerBuilderStepLabel');
                if (stepLabel) stepLabel.textContent = `Step ${currentStep} of 5: ${labels[currentStep]}`;

                const stepNextBtn = document.getElementById('offerBuilderStepNextBtn');
                if (stepNextBtn) stepNextBtn.style.display = currentStep >= 5 ? 'none' : 'inline-flex';

                const stepStates = {
                    1: !!servicesComplete,
                    2: !!pricingComplete,
                    3: !!messagingComplete,
                    4: !!standardsComplete,
                    5: !!briefComplete
                };

                for (let i = 1; i <= 5; i++) {
                    const btn = document.getElementById(`obStepBtn${i}`);
                    const circle = document.getElementById(`obStepCircle${i}`);
                    if (!btn || !circle) continue;

                    btn.classList.remove('is-done', 'is-current');
                    circle.textContent = String(i);
                    if (stepStates[i] && (i < currentStep || (i === 5 && briefComplete))) {
                        btn.classList.add('is-done');
                    } else if (i === currentStep) {
                        btn.classList.add('is-current');
                    }
                }
            },
            
            generateSampleOfferData() {
                const categories = ['TV Mount', 'Cameras', 'Doorbell', 'WiFi', 'Bundle'];
                const category = categories[Math.floor(Math.random() * categories.length)];
                const avatars = ['homeowner', 'renter', 'property manager', 'small biz'];
                const goals = ['bookings', 'AOV lift', 'bundle attach', 'speed to cash', 'lead volume'];
                const markets = ['All', 'Dallas, TX', 'Houston, TX', 'Austin, TX', 'San Antonio, TX'];
                const scarcityTypes = ['deadline', 'limited slots', 'limited bundles', 'price ends'];
                
                // Use Math.random() for random selections (can be made deterministic with seed if needed)
                // Check for URL seed parameter for deterministic generation
                const urlParams = new URLSearchParams(window.location.search);
                const seedParam = urlParams.get('seed');
                let seed = seedParam ? parseInt(seedParam) : null;
                
                // Simple seeded RNG if seed provided, otherwise use Math.random()
                let rngState = seed || Math.floor(Math.random() * 1000000);
                const seededRandom = () => {
                    rngState = (rngState * 9301 + 49297) % 233280;
                    return rngState / 233280;
                };
                
                const random = seed !== null ? seededRandom : () => Math.random();
                const randomInt = (max) => Math.floor(random() * max);
                const randomChoice = (arr) => arr[randomInt(arr.length)];
                
                const sample = {
                    name: `${category} Special Offer ${new Date().getMonth() + 1}/${new Date().getDate()}`,
                    category: category,
                    market: randomChoice(markets),
                    primaryAvatar: randomChoice(avatars),
                    intendedGoal: randomChoice(goals),
                    headline: this.generateHeadline(category),
                    oneSentencePromise: this.generatePromise(category),
                    offerStartDate: new Date().toISOString().split('T')[0],
                    offerEndDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    scarcityMechanism: randomChoice(scarcityTypes),
                    riskReversal: '30-day satisfaction guarantee. If not happy, we\'ll redo the work at no charge.',
                    whatsIncluded: this.generateWhatsIncluded(category),
                    whatsNotIncluded: 'Additional wiring beyond 10 feet, custom mounting brackets, premium equipment upgrades.',
                    eligibilityRules: this.generateEligibility(category),
                    redemptionRules: 'Book online only. Use promo code at checkout. Valid for new customers only.',
                    dreamOutcome: this.generateDreamOutcome(category),
                    likelihoodOfAchievement: 'Proven process with 500+ installations. Licensed and insured technicians.',
                    timeDelay: this.generateTimeDelay(category),
                    effortSacrifice: 'No need to research installers, buy tools, or risk DIY mistakes. We handle everything.',
                    competitorPriceRange: this.generateCompetitorRange(category),
                    howWereDifferent: 'Not just cheaper - faster, guaranteed, and fully insured. Same-day service available.',
                    whyChooseUs: 'Licensed pros with 4.9/5 rating. We show up on time, clean up after, and guarantee our work.',
                    bookingPageMicrocopy: 'Limited time offer. Book your installation today and save. Professional service, guaranteed satisfaction.',
                    smsConfirmation: `Your ${category.toLowerCase()} installation is confirmed! We'll text you 24h before with arrival time.`,
                    smsReminder24h: 'Reminder: Your installation is tomorrow. We\'ll arrive between 9am-12pm. Reply STOP to opt out.',
                    priceQuestionLine: 'Our price includes professional installation, all materials, and a satisfaction guarantee. Best value in town.',
                    techBroadcastMessage: `New ${category} offer active. Follow standard installation checklist. Upsell opportunities: wire management, extended warranty.`,
                    hooks: this.generateHooks(category),
                    objectionsRebuttals: this.generateObjections(category),
                    proofIdeas: ['Customer testimonials (4.9/5 stars)', 'Before/after photos', '30-day guarantee badge'],
                    whatToSayInHome: this.generateWhatToSay(category),
                    specialInstructions: 'Take before photos. Check wall type and stud location. Offer wire management upgrade if applicable.',
                    capacityAssumption: '3-4 jobs per day per tech',
                    cancellationRisks: 'Weather delays, wall type incompatibility, customer not home, access issues.',
                    bestCaseOutcome: `Book 20+ ${category.toLowerCase()} installations this month with 40%+ margins.`,
                    worstCaseRisk: 'Low booking rate if pricing too aggressive. Margin compression if materials cost spike.',
                    confidenceScore: 7,
                    confidenceWhy: 'Strong offer structure, realistic pricing, proven category demand.',
                    marginBreakPoints: 'Materials cost increase, travel distance >20mi, complex wall types requiring extra time.',
                    safeguards: 'Cap travel distance. Require wall type photos before booking. Lock in material costs upfront.',
                    paymentProcessingFees: 2.9,
                    travelOtherVariableCost: 15
                };
                
                // Add services based on category
                if (category === 'TV Mount') {
                    sample.lineItems = [
                        { id: '1', serviceId: 'tv-install', name: 'TV Installation', qty: randomInt(3) + 1, baseUnitPrice: 150, equipCostPerUnit: 0, equipMode: 'BYO', isIncludedInOffer: true, notes: '' }
                    ];
                    if (random() > 0.5) {
                        sample.lineItems.push({ id: '2', serviceId: 'soundbar-mount', name: 'Soundbar Mount', qty: 1, baseUnitPrice: 75, equipCostPerUnit: 0, equipMode: 'BYO', isIncludedInOffer: true, notes: 'Add-on' });
                    }
                } else if (category === 'Cameras') {
                    const cameraCount = randomInt(5) + 2;
                    sample.lineItems = [
                        { id: '1', serviceId: 'security-system', name: 'Security System Install', qty: cameraCount, baseUnitPrice: Math.round(500 / cameraCount), equipCostPerUnit: Math.round(300 / cameraCount), equipMode: 'included', isIncludedInOffer: true, notes: `${cameraCount} cameras` }
                    ];
                } else if (category === 'Doorbell') {
                    sample.lineItems = [
                        { id: '1', serviceId: 'doorbell-camera', name: 'Doorbell Camera Install', qty: 1, baseUnitPrice: 200, equipCostPerUnit: 150, equipMode: 'included', isIncludedInOffer: true, notes: '' }
                    ];
                } else if (category === 'WiFi') {
                    sample.lineItems = [
                        { id: '1', serviceId: 'wifi-setup', name: 'WiFi Setup / Mesh Network', qty: 1, baseUnitPrice: 250, equipCostPerUnit: 0, equipMode: 'BYO', isIncludedInOffer: true, notes: 'Mesh system setup' }
                    ];
                } else {
                    sample.lineItems = [
                        { id: '1', serviceId: 'tv-install', name: 'TV Installation', qty: 1, baseUnitPrice: 150, equipCostPerUnit: 0, equipMode: 'BYO', isIncludedInOffer: true, notes: '' },
                        { id: '2', serviceId: 'doorbell-camera', name: 'Doorbell Camera Install', qty: 1, baseUnitPrice: 200, equipCostPerUnit: 150, equipMode: 'included', isIncludedInOffer: true, notes: '' }
                    ];
                }
                
                // Pricing strategy
                const strategies = ['sum', 'percentOff', 'dollarOff', 'bundlePrice'];
                sample.pricingStrategy = randomChoice(strategies);
                const subtotal = sample.lineItems.reduce((sum, item) => sum + (item.baseUnitPrice * item.qty), 0);
                
                if (sample.pricingStrategy === 'percentOff') {
                    sample.percentOff = randomInt(25) + 10; // 10-35% off
                } else if (sample.pricingStrategy === 'dollarOff') {
                    sample.dollarOff = Math.floor(subtotal * 0.15);
                } else if (sample.pricingStrategy === 'bundlePrice') {
                    sample.bundlePrice = Math.floor(subtotal * 0.85);
                }
                
                return sample;
            },
            
            generateHeadline(category) {
                const headlines = {
                    'TV Mount': ['Get Your TV Mounted in 24 Hours', 'Professional TV Mounting Same Day', 'TV Mounted Today, No Hassle'],
                    'Cameras': ['Complete Security System Installed Today', 'Get Protected in 24 Hours', 'Professional Camera Installation Same Day'],
                    'Doorbell': ['Smart Doorbell Installed Today', 'Get Your Doorbell Camera in 24 Hours', 'Professional Doorbell Install Same Day'],
                    'WiFi': ['WiFi Setup Done Right, Same Day', 'Get Fast WiFi Today', 'Professional WiFi Setup in 24 Hours'],
                    'Bundle': ['Complete Smart Home Setup Today', 'Get Everything Installed Same Day', 'Full Installation Package in 24 Hours']
                };
                const options = headlines[category] || headlines['TV Mount'];
                // Use a simple hash of category for consistent selection if seed is used
                return options[Math.floor(Math.random() * options.length)];
            },
            
            generatePromise(category) {
                const promises = {
                    'TV Mount': 'Professional installation in under 2 hours, guaranteed perfect level and secure mounting.',
                    'Cameras': 'Complete security system installed and configured in one visit, with mobile app setup included.',
                    'Doorbell': 'Smart doorbell installed and connected to your phone in under 90 minutes, guaranteed.',
                    'WiFi': 'Fast, reliable WiFi throughout your home, professionally configured and tested same day.',
                    'Bundle': 'Complete smart home setup in one visit, everything working and connected to your phone.'
                };
                return promises[category] || promises['TV Mount'];
            },
            
            generateWhatsIncluded(category) {
                if (category === 'TV Mount') return 'Professional mounting, leveling, cable management, basic wall patching if needed.';
                if (category === 'Cameras') return 'Camera installation, wiring (up to 10ft), mobile app setup, basic configuration.';
                if (category === 'Doorbell') return 'Doorbell installation, wiring connection, mobile app setup, video testing.';
                if (category === 'WiFi') return 'Router/mesh setup, network configuration, speed testing, device connection help.';
                return 'Professional installation, setup, and configuration of all included services.';
            },
            
            generateEligibility(category) {
                if (category === 'TV Mount') return 'Standard drywall or stud walls. TV up to 85". Height restrictions may apply for very high mounts.';
                if (category === 'Cameras') return 'Standard home construction. Access to power and mounting locations required.';
                if (category === 'Doorbell') return 'Existing doorbell wiring or power access required. Standard door frame compatibility.';
                if (category === 'WiFi') return 'Home with existing internet service. Access to router location required.';
                return 'Standard home installation. Access and compatibility requirements apply.';
            },
            
            generateDreamOutcome(category) {
                if (category === 'TV Mount') return 'Perfect viewing angle, no visible wires, secure mounting you can trust.';
                if (category === 'Cameras') return 'Complete home security, peace of mind, remote monitoring from anywhere.';
                if (category === 'Doorbell') return 'See who\'s at your door from anywhere, package protection, visitor alerts.';
                if (category === 'WiFi') return 'Fast, reliable internet in every room, no dead zones, seamless streaming.';
                return 'Complete smart home setup, everything working perfectly, controlled from your phone.';
            },
            
            generateTimeDelay(category) {
                return category === 'WiFi' ? 'Same day' : '24 hours';
            },
            
            generateCompetitorRange(category) {
                const ranges = {
                    'TV Mount': '$200-$400',
                    'Cameras': '$800-$1500',
                    'Doorbell': '$300-$500',
                    'WiFi': '$200-$400',
                    'Bundle': '$1000-$2000'
                };
                return ranges[category] || '$200-$500';
            },
            
            generateHooks(category) {
                return [
                    `Get your ${category.toLowerCase()} installed today`,
                    'Professional service, guaranteed satisfaction',
                    'No DIY headaches, we handle everything',
                    'Licensed and insured technicians',
                    'Same-day service available'
                ];
            },
            
            generateObjections(category) {
                return [
                    'Too expensive -> Our price includes everything: installation, materials, and guarantee. Competitors charge extra.',
                    'Can do it myself -> Save 4+ hours and avoid costly mistakes. We guarantee perfect results.',
                    'Not sure I need it -> Free consultation included. See the value before you commit.'
                ];
            },
            
            generateWhatToSay(category) {
                return [
                    'Highlight the guarantee and same-day service',
                    'Show before/after photos if available',
                    'Mention the included mobile app setup'
                ];
            },
            
            async generateSampleOffer() {
                // Check if user has typed anything
                const hasContent = this.offer.name || 
                    this.offer.lineItems.length > 0 || 
                    this.offer.headline || 
                    document.getElementById('offerBuilderName')?.value ||
                    document.getElementById('offerBuilderHeadline')?.value;
                
                if (hasContent) {
                    const confirmed = await showConfirm('Overwrite Draft?', 'This will populate all fields with a sample offer. Continue?');
                    if (!confirmed) return;
                }
                
                const sample = this.generateSampleOfferData();
                // Mark as sample offer
                this.offer.isSample = true;
                this.applyOfferToUI(sample, { keepNumbers: false });
                
                // Show sample indicator
                showToast('Sample offer generated. Review and adjust as needed, then click "Save Offer" to keep it.', 'success');
                
                // Recalculate and scroll to standards
                setTimeout(() => {
                    this.recalculateOffer();
                    setTimeout(() => {
                        const standardsEl = document.getElementById('offerBuilderStandards');
                        if (standardsEl) {
                            standardsEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);
                }, 100);
            },
            
            applyOfferToUI(sample, { keepNumbers }) {
                // Always update messaging/copy fields
                if (sample.name) {
                    const nameEl = document.getElementById('offerBuilderName');
                    if (nameEl) {
                        nameEl.value = sample.name;
                        this.updateOfferName(sample.name);
                    }
                }
                
                if (!keepNumbers) {
                    // Clear existing line items
                    this.offer.lineItems = [];
                    this.renderLineItems();
                    
                    // Add new services
                    sample.lineItems.forEach(item => {
                        const service = this.serviceCatalog.find(s => s.id === item.serviceId) || this.serviceCatalog[0];
                        if (service) {
                            const lineItem = {
                                id: Date.now().toString() + Math.random(),
                                serviceId: item.serviceId,
                                name: item.name,
                                qty: item.qty,
                                baseUnitPrice: item.baseUnitPrice,
                                equipCostPerUnit: item.equipCostPerUnit,
                                equipMode: item.equipMode,
                                isIncludedInOffer: true,
                                notes: item.notes || ''
                            };
                            this.offer.lineItems.push(lineItem);
                        }
                    });
                    this.renderLineItems();
                    
                    // Update pricing strategy
                    this.offer.pricingStrategy = sample.pricingStrategy;
                    this.updatePricingStrategy(sample.pricingStrategy);
                    
                    if (sample.percentOff) {
                        this.offer.percentOff = sample.percentOff;
                        const el = document.getElementById('offerBuilderPercentOff');
                        if (el) el.value = sample.percentOff;
                    }
                    if (sample.dollarOff) {
                        this.offer.dollarOff = sample.dollarOff;
                        const el = document.getElementById('offerBuilderDollarOff');
                        if (el) el.value = sample.dollarOff;
                    }
                    if (sample.bundlePrice) {
                        this.offer.bundlePrice = sample.bundlePrice;
                        const el = document.getElementById('offerBuilderBundlePrice');
                        if (el) el.value = sample.bundlePrice;
                    }
                }
                
                // Update all messaging fields
                const fieldMap = {
                    category: 'offerBuilderCategory',
                    market: 'offerBuilderMarket',
                    primaryAvatar: 'offerBuilderPrimaryAvatar',
                    intendedGoal: 'offerBuilderIntendedGoal',
                    headline: 'offerBuilderHeadline',
                    oneSentencePromise: 'offerBuilderOneSentencePromise',
                    offerStartDate: 'offerBuilderOfferStartDate',
                    offerEndDate: 'offerBuilderOfferEndDate',
                    scarcityMechanism: 'offerBuilderScarcityMechanism',
                    riskReversal: 'offerBuilderRiskReversal',
                    whatsIncluded: 'offerBuilderWhatsIncluded',
                    whatsNotIncluded: 'offerBuilderWhatsNotIncluded',
                    eligibilityRules: 'offerBuilderEligibilityRules',
                    redemptionRules: 'offerBuilderRedemptionRules',
                    dreamOutcome: 'offerBuilderDreamOutcome',
                    likelihoodOfAchievement: 'offerBuilderLikelihoodOfAchievement',
                    timeDelay: 'offerBuilderTimeDelay',
                    effortSacrifice: 'offerBuilderEffortSacrifice',
                    competitorPriceRange: 'offerBuilderCompetitorPriceRange',
                    howWereDifferent: 'offerBuilderHowWereDifferent',
                    whyChooseUs: 'offerBuilderWhyChooseUs',
                    bookingPageMicrocopy: 'offerBuilderBookingPageMicrocopy',
                    smsConfirmation: 'offerBuilderSmsConfirmation',
                    smsReminder24h: 'offerBuilderSmsReminder24h',
                    priceQuestionLine: 'offerBuilderPriceQuestionLine',
                    techBroadcastMessage: 'offerBuilderTechBroadcastMessage',
                    specialInstructions: 'offerBuilderSpecialInstructions',
                    capacityAssumption: 'offerBuilderCapacityAssumption',
                    cancellationRisks: 'offerBuilderCancellationRisks',
                    bestCaseOutcome: 'offerBuilderBestCaseOutcome',
                    worstCaseRisk: 'offerBuilderWorstCaseRisk',
                    confidenceWhy: 'offerBuilderConfidenceWhy',
                    marginBreakPoints: 'offerBuilderMarginBreakPoints',
                    safeguards: 'offerBuilderSafeguards'
                };
                
                Object.keys(fieldMap).forEach(key => {
                    if (sample[key] !== undefined) {
                        const el = document.getElementById(fieldMap[key]);
                        if (el) {
                            if (el.tagName === 'SELECT') {
                                el.value = sample[key];
                                el.dispatchEvent(new Event('change'));
                            } else if (el.tagName === 'TEXTAREA') {
                                el.value = sample[key];
                                el.dispatchEvent(new Event('input'));
                            } else {
                                el.value = sample[key];
                                el.dispatchEvent(new Event('input'));
                            }
                            this.updateField(key, sample[key]);
                        }
                    }
                });
                
                // Handle arrays
                if (sample.hooks && Array.isArray(sample.hooks)) {
                    const el = document.getElementById('offerBuilderHooks');
                    if (el) {
                        el.value = sample.hooks.join('\\n');
                        this.updateField('hooks', sample.hooks);
                    }
                }
                if (sample.objectionsRebuttals && Array.isArray(sample.objectionsRebuttals)) {
                    const el = document.getElementById('offerBuilderObjectionsRebuttals');
                    if (el) {
                        el.value = sample.objectionsRebuttals.join('\\n');
                        this.updateField('objectionsRebuttals', sample.objectionsRebuttals);
                    }
                }
                if (sample.proofIdeas && Array.isArray(sample.proofIdeas)) {
                    const el = document.getElementById('offerBuilderProofIdeas');
                    if (el) {
                        el.value = sample.proofIdeas.join('\\n');
                        this.updateField('proofIdeas', sample.proofIdeas);
                    }
                }
                if (sample.whatToSayInHome && Array.isArray(sample.whatToSayInHome)) {
                    const el = document.getElementById('offerBuilderWhatToSayInHome');
                    if (el) {
                        el.value = sample.whatToSayInHome.join('\\n');
                        this.updateField('whatToSayInHome', sample.whatToSayInHome);
                    }
                }
                
                // Handle confidence score
                if (sample.confidenceScore !== undefined) {
                    const el = document.getElementById('offerBuilderConfidenceScore');
                    if (el) {
                        el.value = sample.confidenceScore;
                        this.updateField('confidenceScore', sample.confidenceScore);
                    }
                }
            },
            
            renderLineItems() {
                const container = document.getElementById('offerBuilderLineItems');
                const emptyState = document.getElementById('offerBuilderEmptyState');
                const tipBanner = document.getElementById('offerBuilderTipBanner');
                
                if (!container) return;
                
                if (this.offer.lineItems.length === 0) {
                    container.innerHTML = '';
                    if (emptyState) emptyState.style.display = 'block';
                    if (tipBanner) tipBanner.style.display = 'none';
                    return;
                }
                
                if (emptyState) emptyState.style.display = 'none';
                if (tipBanner) tipBanner.style.display = 'block';
                
                container.innerHTML = this.offer.lineItems.map((item, index) => {
                    // Ensure BYO mode has 0 cost
                    if (item.equipMode === 'BYO') {
                        item.equipCostPerUnit = 0;
                    }
                    
                    const allServices = [...this.serviceCatalog, ...this.getCustomServices()];
                    const service = allServices.find(s => s.id === item.serviceId);
                    const lineTotal = item.baseUnitPrice * item.qty;
                    const equipTotal = item.equipCostPerUnit * item.qty;
                    
                    return `
                    <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--cobalt)'; this.style.boxShadow='0 2px 8px rgba(10,42,90,0.1)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <div style="font-size: 17px; font-weight: 700; color: var(--cobalt); margin-bottom: 6px;">${item.name}</div>
                                ${item.baseUnitPrice === 0 ? `
                                    <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 8px 10px; margin-bottom: 6px; border-radius: 4px;">
                                        <div style="font-size: 12px; color: #92400e; font-weight: 600;">Enter your price below</div>
                                        ${service && service.benchmarkPrice ? `<div style="font-size: 11px; color: #78350f; margin-top: 2px;">Industry Reference: ${service.benchmarkPrice}</div>` : ''}
                                    </div>
                                ` : `
                                    <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
                                        Your Price: <strong style="color: #374151;">$${item.baseUnitPrice.toFixed(2)}</strong>
                                        ${service && service.benchmarkPrice ? ` <span style="color: #9ca3af;">(Industry: ${service.benchmarkPrice})</span>` : ''}
                                    </div>
                                `}
                                ${item.notes ? `<div style="font-size: 12px; color: #6b7280; font-style: italic; margin-top: 4px;">${item.notes}</div>` : ''}
                            </div>
                            <button onclick="offerBuilder.removeLineItem('${item.id}')" style="padding: 8px 14px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#dc2626'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='#ef4444'; this.style.transform='scale(1)'">
                                Remove
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">What's Your Price? <span style="color: #ef4444;">*</span></label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #6b7280; font-weight: 600;">$</span>
                                    <input type="number" value="${item.baseUnitPrice}" min="0" step="0.01" placeholder="0.00" onchange="offerBuilder.updateLineItem('${item.id}', 'baseUnitPrice', this.value)" style="width: 100%; padding: 10px 10px 10px 28px; border: 2px solid ${item.baseUnitPrice === 0 ? '#f59e0b' : '#e5e7eb'}; border-radius: 8px; font-size: 15px; font-weight: 600; color: var(--cobalt);">
                                </div>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Your labor charge to the customer</div>
                            </div>
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Quantity</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button onclick="offerBuilder.updateLineItem('${item.id}', 'qty', Math.max(1, ${item.qty} - 1))" style="width: 36px; height: 36px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; color: var(--cobalt); transition: all 0.2s;" onmouseover="this.style.borderColor='var(--cobalt)'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">-</button>
                                    <input type="number" value="${item.qty}" min="1" onchange="offerBuilder.updateLineItem('${item.id}', 'qty', this.value)" style="width: 70px; padding: 8px; text-align: center; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-weight: 600; color: var(--cobalt);">
                                    <button onclick="offerBuilder.updateLineItem('${item.id}', 'qty', ${item.qty} + 1)" style="width: 36px; height: 36px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 16px; color: var(--cobalt); transition: all 0.2s;" onmouseover="this.style.borderColor='var(--cobalt)'; this.style.background='#f9fafb'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Equipment</label>
                                <select onchange="offerBuilder.updateLineItem('${item.id}', 'equipMode', this.value)" style="width: 100%; padding: 8px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 13px; cursor: pointer;">
                                    <option value="included" ${item.equipMode === 'included' ? 'selected' : ''}>We Provide</option>
                                    <option value="BYO" ${item.equipMode === 'BYO' ? 'selected' : ''}>Customer Provides</option>
                                    <option value="custom" ${item.equipMode === 'custom' ? 'selected' : ''}>Custom Cost</option>
                                </select>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">
                                    ${item.equipMode === 'included' ? 'Enter cost per unit below' : item.equipMode === 'BYO' ? 'No equipment cost' : 'Set custom cost per unit'}
                                </div>
                            </div>
                            <div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt);">Equipment Cost <span style="font-weight: 400; color: #6b7280; font-size: 11px;">(per unit)</span></label>
                                    ${item.equipMode !== 'BYO' ? `
                                        <button type="button" onclick="offerBuilder.estimateEquipmentCost('${item.id}')" style="padding: 4px 10px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; color: var(--cobalt); transition: all 0.2s;" onmouseover="this.style.background='#dbeafe'; this.style.borderColor='#93c5fd'" onmouseout="this.style.background='#f0f9ff'; this.style.borderColor='#bae6fd'">
                                            AI Estimate
                                        </button>
                                    ` : ''}
                                </div>
                                <input type="number" value="${item.equipCostPerUnit}" min="0" step="0.01" ${item.equipMode === 'BYO' ? 'disabled' : ''} onchange="offerBuilder.updateLineItem('${item.id}', 'equipCostPerUnit', this.value)" placeholder="0.00" style="width: 100%; padding: 8px; border: 2px solid ${item.equipMode === 'BYO' ? '#d1d5db' : '#e5e7eb'}; border-radius: 8px; font-size: 13px; ${item.equipMode === 'BYO' ? 'background: #f3f4f6; color: #9ca3af;' : ''}">
                                ${item.equipEstimate ? `
                                    <div style="background: ${item.equipEstimate.confidence === 'high' ? '#d1fae5' : item.equipEstimate.confidence === 'medium' ? '#fef3c7' : '#fee2e2'}; border: 1px solid ${item.equipEstimate.confidence === 'high' ? '#a7f3d0' : item.equipEstimate.confidence === 'medium' ? '#fde68a' : '#fecaca'}; border-radius: 6px; padding: 10px; margin-top: 6px;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                                            <div style="font-size: 11px; font-weight: 600; color: ${item.equipEstimate.confidence === 'high' ? '#065f46' : item.equipEstimate.confidence === 'medium' ? '#92400e' : '#991b1b'};">
                                                AI Estimate (${item.equipEstimate.confidence} confidence)
                                            </div>
                                            <button onclick="offerBuilder.clearEquipmentEstimate('${item.id}')" style="padding: 2px 6px; background: transparent; border: none; cursor: pointer; font-size: 12px; color: #6b7280; font-weight: 700;">X</button>
                                        </div>
                                        <div style="font-size: 12px; font-weight: 700; color: var(--cobalt); margin-bottom: 4px;">
                                            $${item.equipEstimate.estimatedCost.toFixed(2)} (Range: $${item.equipEstimate.costRange.min.toFixed(2)} - $${item.equipEstimate.costRange.max.toFixed(2)})
                                        </div>
                                        ${item.equipEstimate.notes ? `<div style="font-size: 11px; color: #374151; line-height: 1.4; margin-bottom: 6px;">${item.equipEstimate.notes}</div>` : ''}
                                        ${item.equipEstimate.equipmentItems && item.equipEstimate.equipmentItems.length > 0 ? `
                                            <div style="font-size: 10px; color: #6b7280; margin-bottom: 4px;"><strong>Equipment:</strong> ${item.equipEstimate.equipmentItems.join(', ')}</div>
                                        ` : ''}
                                        <button onclick="offerBuilder.applyEquipmentEstimate('${item.id}')" style="width: 100%; padding: 6px; background: var(--cobalt); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: 600; margin-top: 6px; transition: all 0.2s;" onmouseover="this.style.background='#1a4a8a'" onmouseout="this.style.background='var(--cobalt)'">
                                            Apply $${item.equipEstimate.estimatedCost.toFixed(2)}
                                        </button>
                                    </div>
                                ` : service && service.benchmarkEquip && item.equipMode !== 'BYO' ? `
                                    <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px; padding: 8px; margin-top: 6px;">
                                        <div style="font-size: 11px; font-weight: 600; color: var(--cobalt); margin-bottom: 4px;">Industry Reference:</div>
                                        <div style="font-size: 11px; color: #374151; line-height: 1.4;">${service.benchmarkEquip}</div>
                                        <div style="font-size: 10px; color: #6b7280; margin-top: 4px; font-style: italic;">Use as a guide. Do specific research if needed for your exact equipment.</div>
                                    </div>
                                ` : item.equipMode !== 'BYO' ? `
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 6px; padding: 8px; background: #f9fafb; border-radius: 6px;">
                                        Enter the cost per unit of equipment you'll provide. Use "AI Estimate" above for a cost range estimate, or do specific research if needed.
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="background: #f9fafb; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
                                <div>
                                    <div style="color: #6b7280; margin-bottom: 2px;">Service Total</div>
                                    <div style="font-weight: 700; font-size: 14px; color: var(--cobalt);">$${lineTotal.toFixed(2)}</div>
                                </div>
                                <div>
                                    <div style="color: #6b7280; margin-bottom: 2px;">Equipment Total</div>
                                    <div style="font-weight: 700; font-size: 14px; color: ${item.equipMode === 'BYO' ? '#9ca3af' : '#374151'};">$${equipTotal.toFixed(2)}</div>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-style: italic;">
                                Note: Tech payout (35%) is calculated on the final customer price, shown in Offer Totals panel.
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Notes (optional)</label>
                            <input type="text" value="${item.notes || ''}" placeholder="Add notes about this service..." onchange="offerBuilder.updateLineItem('${item.id}', 'notes', this.value)" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                        </div>
                    </div>
                `;
                }).join('');
            },
            
            getCustomServices() {
                try {
                    return JSON.parse(localStorage.getItem('h2s_custom_services_v1') || '[]');
                } catch (e) {
                    return [];
                }
            },
            
            saveCustomService(service) {
                const custom = this.getCustomServices();
                service.id = service.id || 'custom_' + Date.now();
                custom.push(service);
                localStorage.setItem('h2s_custom_services_v1', JSON.stringify(custom));
            },
            
            showAddServiceModal() {
                const customServices = this.getCustomServices();
                const allServices = [...this.serviceCatalog, ...customServices];
                
                const modalHtml = `
                    <div style="padding: 24px;">
                        <h3 style="font-size: 22px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Choose a Service</h3>
                        <p style="font-size: 13px; color: #6b7280; margin: 0 0 20px 0;">Pick from our standard services below, or create your own custom service.</p>
                        
                        <button onclick="offerBuilder.showCreateCustomServiceModal()" style="width: 100%; padding: 14px; margin-bottom: 20px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" onmouseover="this.style.background='#d97706'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.background='#f59e0b'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            Create Custom Service
                        </button>
                        
                        <div style="border-top: 2px solid #e5e7eb; padding-top: 20px; margin-top: 4px;">
                            <div style="font-size: 13px; font-weight: 700; color: var(--cobalt); margin-bottom: 14px;">Standard Services</div>
                            <div style="display: flex; flex-direction: column; gap: 10px; max-height: 50vh; overflow-y: auto; padding-right: 4px;">
                                ${allServices.map(s => {
                                    return `
                                    <button onclick="offerBuilder.addLineItem('${s.id}'); closeModal();" style="width: 100%; padding: 16px; text-align: left; background: white; border: 2px solid #e5e7eb; border-radius: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--cobalt)'; this.style.background='#f0f9ff'; this.style.boxShadow='0 4px 12px rgba(10,42,90,0.1)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'; this.style.boxShadow='none'">
                                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; font-size: 15px; color: var(--cobalt); margin-bottom: 4px;">
                                                    ${s.name}
                                                    ${s.id && s.id.startsWith('custom_') ? '<span style="display: inline-block; margin-left: 6px; padding: 2px 8px; font-size: 10px; color: #f59e0b; background: #fef3c7; border-radius: 4px; font-weight: 600;">YOUR CUSTOM</span>' : ''}
                                                </div>
                                                ${s.benchmarkPrice ? `<div style="font-size: 11px; color: #6b7280; margin-bottom: 2px;">Industry Reference: ${s.benchmarkPrice}</div>` : ''}
                                                ${s.benchmarkEquip ? `<div style="font-size: 11px; color: #6b7280; font-style: italic;">Equipment: ${s.benchmarkEquip}</div>` : ''}
                                            </div>
                                            <div style="padding: 4px 12px; background: var(--cobalt); color: white; border-radius: 6px; font-size: 11px; font-weight: 600; align-self: center; white-space: nowrap;">
                                                Add >
                                            </div>
                                        </div>
                                    </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                showModal('Add Service', modalHtml, { width: '600px', maxHeight: '85vh', html: true });
            },
            
            showCreateCustomServiceModal() {
                const modalHtml = `
                    <div style="padding: 24px;">
                        <h3 style="font-size: 22px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Create Your Own Service</h3>
                        <p style="font-size: 13px; color: #6b7280; margin: 0 0 20px 0;">Don't see what you need? Create a custom service with your own pricing.</p>
                        <form id="customServiceForm" onsubmit="event.preventDefault(); offerBuilder.createCustomService();">
                            <div style="display: flex; flex-direction: column; gap: 18px;">
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">What's the service called? <span style="color: #ef4444;">*</span></label>
                                    <input type="text" id="customServiceName" required placeholder="e.g., Premium Outdoor Camera Setup" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">Give it a clear, descriptive name</div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Category</label>
                                    <select id="customServiceCategory" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                        <option value="">Select...</option>
                                        <option value="TV Mount">TV Mount</option>
                                        <option value="Cameras">Cameras</option>
                                        <option value="Doorbell">Doorbell</option>
                                        <option value="WiFi">WiFi</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">What's your price? <span style="color: #ef4444;">*</span></label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #6b7280;">$</span>
                                        <input type="number" id="customServiceBasePrice" required min="0" step="0.01" placeholder="150.00" style="width: 100%; padding: 12px 12px 12px 28px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">This is what you'll charge the customer for your labor</div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">Who provides the equipment?</label>
                                    <select id="customServiceEquipMode" onchange="document.getElementById('customServiceEquipCost').style.display = this.value === 'BYO' ? 'none' : 'block';" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                        <option value="BYO">Customer brings it (most common)</option>
                                        <option value="included">We provide it (add equipment cost below)</option>
                                        <option value="custom">Custom arrangement</option>
                                    </select>
                                </div>
                                <div id="customServiceEquipCost" style="display: none;">
                                    <label style="display: block; font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 8px;">What's the equipment cost?</label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #6b7280;">$</span>
                                        <input type="number" id="customServiceEquipCostValue" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px 12px 12px 28px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                    </div>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">The actual cost of cameras, mounts, cables, etc. This gets added to your labor price.</div>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Industry Benchmark (optional)</label>
                                    <input type="text" id="customServiceBenchmark" placeholder="e.g., Industry: $100-$200" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Notes (optional)</label>
                                    <textarea id="customServiceNotes" placeholder="Any additional notes about this service" style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; min-height: 60px; resize: vertical;"></textarea>
                                </div>
                                <div style="display: flex; gap: 12px; margin-top: 8px;">
                                    <button type="submit" style="flex: 1; padding: 12px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Create & Add</button>
                                    <button type="button" onclick="closeModal(); offerBuilder.showAddServiceModal();" style="flex: 1; padding: 12px; background: #f3f4f6; color: var(--cobalt); border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                `;
                
                showModal('Create Custom Service', modalHtml, { width: '550px', html: true });
            },
            
            createCustomService() {
                const name = document.getElementById('customServiceName')?.value.trim();
                const basePrice = parseFloat(document.getElementById('customServiceBasePrice')?.value || 0);
                const equipMode = document.getElementById('customServiceEquipMode')?.value || 'BYO';
                const equipCost = equipMode === 'BYO' ? 0 : parseFloat(document.getElementById('customServiceEquipCostValue')?.value || 0);
                const category = document.getElementById('customServiceCategory')?.value || '';
                const benchmark = document.getElementById('customServiceBenchmark')?.value || '';
                const notes = document.getElementById('customServiceNotes')?.value || '';
                
                if (!name || basePrice <= 0) {
                    showToast('Service name and base price are required', 'error');
                    return;
                }
                
                const customService = {
                    id: 'custom_' + Date.now(),
                    name: name,
                    basePrice: basePrice,
                    baseUnitPrice: basePrice,
                    defaultEquipCost: equipCost,
                    equipCostPerUnit: equipCost,
                    equipMode: equipMode,
                    category: category,
                    benchmarkPrice: benchmark || undefined,
                    notes: notes
                };
                
                this.saveCustomService(customService);
                showToast('Custom service created!', 'success');
                closeModal();
                
                // Add it to the offer immediately
                this.addLineItem(customService.id);
            },
            
            showHelp() {
                const helpHtml = `
                    <div style="max-width: 800px; max-height: 85vh; overflow-y: auto; padding: 24px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; position: relative;">
                        <button onclick="closeModal()" style="position: absolute; top: 20px; right: 20px; width: 32px; height: 32px; background: #f3f4f6; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: 700; color: #6b7280; display: flex; align-items: center; justify-content: center; transition: all 0.2s; z-index: 10;" onmouseover="this.style.background='#e5e7eb'; this.style.color='#374151'" onmouseout="this.style.background='#f3f4f6'; this.style.color='#6b7280'">X</button>
                        <h2 style="font-size: 24px; font-weight: 900; color: var(--cobalt); margin: 0 0 8px 0; border-bottom: 3px solid var(--cobalt); padding-bottom: 12px; padding-right: 40px;">How to Use the Offer Builder</h2>
                        <p style="font-size: 14px; color: #6b7280; margin: 0 0 24px 0;">Follow these steps to create a complete offer that's ready to use.</p>
                        
                        <div style="display: flex; flex-direction: column; gap: 24px;">
                            <!-- Step 1 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 1: Give Your Offer a Name</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    At the top, type a name for your offer. Make it clear what the offer is about. For example: "Spring Security Bundle" or "TV Mounting Special".
                                </p>
                            </div>
                            
                            <!-- Step 2 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 2: Add Services and Add-ons</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 12px 0;">
                                    <strong>What does this mean?</strong> This is where you list all the services that will be included in your offer. Think of it like a shopping cart.
                                </p>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    For example, if you're creating a "Security Bundle" offer, you might add:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li>3 Security Camera Installations</li>
                                    <li>1 Doorbell Camera Installation</li>
                                    <li>1 Wire Management Service</li>
                                </ul>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    <strong>How to add services:</strong>
                                </p>
                                <ol style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0; padding-left: 24px;">
                                    <li>Click the "Add Service" button</li>
                                    <li>Pick a service from the list (like "TV Installation" or "Security Camera")</li>
                                    <li>The service will appear in your list</li>
                                    <li>You can change the quantity, price, and equipment settings for each service</li>
                                </ol>
                            </div>
                            
                            <!-- Step 3 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 3: Set Your Pricing Strategy</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 12px 0;">
                                    Choose how you want to price this offer:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li><strong>Sum of all services (no discount):</strong> Customer pays the full price of all services added together</li>
                                    <li><strong>Percentage off:</strong> Give a discount like 10% or 20% off the total</li>
                                    <li><strong>Dollar amount off:</strong> Take a fixed amount off, like $50 off</li>
                                    <li><strong>Fixed bundle price:</strong> Set one total price for everything, no matter what services are included</li>
                                </ul>
                                <p style="font-size: 13px; color: #6b7280; line-height: 1.6; margin: 8px 0 0 0; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <strong>Important:</strong> No matter what discount you give, the tech always gets paid 35% of the original service price. If you give a discount, the customer pays less, but the tech still gets the same amount.
                                </p>
                            </div>
                            
                            <!-- Step 4 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 4: Equipment Costs</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 12px 0;">
                                    For each service, you need to decide about equipment:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li><strong>Included:</strong> You provide the equipment (like a camera or smart lock). Enter how much it costs you.</li>
                                    <li><strong>BYO (Bring Your Own):</strong> The customer provides the equipment. No cost to you.</li>
                                    <li><strong>Custom:</strong> You can set a custom equipment cost if needed.</li>
                                </ul>
                                <p style="font-size: 13px; color: #6b7280; line-height: 1.6; margin: 8px 0 0 0; padding: 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <strong>Industry prices:</strong> When you add a service, you'll see typical industry prices. Use these as a guide, but you can change them to match your actual costs.
                                </p>
                            </div>
                            
                            <!-- Step 5 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 5: Fill in the Messaging</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    Click "Offer Messaging & Framing" to expand it. You'll see tabs for different sections:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li><strong>Snapshot:</strong> Basic info like category, market, headline, and dates</li>
                                    <li><strong>Value Equation:</strong> Why this offer is good for customers</li>
                                    <li><strong>Messaging Pack:</strong> Copy you can use in ads, texts, and booking pages</li>
                                    <li><strong>Creative Angles:</strong> Hooks and ideas for making ads</li>
                                    <li><strong>Ops Notes:</strong> Instructions for technicians</li>
                                    <li><strong>Decision Notes:</strong> Your thoughts on best-case and worst-case outcomes</li>
                                </ul>
                            </div>
                            
                            <!-- Step 6 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 6: Check the Standards Panel</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    On the right side, you'll see a "Standards" panel. This tells you:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li>If your offer is complete or needs fixes</li>
                                    <li>A score from 0 to 100</li>
                                    <li>What to fix next</li>
                                    <li>Any problems that need attention</li>
                                </ul>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 8px 0 0 0;">
                                    Click on any issue to jump to the field that needs fixing.
                                </p>
                            </div>
                            
                            <!-- Step 7 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 7: Review Offer Totals</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    Below the Standards panel, you'll see "Offer Totals". This shows:
                                </p>
                                <ul style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0 0 8px 0; padding-left: 24px;">
                                    <li><strong>Subtotal Base:</strong> Total of all services before any discount</li>
                                    <li><strong>Customer Price:</strong> What the customer will pay (after discount)</li>
                                    <li><strong>Tech Payout:</strong> How much the tech gets (35% of customer price)</li>
                                    <li><strong>Equipment Cost:</strong> Total cost of all equipment</li>
                                    <li><strong>Profit:</strong> How much money you make</li>
                                    <li><strong>Margin:</strong> Profit as a percentage</li>
                                </ul>
                            </div>
                            
                            <!-- Step 8 -->
                            <div style="background: #f9fafb; border-left: 4px solid var(--cobalt); padding: 16px; border-radius: 8px;">
                                <h3 style="font-size: 18px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Step 8: Generate Your Brief</h3>
                                <p style="font-size: 14px; color: #374151; line-height: 1.7; margin: 0 0 8px 0;">
                                    Once your offer is complete and passes the Standards check:
                                </p>
                                <ol style="font-size: 14px; color: #374151; line-height: 1.8; margin: 0; padding-left: 24px;">
                                    <li>Click "Generate Brief" to create a document with all your offer details</li>
                                    <li>Review the preview</li>
                                    <li>Click "Export PDF" to download it</li>
                                    <li>When everything looks good, click "Mark Ready" to finalize your offer</li>
                                </ol>
                            </div>
                            
                            <!-- Tips -->
                            <div style="background: #fff7ed; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px; margin-top: 8px;">
                                <h3 style="font-size: 16px; font-weight: 700; color: #92400e; margin: 0 0 12px 0;">Quick Tips</h3>
                                <ul style="font-size: 14px; color: #78350f; line-height: 1.8; margin: 0; padding-left: 24px;">
                                    <li>Use "Fill Sample Offer" to see an example of a complete offer</li>
                                    <li>Check the build order strip at the top to see your progress</li>
                                    <li>Save your work often using "Save Offer"</li>
                                    <li>If profit is negative (red), adjust your pricing or reduce costs</li>
                                    <li>Make sure equipment costs are filled in if you're providing equipment</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal('How to Use Offer Builder', helpHtml, { width: '850px', maxHeight: '90vh', html: true });
            },
            
            async saveOffer() {
                const warnings = this.validateOffer();
                if (warnings.length > 0) {
                    const confirmed = await showConfirm('Save Offer with Warnings?', `This offer has warnings:\n\n${warnings.join('\n')}\n\nSave anyway?`);
                    if (!confirmed) return;
                }
                
                // Validate required fields
                if (!this.offer.name || this.offer.name.trim() === '') {
                    showToast('Please enter an offer name', 'error');
                    return;
                }
                
                if (this.offer.lineItems.length === 0) {
                    showToast('Please add at least one service', 'error');
                    return;
                }
                
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                const offerData = {
                    ...this.offer,
                    totals,
                    standards: {
                        status: standards.status,
                        score: standards.score,
                        evaluatedAt: new Date().toISOString()
                    },
                    timestamp: new Date().toISOString(),
                    createdBy: currentUser || 'USER',
                    isReady: false,
                    // Preserve isSample flag if it exists
                    isSample: this.offer.isSample || false
                };
                
                // Save to localStorage
                const saved = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                saved.push(offerData);
                localStorage.setItem('h2s_offer_builder_offers_v1', JSON.stringify(saved));
                
                // Save to backend API
                try {
                    const response = await fetch(`${API_URL}?action=saveOffer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            offerName: offerData.name,
                            offerData: offerData,
                            vaName: currentUser || 'USER'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.ok) {
                            // Track offer creation event
                            await trackEvent('offer_created', {
                                offer_name: offerData.name,
                                offer_id: result.offerId || offerData.timestamp,
                                customer_price: totals.finalCustomerPrice,
                                profit: totals.profit,
                                margin: totals.margin,
                                standards_status: standards.status,
                                standards_score: standards.score,
                                service_count: offerData.lineItems.length
                            });
                            
                            showToast('Offer saved successfully to backend!', 'success');
                        } else {
                            console.warn('Backend save failed:', result);
                            showToast('Offer saved locally (backend save failed)', 'warning');
                        }
                    }
                } catch (error) {
                    console.error('Backend save error:', error);
                    showToast('Offer saved locally (backend unavailable)', 'warning');
                }
                
                showToast('Offer saved successfully!', 'success');
            },
            
            async markReady() {
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                if (standards.status !== 'Up to Standard' || standards.hardFails.length > 0) {
                    showToast('Offer must be "Up to Standard" to mark ready', 'error');
                    return;
                }
                
                const confirmed = await showConfirm('Mark Ready for Deployment?', `Status: ${standards.status}\nScore: ${standards.score}/100\n\nThis will create an immutable snapshot.`);
                if (!confirmed) return;
                
                // Create locked version
                const offerData = {
                    ...this.offer,
                    totals,
                    standards: {
                        status: standards.status,
                        score: standards.score,
                        evaluatedAt: new Date().toISOString()
                    },
                    timestamp: new Date().toISOString(),
                    createdBy: currentUser || 'USER',
                    isReady: true,
                    readyAt: new Date().toISOString(),
                    version: '1.0',
                    // Preserve isSample flag if it exists
                    isSample: this.offer.isSample || false
                };
                
                const saved = JSON.parse(localStorage.getItem('h2s_offer_builder_offers_v1') || '[]');
                saved.push(offerData);
                localStorage.setItem('h2s_offer_builder_offers_v1', JSON.stringify(saved));
                
                showToast('Offer marked ready for deployment!', 'success');
            },
            
            async generateBrief() {
                // Validate required fields
                if (!this.offer.name || this.offer.name.trim() === '') {
                    showToast('Please enter an offer name first', 'error');
                    return;
                }
                
                if (this.offer.lineItems.length === 0) {
                    showToast('Please add at least one service', 'error');
                    return;
                }
                
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                // Track brief generation event
                if (typeof trackEvent === 'function') {
                    await trackEvent('brief_generated', {
                        offer_name: this.offer.name,
                        standards_status: standards.status,
                        standards_score: standards.score,
                        customer_price: totals.finalCustomerPrice,
                        profit: totals.profit,
                        margin: totals.margin,
                        service_count: this.offer.lineItems.length
                    });
                }
                
                // Allow preview even if standards aren't met (just warn)
                if (standards.hardFails.length > 0 || standards.status === 'Incomplete') {
                    const confirmed = await showConfirm('Preview Brief with Issues?', 'This offer has issues that need to be fixed. Preview brief anyway?');
                    if (!confirmed) return;
                }
                
                if (totals.profit < 0) {
                    const confirmed = await showConfirm('Preview Unprofitable Offer?', 'This offer is unprofitable. Preview brief anyway?');
                    if (!confirmed) return;
                }
                
                this.offer.briefGenerated = true;
                this.updateBuildOrder(standards);
                await this.previewBrief();
            },
            
            showBriefEditor() {
                const totals = this.calculateTotals();
                const modalHtml = `
                    <div style="max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 24px;">
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin: 0 0 8px 0;">Offer Brief Editor</h3>
                            <p style="color: #6b7280; font-size: 13px; margin: 0;">Fill in the details below, then preview and export as PDF.</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- LEFT: Inputs -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Customer-Facing Offer Statement</label>
                                    <textarea id="briefOfferStatement" placeholder="One paragraph describing the offer..." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;">${this.offer.offerStatement || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Executive Summary</label>
                                    <textarea id="briefExecutiveSummary" placeholder="1-2 sentences..." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;">${this.offer.executiveSummary || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Value Stack</label>
                                    <textarea id="briefValueStack" placeholder="DIY vs us, time saved, etc." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 80px; resize: vertical;">${this.offer.valueStack || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Top 3 Objections + Rebuttals</label>
                                    <div id="briefObjections" style="display: flex; flex-direction: column; gap: 8px;">
                                        ${[0, 1, 2].map(i => `
                                            <input type="text" id="briefObjection${i}" placeholder="Objection ${i + 1} + Rebuttal" value="${(this.offer.objections[i] || '')}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Social Proof</label>
                                    <input type="text" id="briefSocialProofType" placeholder="Type (e.g., Testimonial, Case Study)" value="${this.offer.socialProof.type || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; margin-bottom: 8px;">
                                    <textarea id="briefSocialProofDetail" placeholder="Detail..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 60px; resize: vertical;">${this.offer.socialProof.detail || ''}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Urgency Mechanics</label>
                                    <input type="text" id="briefUrgencyType" placeholder="Type (e.g., Limited Time, Limited Quantity)" value="${this.offer.urgency.type || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; margin-bottom: 8px;">
                                    <textarea id="briefUrgencyDetail" placeholder="Detail..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 50px; resize: vertical; margin-bottom: 8px;">${this.offer.urgency.detail || ''}</textarea>
                                    <input type="text" id="briefUrgencyRationale" placeholder="Rationale..." value="${this.offer.urgency.rationale || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Eligibility / Rules</label>
                                    <textarea id="briefEligibility" placeholder="Who qualifies, terms, restrictions..." style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; min-height: 60px; resize: vertical;">${this.offer.eligibility || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- RIGHT: Platform Copy -->
                            <div style="display: flex; flex-direction: column; gap: 20px;">
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Meta Headline (<=40 chars)</label>
                                    <input type="text" id="briefHeadline" maxlength="40" placeholder="Headline..." value="${this.offer.platformCopy.headline || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><span id="headlineCount">0</span>/40</div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Sub-headline (<=60 chars)</label>
                                    <input type="text" id="briefSubheadline" maxlength="60" placeholder="Sub-headline..." value="${this.offer.platformCopy.subheadline || ''}" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px;">
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><span id="subheadlineCount">0</span>/60</div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Primary Text A (<=180 chars)</label>
                                    <textarea id="briefPrimaryTextA" maxlength="180" placeholder="Primary text..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 60px; resize: vertical;">${this.offer.platformCopy.primaryTextA || ''}</textarea>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><span id="primaryTextACount">0</span>/180</div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Primary Text B (<=180 chars)</label>
                                    <textarea id="briefPrimaryTextB" maxlength="180" placeholder="Primary text..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 60px; resize: vertical;">${this.offer.platformCopy.primaryTextB || ''}</textarea>
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;"><span id="primaryTextBCount">0</span>/180</div>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Landing Bullets (one per line)</label>
                                    <textarea id="briefLandingBullets" placeholder="Bullet 1&#10;Bullet 2&#10;Bullet 3" style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 80px; resize: vertical;">${(this.offer.platformCopy.landingBullets || []).join('\\n')}</textarea>
                                </div>
                                
                                <div>
                                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">Disclaimer / Fine Print</label>
                                    <textarea id="briefDisclaimer" placeholder="Fine print..." style="width: 100%; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; min-height: 60px; resize: vertical;">${this.offer.platformCopy.disclaimer || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="offerBuilder.previewBrief()" class="btn" style="padding: 10px 20px; font-size: 13px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Preview Brief
                            </button>
                            <button onclick="offerBuilder.exportPDF()" class="btn" style="padding: 10px 20px; font-size: 13px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Export PDF
                            </button>
                        </div>
                    </div>
                `;
                
                showModal('Offer Brief Editor', modalHtml, { width: '1000px', maxHeight: '90vh' });
                
                // Update character counts
                ['headline', 'subheadline', 'primaryTextA', 'primaryTextB'].forEach(id => {
                    const el = document.getElementById(`brief${id.charAt(0).toUpperCase() + id.slice(1)}`);
                    const countEl = document.getElementById(`${id}Count`);
                    if (el && countEl) {
                        countEl.textContent = el.value.length;
                        el.addEventListener('input', () => {
                            countEl.textContent = el.value.length;
                        });
                    }
                });
            },
            
            collectBriefData() {
                this.offer.offerStatement = document.getElementById('briefOfferStatement')?.value || '';
                this.offer.executiveSummary = document.getElementById('briefExecutiveSummary')?.value || '';
                this.offer.valueStack = document.getElementById('briefValueStack')?.value || '';
                this.offer.objections = [0, 1, 2].map(i => document.getElementById(`briefObjection${i}`)?.value || '').filter(o => o);
                this.offer.socialProof = {
                    type: document.getElementById('briefSocialProofType')?.value || '',
                    detail: document.getElementById('briefSocialProofDetail')?.value || ''
                };
                this.offer.urgency = {
                    type: document.getElementById('briefUrgencyType')?.value || '',
                    detail: document.getElementById('briefUrgencyDetail')?.value || '',
                    rationale: document.getElementById('briefUrgencyRationale')?.value || ''
                };
                this.offer.eligibility = document.getElementById('briefEligibility')?.value || '';
                this.offer.platformCopy = {
                    headline: document.getElementById('briefHeadline')?.value || '',
                    subheadline: document.getElementById('briefSubheadline')?.value || '',
                    primaryTextA: document.getElementById('briefPrimaryTextA')?.value || '',
                    primaryTextB: document.getElementById('briefPrimaryTextB')?.value || '',
                    landingBullets: (document.getElementById('briefLandingBullets')?.value || '').split('\\n').filter(b => b.trim()),
                    disclaimer: document.getElementById('briefDisclaimer')?.value || ''
                };
            },
            
            collectAllOfferData() {
                // Collect all fields from the messaging tabs
                const fieldMap = {
                    category: 'offerBuilderCategory',
                    market: 'offerBuilderMarket',
                    primaryAvatar: 'offerBuilderPrimaryAvatar',
                    intendedGoal: 'offerBuilderIntendedGoal',
                    headline: 'offerBuilderHeadline',
                    oneSentencePromise: 'offerBuilderOneSentencePromise',
                    offerStartDate: 'offerBuilderOfferStartDate',
                    offerEndDate: 'offerBuilderOfferEndDate',
                    scarcityMechanism: 'offerBuilderScarcityMechanism',
                    riskReversal: 'offerBuilderRiskReversal',
                    whatsIncluded: 'offerBuilderWhatsIncluded',
                    whatsNotIncluded: 'offerBuilderWhatsNotIncluded',
                    eligibilityRules: 'offerBuilderEligibilityRules',
                    redemptionRules: 'offerBuilderRedemptionRules',
                    dreamOutcome: 'offerBuilderDreamOutcome',
                    likelihoodOfAchievement: 'offerBuilderLikelihoodOfAchievement',
                    timeDelay: 'offerBuilderTimeDelay',
                    effortSacrifice: 'offerBuilderEffortSacrifice',
                    competitorPriceRange: 'offerBuilderCompetitorPriceRange',
                    howWereDifferent: 'offerBuilderHowWereDifferent',
                    whyChooseUs: 'offerBuilderWhyChooseUs',
                    bookingPageMicrocopy: 'offerBuilderBookingPageMicrocopy',
                    smsConfirmation: 'offerBuilderSmsConfirmation',
                    smsReminder24h: 'offerBuilderSmsReminder24h',
                    priceQuestionLine: 'offerBuilderPriceQuestionLine',
                    techBroadcastMessage: 'offerBuilderTechBroadcastMessage',
                    specialInstructions: 'offerBuilderSpecialInstructions',
                    capacityAssumption: 'offerBuilderCapacityAssumption',
                    cancellationRisks: 'offerBuilderCancellationRisks',
                    bestCaseOutcome: 'offerBuilderBestCaseOutcome',
                    worstCaseRisk: 'offerBuilderWorstCaseRisk',
                    confidenceWhy: 'offerBuilderConfidenceWhy',
                    marginBreakPoints: 'offerBuilderMarginBreakPoints',
                    safeguards: 'offerBuilderSafeguards'
                };
                
                Object.keys(fieldMap).forEach(key => {
                    const el = document.getElementById(fieldMap[key]);
                    if (el) {
                        this.offer[key] = el.value || '';
                    }
                });
                
                // Handle arrays
                const hooksEl = document.getElementById('offerBuilderHooks');
                if (hooksEl) {
                    this.offer.hooks = hooksEl.value.split('\\n').filter(h => h.trim());
                }
                
                const objectionsEl = document.getElementById('offerBuilderObjectionsRebuttals');
                if (objectionsEl) {
                    this.offer.objectionsRebuttals = objectionsEl.value.split('\\n').filter(o => o.trim());
                }
                
                const proofEl = document.getElementById('offerBuilderProofIdeas');
                if (proofEl) {
                    this.offer.proofIdeas = proofEl.value.split('\\n').filter(p => p.trim());
                }
                
                const whatToSayEl = document.getElementById('offerBuilderWhatToSayInHome');
                if (whatToSayEl) {
                    this.offer.whatToSayInHome = whatToSayEl.value.split('\\n').filter(s => s.trim());
                }
                
                // Handle confidence score
                const confidenceEl = document.getElementById('offerBuilderConfidenceScore');
                if (confidenceEl) {
                    this.offer.confidenceScore = parseInt(confidenceEl.value) || 0;
                }
            },
            
            async previewBrief() {
                this.collectAllOfferData();
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                let discountType = 'sum';
                if (this.offer.pricingStrategy === 'percentOff') discountType = '% off';
                else if (this.offer.pricingStrategy === 'dollarOff') discountType = '$ off';
                else if (this.offer.pricingStrategy === 'bundlePrice') discountType = 'bundle price';
                
                const previewHtml = `
                    <div style="max-width: 900px; max-height: 90vh; overflow-y: auto; padding: 0; background: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; position: relative;">
                        <div style="position: sticky; top: 0; background: white; padding: 24px 32px 16px 32px; border-bottom: 2px solid #e5e7eb; margin-bottom: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                            ${this.offer.isSample ? `
                            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 20px;">!</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 2px;">SAMPLE OFFER</div>
                                    <div style="font-size: 12px; color: #78350f;">This brief was generated from a sample offer template. Review all content before deployment.</div>
                                </div>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h1 style="font-size: 28px; font-weight: 900; color: var(--cobalt); margin: 0;">Home2Smart Offer Brief</h1>
                                <button onclick="closeModal()" style="width: 32px; height: 32px; background: #f3f4f6; border: none; border-radius: 6px; cursor: pointer; font-size: 18px; font-weight: 700; color: #6b7280; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='#e5e7eb'; this.style.color='#374151'" onmouseout="this.style.background='#f3f4f6'; this.style.color='#6b7280'">X</button>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button onclick="offerBuilder.exportPDF()" style="padding: 10px 20px; background: var(--cobalt); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#1a4a8a'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='var(--cobalt)'; this.style.transform='translateY(0)'">Export PDF</button>
                                <button id="submitDeliverablesBtn" onclick="offerBuilder.submitToDeliverables()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;" onmouseover="if(!this.disabled) { this.style.background='#059669'; this.style.transform='translateY(-1px)'; }" onmouseout="if(!this.disabled) { this.style.background='#10b981'; this.style.transform='translateY(0)'; }">
                                    <span id="submitDeliverablesText">Submit to Deliverables</span>
                                    <span id="submitDeliverablesSpinner" style="display: none; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></span>
                                </button>
                            </div>
                        </div>
                        <div style="line-height: 1.7; color: #1f2937; padding: 32px; background: white;">
                            
                            <!-- Economics Summary Box (Compact, Top) -->
                            <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #0ea5e9; border-radius: 12px;">
                                <h3 style="font-size: 16px; font-weight: 700; color: var(--cobalt); margin: 0 0 12px 0;">Economics Summary</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; font-size: 13px;">
                                    <div><strong>Customer Price:</strong><br><span style="font-size: 18px; font-weight: 900; color: var(--cobalt);">$${totals.customerPrice.toFixed(2)}</span></div>
                                    <div><strong>Tech Payout:</strong><br><span style="font-size: 16px; font-weight: 700; color: #92400e;">$${totals.techPayoutTotal.toFixed(2)}</span><br><span style="font-size: 11px; color: #6b7280;">(35% of customer price)</span></div>
                                    <div><strong>Equipment Cost:</strong><br><span style="font-size: 16px; font-weight: 700; color: #dc2626;">$${totals.equipCostTotal.toFixed(2)}</span></div>
                                    <div><strong>Profit:</strong><br><span style="font-size: 18px; font-weight: 900; color: ${totals.profit >= 0 ? '#059669' : '#dc2626'};">$${totals.profit.toFixed(2)}</span></div>
                                    <div><strong>Margin:</strong><br><span style="font-size: 18px; font-weight: 900; color: ${totals.marginPct >= 30 ? '#059669' : totals.marginPct >= 20 ? '#d97706' : '#dc2626'};">${totals.marginPct.toFixed(1)}%</span></div>
                                    <div><strong>Standards Score:</strong><br><span style="font-size: 16px; font-weight: 700; color: ${standards.score >= 80 ? '#059669' : standards.score >= 60 ? '#d97706' : '#dc2626'};">${standards.score}/100</span><br><span style="font-size: 11px; color: #6b7280;">${standards.status}</span></div>
                                </div>
                            </div>
                            
                            <!-- 1) OFFER SNAPSHOT -->
                            <section style="margin-bottom: 32px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">1) Offer Snapshot (Read This First)</h2>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 13px;">
                                    <div><strong>Offer Name:</strong> ${this.offer.name || 'N/A'}</div>
                                    <div><strong>Category:</strong> ${this.offer.category || 'N/A'}</div>
                                    <div><strong>Market:</strong> ${this.offer.market || 'N/A'}</div>
                                    <div><strong>Primary Avatar:</strong> ${this.offer.primaryAvatar || 'N/A'}</div>
                                    <div><strong>Intended Goal:</strong> ${this.offer.intendedGoal || 'N/A'}</div>
                                    <div><strong>Offer Dates:</strong> ${this.offer.offerStartDate || 'N/A'} to ${this.offer.offerEndDate || 'N/A'}</div>
                                </div>
                                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                                    <div style="margin-bottom: 12px;"><strong>Headline (Ad-Ready):</strong><br>${this.offer.headline || 'N/A'}</div>
                                    <div style="margin-bottom: 12px;"><strong>1-Sentence Promise:</strong><br>${this.offer.oneSentencePromise || 'N/A'}</div>
                                    <div style="margin-bottom: 12px;"><strong>Scarcity Mechanism:</strong> ${this.offer.scarcityMechanism || 'N/A'}</div>
                                    <div><strong>Risk Reversal:</strong><br>${this.offer.riskReversal || 'N/A'}</div>
                                </div>
                            </section>
                            
                            <!-- 2) THE DEAL -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">2) The Deal (Exact Mechanics)</h2>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; font-size: 13px;">
                                    <div><strong>Regular Price:</strong> $${totals.subtotalBase.toFixed(2)}</div>
                                    <div><strong>Offer Price:</strong> $${totals.customerPrice.toFixed(2)}</div>
                                    <div><strong>Discount Type:</strong> ${discountType}</div>
                                    <div><strong>Discount Amount:</strong> ${this.offer.pricingStrategy === 'percentOff' ? this.offer.percentOff + '%' : this.offer.pricingStrategy === 'dollarOff' ? '$' + this.offer.dollarOff.toFixed(2) : this.offer.pricingStrategy === 'bundlePrice' ? 'Fixed $' + this.offer.bundlePrice.toFixed(2) : 'None'}</div>
                                </div>
                                <div style="margin-bottom: 12px;"><strong>What's Included:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.whatsIncluded || 'N/A'}</div></div>
                                <div style="margin-bottom: 12px;"><strong>What's Not Included / Upcharges:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.whatsNotIncluded || 'N/A'}</div></div>
                                <div style="margin-bottom: 12px;"><strong>Eligibility Rules:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.eligibilityRules || 'N/A'}</div></div>
                                <div><strong>Redemption Rules:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.redemptionRules || 'N/A'}</div></div>
                            </section>
                            
                            <!-- 3) UNIT ECONOMICS -->
                            <section style="margin-bottom: 32px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">3) Unit Economics (Must Be Filled)</h2>
                                <div style="margin-bottom: 16px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Assumptions:</h3>
                                    <div style="font-size: 13px; line-height: 1.8;">
                                        <div><strong>Expected Avg Order Total (AOV):</strong> $${totals.customerPrice.toFixed(2)}</div>
                                        <div><strong>Tech Payout Rate:</strong> 35%</div>
                                        <div><strong>Estimated Materials Cost:</strong> $${totals.equipCostTotal.toFixed(2)}</div>
                                        <div><strong>Payment Processing / Platform Fees:</strong> $${(this.offer.paymentProcessingFees || 0).toFixed(2)}</div>
                                        <div><strong>Travel / Other Variable Cost:</strong> $${(this.offer.travelOtherVariableCost || 0).toFixed(2)}</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 16px; padding: 16px; background: white; border-radius: 8px;">
                                    <h3 style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 8px;">Math:</h3>
                                    <div style="font-size: 13px; line-height: 1.8;">
                                        <div><strong>Revenue (AOV):</strong> $${totals.customerPrice.toFixed(2)}</div>
                                        <div><strong>Tech Payout:</strong> $${totals.techPayoutTotal.toFixed(2)} (35% of customer price: $${totals.customerPrice.toFixed(2)})</div>
                                        <div><strong>Materials:</strong> $${totals.equipCostTotal.toFixed(2)}</div>
                                        <div><strong>Fees:</strong> $${(this.offer.paymentProcessingFees || 0).toFixed(2)}</div>
                                        <div><strong>Gross Profit:</strong> $${totals.profit.toFixed(2)}</div>
                                        <div><strong>Gross Margin %:</strong> ${totals.marginPct.toFixed(1)}%</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;"><strong>Where Can This Break:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.marginBreakPoints || 'N/A'}</div></div>
                                <div><strong>Safeguards to Prevent Margin Bleed:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.safeguards || 'N/A'}</div></div>
                            </section>
                            
                            <!-- 4) VALUE EQUATION -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">4) Value Equation (Why This Will Work)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>Dream Outcome:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.dreamOutcome || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>Likelihood of Achievement (Proof, Process, Guarantees):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.likelihoodOfAchievement || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>Time Delay (How Fast They Get Results):</strong> ${this.offer.timeDelay || 'N/A'}</div>
                                    <div><strong>Effort + Sacrifice (What You Remove, Simplify, Handle for Them):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.effortSacrifice || 'N/A'}</div></div>
                                </div>
                            </section>
                            
                            <!-- 5) COMPETITOR REALITY CHECK -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">5) Competitor Reality Check (Short + Useful)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>Competitor Price Range Found:</strong> ${this.offer.competitorPriceRange || 'N/A'}</div>
                                    <div style="margin-bottom: 12px;"><strong>How We're Different (Not Cheaper, Better):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.howWereDifferent || 'N/A'}</div></div>
                                    <div><strong>Why Someone Chooses Us Even If Not Lowest Price:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.whyChooseUs || 'N/A'}</div></div>
                                </div>
                            </section>
                            
                            <!-- 6) OPS NOTES FOR PROS -->
                            <section style="margin-bottom: 32px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">6) Ops Notes for Pros (Technician-Side)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>What to Say In-Home:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">${(this.offer.whatToSayInHome || []).length > 0 ? (this.offer.whatToSayInHome || []).map(item => `<li>${item}</li>`).join('') : '<li>N/A</li>'}</ul></div>
                                    <div style="margin-bottom: 12px;"><strong>Special Instructions:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.specialInstructions || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>Capacity Assumption:</strong> ${this.offer.capacityAssumption || 'N/A'}</div>
                                    <div><strong>Anything That Could Cause Cancellations or Reschedules:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.cancellationRisks || 'N/A'}</div></div>
                                </div>
                            </section>
                            
                            <!-- 7) MESSAGING PACK -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">7) Messaging Pack (Copy You Can Reuse)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>Booking Page Microcopy (2-4 lines):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.bookingPageMicrocopy || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>SMS Confirmation Copy:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.smsConfirmation || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>SMS Reminder (24h):</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.smsReminder24h || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>If Customer Asks About Price Line:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.priceQuestionLine || 'N/A'}</div></div>
                                    <div><strong>Tech Broadcast Message:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.techBroadcastMessage || 'N/A'}</div></div>
                                </div>
                            </section>
                            
                            <!-- 8) CREATIVE ANGLES -->
                            <section style="margin-bottom: 32px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">8) Creative Angles (So You Can Make Ads Fast)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>5 Hooks:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">${(this.offer.hooks || []).length > 0 ? (this.offer.hooks || []).map(hook => `<li>${hook}</li>`).join('') : '<li>N/A</li>'}</ul></div>
                                    <div style="margin-bottom: 12px;"><strong>3 Primary Objections + Rebuttal Line:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">${(this.offer.objectionsRebuttals || []).length > 0 ? (this.offer.objectionsRebuttals || []).map(obj => `<li>${obj}</li>`).join('') : '<li>N/A</li>'}</ul></div>
                                    <div><strong>3 Proof Ideas:</strong><ul style="margin: 8px 0 0 20px; padding: 0;">${(this.offer.proofIdeas || []).length > 0 ? (this.offer.proofIdeas || []).map(proof => `<li>${proof}</li>`).join('') : '<li>N/A</li>'}</ul></div>
                                </div>
                            </section>
                            
                            <!-- 9) DECISION NOTES -->
                            <section style="margin-bottom: 32px; padding: 20px; background: #f9fafb; border-radius: 12px; border: 2px solid #e5e7eb;">
                                <h2 style="font-size: 20px; font-weight: 700; color: var(--cobalt); margin-bottom: 16px; border-bottom: 2px solid var(--cobalt); padding-bottom: 8px;">9) Decision Notes (For Internal)</h2>
                                <div style="font-size: 13px; line-height: 1.8;">
                                    <div style="margin-bottom: 12px;"><strong>Best-Case Outcome If This Works:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.bestCaseOutcome || 'N/A'}</div></div>
                                    <div style="margin-bottom: 12px;"><strong>Worst-Case Risk If This Fails:</strong><br><div style="white-space: pre-line; color: #374151;">${this.offer.worstCaseRisk || 'N/A'}</div></div>
                                    <div><strong>Confidence Score:</strong> ${this.offer.confidenceScore || 0}/10 - ${this.offer.confidenceWhy || 'N/A'}</div>
                                </div>
                            </section>
                            
                            <!-- Standards Status -->
                            <div style="padding: 16px; background: ${standards.status === 'Up to Standard' ? '#d1fae5' : '#fef3c7'}; border-radius: 8px; border: 2px solid ${standards.status === 'Up to Standard' ? '#a7f3d0' : '#fde68a'}; text-align: center;">
                                <div style="font-size: 14px; font-weight: 700; color: ${standards.status === 'Up to Standard' ? '#065f46' : '#92400e'};">
                                    Standard Status: ${standards.status} (Score: ${standards.score}/100)
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                showModal('Offer Brief Preview', previewHtml, { width: '950px', maxHeight: '90vh', html: true });
            },
            
            async exportPDF() {
                this.collectAllOfferData();
                
                // Initialize missing properties to prevent errors
                if (!this.offer.objections) this.offer.objections = [];
                if (!this.offer.socialProof) this.offer.socialProof = { type: '', detail: '' };
                if (!this.offer.urgency) this.offer.urgency = { type: '', detail: '', rationale: '' };
                if (!this.offer.platformCopy) this.offer.platformCopy = { headline: '', subheadline: '', primaryTextA: '', primaryTextB: '', landingBullets: [], disclaimer: '' };
                if (!this.offer.platformCopy.landingBullets) this.offer.platformCopy.landingBullets = [];
                if (!this.offer.lineItems) this.offer.lineItems = [];
                
                // Validate required fields
                if (!this.offer.name || this.offer.name.trim() === '') {
                    showToast('Offer name is required', 'error');
                    return;
                }
                
                if (!this.offer.lineItems || this.offer.lineItems.length === 0) {
                    showToast('At least one service is required', 'error');
                    return;
                }
                
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                // Block export if hard-fails exist
                if (standards.hardFails.length > 0 || standards.status === 'Incomplete') {
                    showToast('Cannot export: Offer has hard-fail issues. Check Standards panel.', 'error');
                    return;
                }
                
                if (totals.profit < 0) {
                    const confirmed = await showConfirm('Export Unprofitable Offer?', 'This offer is unprofitable. Export PDF anyway?');
                    if (!confirmed) return;
                }
                
                let discountType = 'sum';
                if (this.offer.pricingStrategy === 'percentOff') discountType = '% off';
                else if (this.offer.pricingStrategy === 'dollarOff') discountType = '$ off';
                else if (this.offer.pricingStrategy === 'bundlePrice') discountType = 'bundle price';
                
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    const maxWidth = pageWidth - (margin * 2);
                    let yPos = margin;
                    
                    // Helper to add text with word wrap
                    const addText = (text, fontSize = 12, isBold = false, color = [0, 0, 0]) => {
                        doc.setFontSize(fontSize);
                        doc.setFont(undefined, isBold ? 'bold' : 'normal');
                        doc.setTextColor(color[0], color[1], color[2]);
                        const lines = doc.splitTextToSize(text, maxWidth);
                        lines.forEach(line => {
                            if (yPos > pageHeight - 30) {
                                doc.addPage();
                                yPos = margin;
                            }
                            doc.text(line, margin, yPos);
                            yPos += fontSize * 0.5;
                        });
                        yPos += 5;
                    };
                    
                    // Title
                    addText('HOME2SMART OFFER BRIEF', 18, true, [10, 42, 90]);
                    yPos += 5;
                    addText(this.offer.name || 'Untitled Offer', 16, true, [10, 42, 90]);
                    addText(`Generated: ${new Date().toLocaleDateString()}`, 9, false, [107, 114, 128]);
                    yPos += 12;
                    
                    // 1) OFFER SNAPSHOT
                    addText('1) OFFER SNAPSHOT (Read This First)', 14, true, [10, 42, 90]);
                    addText(`Offer Name: ${this.offer.name || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Category: ${this.offer.category || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Market: ${this.offer.market || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Primary Avatar: ${this.offer.primaryAvatar || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Intended Goal: ${this.offer.intendedGoal || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Offer Dates: ${this.offer.offerStartDate || 'N/A'} to ${this.offer.offerEndDate || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 3;
                    addText(`Headline (Ad-Ready): ${this.offer.headline || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`1-Sentence Promise: ${this.offer.oneSentencePromise || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Scarcity Mechanism: ${this.offer.scarcityMechanism || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Risk Reversal: ${this.offer.riskReversal || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 2) THE DEAL
                    addText('2) THE DEAL (Exact Mechanics)', 14, true, [10, 42, 90]);
                    addText(`Regular Price: $${totals.subtotalBase.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Offer Price: $${totals.customerPrice.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Discount Type: ${discountType}`, 11, false, [0, 0, 0]);
                    const discountAmt = this.offer.pricingStrategy === 'percentOff' ? (this.offer.percentOff || 0) + '%' : 
                                       this.offer.pricingStrategy === 'dollarOff' ? '$' + (this.offer.dollarOff || 0).toFixed(2) : 
                                       this.offer.pricingStrategy === 'bundlePrice' ? 'Fixed $' + (this.offer.bundlePrice || 0).toFixed(2) : 'None';
                    addText(`Discount Amount: ${discountAmt}`, 11, false, [0, 0, 0]);
                    yPos += 3;
                    addText(`What's Included: ${this.offer.whatsIncluded || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`What's Not Included / Upcharges: ${this.offer.whatsNotIncluded || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Eligibility Rules: ${this.offer.eligibilityRules || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Redemption Rules: ${this.offer.redemptionRules || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 5;
                    addText('Services Included:', 11, true, [0, 0, 0]);
                    if (this.offer.lineItems && this.offer.lineItems.length > 0) {
                        this.offer.lineItems.forEach(item => {
                            const equipInfo = item.equipMode === 'BYO' ? ' (Customer provides equipment)' : item.equipMode === 'included' ? ` (Equipment cost: $${(item.equipCostPerUnit || 0).toFixed(2)}/unit)` : ` (Custom equipment: $${(item.equipCostPerUnit || 0).toFixed(2)}/unit)`;
                            addText(`  - ${item.name || 'Unknown'} x ${item.qty || 1} @ $${(item.baseUnitPrice || 0).toFixed(2)} each${equipInfo}${item.notes ? ` - ${item.notes}` : ''}`, 10, false, [0, 0, 0]);
                        });
                    }
                    yPos += 10;
                    
                    // 3) UNIT ECONOMICS
                    addText('3) UNIT ECONOMICS (Must Be Filled)', 14, true, [10, 42, 90]);
                    addText('Assumptions:', 11, true, [0, 0, 0]);
                    addText(`  Expected Avg Order Total (AOV): $${totals.customerPrice.toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Tech Payout Rate: 35%`, 10, false, [0, 0, 0]);
                    addText(`  Estimated Materials Cost: $${totals.equipCostTotal.toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Payment Processing / Platform Fees: $${(this.offer.paymentProcessingFees || 0).toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Travel / Other Variable Cost: $${(this.offer.travelOtherVariableCost || 0).toFixed(2)}`, 10, false, [0, 0, 0]);
                    yPos += 3;
                    addText('Math:', 11, true, [0, 0, 0]);
                    addText(`  Revenue (AOV): $${totals.customerPrice.toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Tech Payout: $${totals.techPayoutTotal.toFixed(2)} (35% of customer price)`, 10, false, [0, 0, 0]);
                    addText(`  Materials: $${totals.equipCostTotal.toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Fees: $${(this.offer.paymentProcessingFees || 0).toFixed(2)}`, 10, false, [0, 0, 0]);
                    addText(`  Gross Profit: $${totals.profit.toFixed(2)}`, 10, false, totals.profit >= 0 ? [0, 0, 0] : [239, 68, 68]);
                    addText(`  Gross Margin %: ${totals.marginPct.toFixed(1)}%`, 10, false, totals.marginPct >= 40 ? [16, 185, 129] : totals.marginPct >= 20 ? [245, 158, 11] : [239, 68, 68]);
                    yPos += 3;
                    addText(`Where Can This Break: ${this.offer.marginBreakPoints || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Safeguards to Prevent Margin Bleed: ${this.offer.safeguards || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 4) VALUE EQUATION
                    addText('4) VALUE EQUATION (Why This Will Work)', 14, true, [10, 42, 90]);
                    addText(`Dream Outcome: ${this.offer.dreamOutcome || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Likelihood of Achievement (Proof, Process, Guarantees): ${this.offer.likelihoodOfAchievement || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Time Delay (How Fast They Get Results): ${this.offer.timeDelay || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Effort + Sacrifice (What You Remove/Simplify): ${this.offer.effortSacrifice || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 5) COMPETITOR REALITY CHECK
                    addText('5) COMPETITOR REALITY CHECK (Short + Useful)', 14, true, [10, 42, 90]);
                    addText(`Competitor Price Range Found: ${this.offer.competitorPriceRange || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`How We're Different (Not Cheaper, Better): ${this.offer.howWereDifferent || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Why Someone Chooses Us Even If Not Lowest Price: ${this.offer.whyChooseUs || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 6) OPS NOTES FOR PROS
                    addText('6) OPS NOTES FOR PROS (Technician-Side)', 14, true, [10, 42, 90]);
                    if (this.offer.whatToSayInHome && Array.isArray(this.offer.whatToSayInHome) && this.offer.whatToSayInHome.length > 0) {
                        addText('What to Say In-Home:', 11, true, [0, 0, 0]);
                        this.offer.whatToSayInHome.forEach(item => {
                            addText(`  - ${item}`, 10, false, [0, 0, 0]);
                        });
                    } else {
                        addText('What to Say In-Home: N/A', 11, false, [0, 0, 0]);
                    }
                    addText(`Special Instructions: ${this.offer.specialInstructions || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Capacity Assumption: ${this.offer.capacityAssumption || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Anything That Could Cause Cancellations or Reschedules: ${this.offer.cancellationRisks || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 7) MESSAGING PACK
                    addText('7) MESSAGING PACK (Copy You Can Reuse)', 14, true, [10, 42, 90]);
                    addText(`Booking Page Microcopy (2-4 lines): ${this.offer.bookingPageMicrocopy || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`SMS Confirmation Copy: ${this.offer.smsConfirmation || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`SMS Reminder (24h): ${this.offer.smsReminder24h || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`If Customer Asks About Price Line: ${this.offer.priceQuestionLine || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Tech Broadcast Message: ${this.offer.techBroadcastMessage || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // 8) CREATIVE ANGLES
                    addText('8) CREATIVE ANGLES (So You Can Make Ads Fast)', 14, true, [10, 42, 90]);
                    if (this.offer.hooks && Array.isArray(this.offer.hooks) && this.offer.hooks.length > 0) {
                        addText('5 Hooks:', 11, true, [0, 0, 0]);
                        this.offer.hooks.forEach(hook => {
                            addText(`  - ${hook}`, 10, false, [0, 0, 0]);
                        });
                    } else {
                        addText('5 Hooks: N/A', 11, false, [0, 0, 0]);
                    }
                    yPos += 2;
                    if (this.offer.objectionsRebuttals && Array.isArray(this.offer.objectionsRebuttals) && this.offer.objectionsRebuttals.length > 0) {
                        addText('3 Primary Objections + Rebuttal Line:', 11, true, [0, 0, 0]);
                        this.offer.objectionsRebuttals.forEach(obj => {
                            addText(`  - ${obj}`, 10, false, [0, 0, 0]);
                        });
                    } else if (this.offer.objections && Array.isArray(this.offer.objections) && this.offer.objections.length > 0) {
                        addText('3 Primary Objections + Rebuttal Line:', 11, true, [0, 0, 0]);
                        this.offer.objections.forEach(obj => {
                            addText(`  - ${obj}`, 10, false, [0, 0, 0]);
                        });
                    } else {
                        addText('3 Primary Objections + Rebuttal Line: N/A', 11, false, [0, 0, 0]);
                    }
                    yPos += 2;
                    if (this.offer.proofIdeas && Array.isArray(this.offer.proofIdeas) && this.offer.proofIdeas.length > 0) {
                        addText('3 Proof Ideas:', 11, true, [0, 0, 0]);
                        this.offer.proofIdeas.forEach(proof => {
                            addText(`  - ${proof}`, 10, false, [0, 0, 0]);
                        });
                    } else {
                        addText('3 Proof Ideas: N/A', 11, false, [0, 0, 0]);
                    }
                    yPos += 10;
                    
                    // 9) DECISION NOTES
                    addText('9) DECISION NOTES (For Internal)', 14, true, [10, 42, 90]);
                    addText(`Best-Case Outcome If This Works: ${this.offer.bestCaseOutcome || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Worst-Case Risk If This Fails: ${this.offer.worstCaseRisk || 'N/A'}`, 11, false, [0, 0, 0]);
                    addText(`Confidence Score: ${this.offer.confidenceScore || 0}/10 - ${this.offer.confidenceWhy || 'N/A'}`, 11, false, [0, 0, 0]);
                    yPos += 10;
                    
                    // PLATFORM COPY (META)
                    addText('PLATFORM COPY (Meta)', 14, true, [10, 42, 90]);
                    if (this.offer.platformCopy) {
                        if (this.offer.platformCopy.headline) addText(`Headline (<=40): ${this.offer.platformCopy.headline}`, 11, false, [0, 0, 0]);
                        if (this.offer.platformCopy.subheadline) addText(`Sub-headline (<=60): ${this.offer.platformCopy.subheadline}`, 11, false, [0, 0, 0]);
                        if (this.offer.platformCopy.primaryTextA) addText(`Primary Text A (<=180): ${this.offer.platformCopy.primaryTextA}`, 11, false, [0, 0, 0]);
                        if (this.offer.platformCopy.primaryTextB) addText(`Primary Text B (<=180): ${this.offer.platformCopy.primaryTextB}`, 11, false, [0, 0, 0]);
                        if (this.offer.platformCopy.landingBullets && Array.isArray(this.offer.platformCopy.landingBullets) && this.offer.platformCopy.landingBullets.length > 0) {
                            addText('Landing Bullets:', 11, true, [0, 0, 0]);
                            this.offer.platformCopy.landingBullets.forEach(b => {
                                addText(`  - ${b}`, 10, false, [0, 0, 0]);
                            });
                        }
                        if (this.offer.platformCopy.disclaimer) {
                            addText(`Disclaimer: ${this.offer.platformCopy.disclaimer}`, 10, false, [107, 114, 128]);
                        }
                    } else {
                        addText('Platform Copy: N/A', 11, false, [0, 0, 0]);
                    }
                    yPos += 10;
                    
                    // ADDITIONAL SECTIONS (Offer Statement, Executive Summary, Value Stack, Social Proof, Urgency, Eligibility)
                    if (this.offer.offerStatement) {
                        addText('CUSTOMER-FACING OFFER STATEMENT', 14, true, [10, 42, 90]);
                        addText(this.offer.offerStatement, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    if (this.offer.executiveSummary) {
                        addText('EXECUTIVE SUMMARY', 14, true, [10, 42, 90]);
                        addText(this.offer.executiveSummary, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    if (this.offer.valueStack) {
                        addText('VALUE STACK', 14, true, [10, 42, 90]);
                        addText(this.offer.valueStack, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    if (this.offer.socialProof && (this.offer.socialProof.type || this.offer.socialProof.detail)) {
                        addText('SOCIAL PROOF', 14, true, [10, 42, 90]);
                        if (this.offer.socialProof.type) addText(`Type: ${this.offer.socialProof.type}`, 11, false, [0, 0, 0]);
                        if (this.offer.socialProof.detail) addText(`Detail: ${this.offer.socialProof.detail}`, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    if (this.offer.urgency && (this.offer.urgency.type || this.offer.urgency.detail)) {
                        addText('URGENCY MECHANICS', 14, true, [10, 42, 90]);
                        if (this.offer.urgency.type) addText(`Type: ${this.offer.urgency.type}`, 11, false, [0, 0, 0]);
                        if (this.offer.urgency.detail) addText(`Detail: ${this.offer.urgency.detail}`, 11, false, [0, 0, 0]);
                        if (this.offer.urgency.rationale) addText(`Rationale: ${this.offer.urgency.rationale}`, 10, false, [107, 114, 128]);
                        yPos += 10;
                    }
                    
                    if (this.offer.eligibility) {
                        addText('ELIGIBILITY / RULES', 14, true, [10, 42, 90]);
                        addText(this.offer.eligibility, 11, false, [0, 0, 0]);
                        yPos += 10;
                    }
                    
                    // ECONOMICS SNAPSHOT (INTERNAL) - Final Summary
                    yPos += 5;
                    addText('ECONOMICS SNAPSHOT (Internal)', 14, true, [10, 42, 90]);
                    addText(`Customer Price: $${totals.customerPrice.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Tech Payout: $${totals.techPayoutTotal.toFixed(2)} (35% of customer price)`, 11, false, [0, 0, 0]);
                    addText(`Equipment Cost: $${totals.equipCostTotal.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Profit: $${totals.profit.toFixed(2)}`, 11, false, totals.profit >= 0 ? [16, 185, 129] : [239, 68, 68]);
                    addText(`Margin: ${totals.marginPct.toFixed(1)}%`, 11, false, totals.marginPct >= 40 ? [16, 185, 129] : totals.marginPct >= 20 ? [245, 158, 11] : [239, 68, 68]);
                    yPos += 5;
                    addText(`Standards Status: ${standards.status} (Score: ${standards.score}/100)`, 10, false, [107, 114, 128]);
                    
                    // Generate filename
                    const date = new Date().toISOString().split('T')[0];
                    const safeName = (this.offer.name || 'Untitled').replace(/[^a-z0-9]/gi, '_').substring(0, 50);
                    const filename = `Offer_Brief_${safeName}_${date}.pdf`;
                    
                    // Save PDF
                    doc.save(filename);
                    showToast('PDF exported successfully!', 'success');
                    closeModal();
            } catch (error) {
                    console.error('PDF export error:', error);
                    showToast('Error exporting PDF: ' + error.message, 'error');
                }
            },
            
            async submitToDeliverables() {
                // Get button elements for loading state
                const submitBtn = document.getElementById('submitDeliverablesBtn');
                const submitText = document.getElementById('submitDeliverablesText');
                const submitSpinner = document.getElementById('submitDeliverablesSpinner');
                
                // Set loading state immediately
                const setLoadingState = (loading) => {
                    if (submitBtn) {
                        submitBtn.disabled = loading;
                        submitBtn.style.cursor = loading ? 'not-allowed' : 'pointer';
                        submitBtn.style.opacity = loading ? '0.7' : '1';
                    }
                    if (submitText) {
                        submitText.textContent = loading ? 'Submitting...' : 'Submit to Deliverables';
                    }
                    if (submitSpinner) {
                        submitSpinner.style.display = loading ? 'block' : 'none';
                    }
                };
                
                // Start loading state immediately
                setLoadingState(true);
                
                this.collectAllOfferData();
                
                // Initialize missing properties to prevent errors
                if (!this.offer.objections) this.offer.objections = [];
                if (!this.offer.socialProof) this.offer.socialProof = { type: '', detail: '' };
                if (!this.offer.urgency) this.offer.urgency = { type: '', detail: '', rationale: '' };
                if (!this.offer.platformCopy) this.offer.platformCopy = { headline: '', subheadline: '', primaryTextA: '', primaryTextB: '', landingBullets: [], disclaimer: '' };
                if (!this.offer.platformCopy.landingBullets) this.offer.platformCopy.landingBullets = [];
                if (!this.offer.lineItems) this.offer.lineItems = [];
                
                const totals = this.calculateTotals();
                const standards = this.evaluateStandards(totals);
                
                // Validate required fields
                if (!this.offer.name || this.offer.name.trim() === '') {
                    setLoadingState(false);
                    showToast('Offer name is required', 'error');
                    return;
                }
                
                if (!this.offer.lineItems || this.offer.lineItems.length === 0) {
                    setLoadingState(false);
                    showToast('At least one service is required', 'error');
                    return;
                }
                
                // Generate PDF first
                let pdfDataUrl = null;
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const margin = 20;
                    const maxWidth = pageWidth - (margin * 2);
                    let yPos = margin;
                    
                    const addText = (text, fontSize = 12, isBold = false, color = [0, 0, 0]) => {
                        doc.setFontSize(fontSize);
                        doc.setFont(undefined, isBold ? 'bold' : 'normal');
                        doc.setTextColor(color[0], color[1], color[2]);
                        const lines = doc.splitTextToSize(text, maxWidth);
                        lines.forEach(line => {
                            if (yPos > pageHeight - 30) {
                                doc.addPage();
                                yPos = margin;
                            }
                            doc.text(line, margin, yPos);
                            yPos += fontSize * 0.5;
                        });
                        yPos += 5;
                    };
                    
                    addText(this.offer.name || 'Untitled Offer', 20, true, [10, 42, 90]);
                    yPos += 10;
                    addText(`Offer Brief - ${new Date().toLocaleDateString()}`, 12, false, [107, 114, 128]);
                    yPos += 10;
                    addText(`Status: ${standards.status} (Score: ${standards.score}/100)`, 11, false, [107, 114, 128]);
                    yPos += 10;
                    addText(`Customer Price: $${totals.customerPrice.toFixed(2)}`, 11, false, [0, 0, 0]);
                    addText(`Tech Payout: $${totals.techPayoutTotal.toFixed(2)} (35% of customer price)`, 11, false, [0, 0, 0]);
                    addText(`Profit: $${totals.profit.toFixed(2)} | Margin: ${totals.marginPct.toFixed(1)}%`, 11, false, totals.profit >= 0 ? [0, 0, 0] : [239, 68, 68]);
                    yPos += 10;
                    
                    // Add key offer details
                    if (this.offer.headline) {
                        addText('Headline:', 14, true, [10, 42, 90]);
                        addText(this.offer.headline, 11, false, [0, 0, 0]);
                    }
                    if (this.offer.oneSentencePromise) {
                        addText('Promise:', 14, true, [10, 42, 90]);
                        addText(this.offer.oneSentencePromise, 11, false, [0, 0, 0]);
                    }
                    if (this.offer.lineItems && this.offer.lineItems.length > 0) {
                        addText('Services:', 14, true, [10, 42, 90]);
                        this.offer.lineItems.forEach(item => {
                            addText(`${item.name || 'Unknown'} x ${item.qty || 1} @ $${(item.baseUnitPrice || 0).toFixed(2)}`, 11, false, [0, 0, 0]);
                        });
                    }
                    
                    pdfDataUrl = doc.output('dataurlstring');
                } catch (error) {
                    console.error('PDF generation error:', error);
                    setLoadingState(false);
                    showToast('Error generating PDF for submission', 'error');
                    return;
                }
                
                // Prepare description
                const description = `
Offer: ${this.offer.name}
Category: ${this.offer.category || 'Not set'}
Market: ${this.offer.market || 'Not set'}

Services: ${(this.offer.lineItems || []).map(item => `${item.name || 'Unknown'} x ${item.qty || 1}`).join(', ')}
Customer Price: $${totals.customerPrice.toFixed(2)}
Tech Payout: $${totals.techPayoutTotal.toFixed(2)} (35% of customer price)
Profit: $${totals.profit.toFixed(2)}
Margin: ${totals.marginPct.toFixed(1)}%

Standards Status: ${standards.status} (Score: ${standards.score}/100)
${standards.hardFails && standards.hardFails.length > 0 ? `Issues: ${standards.hardFails.map(f => f.message || f).join('; ')}` : ''}

${this.offer.headline ? `Headline: ${this.offer.headline}` : ''}
${this.offer.oneSentencePromise ? `Promise: ${this.offer.oneSentencePromise}` : ''}
                `.trim();
                
                // Submit to deliverables
                try {
                    const response = await fetch(`${API_URL}?action=submitDeliverable`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: `Offer Brief: ${this.offer.name}`,
                            description: description,
                            fileLink: pdfDataUrl,
                            submittedBy: currentUser || 'USER',
                            metadata: {
                                type: 'offer_brief',
                                offerId: this.offer.name,
                                isSample: this.offer.isSample || false,
                                standards: {
                                    status: standards.status,
                                    score: standards.score
                                },
                                totals: {
                                    customerPrice: totals.customerPrice,
                                    techPayout: totals.techPayoutTotal,
                                    profit: totals.profit,
                                    margin: totals.marginPct
                                }
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.ok && data.result) {
                        // Update button to show success state briefly
                        if (submitText) submitText.textContent = 'Submitted!';
                        if (submitSpinner) submitSpinner.style.display = 'none';
                        
                        showToast('Offer brief submitted to Deliverables!', 'success');
                        
                        // Close modal and navigate after a brief delay
                        setTimeout(() => {
                            closeModal();
                            
                            // Smoothly navigate to deliverables tab (intelligent routing)
                            setTimeout(() => {
                                // Switch to review view to show the new submission
                                if (typeof switchDeliverablesView === 'function') {
                                    switchDeliverablesView('review');
                                }
                                
                                switchToTab('deliverables', { skipPersistence: false, smooth: true });
                                
                                // Highlight the new submission after a brief delay
                                setTimeout(() => {
                                    const deliverablesContainer = document.getElementById('deliverablesContainer');
                                    const reviewContainer = document.getElementById('deliverablesReviewContainer');
                                    
                                    // Refresh deliverables to show new submission
                                    if (typeof loadDeliverablesReview === 'function') {
                                        loadDeliverablesReview();
                                    }
                                    if (typeof loadDeliverablesLibrary === 'function') {
                                        loadDeliverablesLibrary();
                                    }
                                    
                                    // Scroll to review container to show new submission
                                    if (reviewContainer) {
                                        setTimeout(() => {
                                            reviewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                        }, 400);
                                    } else if (deliverablesContainer) {
                                        deliverablesContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                    }
                                }, 400);
                            }, 200);
                        }, 300);
                    } else {
                        setLoadingState(false);
                        showToast('Error submitting: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Submit deliverable error:', error);
                    setLoadingState(false);
                    showToast('Error submitting to deliverables: ' + error.message, 'error');
                }
            },
            
            async loadPerformanceData() {
                const summaryDiv = document.getElementById('offerBuilderPerformanceSummary');
                const loadingDiv = document.getElementById('offerBuilderPerformanceLoading');
                const emptyDiv = document.getElementById('offerBuilderPerformanceEmpty');
                const container = document.getElementById('offerBuilderPerformanceFeedback');
                
                if (!summaryDiv || !loadingDiv || !emptyDiv || !container) return;
                
                const offerName = this.offer.name || null;
                
                // Show loading state
                summaryDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                
                try {
                    // Use meta_pixel_events endpoint from current backend (has CORS configured)
                    // This endpoint queries the same h2s_tracking_events table structure
                    const response = await fetch(`${API_URL}?action=meta_pixel_events`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to load: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    // meta_pixel_events returns { ok: true, meta_pixel_events: {...} } or just the data directly
                    const pixelData = result.meta_pixel_events || result;
                    
                    // Log for debugging
                    console.log('Meta Pixel data loaded:', pixelData);
                    if (pixelData.summary) {
                        console.log('Total events:', pixelData.summary.total_events);
                        console.log('Unique users:', pixelData.summary.unique_users);
                        console.log('Event types:', pixelData.summary.by_event_type);
                    }
                    
                    // Hide loading
                    loadingDiv.style.display = 'none';
                    
                    const summary = pixelData.summary || {};
                    const totalEvents = summary.total_events || 0;
                    const uniqueUsers = summary.unique_users || 0;
                    
                    if (!summary || totalEvents === 0) {
                        // Show empty state
                        emptyDiv.style.display = 'block';
                        return;
                    }
                    
                    // Hide empty state
                    emptyDiv.style.display = 'none';
                    
                    // Extract metrics from meta_pixel_events format
                    // Calculate page views (page_view + view_content events)
                    // Backend now normalizes to lowercase, so check both formats for backward compatibility
                    const eventTypes = summary.by_event_type || {};
                    const pageViews = (eventTypes.page_view?.count || eventTypes.pageview?.count || 0) + 
                                    (eventTypes.view_content?.count || eventTypes.viewcontent?.count || 0);
                    const leads = (eventTypes.lead?.count || 0) + 
                                (eventTypes.complete_registration?.count || 0);
                    const orders = (eventTypes.purchase?.count || 0);
                    // REMOVED: totalRevenue and avgOrderValue - user explicitly said NO revenue
                    const uniqueSessions = summary.unique_sessions || 0;
                    
                    // Get page type performance if available
                    const pageTypeData = pixelData.by_page_type || {};
                    const pageTypeEntries = Object.entries(pageTypeData).slice(0, 5);
                    
                    // Calculate engagement rate (soft indicator)
                    const engagementRate = uniqueUsers > 0 ? Math.round((leads / uniqueUsers) * 100) : 0;
                    // Calculate conversion rate (leads to purchases)
                    const conversionRate = leads > 0 ? Math.round((orders / leads) * 100) : 0;
                    
                    // Format latest event timestamp
                    let latestEventTime = '';
                    if (summary.latest_event_at) {
                        const eventDate = new Date(summary.latest_event_at);
                        const now = new Date();
                        const diffMs = now - eventDate;
                        const diffMins = Math.floor(diffMs / 60000);
                        const diffHours = Math.floor(diffMs / 3600000);
                        const diffDays = Math.floor(diffMs / 86400000);
                        
                        if (diffMins < 1) {
                            latestEventTime = 'Just now';
                        } else if (diffMins < 60) {
                            latestEventTime = `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
                        } else if (diffHours < 24) {
                            latestEventTime = `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
                        } else if (diffDays < 7) {
                            latestEventTime = `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
                        } else {
                            latestEventTime = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
                        }
                    }
                    
                    summaryDiv.style.display = 'block';
                    summaryDiv.innerHTML = `
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h4 style="font-size: 14px; font-weight: 600; color: #6b7280; margin: 0;">Activity Overview</h4>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    ${latestEventTime ? `<span style="font-size: 11px; color: #059669; background: #d1fae5; padding: 4px 10px; border-radius: 10px; font-weight: 600;">${latestEventTime}</span>` : ''}
                                    ${offerName ? `<span style="font-size: 11px; color: #9ca3af; background: #f3f4f6; padding: 3px 10px; border-radius: 10px;">${offerName}</span>` : ''}
                                </div>
                            </div>
                            
                            <!-- Metrics Cards - EXACT MATCH to funnel-track.html Meta Pixel section (NO REVENUE) -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px;">
                                <div style="background: #fafbfc; padding: 14px; border-radius: 8px; border: 1px solid #e8eaed;">
                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 500;">Total Events</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #1493ff;">${(summary.total_events || 0).toLocaleString()}</div>
                                    <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">${uniqueSessions.toLocaleString()} sessions tracked</div>
                                </div>
                                
                                <div style="background: #fafbfc; padding: 14px; border-radius: 8px; border: 1px solid #e8eaed;">
                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 500;">Unique Users</div>
                                    <div style="font-size: 20px; font-weight: 600; color: var(--cobalt);">${uniqueUsers.toLocaleString()}</div>
                                </div>
                                
                                <div style="background: #fafbfc; padding: 14px; border-radius: 8px; border: 1px solid #e8eaed;">
                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 500;">Top Content</div>
                                    ${(() => {
                                        let topEvent = 'No data';
                                        let topCount = 0;
                                        if (eventTypes && Object.keys(eventTypes).length > 0) {
                                            Object.entries(eventTypes).forEach(([name, data]) => {
                                                const count = typeof data === 'object' ? (data.count || 0) : (data || 0);
                                                if (count > topCount) {
                                                    topCount = count;
                                                    topEvent = name;
                                                }
                                            });
                                        }
                                        return `<div style="font-size: 20px; font-weight: 600; color: #6366f1;">${topEvent}</div><div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">${topCount.toLocaleString()} events</div>`;
                                    })()}
                                </div>
                                
                                <div style="background: #fafbfc; padding: 14px; border-radius: 8px; border: 1px solid #e8eaed;">
                                    <div style="font-size: 11px; color: #9ca3af; margin-bottom: 6px; font-weight: 500;">Conversions</div>
                                    <div style="font-size: 20px; font-weight: 600; color: #FBBC04;">${orders.toLocaleString()}</div>
                                    <div style="font-size: 10px; color: #9ca3af; margin-top: 4px;">${orders === 1 ? 'conversion' : 'conversions'}</div>
                                </div>
                            </div>
                            
                            ${pageTypeEntries.length > 0 ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e8eaed;">
                                <h5 style="font-size: 13px; font-weight: 600; color: #6b7280; margin: 0 0 12px 0;">Page Type Performance</h5>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${pageTypeEntries.map(([type, count]) => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f9fafb; border-radius: 6px;">
                                            <span style="font-size: 12px; color: #374151; font-weight: 500;">${type}</span>
                                            <span style="font-size: 12px; color: var(--cobalt); font-weight: 600;">${count.toLocaleString()} events</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ` : ''}
                            
                            
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Error loading performance data:', error);
                    loadingDiv.style.display = 'none';
                    emptyDiv.style.display = 'block';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 32px; margin-bottom: 8px;">!</div>
                        <p style="font-size: 14px; font-weight: 600; color: #374151; margin: 0 0 8px 0;">Unable to load data</p>
                        <p style="font-size: 12px; color: #6b7280; margin: 0;">There was an error connecting to the tracking system. Please try again later.</p>
                    `;
                }
            },
            
            async loadInsights() {
                const contentDiv = document.getElementById('offerBuilderInsightsContent');
                const loadingDiv = document.getElementById('offerBuilderInsightsLoading');
                const emptyDiv = document.getElementById('offerBuilderInsightsEmpty');
                const container = document.getElementById('offerBuilderInsights');
                
                if (!contentDiv || !loadingDiv || !emptyDiv || !container) return;
                
                // Show loading
                contentDiv.style.display = 'none';
                emptyDiv.style.display = 'none';
                loadingDiv.style.display = 'block';
                
                try {
                    // Get overall performance data to analyze service performance
                    const response = await fetch(`${API_URL}?action=offer_performance&days=90`);
                    if (!response.ok) throw new Error(`Failed to load: ${response.status}`);
                    
                    const result = await response.json();
                    const allData = result.offer_performance || result;
                    
                    // Also get meta_pixel_events to analyze service performance by page type/campaign
                    const pixelResponse = await fetch(`${API_URL}?action=meta_pixel_events`);
                    const pixelResult = await pixelResponse.ok ? await pixelResponse.json() : null;
                    const pixelData = pixelResult?.meta_pixel_events || pixelResult;
                    
                    loadingDiv.style.display = 'none';
                    
                    // Analyze which services/categories are performing well
                    const insights = this.analyzeServicePerformance(allData, pixelData);
                    
                    if (insights.hasData) {
                        emptyDiv.style.display = 'none';
                        contentDiv.style.display = 'block';
                        contentDiv.innerHTML = this.renderInsights(insights);
                    } else {
                        contentDiv.style.display = 'none';
                        emptyDiv.style.display = 'block';
                    }
                    
                } catch (error) {
                    console.error('Error loading insights:', error);
                    loadingDiv.style.display = 'none';
                    contentDiv.style.display = 'none';
                    emptyDiv.style.display = 'block';
                }
            },
            
            analyzeServicePerformance(performanceData, pixelData) {
                // Extract service performance from page types and campaign names
                const servicePerformance = {};
                const categoryPerformance = {};
                
                // Analyze pixel data for page performance by type
                if (pixelData?.page_performance) {
                    pixelData.page_performance.forEach((page) => {
                        const path = page.path?.toLowerCase() || '';
                        // Map page paths to services
                        if (path.includes('tv') || path.includes('mount')) {
                            categoryPerformance['TV Mounting'] = (categoryPerformance['TV Mounting'] || 0) + (page.score || 0);
                        } else if (path.includes('security') || path.includes('camera')) {
                            categoryPerformance['Security'] = (categoryPerformance['Security'] || 0) + (page.score || 0);
                        } else if (path.includes('smart') || path.includes('automation')) {
                            categoryPerformance['Smart Home'] = (categoryPerformance['Smart Home'] || 0) + (page.score || 0);
                        } else if (path.includes('wifi') || path.includes('network')) {
                            categoryPerformance['WiFi'] = (categoryPerformance['WiFi'] || 0) + (page.score || 0);
                        }
                    });
                }
                
                // Analyze conversion rates by campaign/offer name patterns
                let avgConversionRate = 0;
                let topPerformingCategories = [];
                
                if (performanceData?.conversion_rates?.visitor_to_purchase) {
                    avgConversionRate = parseFloat(performanceData.conversion_rates.visitor_to_purchase) || 0;
                }
                
                // Get top categories by performance score
                const sortedCategories = Object.entries(categoryPerformance)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([cat]) => cat);
                
                return {
                    hasData: sortedCategories.length > 0 || avgConversionRate > 0,
                    topCategories: sortedCategories,
                    avgConversionRate: avgConversionRate,
                    categoryPerformance: categoryPerformance
                };
            },
            
            renderInsights(insights) {
                const currentCategory = this.offer.category || '';
                const currentServices = this.offer.lineItems.map(item => item.name);
                const totals = this.calculateTotals(); // Calculate once at the start
                
                let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';
                
                // Service Performance Section
                if (insights.topCategories && insights.topCategories.length > 0) {
                    html += `
                        <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 16px; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: #0c4a6e; margin-bottom: 12px;">Top Performing Service Categories</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${insights.topCategories.map((cat, idx) => `
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px; font-weight: 700; color: #0ea5e9; min-width: 24px;">${idx + 1}</span>
                                        <span style="font-size: 13px; color: #0c4a6e; font-weight: 600;">${cat}</span>
                                        ${currentCategory === cat ? '<span style="font-size: 11px; background: #22c55e; color: white; padding: 2px 8px; border-radius: 12px; margin-left: auto;">Your category</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                            <div style="font-size: 12px; color: #075985; margin-top: 12px; padding-top: 12px; border-top: 1px solid #bae6fd;">
                                <strong>Note:</strong> Performance is based on campaign tracking. Make sure your ad set names (utm_campaign) match your offer names to track properly.
                            </div>
                        </div>
                    `;
                }
                
                // Conversion Rate Benchmark
                if (insights.avgConversionRate > 0) {
                    const marginColor = totals.marginPct >= 30 ? '#22c55e' : totals.marginPct >= 20 ? '#eab308' : '#ef4444';
                    
                    html += `
                        <div style="background: #f9fafb; border: 1px solid #e5e7eb; padding: 16px; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: var(--cobalt); margin-bottom: 12px;">Performance Benchmarks</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Avg Conversion Rate</div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--cobalt);">${insights.avgConversionRate.toFixed(1)}%</div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Your Current Margin</div>
                                    <div style="font-size: 20px; font-weight: 700; color: ${marginColor};">${totals.marginPct.toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Pricing Guidance
                if (currentServices.length > 0) {
                    html += `
                        <div style="background: #fff7ed; border-left: 4px solid #f59e0b; padding: 16px; border-radius: 8px;">
                            <div style="font-size: 14px; font-weight: 700; color: #92400e; margin-bottom: 8px;">Pricing Tip</div>
                            <div style="font-size: 13px; color: #78350f; line-height: 1.6;">
                                ${totals.marginPct < 30 ? 
                                    'Your margin is below the 30% target. Consider adjusting pricing or reducing equipment costs to improve profitability.' :
                                    totals.marginPct < 20 ?
                                    'Margin is getting low. Monitor closely to ensure profitability.' :
                                    'Great margin! This offer should be profitable.'
                                }
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                return html;
            },
            
            // Load offer-specific performance metrics
            async loadOfferPerformanceData() {
                if (!this.offer.name) return;
                
                try {
                    const response = await fetch(`${API_URL}?action=offer_performance&offerName=${encodeURIComponent(this.offer.name)}&days=30&debug=true`);
                    
                    if (!response.ok) {
                        console.warn('Offer performance endpoint not available yet');
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (result.ok && result.offer_performance) {
                        const perf = result.offer_performance;
                        console.log('Offer Performance:', perf);
                        
                        // Track that we loaded performance data
                        await trackEvent('offer_performance_viewed', {
                            offer_name: this.offer.name,
                            has_data: perf.has_data || false,
                            total_events: perf.summary?.total_events || 0,
                            total_revenue: perf.summary?.total_revenue || 0
                        });
                        
                        // You can display this data in the Performance Feedback section
                        // or store it for later use
                        this.offerPerformance = perf;
                    }
                } catch (error) {
                    console.log('Offer performance tracking not yet available:', error.message);
                }
            }
        };


        // Initialize features when tabs become active
        function initFeatureIfNeeded(tabName) {
            if (tabName === 'admin') {
                const pane = document.getElementById('admin-pane');
                if (pane && pane.classList.contains('active') && !pane.dataset.initialized) {
                    adminDashboard.refresh();
                    pane.dataset.initialized = 'true';
                }
            } else if (tabName === 'offerbuilder') {
                const pane = document.getElementById('offerbuilder-pane');
                if (pane && pane.classList.contains('active') && !pane.dataset.initialized) {
                    offerBuilder.init();
                    pane.dataset.initialized = 'true';
                }
            } else if (tabName === 'proofpacks') {
                const pane = document.getElementById('proofpacks-pane');
                if (pane && pane.classList.contains('active') && !pane.dataset.initialized) {
                    proofPacks.init();
                    pane.dataset.initialized = 'true';
                }
            }
        }

        // Hook into switchToTab
        const originalSwitchToTab = window.switchToTab;
        if (typeof originalSwitchToTab === 'function') {
            window.switchToTab = function(tab) {
                originalSwitchToTab(tab);
                setTimeout(() => initFeatureIfNeeded(tab), 150);
            };
        }

        // ===== LAYOUT AUDIT HELPER (Dev Tool) =====
        // Run: layoutAudit() in console to diagnose layout issues
        window.layoutAudit = function() {
            const report = {
                timestamp: new Date().toISOString(),
                viewport: {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    scrollY: window.scrollY,
                    scrollX: window.scrollX
                },
                scrollContainers: [],
                accordionElements: [],
                fixedHeights: [],
                absolutePositioned: [],
                stickyElements: []
            };

            // Find active scroll containers
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                const overflowY = style.overflowY;
                const overflowX = style.overflowX;
                
                if ((overflowY === 'auto' || overflowY === 'scroll') && el.scrollHeight > el.clientHeight) {
                    report.scrollContainers.push({
                        id: el.id || 'no-id',
                        className: el.className || 'no-class',
                        tag: el.tagName,
                        scrollHeight: el.scrollHeight,
                        clientHeight: el.clientHeight,
                        scrollTop: el.scrollTop,
                        overflowY: overflowY,
                        overflowX: overflowX
                    });
                }
            });

            // Find accordion sections in Offer Builder
            const offerBuilderPane = document.getElementById('offerbuilder-pane');
            if (offerBuilderPane) {
                const accordionSections = [
                    'offerMessagingSection',
                    'offerBuilderInsights',
                    'offerBuilderPerformanceFeedback'
                ];
                
                accordionSections.forEach(sectionId => {
                    const section = document.getElementById(sectionId);
                    if (section) {
                        const style = window.getComputedStyle(section);
                        const parent = section.parentElement;
                        const parentStyle = parent ? window.getComputedStyle(parent) : null;
                        
                        report.accordionElements.push({
                            id: sectionId,
                            display: style.display,
                            position: style.position,
                            height: section.offsetHeight,
                            scrollHeight: section.scrollHeight,
                            isVisible: style.display !== 'none',
                            parent: {
                                id: parent?.id || 'no-id',
                                position: parentStyle?.position || 'unknown',
                                overflow: parentStyle?.overflow || 'unknown',
                                maxHeight: parentStyle?.maxHeight || 'none'
                            },
                            hasAbsoluteChildren: Array.from(section.querySelectorAll('*')).some(child => {
                                return window.getComputedStyle(child).position === 'absolute';
                            })
                        });
                    }
                });
            }

            // Find elements with fixed heights that might prevent reflow
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                const height = style.height;
                const maxHeight = style.maxHeight;
                
                if (height && height !== 'auto' && !height.includes('%')) {
                    const heightNum = parseFloat(height);
                    if (heightNum > 0 && heightNum < 10000) { // Reasonable range
                        report.fixedHeights.push({
                            id: el.id || 'no-id',
                            className: el.className || 'no-class',
                            tag: el.tagName,
                            height: height,
                            actualHeight: el.offsetHeight,
                            scrollHeight: el.scrollHeight
                        });
                    }
                }
                
                if (maxHeight && maxHeight !== 'none' && !maxHeight.includes('%')) {
                    const maxHeightNum = parseFloat(maxHeight);
                    if (maxHeightNum > 0 && maxHeightNum < 10000) {
                        report.fixedHeights.push({
                            id: el.id || 'no-id',
                            className: el.className || 'no-class',
                            tag: el.tagName,
                            maxHeight: maxHeight,
                            actualHeight: el.offsetHeight,
                            scrollHeight: el.scrollHeight,
                            isClipped: el.scrollHeight > el.offsetHeight
                        });
                    }
                }
            });

            // Find absolutely positioned elements inside accordion content
            if (offerBuilderPane) {
                const accordionContent = offerBuilderPane.querySelectorAll('[id*="Section"], [id*="Insights"], [id*="Performance"]');
                accordionContent.forEach(el => {
                    const style = window.getComputedStyle(el);
                    if (style.position === 'absolute' || style.position === 'fixed') {
                        report.absolutePositioned.push({
                            id: el.id || 'no-id',
                            position: style.position,
                            top: style.top,
                            left: style.left,
                            zIndex: style.zIndex
                        });
                    }
                });
            }

            // Find sticky elements
            allElements.forEach(el => {
                const style = window.getComputedStyle(el);
                if (style.position === 'sticky') {
                    report.stickyElements.push({
                        id: el.id || 'no-id',
                        className: el.className || 'no-class',
                        tag: el.tagName,
                        top: style.top,
                        bottom: style.bottom,
                        zIndex: style.zIndex
                    });
                }
            });

            // Print report
            console.group('Layout Audit Report');
            console.log('Viewport:', report.viewport);
            console.log('Active Scroll Containers:', report.scrollContainers);
            console.log('Accordion Elements:', report.accordionElements);
            console.log('Fixed/Max Heights:', report.fixedHeights);
            console.log('Absolute Positioned (in accordions):', report.absolutePositioned);
            console.log('Sticky Elements:', report.stickyElements);
            console.groupEnd();
            
            return report;
        };
        
        /* ============================================
           EDIT HISTORY SYSTEM (Undo/Redo)
           ============================================ */
        class EditHistory {
            constructor(proofPacksRef) {
                this.proofPacks = proofPacksRef;
                this.history = [];
                this.currentIndex = -1;
                this.maxHistory = 50;
            }
            
            push(state) {
                // Remove any states after current index (branching timeline)
                this.history = this.history.slice(0, this.currentIndex + 1);
                
                // Add new state
                this.history.push(JSON.parse(JSON.stringify(state)));
                this.currentIndex++;
                
                // Keep history size under limit
                if (this.history.length > this.maxHistory) {
                    this.history.shift();
                    this.currentIndex--;
                }
                
                this.updateUI();
            }
            
            undo() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.restoreState(this.history[this.currentIndex]);
                    this.updateUI();
                    showToast(`Undone: ${this.history[this.currentIndex].description || 'Edit'}`, 'info');
                } else {
                    showToast('Nothing to undo', 'info');
                }
            }
            
            redo() {
                if (this.currentIndex < this.history.length - 1) {
                    this.currentIndex++;
                    this.restoreState(this.history[this.currentIndex]);
                    this.updateUI();
                    showToast(`Redone: ${this.history[this.currentIndex].description || 'Edit'}`, 'info');
                } else {
                    showToast('Nothing to redo', 'info');
                }
            }
            
            restoreState(state) {
                if (!state) return;
                
                // Restore rotation
                if (typeof state.rotateDeg === 'number') {
                    const rotateField = document.getElementById('ppRotateDeg');
                    if (rotateField) rotateField.value = state.rotateDeg;
                }
                
                // Restore trim
                if (typeof state.trimStartSec === 'number') {
                    const trimStartField = document.getElementById('ppTrimStartSec');
                    if (trimStartField) trimStartField.value = state.trimStartSec;
                }
                if (typeof state.trimEndSec === 'number') {
                    const trimEndField = document.getElementById('ppTrimEndSec');
                    if (trimEndField) trimEndField.value = state.trimEndSec;
                }
                
                // Restore filters
                if (typeof state.filterBw === 'boolean') {
                    const bwCheckbox = document.getElementById('ppFilterGrayscale');
                    if (bwCheckbox) bwCheckbox.checked = state.filterBw;
                }
                
                if (state.filterBrightness) {
                    const el = document.getElementById('ppBrightness');
                    if (el) el.value = state.filterBrightness;
                }
                if (state.filterContrast) {
                    const el = document.getElementById('ppContrast');
                    if (el) el.value = state.filterContrast;
                }
                if (state.filterSaturation) {
                    const el = document.getElementById('ppSaturation');
                    if (el) el.value = state.filterSaturation;
                }
                
                // Refresh preview if video player exists
                if (typeof this.proofPacks.applyLocalPreviewRotation === 'function') {
                    this.proofPacks.applyLocalPreviewRotation();
                    // Also update label values
                    if (typeof this.proofPacks.updateControlValues === 'function') {
                        this.proofPacks.updateControlValues();
                    }
                } else if (typeof this.proofPacks.refreshVideoPreview === 'function') {
                    this.proofPacks.applyLocalPreviewRotation();
                } else if (typeof this.proofPacks.refreshVideoPreview === 'function') {
                    this.proofPacks.refreshVideoPreview();
                }
            }
            
            updateUI() {
                const undoBtn = document.getElementById('ppUndoBtn');
                const redoBtn = document.getElementById('ppRedoBtn');
                
                if (undoBtn) {
                    undoBtn.disabled = this.currentIndex <= 0;
                    undoBtn.style.opacity = this.currentIndex <= 0 ? '0.5' : '1';
                }
                
                if (redoBtn) {
                    redoBtn.disabled = this.currentIndex >= this.history.length - 1;
                    redoBtn.style.opacity = this.currentIndex >= this.history.length - 1 ? '0.5' : '1';
                }
            }
        }
        
        /* ============================================
           KEYBOARD SHORTCUTS
           ============================================ */
        document.addEventListener('keydown', (e) => {
            // Only activate shortcuts when Proof Packs editor is open
            const editorCard = document.getElementById('ppLibraryEditor');
            const isEditorOpen = editorCard && !editorCard.classList.contains('is-hidden');
            
            if (!isEditorOpen) return;
            
            const videoEl = document.getElementById('ppVideoPreview');
            
            // GAP 8 FIX: Check if element is video or image
            const isVideo = videoEl && videoEl.tagName === 'VIDEO';
            const isImage = videoEl && videoEl.tagName === 'IMG';
            const isMediaElement = isVideo || isImage;
            
            // Space: Play/Pause (video only)
            if (e.code === 'Space' && !e.target.matches('input, textarea')) {
                if (isVideo) {
                    e.preventDefault();
                    if (videoEl.paused) {
                        videoEl.play().catch(err => console.warn('Play failed:', err));
                        showToast('Playing', 'info');
                    } else {
                        videoEl.pause();
                        showToast('Paused', 'info');
                    }
                }
            }
            
            // Arrow Left: Seek -5s (video only)
            if (e.code === 'ArrowLeft' && !e.target.matches('input, textarea')) {
                if (isVideo) {
                    e.preventDefault();
                    videoEl.currentTime = Math.max(0, videoEl.currentTime - 5);
                    showToast('Seek -5s', 'info');
                }
            }
            
            // Arrow Right: Seek +5s (video only)
            if (e.code === 'ArrowRight' && !e.target.matches('input, textarea')) {
                if (isVideo) {
                    e.preventDefault();
                    videoEl.currentTime = Math.min(videoEl.duration || 0, videoEl.currentTime + 5);
                    showToast('Seek +5s', 'info');
                }
            }
            
            // R: Rotate 90 deg (works for both video and image)
            if (e.code === 'KeyR' && !e.target.matches('input, textarea')) {
                if (isMediaElement) {
                    e.preventDefault();
                    const rotateField = document.getElementById('ppVideoRotate');
                    if (rotateField) {
                        const currentRotate = parseInt(rotateField.value) || 0;
                        const newRotate = (currentRotate + 90) % 360;
                        rotateField.value = newRotate;
                        if (typeof proofPacks.applyLocalPreviewRotation === 'function') {
                            proofPacks.applyLocalPreviewRotation();
                            
                            // Also update the display value
                            const valEl = document.getElementById('ppRotationValue');
                            if (valEl) valEl.textContent = `${newRotate} deg`;
                        } else if (typeof proofPacks.refreshVideoPreview === 'function') {
                            proofPacks.refreshVideoPreview();
                        }
                        showToast(`Rotated to ${newRotate} deg`, 'info');
                    }
                }
            }
            
            // G: Toggle grayscale (works for both video and image)
            if (e.code === 'KeyG' && !e.target.matches('input, textarea')) {
                if (isMediaElement) {
                    e.preventDefault();
                    const bwCheckbox = document.getElementById('ppFilterGrayscale');
                    if (bwCheckbox) {
                        bwCheckbox.checked = !bwCheckbox.checked;
                        if (typeof proofPacks.applyLocalPreviewRotation === 'function') {
                            proofPacks.applyLocalPreviewRotation();
                        } else if (typeof proofPacks.refreshVideoPreview === 'function') {
                            proofPacks.refreshVideoPreview();
                        }
                        showToast(bwCheckbox.checked ? 'Grayscale ON' : 'Grayscale OFF', 'info');
                    }
                }
            }
            
            // Escape: Close editor
            if (e.code === 'Escape') {
                e.preventDefault();
                if (typeof proofPacks.cancelEdit === 'function') {
                    proofPacks.cancelEdit();
                }
            }
            
            // Ctrl+Z: Undo
            if (e.ctrlKey && e.code === 'KeyZ' && !e.shiftKey) {
                e.preventDefault();
                if (typeof proofPacks.undoEdit === 'function') {
                    proofPacks.undoEdit();
                }
            }
            
            // Ctrl+Y or Ctrl+Shift+Z: Redo
            if ((e.ctrlKey && e.code === 'KeyY') || (e.ctrlKey && e.shiftKey && e.code === 'KeyZ')) {
                e.preventDefault();
                if (typeof proofPacks.redoEdit === 'function') {
                    proofPacks.redoEdit();
                }
            }
            
            // Ctrl+S: Save (apply edits)
            if (e.ctrlKey && e.code === 'KeyS') {
                e.preventDefault();
                if (typeof proofPacks.applyEditsToAsset === 'function') {
                    proofPacks.applyEditsToAsset();
                }
            }
        });
        
        // Keyboard hints toggle
        document.addEventListener('DOMContentLoaded', () => {
            const keyboardHintsBtn = document.getElementById('ppKeyboardHintsBtn');
            const keyboardHintsPanel = document.getElementById('ppKeyboardHints');
            
            if (keyboardHintsBtn && keyboardHintsPanel) {
                keyboardHintsBtn.addEventListener('click', () => {
                    const isHidden = keyboardHintsPanel.style.display === 'none' || !keyboardHintsPanel.style.display;
                    keyboardHintsPanel.style.display = isHidden ? 'block' : 'none';
                });
            }
            
            /* ============================================
               WIRE UP EVENT LISTENERS FOR EXTENDED FEATURES
               ============================================ */
            
            // Batch Toolbar Actions
            const clearSelectionBtn = document.getElementById('ppClearSelection');
            if (clearSelectionBtn) {
                clearSelectionBtn.addEventListener('click', () => {
                    if (typeof proofPacks.clearSelection === 'function') {
                        proofPacks.clearSelection();
                    }
                });
            }
            
            const batchRotateBtn = document.getElementById('ppBatchRotate');
            if (batchRotateBtn) {
                batchRotateBtn.addEventListener('click', () => {
                    if (typeof proofPacks.batchRotate === 'function') {
                        proofPacks.batchRotate(90);
                    }
                });
            }
            
            const batchVisibilityBtn = document.getElementById('ppBatchVisibility');
            if (batchVisibilityBtn) {
                batchVisibilityBtn.addEventListener('click', () => {
                    if (typeof proofPacks.batchToggleVisibility === 'function') {
                        proofPacks.batchToggleVisibility();
                    }
                });
            }
            
            const batchDeleteBtn = document.getElementById('ppBatchDelete');
            if (batchDeleteBtn) {
                batchDeleteBtn.addEventListener('click', () => {
                    if (typeof proofPacks.batchDelete === 'function') {
                        proofPacks.batchDelete();
                    }
                });
            }
            
            // Search Filter
            const searchInput = document.getElementById('ppSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    if (typeof proofPacks.filterLibrary === 'function') {
                        proofPacks.filterLibrary(e.target.value);
                    }
                });
            }
            
            // Chip Filters
            document.querySelectorAll('.pp-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    const filter = e.currentTarget.dataset.filter;
                    if (filter && typeof proofPacks.applyChipFilter === 'function') {
                        proofPacks.applyChipFilter(filter, e.currentTarget);
                    }
                });
            });
            
            // Sort Dropdown
            const sortSelect = document.getElementById('ppSortSelect');
            if (sortSelect) {
                sortSelect.addEventListener('change', (e) => {
                    if (typeof proofPacks.sortLibrary === 'function') {
                        proofPacks.sortLibrary(e.target.value);
                    }
                });
            }
            
            // View Mode Toggle
            document.querySelectorAll('.pp-view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const mode = e.currentTarget.dataset.view;
                    if (mode && typeof proofPacks.setViewMode === 'function') {
                        proofPacks.setViewMode(mode, e.currentTarget);
                    }
                });
            });
            
            // Export Presets (add listeners dynamically when export panel is shown)
            const attachExportListeners = () => {
                document.querySelectorAll('.pp-export-preset').forEach(preset => {
                    preset.addEventListener('click', (e) => {
                        const presetName = e.currentTarget.dataset.preset;
                        if (presetName && typeof proofPacks.exportWithPreset === 'function') {
                            proofPacks.exportWithPreset(presetName);
                        }
                    });
                });
            };
            
            // Attach export listeners (will be called when editor opens)
            setTimeout(attachExportListeners, 1000);
            
            // Undo/Redo Buttons
            const undoBtn = document.getElementById('ppUndoBtn');
            if (undoBtn) {
                undoBtn.addEventListener('click', () => {
                    if (typeof proofPacks.undoEdit === 'function') {
                        proofPacks.undoEdit();
                    }
                });
            }
            
            const redoBtn = document.getElementById('ppRedoBtn');
            if (redoBtn) {
                redoBtn.addEventListener('click', () => {
                    if (typeof proofPacks.redoEdit === 'function') {
                        proofPacks.redoEdit();
                    }
                });
            }
        });
    </script>
</body>
</html>








