<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes,viewport-fit=cover">
<meta name="description" content="Home2Smart professional portal for job management and scheduling">
<meta name="theme-color" content="#0a2a5a">
<title>Pro Portal • Home2Smart</title>
<!-- VERSION: 2025-12-01-FIXED-v5 -->

<!-- Service Worker Registration for Offline Capability -->
<script>
console.log('🏗️ PORTAL_BUILD_20260106_130500');
console.log('🔧 PORTAL VERSION: 2025-12-01-FIXED-v6-NO-SW');
console.log('🔧 Service Worker DISABLED - was caching old version');
console.log('🔧 After refresh, go to DevTools > Application > Service Workers > Unregister');
/*
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('[SW] Registered:', reg.scope))
      .catch(err => console.log('[SW] Registration failed:', err));
  });
}
*/
// UNREGISTER OLD SERVICE WORKER
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(registrations => {
    registrations.forEach(reg => {
      reg.unregister();
      console.log('🔧 Unregistered service worker:', reg.scope);
    });
  });
}

</script>

<!-- DNS Prefetch for external resources -->
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="dns-prefetch" href="https://storage.googleapis.com">

<!-- Preconnect for critical resources -->
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- Preload critical font with font-display swap -->
<link rel="preload" href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;900&family=Inter:wght@500;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;900&family=Inter:wght@500;600;700;800&display=swap"></noscript>

<!-- Inline critical CSS for above-the-fold content -->
<style>
:root{
  /* Primary Colors - Not all blue anymore */
  --blue:#0a2a5a;
  --blue-2:#0b2a58;
  --blue-3:#0c2f62;
  --azure:#1493ff;
  --azure-dark:#0f7acc;
  --azure-light:#60b5fa;
  
  /* Accent Colors - REAL CONTRAST */
  --green:#10b981;
  --green-light:#34d399;
  --green-dark:#059669;
  --orange:#f59e0b;
  --orange-light:#fbbf24;
  --orange-dark:#d97706;
  --red:#ef4444;
  --red-light:#f87171;
  --red-dark:#dc2626;
  --purple:#8b5cf6;
  --purple-light:#a78bfa;
  --purple-dark:#7c3aed;
  --cyan:#06b6d4;
  --cyan-light:#22d3ee;
  
  /* Neutrals */
  --white:#fff;
  --gray-50:#f9fafb;
  --gray-100:#f3f4f6;
  --gray-200:#e5e7eb;
  --gray-300:#d1d5db;
  --gray-700:#374151;
  --gray-800:#1f2937;
  --gray-900:#111827;
  
  /* Semantic Colors */
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
  --info:#3b82f6;
  
  /* Spacing */
  --spacing-xs:4px;
  --spacing-sm:8px;
  --spacing-md:16px;
  --spacing-lg:24px;
  --spacing-xl:32px;
  --spacing-2xl:48px;
  
  /* Border Radius */
  --br:14px;
  --br-sm:8px;
  --br-lg:18px;
  --br-xl:24px;
  
  /* Shadows - More dramatic */
  --e1:0 2px 8px rgba(0,0,0,.15),0 4px 16px rgba(0,0,0,.1);
  --e2:0 4px 16px rgba(0,0,0,.2),0 8px 32px rgba(0,0,0,.15);
  --e3:0 8px 32px rgba(0,0,0,.25),0 16px 48px rgba(0,0,0,.2);
  --shadow-success:0 4px 16px rgba(16,185,129,.25);
  --shadow-warning:0 4px 16px rgba(245,158,11,.25);
  --shadow-danger:0 4px 16px rgba(239,68,68,.25);
  --shadow-info:0 4px 16px rgba(59,130,246,.25);
  
  /* Gradients - More variety */
  --gradient-primary:linear-gradient(135deg,#1493ff 0%,#0f7acc 100%);
  --gradient-success:linear-gradient(135deg,#10b981 0%,#059669 100%);
  --gradient-warning:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);
  --gradient-danger:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);
  --gradient-purple:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);
  --gradient-card:linear-gradient(135deg,#0b2d5f 0%,#0a2653 100%);
  --gradient-dark:linear-gradient(135deg,#0a2653 0%,#081d42 100%);
  --gradient-vibrant:linear-gradient(135deg,#ec4899 0%,#8b5cf6 50%,#3b82f6 100%)
}
*{
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
}
html,body{
  min-height:100%; /* Changed from height:100% to allow scrolling */
  background:var(--blue);
  overflow-x:hidden;
  -webkit-text-size-adjust:100%;
  -ms-text-size-adjust:100%;
  text-size-adjust:100%;
  scroll-padding-top:80px; /* Ensure content doesn't scroll under header */
}
body{
  margin:0;
  padding-top:0; /* Remove padding - we'll handle spacing with margins instead */
  padding-bottom:env(safe-area-inset-bottom); /* Account for iPhone bottom */
  color:#fff;
  font-family:Archivo,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
  display:flex;
  flex-direction:column;
  min-height:100vh;
  background:var(--blue);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  text-rendering:optimizeLegibility;
  overscroll-behavior:none;
}

/* Header */
/* ===== HEADER ===== */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 16px; /* Mobile optimized padding */
  position:fixed;
  top:0;
  left:0;
  right:0;
  z-index:50;
  background:rgba(15, 23, 42, 0.95); /* Darker, cleaner background */
  border-bottom:1px solid rgba(255,255,255,0.08);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  height:64px; /* Fixed height for consistency */
}
.header.header-hidden{
  transform:translateY(-100%);
}
.header img{
  height:32px; /* Smaller logo for mobile */
  width:auto;
  display:block;
}
.header-right{
  display:flex;
  align-items:center;
  gap:12px;
}
.support{
  color:#fff;
  text-decoration:none;
  font-weight:600;
  font-size:14px;
  padding:8px 16px;
  border-radius:8px;
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.1);
  transition:all .2s ease;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.support:hover{
  background:rgba(255,255,255,0.15);
}

/* Menu Overlay & Sheet */
.menu-overlay{
  position:fixed;
  inset:0;
  background:rgba(10,42,90,0.97);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  z-index:100;
  display:none;
  place-items:center;
  padding:20px;
  animation:fadeIn 0.2s ease;
}
.menu-overlay[aria-hidden="false"]{
  display:grid;
}
.menu-sheet{
  background:rgba(30,41,59,0.95);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:20px;
  padding:32px;
  width:100%;
  max-width:480px;
  box-shadow:0 20px 60px rgba(0,0,0,0.5);
}
.menu-row{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-bottom:24px;
}
.menu-item{
  background:rgba(59,130,246,0.1);
  border:1px solid rgba(59,130,246,0.2);
  border-radius:12px;
  padding:16px 20px;
  font-size:16px;
  font-weight:600;
  color:#e0f2fe;
  cursor:pointer;
  transition:all 0.2s ease;
  text-align:left;
}
.menu-item:hover{
  background:rgba(59,130,246,0.2);
  border-color:rgba(59,130,246,0.4);
  transform:translateX(4px);
}
.menu-item:active{
  transform:translateX(2px) scale(0.98);
}
.menu-close{
  display:flex;
  justify-content:center;
}
.menu-btn{
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.1);
  border-radius:8px;
  padding:8px 16px;
  color:#fff;
  font-weight:600;
  font-size:14px;
  cursor:pointer;
  transition:all 0.2s ease;
  display:none;
}
.menu-btn:hover{
  background:rgba(255,255,255,0.15);
}
.menu-ic{
  display:block;
  width:18px;
  height:2px;
  background:#fff;
  position:relative;
}
.menu-ic::before,
.menu-ic::after{
  content:'';
  display:block;
  width:18px;
  height:2px;
  background:#fff;
  position:absolute;
  left:0;
}
.menu-ic::before{
  top:-6px;
}
.menu-ic::after{
  top:6px;
}

/* Main + container */
.main{
  flex:1;
  display:block;
  padding:16px; /* Standard mobile padding */
  padding-top:80px; /* Clear fixed header */
  background:#0f172a; /* Clean dark background */
  min-height:100vh;
}
.container{
  max-width:100%;
  width:100%;
  margin:0 auto;
  padding:0; /* Remove double padding */
}

/* Titles */
.h1{
  font-family:'Inter', sans-serif;
  font-weight:700;
  font-size:28px; /* Better mobile size */
  margin:0 0 24px;
  color:#fff;
  line-height:1.2;
  letter-spacing:-0.02em;
}

/* Cards & inputs */
.card{
  background:#1e293b;
  border:1px solid rgba(255,255,255,0.08);
  border-radius:16px;
  padding:20px;
  margin-bottom:16px;
  box-shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
.card::before{display:none} /* Remove gradient border top */

.card h2{
  margin:0 0 16px;
  font-weight:700;
  font-size:20px;
  color:#fff;
}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:960px){.grid-3{grid-template-columns:1fr}.grid-2{grid-template-columns:1fr}}
.label{
  font-weight:700;
  font-size:14px;
  margin:8px 0 6px;
  color:#b8d9ff;
  text-transform:uppercase;
  letter-spacing:.5px;
  font-size:12px
}
.input,.textarea,.select{
  width:100%;
  border:2px solid rgba(255,255,255,.12);
  background:linear-gradient(135deg,rgba(12,47,98,.6) 0%,rgba(11,42,88,.6) 100%);
  color:#e7f1ff;
  border-radius:12px;
  padding:14px 16px;
  font-size:16px;
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family:inherit;
  appearance:none
}
.input:focus,.textarea:focus,.select:focus{
  outline:none;
  border-color:var(--azure);
  background:linear-gradient(135deg,rgba(12,47,98,.8) 0%,rgba(11,42,88,.8) 100%);
  box-shadow:0 0 0 3px rgba(20,147,255,.15);
  transform:translateY(-1px);
}
.input::placeholder,.textarea::placeholder{
  color:rgba(231,241,255,.4)
}
.input{min-height:48px}
.textarea{min-height:120px;resize:vertical}
select.input,select.select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%2360b5ff' d='M6 8L0 0h12z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
  background-size:12px;
  padding-right:40px;
  cursor:pointer
}
select.input:hover,select.select:hover{
  border-color:rgba(255,255,255,.2);
  background-color:rgba(12,47,98,.7)
}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
.btn{
  appearance:none;
  border:2px solid var(--azure);
  background:linear-gradient(135deg,#1493ff 0%,#0f7acc 100%);
  color:#fff;
  font-weight:700;
  border-radius:13px;
  cursor:pointer;
  padding:1rem 1.5rem;
  min-height:52px;
  min-width:130px;
  box-shadow:0 4px 14px rgba(20,147,255,.3), 0 2px 4px rgba(0,0,0,.1), inset 0 1px 0 rgba(255,255,255,.25);
  touch-action:manipulation;
  transition:all .25s cubic-bezier(0.4, 0, 0.2, 1);
  font-family:inherit;
  font-size:15px;
  position:relative;
  overflow:hidden;
  will-change:transform,box-shadow;
  text-shadow:0 1px 2px rgba(0,0,0,.2);
  letter-spacing:0.3px;
}
.btn::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.2) 0%,rgba(255,255,255,0) 100%);
  opacity:0;
  transition:opacity .2s
}
.btn:hover{
  transform:translateY(-3px) scale(1.01);
  box-shadow:0 8px 24px rgba(20,147,255,.4), 0 4px 8px rgba(0,0,0,.15), inset 0 1px 0 rgba(255,255,255,.3);
  border-color:#60b5fa;
}
.btn:hover::before{opacity:1}
.btn:active{
  transform:translateY(-1px) scale(0.99);
  box-shadow:0 2px 8px rgba(20,147,255,.25), inset 0 2px 4px rgba(0,0,0,.1);
}
/* Mobile touch feedback */
@media (max-width:640px){
  .btn:active, button:active, a:active{
    transform:scale(0.96);
    transition:transform 0.1s;
  }
  .btn {
    width: 100%;
    display: block;
    margin-bottom: 8px;
  }
  .actions-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 16px;
  }
  .actions-grid button {
    grid-column: auto !important; /* Override any grid-column spans */
    width: 100%;
  }
}

/* Desktop Grid for Actions */
@media (min-width: 641px) {
  .actions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 16px;
  }
}

.btn.secondary{
  background:linear-gradient(135deg, rgba(255,255,255,.1) 0%, rgba(255,255,255,.05) 100%);
  border-color:rgba(255,255,255,.35);
/* ===== Time Off Modal (Premium Design) ===== */
.timeoff-modal-header{background:linear-gradient(135deg,#8b5cf6 0%,#6366f1 100%);padding:32px;border-radius:20px 20px 0 0;margin:-32px -32px 32px -32px}
.timeoff-modal-title{font-size:28px;font-weight:800;color:#fff;margin:0 0 8px 0;letter-spacing:-.02em}
.timeoff-modal-subtitle{font-size:15px;color:rgba(255,255,255,.85);margin:0}
.date-section{margin-bottom:32px}
.date-section-label{font-size:13px;font-weight:700;color:#cbd5e1;text-transform:uppercase;letter-spacing:.8px;margin-bottom:16px;display:block}
.date-input-wrapper{position:relative}
.date-display{background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(15,23,42,.85));border:2px solid rgba(139,92,246,.3);border-radius:16px;padding:24px;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1);min-height:80px;display:flex;align-items:center;justify-content:space-between}
.date-display:hover{border-color:rgba(139,92,246,.5);box-shadow:0 8px 24px rgba(139,92,246,.15),0 0 0 4px rgba(139,92,246,.08);transform:translateY(-2px)}
.date-display-content{flex:1}
.date-display-label{font-size:13px;color:#94a3b8;margin-bottom:6px}
.date-display-value{font-size:24px;font-weight:800;color:#e2e8f0;letter-spacing:-.01em}
.date-display-icon{width:48px;height:48px;background:rgba(139,92,246,.15);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.date-display-icon svg{width:24px;height:24px;stroke:#a78bfa;stroke-width:2.5}
.date-input-native{position:absolute;opacity:0;pointer-events:none;width:1px;height:1px}
.quick-picks{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:20px}
.quick-pick-chip{background:rgba(99,102,241,.12);border:2px solid rgba(99,102,241,.25);border-radius:12px;padding:14px 20px;color:#c7d2fe;font-size:14px;font-weight:700;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);text-align:center;white-space:nowrap}
.quick-pick-chip:hover{background:rgba(99,102,241,.25);border-color:rgba(99,102,241,.5);transform:translateY(-2px);box-shadow:0 4px 12px rgba(99,102,241,.2)}
.quick-pick-chip:active{transform:translateY(0)}
.date-hint{margin-top:20px;padding:16px;background:rgba(59,130,246,.08);border-left:3px solid rgba(59,130,246,.5);border-radius:8px;color:#93c5fd;font-size:14px;line-height:1.6}
.reason-section{margin-bottom:32px}
.reason-select-wrapper{position:relative}
.reason-select{width:100%;background:rgba(15,23,42,.95);border:2px solid rgba(139,92,246,.25);border-radius:14px;padding:18px 20px;color:#e2e8f0;font-size:16px;font-weight:600;cursor:pointer;transition:all .25s;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' fill='none' viewBox='0 0 24 24' stroke='%23a78bfa' stroke-width='2.5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center;background-size:20px;padding-right:52px}
.reason-select:hover{border-color:rgba(139,92,246,.4);background-color:rgba(15,23,42,1)}
.reason-select:focus{outline:none;border-color:#a78bfa;box-shadow:0 0 0 4px rgba(139,92,246,.15)}
.modal-actions{display:flex;gap:12px;margin-top:32px;padding-top:24px;border-top:1px solid rgba(148,163,184,.1)}
.modal-actions .btn-modern{flex:1;min-height:56px;font-size:16px;font-weight:700;border-radius:14px}

  color:#e7f1ff;
  box-shadow:0 2px 10px rgba(0,0,0,.15), inset 0 1px 0 rgba(255,255,255,.1);
  text-shadow:0 1px 2px rgba(0,0,0,.3);
}
.btn.secondary:hover{
  border-color:rgba(255,255,255,.55);
  background:linear-gradient(135deg, rgba(255,255,255,.15) 0%, rgba(255,255,255,.1) 100%);
  box-shadow:0 4px 16px rgba(0,0,0,.2), inset 0 1px 0 rgba(255,255,255,.15);
  transform:translateY(-3px) scale(1.01);
}
.btn.ghost{
  background:transparent;
  border-color:rgba(255,255,255,.3);
  color:#d6eaff;
  box-shadow:none
}
.btn.ghost:hover{
  border-color:rgba(255,255,255,.3);
  background:rgba(255,255,255,.03)
}
.btn.warn{
  background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);
  border-color:#dc2626
}
.btn.warn:hover{
  border-color:#ef4444
}
.muted{font-size:13px;opacity:.85;margin-top:6px;color:#b6d1ef}
.error{
  display:none;
  margin-top:12px;
  background:linear-gradient(135deg,rgba(220,38,38,.15) 0%,rgba(153,27,27,.15) 100%);
  color:#ffd7db;
  border:1px solid rgba(255,0,0,.3);
  padding:12px 14px;
  border-radius:10px;
  border-left:4px solid #dc2626
}
.ok{
  display:none;
  margin-top:12px;
  background:linear-gradient(135deg,rgba(16,185,129,.15) 0%,rgba(5,150,105,.15) 100%);
  color:#c8ffd6;
  border:1px solid rgba(0,255,0,.25);
  padding:12px 14px;
  border-radius:10px;
  border-left:4px solid var(--success)
}

/* Footer */
.footer{padding:18px clamp(16px,4vw,28px);font-size:14px;opacity:.9;background:var(--blue)}

/* Views */
.view{
  display:none;
  content-visibility:auto;
  contain-intrinsic-size:auto 800px
}
.view[aria-hidden="false"]{display:block}

/* Lists */
.list{display:grid;gap:10px}
.item{
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:14px 16px;
  background:var(--gradient-card);
  transition:all .35s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
  contain:layout style paint;
  opacity:0;
  transform:translateY(10px);
  animation:itemFadeIn .4s cubic-bezier(0.4, 0, 0.2, 1) forwards
}
@keyframes itemFadeIn{
  to{
    opacity:1;
    transform:translateY(0)
  }
}
.item::before{
  content:"";
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:3px;
  background:var(--gradient-primary);
  opacity:0;
  transition:opacity .35s cubic-bezier(0.4, 0, 0.2, 1)
}
.item:hover{
  border-color:rgba(255,255,255,.2);
  transform:translateX(6px) scale(1.005);
  box-shadow:var(--e2)
}
.item:hover::before{opacity:.8}
.item h3{margin:0 0 8px;font-size:18px;font-weight:800}
.item .meta{font-size:14px;opacity:.9;color:#9bc8ff}
.item .actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}

/* Job list pagination */
.list-container{position:relative}
.list-collapsed{max-height:800px;overflow:hidden;position:relative}
.list-collapsed::after{
  content:'';
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  height:120px;
  background:linear-gradient(to bottom, transparent 0%, rgba(10,42,90,0.95) 80%, rgba(10,42,90,1) 100%);
  pointer-events:none
}
.load-more-btn{
  width:100%;
  padding:14px;
  margin-top:16px;
  background:rgba(59,130,246,.1);
  border:1px solid rgba(59,130,246,.25);
  border-radius:12px;
  color:#60b5ff;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px
}
.load-more-btn:hover{
  background:rgba(59,130,246,.15);
  border-color:rgba(59,130,246,.35);
  transform:translateY(-1px)
}
.load-more-btn:active{transform:scale(0.98)}
.load-more-count{
  background:rgba(59,130,246,.2);
  padding:2px 8px;
  border-radius:6px;
  font-size:12px;
  font-weight:700
}

/* Photo gallery */
.photo-gallery{
  border-top:1px solid rgba(255,255,255,.08);
  margin-top:12px;
  padding-top:12px;
  animation:gallerySlideDown .3s ease
}
@keyframes gallerySlideDown{
  from{
    opacity:0;
    transform:translateY(-10px)
  }
  to{
    opacity:1;
    transform:translateY(0)
  }
}
/* Delete media confirm modal */
.delete-confirm-overlay{
  position:fixed; inset:0; display:none; place-items:center;
  background:rgba(10,42,90,.86); backdrop-filter:blur(8px);
  z-index:35000; animation:fadeIn .2s ease;
}
.delete-confirm{
  width:min(420px,92vw);
  background:var(--gradient-dark);
  border:1px solid rgba(255,255,255,.18);
  border-radius:16px; box-shadow:var(--e3);
  padding:18px; color:#e7f1ff;
}
.delete-confirm h4{margin:0 0 10px; font-size:18px; font-weight:900;
  background:linear-gradient(135deg,#fff 0%,#fbbf24 100%);
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;}
.delete-confirm .desc{font-size:13px; opacity:.85; margin-bottom:14px;}
.delete-confirm .preview{border:1px solid rgba(255,255,255,.12); border-radius:12px; overflow:hidden; margin-bottom:14px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,.06)}
.delete-confirm .actions{display:flex; gap:10px; justify-content:flex-end}
.btn.danger{background:linear-gradient(135deg,#ef4444, #b91c1c); border-color:#ef4444}
.btn.danger:hover{border-color:#f87171; box-shadow:0 8px 24px rgba(239,68,68,.35)}

/* Loader + toast */
.loader{
  position:fixed;
  inset:0;
  display:none;
  place-items:center;
  background:rgba(10,42,90,.75);
  backdrop-filter:blur(6px);
  z-index:20000
}
.spin{
  width:72px;
  height:72px;
  border-radius:50%;
  border:6px solid rgba(255,255,255,.15);
  border-top-color:#1493ff;
  border-right-color:#60b5ff;
  animation:sp .8s linear infinite;
  box-shadow:0 0 20px rgba(20,147,255,.3)
}
@keyframes sp{to{transform:rotate(360deg)}}
.toast{
  position:fixed;
  left:50%;
  bottom:28px;
  transform:translateX(-50%);
  background:var(--gradient-card);
  color:#d6eaff;
  border:1px solid rgba(255,255,255,.2);
  padding:14px 20px;
  border-radius:14px;
  display:none;
  z-index:30000;
  box-shadow:var(--e3);
  font-weight:600;
  backdrop-filter:blur(10px);
  animation:toastIn .3s ease
}
@keyframes toastIn{
  from{opacity:0;transform:translate(-50%,20px)}
  to{opacity:1;transform:translate(-50%,0)}
}

/* Payouts */
.big-num{
  font-weight:900;
  font-size:clamp(36px,8vw,56px);
  margin:8px 0 12px;
  background:linear-gradient(135deg,#10b981 0%,#059669 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  line-height:1.1
}
.kpis{display:flex;gap:12px;flex-wrap:wrap}
.kpi{
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.14);
  border-radius:12px;
  padding:12px 16px;
  font-weight:700;
  font-size:15px;
  transition:transform .2s,box-shadow .2s
}
.kpi:hover{
  transform:translateY(-2px);
  box-shadow:var(--e2)
}
.period-head{margin-top:20px;font-weight:900;font-size:18px;color:#b8d9ff}
.row-pay{
  display:flex;
  justify-content:space-between;
  gap:10px;
  padding:12px 14px;
  border:1px solid rgba(255,255,255,.14);
  border-radius:12px;
  background:var(--gradient-card);
  transition:all .2s ease
}
.row-pay:hover{
  border-color:rgba(255,255,255,.2);
  box-shadow:var(--e1)
}
.row-pay+.row-pay{margin-top:8px}
.pay-left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pay-amt{font-weight:900;color:#10b981;font-size:18px}

/* Modals */
.modal{
  position:fixed;
  inset:0;
  display:none;
  place-items:center;
  background:rgba(10,42,90,.92);
  backdrop-filter:blur(8px);
  z-index:25000;
  padding:20px;
  will-change:opacity
}
.sheet{
  width:min(820px,94vw);
  max-height:90vh;
  overflow:auto;
  background:var(--gradient-dark);
  border:1px solid rgba(255,255,255,.16);
  border-radius:var(--br-lg);
  box-shadow:var(--e3);
  padding:24px;
  margin:0 auto;
  position:relative
}
.sheet::before{
  content:"";
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:2px;
  background:var(--gradient-primary);
  opacity:.7
}
.sheet h3{
  margin:4px 0 14px;
  font-size:24px;
  font-weight:900;
  background:linear-gradient(135deg,#fff 0%,#b8d9ff 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text
}
.payout{margin:12px 0}
.payout .num{
  font-weight:900;
  font-size:32px;
  background:linear-gradient(135deg,#10b981 0%,#059669 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text
}
.payout .subl{font-size:14px;opacity:.8;margin-top:6px;color:#9bc8ff}
.kv{display:grid;grid-template-columns:150px 1fr;gap:10px;font-size:14px;line-height:1.6}
.kv > div:nth-child(odd){color:#9bc8ff;font-weight:600}
.hr{height:1px;background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.15) 50%,transparent 100%);margin:16px 0}
.cands{display:grid;gap:10px;margin-top:10px}
.cand{
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:1px solid rgba(255,255,255,.14);
  border-radius:12px;
  padding:12px 14px;
  background:var(--gradient-card);
  transition:all .2s ease
}
.cand:hover{
  border-color:rgba(255,255,255,.25);
  transform:translateX(4px);
  box-shadow:var(--e2)
}

/* Signature */
.canvas-wrap{
  background:#fff;
  border-radius:14px;
  padding:12px;
  box-shadow:inset 0 2px 8px rgba(0,0,0,.1)
}
.sig-canvas{
  background:#fff;
  border:2px solid #e5e7eb;
  border-radius:10px;
  touch-action:none;
  cursor:crosshair;
  transition:border-color .2s
}
.sig-canvas:hover{
  border-color:#1493ff
}
.sig-error{
  display:none;
  margin-top:12px;
  color:#ffd7db;
  background:linear-gradient(135deg,rgba(220,38,38,.15) 0%,rgba(153,27,27,.15) 100%);
  border:1px solid rgba(255,0,0,.3);
  padding:10px 14px;
  border-radius:10px;
  border-left:4px solid #dc2626
}

/* Admin list */
.admin-bar{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-bottom:16px;
  padding:16px;
  background:var(--gradient-card);
  border-radius:14px;
  border:1px solid rgba(255,255,255,.1)
}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.tr{
  display:grid;
  grid-template-columns:1.2fr .9fr .9fr 1fr .6fr .8fr;
  gap:10px;
  align-items:center;
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:12px 14px;
  transition:all .2s ease
}
.tr:hover{
  border-color:rgba(255,255,255,.25);
  transform:translateX(4px);
  box-shadow:var(--e2)
}
.th{opacity:.8;font-weight:700;font-size:13px;color:#9bc8ff;text-transform:uppercase;letter-spacing:.5px}
.td{font-size:14px}
.actions-sm{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

/* Training enhancements */
.training-header{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:space-between;
  margin-bottom:20px;
  padding:16px;
  background:var(--gradient-card);
  border-radius:14px;
  border:1px solid rgba(255,255,255,.1)
}
.training-controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.training-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:24px;
  margin-top:20px
}

/* ===== NEW TRAINING HUB STYLES ===== */
.training-dashboard-header{
  background:linear-gradient(135deg,rgba(20,147,255,.12) 0%,rgba(10,80,180,.08) 100%);
  border:1px solid rgba(20,147,255,.2);
  border-radius:16px;
  padding:28px;
  margin-bottom:32px
}
.training-header-content h2{font-size:28px;font-weight:900;margin:0;color:#fff}
.training-header-content .muted{font-size:15px;opacity:.85}
.training-stats-cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:16px;
  margin-top:24px
}
.stat-card{
  background:rgba(10,42,90,.5);
  backdrop-filter:blur(10px);
  border:1px solid rgba(255,255,255,.14);
  border-radius:12px;
  padding:16px;
  display:flex;
  align-items:center;
  gap:12px;
  transition:all .3s
}
.stat-card:hover{
  transform:translateY(-2px);
  border-color:rgba(20,147,255,.4);
  box-shadow:0 4px 12px rgba(20,147,255,.15)
}
.stat-icon{
  font-size:32px;
  line-height:1
}
.stat-info{flex:1}
.stat-value{
  font-size:24px;
  font-weight:900;
  color:#fff;
  line-height:1.2
}
.stat-label{
  font-size:12px;
  opacity:.75;
  margin-top:4px;
  text-transform:uppercase;
  letter-spacing:.5px
}
.stat-completed .stat-value{color:#10b981}
.stat-progress .stat-value{color:#3b82f6}
.stat-certificates .stat-value{color:#f59e0b}
.stat-hours .stat-value{color:#8b5cf6}

/* Training Sections */
.training-section{
  margin-bottom:56px;
  padding:0 4px
}
.section-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:24px;
  flex-wrap:wrap;
  gap:16px
}
.section-title{
  font-size:24px;
  font-weight:900;
  margin:0;
  color:#fff;
  letter-spacing:-0.02em
}
.section-subtitle{
  font-size:14px;
  opacity:.8;
  margin:8px 0 0;
  line-height:1.5
}
.btn-text{
  background:none;
  border:none;
  color:#3b82f6;
  font-size:14px;
  font-weight:700;
  cursor:pointer;
  padding:8px 12px;
  border-radius:8px;
  transition:all .2s
}
.btn-text:hover{
  background:rgba(59,130,246,.12);
  color:#60a5fa
}

/* Learning Paths */
.learning-paths-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(380px,1fr));
  gap:20px
}
.learning-path-card{
  background:linear-gradient(135deg,rgba(20,147,255,.08) 0%,rgba(10,80,180,.04) 100%);
  border:1px solid rgba(20,147,255,.25);
  border-radius:16px;
  padding:24px;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  cursor:pointer;
  position:relative;
  overflow:hidden
}
.learning-path-card::before{
  content:"";
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:4px;
  background:linear-gradient(90deg,#3b82f6,#8b5cf6,#ec4899);
  opacity:0;
  transition:opacity .3s
}
.learning-path-card:hover{
  transform:translateY(-4px);
  box-shadow:0 12px 24px rgba(20,147,255,.2);
  border-color:rgba(20,147,255,.5)
}
.learning-path-card:hover::before{opacity:1}
.path-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:16px
}
.path-icon{
  font-size:48px;
  line-height:1
}
.path-badge{
  background:rgba(59,130,246,.2);
  border:1px solid rgba(59,130,246,.4);
  color:#60a5fa;
  padding:4px 10px;
  border-radius:6px;
  font-size:11px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:.5px
}
.path-title{
  font-size:20px;
  font-weight:900;
  margin:0 0 8px;
  color:#fff
}
.path-description{
  font-size:14px;
  opacity:.85;
  line-height:1.6;
  margin-bottom:20px
}
.path-meta{
  display:flex;
  gap:16px;
  font-size:13px;
  opacity:.75;
  margin-bottom:16px
}
.path-meta span{
  display:inline-flex;
  align-items:center;
  gap:6px
}
.path-progress-bar{
  background:rgba(10,42,90,.6);
  border-radius:8px;
  height:8px;
  overflow:hidden;
  margin-bottom:12px
}
.path-progress-fill{
  background:linear-gradient(90deg,#3b82f6,#8b5cf6);
  height:100%;
  transition:width .6s cubic-bezier(.4,0,.2,1)
}
.path-progress-text{
  font-size:12px;
  font-weight:700;
  opacity:.85
}

/* Filters Bar */
.training-filters-bar{
  background:rgba(10,42,90,.35);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:28px;
  margin-bottom:32px;
  backdrop-filter:blur(12px);
  box-shadow:0 4px 16px rgba(0,0,0,.15);
  overflow:hidden; /* Prevent content bleeding */
  box-sizing:border-box;
}
.filter-tabs{
  display:flex;
  gap:10px;
  margin-bottom:20px;
  flex-wrap:wrap;
  padding:4px 0
}
.filter-tab{
  background:rgba(30,41,59,0.6);
  border:1.5px solid rgba(59,130,246,0.25);
  border-radius:11px;
  padding:11px 22px;
  font-size:14px;
  font-weight:600;
  color:rgba(226,232,240,0.85);
  cursor:pointer;
  transition:all .25s cubic-bezier(.4,0,.2,1);
  white-space:nowrap;
  min-height:44px;
  display:inline-flex;
  align-items:center;
  gap:7px
}
.filter-tab:hover{
  background:rgba(59,130,246,.18);
  border-color:rgba(59,130,246,.5);
  color:#e0f2fe;
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(59,130,246,.2)
}
.filter-tab.active{
  background:linear-gradient(135deg,rgba(59,130,246,.28),rgba(37,99,235,.25));
  border-color:rgba(96,165,250,.7);
  color:#60a5fa;
  box-shadow:0 0 0 3px rgba(59,130,246,.12),0 6px 16px rgba(59,130,246,.3);
  transform:translateY(-2px)
}

/* Category Pills */
.category-pill{
  background:rgba(139, 92, 246, 0.15);
  border:1px solid rgba(139, 92, 246, 0.4);
  border-radius:30px;
  padding:12px 24px;
  display:inline-flex;
  align-items:center;
  gap:10px;
  transition:all 0.2s;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  color:#e2e8f0
}
.category-pill:hover{
  background:rgba(139, 92, 246, 0.25);
  border-color:#8b5cf6;
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(139, 92, 246, 0.2)
}
.category-pill .count{
  background:rgba(236, 72, 153, 0.3);
  border-radius:12px;
  padding:4px 10px;
  font-size:12px;
  font-weight:700;
  color:#fbbf24
}

.search-box:focus-within {
  box-shadow:0 0 0 3px rgba(59,130,246,.1)
}
.filter-controls{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  overflow:hidden; /* Prevent bleeding over boundaries */
}
.search-box-training{
  flex:1;
  min-width:260px;
  max-width:400px;
  position:relative;
  display:flex;
  align-items:center;
  max-width:100%; /* Never exceed container */
  box-sizing:border-box;
}
.search-icon{
  position:absolute;
  left:14px;
  font-size:16px;
  opacity:.6;
  pointer-events:none
}
.search-input-training{
  width:100%;
  background:rgba(10,42,90,.6);
  border:1px solid rgba(255,255,255,.14);
  border-radius:10px;
  padding:10px 14px 10px 40px;
  font-size:14px;
  color:#fff;
  transition:all .2s
}
.search-input-training::placeholder{color:rgba(255,255,255,.5)}
.search-input-training:focus{
  outline:none;
  border-color:rgba(59,130,246,.5);
  box-shadow:0 0 0 3px rgba(59,130,246,.1);
  background:rgba(10,42,90,.8)
}
.input-filter{
  background:rgba(10,42,90,.6);
  border:1px solid rgba(255,255,255,.14);
  border-radius:10px;
  padding:10px 14px;
  font-size:14px;
  color:#fff;
  cursor:pointer;
  transition:all .2s;
  min-width:160px
}
.input-filter:hover{
  border-color:rgba(20,147,255,.3);
  background:rgba(10,42,90,.8)
}
.input-filter:focus{
  outline:none;
  border-color:rgba(59,130,246,.5);
  box-shadow:0 0 0 3px rgba(59,130,246,.1)
}

/* View Toggles */
.view-toggles{
  display:flex;
  gap:4px;
  background:rgba(10,42,90,.4);
  padding:4px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.1)
}
.view-toggle{
  background:transparent;
  border:none;
  border-radius:8px;
  padding:8px 12px;
  color:rgba(255,255,255,.6);
  cursor:pointer;
  transition:all .2s;
  display:flex;
  align-items:center;
  justify-content:center
}
.view-toggle:hover{
  color:#fff;
  background:rgba(255,255,255,.08)
}
.view-toggle.active{
  background:rgba(59,130,246,.25);
  color:#60a5fa
}

/* Training Grid Horizontal (Continue Watching) */
.training-grid-horizontal{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:20px;
  padding-bottom:8px
}

/* Enhanced Training Cards */
/* Enhanced Training Cards */
.training-card{
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  padding:0;
  overflow:hidden;
  transition:all .35s cubic-bezier(0.4, 0, 0.2, 1);
  cursor:pointer;
  box-shadow:var(--e1);
  will-change:transform,box-shadow;
  contain:layout style paint;
  position:relative
}
.training-card::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:16px;
  padding:1px;
  background:linear-gradient(135deg,transparent,rgba(59,130,246,.3));
  -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite:xor;
  mask-composite:exclude;
  opacity:0;
  transition:opacity .35s cubic-bezier(0.4, 0, 0.2, 1);
}
.training-card:hover{
  transform:translateY(-8px) scale(1.015);
  box-shadow:0 20px 40px rgba(20,147,255,.3), 0 8px 16px rgba(0,0,0,.2), 0 0 0 1px rgba(59,130,246,.4);
  border-color:rgba(20,147,255,.6);
}
.training-card:hover::after{opacity:1}
.training-thumb{
  width:100%;
  aspect-ratio:16/9;
  background:linear-gradient(135deg,#1a4a7a 0%,#0f2d52 100%);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:52px;
  position:relative;
  overflow:hidden
}
.training-thumb::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(180deg,transparent 0%,rgba(10,42,90,.6) 100%);
  opacity:0;
  transition:opacity .3s
}
.training-card:hover .training-thumb::before{opacity:1}
.training-thumb img{width:100%;height:100%;object-fit:cover}
.training-badge{
  position:absolute;
  top:12px;
  right:12px;
  background:rgba(10,42,90,.95);
  backdrop-filter:blur(10px);
  color:#fff;
  padding:6px 12px;
  border-radius:8px;
  font-size:12px;
  font-weight:800;
  border:1px solid rgba(255,255,255,.25);
  box-shadow:0 2px 8px rgba(0,0,0,.3);
  text-transform:uppercase;
  letter-spacing:.5px
}
.badge-completed{
  background:linear-gradient(135deg,rgba(16,185,129,.95) 0%,rgba(5,150,105,.95) 100%);
  border-color:rgba(16,185,129,.4)
}
.badge-progress{
  background:linear-gradient(135deg,rgba(59,130,246,.95) 0%,rgba(37,99,235,.95) 100%);
  border-color:rgba(59,130,246,.4)
}
.badge-new{
  background:linear-gradient(135deg,rgba(251,191,36,.95) 0%,rgba(245,158,11,.95) 100%);
  border-color:rgba(251,191,36,.4);
  color:#0a2a5a
}
.training-body{padding:18px 20px}
.training-title{font-size:18px;font-weight:900;margin:0 0 10px;line-height:1.3;color:#fff}
.training-meta{
  font-size:13px;
  opacity:.9;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:12px;
  color:#9bc8ff
}
.training-meta span{display:inline-flex;align-items:center;gap:4px}
.training-desc{
  font-size:14px;
  opacity:.9;
  line-height:1.6;
  margin:12px 0;
  display:-webkit-box;
  -webkit-line-clamp:2;
  line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
  color:#b8d9ff
}
.training-progress{
  width:100%;
  height:6px;
  background:rgba(255,255,255,.1);
  border-radius:3px;
  margin:12px 0;
  overflow:hidden;
  box-shadow:inset 0 1px 3px rgba(0,0,0,.3)
}
.training-progress-bar{
  height:100%;
  background:linear-gradient(90deg,#1493ff 0%,#10b981 100%);
  transition:width .4s cubic-bezier(.4,0,.2,1);
  border-radius:3px;
  box-shadow:0 0 8px rgba(20,147,255,.5)
}

/* ===== ENHANCED RESOURCES & CERTIFICATES ===== */
/* Resources & Downloads */
.resources-list{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(320px, 1fr));
  gap:16px;
  max-height:600px;
  overflow-y:auto;
  padding-right:8px;
}
.resources-list::-webkit-scrollbar{
  width:8px;
}
.resources-list::-webkit-scrollbar-track{
  background:rgba(255,255,255,.05);
  border-radius:4px;
}
.resources-list::-webkit-scrollbar-thumb{
  background:rgba(96,181,255,.3);
  border-radius:4px;
}
.resources-list::-webkit-scrollbar-thumb:hover{
  background:rgba(96,181,255,.5);
}
.resource-item{
  background:rgba(10,42,90,.4);
  border:1px solid rgba(255,255,255,.1);
  border-radius:12px;
  padding:18px;
  display:flex;
  align-items:center;
  gap:14px;
  transition:all .35s cubic-bezier(0.4, 0, 0.2, 1);
  cursor:pointer;
}
.resource-item:hover{
  background:rgba(20,147,255,.1);
  border-color:rgba(20,147,255,.35);
  transform:translateX(6px);
  box-shadow:0 4px 12px rgba(20,147,255,.15);
}
.resource-icon{
  font-size:32px;
  line-height:1;
  min-width:44px;
  text-align:center;
  transition:transform .35s cubic-bezier(0.4, 0, 0.2, 1);
}
.resource-item:hover .resource-icon{
  transform:scale(1.1) rotate(5deg);
}
.resource-info{flex:1;min-width:0}
.resource-title{
  font-size:15px;
  font-weight:700;
  margin:0 0 6px;
  color:#fff;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.resource-meta{
  font-size:12px;
  opacity:.75;
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.resource-meta span{
  display:inline-flex;
  align-items:center;
  gap:4px;
}
.resource-download{
  background:rgba(59,130,246,.15);
  border:1px solid rgba(59,130,246,.3);
  border-radius:10px;
  padding:8px 16px;
  font-size:13px;
  font-weight:700;
  color:#60a5fa;
  transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
  white-space:nowrap;
}
.resource-download:hover{
  background:rgba(59,130,246,.3);
  transform:scale(1.05)
}

.certificates-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:20px
}
.certificate-card{
  background:linear-gradient(135deg,rgba(251,191,36,.08),rgba(245,158,11,.04));
  border:2px solid rgba(251,191,36,.3);
  border-radius:16px;
  padding:28px;
  position:relative;
  overflow:hidden;
  transition:all .3s
}
.certificate-card::before{
  content:"";
  position:absolute;
  top:-50%;
  right:-50%;
  width:200%;
  height:200%;
  background:radial-gradient(circle,rgba(251,191,36,.15) 0%,transparent 70%);
  opacity:0;
  transition:opacity .3s
}
.certificate-card:hover{
  transform:translateY(-4px);
  box-shadow:0 12px 24px rgba(251,191,36,.2);
  border-color:rgba(251,191,36,.5)
}
.certificate-card:hover::before{opacity:1}
.certificate-icon{
  font-size:64px;
  text-align:center;
  margin-bottom:16px
}
.certificate-title{
  font-size:20px;
  font-weight:900;
  text-align:center;
  margin:0 0 8px;
  color:#fbbf24
}
.certificate-subtitle{
  font-size:14px;
  text-align:center;
  opacity:.85;
  margin-bottom:16px
}
.certificate-date{
  font-size:12px;
  text-align:center;
  opacity:.7;
  font-weight:600
}
.certificate-actions{
  margin-top:20px;
  display:flex;
  gap:8px;
  justify-content:center
}

.training-grid.view-list{
  grid-template-columns:1fr
}
.training-grid.view-list .training-card{
  display:flex;
  flex-direction:row;
  align-items:stretch
}
.training-grid.view-list .training-thumb{
  width:240px;
  aspect-ratio:16/10;
  flex-shrink:0
}
.training-grid.view-list .training-body{
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  padding:20px 24px
}

.resource-card{
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  padding:20px;
  transition:all .3s cubic-bezier(.4,0,.2,1);
  box-shadow:var(--e1)
}
.resource-card:hover{
  transform:translateY(-4px);
  box-shadow:var(--e3);
  border-color:rgba(20,147,255,.3)
}
.resource-icon{
  width:56px;
  height:56px;
  border-radius:14px;
  background:var(--gradient-primary);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  margin-bottom:14px;
  box-shadow:0 4px 12px rgba(20,147,255,.3)
}
.skeleton{
  background:linear-gradient(90deg,rgba(255,255,255,.05) 25%,rgba(255,255,255,.1) 50%,rgba(255,255,255,.05) 75%);
  background-size:200% 100%;
  animation:shimmer 1.5s infinite;
  border-radius:16px
}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-card{height:360px;border-radius:16px}
.empty-state{
  text-align:center;
  padding:80px 20px;
  background:rgba(10,42,90,.2);
  border:2px dashed rgba(255,255,255,.1);
  border-radius:16px;
  margin:40px auto;
  max-width:480px
}
.empty-state-icon{
  font-size:84px;
  margin-bottom:24px;
  opacity:.6;
  filter:grayscale(1)
}
.empty-state p{
  font-size:18px;
  font-weight:700;
  margin:0 0 24px;
  opacity:.8;
  color:#fff
}
.empty-state .btn{
  min-width:160px;
  font-size:15px;
  padding:12px 28px
}
.video-modal-body{display:grid;gap:24px}
.video-info{display:grid;gap:14px}
.video-stats{
  display:flex;
  gap:18px;
  flex-wrap:wrap;
  font-size:14px;
  opacity:.95;
  color:#9bc8ff;
  padding:12px;
  background:rgba(255,255,255,.03);
  border-radius:10px;
  border:1px solid rgba(255,255,255,.08)
}
.video-stat{display:flex;align-items:center;gap:6px;font-weight:600}

/* Accessibility */
.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* Mobile tweaks */
@media (max-width:800px){
  .tr{grid-template-columns:1fr 1fr;gap:10px}
  .actions-sm{justify-content:flex-start}
  .training-grid{grid-template-columns:1fr}
  .video-stats{gap:12px}
}
@media (max-width:540px){
  .header{padding:12px 16px}
  .header img{height:48px}
  .btn{min-width:100px;padding:.9rem 1rem;font-size:14px}
  .input{min-height:46px;font-size:15px}
  .main{padding:16px}
  .container{padding:0 12px}
  .card{padding:18px;margin:8px auto 18px}
  .card h2{font-size:22px}
  .kv{grid-template-columns:1fr}
  .training-header{flex-direction:column;align-items:stretch}
  .training-controls{width:100%}
  .training-controls select{width:100%}
  #trainingSearch{width:100%;max-width:100%}
  .big-num{font-size:40px}
}

/* AGGRESSIVE MOBILE OPTIMIZATIONS - iOS Standard */
@media (max-width:640px){
  /* Prevent zoom on inputs - iOS fix */
  input, select, textarea, button {
    font-size:16px !important;
  }
  
  /* Minimum tap targets - 48px Standard */
  button, .btn, input, select {
    min-height:48px !important;
    min-width:48px !important;
  }
  
  /* Exception for small icon buttons (like delete) */
  button[style*="width:36px"] {
    min-height:36px !important;
    min-width:36px !important;
  }
  
  /* Header optimization - MUCH SMALLER, cleaner */
  .header{
    padding:8px 16px !important;
    min-height:56px !important;
    backdrop-filter:blur(20px) saturate(180%) !important;
    -webkit-backdrop-filter:blur(20px) saturate(180%) !important;
    background:rgba(10,42,90,0.95) !important;
    border-bottom:1px solid rgba(255,255,255,.08) !important;
    /* iPhone notch adaptation */
    top:env(safe-area-inset-top, 0) !important;
    padding-top:max(8px, env(safe-area-inset-top)) !important;
  }
  .header img{
    height:28px !important;
    width:auto;
  }
  .support{
    font-size:12px !important;
    padding:6px 12px !important;
    min-height:32px !important;
    font-weight:600 !important;
  }
  .header-right{
    gap:8px;
  }
  .menu-btn{
    padding:8px !important;
    min-height:36px !important;
    font-size:13px !important;
    font-weight:600 !important;
    width:auto !important;
    min-width:44px !important;
  }
  .menu-ic{
    width:20px !important;
  }
  .menu-ic::before,
  .menu-ic::after{
    width:20px !important;
  }
  .menu-sheet{
    max-width:100% !important;
    border-radius:0 !important;
    padding:24px !important;
    min-height:100vh !important;
  }
  .menu-item{
    padding:16px !important;
    font-size:16px !important;
    min-height:56px !important;
    display:flex !important;
    align-items:center !important;
  }
  
  /* Compact typography - REFINED */
  .h1{
    font-family:'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
    font-size:24px !important;
    margin-top:calc(env(safe-area-inset-top, 0px) + 80px) !important;
    margin-left:16px !important;
    margin-right:16px !important;
    margin-bottom:16px !important;
    line-height:1.2 !important;
    letter-spacing:-0.02em !important;
  }
  .card h2{
    font-size:18px !important;
    margin:0 0 12px !important;
    line-height:1.3 !important;
    font-weight:700 !important;
  }
  .card h3{
    font-size:16px !important;
    margin:0 0 8px !important;
    line-height:1.3 !important;
    font-weight:600 !important;
  }
  
  /* Tighter spacing - REFINED */
  .main{
    padding:0 !important;
    min-height:100vh !important;
  }
  .container{
    padding:0 !important;
    min-height:auto !important;
  }
  .card{
    padding:20px !important;
    margin:0 0 12px 0 !important;
    border-radius:0 !important;
    border-left:none !important;
    border-right:none !important;
    border-top:1px solid rgba(255,255,255,.05) !important;
    border-bottom:1px solid rgba(255,255,255,.05) !important;
    box-shadow:none !important;
    background:rgba(10,42,90,0.4) !important;
  }
  
  /* Login screen - ensure it's scrollable */
  #view-auth{
    min-height:auto !important;
    max-height:none !important;
    overflow-y:visible !important;
    -webkit-overflow-scrolling:touch !important;
    padding:20px !important;
  }
  #view-auth .card {
    border-radius:16px !important;
    border:1px solid rgba(255,255,255,.1) !important;
    margin-top:40px !important;
  }
  
  /* TEAM UPDATES MOBILE - PREMIUM FEEL */
  .view-all-btn{
    display:none !important;
  }
  .announcement-header-clickable{
    transition:all 0.2s ease !important;
  }
  .announcement-header-clickable:active{
    opacity:0.7 !important;
    transform:scale(0.98) !important;
  }
  .announcement-icon{
    width:32px !important;
    height:32px !important;
    font-size:16px !important;
  }
  .announcement-title{
    font-size:15px !important;
    font-weight:600 !important;
    letter-spacing:-0.01em !important;
  }
  .announcement-subtitle{
    font-size:12px !important;
    opacity:0.7 !important;
  }
  .announcement-card{
    padding:16px !important;
    gap:12px !important;
    margin-bottom:12px !important;
    border-radius:12px !important;
    background:rgba(255,255,255,.03) !important;
    border:1px solid rgba(255,255,255,.05) !important;
  }
  .announcement-card:active{
    transform:scale(0.98) !important;
    background:rgba(255,255,255,.06) !important;
  }
  
  /* Communication Hub mobile - REFINED */
  #communicationHub{
    padding:16px !important;
    margin-bottom:0 !important;
    border-radius:0 !important;
    border-left:none !important;
    border-right:none !important;
  }
  
  /* Announcements Modal mobile optimization */
  #announcementsModal{
    padding:0 !important;
  }
  #announcementsModal > div{
    margin:0 !important;
    border-radius:0 !important;
    max-width:100% !important;
    min-height:100vh !important;
    height:100vh !important;
  }
  #announcementsModal > div > div:first-child{
    padding:16px 20px !important;
  }
  #announcementsListPro{
    padding:16px 20px !important;
    max-height:calc(100vh - 80px) !important;
  }
  
  /* TRAINING SEARCH - HIDE ON MOBILE */
  .search-box-training{
    display:none !important; /* Categories are better navigation on mobile */
  }
  .filter-controls{
    justify-content:flex-end !important;
  }
  .training-filters-bar{
    padding:16px !important;
    border-radius:0 !important;
    margin-bottom:0 !important;
    border-left:none !important;
    border-right:none !important;
  }
  .filter-tabs{
    gap:8px !important;
    margin-bottom:14px !important;
    overflow-x:auto !important;
    padding-bottom:8px !important;
    -webkit-overflow-scrolling:touch !important;
  }
  .filter-tab{
    padding:8px 16px !important;
    font-size:14px !important;
    min-height:40px !important;
    flex-shrink:0 !important;
  }
  
  /* Job list mobile optimization - Smart pagination */
  .list-collapsed{
    max-height:none !important; /* Show all on mobile, scrolling is natural */
  }
  .list-collapsed::after {
    display:none !important;
  }
  .load-more-btn{
    padding:16px !important;
    font-size:15px !important;
    margin-top:16px !important;
    border-radius:12px !important;
    background:rgba(59,130,246,.15) !important;
  }
  .item{
    padding:16px !important;
    margin-bottom:12px !important;
    border-radius:12px !important;
    background:rgba(255,255,255,.03) !important;
    border:1px solid rgba(255,255,255,.08) !important;
  }
  .item h3{
    font-size:17px !important;
    font-weight:700 !important;
  }
  .item .meta{
    font-size:14px !important;
    line-height:1.5 !important;
  }
  
  /* Signature canvas - PERFECTLY CONTAINED */
  .canvas-wrap{
    margin:0 !important;
    padding:0 !important;
    border-radius:12px !important;
    background:#fff !important;
    overflow:hidden !important;
  }
  .sig-canvas{
    width:100% !important;
    max-width:100% !important;
    height:200px !important;
    display:block !important;
    border-radius:0 !important;
    touch-action:none !important;
  }
  
  /* Full-width buttons - SLEEK & MODERN */
  .btn{
    width:100% !important;
    min-width:auto !important;
    padding:0 20px !important;
    font-size:16px !important;
    min-height:52px !important;
    line-height:52px !important;
    border-radius:12px !important;
    font-weight:700 !important;
    letter-spacing:-0.01em !important;
    margin-bottom:8px !important;
  }
  .btn.ghost{
    background:rgba(255,255,255,.05) !important;
    border:1px solid rgba(255,255,255,.15) !important;
    color:rgba(255,255,255,.9) !important;
  }
  .btn.secondary{
    background:rgba(139,92,246,.15) !important;
    border:1px solid rgba(139,92,246,.3) !important;
    color:#e0e7ff !important;
  }
  .row{
    flex-direction:column !important;
    gap:12px !important;
    margin-top:16px !important;
  }
  
  /* Optimized inputs - CLEAN & MODERN */
  .input,.textarea,.select{
    min-height:52px !important;
    font-size:16px !important;
    padding:14px 16px !important;
    border-radius:12px !important;
    width:100% !important;
    border:1px solid rgba(255,255,255,.15) !important;
    background:rgba(255,255,255,.05) !important;
    transition:all 0.2s ease !important;
  }
  .input:focus,.textarea:focus,.select:focus{
    border-color:rgba(96,181,255,.5) !important;
    background:rgba(255,255,255,.08) !important;
    outline:none !important;
  }
  .textarea{
    min-height:120px !important;
    line-height:1.5 !important;
  }
  
  /* Modal optimization */
  .modal{
    padding:0 !important;
    align-items:flex-end !important; /* Bottom sheet style */
  }
  .sheet{
    width:100vw !important;
    max-width:100vw !important;
    border-radius:24px 24px 0 0 !important; /* Rounded top corners */
    border-left:none !important;
    border-right:none !important;
    border-bottom:none !important;
    padding:24px 20px !important;
    max-height:92vh !important;
    overflow-y:auto !important;
    background:linear-gradient(180deg, #0f2d52 0%, #0a2a5a 100%) !important;
    box-shadow:0 -10px 40px rgba(0,0,0,0.5) !important;
  }
  .sheet h3{
    font-size:22px !important;
    margin:0 0 20px !important;
    line-height:1.3 !important;
  }
  
  /* Grid adjustments */
  .grid-2{
    grid-template-columns:1fr !important;
    gap:16px !important;
  }
  .grid-3{
    grid-template-columns:1fr !important;
    gap:16px !important;
  }
  
  /* List items - PERFECT edge-to-edge */
  .list{
    gap:12px !important;
    margin:0 !important;
    padding:0 16px !important;
  }
  
  /* Page headers on mobile */
  .page-header-modern{
    margin:0 0 16px 0 !important;
    border-radius:0 !important;
    border-left:none !important;
    border-right:none !important;
    padding:20px !important;
    background:transparent !important;
    border:none !important;
    box-shadow:none !important;
  }
  .page-title-modern{
    font-size:26px !important;
  }
  .page-subtitle-modern{
    font-size:15px !important;
  }
  
  /* Bottom navigation - FIXED positioning */
  .bottom-nav{
    position:fixed !important;
    bottom:0 !important;
    left:0 !important;
    right:0 !important;
    z-index:100 !important;
  }
  
  /* Photo gallery on mobile */
  .photo-gallery{
    margin-left:-20px !important;
    margin-right:-20px !important;
    padding:16px 20px !important;
    background:rgba(0,0,0,.2) !important;
  }
}

/* Smooth scrolling */
html{scroll-behavior:smooth}

/* Focus styles */
.btn:focus-visible,.input:focus-visible,.textarea:focus-visible,select:focus-visible{
  outline:2px solid var(--azure);
  outline-offset:2px
}

/* Link styles */
a{transition:all .2s ease}
a:focus-visible{
  outline:2px solid var(--azure);
  outline-offset:2px;
  border-radius:4px
}

/* ===================================================================
   MODERN REDESIGNED COMPONENTS - WITH ACTUAL CONTRAST
   =================================================================== */

/* Modern Page Headers */
.page-header-modern{
  background:linear-gradient(135deg,rgba(139,92,246,.12) 0%,rgba(59,130,246,.08) 100%);
  border:1.5px solid rgba(139,92,246,.25);
  border-radius:var(--br-lg);
  padding:var(--spacing-lg);
  margin-bottom:var(--spacing-xl);
  box-shadow:0 4px 24px rgba(139,92,246,.15)
}
.page-header-content{
  display:flex;
  align-items:center;
  gap:var(--spacing-md)
}
.page-icon-circle{
  width:72px;
  height:72px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  box-shadow:0 8px 24px rgba(0,0,0,.2)
}
.page-title-modern{
  font-size:28px;
  font-weight:900;
  margin:0;
  background:linear-gradient(135deg,#fff 0%,#e0e7ff 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  letter-spacing:-0.02em
}
.page-subtitle-modern{
  font-size:15px;
  opacity:.85;
  margin:6px 0 0;
  color:#cbd5e1
}

/* Modern Sections */
.modern-section{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--br-lg);
  padding:var(--spacing-lg);
  margin-bottom:var(--spacing-lg);
  transition:all .3s ease
}
.modern-section:hover{
  background:rgba(255,255,255,.05);
  border-color:rgba(255,255,255,.12);
  box-shadow:var(--e1)
}

.section-header-modern{
  display:flex;
  align-items:flex-start;
  gap:var(--spacing-md);
  margin-bottom:var(--spacing-lg)
}
.section-icon-modern{
  width:48px;
  height:48px;
  border-radius:var(--br);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  flex-shrink:0;
  box-shadow:0 4px 12px rgba(0,0,0,.15)
}
.section-title-modern{
  font-size:20px;
  font-weight:900;
  margin:0;
  color:#fff;
  letter-spacing:-0.01em
}
.section-subtitle-modern{
  font-size:14px;
  opacity:.75;
  margin:4px 0 0;
  color:#cbd5e1;
  line-height:1.5
}

/* Modern Schedule Grid */
.schedule-grid-modern{
  display:flex;
  flex-direction:column;
  gap:1px;
  background:rgba(255,255,255,.05);
  border-radius:var(--br);
  overflow:hidden;
  margin-top:var(--spacing-md)
}
.schedule-day-modern{
  background:linear-gradient(135deg,rgba(15,23,42,.95) 0%,rgba(15,23,42,.85) 100%);
  padding:clamp(14px,3vw,20px);
  display:grid;
  grid-template-columns:140px 1fr auto;
  gap:clamp(12px,2vw,20px);
  align-items:center;
  transition:all .3s cubic-bezier(.4,0,.2,1)
}
.schedule-day-modern:hover{
  background:linear-gradient(135deg,rgba(30,41,59,.98) 0%,rgba(30,41,59,.88) 100%);
  transform:translateX(2px)
}
.schedule-day-label-modern{
  display:flex;
  align-items:baseline;
  gap:10px
}
.schedule-day-name{
  font-weight:700;
  font-size:15px;
  color:#e2e8f0;
  letter-spacing:.3px
}
.schedule-day-abbr{
  font-size:12px;
  color:#94a3b8;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.5px
}
.schedule-time-inputs{
  display:flex;
  align-items:center;
  gap:12px;
  max-width:400px
}
.time-input{
  flex:1;
  min-width:0;
  padding:12px 16px !important;
  font-size:15px !important;
  font-weight:600 !important;
  background:rgba(30,41,59,.9) !important;
  border:2px solid rgba(139,92,246,.25) !important;
  border-radius:10px !important;
  color:#e2e8f0 !important;
  font-family:'SF Pro Display',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif !important;
  transition:all .25s cubic-bezier(.4,0,.2,1) !important;
  cursor:pointer;
  position:relative
}
.time-input:hover{
  background:rgba(30,41,59,1) !important;
  border-color:rgba(139,92,246,.4) !important;
  box-shadow:0 0 0 3px rgba(139,92,246,.08),0 4px 12px rgba(0,0,0,.15) !important
}
.time-input:focus{
  background:rgba(30,41,59,1) !important;
  border-color:#a78bfa !important;
  box-shadow:0 0 0 4px rgba(139,92,246,.15),0 4px 16px rgba(139,92,246,.3) !important;
  outline:none !important
}
.time-input::placeholder{
  color:#64748b !important;
  font-weight:500 !important
}
.time-input::-webkit-calendar-picker-indicator{
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23a78bfa" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>') no-repeat center;
  background-size:18px;
  cursor:pointer;
  opacity:.7;
  transition:opacity .2s
}
.time-input::-webkit-calendar-picker-indicator:hover{
  opacity:1
}
.time-separator{
  color:#64748b;
  font-weight:700;
  font-size:18px;
  flex-shrink:0;
  user-select:none
}

/* Modern Form Elements */
.time-off-form-modern{
  background:rgba(15,23,42,.5);
  border-radius:var(--br);
  padding:var(--spacing-lg);
  border:1px solid rgba(255,255,255,.08)
}
.form-row-modern{
  display:grid;
  grid-template-columns:1fr 1fr auto;
  gap:var(--spacing-md);
  align-items:end
}
.form-group-modern{
  display:flex;
  flex-direction:column;
  gap:var(--spacing-sm)
}
.label-modern{
  font-size:12px;
  font-weight:700;
  color:#94a3b8;
  text-transform:uppercase;
  letter-spacing:.8px;
  margin-bottom:2px
}
.input-modern{
  background:rgba(30,41,59,.9);
  border:2px solid rgba(139,92,246,.25);
  border-radius:10px;
  padding:12px 16px;
  color:#e2e8f0;
  font-size:15px;
  font-weight:600;
  font-family:'SF Pro Display',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  transition:all .25s cubic-bezier(.4,0,.2,1);
  min-height:48px
}
.input-modern:hover{
  border-color:rgba(139,92,246,.4);
  background:rgba(30,41,59,1);
  box-shadow:0 0 0 3px rgba(139,92,246,.08),0 4px 12px rgba(0,0,0,.15)
}
.input-modern:focus{
  outline:none;
  border-color:#a78bfa;
  background:rgba(30,41,59,1);
  box-shadow:0 0 0 4px rgba(139,92,246,.15),0 4px 16px rgba(139,92,246,.3)
}
.input-modern::placeholder{
  color:#64748b;
  font-weight:500
}
.input-modern::-webkit-calendar-picker-indicator{
  background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23a78bfa" stroke-width="2.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>') no-repeat center;
  background-size:18px;
  cursor:pointer;
  opacity:.7;
  transition:opacity .2s
}
.input-modern::-webkit-calendar-picker-indicator:hover{
  opacity:1
}
.select-modern{
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='none' viewBox='0 0 24 24' stroke='%23a78bfa' stroke-width='2.5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px center;
  background-size:20px;
  padding-right:44px;
  cursor:pointer
}

/* Modern Buttons with Color Variants */
.btn-modern{
  background:var(--gradient-primary);
  border:none;
  border-radius:var(--br-sm);
  padding:14px 28px;
  color:#fff;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
  transition:all .25s cubic-bezier(.4,0,.2,1);
  display:inline-flex;
  align-items:center;
  gap:8px;
  box-shadow:0 4px 12px rgba(20,147,255,.3);
  min-height:48px;
  white-space:nowrap
}
.btn-modern:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(20,147,255,.4)
}
.btn-modern:active{
  transform:translateY(0)
}

.btn-success{
  background:var(--gradient-success);
  box-shadow:var(--shadow-success)
}
.btn-success:hover{
  box-shadow:0 8px 20px rgba(16,185,129,.4)
}

.btn-warning{
  background:var(--gradient-warning);
  box-shadow:var(--shadow-warning)
}
.btn-warning:hover{
  box-shadow:0 8px 20px rgba(245,158,11,.4)
}

.btn-danger{
  background:var(--gradient-danger);
  box-shadow:var(--shadow-danger)
}
.btn-danger:hover{
  box-shadow:0 8px 20px rgba(239,68,68,.4)
}

.btn-purple{
  background:var(--gradient-purple);
  box-shadow:0 4px 12px rgba(139,92,246,.3)
}
.btn-purple:hover{
  box-shadow:0 8px 20px rgba(139,92,246,.4)
}

.btn-secondary{
  background:rgba(51,65,85,.9);
  border:2px solid rgba(148,163,184,.3);
  box-shadow:0 4px 12px rgba(0,0,0,.2)
}
.btn-secondary:hover{
  background:rgba(71,85,105,.9);
  border-color:rgba(148,163,184,.5);
  box-shadow:0 8px 20px rgba(0,0,0,.3)
}

.btn-icon{
  font-size:16px
}

/* Action Card (Time Off Request) */
.action-card-modern{
  position:relative;
  overflow:hidden
}
.action-card-modern::before{
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,rgba(245,158,11,.12),rgba(251,191,36,.12));
  opacity:0;
  transition:opacity .3s cubic-bezier(.4,0,.2,1)
}
.action-card-modern:hover::before{
  opacity:1
}
.action-card-modern:hover{
  border-color:rgba(245,158,11,.4);
  transform:translateY(-4px);
  box-shadow:0 12px 32px rgba(245,158,11,.2)
}
.action-card-modern:active{
  transform:translateY(-2px)
}

/* Modern Availability List */
.availability-list-modern{
  display:grid;
  gap:var(--spacing-md)
}
.availability-section-modern{
  margin-bottom:var(--spacing-lg)
}
.availability-section-title-modern{
  font-size:14px;
  font-weight:800;
  color:#94a3b8;
  margin:0 0 var(--spacing-md);
  text-transform:uppercase;
  letter-spacing:1px;
  padding-bottom:8px;
  border-bottom:2px solid rgba(255,255,255,.05)
}
.availability-item-modern{
  background:linear-gradient(135deg,rgba(30,41,59,.6) 0%,rgba(15,23,42,.5) 100%);
  border:1.5px solid rgba(255,255,255,.08);
  border-left:4px solid var(--purple);
  border-radius:var(--br);
  padding:var(--spacing-md);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:var(--spacing-md);
  transition:all .25s ease
}
.availability-item-modern:hover{
  background:linear-gradient(135deg,rgba(30,41,59,.8) 0%,rgba(15,23,42,.7) 100%);
  border-color:rgba(255,255,255,.15);
  transform:translateX(4px);
  box-shadow:0 4px 16px rgba(0,0,0,.2)
}
.availability-item-modern.type-weekly{border-left-color:var(--purple)}
.availability-item-modern.type-vacation{border-left-color:var(--orange)}
.availability-item-modern.type-blocked{border-left-color:var(--cyan)}

.availability-info-modern{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:4px
}
.availability-type-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 12px;
  border-radius:6px;
  font-size:12px;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:.5px;
  width:fit-content
}
.availability-type-badge.weekly{
  background:rgba(139,92,246,.15);
  color:var(--purple-light);
  border:1px solid rgba(139,92,246,.3)
}
.availability-type-badge.vacation{
  background:rgba(245,158,11,.15);
  color:var(--orange-light);
  border:1px solid rgba(245,158,11,.3)
}
.availability-type-badge.blocked{
  background:rgba(6,182,212,.15);
  color:var(--cyan-light);
  border:1px solid rgba(6,182,212,.3)
}
.availability-details-modern{
  font-size:15px;
  color:#e2e8f0;
  font-weight:600
}

.btn-delete-modern{
  background:rgba(239,68,68,.15);
  border:1.5px solid rgba(239,68,68,.3);
  border-radius:var(--br-sm);
  padding:8px 16px;
  color:var(--red-light);
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  transition:all .2s ease;
  white-space:nowrap
}
.btn-delete-modern:hover{
  background:rgba(239,68,68,.25);
  border-color:rgba(239,68,68,.5);
  transform:scale(1.05);
  box-shadow:var(--shadow-danger)
}

/* Empty State - Modern */
.empty-state-modern{
  text-align:center;
  padding:var(--spacing-2xl) var(--spacing-lg);
  background:rgba(15,23,42,.4);
  border:2px dashed rgba(255,255,255,.1);
  border-radius:var(--br-lg);
  margin:var(--spacing-lg) 0
}
.empty-state-icon-modern{
  font-size:64px;
  margin-bottom:var(--spacing-md);
  opacity:.5;
  filter:grayscale(.5)
}
.empty-state-title-modern{
  font-size:18px;
  font-weight:700;
  color:#e2e8f0;
  margin:0 0 var(--spacing-sm)
}
.empty-state-text-modern{
  font-size:14px;
  opacity:.75;
  color:#cbd5e1;
  margin:0 0 var(--spacing-lg);
  line-height:1.6
}

/* Schedule & Availability Styles (OLD - KEEP FOR BACKWARDS COMPAT) */
.schedule-grid{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-bottom:16px
}
.schedule-day{
  display:grid;
  grid-template-columns:80px 1fr 1fr 120px;
  gap:12px;
  align-items:center;
  padding:12px;
  background:rgba(255,255,255,.05);
  border-radius:var(--br);
  border:1px solid rgba(255,255,255,.1);
  transition:all .2s ease
}
.schedule-day:hover{
  background:rgba(255,255,255,.08);
  border-color:rgba(255,255,255,.2)
}
.schedule-day-label{
  font-weight:600;
  font-size:14px;
  color:#9bc8ff
}
.schedule-day input[type="time"]{
  background:rgba(0,0,0,.3);
  border:1px solid rgba(255,255,255,.15);
  color:#fff;
  padding:8px 12px;
  border-radius:8px;
  font-size:14px;
  transition:all .2s ease
}
.schedule-day input[type="time"]:focus{
  border-color:var(--azure);
  background:rgba(0,0,0,.4);
  outline:none
}
.schedule-day .btn-save{
  padding:8px 16px;
  font-size:14px;
  min-height:38px
}
.availability-list{
  display:flex;
  flex-direction:column;
  gap:10px
}
.availability-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px;
  background:rgba(255,255,255,.05);
  border-radius:var(--br);
  border:1px solid rgba(255,255,255,.1);
  transition:all .2s ease
}
.availability-item:hover{
  background:rgba(255,255,255,.08);
  border-color:rgba(255,255,255,.2)
}
.availability-item-info{
  flex:1
}
.availability-item-type{
  display:inline-block;
  padding:4px 10px;
  border-radius:6px;
  font-size:12px;
  font-weight:600;
  margin-right:8px
}
.availability-type-weekly{
  background:rgba(20,147,255,.2);
  color:#60b5ff
}
.availability-type-vacation{
  background:rgba(251,191,36,.2);
  color:#fbbf24
}
.availability-type-blocked{
  background:rgba(239,68,68,.2);
  color:#f87171
}
.availability-item-details{
  color:#9bc8ff;
  font-size:14px;
  margin-top:4px
}
.btn-delete-avail{
  appearance:none;
  background:rgba(239,68,68,.15);
  border:1px solid rgba(239,68,68,.3);
  color:#f87171;
  padding:6px 12px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease
}
.btn-delete-avail:hover{
  background:rgba(239,68,68,.25);
  border-color:rgba(239,68,68,.5);
  transform:translateY(-1px)
}
.btn-delete-avail:active{
  transform:translateY(0)
}
.btn-success{
  appearance:none;
  background:var(--success);
  border:none;
  color:#fff;
  padding:10px 20px;
  border-radius:var(--br);
  font-size:15px;
  font-weight:700;
  cursor:pointer;
  transition:all .2s ease;
  box-shadow:var(--e1);
  min-height:44px
}
.btn-success:hover{
  background:#0d9668;
  transform:translateY(-1px);
  box-shadow:var(--e2)
}
.btn-success:active{
  transform:translateY(0);
  box-shadow:var(--e1)
}

/* Data Health Dashboard Styles */
.kpi-card{
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.12);
  border-radius:var(--br);
  padding:20px;
  box-shadow:var(--e1);
  transition:all .2s ease
}
.kpi-card:hover{
  border-color:rgba(255,255,255,.2);
  box-shadow:var(--e2);
  transform:translateY(-2px)
}
.kpi-card.warn{
  background:linear-gradient(135deg,rgba(251,191,36,.15) 0%,rgba(217,119,6,.1) 100%);
  border-color:rgba(251,191,36,.3)
}
.kpi-card.info{
  background:linear-gradient(135deg,rgba(20,147,255,.15) 0%,rgba(15,122,204,.1) 100%);
  border-color:rgba(20,147,255,.3)
}
.kpi-card.success{
  background:linear-gradient(135deg,rgba(16,185,129,.15) 0%,rgba(5,150,105,.1) 100%);
  border-color:rgba(16,185,129,.3)
}
.kpi-label{
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:.5px;
  color:#9bc8ff;
  margin-bottom:8px;
  font-weight:600
}
.kpi-value{
  font-size:36px;
  font-weight:900;
  color:#fff;
  line-height:1;
  margin-bottom:6px
}
.kpi-sublabel{
  font-size:13px;
  color:rgba(255,255,255,.6)
}
.link-todo-item{
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.12);
  border-radius:var(--br);
  padding:16px;
  margin-bottom:12px;
  transition:all .2s ease
}
.link-todo-item:hover{
  border-color:rgba(255,255,255,.2);
  box-shadow:var(--e1)
}
.link-todo-item-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:12px
}
.link-todo-item-name{
  font-size:16px;
  font-weight:700;
  color:#fff;
  margin-bottom:4px
}
.link-todo-item-search{
  font-size:13px;
  color:#9bc8ff;
  margin-bottom:8px
}
.link-todo-item-priority{
  display:inline-block;
  padding:4px 10px;
  border-radius:6px;
  font-size:12px;
  font-weight:600;
  background:rgba(251,191,36,.2);
  color:#fbbf24
}
.link-todo-item-priority.high{
  background:rgba(239,68,68,.2);
  color:#f87171
}
.link-todo-item-actions{
  display:flex;
  gap:8px;
  align-items:center;
  margin-top:12px
}
.link-todo-item-input{
  flex:1;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.2);
  color:#fff;
  padding:10px 14px;
  border-radius:8px;
  font-size:14px;
  transition:all .2s ease
}
.link-todo-item-input:focus{
  outline:none;
  border-color:var(--azure);
  background:rgba(255,255,255,.12);
  box-shadow:0 0 0 3px rgba(20,147,255,.2)
}
.link-todo-item-input::placeholder{
  color:rgba(255,255,255,.4)
}
.btn-save-link{
  appearance:none;
  background:var(--azure);
  border:none;
  color:#fff;
  padding:10px 16px;
  border-radius:8px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
  white-space:nowrap
}
.btn-save-link:hover{
  background:var(--azure-dark);
  transform:translateY(-1px);
  box-shadow:var(--e1)
}
.btn-save-link:active{
  transform:translateY(0)
}
.btn-search-retailer{
  appearance:none;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.2);
  color:#9bc8ff;
  padding:10px 14px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
  white-space:nowrap
}
.btn-search-retailer:hover{
  background:rgba(255,255,255,.12);
  border-color:rgba(255,255,255,.3);
  color:#fff
}
.improvement-item{
  background:var(--gradient-card);
  border:1px solid rgba(255,255,255,.12);
  border-radius:var(--br);
  padding:16px;
  margin-bottom:12px;
  transition:all .2s ease
}
.improvement-item:hover{
  border-color:rgba(255,255,255,.2);
  box-shadow:var(--e1)
}
.improvement-item-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:10px
}
.improvement-item-title{
  font-size:16px;
  font-weight:700;
  color:#fff;
  margin-bottom:6px
}
.improvement-item-service{
  font-size:13px;
  color:#60b5ff;
  font-weight:600
}
.improvement-item-stats{
  font-size:13px;
  color:#9bc8ff;
  margin-bottom:12px
}
.improvement-item-confidence{
  display:inline-block;
  padding:4px 10px;
  border-radius:6px;
  font-size:12px;
  font-weight:600;
  background:rgba(16,185,129,.2);
  color:#10b981;
  margin-left:8px
}
.improvement-item-confidence.medium{
  background:rgba(251,191,36,.2);
  color:#fbbf24
}
.improvement-item-confidence.low{
  background:rgba(239,68,68,.2);
  color:#f87171
}
.improvement-item-actions{
  display:flex;
  gap:8px;
  margin-top:12px
}
.btn-approve-bom{
  appearance:none;
  background:var(--success);
  border:none;
  color:#fff;
  padding:10px 16px;
  border-radius:8px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease
}
.btn-approve-bom:hover{
  background:#0d9668;
  transform:translateY(-1px);
  box-shadow:var(--e1)
}
.btn-approve-bom:active{
  transform:translateY(0)
}
.btn-reject-bom{
  appearance:none;
  background:rgba(239,68,68,.15);
  border:1px solid rgba(239,68,68,.3);
  color:#f87171;
  padding:10px 16px;
  border-radius:8px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease
}
.btn-reject-bom:hover{
  background:rgba(239,68,68,.25);
  border-color:rgba(239,68,68,.5)
}
.ai-suggestion-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  background:linear-gradient(135deg,rgba(168,85,247,.2) 0%,rgba(147,51,234,.15) 100%);
  border:1px solid rgba(168,85,247,.3);
  color:#c084fc;
  margin-left:8px
}
.needs-review-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  background:rgba(251,191,36,.2);
  border:1px solid rgba(251,191,36,.3);
  color:#fbbf24;
  margin-left:8px
}

/* Loading animations */
@keyframes loadingDots{
  0%,20%{opacity:.2}
  50%{opacity:1}
  100%{opacity:.2}
}
.loading-dots{
  animation:loadingDots 1.4s infinite;
  letter-spacing:4px
}
@keyframes btnSpinner{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}
/* ✅ PERFORMANCE: Add will-change for spinner animation optimization */
.btn-spinner{
  display:inline-block;
  width:12px;
  height:12px;
  border:2px solid rgba(255,255,255,.3);
  border-top-color:#fff;
  border-radius:50%;
  animation:btnSpinner .6s linear infinite;
  margin-right:6px;
  vertical-align:middle;
  will-change:transform
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}
.fade-in{
  animation:fadeIn .4s ease-out
}
/* ✅ PERFORMANCE: Use transform (GPU-accelerated) instead of max-height */
@keyframes slideDown{
  from{transform:translateY(-10px) scaleY(0.95);opacity:0;transform-origin:top}
  to{transform:translateY(0) scaleY(1);opacity:1;transform-origin:top}
}
.slide-down{
  animation:slideDown .5s ease-out;
  overflow:hidden
}

/* Buy list improvements */
#adBuyListResults{
  transition:all .3s ease
}
#adBuyListStatus{
  min-height:44px;
  display:flex;
  align-items:center
}

/* ========================================
   ENHANCED MOBILE OPTIMIZATION
   ======================================== */

/* Tablet and smaller */
/* ===================================================================
   MOBILE RESPONSIVE - MODERN COMPONENTS
   =================================================================== */
/* ===== RESPONSIVE ===== */
@media (min-width:769px){
  .support{display:inline-flex}
  .menu-btn{display:flex}
}

@media (max-width:768px){
  .support{display:none}
  .menu-btn{display:none} /* Hidden by default */
  .menu-btn[data-on="1"]{display:flex !important} /* Only show when logged in */
  
  /* Modern Page Headers */
  .page-header-content{flex-direction:column;text-align:center}
  .page-icon-circle{width:64px;height:64px;margin:0 auto}
  .page-title-modern{font-size:24px}
  
  /* Modern Schedule Grid */
  .schedule-day-modern{
    grid-template-columns:1fr;
    gap:12px;
    padding:16px
  }
  .schedule-day-label-modern{
    padding-bottom:8px;
    border-bottom:1px solid rgba(255,255,255,.1)
  }
  .schedule-time-inputs{
    max-width:100%
  }
  .btn-modern{
    width:100%
  }
  .schedule-day-label-modern{
    justify-content:center;
    padding-bottom:var(--spacing-sm);
    border-bottom:1px solid rgba(255,255,255,.1)
  }
  
  /* Modern Forms */
  .form-row-modern{
    grid-template-columns:1fr;
    gap:var(--spacing-md)
  }
  .btn-modern{
    width:100%;
    justify-content:center
  }
  
  /* Modern Availability Items */
  .availability-item-modern{
    flex-direction:column;
    align-items:flex-start;
    gap:var(--spacing-sm)
  }
  .btn-delete-modern{
    width:100%;
    text-align:center
  }
  
  /* Resources grid responsive */
  .resources-list{
    grid-template-columns:1fr;
    max-height:none;
  }
  
  .resource-item{
    flex-direction:column;
    align-items:flex-start;
    text-align:left;
  }
  
  .resource-download{
    width:100%;
    text-align:center;
  }
  
  /* Sections */
  .modern-section{
    padding:var(--spacing-md)
  }
  .section-header-modern{
    flex-direction:column;
    text-align:center;
    align-items:center
  }
  
  /* Empty State */
  .empty-state-modern{
    padding:var(--spacing-lg)
  }
  .empty-state-icon-modern{
    font-size:48px
  }
  
  /* Buy list table optimization */
  #adBuyListResults table{
    font-size:13px;
    display:block;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch
  }
  #adBuyListResults td,
  #adBuyListResults th{
    padding:8px 6px !important
  }
  
  /* Badges and labels */
  .ai-suggestion-badge,
  .needs-review-badge{
    font-size:11px;
    padding:4px 8px;
    margin-left:4px
  }
  
  /* Better button sizing on mobile */
  #btnGenerateBuyList{
    width:100%;
    max-width:320px;
    margin:0 auto;
    display:block
  }
  
  /* Make action buttons in table more mobile-friendly */
  #adBuyListResults table .btn{
    padding:6px 12px !important;
    font-size:12px !important;
    white-space:nowrap
  }
  
  /* Job cards - stack vertically on tablets */
  .job-card{
    padding:12px !important;
    margin-bottom:12px !important
  }
  
  .job-card-header{
    flex-direction:column;
    align-items:flex-start !important;
    gap:8px !important
  }
  
  /* Modal adjustments for tablets */
  .modal-content{
    width:95%;
    max-width:100%;
    margin:20px auto;
    padding:16px !important
  }
  
  /* Form inputs full width */
  input[type="text"],
  input[type="email"],
  input[type="tel"],
  input[type="number"],
  select,
  textarea{
    width:100% !important;
    max-width:100% !important;
    box-sizing:border-box
  }
  
  /* Touch-friendly buttons */
  .btn{
    min-height:44px;
    padding:10px 16px !important;
    font-size:14px !important;
    touch-action:manipulation
  }
  
  /* AI Notes section on mobile */
  .ai-notes-section{
    padding:12px !important;
    margin:12px 0 !important
  }
  
  .ai-notes-section li{
    font-size:13px !important;
    padding:6px 0 !important
  }
}

/* Mobile phones */
@media (max-width:480px){
  /* Stack totals summary on very small screens */
  #adBuyListResults > div{
    flex-direction:column !important;
    align-items:flex-start !important;
    gap:10px !important
  }
  
  /* Header adjustments */
  .header{
    padding:10px 12px !important
  }
  
  .h2s-logo img{
    width:120px !important;
    height:auto !important
  }
  
  /* Main title sizing */
  .h1{
    font-size:24px !important;
    margin-bottom:16px !important
  }
  
  .h2{
    font-size:20px !important
  }
  
  .h3{
    font-size:18px !important
  }
  
  /* Buy list - force single column on phones */
  #adBuyListResults table{
    font-size:12px !important
  }
  
  #adBuyListResults thead{
    display:none /* Hide header on small screens */
  }
  
  #adBuyListResults tbody tr{
    display:block;
    border:1px solid #ddd;
    border-radius:6px;
    margin-bottom:10px;
    padding:10px;
    background:#fff
  }
  
  #adBuyListResults tbody td{
    display:block;
    text-align:left !important;
    padding:6px 0 !important;
    border:none !important
  }
  
  #adBuyListResults tbody td:before{
    content:attr(data-label);
    font-weight:600;
    display:inline-block;
    width:80px;
    margin-right:10px;
    color:#666
  }
  
  /* Job info section - compact layout */
  .job-info-grid{
    grid-template-columns:1fr !important;
    gap:8px !important
  }
  
  /* Smaller spacing on mobile */
  .container{
    padding:12px !important
  }
  
  section{
    margin-bottom:20px !important;
    padding:12px !important
  }
  
  /* Navigation menu full screen on mobile */
  .menu-sheet{
    width:100% !important;
    max-width:100% !important
  }
  
  /* Status badges smaller on mobile */
  .status-badge{
    font-size:11px !important;
    padding:4px 8px !important
  }
}

@media (max-width:768px){
  .schedule-day{
    grid-template-columns:1fr;
    gap:8px
  }
  .schedule-day-label{
    text-align:left
  }
  
  /* Account tab responsive - stack sections on mobile */
  #tab-profile > div[style*="grid-template-columns"] {
    grid-template-columns: 1fr !important;
  }
  
  /* Photo upload section - better mobile layout */
  #pfPhotoPreview {
    width: 100px !important;
    height: 100px !important;
  }
}

/* ========================================
   🔴 REAL-TIME DASHBOARD ANIMATIONS
   ======================================== */
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

@keyframes slideInRight {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* New job highlight effect */
.job-new-highlight {
  animation: fadeIn 0.5s ease, highlightPulse 2s ease;
}

@keyframes highlightPulse {
  0% { background: rgba(102, 126, 234, 0.1); }
  50% { background: rgba(102, 126, 234, 0.2); }
  100% { background: transparent; }
}

</style>
<!-- Global safety shims to ensure all referenced functions exist and prevent runtime crashes -->
<script>
  // Console safety
  (function(){
    var noop=function(){};
    var c=window.console||(window.console={});
    ['log','info','warn','error','debug','table','trace'].forEach(function(m){ if(typeof c[m]!=='function'){ c[m]=noop; } });
  })();

  // requestIdleCallback polyfill
  window.requestIdleCallback = window.requestIdleCallback || function(cb){
    var start = Date.now();
    return setTimeout(function(){ cb({ didTimeout:false, timeRemaining:function(){ return Math.max(0, 50 - (Date.now()-start)); } }); }, 1);
  };
  window.cancelIdleCallback = window.cancelIdleCallback || function(id){ clearTimeout(id); };

  // AnimationFrame safety
  window.requestAnimationFrame = window.requestAnimationFrame || function(cb){ return setTimeout(cb,16); };
  window.cancelAnimationFrame = window.cancelAnimationFrame || function(id){ clearTimeout(id); };

  // Meta Pixel stub to avoid "fbq is not defined" errors in non-pixel environments
  if(typeof window.fbq!=='function'){
    var queue=[]; var fbq=function(){ queue.push(arguments); };
    fbq.callMethod=function(){}; fbq.push=function(){}; fbq.loaded=true; fbq.version='2.0'; fbq.queue=queue;
    window.fbq=fbq; window._fbq=fbq;
  }

  // Helper: $ by id (if not already defined later)
  if(typeof window.$!=="function"){ window.$=function(id){ return document.getElementById(id); }; }

  // Guard critical app functions referenced later; provide minimal no-op implementations
  function defineNoop(name){ if(typeof window[name]!=="function"){ window[name]=function(){ /* noop */ }; } }
  ['showLoader','hideLoader','showModal','closeModal','toggleMenu','toggleCart','closeAll','updateCartBadge']
    .forEach(defineNoop);

  // Guards for data loaders that may be deferred by route/state
  ['loadJobs','adminLoadJobs','loadHeroReviews','loadReviews','renderShop','renderShopSuccess']
    .forEach(function(n){ if(typeof window[n]!=="function"){ window[n]=async function(){ /* noop: deferred */ return null; }; } });

  // showToast minimal fallback (replaced by full implementation later in file)
  if(typeof window.showToast!=="function"){
    window.showToast=function(message,type){ try{ var t=document.createElement('div'); t.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0b2d5f;color:#fff;padding:10px 14px;border-radius:10px;z-index:30000;box-shadow:0 6px 20px rgba(0,0,0,.3)'; t.textContent=String(message||''); document.body.appendChild(t); setTimeout(function(){ t.remove(); }, 2500); }catch(e){ /* ignore */ } };
  }
</script>
<!-- Media deletion confirmation logic + notification dedupe + payout helpers -->
<script>
  // Delete media confirm modal controller
  (function(){
    const overlay = document.getElementById('deleteConfirmOverlay');
    if(!overlay) return;
    const preview = document.getElementById('deleteConfirmPreview');
    const btnCancel = document.getElementById('deleteConfirmCancel');
    const btnConfirm = document.getElementById('deleteConfirmConfirm');
    let currentItem = null; // { id, type:'image'|'video', src, onDelete }

    function openDeleteConfirm(item){
      currentItem = item || null;
      // Paint preview
      preview.innerHTML = '';
      if(item?.type==='video'){
        const v = document.createElement('video'); v.src=item.src; v.controls=true; v.style.maxWidth='100%'; v.style.maxHeight='240px'; preview.appendChild(v);
      }else{
        const img = document.createElement('img'); img.src=item?.src||''; img.alt='Selected media'; img.style.maxWidth='100%'; img.style.maxHeight='240px'; preview.appendChild(img);
      }
      overlay.style.display='grid'; overlay.setAttribute('aria-hidden','false');
    }
    function closeDeleteConfirm(){ overlay.style.display='none'; overlay.setAttribute('aria-hidden','true'); preview.innerHTML=''; currentItem=null; }
    btnCancel.onclick = closeDeleteConfirm;
    btnConfirm.onclick = async function(){
      try{
        if(currentItem && typeof currentItem.onDelete==='function'){
          await currentItem.onDelete(currentItem.id);
        }
        showToast('Media removed','success');
      }catch(err){ console.error('Delete media failed', err); showToast('Delete failed','error'); }
      finally{ closeDeleteConfirm(); }
    };
    // Expose
    window.openDeleteConfirm = openDeleteConfirm;
    window.closeDeleteConfirm = closeDeleteConfirm;
  })();

  // New job notification dedupe cache
  (function(){
    const KEY='seenJobIds';
    function getSeen(){ try{ return new Set(JSON.parse(localStorage.getItem(KEY)||'[]')); }catch(e){ return new Set(); } }
    function addSeen(id){ try{ const s=getSeen(); s.add(String(id)); localStorage.setItem(KEY, JSON.stringify(Array.from(s).slice(-500))); }catch(e){} }
    window.shouldNotifyNewJob = function(jobId){ const s=getSeen(); const id=String(jobId||''); const isNew = id && !s.has(id); if(isNew) addSeen(id); return isNew; };
  })();

  // Payout helpers (AUTHORITATIVE - mirrors Operations.js PAYOUT_POLICY)
  (function(){
    const fmtMoney = (v)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(Number(v||0));
    
    // PAYOUT_POLICY: Centralized rates matching backend (Operations.js)
    const PAYOUT_POLICY = {
      materials_pct_estimate: { BYO: 0.00, BASE: 0.28, H2S: 0.38 },
      pro_pct_on_labor: { BYO: 0.75, BASE: 0.65, H2S: 0.60 },
      min_payout_floor: 45,
      max_payout_cap_pct: 0.90
    };
    
    function _tierFromVariant(variantCode){
      const v = String(variantCode||'').trim().toUpperCase();
      if(v==='BYO') return 'BYO';
      if(v==='BASE') return 'BASE';
      if(v==='H2S') return 'H2S';
      return 'BASE';
    }
    
    // Compute pro payout for a single job line (customer_total, variant_code)
    function _computeProPayoutForLine(lineCustomerTotal, variantCode){
      const P = PAYOUT_POLICY;
      const price = Number(lineCustomerTotal||0) || 0;
      const tier = _tierFromVariant(variantCode);
      const matPct = P.materials_pct_estimate[tier] || 0;
      const laborBase = Math.max(0, price - (price * matPct));
      const pct = P.pro_pct_on_labor[tier] || 0.55;
      const raw = laborBase * pct;
      const capped = Math.min(raw, price * P.max_payout_cap_pct);
      const finalAmt = Math.max(P.min_payout_floor, capped);
      return Math.round(finalAmt * 100) / 100;
    }
    
    // Compute total payout for a job with multiple lines
    // job.lines: [{ customer_total, variant_code }]
    window.computePayoutForJob = function(job){
      // Support both legacy 'lines' and new 'line_items'
      const lines = job?.line_items || job?.lines || [];
      let lineTotal = 0;
      lines.forEach(ln => {
        lineTotal += _computeProPayoutForLine(ln.customer_total, ln.variant_code);
      });
      
      // If no lines but job has direct payout fields, use them
      // Priority: payout_estimated (from API) > base_pay (legacy)
      const estimated = Number(job?.payout_estimated || 0);
      const base = Number(job?.base_pay || job?.payout_base || 0);
      const extras = Number(job?.extras_total || job?.payout_extras || 0);
      const deductions = Number(job?.deductions_total || job?.payout_deductions || 0);
      
      let directTotal = 0;
      if (estimated > 0) {
          directTotal = estimated;
      } else {
          directTotal = base + extras - deductions;
      }
      
      const total = lines.length > 0 ? lineTotal : Math.max(0, directTotal);
      
      // If we have a hard estimated payout from backend, prefer that over calculation
      const finalTotal = (estimated > 0 && lines.length === 0) ? estimated : total;

      return { 
        base, 
        extras, 
        deductions, 
        lineTotal, 
        total: finalTotal, 
        label: fmtMoney(finalTotal) 
      };
    };
    
    // Compute payout for a single line item (for detail breakdown)
    window.computePayoutForLine = function(lineCustomerTotal, variantCode){
      const amt = _computeProPayoutForLine(lineCustomerTotal, variantCode);
      return { amount: amt, label: fmtMoney(amt) };
    };
    
    // Format currency
    window.fmtMoney = fmtMoney;
  })();
</script>

<!-- Supabase Client for Real-time Updates -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>
<body>
<header class="header">
  <a class="h2s-logo" href="#" aria-label="Home2Smart home">
    <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart logo" width="156" height="52" loading="eager" fetchpriority="high" decoding="async">
  </a>
  <div class="header-right">
    <a id="supportLink" class="support" href="mailto:contact@home2smart.com">Support</a>
    <button id="openMenu" class="menu-btn" aria-label="Open menu" type="button"><span class="menu-ic"></span></button>
  </div>
</header>

<div id="menu" class="menu-overlay" aria-hidden="true">
  <div class="menu-sheet" role="dialog" aria-labelledby="menuTitle">
    <h2 id="menuTitle" class="visually-hidden">Navigation menu</h2>
    <div class="menu-row" id="menuItems"></div>
    <div class="menu-close"><button id="closeMenu" class="btn secondary" type="button">Close</button></div>
  </div>
</div>

<main class="main">
  <div class="container">
    <h1 class="h1" id="portalTitle">Pro portal</h1>

    <section id="view-auth" class="view card" aria-hidden="false">
      <div id="step-signin">
        <h2>Sign in</h2>
        <div class="grid-2">
          <div><label class="label" for="siEmail">Email</label><input id="siEmail" class="input" type="email" placeholder="you@example.com" autocomplete="email"></div>
          <div><label class="label" for="siZip">ZIP code</label><input id="siZip" class="input" inputmode="numeric" placeholder="#####" autocomplete="postal-code"></div>
        </div>
        <div style="margin:12px 0;display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="siRemember" checked style="width:16px;height:16px;accent-color:#3b82f6">
            <label for="siRemember" style="font-size:14px;color:#cbd5e1;cursor:pointer">Remember me</label>
        </div>
        <div class="row">
          <button id="btnSignIn" class="btn" type="button">Sign in</button>
          <button id="btnStartSignup" class="btn secondary" type="button">First time? Sign up</button>
        </div>
        <div id="err" class="error" role="alert"></div>
        
        <!-- Helpful reminder about last used email -->
        <div id="lastEmailReminder" style="display:none;margin-top:16px;padding:12px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.2);border-radius:8px">
          <p style="margin:0;font-size:13px;color:#94a3b8">
            <strong style="color:#60a5fa">Tip:</strong> Last account created: <strong id="lastEmailUsed" style="color:#e0f2fe"></strong>
          </p>
        </div>
      </div>

      <div id="step-info" style="display:none;margin-top:8px">
        <h2>Your info</h2>
        <div class="grid-2">
          <div><label class="label" for="piName">Full name</label><input id="piName" class="input" placeholder="Jane Doe" autocomplete="name"></div>
          <div><label class="label" for="piEmail">Email</label><input id="piEmail" class="input" type="email" placeholder="you@example.com" autocomplete="email"></div>
        </div>
        <div class="grid-2">
          <div><label class="label" for="piPhone">Phone</label><input id="piPhone" class="input" type="tel" placeholder="(###) ###-####" autocomplete="tel"></div>
          <div></div>
        </div>
        <div class="row"><button id="toAddress" class="btn" type="button">Continue</button><button id="backToSignIn" class="btn secondary" type="button">Back</button></div>
        <div id="err-info" class="error" role="alert"></div>
      </div>

      <div id="step-address" style="display:none;margin-top:8px">
        <h2>Your address</h2>
        <div class="grid-2">
          <div style="position:relative">
            <label class="label" for="adStreet">Address</label>
            <input id="adStreet" class="input" placeholder="123 Main St" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <div id="adStreetDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:#1e293b;border:1px solid rgba(59,130,246,0.3);border-radius:8px;margin-top:4px;max-height:240px;overflow-y:auto;z-index:1000;box-shadow:0 10px 25px rgba(0,0,0,0.3)"></div>
          </div>
          <div><label class="label" for="adCity">City</label><input id="adCity" class="input" placeholder="Charlotte" autocomplete="off"></div>
        </div>
        <div class="grid-2">
          <div><label class="label" for="adState">State</label><input id="adState" class="input" placeholder="NC" autocomplete="off"></div>
          <div><label class="label" for="adZip">ZIP</label><input id="adZip" class="input" inputmode="numeric" placeholder="28202" autocomplete="off"></div>
        </div>
        <p class="muted">We use this to match you to nearby jobs.</p>
        <div class="row"><button id="finishStep1" class="btn" type="button">Create account</button><button id="backToInfo" class="btn secondary" type="button">Back</button></div>
        <div id="err-address" class="error" role="alert"></div>
      </div>
    </section>

    <section id="view-portal" class="view" aria-hidden="true">
      <div id="tab-dash" class="card">
        
        <!-- COMMUNICATION HUB - Always visible culture/announcement section -->
        <div id="communicationHub" style="background:linear-gradient(135deg, rgba(59,130,246,0.12) 0%, rgba(16,185,129,0.08) 100%);border:1px solid rgba(59,130,246,0.25);border-radius:16px;padding:24px;margin-bottom:28px;position:relative;overflow:hidden">
          
          <!-- Default Culture Message (shows when no announcements) -->
          <div id="cultureSloganSection" style="display:none;text-align:center">
            <h3 style="margin:0 0 10px 0;font-size:22px;font-weight:700;color:#e0f2fe;letter-spacing:-0.02em">Excellence in Every Service</h3>
            <p style="margin:0;font-size:15px;color:#94a3b8;line-height:1.6;max-width:600px;margin:0 auto">Home2Smart pros deliver premium service with professionalism, integrity, and care. Every job is an opportunity to exceed expectations.</p>
          </div>

          <!-- Active Announcements Section (shows when announcements exist) -->
          <div id="activeAnnouncementsSection" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
              <div style="display:flex;align-items:center;gap:12px;cursor:pointer" onclick="openAnnouncementsModal()" class="announcement-header-clickable">
                <div style="width:44px;height:44px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(59,130,246,0.3);color:white" class="announcement-icon">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 8.35V2.54a.5.5 0 0 0-.74-.43l-8.55 5.03a2 2 0 0 1-.97.25H4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2.5a2 2 0 0 1 .8.17l3.7 1.48a2 2 0 0 0 1.6.04l6.66-2.66a.5.5 0 0 0 .74-.43V8.35z"></path><path d="M22 8.35A5.5 5.5 0 0 1 22 18.5"></path></svg>
                </div>
                <div>
                  <h3 style="margin:0;font-size:19px;font-weight:700;color:#f1f5f9;letter-spacing:-0.01em" class="announcement-title">Team Updates</h3>
                  <p style="margin:0;font-size:13px;color:#94a3b8;margin-top:2px" id="announcementCount" class="announcement-subtitle">New messages from dispatch</p>
                </div>
              </div>
              <button id="btnViewAllAnnouncements" onclick="openAnnouncementsModal()" style="background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#60a5fa;padding:8px 18px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(59,130,246,0.25)'" onmouseout="this.style.background='rgba(59,130,246,0.15)'" class="view-all-btn">View All</button>
            </div>

            <!-- Announcement Cards Container -->
            <div id="announcementCardsContainer" style="display:flex;flex-direction:column;gap:14px">
              <!-- Dynamically populated announcement cards -->
            </div>
          </div>

          <!-- Decorative gradient overlay -->
          <div style="position:absolute;top:0;right:0;width:200px;height:200px;background:radial-gradient(circle at center, rgba(59,130,246,0.08) 0%, transparent 70%);pointer-events:none;opacity:0.6"></div>
        </div>

        <h2 style="margin-top:32px">Pending offers</h2>
        <div id="list-offers" class="list"></div>
        <p class="muted" id="offers-empty" style="display:none">No pending offers.</p>

        <h2 style="margin-top:22px">Upcoming jobs</h2>
        <div id="list-upcoming" class="list"></div>
        <p class="muted" id="upcoming-empty" style="display:none">No accepted upcoming jobs.</p>

        <h2 style="margin-top:22px">Completed jobs</h2>
        <div id="list-completed" class="list"></div>
        <p class="muted" id="completed-empty" style="display:none">No completed jobs yet.</p>
      </div>

      <div id="tab-customers" class="card" style="display:none">
        <!-- Tab Switcher -->
        <div style="display:flex;gap:12px;margin-bottom:32px;border-bottom:2px solid rgba(148,163,184,.1);padding-bottom:0">
          <button id="btnCustomersToCall" class="customer-tab-btn active" onclick="switchCustomerTab('to-call')" type="button" style="background:none;border:none;padding:16px 24px;font-size:15px;font-weight:700;color:#60a5fa;cursor:pointer;position:relative;transition:all .2s;border-bottom:3px solid #3b82f6">
            To Call
          </button>
          <button id="btnCustomersHistory" class="customer-tab-btn" onclick="switchCustomerTab('history')" type="button" style="background:none;border:none;padding:16px 24px;font-size:15px;font-weight:700;color:#64748b;cursor:pointer;position:relative;transition:all .2s;border-bottom:3px solid transparent">
            📋 Customer History
          </button>
        </div>

        <!-- TO CALL VIEW -->
        <div id="customers-to-call-view">
          <div style="margin-bottom:24px">
            <h2 style="margin:0 0 8px;font-size:22px;font-weight:700;color:#e0f2fe">Upcoming Appointments</h2>
            <p class="muted" style="margin:0;font-size:14px">Reach out before the job - next 7 days</p>
          </div>

          <div id="customers-list" style="display:grid;gap:16px">
            <div class="skeleton" style="height:140px;border-radius:14px"></div>
            <div class="skeleton" style="height:140px;border-radius:14px"></div>
          </div>

          <div id="customers-empty" style="display:none;text-align:center;padding:60px 20px;color:#94a3b8">
            <div style="font-size:18px;font-weight:600;margin-bottom:8px">All caught up!</div>
            <div style="font-size:14px;opacity:.8">No upcoming appointments to call about right now</div>
          </div>
        </div>

        <!-- CUSTOMER HISTORY VIEW -->
        <div id="customers-history-view" style="display:none">
          <div style="margin-bottom:24px">
            <h2 style="margin:0 0 8px;font-size:22px;font-weight:700;color:#e0f2fe">Past Customers</h2>
            <p class="muted" style="margin:0;font-size:14px">Everyone you've served - your customer database</p>
          </div>

          <div id="customers-history-list" style="display:grid;gap:16px">
            <div class="skeleton" style="height:120px;border-radius:14px"></div>
            <div class="skeleton" style="height:120px;border-radius:14px"></div>
            <div class="skeleton" style="height:120px;border-radius:14px"></div>
          </div>

          <div id="customers-history-empty" style="display:none;text-align:center;padding:60px 20px;color:#94a3b8">
            <div style="font-size:64px;margin-bottom:16px;opacity:.4">📋</div>
            <div style="font-size:18px;font-weight:600;margin-bottom:8px">No customer history yet</div>
            <div style="font-size:14px;opacity:.8">Complete your first job to start building your customer database</div>
          </div>
        </div>
      </div>

      <div id="tab-payouts" class="card" style="display:none">
        <div style="margin-bottom:32px">
          <h2 style="margin:0 0 8px;display:flex;align-items:center;gap:12px">
            Earnings Dashboard
          </h2>
          <p class="muted" style="margin:0;font-size:15px">Track your earnings, view payout history, and withdraw funds</p>
        </div>

        <!-- Available Balance Card -->
        <div style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-radius:18px;padding:32px;margin-bottom:24px;box-shadow:0 8px 24px rgba(16,185,129,.3);position:relative;overflow:hidden">
          <div style="position:absolute;top:0;right:0;width:200px;height:200px;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%);pointer-events:none"></div>
          <div style="position:relative;z-index:1">
            <div style="font-size:15px;font-weight:600;color:rgba(255,255,255,.85);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Available Balance</div>
            <div id="available-balance" style="font-size:52px;font-weight:900;color:#fff;margin-bottom:4px;letter-spacing:-0.02em">$0.00</div>
            <div style="font-size:14px;color:rgba(255,255,255,.75);margin-bottom:24px">Ready to withdraw</div>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <!-- Instant Withdraw temporarily removed until banking integration is implemented -->
              <!-- <button id="btnInstantWithdraw" class="btn" style="background:rgba(255,255,255,0.1);color:#94a3b8;border:1px solid rgba(255,255,255,0.2);cursor:not-allowed;opacity:0.6" type="button" disabled title="Banking setup required">
                Instant Withdraw (Setup Required)
              </button> -->
              <button id="btnViewHistory" class="btn secondary" style="background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.3)" type="button">
                View History
              </button>
            </div>
          </div>
        </div>

        <!-- Earnings Stats Grid -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px">
          <!-- Lifetime Earnings -->
          <div style="background:linear-gradient(135deg,rgba(139,92,246,.12) 0%,rgba(124,58,237,.08) 100%);border:1px solid rgba(139,92,246,.25);border-radius:14px;padding:20px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="width:36px;height:36px;background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff">LT</div>
              <div style="font-size:13px;font-weight:600;color:#cbd5e1;text-transform:uppercase;letter-spacing:.5px">Lifetime Earnings</div>
            </div>
            <div id="lifetime-earnings" style="font-size:32px;font-weight:800;color:#e0f2fe;letter-spacing:-0.01em">$0.00</div>
            <div style="font-size:12px;color:#94a3b8;margin-top:4px">Total earnings</div>
          </div>

          <!-- This Week -->
          <div style="background:linear-gradient(135deg,rgba(59,130,246,.12) 0%,rgba(37,99,235,.08) 100%);border:1px solid rgba(59,130,246,.25);border-radius:14px;padding:20px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="width:36px;height:36px;background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff">7D</div>
              <div style="font-size:13px;font-weight:600;color:#cbd5e1;text-transform:uppercase;letter-spacing:.5px">This Week</div>
            </div>
            <div id="week-earnings" style="font-size:32px;font-weight:800;color:#e0f2fe;letter-spacing:-0.01em">$0.00</div>
            <div id="week-jobs" style="font-size:12px;color:#94a3b8;margin-top:4px">0 jobs completed</div>
          </div>

          <!-- Pending Approval -->
          <div style="background:linear-gradient(135deg,rgba(245,158,11,.12) 0%,rgba(217,119,6,.08) 100%);border:1px solid rgba(245,158,11,.25);border-radius:14px;padding:20px">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="width:36px;height:36px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff">⋯</div>
              <div style="font-size:13px;font-weight:600;color:#cbd5e1;text-transform:uppercase;letter-spacing:.5px">Pending Approval</div>
            </div>
            <div id="pending-earnings" style="font-size:32px;font-weight:800;color:#e0f2fe;letter-spacing:-0.01em">$0.00</div>
            <div style="font-size:12px;color:#94a3b8;margin-top:4px">Awaiting approval</div>
          </div>
        </div>

        <!-- Recent Payouts List -->
        <div style="background:linear-gradient(135deg,rgba(12,47,98,.6) 0%,rgba(11,42,88,.6) 100%);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:24px">
          <h3 style="font-size:18px;font-weight:700;margin:0 0 20px;color:#e0f2fe">Recent Earnings</h3>
          <div id="recent-payouts-list">
            <div style="text-align:center;padding:40px 20px;color:#94a3b8">
              <div style="font-size:48px;font-weight:300;margin-bottom:12px;opacity:.5;color:#3b82f6">$0</div>
              <div style="font-size:15px">No earnings yet. Accept jobs to start earning!</div>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-reviews" class="card" style="display:none">
        <h2>Your reviews</h2>
        <div id="reviews-rows" class="list"></div>
        <p class="muted" id="reviews-empty" style="display:none">No reviews yet.</p>
      </div>

      <div id="tab-profile" class="card" style="display:none">
        <div style="margin-bottom:32px">
          <h2 style="margin:0 0 8px">Account Settings</h2>
          <p class="muted" style="margin:0;font-size:15px">Manage your professional profile and service preferences</p>
        </div>

        <!-- Personal Info Section -->
        <div style="background:linear-gradient(135deg,rgba(59,130,246,.08) 0%,rgba(37,99,235,.06) 100%);border:1px solid rgba(59,130,246,.2);border-radius:16px;padding:28px;margin-bottom:24px">
          <h3 style="font-size:18px;font-weight:700;margin:0 0 20px;color:#e0f2fe;display:flex;align-items:center;gap:10px">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Professional Profile
          </h3>
          <div style="display:grid;gap:20px">
            <!-- Profile Photo Upload -->
            <div>
              <label class="label" style="display:block;margin-bottom:12px;font-weight:600;color:#cbd5e1">Profile Photo</label>
              <div style="display:flex;gap:16px;align-items:start">
                <!-- Photo Preview -->
                <div style="flex-shrink:0">
                  <div id="pfPhotoPreview" style="width:120px;height:120px;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,rgba(96,181,250,.15) 0%,rgba(59,130,246,.15) 100%);border:2px solid rgba(96,181,250,.3);display:flex;align-items:center;justify-content:center">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:.4">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </div>
                </div>
                <!-- Upload Controls -->
                <div style="flex:1">
                  <input type="file" id="pfPhotoInput" accept="image/*" capture="environment" style="display:none">
                  <input type="hidden" id="pfPhoto">
                  <button id="btnChoosePhoto" class="btn secondary" type="button" style="width:100%;margin-bottom:10px;display:flex;align-items:center;justify-content:center;gap:8px">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    Choose Photo
                  </button>
                  <p class="muted" style="margin:0;font-size:13px;line-height:1.5">
                    Tap to select from camera roll or take a new photo<br>
                    Customers see this when you're assigned to their job
                  </p>
                  <div id="pfPhotoUploading" style="display:none;margin-top:12px;padding:10px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:8px;font-size:13px">
                    <div style="display:flex;align-items:center;gap:8px">
                      <div class="spin" style="width:16px;height:16px;border-width:2px"></div>
                      <span>Uploading photo...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Vehicle Description -->
            <div>
              <label class="label" for="pfVehicle" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1">Vehicle Description</label>
              <input id="pfVehicle" class="input" placeholder="2018 blue Ford F-150" style="font-size:15px">
              <p class="muted" style="margin:6px 0 0;font-size:13px">Helps customers identify you on arrival</p>
            </div>
            <div>
              <label class="label" for="pfBio" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1">Short Bio</label>
              <textarea id="pfBio" class="textarea" placeholder="Hi! I'm a certified technician with 5+ years of experience. I specialize in smart home installations and pride myself on clean, professional work." style="min-height:100px;font-size:15px;line-height:1.6"></textarea>
              <p class="muted" style="margin:6px 0 0;font-size:13px">Tell customers about your experience and what makes you great at your job</p>
            </div>
          </div>
        </div>

        <!-- Service Settings Section -->
        <div style="background:linear-gradient(135deg,rgba(16,185,129,.08) 0%,rgba(5,150,105,.06) 100%);border:1px solid rgba(16,185,129,.2);border-radius:16px;padding:28px;margin-bottom:24px">
          <h3 style="font-size:18px;font-weight:700;margin:0 0 20px;color:#d1fae5;display:flex;align-items:center;gap:10px">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Service Availability
          </h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <div>
              <label class="label" for="pfMiles" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1">
                Maximum Travel Distance
                <span style="font-weight:400;opacity:.7;font-size:12px;margin-left:8px">(miles from home)</span>
              </label>
              <input id="pfMiles" class="input" inputmode="numeric" placeholder="30" style="font-size:18px;font-weight:600;padding:16px">
              <p class="muted" style="margin:8px 0 0;font-size:13px">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                This is your absolute max. Most jobs are within 10-15 miles
              </p>
            </div>
            <div>
              <label class="label" for="pfMax" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1">
                Daily Job Capacity
                <span style="font-weight:400;opacity:.7;font-size:12px;margin-left:8px">(jobs per day)</span>
              </label>
              <input id="pfMax" class="input" inputmode="numeric" placeholder="5" style="font-size:18px;font-weight:600;padding:16px">
              <p class="muted" style="margin:8px 0 0;font-size:13px">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:4px">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                Full workday maximum. You can adjust this anytime
              </p>
            </div>
          </div>
        </div>

        <!-- How Settings Work Info -->
        <div style="background:linear-gradient(135deg,rgba(139,92,246,.08) 0%,rgba(124,58,237,.06) 100%);border:1px solid rgba(139,92,246,.2);border-radius:16px;padding:24px;margin-bottom:24px">
          <h3 style="font-size:16px;font-weight:700;margin:0 0 16px;color:#e9d5ff;display:flex;align-items:center;gap:8px">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            How Your Settings Work
          </h3>
          <div style="display:grid;gap:14px;font-size:14px;line-height:1.7;color:#e9d5ff">
            <div style="display:flex;gap:10px">
              <div style="flex-shrink:0;margin-top:2px"></div>
              <div>
                <strong style="color:#f3e8ff">Travel Distance:</strong> 
                Our dispatch system prioritizes jobs within your max distance. You'll mainly see jobs in your preferred range, but occasionally we may offer jobs slightly outside if no closer pros are available - you can still accept or decline based on your schedule.
              </div>
            </div>
            <div style="display:flex;gap:10px">
              <div style="flex-shrink:0;margin-top:2px"></div>
              <div>
                <strong style="color:#f3e8ff">Daily Capacity:</strong> 
                The system tracks your accepted jobs each day and won't auto-assign beyond your limit. This protects you from overload while keeping your schedule full. You can manually accept additional jobs if you want.
              </div>
            </div>
            <div style="display:flex;gap:10px">
              <div style="flex-shrink:0;margin-top:2px"></div>
              <div>
                <strong style="color:#f3e8ff">Time Off Requests:</strong> 
                When you block dates in the Schedule tab, the system automatically skips you for job offers on those days. No calls, no job offers - just time off.
              </div>
            </div>
            <div style="padding:12px;background:rgba(139,92,246,.1);border-radius:8px;border:1px solid rgba(139,92,246,.25)">
              <strong style="color:#f3e8ff">Pro Tip:</strong> These are <em>preferences</em>, not hard limits. The system uses them to find the best matches, but you always have final say when accepting or declining jobs. If a job works for you even if it's outside your usual range, go for it!
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:32px">
          <p class="muted" style="margin:0;font-size:14px">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:middle;margin-right:6px">
              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
            </svg>
            Changes are saved immediately and visible to customers
          </p>
          <button id="btnSaveProfile" class="btn" type="button" style="min-width:180px;font-size:16px;padding:16px 32px">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;vertical-align:middle">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Save Changes
          </button>
        </div>
        
        <div id="pf-ok" class="ok" role="status"></div>
        <div id="pf-err" class="error" role="alert"></div>
      </div>

      <div id="tab-training" class="card" style="display:none">
        <!-- ===== TRAINING DASHBOARD HEADER ===== -->
        <div class="training-dashboard-header">
          <div class="training-header-content">
            <h2 style="margin:0">Training Hub</h2>
            <p class="muted" style="margin:8px 0 0">Level up your skills and earn certifications</p>
          </div>
          <div class="training-stats-cards">
            <div class="stat-card stat-completed">
              <div class="stat-icon"></div>
              <div class="stat-info">
                <div class="stat-value" id="statCompleted">0</div>
                <div class="stat-label">Completed</div>
              </div>
            </div>
            <div class="stat-card stat-progress">
              <div class="stat-icon"></div>
              <div class="stat-info">
                <div class="stat-value" id="statInProgress">0</div>
                <div class="stat-label">In Progress</div>
              </div>
            </div>
            <div class="stat-card stat-hours">
              <div class="stat-icon"></div>
              <div class="stat-info">
                <div class="stat-value" id="statHours">0h</div>
                <div class="stat-label">Watch Time</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== FILTERS & SEARCH ===== -->
        <div class="training-section">
          <!-- Dynamic Category Pills Overview -->
          <div class="categories-overview" id="trainingCategoriesOverview" style="display:none; background:linear-gradient(135deg, #1e293b 0%, #334155 100%); border:1px solid rgba(139, 92, 246, 0.3); border-radius:16px; padding:28px; margin-bottom:32px;">
            <h3 style="font-size:18px; font-weight:600; color:#e2e8f0; margin-bottom:16px; ">
              Your Training Categories
            </h3>
            <div id="trainingCategoryPills" style="display:flex; flex-wrap:wrap; gap:12px; margin-bottom:16px;">
              <!-- Dynamic pills generated here -->
            </div>
            <div style="padding:12px 16px; background:rgba(59, 130, 246, 0.1); border-left:3px solid #3b82f6; border-radius:6px; font-size:13px; color:#93c5fd; line-height:1.6;">
              💡 Click a category to filter videos. Categories are automatically organized from your training database.
            </div>
          </div>
          
          <div class="training-filters-bar">
            <div class="filter-tabs" id="trainingFilterTabs" role="tablist">
              <button class="filter-tab active" data-category="all" role="tab">
                📚 All
              </button>
              <!-- Dynamic tabs generated here -->
            </div>
            <div class="filter-controls">
              <div class="search-box-training">
                <span class="search-icon"></span>
                <input id="trainingSearch" type="search" placeholder="Search training..." class="search-input-training">
              </div>
              <select id="trainingStatusFilter" class="input-filter" aria-label="Filter by status">
                <option value="">All Videos</option>
                <option value="completed">✓ Completed</option>
                <option value="in_progress">In Progress</option>
                <option value="not_started">Not Started</option>
              </select>
            </div>
          </div>
        </div>
        <!-- ===== TRAINING CONTENT GRID ===== -->
        <div class="training-section">
          <div class="section-header" style="margin-bottom:24px">
            <div>
              <h3 class="section-title" id="currentSectionTitle" style="font-size:20px;font-weight:700;color:#f8fafc">All Training Content</h3>
              <p class="section-subtitle" id="currentSectionSubtitle" style="margin-top:4px;font-size:14px;color:#94a3b8">Loading videos...</p>
            </div>
          </div>
          
          <div id="training-content" class="training-grid">
            <!-- Populated dynamically -->
          </div>
          
          <div id="training-loading" style="display:none" class="training-grid">
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
            <div class="skeleton skeleton-card"></div>
          </div>
        </div>

        <!-- ===== RESOURCES & DOWNLOADS ===== -->
        <div class="training-section">
          <div class="section-header" style="margin-bottom:20px">
            <div>
              <h3 class="section-title" style="font-size:20px;font-weight:700;color:#f8fafc">📚 Resources & Downloads</h3>
              <p class="section-subtitle" style="margin-top:4px;font-size:14px;color:#94a3b8">Guides, checklists, and reference materials</p>
            </div>
          </div>
          <div id="training-resources" class="resources-list">
            <!-- Populated dynamically -->
          </div>
          <div id="training-resources-empty" class="empty-state-modern" style="display:none;text-align:center;padding:60px 24px;background:#0f172a;border-radius:16px;border:2px dashed #1e293b">
            <div style="font-size:48px;margin-bottom:12px;opacity:.5">📄</div>
            <p style="font-size:14px;color:#64748b">No resources available yet</p>
          </div>
        </div>
      </div>

      <div id="tab-schedule" class="card" style="display:none">
        <div class="page-header-modern">
          <div class="page-header-content">
            <div class="page-icon-circle" style="background:var(--gradient-purple)">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            <div>
              <h2 class="page-title-modern">Time Off</h2>
              <p class="page-subtitle-modern">Request days when you're unavailable to work</p>
            </div>
          </div>
        </div>

        <!-- Request Time Off Button -->
        <div class="modern-section" style="margin-bottom:var(--spacing-xl)">
          <div id="btnOpenTimeOffModal" class="action-card-modern" style="background:linear-gradient(135deg,rgba(245,158,11,.08),rgba(251,191,36,.08));border:2px solid rgba(245,158,11,.2);border-radius:16px;padding:32px;text-align:center;cursor:pointer;transition:all .3s cubic-bezier(.4,0,.2,1)">
            <div style="width:64px;height:64px;margin:0 auto 20px;background:linear-gradient(135deg,#f59e0b,#fbbf24);border-radius:20px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 16px rgba(245,158,11,.25)">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </div>
            <h3 style="font-size:20px;font-weight:700;color:#f8fafc;margin-bottom:8px">Request Time Off</h3>
            <p style="font-size:14px;color:#94a3b8;margin-bottom:24px">Block dates when you can't take jobs</p>
            <div class="btn-modern btn-warning" style="display:inline-flex;pointer-events:none">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              Request Time Off
            </div>
          </div>
        </div>

        <!-- Requested Time Off List -->
        <div class="modern-section">
          <div class="section-header-modern">
            <div class="section-icon-modern" style="background:rgba(16,185,129,.15);color:var(--green-light)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 11 12 14 22 4"></polyline>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
              </svg>
            </div>
            <div>
              <h3 class="section-title-modern">Your Time Off Requests</h3>
              <p class="section-subtitle-modern">Upcoming dates you've blocked</p>
            </div>
          </div>
          <div id="current-schedule-display" class="availability-list-modern">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </section>

    <section id="view-admin" class="view" aria-hidden="true">
      <!-- Jobs Overview Panel -->
      <div class="card" id="jobsPanel">
        <h2>Dispatch <span id="lastUpdateIndicator" class="muted" style="font-size:14px;font-weight:normal;margin-left:12px"></span></h2>
        <div class="admin-bar">
          <div>
            <label class="label" for="adStatus">Status</label>
            <select id="adStatus" class="input" style="min-height:44px">
              <option value="">All recent</option>
              <option value="pending_assign">Pending assign</option>
              <option value="offer_sent">Offer sent</option>
              <option value="accepted">Accepted</option>
              <option value="completed">Completed</option>
              <option value="canceled">Canceled</option>
            </select>
          </div>
          <div>
            <label class="label" for="adDays">Window (days)</label>
            <input id="adDays" class="input" inputmode="numeric" value="30">
          </div>
          <div style="align-self:flex-end" class="row">
            <button id="btnCreateTestOrder" class="btn secondary" type="button" title="Create test order for migration testing">Create Test Order</button>
            <button id="btnMigrateOrders" class="btn" type="button" title="Convert orders to jobs">Sync Orders → Jobs</button>
            <button id="btnGeocodeAll" class="btn warning" type="button" title="Geocode all jobs and techs with missing coordinates">🌍 Fix Locations</button>
            <button id="btnAdRefresh" class="btn" type="button">Refresh</button>
            <button id="btnToggleDataHealth" class="btn secondary" type="button">Data Health</button>
            <button id="btnAdSignOut" class="btn secondary" type="button">Sign out</button>
          </div>
        </div>

        <div class="tr th" style="margin-bottom:8px;background:transparent;border:none;padding:0">
          <div class="td">Service / Customer</div>
          <div class="td">When</div>
          <div class="td">Address</div>
          <div class="td">Variant</div>
          <div class="td">Status</div>
          <div class="td" style="text-align:right">Actions</div>
        </div>
        <div id="adList" class="list"></div>
        <p id="adEmpty" class="muted" style="display:none">No jobs found.</p>
      </div>

      <!-- Announcements Management Panel -->
      <div class="card" id="announcementsPanel" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid rgba(255,255,255,0.08)">
          <div>
            <h2 style="margin:0 0 8px 0;font-size:28px;font-weight:700;background:linear-gradient(135deg,#60a5fa 0%,#3b82f6 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Announcements</h2>
            <p class="muted" style="margin:0;font-size:14px;color:#94a3b8">Create and manage announcements for all pros</p>
          </div>
          <div style="display:flex;gap:12px">
            <button id="btnTestAnnouncements" class="btn secondary" type="button" style="font-size:12px;padding:8px 16px;border-radius:8px;transition:all 0.2s">Test Connection</button>
            <button id="btnNewAnnouncement" class="btn-success" type="button" style="font-size:14px;font-weight:600;padding:12px 24px;border-radius:10px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border:none;box-shadow:0 4px 12px rgba(16,185,129,0.3);transition:all 0.2s;cursor:pointer" onmouseover="console.log('[Announcements] 🖱️ Mouse over New Announcement button')" onclick="console.log('[Announcements] 🖱️ DIRECT onclick fired on button element')">+ New Announcement</button>
          </div>
        </div>

        <!-- Announcements List -->
        <div id="announcementsList" class="announcements-list">
          <p class="muted">Loading announcements...</p>
        </div>
      </div>

    </section>

    <!-- Create/Edit Announcement Modal (OUTSIDE view-admin so it's always accessible) -->
    <div id="announcementModal" class="modal-overlay" style="display:none;align-items:center;justify-content:center;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);z-index:9999">
      <div class="modal-content" style="width:680px;max-width:92vw;max-height:90vh;overflow-y:auto;border-radius:20px;box-shadow:0 25px 80px rgba(0,0,0,0.5);background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);border:1px solid rgba(255,255,255,0.12)">
        <div class="modal-header" style="padding:28px 32px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:rgba(15,23,42,0.95);backdrop-filter:blur(10px);z-index:10">
          <h3 id="announcementModalTitle" style="margin:0;font-size:24px;font-weight:700;color:#f1f5f9;letter-spacing:-0.02em">New Announcement</h3>
          <button id="btnCloseAnnouncementModal" class="modal-close" style="width:36px;height:36px;border-radius:10px;font-size:22px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#94a3b8;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;flex-shrink:0" onmouseover="this.style.background='rgba(239,68,68,0.15)';this.style.borderColor='rgba(239,68,68,0.3)';this.style.color='#f87171'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='#94a3b8'">&times;</button>
        </div>
          <div class="modal-body" style="padding:32px">
            <div style="margin-bottom:24px">
              <label class="label" for="announcementTitleInput" style="font-weight:600;color:#cbd5e1;margin-bottom:10px;display:block;font-size:14px">Title <span style="color:#f87171">*</span></label>
              <input id="announcementTitleInput" class="input" placeholder="What's this announcement about?" maxlength="100" style="border-radius:12px;border:1px solid rgba(148,163,184,0.15);background:rgba(15,23,42,0.7);padding:14px 18px;font-size:15px;transition:all 0.2s;width:100%;color:#f1f5f9" onfocus="this.style.borderColor='rgba(59,130,246,0.5)';this.style.background='rgba(15,23,42,0.9)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)';this.style.background='rgba(15,23,42,0.7)'">
            </div>
            <div style="margin-bottom:24px">
              <label class="label" for="announcementMessage" style="font-weight:600;color:#cbd5e1;margin-bottom:10px;display:block;font-size:14px">Message</label>
              <textarea id="announcementMessage" class="input" rows="4" placeholder="Add details, instructions, or context for your team..." style="border-radius:12px;border:1px solid rgba(148,163,184,0.15);background:rgba(15,23,42,0.7);padding:14px 18px;font-size:14px;line-height:1.7;resize:vertical;min-height:110px;width:100%;color:#e2e8f0;font-family:inherit" onfocus="this.style.borderColor='rgba(59,130,246,0.5)';this.style.background='rgba(15,23,42,0.9)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)';this.style.background='rgba(15,23,42,0.7)'"></textarea>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px">
              <div>
                <label class="label" for="announcementType" style="font-weight:600;color:#cbd5e1;margin-bottom:10px;display:block;font-size:14px">Type</label>
                <select id="announcementType" class="input" style="border-radius:12px;border:1px solid rgba(148,163,184,0.15);background:rgba(15,23,42,0.7);padding:14px 18px;font-size:14px;cursor:pointer;width:100%;color:#f1f5f9;appearance:none;background-image:url('data:image/svg+xml;charset=UTF-8,%3csvg width=%2714%27 height=%278%27 viewBox=%270 0 14 8%27 fill=%27none%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M1 1L7 7L13 1%27 stroke=%27%2394a3b8%27 stroke-width=%272%27 stroke-linecap=%27round%27 stroke-linejoin=%27round%27/%3e%3c/svg%3e');background-repeat:no-repeat;background-position:right 18px center;padding-right:45px" onfocus="this.style.borderColor='rgba(59,130,246,0.5)';this.style.background='rgba(15,23,42,0.9)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)';this.style.background='rgba(15,23,42,0.7)'">
                  <option value="info">Info</option>
                  <option value="update">Update</option>
                  <option value="warning">Warning</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
              <div>
                <label class="label" for="announcementPriority" style="font-weight:600;color:#cbd5e1;margin-bottom:10px;display:block;font-size:14px">Priority</label>
                <input id="announcementPriority" class="input" type="number" value="10" min="0" max="100" placeholder="0-100" style="border-radius:12px;border:1px solid rgba(148,163,184,0.15);background:rgba(15,23,42,0.7);padding:14px 18px;font-size:14px;width:100%;color:#f1f5f9" onfocus="this.style.borderColor='rgba(59,130,246,0.5)';this.style.background='rgba(15,23,42,0.9)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)';this.style.background='rgba(15,23,42,0.7)'">
              </div>
            </div>
            <div style="margin-bottom:24px">
              <label class="label" for="announcementVideoUrl" style="font-weight:600;color:#cbd5e1;margin-bottom:10px;display:block;font-size:14px">Video Link</label>
              <input id="announcementVideoUrl" class="input" type="url" placeholder="https://www.loom.com/share/... or YouTube link" style="border-radius:12px;border:1px solid rgba(148,163,184,0.15);background:rgba(15,23,42,0.7);padding:14px 18px;font-size:14px;width:100%;color:#f1f5f9" onfocus="this.style.borderColor='rgba(59,130,246,0.5)';this.style.background='rgba(15,23,42,0.9)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)';this.style.background='rgba(15,23,42,0.7)'">
              <p class="muted" style="font-size:12px;margin-top:8px;color:#64748b;font-style:italic">Embed a Loom or YouTube video for visual instructions</p>
            </div>
            <div style="margin-bottom:24px">
              <label class="label" for="announcementExpires" style="font-weight:600;color:#cbd5e1;margin-bottom:10px;display:block;font-size:14px">Expiration Date & Time</label>
              <input id="announcementExpires" class="input" type="datetime-local" style="border-radius:12px;border:1px solid rgba(148,163,184,0.15);background:rgba(15,23,42,0.7);padding:14px 18px;font-size:14px;width:100%;color:#f1f5f9;color-scheme:dark" onfocus="this.style.borderColor='rgba(59,130,246,0.5)';this.style.background='rgba(15,23,42,0.9)'" onblur="this.style.borderColor='rgba(148,163,184,0.15)';this.style.background='rgba(15,23,42,0.7)'">
              <p class="muted" style="font-size:12px;margin-top:8px;color:#64748b;font-style:italic">Leave empty for announcements that don't expire</p>
            </div>
            <div style="display:flex;align-items:center;gap:14px;padding:18px 20px;background:rgba(59,130,246,0.1);border-radius:12px;border:1px solid rgba(59,130,246,0.25)">
              <input id="announcementActive" type="checkbox" checked style="width:22px;height:22px;cursor:pointer;accent-color:#3b82f6;flex-shrink:0">
              <label for="announcementActive" style="margin:0;color:#e0f2fe;font-weight:500;cursor:pointer;font-size:14px;user-select:none">Publish immediately (visible to all pros)</label>
            </div>
          </div>
          <div class="modal-footer" style="padding:24px 32px;border-top:1px solid rgba(255,255,255,0.08);display:flex;gap:14px;justify-content:flex-end;background:rgba(15,23,42,0.5)">
            <button id="btnCancelAnnouncement" class="btn secondary" type="button" style="padding:12px 28px;border-radius:12px;font-weight:600;transition:all 0.2s;font-size:14px;background:rgba(100,116,139,0.15);border:1px solid rgba(148,163,184,0.2);color:#cbd5e1" onmouseover="this.style.background='rgba(100,116,139,0.25)'" onmouseout="this.style.background='rgba(100,116,139,0.15)'">Cancel</button>
            <button id="btnSaveAnnouncement" class="btn-success" type="button" style="padding:12px 32px;border-radius:12px;font-weight:600;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border:none;box-shadow:0 4px 16px rgba(16,185,129,0.35);transition:all 0.2s;font-size:14px;color:white" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 20px rgba(16,185,129,0.45)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 16px rgba(16,185,129,0.35)'">Save Announcement</button>
          </div>
        </div>
      </div>

      <!-- Data Health Dashboard -->
      <div class="card" id="dataHealthDashboard" style="display:none;margin-top:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
          <h2>Data Health Dashboard</h2>
          <button id="btnRefreshDataHealth" class="btn secondary" type="button">🔄 Refresh</button>
        </div>
        
        <!-- KPI Cards -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px">
          <div class="kpi-card">
            <div class="kpi-label">Catalog Items</div>
            <div class="kpi-value" id="kpiCatalogTotal">--</div>
            <div class="kpi-sublabel"><span id="kpiCatalogWithLinks">--</span> with links</div>
          </div>
          <div class="kpi-card warn">
            <div class="kpi-label">Missing Links</div>
            <div class="kpi-value" id="kpiMissingLinks">--</div>
            <div class="kpi-sublabel">Need manual search</div>
          </div>
          <div class="kpi-card info">
            <div class="kpi-label">Auto-Created</div>
            <div class="kpi-value" id="kpiAutoCreated">--</div>
            <div class="kpi-sublabel">By AI assistant</div>
          </div>
          <div class="kpi-card success">
            <div class="kpi-label">BOM Improvements</div>
            <div class="kpi-value" id="kpiBOMPending">--</div>
            <div class="kpi-sublabel">Pending review</div>
          </div>
        </div>

        <!-- Missing Product Links Section -->
        <div style="margin-bottom:32px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">🔗 Items Needing Links</h3>
            <button id="btnAutoFindLinks" class="btn-success" type="button" style="font-size:14px;padding:8px 16px">🤖 Auto-Find Links</button>
          </div>
          <div id="linkTodoList" class="link-todo-list">
            <p class="muted">Loading...</p>
          </div>
        </div>

        <!-- BOM Improvements Section -->
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 style="margin:0">BOM Improvement Suggestions</h3>
            <button id="btnRefreshBOMImprovements" class="btn secondary" type="button" style="font-size:14px;padding:8px 16px">🔄 Refresh</button>
          </div>
          <div id="bomImprovementsList" class="bom-improvements-list">
            <p class="muted">Loading...</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Delete media confirmation overlay -->
  <div id="deleteConfirmOverlay" class="delete-confirm-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="delete-confirm" role="document">
      <h4 id="deleteConfirmTitle">Remove media?</h4>
      <div class="desc" id="deleteConfirmDesc">This will permanently remove the selected photo/video from this job. You cannot undo this.</div>
      <div class="preview" id="deleteConfirmPreview" aria-label="Media preview"></div>
      <div class="actions">
        <button class="btn ghost" id="deleteConfirmCancel">Cancel</button>
        <button class="btn danger" id="deleteConfirmConfirm">Delete</button>
      </div>
    </div>
  </div>
</main>

<footer class="footer">© Home2Smart • <a href="mailto:contact@home2smart.com" style="color:#9bc8ff;text-decoration:none">contact@home2smart.com</a></footer>

<!-- Announcements Modal (Pro View) -->
<div id="announcementsModal" class="modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(15,23,42,0.97);backdrop-filter:blur(12px);z-index:10000;padding:20px;overflow-y:auto;animation:fadeIn 0.2s ease">
  <div style="max-width:900px;margin:40px auto;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border-radius:20px;box-shadow:0 25px 80px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.12);overflow:hidden">
    <!-- Header -->
    <div style="padding:28px 32px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;background:rgba(30,41,59,0.5)">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg,rgba(59,130,246,0.2) 0%,rgba(37,99,235,0.1) 100%);display:flex;align-items:center;justify-content:center;color:#60a5fa">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 8.35V2.54a.5.5 0 0 0-.74-.43l-8.55 5.03a2 2 0 0 1-.97.25H4a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2.5a2 2 0 0 1 .8.17l3.7 1.48a2 2 0 0 0 1.6.04l6.66-2.66a.5.5 0 0 0 .74-.43V8.35z"></path><path d="M22 8.35A5.5 5.5 0 0 1 22 18.5"></path></svg>
        </div>
        <h2 style="margin:0;font-size:26px;font-weight:700;background:linear-gradient(135deg,#60a5fa 0%,#3b82f6 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">All Announcements</h2>
      </div>
      <button onclick="closeAnnouncementsModal()" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);color:#cbd5e1;width:40px;height:40px;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;font-size:20px;font-weight:300" onmouseover="this.style.background='rgba(239,68,68,0.2)';this.style.borderColor='rgba(239,68,68,0.4)';this.style.color='#f87171'" onmouseout="this.style.background='rgba(255,255,255,0.08)';this.style.borderColor='rgba(255,255,255,0.12)';this.style.color='#cbd5e1'">&times;</button>
    </div>
    
    <!-- Announcements List with Custom Scrollbar -->
    <div id="announcementsListPro" style="padding:24px 32px;max-height:calc(100vh - 240px);overflow-y:auto;
      /* Custom Scrollbar Styling */
      scrollbar-width:thin;
      scrollbar-color:rgba(59,130,246,0.4) rgba(255,255,255,0.05)">
      <p style="color:#64748b;text-align:center">Loading announcements...</p>
    </div>
  </div>
</div>

<!-- Custom Confirmation Modal (for deletions, etc.) -->
<div id="confirmModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);z-index:99999;padding:20px;align-items:center;justify-content:center;animation:fadeIn 0.2s ease">
  <div style="max-width:480px;width:100%;background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border-radius:20px;box-shadow:0 30px 90px rgba(0,0,0,0.8);border:1px solid rgba(239,68,68,0.3);overflow:hidden;animation:scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)">
    <!-- Header -->
    <div style="padding:24px 28px;background:linear-gradient(135deg,rgba(239,68,68,0.15) 0%,rgba(220,38,38,0.1) 100%);border-bottom:1px solid rgba(239,68,68,0.2)">
      <div style="display:flex;align-items:center;gap:14px">
        <div style="width:48px;height:48px;border-radius:12px;background:rgba(239,68,68,0.2);display:flex;align-items:center;justify-content:center">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        </div>
        <h3 id="confirmModalTitle" style="margin:0;font-size:22px;font-weight:700;color:#f87171">Confirm Action</h3>
      </div>
    </div>
    
    <!-- Body -->
    <div style="padding:28px">
      <p id="confirmModalMessage" style="margin:0;color:#cbd5e1;font-size:15px;line-height:1.7">Are you sure?</p>
    </div>
    
    <!-- Footer / Actions -->
    <div style="padding:20px 28px;background:rgba(15,23,42,0.8);border-top:1px solid rgba(255,255,255,0.05);display:flex;gap:12px;justify-content:flex-end">
      <button id="confirmModalCancel" style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);color:#cbd5e1;padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.12)'" onmouseout="this.style.background='rgba(255,255,255,0.08)'">Cancel</button>
      <button id="confirmModalConfirm" style="background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);border:none;color:#fff;padding:12px 28px;border-radius:10px;cursor:pointer;font-weight:700;font-size:14px;box-shadow:0 4px 14px rgba(239,68,68,0.4);transition:all 0.2s" onmouseover="this.style.transform='translateY(-1px)';this.style.boxShadow='0 6px 20px rgba(239,68,68,0.5)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 14px rgba(239,68,68,0.4)'">Delete</button>
    </div>
  </div>
</div>

<style>
/* Webkit browsers (Chrome, Safari, Edge) - Custom Scrollbar */
#announcementsListPro::-webkit-scrollbar {
  width: 10px;
}

#announcementsListPro::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  margin: 4px;
}

#announcementsListPro::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, rgba(59,130,246,0.5) 0%, rgba(37,99,235,0.4) 100%);
  border-radius: 10px;
  border: 2px solid rgba(30,41,59,0.3);
  transition: all 0.2s;
}

#announcementsListPro::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, rgba(59,130,246,0.7) 0%, rgba(37,99,235,0.6) 100%);
  border-color: rgba(59,130,246,0.2);
}

/* Fade in animation */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Toast animations */
@keyframes slideInUp {
  from {
    transform: translateY(100px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideOutDown {
  from {
    transform: translateY(0);
    opacity: 1;
  }
  to {
    transform: translateY(100px);
    opacity: 0;
  }
}

@keyframes slideInDown {
  from {
    transform: translateY(-100px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes slideOutUp {
  from {
    transform: translateY(0);
    opacity: 1;
  }
  to {
    transform: translateY(-100px);
    opacity: 0;
  }
}

@keyframes scaleIn {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}
</style>

<div id="adModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="adJobTitle">
  <div class="sheet">
    <h3 id="adJobTitle">Job</h3>
    <div class="grid-3">
      <div><label class="label" for="adServiceId">Service</label><input id="adServiceId" class="input" placeholder="service_id"></div>
      <div><label class="label" for="adVariant">Variant code</label><input id="adVariant" class="input" placeholder="e.g. STD"></div>
      <div><label class="label" for="adStatusField">Status</label><input id="adStatusField" class="input" placeholder="pending_assign"></div>
    </div>
    <div class="grid-3" style="margin-top:10px">
      <div><label class="label" for="adStart">Start ISO</label><input id="adStart" class="input" placeholder="2025-04-01T10:00:00-04:00"></div>
      <div><label class="label" for="adEnd">End ISO</label><input id="adEnd" class="input" placeholder="2025-04-01T12:00:00-04:00"></div>
      <div><label class="label" for="adRes">Resources</label><input id="adRes" class="input" placeholder="Ladder, drill"></div>
    </div>
    <div class="grid-3" style="margin-top:10px">
      <div><label class="label" for="adAddr">Address</label><input id="adAddr" class="input" placeholder="123 Main St"></div>
      <div><label class="label" for="adCity">City</label><input id="adCity" class="input" placeholder="Greenville"></div>
      <div><label class="label" for="adState">State / ZIP</label>
        <div class="grid-2" style="gap:8px">
          <input id="adState" class="input" placeholder="SC">
          <input id="adZip" class="input" placeholder="29649">
        </div>
      </div>
    </div>
    <div class="row">
      <button id="btnAdSave" class="btn" type="button">Save changes</button>
      <button id="btnAdClose" class="btn ghost" type="button">Close</button>
    </div>

    <div class="hr"></div>
    <h3>Job Assignments / Offers</h3>
    <div id="adOffers" class="list"></div>

    <div class="hr"></div>
    <h3>Dispatch - Find Available Techs</h3>
    <div class="row" style="align-items:center;gap:10px;margin-bottom:16px">
      <button id="btnFindAvailableTechs" class="btn" type="button">🔍 Find Available Techs</button>
      <p class="muted">Automatically matches techs based on location, radius, and availability</p>
    </div>
    <div id="adAvailableTechs" class="cands" style="display:none"></div>

    <div class="hr"></div>
    <h3>Assign pros (Manual)</h3>
    <div class="row" style="align-items:center;gap:10px">
      <button id="btnAdLoadPros" class="btn secondary" type="button">Select a pro</button>
      <input id="adProsSearch" class="input" placeholder="Search name or email" style="min-width:260px;width:320px" aria-label="Search professionals">
      <p class="muted">Ordered by distance. Use Assign (offer) to email and create a pending row.</p>
    </div>
    <div id="adCands" class="cands"></div>

    <div class="hr"></div>
    <h3 style="display: flex; align-items: center; gap: 8px;">
      Materials Order
      <span id="buyListLoadingIndicator" class="loading-dots" style="display: none; font-size: 20px; color: var(--azure); margin-left: 8px;">●●●</span>
    </h3>
    <div id="adBuyListStatus" style="margin-bottom: 14px;">
      <span style="opacity: 0.7;">No order generated yet</span>
    </div>
    <button id="btnGenerateBuyList" class="btn secondary" type="button" style="position: relative; overflow: hidden;">
      <span id="btnGenerateBuyListText">Generate Buy List</span>
      <span id="btnGenerateBuyListSpinner" style="display: none;">
        <span class="btn-spinner"></span> Generating...
      </span>
    </button>
    <div id="adBuyListResults" style="margin-top: 16px; display: none;">
      <!-- Buy list will be rendered here -->
    </div>
  </div>
</div>

<div id="modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="md-title">
  <div class="sheet">
    <h3 id="md-title">Job details</h3>
    <div class="payout"><div class="num" id="md-payout">$0.00</div><div class="subl" id="md-variant"></div></div>
    <div class="kv" style="margin-top:10px">
      <div>Date</div><div id="md-date"></div>
      <div>Address</div><div id="md-addr"></div>
      <div>Resources</div><div id="md-res"></div>
      <div>Included tech</div><div id="md-tech"></div>
      <div style="display:none">Teammate</div><div id="md-teammate" style="color:#8b5cf6;font-weight:600"></div>
      <div style="display:none">Notes</div><div id="md-notes" style="font-style:italic;color:#fbbf24"></div>
    </div>
    <div class="hr"></div>
    <div class="subl" style="margin-bottom:6px">Payout breakdown</div>
    <div id="md-lines" class="list"></div>
    <div class="hr"></div>
    <div id="invite-wrap" style="display:none"></div>
    <div class="row" style="margin-top:12px">
      <button id="md-accept" class="btn" type="button">Accept</button>
      <button id="md-close" class="btn ghost" type="button">Close</button>
    </div>
  </div>
</div>

<div id="sigModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="sigTitle">
  <div class="sheet">
    <h3 id="sigTitle">Customer signature</h3>
    <div class="canvas-wrap">
      <canvas id="sig" class="sig-canvas" width="560" height="220" aria-label="Signature canvas"></canvas>
    </div>
    <div class="row">
      <button id="sigSave" class="btn" type="button">Save signature</button>
      <button id="sigClear" class="btn ghost" type="button">Clear</button>
      <button id="sigClose" class="btn secondary" type="button">Close</button>
    </div>
    <div id="sigErr" class="sig-error" role="alert"></div>
    <p class="muted">Signature is required to complete the job.</p>
  </div>
</div>

<div id="replyModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="replyTitle">
  <div class="sheet" style="max-width:600px">
    <h3 id="replyTitle">Reply to review</h3>
    <label class="label" for="replyText">Enter your reply:</label>
    <textarea id="replyText" class="textarea" placeholder="Thank you for your feedback..." style="min-height:140px"></textarea>
    <div class="row" style="margin-top:12px">
      <button id="replyOK" class="btn" type="button">Post reply</button>
      <button id="replyCancel" class="btn secondary" type="button">Cancel</button>
    </div>
  </div>
</div>

<!-- Time Off Request Modal (Premium Design) -->
<div id="timeOffModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="timeOffModalTitle">
  <div class="sheet" style="max-width:600px;max-height:90vh;overflow-y:auto;padding:32px;background:linear-gradient(135deg, rgba(15,23,42,0.98) 0%, rgba(30,41,59,0.98) 100%);border:2px solid rgba(139,92,246,0.2);box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)">
    <style>
      /* Branded scrollbar for Time Off modal container */
      #timeOffModal .sheet { scrollbar-width:thin; scrollbar-color:#8b5cf6 rgba(15,23,42,0.55); }
      #timeOffModal .sheet::-webkit-scrollbar { width:14px; }
      #timeOffModal .sheet::-webkit-scrollbar-track {
        background:linear-gradient(180deg,#0f172a 0%, #1e293b 100%);
        border-radius:10px;
        margin:8px 0;
        border:1px solid rgba(139,92,246,0.25);
      }
      #timeOffModal .sheet::-webkit-scrollbar-thumb {
        background:linear-gradient(180deg,#8b5cf6 0%, #6366f1 100%);
        border-radius:10px;
        border:3px solid rgba(15,23,42,0.85);
        box-shadow:0 2px 8px rgba(139,92,246,0.45);
      }
      #timeOffModal .sheet::-webkit-scrollbar-thumb:hover {
        background:linear-gradient(180deg,#a855f7 0%, #7c3aed 100%);
        box-shadow:0 4px 12px rgba(139,92,246,0.6);
      }
      #timeOffModal .sheet::-webkit-scrollbar-thumb:active {
        background:linear-gradient(180deg,#7c3aed 0%, #6366f1 100%);
      }
    </style>
    <div style="background:linear-gradient(135deg,#8b5cf6 0%,#6366f1 100%);padding:32px;border-radius:16px;margin-bottom:32px;box-shadow:0 10px 30px rgba(139,92,246,0.3)">
      <h3 id="timeOffModalTitle" style="font-size:32px;font-weight:800;color:#fff;margin:0 0 8px 0;letter-spacing:-0.02em">🌴 Request Time Off</h3>
      <p style="font-size:15px;color:rgba(255,255,255,0.9);margin:0">Block dates when you're unavailable for jobs</p>
    </div>
    
    <div style="margin-bottom:32px">
      <label style="font-size:13px;font-weight:700;color:#cbd5e1;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:16px;display:block">Select Date</label>
      <div style="position:relative">
        <div id="dateDisplayTrigger" 
             onclick="(function(){
               const dropdown = document.getElementById('customCalendarDropdown');
               console.log('📅 CLICK EVENT FIRED! Dropdown:', dropdown);
               if (!dropdown) {
                 console.error('❌ Dropdown not found!');
                 return;
               }
               const isVisible = dropdown.style.display === 'block';
               dropdown.style.display = isVisible ? 'none' : 'block';
               console.log('📅 Dropdown now:', dropdown.style.display);
               if (!isVisible) {
                 const today = new Date();
                 const maxDate = new Date(today.getFullYear(), today.getMonth() + 12, 0);
                 renderCustomCalendar(today, maxDate);
               }
             })()"
             style="background:linear-gradient(135deg,rgba(30,41,59,0.95),rgba(15,23,42,0.95));border:2px solid rgba(139,92,246,0.4);border-radius:16px;padding:24px;cursor:pointer;transition:all 0.3s;min-height:90px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 12px rgba(139,92,246,0.1)" 
             onmouseover="this.style.borderColor='rgba(139,92,246,0.6)';this.style.boxShadow='0 8px 24px rgba(139,92,246,0.2)';this.style.transform='translateY(-2px)'" 
             onmouseout="this.style.borderColor='rgba(139,92,246,0.4)';this.style.boxShadow='0 4px 12px rgba(139,92,246,0.1)';this.style.transform='translateY(0)'">
          <div style="flex:1">
            <div style="font-size:13px;color:#94a3b8;margin-bottom:6px">Selected Date</div>
            <div id="dateDisplayValue" style="font-size:26px;font-weight:800;color:#e2e8f0;letter-spacing:-0.01em">Choose a date</div>
          </div>
          <div style="width:52px;height:52px;background:rgba(139,92,246,0.15);border-radius:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
            <svg viewBox="0 0 24 24" fill="none" style="width:28px;height:28px;stroke:#a78bfa;stroke-width:2.5">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
          </div>
        </div>
        <div id="customCalendarDropdown" style="display:none;position:absolute;top:calc(100% + 12px);left:0;right:0;background:linear-gradient(135deg,rgba(15,23,42,0.98),rgba(30,41,59,0.98));border:2px solid rgba(139,92,246,0.4);border-radius:16px;padding:20px;box-shadow:0 20px 50px rgba(0,0,0,0.5);z-index:1000;max-height:420px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(139,92,246,0.6) rgba(15,23,42,0.5)">
          <style>
            #customCalendarDropdown::-webkit-scrollbar {
              width: 12px !important;
            }
            #customCalendarDropdown::-webkit-scrollbar-track {
              background: rgba(15,23,42,0.6) !important;
              border-radius: 10px !important;
              margin: 8px 0 !important;
              border: 1px solid rgba(139,92,246,0.2) !important;
            }
            #customCalendarDropdown::-webkit-scrollbar-thumb {
              background: linear-gradient(180deg, #8b5cf6 0%, #6366f1 100%) !important;
              border-radius: 10px !important;
              border: 2px solid rgba(15,23,42,0.4) !important;
              box-shadow: 0 2px 8px rgba(139,92,246,0.3) !important;
            }
            #customCalendarDropdown::-webkit-scrollbar-thumb:hover {
              background: linear-gradient(180deg, #a855f7 0%, #7c3aed 100%) !important;
              border-color: rgba(139,92,246,0.3) !important;
              box-shadow: 0 4px 12px rgba(139,92,246,0.5) !important;
            }
            #customCalendarDropdown::-webkit-scrollbar-thumb:active {
              background: linear-gradient(180deg, #7c3aed 0%, #6366f1 100%) !important;
            }
          </style>
          <div id="calendarHeader" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <button id="calPrevMonth" type="button" style="width:40px;height:40px;background:rgba(139,92,246,0.15);border:2px solid rgba(139,92,246,0.3);border-radius:10px;color:#a78bfa;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s" onmouseover="this.style.background='rgba(139,92,246,0.25)';this.style.borderColor='rgba(139,92,246,0.5)'" onmouseout="this.style.background='rgba(139,92,246,0.15)';this.style.borderColor='rgba(139,92,246,0.3)'">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <div id="calMonthYear" style="font-size:18px;font-weight:700;color:#e2e8f0"></div>
            <button id="calNextMonth" type="button" style="width:40px;height:40px;background:rgba(139,92,246,0.15);border:2px solid rgba(139,92,246,0.3);border-radius:10px;color:#a78bfa;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s" onmouseover="this.style.background='rgba(139,92,246,0.25)';this.style.borderColor='rgba(139,92,246,0.5)'" onmouseout="this.style.background='rgba(139,92,246,0.15)';this.style.borderColor='rgba(139,92,246,0.3)'">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
          </div>
          <div id="calWeekdays" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:8px"></div>
          <div id="calDays" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px"></div>
        </div>
        <input id="timeOffDateModal" type="date" required style="position:absolute;opacity:0;pointer-events:none;width:1px;height:1px">
      </div>
      <div id="quickPicks" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-top:20px">
        <!-- Quick pick chips -->
      </div>
      <div id="dateRangeHint" style="margin-top:20px;padding:16px;background:rgba(59,130,246,0.1);border-left:4px solid rgba(59,130,246,0.6);border-radius:8px;color:#93c5fd;font-size:14px;line-height:1.6">
        You can request time off up to 12 months in advance
      </div>
    </div>
    
    <style>
      /* Custom dropdown component for Time Off Type */
      #timeOffTypeWrapper { position:relative; }
      #timeOffTypeControl {
        background:linear-gradient(135deg,rgba(30,41,59,0.95),rgba(15,23,42,0.95));
        border:2px solid rgba(139,92,246,0.45);
        border-radius:14px; padding:20px 60px 20px 24px;
        font-size:18px; font-weight:700; color:#f1f5f9; cursor:pointer;
        display:flex; align-items:center; position:relative; user-select:none;
        transition:all .25s; box-shadow:0 4px 14px rgba(139,92,246,0.18);
      }
      #timeOffTypeControl:hover { border-color:rgba(139,92,246,0.7); box-shadow:0 8px 24px rgba(139,92,246,0.35); transform:translateY(-2px); }
      #timeOffTypeControl.open { border-color:#8b5cf6; box-shadow:0 12px 30px rgba(139,92,246,0.45); }
      #timeOffTypeDisplay.placeholder { color:#94a3b8; font-style:italic; animation:pulseSelect 2.2s ease-in-out infinite; }
      @keyframes pulseSelect { 0%,100% { opacity:1 } 50% { opacity:.55 } }
      #timeOffTypeArrow { position:absolute; right:20px; top:50%; transform:translateY(-50%); width:28px; height:28px; display:flex; align-items:center; justify-content:center; pointer-events:none; transition:transform .3s; }
      #timeOffTypeControl.open #timeOffTypeArrow { transform:translateY(-50%) rotate(180deg); }
      #timeOffTypePanel {
        position:absolute; left:0; top:calc(100% + 8px); width:100%; z-index:1000;
        background:linear-gradient(135deg,rgba(15,23,42,0.98),rgba(30,41,59,0.98));
        border:2px solid rgba(139,92,246,0.5); border-radius:16px; padding:12px 12px 14px;
        box-shadow:0 24px 60px -12px rgba(0,0,0,0.7); backdrop-filter:blur(5px);
        max-height:340px; overflow-y:auto; scrollbar-width:thin; scrollbar-color:#8b5cf6 rgba(15,23,42,0.55);
        animation:dropdownIn .25s cubic-bezier(.4,0,.2,1);
      }
      @keyframes dropdownIn { from { opacity:0; transform:translateY(-8px) scale(.96) } to { opacity:1; transform:translateY(0) scale(1) } }
      #timeOffTypePanel::-webkit-scrollbar { width:12px !important; }
      #timeOffTypePanel::-webkit-scrollbar-track {
        background:rgba(15,23,42,0.65) !important;
        border-radius:10px !important;
        margin:6px 0 !important;
        border:1px solid rgba(139,92,246,0.25) !important;
      }
      #timeOffTypePanel::-webkit-scrollbar-thumb {
        background:linear-gradient(180deg,#8b5cf6 0%, #6366f1 100%) !important;
        border-radius:10px !important;
        border:2px solid rgba(15,23,42,0.5) !important;
        box-shadow:0 2px 6px rgba(139,92,246,0.4) !important;
      }
      #timeOffTypePanel::-webkit-scrollbar-thumb:hover {
        background:linear-gradient(180deg,#a855f7 0%, #7c3aed 100%) !important;
        box-shadow:0 4px 10px rgba(139,92,246,0.6) !important;
      }
      #timeOffTypePanel::-webkit-scrollbar-thumb:active {
        background:linear-gradient(180deg,#7c3aed 0%, #6366f1 100%) !important;
      }
      .timeOffTypeOption {
        display:flex; align-items:center; gap:12px; padding:14px 16px; border:2px solid rgba(139,92,246,0.25);
        border-radius:12px; margin:6px 4px; cursor:pointer; font-size:15px; font-weight:600; color:#f1f5f9;
        background:linear-gradient(135deg,rgba(31,41,55,0.85),rgba(17,24,39,0.85)); transition:all .22s;
      }
      .timeOffTypeOption:hover { border-color:rgba(139,92,246,0.6); background:linear-gradient(135deg,rgba(49,60,82,0.9),rgba(27,34,48,0.9)); box-shadow:0 6px 16px rgba(139,92,246,0.35); transform:translateY(-2px); }
      .timeOffTypeOption:active { transform:translateY(0); }
      .timeOffTypeOption.selected { border-color:#8b5cf6; background:linear-gradient(135deg,#8b5cf6,#6366f1); color:#fff; box-shadow:0 6px 18px rgba(139,92,246,0.5); }
      .timeOffTypeBadge { font-size:11px; font-weight:700; padding:4px 8px; border-radius:8px; background:rgba(139,92,246,0.18); color:#c4b5fd; letter-spacing:.5px; }
      @media (hover:none) { #timeOffTypeControl:hover { transform:none; } }
    </style>
    <div style="margin-bottom:32px">
      <label for="timeOffReasonModal" style="font-size:13px;font-weight:700;color:#cbd5e1;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:16px;display:block">Type</label>
      <div id="timeOffTypeWrapper">
        <!-- Hidden native select (kept for existing JS logic) -->
        <select id="timeOffReasonModal" style="display:none">
          <option value="vacation">Vacation</option>
          <option value="sick">Sick Day</option>
          <option value="personal">Personal Day</option>
          <option value="appointment">Appointment</option>
          <option value="blocked">Blocked Date</option>
        </select>
        <!-- Custom control -->
        <div id="timeOffTypeControl" tabindex="0">
          <span id="timeOffTypeDisplay" class="placeholder">Select</span>
          <div id="timeOffTypeArrow">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 9l-7 7-7-7"/></svg>
          </div>
        </div>
        <div id="timeOffTypePanel" style="display:none">
          <div class="timeOffTypeOption" data-value="vacation" data-label="Vacation">
            <div class="timeOffTypeBadge">VACATION</div><div>Vacation</div>
          </div>
          <div class="timeOffTypeOption" data-value="sick" data-label="Sick Day">
            <div class="timeOffTypeBadge">SICK</div><div>Sick Day</div>
          </div>
            <div class="timeOffTypeOption" data-value="personal" data-label="Personal Day">
            <div class="timeOffTypeBadge">PERSONAL</div><div>Personal Day</div>
          </div>
          <div class="timeOffTypeOption" data-value="appointment" data-label="Appointment">
            <div class="timeOffTypeBadge">APPT</div><div>Appointment</div>
          </div>
          <div class="timeOffTypeOption" data-value="blocked" data-label="Blocked Date">
            <div class="timeOffTypeBadge">BLOCKED</div><div>Blocked Date</div>
          </div>
        </div>
      </div>
    </div>
    <script>
      // Initialize custom dropdown behavior
      (function(){
        const native = document.getElementById('timeOffReasonModal');
        const control = document.getElementById('timeOffTypeControl');
        const panel = document.getElementById('timeOffTypePanel');
        const display = document.getElementById('timeOffTypeDisplay');
        let open = false;
        function closePanel(){ panel.style.display='none'; control.classList.remove('open'); open=false; }
        function openPanel(){ panel.style.display='block'; control.classList.add('open'); open=true; }
        control.addEventListener('click', ()=> open? closePanel() : openPanel());
        control.addEventListener('keydown', e => {
          if(e.key==='Enter' || e.key===' '){ e.preventDefault(); open? closePanel() : openPanel(); }
          if(e.key==='Escape' && open){ closePanel(); }
        });
        panel.querySelectorAll('.timeOffTypeOption').forEach(opt => {
          opt.addEventListener('click', () => {
            panel.querySelectorAll('.timeOffTypeOption').forEach(o=>o.classList.remove('selected'));
            opt.classList.add('selected');
            const val = opt.getAttribute('data-value');
            const label = opt.getAttribute('data-label');
            native.value = val;
            display.textContent = label;
            display.classList.remove('placeholder');
            closePanel();
          });
        });
        document.addEventListener('click', e => { if(!control.contains(e.target) && !panel.contains(e.target)) closePanel(); });
      })();
    </script>
    
    <div style="display:flex;gap:12px;padding-top:24px;border-top:1px solid rgba(148,163,184,0.1)">
      <button id="btnCancelTimeOffModal" type="button" style="flex:1;min-height:56px;font-size:16px;font-weight:700;border-radius:14px;background:rgba(51,65,85,0.9);border:2px solid rgba(148,163,184,0.3);color:#e2e8f0;cursor:pointer;transition:all 0.25s;display:inline-flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2)"
              onmouseover="this.style.background='rgba(71,85,105,0.9)';this.style.borderColor='rgba(148,163,184,0.5)';this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.3)'" 
              onmouseout="this.style.background='rgba(51,65,85,0.9)';this.style.borderColor='rgba(148,163,184,0.3)';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'">
        Cancel
      </button>
      <button id="btnSubmitTimeOffModal" type="button" style="flex:1;min-height:56px;font-size:16px;font-weight:700;border-radius:14px;background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);border:none;color:#fff;cursor:pointer;transition:all 0.25s;display:inline-flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 12px rgba(245,158,11,0.3)"
              onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(245,158,11,0.4)'" 
              onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(245,158,11,0.3)'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
        Submit Request
      </button>
    </div>
  </div>
</div>

<!-- Payout History Modal -->
<div id="payoutHistoryModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="historyModalTitle">
  <div class="sheet" style="max-width:900px;padding:32px;background:linear-gradient(135deg, rgba(15,23,42,0.98) 0%, rgba(30,41,59,0.98) 100%);border:2px solid rgba(59,130,246,0.2);box-shadow:0 25px 50px -12px rgba(0,0,0,0.5)">
    <div style="background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);padding:32px;border-radius:16px;margin-bottom:32px;box-shadow:0 10px 30px rgba(59,130,246,0.3)">
      <h3 id="historyModalTitle" style="font-size:32px;font-weight:800;color:#fff;margin:0 0 8px 0;letter-spacing:-0.02em">Payout History</h3>
      <p style="font-size:15px;color:rgba(255,255,255,0.9);margin:0">View all your earnings and withdrawals</p>
    </div>
    
    <div id="historyContent" style="max-height:500px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:rgba(59,130,246,0.6) rgba(15,23,42,0.5)">
      <style>
        #historyContent::-webkit-scrollbar {
          width: 12px !important;
        }
        #historyContent::-webkit-scrollbar-track {
          background: rgba(15,23,42,0.6) !important;
          border-radius: 10px !important;
          margin: 8px 0 !important;
        }
        #historyContent::-webkit-scrollbar-thumb {
          background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%) !important;
          border-radius: 10px !important;
          border: 2px solid rgba(15,23,42,0.4) !important;
        }
        #historyContent::-webkit-scrollbar-thumb:hover {
          background: linear-gradient(180deg, #60a5fa 0%, #3b82f6 100%) !important;
        }
      </style>
      
      <div id="historyList">
        <div style="text-align:center;padding:60px 20px;color:#94a3b8">
          <div class="spin" style="margin:0 auto 20px;width:48px;height:48px"></div>
          <div style="font-size:15px">Loading history...</div>
        </div>
      </div>
    </div>
    
    <div style="display:flex;gap:12px;padding-top:24px;margin-top:24px;border-top:1px solid rgba(148,163,184,0.1)">
      <button id="btnCloseHistory" type="button" style="flex:1;min-height:56px;font-size:16px;font-weight:700;border-radius:14px;background:rgba(51,65,85,0.9);border:2px solid rgba(148,163,184,0.3);color:#e2e8f0;cursor:pointer;transition:all 0.25s;display:inline-flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2)"
              onmouseover="this.style.background='rgba(71,85,105,0.9)';this.style.borderColor='rgba(148,163,184,0.5)';this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.3)'" 
              onmouseout="this.style.background='rgba(51,65,85,0.9)';this.style.borderColor='rgba(148,163,184,0.3)';this.style.transform='translateY(0)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Support Ticket Modal -->
<div id="supportModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="supportModalTitle">
  <div class="sheet" style="max-width:640px">
    <div style="margin-bottom:20px">
      <h3 id="supportModalTitle" style="font-size:24px;font-weight:700;color:#f8fafc;margin-bottom:8px">Contact Support</h3>
      <p style="font-size:14px;color:#94a3b8;line-height:1.6">Describe your issue and we'll email support and create a ticket automatically.</p>
    </div>
    <div style="margin-bottom:16px">
      <label class="label-modern" for="supportSubject" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1">Subject</label>
      <input id="supportSubject" class="input-modern" type="text" placeholder="Short summary" maxlength="120" style="width:100%;font-size:16px;padding:14px 16px">
    </div>
    <div class="grid-2" style="margin-bottom:16px">
      <div>
        <label class="label-modern" for="supportCategory" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1">Category</label>
        <select id="supportCategory" class="input-modern select-modern" style="width:100%;font-size:16px;padding:14px 16px">
          <option>General</option>
          <option>Login</option>
          <option>Jobs</option>
          <option>Payments</option>
          <option>Training</option>
          <option>Bug</option>
        </select>
      </div>
      <div>
        <label class="label-modern" for="supportSeverity" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1">Severity</label>
        <select id="supportSeverity" class="input-modern select-modern" style="width:100%;font-size:16px;padding:14px 16px">
          <option>Low</option>
          <option selected>Normal</option>
          <option>High</option>
          <option>Critical</option>
        </select>
      </div>
    </div>
    <div style="margin-bottom:24px">
      <label class="label-modern" for="supportMessage" style="display:block;margin-bottom:8px;font-weight:600;color:#cbd5e1">Message</label>
      <textarea id="supportMessage" class="input-modern" placeholder="What happened? Include any steps to reproduce or screenshots/links if helpful." style="width:100%;min-height:140px;padding:14px 16px"></textarea>
    </div>
    <div class="row" style="gap:12px;justify-content:flex-end">
      <button id="btnCancelSupportModal" class="btn-modern btn-secondary" type="button" style="min-width:120px">Cancel</button>
      <button id="btnSubmitSupportModal" class="btn-modern" type="button" style="min-width:180px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px">
          <path d="M22 2L11 13"></path>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
        Send to Support
      </button>
    </div>
  </div>
  
</div>

<div id="videoModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="videoTitle">
  <div class="sheet" style="max-width:1200px">
    <div class="video-modal-body">
      <div>
        <h3 id="videoTitle" style="font-size:24px;margin-bottom:8px">Training Video</h3>
        <div class="video-stats">
          <span class="video-stat">📂 <span id="videoModule"></span></span>
          <span class="video-stat" id="videoLevel"></span>
          <span class="video-stat" id="videoDuration"></span>
          <span class="video-stat" id="videoProgressStatus"></span>
        </div>
        <div id="videoProgressBar" style="display:none;margin-top:12px;background:rgba(255,255,255,.1);border-radius:8px;height:6px;overflow:hidden">
          <div id="videoProgressFill" style="height:100%;background:linear-gradient(90deg,#1493ff,#60b5ff);width:0%;transition:width .3s ease"></div>
        </div>
        <div id="videoWatchTime" style="display:none;margin-top:6px;font-size:12px;opacity:.75"></div>
      </div>
      <div id="videoPlayer" style="aspect-ratio:16/9;background:linear-gradient(135deg,#1a4a7a 0%,#0f2d52 100%);border-radius:14px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.3)"></div>
      <div id="videoDescription" class="muted" style="line-height:1.6;font-size:15px"></div>
      <div class="row" style="margin-top:16px;justify-content:space-between;align-items:center">
        <button id="videoMarkComplete" class="btn" type="button" style="min-width:160px">✓ Mark Complete</button>
        <button id="videoClose" class="btn secondary" type="button">Close</button>
      </div>
      <p class="muted" style="margin-top:10px;font-size:13px">Tip: Your progress is automatically saved every 10 seconds. Close anytime to resume later.</p>
    </div>
  </div>
</div>

<!-- Welcome modal for new users -->
<div id="welcomeModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="welcomeTitle">
  <div class="sheet" style="max-width:560px">
    <h3 id="welcomeTitle" style="font-size:24px;margin-bottom:12px">Welcome to Home2Smart!</h3>
    <p style="line-height:1.7;margin-bottom:16px;font-size:15px;color:#cbd5e1">
      Before you start accepting jobs, please complete your profile in the <strong>Account</strong> tab.
    </p>
    <div style="background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);border-radius:12px;padding:16px;margin-bottom:20px">
      <p style="margin:0;font-size:14px;line-height:1.6;color:#bfdbfe">
        <strong style="color:#60a5fa;display:block;margin-bottom:8px">Required info:</strong>
        • Vehicle description<br>
        • Max service radius (miles)<br>
        • Max jobs per day<br>
        • Profile photo & short bio
      </p>
    </div>
    <p class="muted" style="margin-bottom:20px;font-size:14px">
      This info helps customers know who's coming and helps us send you the right jobs.
    </p>
    <div class="row">
      <button id="welcomeGoToProfile" class="btn" type="button">Complete Profile →</button>
      <button id="welcomeLater" class="btn secondary" type="button">I'll do it later</button>
    </div>
  </div>
</div>

<div id="loader" class="loader" aria-live="polite"><div class="spin" role="status" aria-label="Loading"></div></div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
// Global function declarations (needed for inline onclick handlers)
window.switchCustomerTab = function() { console.warn('switchCustomerTab not ready yet'); };

document.addEventListener("DOMContentLoaded", function() {

// ===== MOBILE HEADER AUTO-HIDE ON SCROLL =====
let lastScrollY = 0;
let scrollTimeout;
const header = document.querySelector('.header');

if (header && window.innerWidth <= 640) {
  window.addEventListener('scroll', () => {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      const currentScrollY = window.scrollY;
      
      if (currentScrollY < 50) {
        // Always show at top
        header.classList.remove('header-hidden');
      } else if (currentScrollY > lastScrollY && currentScrollY > 100) {
        // Scrolling down - hide header
        header.classList.add('header-hidden');
      } else if (currentScrollY < lastScrollY) {
        // Scrolling up - show header
        header.classList.remove('header-hidden');
      }
      
      lastScrollY = currentScrollY;
    }, 10);
  }, { passive: true });
}

// ===== EXISTING CODE CONTINUES ===== 
/* ===== CONFIG ===== */
// API Configuration - Use h2s-backend.vercel.app (auto-aliases to latest production)
const VERCEL_API = "https://h2s-backend.vercel.app/api";

// Unified API Endpoint (Vercel Only)
const API = VERCEL_API;
const LS_TOKEN = "h2s_portal_token";
const LS_ADMIN_TOKEN = "h2s_admin_token";

/* ===== UTIL ===== */
const $ = id => document.getElementById(id);

// ✅ TECH SUPPLIES - Items techs carry in their van, NOT job-specific orders
const TECH_SUPPLIED_ITEMS = [
  // Basic tools & hardware techs always have
  'hdmi', 'hdmi cable', 'display cable', 'video cable',
  'basic tools', 'screwdriver', 'drill',
  'wire strippers', 'fish tape', 'stud finder',
  'level', 'tape measure', 'utility knife',
  
  // Common consumables techs stock
  'wire nuts', 'electrical tape', 'cable ties', 'zip ties',
  'small screws', 'basic anchors', 'cable clips',
  'velcro strips', 'adhesive pads',
  
  // Standard networking supplies
  'ethernet cable', 'cat5', 'cat6', 'network cable',
  'coax cable', 'cable connectors', 'wall plates',
  
  // Testing equipment
  'voltage tester', 'cable tester', 'multimeter'
];

// Helper function to check if item is tech-supplied
function isTechSuppliedItem(itemName) {
  if (!itemName) return false;
  const nameLower = itemName.toLowerCase();
  return TECH_SUPPLIED_ITEMS.some(supply => nameLower.includes(supply));
}

// ========================================
// � REAL-TIME DASHBOARD SYSTEM
// ========================================

let supabaseClient = null;
let realtimeChannel = null;
let connectionIndicator = null;

// Initialize Supabase real-time connection
async function initRealtimeSync() {
  try {
    if (!window.supabase) {
      console.warn('[Realtime] Supabase SDK not loaded');
      return;
    }
    
    if (!adminToken) {
      console.warn('[Realtime] No admin token available');
      return;
    }

    console.log('[Realtime] 🔴 Fetching secure Supabase credentials...');
    
    // Fetch Supabase credentials securely from backend
    const response = await fetch(`${VERCEL_API}/get_supabase_config`, {
      headers: { 'Authorization': `Bearer ${adminToken}` }
    });
    
    if (!response.ok) {
      throw new Error(`Failed to get config: ${response.status}`);
    }
    
    const config = await response.json();
    console.log('[Realtime] ✅ Credentials received:', config.url);
    
    // Create Supabase client with credentials from backend
    supabaseClient = window.supabase.createClient(config.url, config.anonKey);
    
    console.log('[Realtime] 🔴 Initializing live connection...');
    
    // Create connection status indicator
    createConnectionIndicator();
    
    // Subscribe to job changes
    realtimeChannel = supabaseClient
      .channel('dispatch-jobs-channel')
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'h2s_dispatch_jobs' }, 
        (payload) => {
          console.log('[Realtime] 📡 Job update received:', payload);
          handleJobUpdate(payload);
        }
      )
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'h2s_dispatch_job_assignments' }, 
        (payload) => {
          console.log('[Realtime] 📡 Assignment update received:', payload);
          handleAssignmentUpdate(payload);
        }
      )
      .subscribe((status) => {
        console.log('[Realtime] Connection status:', status);
        updateConnectionIndicator(status);
        
        if (status === 'SUBSCRIBED') {
          console.log('[Realtime] ✅ Live updates active');
          if (typeof showToast === 'function') {
            showToast('🔴 Live updates active', 'success');
          }
        } else if (status === 'CLOSED') {
          console.warn('[Realtime] ⚠️ Connection closed');
          if (typeof showToast === 'function') {
            showToast('⚠️ Live updates disconnected', 'warning');
          }
        }
      });
      
  } catch (error) {
    console.error('[Realtime] ❌ Failed to initialize:', error);
    // Don't show toast on error - login should still work
  }
}// Create visual connection indicator
function createConnectionIndicator() {
  const indicator = document.createElement('div');
  indicator.id = 'realtimeIndicator';
  indicator.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  `;
  indicator.innerHTML = '<span style="width:8px;height:8px;border-radius:50%;background:#666;display:inline-block;"></span> Connecting...';
  document.body.appendChild(indicator);
  connectionIndicator = indicator;
}

// Update connection indicator visual state
function updateConnectionIndicator(status) {
  if (!connectionIndicator) return;
  
  const dot = connectionIndicator.querySelector('span');
  
  if (status === 'SUBSCRIBED') {
    connectionIndicator.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    connectionIndicator.style.color = '#fff';
    dot.style.background = '#4ade80';
    dot.style.boxShadow = '0 0 8px #4ade80';
    connectionIndicator.innerHTML = '<span style="width:8px;height:8px;border-radius:50%;background:#4ade80;display:inline-block;box-shadow:0 0 8px #4ade80;animation:pulse 2s infinite;"></span> 🔴 LIVE';
  } else if (status === 'CHANNEL_ERROR' || status === 'CLOSED') {
    connectionIndicator.style.background = '#ef4444';
    connectionIndicator.style.color = '#fff';
    dot.style.background = '#fbbf24';
    connectionIndicator.innerHTML = '<span style="width:8px;height:8px;border-radius:50%;background:#fbbf24;display:inline-block;"></span> ⚠️ Disconnected';
  } else {
    connectionIndicator.style.background = '#6b7280';
    connectionIndicator.style.color = '#fff';
    dot.style.background = '#d1d5db';
    connectionIndicator.innerHTML = '<span style="width:8px;height:8px;border-radius:50%;background:#d1d5db;display:inline-block;"></span> Connecting...';
  }
}

// Handle job updates in real-time
function handleJobUpdate(payload) {
  const { eventType, new: newRecord, old: oldRecord } = payload;
  
  // Show notification (dedupe new job toasts to avoid noise on rejoin)
  if (eventType === 'INSERT') {
    if (shouldNotifyNewJob(newRecord.job_id)) {
      showToast(`✨ New job created: ${newRecord.service_id || 'Job'}`, 'info');
      playNotificationSound();
    }
  } else if (eventType === 'UPDATE') {
    showToast(`🔄 Job updated: ${newRecord.job_id?.substring(0, 8)}`, 'info');
  } else if (eventType === 'DELETE') {
    showToast(`🗑️ Job deleted`, 'info');
  }
  
  // Auto-refresh job list if in admin view
  if (isAdmin && $("jobsPanel")?.style.display !== 'none') {
    console.log('[Realtime] Auto-refreshing admin job list...');
    invalidateCache('adminJobs');
    setTimeout(() => {
      adminLoadJobs();
    }, 500); // Small delay for smooth animation
  }
  
  // Auto-refresh portal jobs if in tech view
  if (!isAdmin && token) {
    console.log('[Realtime] Auto-refreshing tech jobs...');
    invalidateCache('jobs');
    setTimeout(() => {
      loadJobs();
    }, 500);
  }
}

// Handle assignment updates
function handleAssignmentUpdate(payload) {
  const { eventType, new: newRecord } = payload;
  
  if (eventType === 'INSERT' && newRecord.state === 'offer_sent') {
    if (shouldNotifyNewJob(newRecord.job_id)) {
      showToast(`📬 New job offer received!`, 'success');
      playNotificationSound();
    }
  } else if (eventType === 'UPDATE' && newRecord.state === 'accepted') {
    showToast(`✅ Job accepted`, 'success');
  }
  
  // Auto-refresh if viewing relevant data
  if (!isAdmin && token) {
    invalidateCache('jobs');
    setTimeout(() => loadJobs(), 500);
  }
}

// Show toast notification
function showToast(message, type = 'info') {
  const existingToast = document.getElementById('realtimeToast');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.id = 'realtimeToast';
  toast.textContent = message;
  
  const colors = {
    info: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    success: 'linear-gradient(135deg, #4ade80 0%, #10b981 100%)',
    warning: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)',
    error: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'
  };
  
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 16px 24px;
    border-radius: 8px;
    color: #fff;
    font-weight: 600;
    z-index: 10001;
    background: ${colors[type] || colors.info};
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideInRight 0.3s ease;
  `;
  
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// Play subtle notification sound
function playNotificationSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.2);
  } catch (error) {
    console.warn('[Realtime] Could not play sound:', error);
  }
}

/* ===== 🕐 LAST UPDATE INDICATOR ===== */
let lastUpdateTime = null;
let updateIndicatorInterval = null;

function updateLastUpdateIndicator() {
  lastUpdateTime = Date.now();
  renderLastUpdateTime();
  
  // Clear existing interval
  if (updateIndicatorInterval) {
    clearInterval(updateIndicatorInterval);
  }
  
  // Update every 5 seconds to show "X seconds ago"
  updateIndicatorInterval = setInterval(renderLastUpdateTime, 5000);
}

function renderLastUpdateTime() {
  const indicator = document.getElementById('lastUpdateIndicator');
  if (!indicator || !lastUpdateTime) return;
  
  const seconds = Math.floor((Date.now() - lastUpdateTime) / 1000);
  
  if (seconds < 5) {
    indicator.textContent = '• Just updated';
    indicator.style.color = '#10b981'; // Green
  } else if (seconds < 60) {
    indicator.textContent = `• ${seconds}s ago`;
    indicator.style.color = '#6b7280'; // Gray
  } else {
    const minutes = Math.floor(seconds / 60);
    indicator.textContent = `• ${minutes}m ago`;
    indicator.style.color = '#9ca3af'; // Light gray
  }
}

function pulseJobsList() {
  const list = document.getElementById('adList');
  if (!list) return;
  
  // Add subtle pulse animation
  list.style.animation = 'none';
  setTimeout(() => {
    list.style.animation = 'fadeIn 0.3s ease';
  }, 10);
}

/* ===== END LAST UPDATE INDICATOR ===== */

// Play subtle notification sound
function playNotificationSound() {
  // Create subtle beep using Web Audio API
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
  } catch (e) {
    // Silent fail if audio not supported
  }
}


// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  if (realtimeChannel) {
    realtimeChannel.unsubscribe();
    console.log('[Realtime] Disconnected');
  }
});

// ========================================
// �🚀 PERFORMANCE OPTIMIZATION SYSTEM
// ========================================

// ✅ PERFORMANCE: Track loading times for monitoring
const perfMetrics = {
  renderTimes: [],
  apiTimes: [],
  cacheHits: 0,
  cacheMisses: 0
};

function recordMetric(type, duration) {
  if (type === 'render' && duration < 5000) { // Ignore outliers
    perfMetrics.renderTimes.push(duration);
    if (perfMetrics.renderTimes.length > 10) perfMetrics.renderTimes.shift(); // Keep last 10
  } else if (type === 'api' && duration < 10000) {
    perfMetrics.apiTimes.push(duration);
    if (perfMetrics.apiTimes.length > 10) perfMetrics.apiTimes.shift();
  }
}

function getAvgMetric(type) {
  const arr = type === 'render' ? perfMetrics.renderTimes : perfMetrics.apiTimes;
  if (arr.length === 0) return 0;
  return Math.round(arr.reduce((a,b) => a + b, 0) / arr.length);
}

// Tab data cache - prevents reloading already-fetched data
const tabCache = {
  dash: { data: null, timestamp: 0, ttl: 300000 },      // 5min cache (jobs change but not THAT fast)
  payouts: { data: null, timestamp: 0, ttl: 600000 },   // 10min cache (payouts rarely change)
  reviews: { data: null, timestamp: 0, ttl: 600000 },   // 10min cache
  schedule: { data: null, timestamp: 0, ttl: 300000 },  // 5min cache
  training: { data: null, timestamp: 0, ttl: 3600000 }, // 1hr cache (rarely changes)
  announcements: { data: null, timestamp: 0, ttl: 300000 }, // 5min cache (🚀 NEW: announcements cache)
  adminJobs: { data: null, timestamp: 0, ttl: 30000 },  // 30s cache (admin needs fresher data)
  me: { data: null, timestamp: 0, ttl: 600000 },        // 10min cache (user profile rarely changes)
};

// Load cache from LocalStorage on startup
function loadCacheFromStorage() {
  try {
    // 🔒 SECURITY: Cache must be tied to current user's token
    const cacheKey = `h2s_portal_cache_${token || adminToken || 'anon'}`;
    const stored = localStorage.getItem(cacheKey);
    if (stored) {
      const parsed = JSON.parse(stored);
      Object.keys(parsed).forEach(key => {
        if (tabCache[key]) {
          tabCache[key].data = parsed[key].data;
          tabCache[key].timestamp = parsed[key].timestamp;
        }
      });
    }
  } catch (err) {
    console.error('[CACHE] Failed to load from storage:', err);
  }
}

// Save cache to LocalStorage
function saveCacheToStorage() {
  try {
    // 🔒 SECURITY: Cache is user-specific
    const cacheKey = `h2s_portal_cache_${token || adminToken || 'anon'}`;
    const toStore = {};
    Object.keys(tabCache).forEach(key => {
      if (tabCache[key].data) {
        toStore[key] = {
          data: tabCache[key].data,
          timestamp: tabCache[key].timestamp
        };
      }
    });
    localStorage.setItem(cacheKey, JSON.stringify(toStore));
  } catch (err) {
    console.error('[CACHE] Failed to save to storage:', err);
  }
}

// Check if cached data is still valid
function isCacheValid(cacheKey) {
  const c = tabCache[cacheKey];
  if (!c || !c.data) return false;
  return (Date.now() - c.timestamp) < c.ttl;
}

// Store data in cache
function setCache(cacheKey, data) {
  if (tabCache[cacheKey]) {
    tabCache[cacheKey].data = data;
    tabCache[cacheKey].timestamp = Date.now();
    console.log(`[CACHE] ✅ Stored ${cacheKey} (valid for ${tabCache[cacheKey].ttl/1000}s)`);
    
    // Save to localStorage for persistence across refreshes
    saveCacheToStorage();
  }
}

// Get cached data
function getCache(cacheKey) {
  if (isCacheValid(cacheKey)) {
    perfMetrics.cacheHits++;
    console.log(`[CACHE] 🎯 Hit ${cacheKey} (age: ${Math.round((Date.now() - tabCache[cacheKey].timestamp)/1000)}s)`);
    return tabCache[cacheKey].data;
  }
  perfMetrics.cacheMisses++;
  console.log(`[CACHE] ❌ Miss ${cacheKey}`);
  return null;
}

// Invalidate specific cache (for manual refresh)
function invalidateCache(cacheKey) {
  if (tabCache[cacheKey]) {
    tabCache[cacheKey].data = null;
    tabCache[cacheKey].timestamp = 0;
    console.log(`[CACHE] 🗑️ Invalidated ${cacheKey}`);
    
    // ✅ FIX: Also remove from localStorage immediately
    try {
      const storageKey = `h2s_portal_cache_${token || adminToken || 'anon'}`;
      const stored = localStorage.getItem(storageKey);
      if (stored) {
        const parsed = JSON.parse(stored);
        delete parsed[cacheKey];
        localStorage.setItem(storageKey, JSON.stringify(parsed));
        console.log(`[CACHE] 🗑️ Removed ${cacheKey} from localStorage`);
      }
    } catch (err) {
      console.error('[CACHE] Failed to remove from localStorage:', err);
    }
  }
}

// Prefetch next likely tab (predictive loading)
let prefetchTimer = null;
function prefetchNextTab(currentTab) {
  clearTimeout(prefetchTimer);
  
  // Predict next tab based on common user flows
  const prefetchMap = {
    dash: 'schedule',     // After checking jobs, often check schedule
    schedule: 'payouts',  // After schedule, check payouts
    payouts: 'reviews',   // After payouts, check reviews
    reviews: 'profile',   // After reviews, update profile
  };
  
  const nextTab = prefetchMap[currentTab];
  if (!nextTab) return;
  
  // Prefetch after 1 second of staying on current tab
  prefetchTimer = setTimeout(() => {
    if (!isCacheValid(nextTab)) {
      console.log(`[PREFETCH] 🔮 Loading ${nextTab} in background...`);
      // Silently load in background without showing loader
      if (nextTab === 'schedule') prefetchSchedule();
      else if (nextTab === 'payouts') prefetchPayouts();
      else if (nextTab === 'reviews') prefetchReviews();
    }
  }, 1000);
}

// Prefetch functions - load data silently without showing UI changes
async function prefetchPayouts() {
  try {
    const out = await GET("portal_payouts", {token});
    if (out.ok && out.rows) {
      // Process and cache
      const rows = out.rows;
      const periodMap = {};
      let currentPeriodTotal = 0, pendingTotal = 0, ytdTotal = 0;
      const now = new Date();
      
      rows.forEach(r => {
        const amount = asNum(r.amount);
        ytdTotal += amount;
        if (r.state === "pending") pendingTotal += amount;
        const periodKey = r.period_start + "_" + r.period_end;
        if (!periodMap[periodKey]) {
          periodMap[periodKey] = {start: r.period_start, end: r.period_end, total: 0, paid: 0, pending: 0, rows: []};
        }
        periodMap[periodKey].total += amount;
        if (r.state === "paid") periodMap[periodKey].paid += amount;
        if (r.state === "pending") periodMap[periodKey].pending += amount;
        periodMap[periodKey].rows.push(r);
        
        const periodStart = new Date(r.period_start);
        const periodEnd = new Date(r.period_end);
        if (now >= periodStart && now <= periodEnd && r.state === "open") {
          currentPeriodTotal += amount;
        }
      });
      
      setCache('payouts', {rows, periodMap, currentPeriodTotal, pendingTotal, ytdTotal});
      console.log('[PREFETCH] ✅ Payouts cached');
    }
  } catch (err) {
    console.log('[PREFETCH] ⚠️ Payouts failed (silent):', err.message);
  }
}

async function prefetchReviews() {
  try {
    const out = await GET("portal_reviews_get", {token});
    if (out.ok && out.reviews) {
      setCache('reviews', out.reviews);
      console.log('[PREFETCH] ✅ Reviews cached');
    }
  } catch (err) {
    console.log('[PREFETCH] ⚠️ Reviews failed (silent):', err.message);
  }
}

async function prefetchSchedule() {
  try {
    // Schedule loading is lightweight, cache the jobs we already have
    if (currentJobsData && currentJobsData.upcoming) {
      setCache('schedule', currentJobsData);
      console.log('[PREFETCH] ✅ Schedule cached from current jobs');
    }
  } catch (err) {
    console.log('[PREFETCH] ⚠️ Schedule failed (silent):', err.message);
  }
}

// ✅ PERFORMANCE: Request deduplication - prevent multiple identical requests
const pendingRequests = new Map();

// ✅ PERFORMANCE: Request batching - group simultaneous requests
let requestBatch = [];
let batchTimer = null;

// ✅ DEBOUNCE: Prevent rapid-fire function calls
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ✅ THROTTLE: Limit function execution rate
function throttle(func, limit) {
  let inThrottle;
  return function(...args) {
    if (!inThrottle) {
      func.apply(this, args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

function toast(msg, duration = 2400) {
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(() => t.style.display = "none", duration);
}
function loading(on) { $("loader").style.display = on ? "grid" : "none"; }
function esc(s) { return String(s||"").replace(/[<>&"]/g, c => ({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[c])); }
function qs(obj) {
  const u = new URLSearchParams();
  Object.entries(obj).forEach(([k,v]) => { if (v !== undefined && v !== null) u.set(k, String(v)); });
  return u.toString();
}
async function GET(action, payload={}) {
  console.log(`[GET] 🌐 ${action}`, payload);
  console.log(`[GET] 🔑 Token in payload:`, payload.token ? `${payload.token.substring(0,20)}...` : 'MISSING');
  
  // List of all Vercel endpoints (faster, no CORS issues)
  const VERCEL_ENDPOINTS = [
    // Portal endpoints
    'portal_login', 'portal_signup_step1', 'portal_me', 'portal_jobs', 
    'portal_accept', 'portal_decline', 'portal_mark_done', 'portal_payouts',
    'portal_reviews_get', 'portal_training',
    'portal_customers', 'portal_customer_history', 'portal_log_call',
    'portal_announcements_list', 'portal_announcements_create', 
    'portal_announcements_update', 'portal_announcements_delete', 
    'portal_announcements_mark_viewed',
    'portal_get_artifacts', 'portal_upload_artifact', 'portal_delete_artifact',
    'portal_upload_photo', 'portal_update_profile',
    'portal_on_my_way',
    // Admin endpoints
    'admin_login', 'admin_jobs_list', 'admin_job_delete', 
    'admin_dispatch', 'admin_send_offer', 'admin_geocode_all',
    // Job creation and config
    'create_jobs_from_orders', 'simulate_checkout', 'diagnostic',
    'get_supabase_config'
  ];
  
  // Check if this action should use Vercel
  const useVercel = true;
  const apiBase = VERCEL_API;
  
  console.log(`[GET] Using ${useVercel ? 'VERCEL' : 'APPS_SCRIPT'} for ${action}`);
  console.log(`[GET] 🌐 Endpoint: ${useVercel ? apiBase + '/' + action : 'query string'}`);
  
  if (useVercel) {
    const endpoint = `${apiBase}/${action}`;
    const requestKey = action + JSON.stringify(payload);
    
    // Request deduplication
    if (pendingRequests.has(requestKey)) {
      console.log(`[GET] ⏳ Waiting for in-flight request: ${action}`);
      return await pendingRequests.get(requestKey);
    }
    
    const requestPromise = (async () => {
      try {
        console.log(`[GET] 📡 Fetching ${action} from Vercel...`);
        
        // Build headers
        const headers = {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        };
        
        // Add bearer token if available (from payload OR global)
        // ⚠️ CRITICAL FIX: Ensure we don't access 'token' if it's not initialized yet
        let globalToken = null;
        try {
          if (typeof token !== 'undefined') globalToken = token;
        } catch (e) { /* ignore */ }
        
        const authToken = payload.token || globalToken;
        
        // ⚠️ CORS FIX: Do NOT send Authorization header for Vercel endpoints
        // The token is already sent in the query string (for GET) or body (for POST)
        // Sending this header causes CORS preflight failures on some browsers/networks
        // UPDATE: We MUST send it for now until the backend deployment propagates
        if (authToken) {
          headers['Authorization'] = `Bearer ${authToken}`;
        }
        
        // Endpoints that require POST with body (login, signup, etc)
        const requiresPost = [
          'portal_login', 'portal_signup_step1', 'admin_login',
          'portal_jobs', 'portal_accept', 'portal_decline', 'portal_mark_done'  // These also need POST to send token
        ];
        const usePost = requiresPost.includes(action);
        
        // ✅ ROBUSTNESS: For GET requests, append all payload params to query string
        let finalEndpoint = endpoint;
        if (!usePost) {
          const queryParams = new URLSearchParams();
          
          // Add token first if available (from payload OR global)
          if (authToken && !endpoint.includes('token=')) {
            queryParams.append('token', authToken);
          }
          
          // Add all payload params as query string (for Vercel GET endpoints)
          Object.entries(payload).forEach(([key, value]) => {
            if (key !== 'token' && value !== undefined && value !== null) {
              queryParams.append(key, String(value));
            }
          });
          
          // ✅ CACHE BUSTER: Force browser to fetch fresh data
          queryParams.append('_t', Date.now());
          
          const queryString = queryParams.toString();
          if (queryString) {
            const separator = endpoint.includes('?') ? '&' : '?';
            finalEndpoint = `${endpoint}${separator}${queryString}`;
          }
        }
        
        console.log(`[GET] 🔗 Final endpoint:`, finalEndpoint);
        
        const res = await fetch(finalEndpoint, {
          method: usePost ? "POST" : "GET",
          headers: headers,
          body: usePost ? JSON.stringify(payload) : undefined
        });
        
        console.log(`[GET] 📨 Response status: ${res.status} ${res.statusText}`);
        
        // Always parse JSON response (backend sends {ok: true/false})
        const data = await res.json();
        console.log(`[GET] ✅ ${action} response:`, data);
        return data;
        
      } catch (err) {
        console.error(`[GET] 💥 ${action} exception:`, err);
        throw err;
      } finally {
        pendingRequests.delete(requestKey);
      }
    })();
    
    pendingRequests.set(requestKey, requestPromise);
    return await requestPromise;
  }
  
  // Apps Script (query string format)
  const qsObj = { action, ...payload, t: Date.now() };
  const url = apiBase + "?" + qs(qsObj);
  const requestKey = action + JSON.stringify(payload);
  
  console.log(`[GET] 🔗 Full URL:`, url);
  
  if (pendingRequests.has(requestKey)) {
    console.log(`[GET] ⏳ Waiting for in-flight request: ${action}`);
    return await pendingRequests.get(requestKey);
  }
  
  const requestPromise = (async () => {
    try {
      console.log(`[GET] 📡 Fetching ${action}...`);
      const res = await fetch(url, {
        method: "GET",
        cache: "no-store",
        headers: {
          'Accept': 'application/json',
        }
      });
      
      console.log(`[GET] 📨 Response status: ${res.status} ${res.statusText}`);
      
      if (!res.ok) {
        console.error(`[GET] ❌ ${action} failed:`, res.status, res.statusText);
        const errorText = await res.text();
        console.error(`[GET] ❌ Error body:`, errorText);
        throw new Error("Server " + res.status);
      }
      
      const responseText = await res.text();
      console.log(`[GET] 📄 Raw response text:`, responseText);
      
      let data;
      try {
        data = JSON.parse(responseText);
        console.log(`[GET] ✅ Parsed JSON:`, data);
      } catch(parseErr) {
        console.error(`[GET] ❌ JSON parse error:`, parseErr);
        console.error(`[GET] ❌ Response was:`, responseText);
        throw new Error("Invalid JSON response");
      }
      
      console.log(`[GET] ✅ ${action} completed successfully`);
      return data;
      
    } catch (err) {
      console.error(`[GET] 💥 ${action} exception:`, err);
      console.error(`[GET] 💥 Error stack:`, err.stack);
      throw err;
    } finally {
      pendingRequests.delete(requestKey);
    }
  })();
  
  pendingRequests.set(requestKey, requestPromise);
  return await requestPromise;
}
// JSONP helper for GAS (bypasses CORS by using <script> injection)
async function GET_JSONP(action, payload={}) {
  return new Promise((resolve, reject) => {
    const cb = 'h2s_cb_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
    const cleanup = (scriptEl) => {
      try { delete window[cb]; } catch(_){}
      if (scriptEl && scriptEl.parentNode) scriptEl.parentNode.removeChild(scriptEl);
    };
    window[cb] = (data) => { resolve(data); cleanup(scriptEl); };
  const qsObj = { action, ...payload, callback: cb, t: Date.now() };
  // JSONP is only used for Apps Script (bypasses CORS). Ensure we hit the Apps Script endpoint.
  const url = APPS_SCRIPT_API + '?' + qs(qsObj);
  console.log(`[JSONP] 🔗 ${action} -> (Apps Script)`, url);
    const scriptEl = document.createElement('script');
    scriptEl.src = url;
    scriptEl.async = true;
    scriptEl.onerror = () => { console.error(`[JSONP] ❌ ${action} failed to load`); reject(new Error('JSONP load error')); cleanup(scriptEl); };
    document.head.appendChild(scriptEl);
    setTimeout(() => { console.error(`[JSONP] ⏰ ${action} timed out`); reject(new Error('JSONP timeout')); cleanup(scriptEl); }, 12000);
  });
}
async function POST(action, payload={}) {
  console.log("POST request:", action, payload);
  
  // Dual-mode routing: portal_* actions → Vercel, admin_* actions → Apps Script
  const useVercel = true;
  const apiBase = VERCEL_API;
  const endpoint = `${apiBase}/${action}`;
  
  console.log(`[POST] Using ${useVercel ? 'VERCEL' : 'APPS_SCRIPT'} for ${action}`);
  
  try {
    if (useVercel) {
      // Vercel expects JSON body
      const headers = { "Content-Type": "application/json" };
      
      // Add Authorization header if token is present in payload
      if (payload.token) {
        headers["Authorization"] = `Bearer ${payload.token}`;
      }
      
      const res = await fetch(endpoint, {
        method: "POST",
        headers: headers,
        body: JSON.stringify(payload)
      });
      
      // ✅ ENHANCED ERROR HANDLING: Capture response body even on error
      if (!res.ok) {
        let errorDetail = `Server ${res.status}`;
        try {
          const errorBody = await res.text();
          console.error(`[POST] ${action} failed:`, {
            status: res.status,
            statusText: res.statusText,
            body: errorBody
          });
          
          // Try to parse as JSON for structured error
          try {
            const errorJson = JSON.parse(errorBody);
            if (errorJson.error) {
              errorDetail = errorJson.error;
            }
          } catch {}
          
        } catch (readErr) {
          console.error(`[POST] Could not read error body:`, readErr);
        }
        
        throw new Error(errorDetail);
      }
      
      const data = await res.json();
      console.log("POST response:", action, data);
      return data;
    } else {
      // Apps Script expects form data
      const form = new URLSearchParams();
      form.set("action", action);
      Object.entries(payload).forEach(([k,v]) => { form.set(k, v == null ? "" : String(v)); });
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: form.toString()
      });
      
      if (!res.ok) {
        let errorDetail = `Server ${res.status}`;
        try {
          const errorBody = await res.text();
          console.error(`[POST] ${action} failed:`, {
            status: res.status,
            statusText: res.statusText,
            body: errorBody
          });
          try {
            const errorJson = JSON.parse(errorBody);
            if (errorJson.error) {
              errorDetail = errorJson.error;
            }
          } catch {}
        } catch {}
        
        throw new Error(errorDetail);
      }
      
      const data = await res.json();
      console.log("POST response:", action, data);
      return data;
    }
  } catch (error) {
    console.error(`[POST] ${action} exception:`, error);
    throw error;
  }
}
function asNum(x) { const n = Number(x); return isFinite(n) ? n : 0; }
function fmtMoney(n) { return "$" + asNum(n).toFixed(2); }

/* ===== STATE ===== */
let token = localStorage.getItem(LS_TOKEN) || sessionStorage.getItem(LS_TOKEN) || "";
let adminToken = localStorage.getItem(LS_ADMIN_TOKEN) || "";
let me = null;
let isAdmin = false;
let currentTab = "dash";
const photoOnFile = {};
const signatureOnFile = {};
let jobPollInterval = null;
let lastOfferCount = 0;
let lastUpcomingCount = 0;

/* ===== SMART SESSION & VIEW RESTORE ===== */
// Persist current tab and scroll so refresh returns to same place
const VIEW_STATE_KEY = 'portal_view_state';

function saveViewState() {
  try {
    const state = {
      tab: currentTab,
      scrollY: window.scrollY,
      ts: Date.now()
    };
    localStorage.setItem(VIEW_STATE_KEY, JSON.stringify(state));
  } catch {}
}

function restoreViewState() {
  try {
    const raw = localStorage.getItem(VIEW_STATE_KEY);
    if (!raw) return;
    const state = JSON.parse(raw);
    if (!state) return;
    // Switch tab first, then restore scroll
    if (state.tab && typeof switchTab === 'function') {
      switchTab(state.tab);
    }
    setTimeout(() => {
      if (typeof state.scrollY === 'number') {
        window.scrollTo(0, state.scrollY);
      }
    }, 250);
  } catch {}
}

// Save on navigation and before unload
window.addEventListener('beforeunload', saveViewState);
document.addEventListener('scroll', () => {
  // Throttle with requestAnimationFrame
  if (!window.__saveScrollQueued) {
    window.__saveScrollQueued = true;
    requestAnimationFrame(() => { window.__saveScrollQueued = false; saveViewState(); });
  }
});

/* ✅ PERFORMANCE: Cache variables for all sections */
let scheduleCache = null;
let trainingCatalog = null;
let trainingProgress = {};
let trainingDebugMode = false; // Set to true to see detailed tracking logs

// ✅ DEBUG: Helper to log training events
function logTraining(message, data) {
  if (trainingDebugMode) {
    console.log(`🎓 [TRAINING] ${message}`, data || '');
  }
}

/* 🌍 LOCATION INTELLIGENCE */
let userLocation = null;
let locationPermissionAsked = false;

// Get user's current location for distance calculations
async function getUserLocation() {
  if (userLocation) return userLocation; // Already have it
  if (locationPermissionAsked) return null; // Already denied
  
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      console.log('📍 Geolocation not supported');
      resolve(null);
      return;
    }
    
    locationPermissionAsked = true;
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
          accuracy: position.coords.accuracy
        };
        console.log('📍 Location acquired:', userLocation);
        resolve(userLocation);
      },
      (error) => {
        console.log('📍 Location denied or error:', error.message);
        resolve(null);
      },
      { enableHighAccuracy: false, timeout: 5000, maximumAge: 300000 } // Cache for 5 min
    );
  });
}

// Calculate distance between two coordinates (Haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 3959; // Earth radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // Distance in miles
}

// Get distance from user to job
async function getDistanceToJob(job) {
  // Try to get coordinates from job
  let jobLat = job.latitude || job.lat;
  let jobLng = job.longitude || job.lng || job.lon;
  
  // If no coordinates, try to geocode the address
  if (!jobLat || !jobLng) {
    if (job.address && job.city && job.state) {
      const coords = await geocodeAddress(`${job.address}, ${job.city}, ${job.state} ${job.zip || ''}`);
      if (coords) {
        jobLat = coords.lat;
        jobLng = coords.lng;
        // Store for future use
        job.latitude = coords.lat;
        job.longitude = coords.lng;
      }
    }
  }
  
  if (!jobLat || !jobLng) return null;
  
  const loc = await getUserLocation();
  if (!loc) return null;
  
  const distance = calculateDistance(loc.lat, loc.lng, jobLat, jobLng);
  return Math.round(distance * 10) / 10; // Round to 1 decimal
}

// Geocode an address to lat/lng using browser's built-in or fallback
async function geocodeAddress(address) {
  try {
    // Use Nominatim (free, no API key needed)
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
    const data = await response.json();
    if (data && data.length > 0) {
      return {
        lat: parseFloat(data[0].lat),
        lng: parseFloat(data[0].lon)
      };
    }
  } catch (err) {
    console.error('[GEOCODE] Failed:', err);
  }
  return null;
}

/* ===== MENU ===== */
function openMenu() {
  if (!$("openMenu").dataset.on) return;
  $("menu").style.display = "grid";
  $("menu").setAttribute("aria-hidden", "false");
}
function closeMenu() {
  $("menu").style.display = "none";
  $("menu").setAttribute("aria-hidden", "true");
}
$("openMenu").addEventListener("click", openMenu);
$("closeMenu").addEventListener("click", closeMenu);
$("menu").addEventListener("click", e => { if (e.target === $("menu")) closeMenu(); });

function doSignOut() {
  stopJobPolling(); // Stop real-time updates
  
  // Cleanup real-time subscriptions
  if (realtimeChannel) {
    realtimeChannel.unsubscribe();
    realtimeChannel = null;
  }
  if (supabaseClient) {
    supabaseClient = null;
  }
  
  // 🔒 SECURITY: Clear user-specific cache on logout
  const cacheKey = `h2s_portal_cache_${token || adminToken || 'anon'}`;
  localStorage.removeItem(cacheKey);
  
  localStorage.removeItem(LS_TOKEN);
  sessionStorage.removeItem(LS_TOKEN);
  localStorage.removeItem(LS_ADMIN_TOKEN);
  token = ""; adminToken = ""; me = null; isAdmin = false;
  
  // Clear in-memory cache
  Object.keys(tabCache).forEach(key => {
    tabCache[key].data = null;
    tabCache[key].timestamp = 0;
  });
  
  hideMenuButton(); closeMenu(); showAuth();
  renderMenuItems();
}
document.addEventListener("click", e => { if (e.target.id === "signOut") doSignOut(); });

function showMenuButton() {
  const b = $("openMenu");
  b.style.display = "flex";
  b.dataset.on = "1";
  $("supportLink").style.display = "inline-block";
}
function hideMenuButton() {
  const b = $("openMenu");
  b.style.display = "none";
  b.dataset.on = "";
  $("supportLink").style.display = "none";
}

/* ===== VIEW SWITCH ===== */
function showAuth() {
  hideMenuButton();
  $("view-auth").setAttribute("aria-hidden", "false");
  $("view-portal").setAttribute("aria-hidden", "true");
  $("view-admin").setAttribute("aria-hidden", "true");
  $("portalTitle").textContent = "Pro portal";
  
  // Show last used email if available
  const lastEmail = localStorage.getItem('h2s_signup_email') || localStorage.getItem('h2s_last_login_email');
  if (lastEmail) {
    const reminderDiv = $("lastEmailReminder");
    const emailSpan = $("lastEmailUsed");
    if (reminderDiv && emailSpan) {
      emailSpan.textContent = lastEmail;
      reminderDiv.style.display = "block";
    }
  }
}
function showPortal() {
  console.log("⚡ FAST LOAD: Initializing portal");
  const perfStart = performance.now();
  
  showMenuButton();
  $("view-auth").setAttribute("aria-hidden", "true");
  $("view-portal").setAttribute("aria-hidden", "false");
  $("view-admin").setAttribute("aria-hidden", "true");
  
  // Initialize communication hub with culture slogan while loading
  const cultureSloganSection = $("cultureSloganSection");
  const activeAnnouncementsSection = $("activeAnnouncementsSection");
  if (cultureSloganSection) cultureSloganSection.style.display = "block";
  if (activeAnnouncementsSection) activeAnnouncementsSection.style.display = "none";
  
  // 🚀 PARALLEL LOAD: Launch announcements in background (non-blocking)
  loadProAnnouncements().catch(err => {
    console.warn('⚠️ Announcements load failed (non-critical):', err);
  });

  // Start periodic refresh (avoid multiple timers)
  if (!proAnnouncementsRefreshTimer) {
    proAnnouncementsRefreshTimer = setInterval(() => {
      // Only refresh if portal view is visible
      if ($("view-portal").getAttribute("aria-hidden") === "false") {
        loadProAnnouncements();
      }
    }, 120000); // every 2 minutes
  }
  
  console.log(`⚡ Portal shown in ${Math.round(performance.now() - perfStart)}ms`);
}
function showAdmin() {
  showMenuButton();
  $("view-auth").setAttribute("aria-hidden", "true");
  $("view-portal").setAttribute("aria-hidden", "true");
  $("view-admin").setAttribute("aria-hidden", "false");
  
  // Initialize real-time updates (non-blocking, runs in background)
  if (typeof initRealtimeSync === 'function') {
    setTimeout(() => {
      initRealtimeSync().catch(err => {
        console.warn('[Realtime] Initialization failed (non-critical):', err);
      });
    }, 1000); // Delay 1 second to ensure admin view is fully loaded
  }
}

/* ===== WELCOME MODAL FOR NEW USERS ===== */
function checkAndShowWelcome() {
  if (!me) return;
  
  // Check if profile is incomplete
  const isIncomplete = !me.vehicle_text || !me.service_radius_miles || !me.max_jobs_per_day || !me.photo_url || !me.bio_short;
  
  // Check if welcome was already dismissed
  const dismissed = localStorage.getItem('h2s_welcome_dismissed');
  
  if (isIncomplete && !dismissed) {
    console.log("📋 Profile incomplete, showing welcome modal");
    $("welcomeModal").style.display = "grid";
    $("welcomeModal").setAttribute("aria-hidden", "false");
  }
}

function closeWelcomeModal() {
  $("welcomeModal").style.display = "none";
  $("welcomeModal").setAttribute("aria-hidden", "true");
  localStorage.setItem('h2s_welcome_dismissed', 'true');
}

/* ===== MENU CONTENT ===== */
function renderMenuItems() {
  const box = $("menuItems");
  box.innerHTML = "";
  if (isAdmin) {
    $("portalTitle").textContent = "Management Portal";
    const items = [["Jobs Overview", "ad-jobs"], ["Announcements", "ad-announcements"], ["Sign out", "signout"]];
    items.forEach(([label, go]) => {
      const b = document.createElement("button");
      b.className = "menu-item";
      b.type = "button";
      b.textContent = label;
      if (go === "signout") b.id = "signOut";
      else b.dataset.go = go;
      box.appendChild(b);
    });
  } else {
    box.innerHTML = `
      <button class="menu-item" data-go="dash" type="button">Dashboard</button>
      <button class="menu-item" data-go="customers" type="button">Customers</button>
      <button class="menu-item" data-go="schedule" type="button">Schedule</button>
      <button class="menu-item" data-go="payouts" type="button">Payouts</button>
      <button class="menu-item" data-go="reviews" type="button">Reviews</button>
      <button class="menu-item" data-go="training" type="button">Training</button>
      <button class="menu-item" data-go="profile" type="button">Account</button>
      <button class="menu-item" id="signOut" type="button">Sign out</button>
    `;
  }
}
$("menu").addEventListener("click", e => {
  const btn = e.target.closest(".menu-item");
  if (!btn || !btn.dataset.go) return;
  console.log('[Menu] Click detected:', btn.dataset.go);
  
  if (isAdmin) { 
    closeMenu(); 
    const tab = btn.dataset.go;
    console.log('[Menu] Admin tab switch:', tab);
    
    if (tab === 'ad-jobs') {
      console.log('[Menu] → Showing Jobs panel');
      $("jobsPanel").style.display = "block";
      $("announcementsPanel").style.display = "none";
      $("dataHealthDashboard").style.display = "none";
      adminLoadJobs();
    } else if (tab === 'ad-announcements') {
      console.log('[Menu] → Showing Announcements panel');
      console.log('[Menu] → Calling loadAnnouncements()...');
      $("jobsPanel").style.display = "none";
      $("announcementsPanel").style.display = "block";
      $("dataHealthDashboard").style.display = "none";
      
      // Check if function exists
      if (typeof loadAnnouncements === 'function') {
        console.log('[Menu] ✅ loadAnnouncements function exists, calling it now...');
        loadAnnouncements();
      } else {
        console.error('[Menu] ❌ loadAnnouncements is NOT a function!', typeof loadAnnouncements);
      }
    }
  }
  else { switchTab(btn.dataset.go); }
});

/* ===== HYDRATE (pro) ===== */
async function hydrateMe() {
  if (!token) {
    return false;
  }
  
  const cachedMe = getCache('me');
  if (cachedMe) {
    me = cachedMe;
    document.getElementById("portalTitle").textContent = me && me.name ? ("Hi, " + me.name.split(" ")[0]) : "Pro portal";
    document.getElementById("pfVehicle").value = me.vehicle_text || "";
    document.getElementById("pfMiles").value = me.service_radius_miles || "";
    document.getElementById("pfMax").value = me.max_jobs_per_day || "";
    document.getElementById("pfPhoto").value = me.photo_url || "";
    document.getElementById("pfBio").value = me.bio_short || "";
    loadProfilePhotoPreview();
    return true;
  }
  
  try {
    const out = await GET("portal_me", {token});
    
    if (!out.ok) {
      console.warn('[HYDRATE] portal_me failed:', out);
      const oldCache = localStorage.getItem(`h2s_me_${token}`);
      if (oldCache) {
        try {
          me = JSON.parse(oldCache);
          console.log('[HYDRATE] Recovered from cache');
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }
    
    me = out.pro || {};
    
    setCache('me', me);
    localStorage.setItem(`h2s_me_${token}`, JSON.stringify(me));
    
    document.getElementById("portalTitle").textContent = me && me.name ? ("Hi, " + me.name.split(" ")[0]) : "Pro portal";
    document.getElementById("pfVehicle").value = me.vehicle_text || "";
    document.getElementById("pfMiles").value = me.service_radius_miles || "";
    document.getElementById("pfMax").value = me.max_jobs_per_day || "";
    document.getElementById("pfPhoto").value = me.photo_url || "";
    document.getElementById("pfBio").value = me.bio_short || "";
    loadProfilePhotoPreview();
    return true;
  } catch(e) { 
    const oldCache = localStorage.getItem(`h2s_me_${token}`);
    if (oldCache) {
      try {
        me = JSON.parse(oldCache);
        document.getElementById("portalTitle").textContent = me && me.name ? ("Hi, " + me.name.split(" ")[0]) : "Pro portal";
        return true;
      } catch (e2) {
        return false;
      }
    }
    return false; 
  }
}

/* ===== TABS (pro) ===== */
function switchTab(which) {
  currentTab = which;
  // ✅ PERSISTENCE: Save current tab to localStorage
  localStorage.setItem('h2s_last_tab', which);
  // Also save view state for refresh resilience
  if (typeof saveViewState === 'function') saveViewState();
  
  ["dash","customers","payouts","reviews","training","profile","schedule"].forEach(k => {
    document.getElementById("tab-" + k).style.display = (k === which) ? "block" : "none";
  });
  closeMenu();
  
  // Stop polling when leaving dashboard
  if (which !== "dash") {
    stopJobPolling();
  }
  
  console.log(`[TAB] 📂 Switching to: ${which}`);
  
  // Load tab with intelligent caching
  if (which === "dash") {
    // ✅ FIX: Only reload if cache is stale (>5 min) or missing
    const cached = getCache('dash');
    const cacheAge = cached ? Date.now() - (cached._timestamp || 0) : Infinity;
    const CACHE_MAX_AGE = 5 * 60 * 1000; // 5 minutes
    
    if (!cached || cacheAge > CACHE_MAX_AGE) {
      console.log('[TAB] Cache miss or stale - loading fresh data');
      loadJobs(); // Full reload
    } else {
      console.log('[TAB] Using cached data (age: ' + Math.round(cacheAge/1000) + 's)');
      // Render from cache immediately
      currentJobsData = cached;
      renderOffers(cached.offers || []);
      renderUpcoming(cached.upcoming || []);
      renderCompleted(cached.completed || []);
      startJobPolling(); // Still poll for updates in background
      loading(false); // ✅ FIX: Turn off loading when using cache
    }
  }
  if (which === "customers") {
    // Default to "To Call" tab
    currentCustomerTab = 'to-call';
    switchCustomerTab('to-call');
  }
  if (which === "profile") {
    loadProfilePhotoPreview();
  }
  if (which === "payouts") loadPayouts();
  if (which === "reviews") loadReviews();
  if (which === "training") loadTraining();
  if (which === "schedule") loadSchedule();
  
  // Start prefetching next likely tab
  prefetchNextTab(which);
}

/* ===== DASHBOARD (pro) ===== */
let currentJobsData = { offers: [], upcoming: [], completed: [] }; // Store job data globally

// ✅ PAGINATION STATE & HELPERS
let paginationState = {
  offers: { page: 1, limit: 5 },
  upcoming: { page: 1, limit: 5 },
  completed: { page: 1, limit: 5 }
};

function renderPaginationControls(type, totalItems, container) {
  const state = paginationState[type];
  const totalPages = Math.ceil(totalItems / state.limit);
  
  if (totalPages <= 1) return;

  const controls = document.createElement('div');
  controls.className = 'pagination-controls';
  controls.style.cssText = 'display:flex;justify-content:center;gap:12px;margin-top:16px;align-items:center;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1)';
  
  const prevBtn = document.createElement('button');
  prevBtn.className = 'btn secondary';
  prevBtn.style.padding = '8px 16px';
  prevBtn.textContent = '← Prev';
  prevBtn.disabled = state.page === 1;
  if (state.page === 1) prevBtn.style.opacity = '0.5';
  
  prevBtn.onclick = (e) => {
    e.stopPropagation();
    if (state.page > 1) {
      state.page--;
      if (type === 'offers') renderOffers(currentJobsData.offers);
      if (type === 'upcoming') renderUpcoming(currentJobsData.upcoming);
      if (type === 'completed') renderCompleted(currentJobsData.completed);
      // Scroll to top of list
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };
  
  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn secondary';
  nextBtn.style.padding = '8px 16px';
  nextBtn.textContent = 'Next →';
  nextBtn.disabled = state.page === totalPages;
  if (state.page === totalPages) nextBtn.style.opacity = '0.5';
  
  nextBtn.onclick = (e) => {
    e.stopPropagation();
    if (state.page < totalPages) {
      state.page++;
      if (type === 'offers') renderOffers(currentJobsData.offers);
      if (type === 'upcoming') renderUpcoming(currentJobsData.upcoming);
      if (type === 'completed') renderCompleted(currentJobsData.completed);
      // Scroll to top of list
      container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };
  
  const info = document.createElement('span');
  info.style.cssText = 'font-size:14px;opacity:0.8;font-variant-numeric:tabular-nums';
  info.textContent = `Page ${state.page} of ${totalPages}`;
  
  controls.appendChild(prevBtn);
  controls.appendChild(info);
  controls.appendChild(nextBtn);
  
  container.appendChild(controls);
}

// Helper to translate bundle codes to operational language
function formatResourceName(text, job) {
    if (!text) return "";
    let t = text;
    
    // Check for 4th TV presence in the job
    const has4th = job && job.line_items && Array.isArray(job.line_items) && 
                   job.line_items.some(i => (i.service_id||i.bundle_id||i.name||'').includes('tv_multi_4th'));

    // Handle specific bundle codes
    t = t.replace(/cam_premium/gi, "Premium Cam Pkg (8 Cams + Doorbell + NVR)");
    t = t.replace(/cam_standard/gi, "Standard Cam Pkg (4 Cams + Doorbell)");
    t = t.replace(/cam_basic/gi, "Basic Cam Pkg (2 Cams + Doorbell)");
    
    // Handle TV Multi variations precisely
    // 1. Handle the 4th TV add-on specifically
    t = t.replace(/tv_multi_4th/gi, "4th TV Add-on");
    
    // 2. Handle the base tv_multi package (It is always 3 TVs in the bundle)
    // Use negative lookahead to ensure we don't match tv_multi_4th if it wasn't caught above
    t = t.replace(/tv_multi(?!_4th)/gi, "Multi-TV Package (3 TVs)");
    
    // 3. Handle the Service Name / Title (e.g. "Multi-Room Package")
    // If the title is generic, make it precise based on the line items
    if (t.includes("Multi-Room Package") || t.includes("Multi-TV Mount")) {
         if (has4th) {
             // If we have the add-on, the total job is 4 TVs
             t = "Multi-TV Mount (4 TVs)";
         } else if (t.includes("Multi-Room Package")) {
             // If no add-on, it's 3 TVs
             t = "Multi-TV Mount (3 TVs)";
         }
    }

    t = t.replace(/tv_2pack/gi, "2-TV Package");
    t = t.replace(/tv_single/gi, "Single TV Mount");
    
    // Handle custom quotes with intelligence
    if (t.toLowerCase().includes('tv_custom')) {
        let details = [];
        if (job) {
             const meta = job.metadata || {};
             // Check various places for TV size
             const size = job.tv_size || meta.tv_size || (job.notes && job.notes.match(/TV Size: ([^\n]+)/i)?.[1]);
             if (size) details.push(size);
             
             // Check for wall type
             const wall = job.wall_type || meta.wall_type || (job.notes && job.notes.match(/Wall Type: ([^\n]+)/i)?.[1]);
             if (wall) details.push(wall);
        }
        const suffix = details.length ? ` (${details.join(', ')})` : "";
        t = t.replace(/tv_custom/gi, "Custom TV Project" + suffix);
    }

    // Handle custom camera quotes
    if (t.toLowerCase().includes('cam_custom')) {
        let details = [];
        if (job) {
             const meta = job.metadata || {};
             // Try to find camera count in metadata or notes
             const count = meta.camera_count || meta.num_cameras || (job.notes && job.notes.match(/(\d+)\s*(?:cameras?|cams?)/i)?.[1]);
             if (count) details.push(`${count} Cameras`);
             
             // Check for NVR/DVR
             if (meta.nvr_included || (job.notes && job.notes.match(/NVR|DVR/i))) {
                 details.push("NVR System");
             }
             
             // Check for Doorbell
             if (meta.doorbell_included || (job.notes && job.notes.match(/Doorbell/i))) {
                 details.push("Doorbell");
             }
             
             // Check for Floodlight
             if (job.notes && job.notes.match(/Floodlight/i)) {
                 details.push("Floodlight");
             }
        }
        const suffix = details.length ? ` (${details.join(', ')})` : "";
        t = t.replace(/cam_custom/gi, "Custom Security Project" + suffix);
    }
    
    return t;
}

function showJobDetails(job) {
  if (!job) {
    toast("Job details not available");
    return;
  }
  
  // Populate modal with job details
  let title = job.service_name || "Job Details";
  // Apply operational language to title as well
  title = formatResourceName(title, job);
  $("md-title").textContent = title;
  
  // ✅ INTELLIGENCE: Better status for unscheduled jobs
  const dateText = job.window || job.start_iso || "Scheduling Pending";
  $("md-date").textContent = dateText === "TBD" ? "Scheduling Pending" : dateText;
  
  $("md-addr").textContent = (job.address || "") + (job.city ? (", " + job.city + " " + (job.state || "") + " " + (job.zip || "")) : "");
  
  // ✅ INTELLIGENCE: Show line items in resources if available (Consistent with Offer View)
  let resourcesText = job.resources_needed || "None specified";
  
  if (job.line_items && Array.isArray(job.line_items) && job.line_items.length > 0) {
      const items = job.line_items.map(i => {
          const id = (i.service_id || i.bundle_id || i.name || '').toLowerCase();
          const qty = i.qty || 1;
          const prefix = qty > 1 ? `(${qty}) ` : '';
          
          // Try to format the ID directly
          let name = formatResourceName(id, job);
          
          // If it didn't change (no match), and we have a title, use the title
          if (name === id && (i.title || i.name)) {
             name = i.title || i.name;
          }
          
          return `${prefix}${name}`;
      });
      resourcesText = items.join(', ');
  } else {
      // Fallback: Try to format the raw resources text (e.g. "1x cam_premium")
      resourcesText = formatResourceName(resourcesText, job);
  }
  $("md-res").textContent = resourcesText;
  
  // ✅ INTELLIGENCE: Included Tech Clarity
  const techSource = job.included_tech_source || job.metadata?.included_tech_source;
  const hasTech = techSource && techSource !== 'None';
  $("md-tech").innerHTML = hasTech 
      ? `<strong>Yes</strong> <span style="font-size:12px;opacity:.8">(It should be there when you arrive)</span>` 
      : "No";
  
  // ✅ INTELLIGENCE: Show Teammate if available (Team Jobs)
  const teammateEl = $("md-teammate");
  if (job.teammate_name || job.is_team_job) {
      teammateEl.textContent = job.teammate_name || "Pending Assignment";
      teammateEl.parentElement.style.display = "block";
  } else {
      teammateEl.parentElement.style.display = "none";
  }
  
  // ✅ INTELLIGENCE: Show Customer Notes if available
  const notes = job.notes_from_customer || job.notes || "";
  const notesEl = $("md-notes");
  if (notes) {
      notesEl.textContent = notes;
      notesEl.parentElement.style.display = "block";
  } else {
      notesEl.parentElement.style.display = "none";
  }
  
  // Show additional details
  const modalSheet = $("modal").querySelector(".sheet");
  let detailsHTML = '';
  
  // ✅ TEAM JOB EDUCATION: Show team job info with educational context
  if (job.is_team_job || job.team_size > 1 || job.min_team_size > 1) {
    const teammateName = job.teammate_name || 'Another pro';
    const split = job.payout_split || '50/50';
    const teamReason = job.team_reason || job.notes?.match(/TV Size: (.+)/)?.[1] || 'Safety and efficiency';
    
    detailsHTML += `
      <div class="hr"></div>
      <div class="subl">Team Job Information</div>
      <div style="background:linear-gradient(135deg, rgba(139,92,246,.15) 0%, rgba(99,102,241,.15) 100%);padding:16px;border-radius:10px;border:2px solid rgba(139,92,246,.3)">
        <div style="display:flex;align-items:start;gap:12px;margin-bottom:12px">
          <div style="color:#8b5cf6">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          </div>
          <div style="flex:1">
            <div style="font-weight:800;color:#8b5cf6;margin-bottom:6px;font-size:16px">Two-Tech Service</div>
            <div style="font-size:14px;line-height:1.5;margin-bottom:8px">
              ${job.teammate_name 
                ? `You're teamed up with <strong>${esc(teammateName)}</strong> for this job.`
                : `This job requires two technicians. A teammate will be assigned shortly.`
              }
            </div>
            <div style="font-size:13px;opacity:.85;margin-bottom:12px">
              <strong>Why two techs?</strong> ${esc(teamReason)}
            </div>
          </div>
        </div>
        
        <div style="background:rgba(255,255,255,.9);padding:12px;border-radius:8px;margin-top:12px">
          <div style="font-weight:700;color:#6b21a8;margin-bottom:8px;font-size:14px">Payout Split: ${esc(split)}</div>
          <div style="font-size:13px;color:#581c87;line-height:1.4">
            Base payout is split evenly between both technicians. Fair compensation, faster completion, safer installation.
          </div>
        </div>
        
        ${!job.teammate_name ? `
          <div style="margin-top:12px;padding:10px;background:rgba(59,130,246,.1);border-radius:6px;font-size:13px;color:#1e40af">
            <strong>Note:</strong> Both techs must accept before the job is confirmed. You'll be notified when your teammate accepts.
          </div>
        ` : ''}
      </div>
    `;
  } else if (job.status === 'accepted' && !job.is_team_job) {
    // Show "Request Helper" option for solo jobs that might benefit from help
    detailsHTML += `
      <div class="hr"></div>
      <div class="subl">Need Help?</div>
      <div style="background:rgba(59,130,246,.08);padding:14px;border-radius:10px;border:1px solid rgba(59,130,246,.2)">
        <div style="font-size:14px;margin-bottom:10px;line-height:1.5">
          Job looking more complex than expected? You can request a second technician.
        </div>
        <button 
          class="btn secondary" 
          onclick="requestTeammate('${esc(job.job_id)}')"
          style="width:100%;font-size:14px;padding:10px">
          Request Second Tech (Split 50/50)
        </button>
        <div style="font-size:12px;opacity:.7;margin-top:8px;text-align:center">
          Note: Requesting help will reduce your payout to 50% but makes the job safer and faster
        </div>
      </div>
    `;
  }
  
  if (job.notes) {
    detailsHTML += `<div class="hr"></div><div class="subl">Customer Notes</div><p>${esc(job.notes)}</p>`;
  }
  
  // ✅ TECH SYNOPSIS: Installation prep notes for technician
  if (job.tech_synopsis) {
    const synopsisFormatted = job.tech_synopsis.split('\n').map(line => `<div style="margin:4px 0">${esc(line)}</div>`).join('');
    detailsHTML += `<div class="hr"></div><div class="subl">Installation Prep</div><div style="background:#f8f9fa;padding:12px;border-radius:8px;border-left:4px solid #4CAF50">${synopsisFormatted}</div>`;
  }
  
  if (job.distance_miles) {
    detailsHTML += `<div class="hr"></div><div class="subl">Distance</div><p>${Math.round(job.distance_miles * 10) / 10} miles from your location</p>`;
  }
  
  // Insert details before buttons
  const existingDetails = modalSheet.querySelector('.job-extra-details');
  if (existingDetails) existingDetails.remove();
  
  if (detailsHTML) {
    const detailsDiv = document.createElement('div');
    detailsDiv.className = 'job-extra-details';
    detailsDiv.innerHTML = detailsHTML;
    const buttons = modalSheet.querySelector('.row');
    if (buttons) buttons.parentNode.insertBefore(detailsDiv, buttons);
  }
  
  // Hide payout section for job details view
  $("modal").querySelector(".payout").style.display = "none";
  $("md-lines").style.display = "none";
  $("invite-wrap").style.display = "none";
  $("md-accept").style.display = "none";
  
  // Show modal
  $("modal").style.display = "grid";
  $("modal").setAttribute("aria-hidden", "false");
}

// Offer-focused details with payout breakdown and Accept action
function showOfferDetails(job) {
  if (!job) { toast("Job details not available"); return; }

  let title = job.service_name || "Job Offer";
  // Apply operational language to title as well
  title = formatResourceName(title, job);
  $("md-title").textContent = title;
  
  // ✅ INTELLIGENCE: Better status for unscheduled jobs
  const dateText = job.window || job.start_iso || "Scheduling Pending";
  $("md-date").textContent = dateText === "TBD" ? "Scheduling Pending" : dateText;
  
  $("md-addr").textContent = (job.address || job.service_address || "") + (job.city||job.service_city ? (", " + (job.city||job.service_city) + " " + (job.state||job.service_state||"") + " " + (job.zip||job.service_zip||"")) : "");
  
  // ✅ INTELLIGENCE: Show line items in resources if available
  let resourcesText = job.resources_needed || "None specified";
  
  if (job.line_items && Array.isArray(job.line_items) && job.line_items.length > 0) {
      const items = job.line_items.map(i => {
          const id = (i.service_id || i.bundle_id || i.name || '').toLowerCase();
          const qty = i.qty || 1;
          const prefix = qty > 1 ? `(${qty}) ` : '';
          
          // Try to format the ID directly
          let name = formatResourceName(id, job);
          
          // If it didn't change (no match), and we have a title, use the title
          if (name === id && (i.title || i.name)) {
             name = i.title || i.name;
          }
          
          return `${prefix}${name}`;
      });
      resourcesText = items.join(', ');
  } else {
      // Fallback: Try to format the raw resources text (e.g. "1x cam_premium")
      resourcesText = formatResourceName(resourcesText, job);
  }
  $("md-res").textContent = resourcesText;
  
  // ✅ INTELLIGENCE: Show Included Tech Source if available
  const techSource = job.included_tech_source || job.metadata?.included_tech_source || "—";
  $("md-tech").textContent = techSource;
  
  // ✅ INTELLIGENCE: Show Teammate if available (Team Jobs)
  const teammateEl = $("md-teammate");
  if (job.teammate_name || job.is_team_job) {
      teammateEl.textContent = job.teammate_name || "Pending Assignment";
      teammateEl.parentElement.style.display = "block";
  } else {
      teammateEl.parentElement.style.display = "none";
  }
  
  // ✅ INTELLIGENCE: Show Customer Notes if available
  const notes = job.notes_from_customer || job.notes || "";
  const notesEl = $("md-notes");
  if (notes) {
      notesEl.textContent = notes;
      notesEl.parentElement.style.display = "block";
  } else {
      notesEl.parentElement.style.display = "none";
  }

  // Compute payout
  let p = null, payoutAmount = 0, payoutLabel = 'Estimated payout';
  try {
    p = (window.computePayoutForJob ? window.computePayoutForJob(job) : null);
    const total = p && isFinite(p.total) ? p.total : 0;
    let share = 1;
    const splitStr = job.payout_split || '';
    const isTeam = !!(job.is_team_job || (job.team_size && Number(job.team_size) > 1) || (splitStr && splitStr.includes('/')));
    if (isTeam) {
      if (splitStr && splitStr.includes('/')) {
        const left = Number(String(splitStr).split('/')[0]);
        share = isFinite(left) && left > 0 ? (left / 100) : 0.5;
      } else {
        share = 0.5;
      }
      payoutLabel = `Your share • ${splitStr || '50/50'}`;
    } else if (p && p.label) {
      payoutLabel = p.label;
    }
    payoutAmount = Math.max(0, asNum(total) * share);
  } catch (e) {
    console.warn('[Offer Modal] payout compute failed', e);
  }

  // Show payout section
  $("md-payout").textContent = fmtMoney(payoutAmount);
  $("md-variant").textContent = payoutLabel;
  $("modal").querySelector(".payout").style.display = "block";

  // Build line breakdown
  const linesBox = $("md-lines");
  linesBox.innerHTML = "";
  let hadLines = false;
  
  // Support both legacy 'lines' and new 'line_items'
  const linesToRender = job.line_items || job.lines || [];
  
  if (linesToRender && Array.isArray(linesToRender) && linesToRender.length) {
    hadLines = true;
    linesToRender.forEach((ln, idx) => {
      // If we have a direct payout amount for the line (future), use it. Otherwise compute.
      let lineAmt = 0;
      let lineLabel = '';
      
      if (window.computePayoutForLine) {
          const res = window.computePayoutForLine(ln.customer_total, ln.variant_code);
          lineAmt = res.amount;
          lineLabel = res.label;
      }
      
      const line = document.createElement('div');
      line.className = 'item';
      line.innerHTML = `
        <div style="font-weight:600">${esc(ln.title || ln.name || ln.sku || ('Line ' + (idx+1)))}</div>
        <div class="meta">Variant: ${esc(ln.variant_code || 'BASE')} ${ln.qty > 1 ? `• Qty: ${ln.qty}` : ''}</div>
        <div class="payout"><div class="num" style="font-size:20px">${lineLabel || fmtMoney(lineAmt)}</div></div>
      `;
      linesBox.appendChild(line);
    });
  }
  if (!hadLines) {
    // Fallback summary if we don't have specific lines
    const base = asNum(job.payout_base || job.base_payout || 0);
    const extras = asNum(job.payout_extras || job.extra_payout || 0);
    const deductions = asNum(job.payout_deductions || 0);
    if (base || extras || deductions) {
      const s = document.createElement('div');
      s.className = 'item';
      s.innerHTML = `
        <div style="font-weight:600">Summary</div>
        <div class="meta">Base: ${fmtMoney(base)} • Extras: ${fmtMoney(extras)} • Deductions: -${fmtMoney(deductions)}</div>
      `;
      linesBox.appendChild(s);
    }
  }
  $("md-lines").style.display = "block";

  // Accept button wiring
  const acceptBtn = $("md-accept");
  acceptBtn.style.display = "inline-block";
  acceptBtn.onclick = async () => {
    try {
      loading(true);
      // Optimistic: move to upcoming immediately
      const offerIndex = currentJobsData.offers.findIndex(o => o.job_id === job.job_id);
      if (offerIndex !== -1) {
        const offer = currentJobsData.offers[offerIndex];
        currentJobsData.offers.splice(offerIndex, 1);
        offer.assign_state = 'accepted';
        currentJobsData.upcoming.unshift(offer);
        renderOffers(currentJobsData.offers);
        renderUpcoming(currentJobsData.upcoming);
      }
      const out = await GET("portal_accept", {token, job_id: job.job_id});
      if (!out.ok) {
        toast(out.error || 'Failed to accept');
        await loadJobs();
        return;
      }
      if (out.is_team_job) {
        toast(out.team_confirmed ? "✅ Team confirmed! Both pros accepted" : "✓ Accepted - Waiting for teammate to accept...");
      } else {
        toast("Accepted");
      }
      $("modal").style.display = "none";
      $("modal").setAttribute("aria-hidden", "true");
      invalidateCache('dash');
      invalidateCache('schedule');
      setTimeout(() => loadJobs(), 1000);
    } catch(err) {
      toast(err.message || 'Failed');
      await loadJobs();
    } finally {
      loading(false);
    }
  };

  // Show modal
  $("modal").style.display = "grid";
  $("modal").setAttribute("aria-hidden", "false");
}

/* ============================================
   PHOTO GALLERY MANAGEMENT
   ============================================ */

let jobPhotos = {}; // Cache: {job_id: [{artifact_id, storage_url, uploaded_at}]}

async function loadJobPhotos(jobId) {
  if (!jobId) {
    console.warn("[Load Photos] No job ID provided");
    return [];
  }
  
  try {
    console.log("[Load Photos] ========================================");
    console.log("[Load Photos] Fetching photos for job:", jobId);
    console.log("[Load Photos] Token:", token ? `${token.substring(0,20)}...` : 'MISSING');
    
    const out = await GET("portal_get_artifacts", {token, job_id: jobId, type: "photo"});
    
    console.log("[Load Photos] Raw Response:", JSON.stringify(out, null, 2));
    
    if (!out.ok) {
      console.error("[Load Photos] ❌ Failed:", out.error);
      console.error("[Load Photos] Error code:", out.error_code);
      
      // Provide actionable feedback based on error type
      let userMessage = 'Failed to load photos';
      if (out.error_code === 'bad_session') {
        userMessage = 'Session expired - please sign in again';
        setTimeout(() => { location.reload(); }, 2000);
      } else if (out.error_code === 'query_error') {
        userMessage = 'Database error - our team has been notified';
      } else if (out.error) {
        userMessage = out.error;
      }
      
      toast(`❌ ${userMessage}`);
      return [];
    }
    
    const artifacts = out.artifacts || [];
    jobPhotos[jobId] = artifacts;
    
    console.log(`[Load Photos] ✅ Loaded ${artifacts.length} photos for job ${jobId}`);
    console.log("[Load Photos] Photos data:", artifacts);
    console.log("[Load Photos] ========================================");
    
    return jobPhotos[jobId];
  } catch(err) {
    console.error("[Load Photos] ❌ Exception:", err);
    console.error("[Load Photos] Stack:", err.stack);
    
    // Network vs server error
    const isNetworkError = err.message && (err.message.includes('Failed to fetch') || err.message.includes('NetworkError'));
    const userMessage = isNetworkError 
      ? 'Network error - check your connection'
      : `Error loading photos: ${err.message || 'Unknown error'}`;
    
    toast(`❌ ${userMessage}`);
    return [];
  }
}



async function togglePhotoGallery(jobId) {
  console.log("[Gallery] Button clicked for job:", jobId);
  
  const gallery = document.getElementById(`photo-gallery-${jobId}`);
  if (!gallery) {
    console.error("[Gallery] Gallery element not found for job:", jobId);
    toast("Gallery not found");
    return;
  }
  
  if (gallery.style.display === "none" || !gallery.style.display) {
    // Show gallery
    console.log("[Gallery] Opening gallery...");
    loading(true);
    try {
      await loadJobPhotos(jobId);
      await renderPhotoGallery(jobId);
      gallery.style.display = "block";
      console.log("[Gallery] Gallery opened successfully");
      
      // Scroll gallery into view
      setTimeout(() => {
        gallery.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    } catch (err) {
      console.error("[Gallery] Error opening gallery:", err);
      toast("Failed to load photos");
    } finally {
      loading(false);
    }
  } else {
    // Hide gallery
    console.log("[Gallery] Closing gallery");
    gallery.style.display = "none";
  }
}

async function renderPhotoGallery(jobId) {
  console.log("[Render Gallery] Starting render for job:", jobId);
  
  const gallery = document.getElementById(`photo-gallery-${jobId}`);
  if (!gallery) {
    console.error("[Render Gallery] Gallery element not found for job:", jobId);
    return;
  }
  
  const photos = jobPhotos[jobId] || [];
  console.log("[Render Gallery] Photos to render:", photos.length);
  console.log("[Render Gallery] Photo data:", photos);
  
  if (photos.length === 0) {
    gallery.innerHTML = `
      <div style="padding:20px;text-align:center;opacity:.6;font-size:14px;background:rgba(59,130,246,.05);border-radius:10px;border:1px dashed rgba(59,130,246,.2)">
        <div style="font-size:32px;margin-bottom:8px">📸</div>
        <div>No photos uploaded yet</div>
        <div style="font-size:12px;margin-top:4px;opacity:.7">Upload photos to document your work</div>
      </div>`;
    console.log("[Render Gallery] Rendered empty state");
    return;
  }
  
  gallery.innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;padding:12px 0">
      ${photos.map(photo => {
        const imageUrl = photo.storage_url || photo.file_url || photo.photo_url || photo.url;
        console.log("[Render Gallery] Photo URL:", imageUrl);
        return `
        <div style="position:relative;border-radius:12px;overflow:hidden;background:linear-gradient(135deg,rgba(10,22,40,.8) 0%,rgba(8,16,30,.9) 100%);border:1px solid rgba(96,181,255,.15);box-shadow:0 4px 12px rgba(0,0,0,.2);transition:all 0.2s ease;cursor:pointer"
             onmouseover="this.style.transform='translateY(-2px) scale(1.02)';this.style.boxShadow='0 8px 20px rgba(20,147,255,.3)'"
             onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(0,0,0,.2)'"
             onclick="window.open('${esc(imageUrl)}', '_blank')">
          <img src="${esc(imageUrl)}" 
               style="width:100%;height:140px;object-fit:cover;display:block"
               loading="lazy"
               alt="Job photo"
               onerror="console.error('[Gallery] Image failed to load:', '${esc(imageUrl)}'); this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22140%22 height=%22140%22%3E%3Crect fill=%22%23374151%22 width=%22140%22 height=%22140%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2214%22 fill=%22%23fff%22 text-anchor=%22middle%22 dy=%22.3em%22%3EImage Error%3C/text%3E%3C/svg%3E';">
          <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top, rgba(0,0,0,.8) 0%, transparent 100%);padding:8px 6px 6px;font-size:10px;opacity:.8">
            ${photo.uploaded_at ? new Date(photo.uploaded_at).toLocaleDateString() : 'Unknown date'}
          </div>
          <button 
            onclick="event.stopPropagation();deletePhoto('${esc(photo.artifact_id)}', '${esc(jobId)}')"
            style="position:absolute;top:6px;right:6px;width:32px;height:32px;border-radius:50%;background:rgba(239,68,68,.95);border:1px solid rgba(255,255,255,.2);color:white;font-size:20px;line-height:1;cursor:pointer;box-shadow:0 2px 12px rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;padding:0;transition:all 0.2s ease;font-weight:300"
            onmouseover="this.style.background='rgba(220,38,38,1)';this.style.transform='scale(1.1)'"
            onmouseout="this.style.background='rgba(239,68,68,.95)';this.style.transform='scale(1)'"
            title="Delete photo">×</button>
        </div>
      `;}).join('')}
    </div>
    <div style="font-size:13px;opacity:.7;padding:8px 0;display:flex;align-items:center;gap:6px;background:rgba(16,185,129,.08);border-radius:8px;padding:10px 12px;border:1px solid rgba(16,185,129,.15)">
      <span style="font-size:18px">✅</span>
      <span><strong>${photos.length}</strong> photo${photos.length !== 1 ? 's' : ''} uploaded successfully</span>
    </div>
  `;
  
  console.log("[Render Gallery] ✅ Rendered", photos.length, "photos");
}

/* ============================================
   GLOBAL PHOTO MANAGEMENT (VIEW & DELETE)
   ============================================ */
async function loadJobPhotos(jobId) {
  if (!jobId) {
    console.warn("[Load Photos] No job ID provided");
    return [];
  }
  
  try {
    console.log(`[Load Photos] ==================== START ====================`);
    console.log(`[Load Photos] Job ID: ${jobId}`);
    console.log(`[Load Photos] Token: ${token ? token.substring(0, 20) + '...' : 'MISSING'}`);
    
    const out = await GET("portal_get_artifacts", {token, job_id: jobId, type: "photo"});
    
    console.log(`[Load Photos] Response:`, JSON.stringify(out, null, 2));
    
    if (!out.ok) {
      console.error(`[Load Photos] ❌ Endpoint returned ok: false`);
      console.error(`[Load Photos] Error:`, out.error);
      console.error(`[Load Photos] Error code:`, out.error_code);
      throw new Error(out.error || 'Failed to load photos');
    }
    
    const artifacts = out.artifacts || [];
    console.log(`[Load Photos] ✅ Loaded ${artifacts.length} photo(s)`);
    
    if (artifacts.length > 0) {
      console.log(`[Load Photos] Sample photo:`, {
        artifact_id: artifacts[0].artifact_id,
        storage_url: artifacts[0].storage_url,
        uploaded_at: artifacts[0].uploaded_at
      });
    }
    
    console.log(`[Load Photos] ==================== END ====================`);
    return artifacts;
  } catch(err) {
    console.error("[Load Photos] ❌ Exception:", err);
    console.error("[Load Photos] Stack:", err.stack);
    toast(`❌ Error loading photos: ${err.message}`);
    return [];
  }
}

async function deletePhoto(artifactId, jobId) {
  // Prevent event bubbling if called from an event handler
  if (window.event) {
    window.event.stopPropagation();
  }

  // Custom Modal
  const confirmed = await new Promise(resolve => {
    const modal = document.createElement('div');
    modal.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)";
    modal.innerHTML = `
      <div style="background:#1e293b;border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:24px;width:100%;max-width:320px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.5)">
        <div style="text-align:center;margin-bottom:20px">
          <div style="width:48px;height:48px;background:rgba(239,68,68,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;color:#ef4444">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
          </div>
          <h3 style="margin:0 0 8px;color:#fff;font-size:18px">Delete Photo?</h3>
          <p style="margin:0;color:#94a3b8;font-size:14px;line-height:1.5">This action cannot be undone.</p>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <button id="cancel-delete" style="padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#fff;font-weight:600;cursor:pointer">Cancel</button>
          <button id="confirm-delete" style="padding:12px;border-radius:10px;border:none;background:#ef4444;color:#fff;font-weight:600;cursor:pointer">Delete</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    
    modal.querySelector('#cancel-delete').onclick = () => {
      modal.remove();
      resolve(false);
    };
    
    modal.querySelector('#confirm-delete').onclick = () => {
      modal.remove();
      resolve(true);
    };
  });

  if (!confirmed) return;
  
  loading(true);
  try {
      console.log(`[Delete] Requesting delete for artifact ${artifactId} on job ${jobId}`);
      const out = await POST("portal_delete_artifact", { token, artifact_id: artifactId });
      
      if(!out.ok) throw new Error(out.error || "Server returned error");
      
      console.log("[Delete] Success");
      toast("Photo deleted successfully");
      
      // 1. Handle Modal Refresh
      const existingModal = document.querySelector('.photo-gallery-modal');
      if (existingModal) {
          // If modal is open, we want to refresh it WITHOUT closing it if possible, 
          // or close and reopen. Reopening is easiest to ensure state consistency.
          existingModal.remove();
          await viewPhotos(jobId);
      }
      
      // 2. Handle Inline Gallery Refresh
      // Even if modal was open, the inline gallery might be visible behind it or needs update.
      
      // Invalidate cache
      invalidateCache('dash');
      
      // Reload photos to get fresh count
      const photos = await loadJobPhotos(jobId);
      
      // Update inline gallery if it exists
      const gallery = document.getElementById(`photo-gallery-${jobId}`);
      if (gallery) {
         if (photos.length === 0) {
            gallery.style.display = "none";
            photoOnFile[jobId] = false;
            const btn = document.getElementById(`gallery-btn-${jobId}`);
            if (btn) {
                btn.textContent = 'View photos';
                btn.className = 'btn secondary';
                btn.style.cssText = '';
            }
         } else {
            await renderPhotoGallery(jobId, photos);
            const btn = document.getElementById(`gallery-btn-${jobId}`);
            if (btn) {
                btn.textContent = `View ${photos.length} photo${photos.length !== 1 ? 's' : ''}`;
                btn.className = 'btn';
                btn.style.cssText = 'background:linear-gradient(135deg,rgba(16,185,129,.2) 0%,rgba(5,150,105,.15) 100%);border-color:rgba(16,185,129,.3);color:#34d399';
            }
         }
      }
      
      // Update job list counts
      loadJobs(); 
      
  } catch(e) {
      console.error("[Delete] Failed:", e);
      toast("❌ Failed to delete: " + e.message);
  } finally {
      loading(false);
  }
}
// Expose to global scope for HTML onclick handlers
window.deletePhoto = deletePhoto;

async function viewPhotos(jobId) {
  console.log(`[View Photos] ==================== OPENING GALLERY ====================`);
  console.log(`[View Photos] Job ID: ${jobId}`);
  
  loading(true);
  try {
      const photos = await loadJobPhotos(jobId);
      
      console.log(`[View Photos] Received ${photos.length} photo(s) from loadJobPhotos`);
      
      // Remove existing if any
      const existing = document.querySelector('.photo-gallery-modal');
      if(existing) existing.remove();

      // Create/Open Modal
      const modal = document.createElement('div');
      modal.className = 'modal photo-gallery-modal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(10,42,90,.96);backdrop-filter:blur(12px);z-index:30000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease';
      
      modal.innerHTML = `
          <div class="sheet" style="width:100%;height:100%;display:flex;flex-direction:column;background:#0f172a;">
              <!-- Header -->
              <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#1e293b;border-bottom:1px solid rgba(255,255,255,0.1);flex-shrink:0">
                  <div>
                      <h3 style="margin:0;font-size:18px;font-weight:700;color:#fff">Job Photos</h3>
                      <div style="font-size:13px;color:#94a3b8;margin-top:2px">${photos.length} photo${photos.length !== 1 ? 's' : ''}</div>
                  </div>
                  <button class="btn ghost" onclick="this.closest('.modal').remove()" style="padding:8px;height:36px;width:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,0.1);color:#fff;border:none">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg>
                  </button>
              </div>
              
              <!-- Content -->
              <div style="flex:1;overflow-y:auto;padding:16px;">
                  ${photos.length === 0 ? `
                      <div style="text-align:center;padding:60px 20px;opacity:0.6;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%">
                          <div style="width:64px;height:64px;background:rgba(255,255,255,0.05);border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:16px;color:#94a3b8">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                          </div>
                          <div style="font-size:16px;font-weight:600;color:#fff">No photos yet</div>
                          <div style="font-size:14px;color:#94a3b8;margin-top:8px">Upload photos to document your work</div>
                          <button onclick="viewPhotos('${jobId}')" class="btn ghost" style="margin-top:24px;font-size:14px;border:1px solid rgba(255,255,255,0.2);color:#fff">
                            Refresh Gallery
                          </button>
                      </div>
                  ` : `
                      <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(150px, 1fr));gap:12px">
                          ${photos.map(p => `
                              <div style="position:relative;aspect-ratio:1;border-radius:12px;overflow:hidden;background:#000;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);border:1px solid rgba(255,255,255,0.1)">
                                  <img src="${p.storage_url}" style="width:100%;height:100%;object-fit:cover;" 
                                       onclick="window.open('${p.storage_url}', '_blank')">
                                  
                                  <div style="position:absolute;bottom:0;left:0;right:0;padding:8px;background:linear-gradient(to top, rgba(0,0,0,0.8), transparent);font-size:11px;color:rgba(255,255,255,0.9);">
                                      ${new Date(p.uploaded_at).toLocaleDateString()}
                                  </div>

                                  <button onclick="event.stopPropagation(); deletePhoto('${esc(p.artifact_id)}', '${esc(jobId)}')" 
                                          title="Delete Photo"
                                          type="button"
                                          style="position:absolute;top:8px;right:8px;background:rgba(239,68,68,0.9);color:white;border:none;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                  </button>
                              </div>
                          `).join('')}
                      </div>
                  `}
              </div>
          </div>
      `;
      document.body.appendChild(modal);
      
      // Helper for adding photos from modal
      window.handlePhotoAdd = async (input, jId) => {
          if(input.files && input.files.length > 0) {
              const modal = document.querySelector('.photo-gallery-modal');
              if(modal) modal.remove(); // Close gallery to show upload preview
              
              const confirmed = await showPhotoUploadPreview(input.files, jId);
              if(confirmed) {
                  await uploadPhotos(confirmed, jId);
                  viewPhotos(jId); // Re-open gallery
                  loadJobs(); // Refresh counts
              } else {
                  viewPhotos(jId); // Re-open gallery if cancelled
              }
          }
      };

  } catch(e) {
      toast("Error viewing photos: " + e.message);
  } finally {
      loading(false);
  }
}
// Expose to global scope for HTML onclick handlers
window.viewPhotos = viewPhotos;

/* ============================================
   PHOTO UPLOAD PREVIEW & CONFIRMATION
   ============================================ */
async function showPhotoUploadPreview(files, jobId) {
  const fileArray = Array.from(files);
  
  // Validate and create previews
  const previews = await Promise.all(fileArray.map(async (f) => {
    // Validation
    if (f.size > 10 * 1024 * 1024) {
      return { file: f, error: 'File too large (max 10MB)', valid: false };
    }
    if (!f.type.startsWith('image/')) {
      return { file: f, error: 'Not a valid image', valid: false };
    }
    
    // Generate preview
    const dataUrl = await new Promise((resolve) => {
      const fr = new FileReader();
      fr.onload = (e) => resolve(e.target.result);
      fr.onerror = () => resolve(null);
      fr.readAsDataURL(f);
    });
    
    return { file: f, dataUrl, valid: true, error: null };
  }));
  
  const validPreviews = previews.filter(p => p.valid);
  const invalidPreviews = previews.filter(p => !p.valid);
  
  // Return promise that resolves with confirmed files
  return new Promise((resolve) => {
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = 'position:fixed;inset:0;background:rgba(10,42,90,.96);backdrop-filter:blur(12px);z-index:30000;display:flex;align-items:center;justify-content:center;padding:20px;overflow-y:auto;animation:fadeIn 0.2s ease';
    
    modal.innerHTML = `
      <div style="background:linear-gradient(135deg,rgba(10,42,90,.98) 0%,rgba(8,32,68,.95) 100%);border:2px solid rgba(96,181,255,.25);border-radius:16px;padding:28px;max-width:650px;width:100%;box-shadow:0 25px 70px rgba(0,0,0,.5);animation:slideUp 0.3s ease">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <div style="font-size:32px">📸</div>
          <h2 style="margin:0;font-size:22px;color:#fff;flex:1">Review Your Photos</h2>
        </div>
        <p style="margin:0 0 24px 44px;opacity:.8;font-size:14px;line-height:1.5">
          Make sure these are the correct photos for this job.<br>
          You can remove any before uploading.
        </p>
        
        ${invalidPreviews.length > 0 ? `
          <div style="background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);border-radius:12px;padding:14px;margin-bottom:20px">
            <div style="font-weight:600;color:#fca5a5;margin-bottom:10px;display:flex;align-items:center;gap:8px">
              <span style="font-size:20px">⚠️</span>
              <span>${invalidPreviews.length} file${invalidPreviews.length > 1 ? 's' : ''} cannot be uploaded:</span>
            </div>
            ${invalidPreviews.map(p => `<div style="font-size:13px;opacity:.9;margin-left:28px;margin-top:4px">• <strong>${esc(p.file.name)}</strong>: ${esc(p.error)}</div>`).join('')}
          </div>
        ` : ''}
        
        ${validPreviews.length > 0 ? `
          <div id="preview-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:14px;margin-bottom:20px;max-height:450px;overflow-y:auto;padding:6px;background:rgba(0,0,0,.15);border-radius:12px;border:1px solid rgba(96,181,255,.1)">
            ${validPreviews.map((p, idx) => `
              <div data-preview-idx="${idx}" style="position:relative;border-radius:12px;overflow:hidden;border:2px solid rgba(96,181,255,.35);background:#0a1628;transition:all 0.2s ease" 
                   onmouseover="this.style.borderColor='rgba(96,181,255,.6)';this.style.transform='scale(1.02)'"
                   onmouseout="this.style.borderColor='rgba(96,181,255,.35)';this.style.transform='scale(1)'">
                <img src="${p.dataUrl}" style="width:100%;height:130px;object-fit:cover;display:block" alt="Preview">
                <button 
                  onclick="this.closest('[data-preview-idx]').remove();const count=document.querySelectorAll('[data-preview-idx]').length;document.getElementById('preview-count').textContent=count;document.getElementById('confirm-upload-text').textContent=count;document.getElementById('confirm-upload').disabled=count===0"
                  style="position:absolute;top:6px;right:6px;width:30px;height:30px;border-radius:50%;background:rgba(239,68,68,.96);border:1px solid rgba(255,255,255,.4);color:white;font-size:20px;cursor:pointer;padding:0;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,.5);transition:all 0.2s ease;font-weight:300"
                  onmouseover="this.style.background='rgba(220,38,38,1)';this.style.transform='scale(1.15)'"
                  onmouseout="this.style.background='rgba(239,68,68,.96)';this.style.transform='scale(1)'"
                  title="Remove this photo">×</button>
                <div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top, rgba(0,0,0,.9) 0%, transparent 100%);padding:6px 8px 4px;font-size:10px;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${esc(p.file.name)}">${esc(p.file.name)}</div>
              </div>
            `).join('')}
          </div>
          
          <div style="background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);border-radius:10px;padding:12px;margin-bottom:24px;display:flex;align-items:center;gap:10px">
            <span style="font-size:24px">📊</span>
            <div style="flex:1;font-size:14px">
              <strong id="preview-count">${validPreviews.length}</strong> photo${validPreviews.length !== 1 ? 's' : ''} ready to upload
              <div style="opacity:.7;font-size:12px;margin-top:2px">Total size: ${Math.round(validPreviews.reduce((sum, p) => sum + p.file.size, 0) / 1024 / 1024 * 10) / 10}MB</div>
            </div>
          </div>
        ` : `
          <div style="text-align:center;padding:40px 20px;opacity:.6">
            <div style="font-size:48px;margin-bottom:12px">🚫</div>
            <div>No valid photos to upload</div>
          </div>
        `}
        
        <div style="display:flex;gap:12px">
          <button id="cancel-upload" class="btn ghost" style="flex:1;font-size:15px;padding:14px">Cancel</button>
          <button id="confirm-upload" class="btn" style="flex:1;font-size:15px;padding:14px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);box-shadow:0 4px 14px rgba(16,185,129,.3)" ${validPreviews.length === 0 ? 'disabled style="opacity:.5;cursor:not-allowed"' : ''}>
            ✅ Upload <span id="confirm-upload-text">${validPreviews.length}</span> Photo${validPreviews.length !== 1 ? 's' : ''}
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Cancel handler
    modal.querySelector('#cancel-upload').onclick = () => {
      modal.remove();
      resolve(null); // User cancelled
    };
    
    // Confirm handler
    modal.querySelector('#confirm-upload').onclick = () => {
      const remainingIndexes = Array.from(modal.querySelectorAll('[data-preview-idx]'))
        .map(el => parseInt(el.dataset.previewIdx));
      const confirmedPreviews = remainingIndexes.map(idx => validPreviews[idx]);
      modal.remove();
      resolve(confirmedPreviews); // Return confirmed previews
    };
  });
}

/* ============================================
   PHOTO UPLOAD (JOB ARTIFACTS)
   ============================================ */
async function uploadPhotos(previews, jobId) {
  try {
    if (!token) {
      toast('❌ Please sign in to upload photos');
      return;
    }
    if (!jobId) {
      toast('❌ Missing job ID');
      return;
    }
    if (!previews || previews.length === 0) {
      toast('❌ No photos selected');
      return;
    }

    loading(true);
    console.log(`[Upload Photos] ==================== START ====================`);
    console.log(`[Upload Photos] Job: ${jobId}`);
    console.log(`[Upload Photos] Files to upload: ${previews.length}`);

    // Normalize to objects with dataUrl + file
    const items = await Promise.all(previews.map(async (p) => {
      if (p.dataUrl) return p;
      // If we were passed a File, convert to dataUrl
      const dataUrl = await new Promise((resolve) => {
        const fr = new FileReader();
        fr.onload = (e) => resolve(e.target.result);
        fr.onerror = () => resolve(null);
        fr.readAsDataURL(p);
      });
      return { file: p, dataUrl, valid: !!dataUrl };
    }));

    const valid = items.filter(i => i.dataUrl);
    if (valid.length === 0) {
      toast('❌ No valid images to upload');
      loading(false);
      return;
    }

    console.log(`[Upload Photos] Valid files ready: ${valid.length}`);

    let success = 0;
    let failed = 0;
    
    for (let i = 0; i < valid.length; i++) {
      const it = valid[i];
      const filename = (it.file && it.file.name) ? it.file.name : `photo-${Date.now()}-${i}.jpg`;
      
      console.log(`[Upload Photos] [${i+1}/${valid.length}] Uploading: ${filename}`);
      
      try {
        // Extract base64 data (remove data:image/xxx;base64, prefix)
        const base64Data = it.dataUrl.includes(',') ? it.dataUrl.split(',')[1] : it.dataUrl;
        
        const payload = {
          token,
          job_id: jobId,
          type: 'photo',
          data: base64Data,  // Backend expects 'data' field
          filename: filename,
          mimetype: it.file?.type || 'image/jpeg'
        };
        
        console.log(`[Upload Photos] Payload:`, {
          job_id: payload.job_id,
          type: payload.type,
          filename: payload.filename,
          mimetype: payload.mimetype,
          data_length: payload.data.length
        });
        
        const out = await POST('portal_upload_artifact', payload);
        
        console.log(`[Upload Photos] Response:`, out);
        
        if (!out.ok) {
          console.error(`[Upload Photos] ❌ Failed:`, out.error);
          failed++;
          // Don't toast individual failures during batch - we'll summarize at end
        } else {
          console.log(`[Upload Photos] ✅ Success - artifact_id: ${out.artifact_id}`);
          success++;
        }
      } catch (e) {
        console.error(`[Upload Photos] ❌ Exception:`, e);
        failed++;
      }
    }

    console.log(`[Upload Photos] ==================== COMPLETE ====================`);
    console.log(`[Upload Photos] Success: ${success}, Failed: ${failed}`);

    if (success > 0) {
      // Mark state and refresh gallery/job list
      photoOnFile[jobId] = true;
      
      // Reload photos for this job
      try {
        await loadJobPhotos(jobId);
      } catch (e) {
        console.error('[Upload Photos] Failed to reload photos:', e);
      }
      
      // Invalidate caches so counts update
      invalidateCache('dash');
      
      // Refresh job list to show updated counts
      setTimeout(() => loadJobs(), 500);
      
      // Success message
      if (failed === 0) {
        toast(`✅ Uploaded ${success} photo${success !== 1 ? 's' : ''} successfully`);
      } else {
        toast(`⚠️ Uploaded ${success} photo${success !== 1 ? 's' : ''}, ${failed} failed`);
      }
    } else {
      toast(`❌ Upload failed - please try again`);
    }
  } catch (err) {
    console.error('[Upload Photos] Fatal error:', err);
    toast(`❌ Upload error: ${err.message}`);
  } finally {
    loading(false);
  }
}

/* ============================================
   REQUEST TEAMMATE FOR SOLO JOB
   ============================================ */
async function requestTeammate(jobId) {
  if (!confirm("Request a second technician for this job?\n\n⚠️ Your payout will be reduced to 50% (split with teammate), but the job will be safer and faster.\n\nContinue?")) {
    return;
  }
  
  try {
    loading(true);
    
    const out = await POST("portal_request_teammate", {
      token,
      job_id: jobId,
      reason: "Pro requested assistance"
    });
    
    if (!out.ok) {
      toast(out.error || "Failed to request teammate");
      return;
    }
    
    toast("✓ Teammate requested! You'll be notified when someone accepts.");
    
    // Close modal and refresh jobs
    $("modal").style.display = "none";
    setTimeout(() => loadJobs(), 500);
    
  } catch(err) {
    console.error("Request teammate error:", err);
    toast("Failed to request teammate");
  } finally {
    loading(false);
  }
}

async function loadJobs() {
  const loadStart = performance.now(); // Track total load time
  
  // Check cache first (5-min TTL)
  const cached = getCache('dash');
  const cacheAge = cached ? Date.now() - (cached._timestamp || 0) : Infinity;
  const CACHE_MAX_AGE = 5 * 60 * 1000; // 5 minutes
  
  if (cached && cacheAge < CACHE_MAX_AGE) {
    console.log(`[Dashboard] 🎯 Using cached data (age: ${Math.round(cacheAge/1000)}s)`);
    currentJobsData = cached;
    renderOffers(cached.offers);
    renderUpcoming(cached.upcoming);
    renderCompleted(cached.completed);
    startJobPolling(); // Still poll for updates
    loading(false); // ✅ FIX: Turn off loading when using cache
    console.log(`[Dashboard] ⚡ Cached load: ${Math.round(performance.now() - loadStart)}ms`);
    return;
  }
  
  try {
    const apiStart = performance.now();
    console.log('[Dashboard] 🔄 Loading fresh data from backend...');
    
    const out = await GET("portal_jobs", {token});
    const apiTime = Math.round(performance.now() - apiStart);
    recordMetric('api', apiTime);
    console.log(`[Dashboard] 📡 API response time: ${apiTime}ms`);
    
    if (!out.ok) {
      console.error('[Dashboard] ❌ Error:', out.error, out.error_code);
      toast(out.error || "Could not load jobs");
      return;
    }
    
    const offers = out.offers || out.pending || [];
    const upcoming = out.upcoming || [];
    const completed = out.completed || out.past || [];
    
    // Backend already filters by radius - no need for client-side filtering
    const filteredOffers = offers;
    
    console.log(`[Dashboard] 📊 Jobs loaded - Offers: ${filteredOffers.length}, Upcoming: ${upcoming.length}, Completed: ${completed.length}`);
    
    // Log detailed offer information
    if (filteredOffers.length > 0) {
      console.log('[Dashboard] PENDING OFFERS:');
      filteredOffers.forEach((offer, idx) => {
        console.log(`  ${idx + 1}. Job ID: ${offer.job_id}`);
        console.log(`     Service: ${offer.service_name || 'Unknown'}`);
        console.log(`     Location: ${offer.address || 'N/A'}, ${offer.city || ''} ${offer.state || ''}`);
        console.log(`     Window: ${offer.window || offer.start_iso || 'Not set'}`);
        console.log(`     Distance: ${offer.distance_miles || 'N/A'} miles`);
        console.log(`     Status: ${offer.assign_state || 'offered'}`);
      });
    } else {
      console.log('[Dashboard] No pending offers at this time');
    }
    
    // Log upcoming jobs summary
    if (upcoming.length > 0) {
      console.log('[Dashboard] UPCOMING JOBS:');
      upcoming.forEach((job, idx) => {
        console.log(`  ${idx + 1}. ${job.service_name} - ${job.window || job.start_iso}`);
      });
    }

    // Store job data globally for Details button access
    currentJobsData = { offers: filteredOffers, upcoming, completed };
    
    // Cache the data with timestamp
    setCache('dash', { 
      offers: filteredOffers, 
      upcoming, 
      completed,
      _timestamp: Date.now() // Track cache age
    });
    
    [...filteredOffers, ...upcoming].forEach(j => {
      if (j.has_signature || j.signature_on_file) signatureOnFile[j.job_id] = true;
      if (asNum(j.photo_count) > 0 || j.photo_on_file) photoOnFile[j.job_id] = true;
    });

    const renderStart = performance.now();
    renderOffers(filteredOffers);
    renderUpcoming(upcoming);
    renderCompleted(completed);
    const renderTime = Math.round(performance.now() - renderStart);
    
    const totalTime = Math.round(performance.now() - loadStart);
    console.log(`[Dashboard] 🎨 Render time: ${renderTime}ms`);
    console.log(`[Dashboard] ⚡ Total load time: ${totalTime}ms (API: ${apiTime}ms, Render: ${renderTime}ms)`);
    
    if (totalTime > 1000) {
      console.warn(`[Dashboard] ⚠️ Slow load detected (${totalTime}ms) - Check backend performance`);
    }
    
    console.log('[Dashboard] All jobs rendered successfully');
  } catch(err) {
    console.error('[Dashboard] Exception:', err);
    toast(err.message || "Failed to load jobs");
  } finally {
    loading(false);
  }
}

function fmtWindow(row) { return row.window || row.start_iso || ""; }

function renderOffers(list) {
  const renderStart = performance.now(); // ✅ PERFORMANCE: Track render timing
  const box = $("list-offers");
  $("offers-empty").style.display = list.length ? "none" : "block";
  box.onclick = null;
  
  // ✅ PAGINATION: Slice list
  const state = paginationState.offers;
  // Reset to page 1 if out of bounds (e.g. after filtering/accepting)
  if ((state.page - 1) * state.limit >= list.length && list.length > 0) {
    state.page = Math.max(1, Math.ceil(list.length / state.limit));
  }
  
  const start = (state.page - 1) * state.limit;
  const end = start + state.limit;
  const paginatedList = list.slice(start, end);
  
  //✅ LOCATION INTELLIGENCE: Calculate distances asynchronously ONLY if no distance from API
  Promise.all(paginatedList.map(async (j) => {
    // Only calculate if API didn't provide distance
    if (!j.distance_miles) {
      const dist = await getDistanceToJob(j);
      if (dist !== null) {
        j._calculatedDistance = dist;
      }
    }
  })).then(() => {
    // Re-render with distances after calculations complete
    if (box.children.length > 0) {
      renderOffersSync(paginatedList, box);
      renderPaginationControls('offers', list.length, box);
    }
  });
  
  // Initial render (will show backend distance or N/A)
  renderOffersSync(paginatedList, box);
  renderPaginationControls('offers', list.length, box);
  
  recordMetric('render', performance.now() - renderStart);
}

function renderOffersSync(list, box) {
  // ✅ PERFORMANCE: Use DocumentFragment to batch DOM updates (1 reflow instead of N)
  const fragment = document.createDocumentFragment();
  
  if (!Array.isArray(list)) {
    console.warn('renderOffersSync: list is not an array', list);
    return;
  }

  list.forEach((j, index) => {
    const el = document.createElement("div");
    el.className = "item";
    // Stagger animation delay for smooth sequential appearance
    el.style.animationDelay = `${index * 0.08}s`;
    
    // Use calculated distance if available, otherwise backend distance
    // FIXED: Handle 0 or 0.01 correctly by checking for null/undefined explicitly
    let distance = j._calculatedDistance;
    if (distance === undefined || distance === null) {
      distance = j.distance_miles;
    }
    
    const maxRadius = me && me.service_radius_miles ? asNum(me.service_radius_miles) : 0;
    const isOutOfRange = maxRadius > 0 && distance && distance > maxRadius;
    const overBy = isOutOfRange ? Math.round((distance - maxRadius) * 10) / 10 : 0;
    
    // FIXED: Check if distance is a valid number (including 0), not just truthy
    const distanceText = (distance !== null && distance !== undefined) ? 
      `<strong>Distance:</strong> ${distance} mi` : 
      `<strong>Distance:</strong> N/A`;
    
    const rangeWarning = isOutOfRange ? 
      `<div style="display:inline-block;margin-left:8px;padding:4px 10px;background:rgba(245,158,11,.15);border:1px solid rgba(245,158,11,.4);border-radius:6px;font-size:12px;color:#fbbf24">
        ${overBy} mi outside your range
      </div>` : '';

    // ✅ INTELLIGENCE: Enhanced Service Details (Line Items)
    let serviceDetails = "";
    if (j.line_items && Array.isArray(j.line_items) && j.line_items.length > 0) {
      const keyItems = j.line_items.filter(i => {
        const name = (i.title || i.name || "").toLowerCase();
        return name.includes('tv') || name.includes('mount') || name.includes('install') || name.includes('setup');
      }).map(i => {
          const name = i.title || i.name;
          const qty = (i.qty && i.qty > 1) ? `(${i.qty}) ` : '';
          return `${qty}${name}`;
      });
      
      if (keyItems.length > 0) {
        serviceDetails = `<div style="font-size:13px;color:#64748b;margin-top:4px;line-height:1.4">
          ${keyItems.map(item => `• ${esc(item)}`).join('<br>')}
        </div>`;
      }
    } else if (j.description) {
       serviceDetails = `<div style="font-size:13px;color:#64748b;margin-top:4px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${esc(j.description)}</div>`;
    }

    // 💰 Use payout from API (metadata.estimated_payout)
    let payoutLabel = 'Estimated payout';
    let payoutAmount = 0;
    try {
      // FIXED: Use payout_estimated from API response (from job.metadata)
      if (j.payout_estimated && j.payout_estimated > 0) {
        payoutAmount = j.payout_estimated;
      } else {
        // Fallback: Try to compute if payout_estimated is missing
        const p = (window.computePayoutForJob ? window.computePayoutForJob(j) : null);
        const total = p && isFinite(p.total) ? p.total : 0;
        payoutAmount = total;
      }
      
      // Team split handling
      const splitStr = j.payout_split || '';
      const isTeam = !!(j.is_team_job || (j.team_size && Number(j.team_size) > 1) || (splitStr && splitStr.includes('/')));
      if (isTeam) {
        let share = 0.5; // Default 50/50
        if (splitStr && splitStr.includes('/')) {
          const left = Number(String(splitStr).split('/')[0]);
          if (isFinite(left) && left > 0) {
            share = left / 100;
          }
        }
        payoutAmount = payoutAmount * share;
        payoutLabel = `Your share • ${splitStr || '50/50'}`;
      }
    } catch (e) {
      console.warn('[Offers] payout compute failed for job', j.job_id, e);
    }
    
    // ✅ URGENCY & DATE DISPLAY (ROBUST)
    let dateHtml = '';
    let urgencyHtml = '';
    
    // Try to get a valid date object
    // FALLBACK: Check metadata for window/date if top-level is missing
    let rawDate = j.start_iso || j.metadata?.start_iso || j.metadata?.date;
    let rawWindow = j.window || j.metadata?.window || j.metadata?.time_window || j.metadata?.arrival_window;
    
    let targetDate = rawDate ? new Date(rawDate) : null;
    
    if (targetDate && !isNaN(targetDate)) {
        const dateStr = targetDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const timeStr = rawWindow || targetDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        // Urgency
        const now = new Date();
        const diffHrs = (targetDate - now) / 36e5;
        
        let badgeColor = '#3b82f6'; // blue default
        let badgeText = '';
        
        if (diffHrs < 0) { badgeText = 'OVERDUE'; badgeColor = '#ef4444'; }
        else if (diffHrs < 4) { badgeText = 'SOON'; badgeColor = '#f59e0b'; }
        else if (diffHrs < 24) { badgeText = 'TODAY'; badgeColor = '#10b981'; }
        
        if (badgeText) {
            urgencyHtml = `<div style="background:${badgeColor};color:white;font-size:10px;font-weight:bold;padding:2px 6px;border-radius:4px;display:inline-block;margin-bottom:2px">${badgeText}</div>`;
        }
        
        dateHtml = `
            <div style="text-align:right; min-width:80px">
                ${urgencyHtml}
                <div style="font-weight:700;color:#fff;font-size:14px">${dateStr}</div>
                <div style="font-size:12px;color:#94a3b8">${timeStr}</div>
            </div>
        `;
    } else if (rawWindow) {
        // Fallback for text-only window
        dateHtml = `
            <div style="text-align:right; min-width:80px">
                <div style="font-weight:700;color:#fff;font-size:13px">Scheduled</div>
                <div style="font-size:12px;color:#94a3b8">${esc(rawWindow)}</div>
            </div>
        `;
    } else {
        // No date info at all
         dateHtml = `
            <div style="text-align:right; min-width:80px; opacity:0.5">
                <div style="font-size:12px;color:#94a3b8">No Date</div>
            </div>
        `;
    }

    // New Flex Header
    const headerHtml = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px">
            <div>
                <h3 style="margin:0;font-size:16px;line-height:1.3">${esc(j.service_name||j.service_id||"Service")}</h3>
                <div class="meta" style="margin-top:4px">
                    <strong>Job ID:</strong> ${esc(j.job_id||"N/A").substring(0,8)}... • ${distanceText}
                </div>
            </div>
            ${dateHtml}
        </div>
    `;

    el.innerHTML = `
      ${headerHtml}
      <div class="meta">
        ${esc(j.service_address||j.address||"")} ${j.service_city||j.city ? ("• "+esc(j.service_city||j.city)) : ""}
        ${j.notes_from_customer||j.notes ? '<br><em>' + esc(j.notes_from_customer||j.notes) + '</em>' : ''}
      </div>
      ${serviceDetails}
      <div class="payout"><div class="num">${fmtMoney(payoutAmount)}</div><div class="subl">${esc(payoutLabel)}</div></div>
      <div class="actions-grid">
        <button class="btn" data-act="accept" data-job="${esc(j.job_id)}" type="button">Accept${isOutOfRange ? ' Anyway' : ''}</button>
        <button class="btn ghost" data-act="decline" data-job="${esc(j.job_id)}" type="button">Decline</button>
        <button class="btn secondary" style="grid-column: span 2" data-act="details" data-job="${esc(j.job_id)}" type="button">Details</button>
      </div>`;
    fragment.appendChild(el);
  });
  
  // Single DOM update (much faster)
  box.innerHTML = "";
  box.appendChild(fragment);
  box.onclick = async e => {
    const b = e.target.closest("button");
    if (!b) return;
    const jobId = b.dataset.job, act = b.dataset.act;
    
    // Handle Details button
    if (act === "details") {
      const job = currentJobsData.offers.find(j => j.job_id === jobId);
      if (job) {
        showOfferDetails(job);
      } else {
        toast("Job details not found");
      }
      return;
    }
    
    // Handle Accept/Decline
    try {
      loading(true);
      
      // ✅ OPTIMISTIC UPDATE: Remove from UI immediately
      const offerIndex = currentJobsData.offers.findIndex(j => j.job_id === jobId);
      if (offerIndex !== -1) {
        const job = currentJobsData.offers[offerIndex];
        currentJobsData.offers.splice(offerIndex, 1); // Remove from offers
        
        if (act === "accept") {
          // Move to upcoming
          job.assign_state = 'accepted';
          currentJobsData.upcoming.unshift(job);
        }
        
        // Re-render immediately (feels instant)
        renderOffers(currentJobsData.offers);
        renderUpcoming(currentJobsData.upcoming);
      }
      
      // Send request to backend
      const out = await GET(act === "accept" ? "portal_accept" : "portal_decline", {token, job_id: jobId});
      
      if (!out.ok) { 
        toast(out.error || "Failed");
        // ✅ Rollback on error - reload fresh data
        await loadJobs();
        return;
      }
      
      // ✅ TEAM JOB FEEDBACK
      if (act === "accept" && out.is_team_job) {
        if (out.team_confirmed) {
          toast("Team confirmed! Both pros accepted");
        } else {
          toast("Accepted - Waiting for teammate to accept...");
        }
      } else {
        toast(act === "accept" ? "Accepted" : "Declined");
      }
      
      // ✅ Invalidate cache and refresh in background
      invalidateCache('dash');
      invalidateCache('schedule');
      
      // Refresh data in background (don't block UI)
      setTimeout(() => loadJobs(), 1000);
      
    } catch(err) { 
      toast(err.message || "Failed");
      // Rollback - reload fresh data
      await loadJobs();
    }
    finally { loading(false); }
  };
}

function renderUpcoming(list) {
  const box = $("list-upcoming");
  $("upcoming-empty").style.display = list.length ? "none" : "block";
  box.onclick = null;
  
  // ✅ PAGINATION: Slice list
  const state = paginationState.upcoming;
  if ((state.page - 1) * state.limit >= list.length && list.length > 0) {
    state.page = Math.max(1, Math.ceil(list.length / state.limit));
  }
  
  const start = (state.page - 1) * state.limit;
  const end = start + state.limit;
  const paginatedList = list.slice(start, end);
  
  // ✅ PERFORMANCE: Use DocumentFragment for batch DOM updates
  const fragment = document.createDocumentFragment();
  paginatedList.forEach(j => {
    const sigLabel = signatureOnFile[j.job_id] ? "Signature — saved" : "Signature";
    const statusLabel = (j.status || "").toLowerCase();
    const isOpen = statusLabel === "open";
    
    // ✅ INTELLIGENCE: Enhanced Service Title & Description
    let serviceTitle = esc(j.service_name || "Service");
    
    // If service name is generic "Service", try to find a better title from line items or description
    if (serviceTitle === "Service") {
        if (j.line_items && Array.isArray(j.line_items) && j.line_items.length > 0) {
            // Try to find a main item (TV, Mount, etc)
            const mainItem = j.line_items.find(i => {
                const name = (i.title || i.name || "").toLowerCase();
                return name.includes('tv') || name.includes('mount') || name.includes('install') || name.includes('setup');
            });
            if (mainItem) {
                serviceTitle = esc(mainItem.title || mainItem.name);
            } else {
                // Fallback to first item
                serviceTitle = esc(j.line_items[0].title || j.line_items[0].name);
            }
        } else if (j.description) {
            // Try to extract first sentence or short description
            const desc = j.description.split('\n')[0];
            if (desc.length < 50) {
                serviceTitle = esc(desc);
            }
        }
    }

    let serviceDetails = "";
    
    // Use line items for better context if available
    if (j.line_items && Array.isArray(j.line_items) && j.line_items.length > 0) {
      // Extract key items (TVs, Mounts, Smart Devices)
      const keyItems = j.line_items.filter(i => {
        const name = (i.title || i.name || "").toLowerCase();
        return name.includes('tv') || name.includes('mount') || name.includes('install') || name.includes('setup');
      }).map(i => {
          const name = i.title || i.name;
          const qty = (i.qty && i.qty > 1) ? `(${i.qty}) ` : '';
          return `${qty}${name}`;
      });
      
      if (keyItems.length > 0) {
        serviceDetails = `<div style="font-size:13px;color:#64748b;margin-top:4px;line-height:1.4">
          ${keyItems.map(item => `• ${esc(item)}`).join('<br>')}
        </div>`;
      }
    } else if (j.description) {
      serviceDetails = `<div style="font-size:13px;color:#64748b;margin-top:4px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${esc(j.description)}</div>`;
    }

    // ✅ TEAM JOB INDICATOR: Check if this is a team job
    let teamIndicator = '';
    if (j.is_team_job || j.team_size > 1 || j.teammate_name) {
      const teammateName = j.teammate_name || 'Partner';
      const split = j.payout_split || '50/50';
      teamIndicator = `<div style="margin-top:8px;padding:8px;background:rgba(139,92,246,.1);border-left:3px solid #8b5cf6;border-radius:6px;font-size:13px">
        <strong>Team Job</strong> • Working with: ${esc(teammateName)} • Split: ${esc(split)}
      </div>`;
    }
    
    // ✅ TECH SYNOPSIS: Show first 2 prep notes inline (compact view)
    let synopsisPreview = '';
    if (j.tech_synopsis) {
      const lines = j.tech_synopsis.split('\n').filter(l => l.trim()).slice(0, 2);
      if (lines.length > 0) {
        synopsisPreview = `<div style="margin-top:8px;padding:8px;background:#f0f7ff;border-radius:6px;font-size:14px;border-left:3px solid #2196F3">
          ${lines.map(line => `<div style="margin:2px 0">${esc(line)}</div>`).join('')}
          ${j.tech_synopsis.split('\n').length > 2 ? '<div style="margin-top:4px;color:#666;font-style:italic">Click "Details" for full prep checklist →</div>' : ''}
        </div>`;
      }
    }
    
    // ✅ COMPLETION STATUS CHECK
    const hasPhotos = photoOnFile[j.job_id];
    const hasSignature = signatureOnFile[j.job_id];
    
    // Button States
    const photoBtnLabel = hasPhotos ? "View Photos" : "Upload Photos";
    const photoBtnStyle = hasPhotos ? "background:rgba(16,185,129,.1);color:#10b981;border-color:rgba(16,185,129,.2)" : "background:rgba(245,158,11,.08);color:#f59e0b;border-color:rgba(245,158,11,.2)";
    
    // Signature enabled only if photos uploaded (or override)
    const sigBtnClass = "btn secondary"; 
    const sigBtnLabel = hasSignature ? "Signature Saved" : "Get Signature";
    const sigBtnStyle = hasSignature 
      ? "background:rgba(16,185,129,.1);color:#10b981;border-color:rgba(16,185,129,.2)" 
      : (!hasPhotos ? "opacity:.5" : "background:rgba(245,158,11,.08);color:#f59e0b;border-color:rgba(245,158,11,.2)");
    
    // Done enabled only if BOTH present
    const doneBtnClass = (hasPhotos && hasSignature) ? "btn" : "btn secondary";
    const doneBtnStyle = (hasPhotos && hasSignature) 
      ? "grid-column:span 2;background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-color:#10b981;box-shadow:0 4px 14px rgba(16,185,129,.3)" 
      : "grid-column:span 2;opacity:.5;cursor:not-allowed";
    const doneBtnTitle = (!hasPhotos || !hasSignature) 
      ? `${!hasPhotos ? 'Upload photos' : 'Get signature'} first` 
      : "Complete & Submit Job";
    const doneBtnLabel = (hasPhotos && hasSignature) ? "Complete Job" : "Complete Job (Locked)";

    // ✅ DATE DISPLAY (ROBUST)
    let dateDisplay = '';
    // Try to get a valid date object
    let rawDate = j.start_iso || j.metadata?.start_iso || j.metadata?.date;
    let rawWindow = j.window || j.metadata?.window || j.metadata?.time_window || j.metadata?.arrival_window;
    
    let targetDate = rawDate ? new Date(rawDate) : null;

    if (targetDate && !isNaN(targetDate)) {
        const dateStr = targetDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        const timeStr = targetDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const timeDisplay = rawWindow || timeStr;
        
        dateDisplay = `<div style="font-size:15px;font-weight:700;color:#e0f2fe;margin-bottom:6px;display:flex;align-items:center;gap:6px">
          <span>${dateStr}</span>
          <span style="opacity:0.6">•</span>
          <span>${timeDisplay}</span>
        </div>`;
    } else if (rawWindow) {
         dateDisplay = `<div style="font-size:15px;font-weight:700;color:#e0f2fe;margin-bottom:6px;display:flex;align-items:center;gap:6px">
          <span>Scheduled</span>
          <span style="opacity:0.6">•</span>
          <span>${esc(rawWindow)}</span>
        </div>`;
    }

    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      ${dateDisplay}
      <div class="actions-grid">
        <button class="btn secondary" data-details="${esc(j.job_id)}" type="button">Details</button>
        <button class="btn secondary" data-onway="${esc(j.job_id)}" type="button">On My Way</button>
        
        <button class="btn secondary" onclick="handleCallClick(event, '${esc(j.job_id)}', '${esc(j.customer_phone||"")}')" type="button" style="grid-column:span 2;background:rgba(59,130,246,.1);color:#60a5fa;border-color:rgba(59,130,246,.2)">Call Customer</button>
        
        <button class="btn secondary" data-photos="${esc(j.job_id)}" style="${photoBtnStyle}" type="button">${photoBtnLabel}</button>
        <button class="${sigBtnClass}" data-sign="${esc(j.job_id)}" style="${sigBtnStyle}" type="button">${sigBtnLabel}</button>
        
        <button class="${doneBtnClass}" data-done="${esc(j.job_id)}" title="${doneBtnTitle}" style="${doneBtnStyle}" type="button">${doneBtnLabel}</button>
      </div>`;
    // Hidden file input for photo uploads (per job)
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'file';
    hiddenInput.id = `upload-${j.job_id}`;
    hiddenInput.accept = 'image/*';
    hiddenInput.multiple = true;
    hiddenInput.capture = 'environment';
    hiddenInput.style.display = 'none';
    el.appendChild(hiddenInput);
    fragment.appendChild(el);
  });
  
  // Single DOM update
  box.innerHTML = "";
  box.appendChild(fragment);
  renderPaginationControls('upcoming', list.length, box);

  // UPCOMING JOBS CLICK HANDLERS
  box.onclick = async e => {
    const sigBtn = e.target.closest("button[data-sign]");
    const doneBtn = e.target.closest("button[data-done]");
    const detailsBtn = e.target.closest("button[data-details]");
    const onWayBtn = e.target.closest("button[data-onway]");
    const photosBtn = e.target.closest("button[data-photos]");
    
    // ✅ PHOTOS BUTTON: Trigger file input OR View Gallery
    if (photosBtn) {
      const jobId = photosBtn.dataset.photos;
      
      // Check if we have photos on file - View Gallery
      if (photoOnFile[jobId]) {
          viewPhotos(jobId);
          return;
      }

      // No photos yet - Trigger Upload
      const input = document.getElementById(`upload-${jobId}`);
      if (input) {
        // Reset input to allow re-selecting same files
        input.value = '';
        
        // Attach change listener once
        input.onchange = async (evt) => {
          if (evt.target.files && evt.target.files.length > 0) {
            // Use existing preview/upload logic
            const confirmedFiles = await showPhotoUploadPreview(evt.target.files, jobId);
            if (confirmedFiles) {
              await uploadPhotos(confirmedFiles, jobId);
              // Refresh to update button state
              loadJobs();
            }
          }
        };
        input.click();
      }
      return;
    }

    // ✅ ON MY WAY: Update job status
    if (onWayBtn) {
      const jobId = onWayBtn.dataset.onway;
      try {
        loading(true);
        
        console.log("[On My Way] Updating job:", jobId);
        console.log("[On My Way] Token:", token ? `${token.substring(0,20)}...` : 'MISSING');
        
        const out = await POST("portal_on_my_way", {
          token,
          job_id: jobId
        });
        
        console.log("[On My Way] Response:", out);
        
        if (!out.ok) {
          const errorMsg = out.error || "Failed to update status";
          console.error("[On My Way] Error:", out);
          toast(`Error: ${errorMsg}`);
          return;
        }
        
        // Update button to show confirmed
        onWayBtn.innerHTML = 'En Route';
        onWayBtn.disabled = true;
        onWayBtn.style.opacity = '0.6';
        
        toast("Status updated - en route timestamp logged");
        console.log("[On My Way] ✅ Success - tech_en_route_at timestamp saved for job:", jobId);
        
        // Reload jobs to get updated status
        setTimeout(() => loadJobs(), 500);
        
      } catch(err) {
        console.error("[On My Way] Exception:", err);
        toast(`Error: ${err.message || "Failed to update status"}`);
      } finally {
        loading(false);
      }
      return;
    }
    
    // ✅ DETAILS BUTTON: Show full job details with tech synopsis
    if (detailsBtn) {
      const jobId = detailsBtn.dataset.details;
      const job = currentJobsData.upcoming.find(j => j.job_id === jobId);
      if (job) {
        showJobDetails(job);
      } else {
        toast("Job details not found");
      }
      return;
    }
    
    if (sigBtn) { 
      const jobId = sigBtn.dataset.sign;
      // UX: Warn if photos not uploaded yet
      if (!photoOnFile[jobId]) {
        if (!confirm("Warning: You haven't uploaded photos yet.\n\nIt's recommended to upload photos of the completed work BEFORE getting the customer's signature.\n\nContinue to signature anyway?")) {
          return;
        }
      }
      openSignatureModal(jobId);
      return;
    }
    
    if (doneBtn) {
      const jobId = doneBtn.dataset.done;
      
      // ✅ ENFORCE WORKFLOW: Photos -> Signature -> Complete
      if (!photoOnFile[jobId]) {
        // Show clear guidance modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(10,42,90,.95);backdrop-filter:blur(10px);z-index:25000;display:flex;align-items:center;justify-content:center;padding:20px';
        modal.innerHTML = `
          <div style="background:linear-gradient(135deg,rgba(10,42,90,.98),rgba(8,32,68,.95));border:2px solid rgba(245,158,11,.4);border-radius:16px;padding:32px;max-width:480px;width:100%;box-shadow:0 25px 70px rgba(0,0,0,.5);text-align:center">
            <div style="margin-bottom:16px;color:#fbbf24">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </div>
            <h2 style="margin:0 0 12px;font-size:22px;color:#fbbf24">Upload Photos First</h2>
            <p style="margin:0 0 24px;opacity:.9;line-height:1.6;font-size:15px">
              Before completing this job, you must upload photos of the completed work.
              This protects both you and the customer.
            </p>
            <div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:12px;padding:16px;margin-bottom:24px;text-align:left">
              <div style="font-weight:700;color:#fbbf24;margin-bottom:10px;font-size:14px">Required Steps:</div>
              <div style="font-size:14px;opacity:.9;line-height:1.8">
                <div>1. Upload photos of completed work</div>
                <div>2. Get customer signature</div>
                <div>3. Complete job</div>
              </div>
            </div>
            <button onclick="this.closest('.modal').remove()" class="btn" style="width:100%;background:linear-gradient(135deg,#f59e0b,#d97706);padding:14px;font-size:15px">
              Got It - Upload Photos Now
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-highlight photo button
        setTimeout(() => {
          const pBtn = box.querySelector(`button[data-photos="${jobId}"]`);
          if (pBtn) {
            pBtn.style.animation = "pulse 0.5s 3";
            pBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
        return;
      }
      
      if (!signatureOnFile[jobId]) {
        // Show signature reminder modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(10,42,90,.95);backdrop-filter:blur(10px);z-index:25000;display:flex;align-items:center;justify-content:center;padding:20px';
        modal.innerHTML = `
          <div style="background:linear-gradient(135deg,rgba(10,42,90,.98),rgba(8,32,68,.95));border:2px solid rgba(139,92,246,.4);border-radius:16px;padding:32px;max-width:480px;width:100%;box-shadow:0 25px 70px rgba(0,0,0,.5);text-align:center">
            <div style="font-size:72px;margin-bottom:16px">✍️</div>
            <h2 style="margin:0 0 12px;font-size:22px;color:#a78bfa">Get Customer Signature</h2>
            <p style="margin:0 0 24px;opacity:.9;line-height:1.6;font-size:15px">
              Photos uploaded! ✓<br><br>
              Now get the customer's signature to confirm they're satisfied with the work.
            </p>
            <div style="background:rgba(139,92,246,.1);border:1px solid rgba(139,92,246,.3);border-radius:12px;padding:16px;margin-bottom:24px;text-align:left">
              <div style="font-weight:700;color:#a78bfa;margin-bottom:10px;font-size:14px">Progress:</div>
              <div style="font-size:14px;opacity:.9;line-height:1.8">
                <div style="opacity:.5;text-decoration:line-through">1. 📸 Upload photos</div>
                <div style="color:#fbbf24">2. ✍️ Get customer signature ← You are here</div>
                <div style="opacity:.5">3. ✅ Complete job</div>
              </div>
            </div>
            <button onclick="this.closest('.modal').remove()" class="btn" style="width:100%;background:linear-gradient(135deg,#8b5cf6,#7c3aed);padding:14px;font-size:15px">
              Got It - Get Signature Now
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Auto-highlight signature button
        setTimeout(() => {
          const sBtn = box.querySelector(`button[data-sign="${jobId}"]`);
          if (sBtn) {
            sBtn.style.animation = "pulse 0.5s 3";
            sBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
        return;
      }
      
      // Both requirements met - Final confirmation
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(10,42,90,.95);backdrop-filter:blur(10px);z-index:25000;display:flex;align-items:center;justify-content:center;padding:20px';
      modal.innerHTML = `
        <div style="background:linear-gradient(135deg,rgba(10,42,90,.98),rgba(8,32,68,.95));border:2px solid rgba(16,185,129,.4);border-radius:16px;padding:32px;max-width:480px;width:100%;box-shadow:0 25px 70px rgba(0,0,0,.5);text-align:center">
          <div style="font-size:72px;margin-bottom:16px">✅</div>
          <h2 style="margin:0 0 12px;font-size:22px;color:#10b981">Ready to Complete?</h2>
          <p style="margin:0 0 24px;opacity:.9;line-height:1.6;font-size:15px">
            All requirements satisfied!
          </p>
          <div style="background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:12px;padding:16px;margin-bottom:24px;text-align:left">
            <div style="font-weight:700;color:#10b981;margin-bottom:10px;font-size:14px">Checklist Complete:</div>
            <div style="font-size:14px;opacity:.9;line-height:1.8">
              <div>✓ Photos uploaded</div>
              <div>✓ Signature collected</div>
              <div>✓ Work area cleaned up</div>
            </div>
          </div>
          <p style="margin:0 0 20px;font-size:13px;opacity:.7;line-height:1.5">
            This job will be marked complete and moved to your Completed Jobs tab.
            Payment will be processed according to your schedule.
          </p>
          <div style="display:flex;gap:12px">
            <button onclick="this.closest('.modal').remove()" class="btn ghost" style="flex:1">Cancel</button>
            <button id="final-complete-confirm" class="btn" style="flex:1;background:linear-gradient(135deg,#10b981,#059669);padding:14px;font-size:15px">
              Complete Job
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Final complete handler
      modal.querySelector('#final-complete-confirm').onclick = async () => {
        modal.remove();

        try {
          loading(true);
          
          // ✅ OPTIMISTIC UPDATE: Move to completed immediately
          const upcomingIndex = currentJobsData.upcoming.findIndex(j => j.job_id === jobId);
          if (upcomingIndex !== -1) {
            const completedJob = currentJobsData.upcoming[upcomingIndex];
            currentJobsData.upcoming.splice(upcomingIndex, 1);
            completedJob.assign_state = 'completed';
            completedJob.completed_at = new Date().toISOString();
            currentJobsData.completed.unshift(completedJob);
            
            // Re-render immediately (feels instant)
            renderUpcoming(currentJobsData.upcoming);
            renderCompleted(currentJobsData.completed);
          }
          
          // Send to backend
          const out = await GET("portal_mark_done", {token, job_id: jobId});
          
          if (!out.ok) { 
            toast(out.error || "Could not mark done");
            // Rollback on error
            await loadJobs();
            return;
          }
          
          toast("✅ Job Completed! Payment processing will update shortly.");
          
          // ✅ Invalidate cache
          invalidateCache('dash');
          invalidateCache('schedule');
          invalidateCache('payouts');
          
          // Refresh in background (don't block UI)
          setTimeout(() => {
            loadJobs();
            loadPayouts();
          }, 1000);
          
        } catch(err) { 
          toast(err.message || "Could not mark done");
          // Rollback
          await loadJobs();
        } finally { 
          loading(false); 
        }
      };
      return;
    }
  };
}

function renderCompleted(list) {
  const box = $("list-completed");
  $("completed-empty").style.display = list.length ? "none" : "block";
  
  // ✅ PAGINATION: Slice list
  const state = paginationState.completed;
  if ((state.page - 1) * state.limit >= list.length && list.length > 0) {
    state.page = Math.max(1, Math.ceil(list.length / state.limit));
  }
  
  const start = (state.page - 1) * state.limit;
  const end = start + state.limit;
  const paginatedList = list.slice(start, end);
  
  // ✅ PERFORMANCE: Use DocumentFragment for batch DOM updates
  const fragment = document.createDocumentFragment();
  paginatedList.forEach(j => {
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <h3>${esc(j.service_name||"Service")} : ${esc(fmtWindow(j))}</h3>
      <div class="meta">${esc(j.address||"")} ${j.city ? ("• "+esc(j.city)+" "+esc(j.state||"")+" "+esc(j.zip||"")) : ""} • ${esc(j.completed_label||"Completed")}</div>
      <div class="actions-grid">
        <button class="btn secondary" onclick="viewPhotos('${esc(j.job_id)}')" type="button">View Photos</button>
        <button class="btn secondary" data-details="${esc(j.job_id)}" type="button">Details</button>
      </div>`;
    fragment.appendChild(el);
  });
  
  // Single DOM update
  box.innerHTML = "";
  box.appendChild(fragment);
  renderPaginationControls('completed', list.length, box);

  /* ============================================
     PHOTO GALLERY FUNCTIONS (SCOPED TO COMPLETED JOBS)
     ============================================ */
  // Functions removed - using global viewPhotos() instead

  // COMPLETED JOBS CLICK HANDLERS
  box.onclick = async function(e) {
    const detailsBtn = e.target.closest("button[data-details]");
    
    // ✅ DETAILS BUTTON: Show full job details
    if (detailsBtn) {
      const jobId = detailsBtn.dataset.details;
      const job = currentJobsData.completed.find(j => j.job_id === jobId);
      if (job) {
        showJobDetails(job);
      } else {
        toast("Job details not found");
      }
      return;
    }
  };
}

/* ===== SMART PAGINATION SYSTEM ===== */
/**
 * Adds smart pagination to any job list section
 * @param {string} containerId - ID of the container element
 * @param {number} initialLimit - How many items to show initially (default: 5 on mobile, 10 on desktop)
 */
function enableSmartPagination(containerId, initialLimit = null) {
  return; // ✅ DISABLED: Using new page-based pagination instead
  const container = $(containerId);
  if (!container) return;
  
  // Auto-detect limit based on screen size
  if (!initialLimit) {
    initialLimit = window.innerWidth <= 640 ? 5 : 10;
  }
  
  const items = Array.from(container.querySelectorAll('.item'));
  const totalItems = items.length;
  
  // Don't paginate if items are under limit
  if (totalItems <= initialLimit) {
    container.classList.remove('list-collapsed');
    const existingBtn = container.parentElement.querySelector('.load-more-btn');
    if (existingBtn) existingBtn.remove();
    return;
  }
  
  // Hide items beyond initial limit
  items.forEach((item, idx) => {
    item.style.display = idx < initialLimit ? 'block' : 'none';
  });
  
  // Add collapsed class for gradient overlay
  container.classList.add('list-collapsed');
  
  // Create or update load more button
  let loadMoreBtn = container.parentElement.querySelector('.load-more-btn');
  if (!loadMoreBtn) {
    loadMoreBtn = document.createElement('button');
    loadMoreBtn.className = 'load-more-btn';
    container.parentElement.appendChild(loadMoreBtn);
  }
  
  const remainingCount = totalItems - initialLimit;
  loadMoreBtn.innerHTML = `
    Show ${remainingCount} more job${(remainingCount > 1 ? 's' : '')}
    <span class="load-more-count">${remainingCount}</span>
  `;
  
  loadMoreBtn.onclick = () => {
    // Show all items
    items.forEach(item => item.style.display = 'block');
    container.classList.remove('list-collapsed');
    loadMoreBtn.remove();
    
    // Smooth scroll to show newly revealed content
    setTimeout(() => {
      const lastItem = items[items.length - 1];
      if (lastItem) {
        lastItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }, 100);
  };
}

/**
 * Auto-apply pagination to all job lists after rendering
 * Call this after renderOffers(), renderUpcoming(), renderCompleted()
 */
function autoEnablePagination() {
  // Enable on all main job lists
  enableSmartPagination('list-offers', window.innerWidth <= 640 ? 3 : 8);
  enableSmartPagination('list-upcoming', window.innerWidth <= 640 ? 5 : 10);
  enableSmartPagination('list-completed', window.innerWidth <= 640 ? 4 : 8);
}

/* ===== REAL-TIME JOB POLLING ===== */
function startJobPolling() {
  // Stop any existing polling
  stopJobPolling();
  
  // ✅ SMART POLLING: Check every 30 seconds, but only update if data changed
  jobPollInterval = setInterval(async () => {
    if (!token || isAdmin || currentTab !== "dash") return;
    
    try {
      const out = await GET("portal_jobs", {token});
      if (!out.ok) return;
      
      const offers = out.offers || out.pending || [];
      const upcoming = out.upcoming || [];
      const completed = out.completed || out.past || [];
      
      // Check for new offers
      if (offers.length > lastOfferCount) {
        const newCount = offers.length - lastOfferCount;
        toast(`${newCount} new job offer${newCount > 1 ? 's' : ''} available!`);
        
        // Play notification sound (optional)
        try {
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCx/y/LXjTkHHWm98OeiUAwuY7fr7aBRAw1Iovny0H4pBS1+zPLajz4IEly06+mnUhAJTKXi8rhnHgU6kdfy0YAoBSF1xPDdkEAKFF206+ioVRQKRp/g8r5sIQQsf8vy1404Bx1pvfDnolAMLWO36+2gUQMNSKL58tB+KQUtfszy2o8+CBJctOvpp1IQCUyl4vK4Zx4FOpHX8tGAKAUhdcTw3ZBABBQ==');
          audio.volume = 0.3;
          audio.play().catch(() => {}); // Ignore if autoplay blocked
        } catch {}
      }
      
      // Check for changes in upcoming jobs
      if (upcoming.length !== lastUpcomingCount) {
        const diff = upcoming.length - lastUpcomingCount;
        if (diff > 0) {
          toast(`${diff} new job${diff > 1 ? 's' : ''} scheduled`);
        }
      }
      
      lastOfferCount = offers.length;
      lastUpcomingCount = upcoming.length;
      
      // ✅ SMART UPDATE: Only re-render if data actually changed
      const hasChanges = 
        offers.length !== currentJobsData.offers.length ||
        upcoming.length !== currentJobsData.upcoming.length ||
        completed.length !== currentJobsData.completed.length;
      
      if (hasChanges) {
        console.log('[Poll] Data changed - updating UI');
        currentJobsData = { offers, upcoming, completed };
        
        // Update cache
        setCache('dash', { 
          offers, 
          upcoming, 
          completed,
          _timestamp: Date.now()
        });
        
        // Update UI if still on dashboard
        if (currentTab === "dash") {
          renderOffers(offers);
          renderUpcoming(upcoming);
          renderCompleted(completed);
        }
      } else {
        console.log('[Poll] No changes detected - skipping render');
      }
      
    } catch(err) {
      console.error("Poll error:", err);
    }
  }, 30000); // 30 seconds
  
  console.log("✅ Job polling started (every 30 seconds)");
}

function stopJobPolling() {
  if (jobPollInterval) {
    clearInterval(jobPollInterval);
    jobPollInterval = null;
    console.log("⏸️ Job polling stopped");
  }
}

/* ===== PAYOUTS ===== */
function renderPayoutsDashboard(data) {
  const {rows, availableBalance, lifetimeEarnings, weekEarnings, pendingEarnings, weekJobCount} = data;
  
  // Update dashboard stats
  $("available-balance").textContent = fmtMoney(availableBalance);
  $("lifetime-earnings").textContent = fmtMoney(lifetimeEarnings);
  $("week-earnings").textContent = fmtMoney(weekEarnings);
  $("week-jobs").textContent = `${weekJobCount} job${weekJobCount !== 1 ? 's' : ''} completed`;
  $("pending-earnings").textContent = fmtMoney(pendingEarnings);
  
  // Render recent payouts list
  const recentList = $("recent-payouts-list");
  recentList.innerHTML = "";
  
  // Sort by earned_at or created_at, most recent first
  const sorted = [...rows].sort((a, b) => {
    const aDate = new Date(a.earned_at || a.created_at);
    const bDate = new Date(b.earned_at || b.created_at);
    return bDate - aDate;
  });
  
  const recent = sorted.slice(0, 10); // Show last 10
  
  if (recent.length === 0) {
    recentList.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:#94a3b8">
        <div style="font-size:15px">No earnings yet. Accept jobs to start earning!</div>
      </div>
    `;
  } else {
    recent.forEach(r => {
      const amount = asNum(r.total_amount || r.amount || 0);
      const earnedDate = r.earned_at ? new Date(r.earned_at) : new Date(r.created_at);
      const dateStr = earnedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      
      // State badge styling
      let stateBadge = '';
      if (r.state === 'approved') {
        stateBadge = '<span style="background:rgba(16,185,129,.15);color:#10b981;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600">✓ Approved</span>';
      } else if (r.state === 'pending') {
        stateBadge = '<span style="background:rgba(245,158,11,.15);color:#f59e0b;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600">⏳ Pending</span>';
      } else if (r.state === 'paid') {
        stateBadge = '<span style="background:rgba(139,92,246,.15);color:#8b5cf6;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600">💰 Paid</span>';
      }
      
      const row = document.createElement("div");
      row.style.cssText = "display:flex;justify-content:space-between;align-items:center;padding:16px 0;border-bottom:1px solid rgba(255,255,255,.06)";
      row.innerHTML = `
        <div style="flex:1">
          <div style="font-size:15px;font-weight:600;color:#e0f2fe;margin-bottom:4px">${esc(r.service_name || 'Job Payout')}</div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <span style="font-size:13px;color:#94a3b8">${dateStr}</span>
            ${stateBadge}
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:24px;font-weight:800;color:#10b981">${fmtMoney(amount)}</div>
          ${r.job_id ? `<button class="btn-link" data-job="${esc(r.job_id)}" style="font-size:12px;color:#60a5fa;background:none;border:none;cursor:pointer;padding:4px 0;text-decoration:underline" type="button">View Job</button>` : ''}
        </div>
      `;
      recentList.appendChild(row);
    });
    
    // Add click handler for "View Job" links
    recentList.onclick = async e => {
      const btn = e.target.closest("button[data-job]");
      if (!btn) return;
      const jobId = btn.dataset.job;
      
      try {
        loading(true);
        const out = await GET("portal_jobs", {token});
        if (!out.ok) { toast(out.error || "Could not load jobs"); return; }
        
        // Find the job in all lists
        const allJobs = [...(out.offers || []), ...(out.upcoming || []), ...(out.completed || [])];
        const job = allJobs.find(j => j.job_id === jobId);
        
        if (!job) { 
          toast("Job details not found"); 
          return; 
        }
        
        showOfferDetails(job);
        
      } catch(err) { 
        console.error("Job lookup error:", err);
        toast(err.message || "Failed to load job details"); 
      }
      finally { loading(false); }
    };
  }
}

async function loadPayouts() {
  // Check cache first
  const cached = getCache('payouts');
  if (cached) {
    console.log('[Payouts] 🎯 Using cached data');
    renderPayoutsDashboard(cached);
    return;
  }
  
  try {
    loading(true);
    const out = await GET("portal_payouts", {token});
    if (!out.ok) { toast(out.error || "Could not load payouts"); return; }
    
    const rows = out.rows || [];
    
    // Calculate comprehensive stats
    let availableBalance = 0;
    let lifetimeEarnings = 0;
    let weekEarnings = 0;
    let pendingEarnings = 0;
    let weekJobCount = 0;
    
    const now = new Date();
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - now.getDay()); // Start of week (Sunday)
    weekStart.setHours(0, 0, 0, 0);
    
    rows.forEach(r => {
      const amount = asNum(r.total_amount || r.amount || 0);
      
      // Lifetime earnings = all approved or paid
      if (r.state === "approved" || r.state === "paid") {
        lifetimeEarnings += amount;
      }
      
      // Available balance = approved but not yet withdrawn
      if (r.state === "approved") {
        availableBalance += amount;
      }
      
      // Pending = awaiting approval
      if (r.state === "pending") {
        pendingEarnings += amount;
      }
      
      // This week's earnings
      const earnedDate = r.earned_at ? new Date(r.earned_at) : null;
      if (earnedDate && earnedDate >= weekStart && (r.state === "approved" || r.state === "paid")) {
        weekEarnings += amount;
        weekJobCount++;
      }
    });
    
    const data = {rows, availableBalance, lifetimeEarnings, weekEarnings, pendingEarnings, weekJobCount};
    
    // Cache the processed data
    setCache('payouts', data);
    
    // Render
    renderPayoutsDashboard(data);
    
  } catch(err) { 
    console.error("Payouts error:", err);
    toast(err.message || "Failed to load payouts"); 
  }
  finally { loading(false); }
}

// Helper to render cached payouts data
function renderPayouts(data) {
  const {rows, periodMap, currentPeriodTotal, pendingTotal, ytdTotal} = data;
  
  $("current-period").textContent = fmtMoney(currentPeriodTotal);
  $("kpi-pending").textContent = "Pending: " + fmtMoney(pendingTotal);
  $("kpi-ytd").textContent = "YTD: " + fmtMoney(ytdTotal);
  
  const periodList = $("payout-period-list");
  periodList.innerHTML = "";
  const periods = Object.values(periodMap);
  periods.sort((a, b) => new Date(b.start) - new Date(a.start));
  
  periods.forEach(p => {
    const periodHeader = document.createElement("div");
    periodHeader.className = "period-header";
    periodHeader.innerHTML = `<strong>${esc(p.start)} → ${esc(p.end)}</strong> <span>${fmtMoney(p.total)}</span>`;
    periodList.appendChild(periodHeader);
    
    p.rows.forEach(r => {
      const row = document.createElement("div");
      row.className = "pay-row";
      let stateDisplay = '';
      if (r.state === "paid") stateDisplay = '<span class="badge success">Paid</span>';
      else if (r.state === "pending") stateDisplay = '<span class="badge warning">Pending</span>';
      else stateDisplay = '<span class="badge">Open</span>';
      
      row.innerHTML = `
        <div class="pay-left">
          <div>${esc(r.label)}</div>
          ${stateDisplay}
        </div>
        <div class="pay-amt">${fmtMoney(r.amount)}</div>
      `;
      periodList.appendChild(row);
    });
  });
}

/* ===== CUSTOMERS TO CALL ===== */
async function loadCustomers() {
  const customersList = $('customers-list');
  const customersEmpty = $('customers-empty');
  
  if (!token) {
    customersList.style.display = 'none';
    customersEmpty.style.display = 'block';
    customersEmpty.innerHTML = `
      <div style="font-size:64px;margin-bottom:16px;opacity:.4">🔒</div>
      <div style="font-size:18px;font-weight:600;margin-bottom:8px">Please log in</div>
      <div style="font-size:14px;opacity:.8">You need to be logged in to view customers</div>
    `;
    return;
  }
  
  try {
    loading(true);
    const out = await GET("portal_customers", {token});
    if (!out.ok) { 
      customersList.style.display = 'none';
      customersEmpty.style.display = 'block';
      customersEmpty.innerHTML = `
        <div style="font-size:64px;margin-bottom:16px;opacity:.4">❌</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px;color:#f87171">Failed to load</div>
        <div style="font-size:14px;opacity:.8">${esc(out.error || 'API error')}</div>
      `;
      loading(false);
      return; 
    }
    
    const customers = out.customers || [];
    console.log(`[Customers] Loaded ${customers.length} customers to call`);
    
    if (customers.length === 0) {
      customersList.style.display = 'none';
      customersEmpty.style.display = 'block';
      
      // DEBUG PROBE DISPLAY
      let debugHTML = '';
      if (out.debug && out.debug.assignments && out.debug.assignments.length > 0) {
          debugHTML = `
            <div style="margin-top:24px;text-align:left;background:rgba(0,0,0,0.3);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);font-size:12px;font-family:monospace;color:#cbd5e1">
                <div style="font-weight:bold;color:#fcd34d;margin-bottom:8px">⚠️ DEBUG PROBE: Found ${out.debug.assignments.length} raw assignments</div>
                <div style="max-height:200px;overflow-y:auto">
                ${out.debug.assignments.map(a => {
                    const job = out.debug.jobs?.find(j => j.job_id === a.job_id);
                    const jobStatus = job ? job.status : 'UNKNOWN_JOB';
                    const jobDate = job ? job.start_iso : 'N/A';
                    const jobName = job ? job.customer_name : 'N/A';
                    
                    let reason = '';
                    if (a.state !== 'accepted') reason += `[State: ${a.state}] `;
                    if (jobStatus !== 'scheduled') reason += `[Job Status: ${jobStatus}] `;
                    // Check if date is in past
                    if (jobDate && new Date(jobDate) < new Date()) reason += `[Past Date] `;
                    
                    return `
                        <div style="padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)">
                            <span style="color:#fff">${jobName}</span><br>
                            <span style="opacity:0.7">Assign: ${a.state} | Job: ${jobStatus}</span><br>
                            <span style="opacity:0.7">Date: ${jobDate}</span><br>
                            ${reason ? `<span style="color:#f87171">Possible Filter: ${reason}</span>` : '<span style="color:#4ade80">Should Show?</span>'}
                        </div>
                    `;
                }).join('')}
                </div>
            </div>
          `;
      }

      customersEmpty.innerHTML = `
        <div style="font-size:64px;margin-bottom:16px;opacity:.4">✅</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">All caught up!</div>
        <div style="font-size:14px;opacity:.8">No upcoming appointments to call about right now</div>
        ${debugHTML}
      `;
      return;
    }
    
    customersList.style.display = 'grid';
    customersEmpty.style.display = 'none';
    customersList.innerHTML = '';
    
    customers.forEach(c => {
      const card = document.createElement('div');
      card.style.cssText = 'background:linear-gradient(135deg,rgba(59,130,246,.08) 0%,rgba(37,99,235,.06) 100%);border:1px solid rgba(59,130,246,.25);border-radius:14px;padding:20px;transition:all .3s';
      
      const callStatus = c.last_called_at 
        ? `<div style="font-size:12px;color:#94a3b8;margin-top:4px">Last called: ${new Date(c.last_called_at).toLocaleDateString()} - ${esc(c.last_call_outcome || 'Unknown')}</div>`
        : '';
      
      // Determine context and talking points
      const context = c.context || 'Appointment Prep / Check-in';
      let talkingPoints = c.notes ? `Notes: ${esc(c.notes)}` : '"Hi, just checking in on our appointment..."';

      // ✅ INTELLIGENCE: Prompt to verify equipment
      if (c.included_tech_source && c.included_tech_source !== 'None') {
          talkingPoints += ' • <strong>Verify equipment landed</strong>';
      }

      // ✅ INTELLIGENCE: Enhanced Service Title
      let serviceTitle = esc(c.service_name || 'N/A');
      
      // If generic, try to find better name from items (if available)
      if (serviceTitle === 'Service' || serviceTitle === 'Appointment Prep' || serviceTitle === 'N/A') {
          if (c.items && Array.isArray(c.items) && c.items.length > 0) {
              // Try to find a main item (TV, Mount, etc)
              const mainItem = c.items.find(i => {
                  const name = (i.title || i.name || "").toLowerCase();
                  return name.includes('tv') || name.includes('mount') || name.includes('install') || name.includes('setup');
              });
              if (mainItem) {
                  serviceTitle = esc(mainItem.title || mainItem.name);
              } else {
                  // Fallback to first item
                  serviceTitle = esc(c.items[0].title || c.items[0].name);
              }
          }
      }

      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:16px">
          <div style="flex:1;min-width:0">
            <div style="font-size:18px;font-weight:700;color:#e0f2fe;margin-bottom:6px">${esc(c.customer_name || 'Customer')}</div>
            <div style="font-size:14px;color:#94a3b8;margin-bottom:4px">${esc(context)}</div>
            <div style="font-size:13px;color:#60a5fa;margin-top:4px;font-style:italic;background:rgba(59,130,246,.1);padding:6px 10px;border-radius:6px;display:inline-block">
               ${talkingPoints}
            </div>
            ${callStatus}
          </div>
          <div style="display:flex;gap:8px;flex-direction:column;align-items:flex-end">
            <button class="btn" onclick="handleCustomerCallClick(event, '${esc(c.order_id)}', '${esc(c.customer_phone)}', '${esc(c.customer_name || 'Customer')}')" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-color:#10b981;color:#fff;padding:12px 20px;font-size:14px;font-weight:600;white-space:nowrap;width:100%">
              📞 Call Customer
            </button>
            <button class="btn secondary" onclick="handleCustomerRescheduleClick(event, '${esc(c.order_id)}', '${esc(c.customer_name || 'Customer')}')" style="padding:8px 16px;font-size:13px;white-space:nowrap;width:100%">
              📅 Reschedule
            </button>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.06)">
          <div>
            <div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Service</div>
            <div style="font-size:14px;color:#e0f2fe;font-weight:600">${serviceTitle}</div>
          </div>
          <div>
            <div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Address</div>
            <div style="font-size:14px;color:#e0f2fe;font-weight:600">${esc(c.service_address || 'N/A')}</div>
          </div>
          <div>
            <div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">Amount</div>
            <div style="font-size:14px;color:#10b981;font-weight:700">${c.amount_total ? fmtMoney(c.amount_total) : 'N/A'}</div>
          </div>
        </div>
      `;
      
      customersList.appendChild(card);
    });
    
    // Add click handler for "Mark as Contacted" buttons
    customersList.onclick = e => {
      // Legacy handler removed
    };
    
  } catch(e) { 
    console.error('[Customers] Error:', e); 
    customersList.style.display = 'none';
    customersEmpty.style.display = 'block';
    customersEmpty.innerHTML = `
      <div style="font-size:64px;margin-bottom:16px;opacity:.4">⚠️</div>
      <div style="font-size:18px;font-weight:600;margin-bottom:8px;color:#e0f2fe">Application Error</div>
      <div style="font-size:14px;opacity:.8;color:#f87171;margin-bottom:12px">${esc(e.message || 'Unknown error')}</div>
      <div style="font-size:13px;opacity:.6">Please refresh the page.</div>
    `;
  }
  finally { loading(false); }
}

function showCallLogModal(customer) {
  const modal = document.getElementById('modal') || createModal();
  
  // Store customer data globally to avoid string escaping issues in onclick
  window._tempCallLogData = {
    order_id: customer.order_id,
    phone: customer.customer_phone,
    email: customer.customer_email,
    name: customer.customer_name
  };
  
  modal.innerHTML = `
    <div class="sheet" style="max-width:500px">
      <h3 style="margin:0 0 20px">Log Call with ${esc(customer.customer_name)}</h3>
      
      <div style="margin-bottom:16px">
        <label class="label">Call Outcome *</label>
        <select id="callOutcome" class="select" required>
          <option value="">-- Select outcome --</option>
          <option value="completed">Talked to customer</option>
          <option value="voicemail">Left voicemail</option>
          <option value="no_answer">No answer</option>
          <option value="rescheduled">Rescheduled appointment</option>
          <option value="cancelled">Cancelled appointment</option>
        </select>
      </div>
      
      <div style="margin-bottom:16px">
        <label class="label">Notes</label>
        <textarea id="callNotes" class="textarea" placeholder="What did you discuss?"></textarea>
      </div>
      
      <div style="margin-bottom:16px">
        <label class="label">Follow-up Date (optional)</label>
        <input type="date" id="followUpDate" class="input">
      </div>
      
      <div class="row" style="margin-top:24px">
        <button class="btn ghost" type="button" onclick="closeModal()">Cancel</button>
        <button class="btn" type="button" id="saveCallLogBtn">Save Call Log</button>
      </div>
    </div>
  `;
  
  modal.style.display = 'grid';
  
  // Attach event listener after DOM is updated
  setTimeout(() => {
    $('saveCallLogBtn').onclick = () => {
      const data = window._tempCallLogData;
      submitCallLog(data.order_id, data.phone, data.email, data.name);
    };
  }, 0);
}

async function submitCallLog(order_id, phone, email, name) {
  const outcome = $('callOutcome').value;
  const notes = $('callNotes').value;
  const followUp = $('followUpDate').value;
  
  if (!outcome) {
    toast('Please select a call outcome');
    return;
  }
  
  try {
    loading(true);
    closeModal();
    
    const response = await fetch(`${API}/portal_log_call`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        customer_phone: phone,
        customer_email: email || null,
        customer_name: name || null,
        order_id: order_id,
        call_reason: 'appointment',
        call_outcome: outcome,
        notes: notes || null,
        follow_up_date: followUp || null
      })
    });
    
    const result = await response.json();
    
    if (!result.ok) {
      toast(result.error || 'Failed to log call');
      return;
    }
    
    toast('✅ Call logged successfully');
    
    // Reload customers list to show updated status
    setTimeout(() => loadCustomers(), 500);
    
  } catch(e) {
    console.error('[CallLog] Error:', e);
    toast(e.message || 'Failed to log call');
  } finally {
    loading(false);
  }
}

function createModal() {
  const modal = document.createElement('div');
  modal.id = 'modal';
  modal.className = 'modal';
  modal.style.cssText = 'position:fixed;inset:0;display:none;place-items:center;background:rgba(10,42,90,.92);backdrop-filter:blur(8px);z-index:25000;padding:20px';
  document.body.appendChild(modal);
  return modal;
}

/* ===== CUSTOMER HISTORY ===== */
let currentCustomerTab = 'to-call';

window.switchCustomerTab = function(tab) {
  currentCustomerTab = tab;
  
  // Update button styles
  const toCallBtn = $('btnCustomersToCall');
  const historyBtn = $('btnCustomersHistory');
  
  if (tab === 'to-call') {
    toCallBtn.style.color = '#60a5fa';
    toCallBtn.style.borderBottomColor = '#3b82f6';
    historyBtn.style.color = '#64748b';
    historyBtn.style.borderBottomColor = 'transparent';
    
    $('customers-to-call-view').style.display = 'block';
    $('customers-history-view').style.display = 'none';
    
    loadCustomers();
  } else {
    toCallBtn.style.color = '#64748b';
    toCallBtn.style.borderBottomColor = 'transparent';
    historyBtn.style.color = '#60a5fa';
    historyBtn.style.borderBottomColor = '#3b82f6';
    
    $('customers-to-call-view').style.display = 'none';
    $('customers-history-view').style.display = 'block';
    
    loadCustomerHistory();
  }
}

async function loadCustomerHistory() {
  const historyList = $('customers-history-list');
  const historyEmpty = $('customers-history-empty');
  
  if (!token) {
    historyList.style.display = 'none';
    historyEmpty.style.display = 'block';
    historyEmpty.innerHTML = `
      <div style="font-size:64px;margin-bottom:16px;opacity:.4">🔒</div>
      <div style="font-size:18px;font-weight:600;margin-bottom:8px">Please log in</div>
      <div style="font-size:14px;opacity:.8">You need to be logged in to view customer history</div>
    `;
    return;
  }
  
  try {
    loading(true);
    const out = await GET("portal_customer_history", {token});
    if (!out.ok) { 
      historyList.style.display = 'none';
      historyEmpty.style.display = 'block';
      historyEmpty.innerHTML = `
        <div style="font-size:64px;margin-bottom:16px;opacity:.4">❌</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px;color:#f87171">Failed to load</div>
        <div style="font-size:14px;opacity:.8">${esc(out.error || 'API error')}</div>
      `;
      loading(false);
      return; 
    }
    
    const customers = out.customers || [];
    console.log(`[CustomerHistory] Loaded ${customers.length} past customers`);
    
    if (customers.length === 0) {
      historyList.style.display = 'none';
      historyEmpty.style.display = 'block';
      historyEmpty.innerHTML = `
        <div style="font-size:64px;margin-bottom:16px;opacity:.4">👥</div>
        <div style="font-size:18px;font-weight:600;margin-bottom:8px">No past customers yet</div>
        <div style="font-size:14px;opacity:.8">Complete jobs to see your customer history here</div>
      `;
      return;
    }
    
    historyList.style.display = 'grid';
    historyEmpty.style.display = 'none';
    historyList.innerHTML = '';
    
    customers.forEach(c => {
      const card = document.createElement('div');
      card.style.cssText = 'background:linear-gradient(135deg,rgba(100,116,139,.08) 0%,rgba(71,85,105,.06) 100%);border:1px solid rgba(100,116,139,.2);border-radius:14px;padding:18px;transition:all .3s;cursor:pointer';
      
      const totalJobsText = c.total_jobs === 1 ? '1 job' : `${c.total_jobs} jobs`;
      const daysSince = Math.floor((new Date() - new Date(c.last_job_date)) / (1000 * 60 * 60 * 24));
      const lastJobText = daysSince === 0 ? 'Today' : daysSince === 1 ? 'Yesterday' : `${daysSince} days ago`;
      
      const callStatus = c.last_called_at 
        ? `<div style="font-size:12px;color:#94a3b8;margin-top:6px">📞 Last called: ${new Date(c.last_called_at).toLocaleDateString()} (${esc(c.last_call_outcome || 'Unknown')})</div>`
        : '';

      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:12px">
          <div style="flex:1;min-width:0">
            <div style="font-size:17px;font-weight:700;color:#e0f2fe;margin-bottom:4px">${esc(c.customer_name || 'Customer')}</div>
            <div style="font-size:13px;color:#94a3b8;margin-bottom:4px">
              ${esc(c.service_address || '')}, ${esc(c.service_city || '')} ${esc(c.service_state || '')}
            </div>
            <div style="font-size:12px;color:#64748b;display:flex;align-items:center;gap:8px;margin-top:6px">
              <span style="background:rgba(59,130,246,.15);color:#60a5fa;padding:4px 10px;border-radius:6px;font-weight:600">${totalJobsText}</span>
              <span style="background:rgba(16,185,129,.15);color:#10b981;padding:4px 10px;border-radius:6px;font-weight:600">${c.total_revenue ? fmtMoney(c.total_revenue) : '$0'} lifetime</span>
            </div>
            ${callStatus}
          </div>
          <button class="btn secondary" onclick="handleCustomerCallClick(event, '${esc(c.order_id || '')}', '${esc(c.customer_phone)}', '${esc(c.customer_name || 'Customer')}')" style="padding:10px 16px;font-size:13px;font-weight:600;white-space:nowrap">
            📞 Call
          </button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding-top:12px;border-top:1px solid rgba(255,255,255,.05)">
          <div>
            <div style="font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">Last Service</div>
            <div style="font-size:13px;color:#cbd5e1;font-weight:600">${esc(c.last_service_name || 'N/A')}</div>
          </div>
          <div>
            <div style="font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">Last Contact</div>
            <div style="font-size:13px;color:#cbd5e1;font-weight:600">${lastJobText}</div>
          </div>
        </div>
      `;
      
      // Click to expand/show more details (future enhancement)
      card.onclick = () => {
        toast(`📋 Customer profile: ${c.customer_name || 'Customer'}`);
      };
      
      historyList.appendChild(card);
    });
    
  } catch(e) { 
    console.error('[CustomerHistory] Error:', e); 
    historyList.style.display = 'none';
    historyEmpty.style.display = 'block';
    historyEmpty.innerHTML = `
      <div style="font-size:64px;margin-bottom:16px;opacity:.4">👥</div>
      <div style="font-size:18px;font-weight:600;margin-bottom:8px;color:#e0f2fe">No customer history available</div>
      <div style="font-size:14px;opacity:.8">Complete jobs to build your customer base</div>
    `;
  }
  finally { loading(false); }
}

/* ===== REVIEWS ===== */
async function loadReviews() {
  // Check cache first
  const cached = getCache('reviews');
  if (cached) {
    console.log('[Reviews] 🎯 Using cached data');
    renderReviews(cached);
    return;
  }
  
  try {
    loading(true);
    const out = await GET("portal_reviews_get", {token});
    if (!out.ok) { toast(out.error || "Could not load reviews"); return; }
    
    const reviews = out.reviews || [];
    setCache('reviews', reviews);
    const box = $("reviews-rows");
    box.innerHTML = "";
    $("reviews-empty").style.display = reviews.length ? "none" : "block";
    
    reviews.forEach(r => {
      const avgStars = ((r.stars_tech || 0) + (r.stars_service || 0)) / 2;
      const starsDisplay = "⭐".repeat(Math.round(avgStars));
      
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <h3>${starsDisplay} ${avgStars.toFixed(1)} / 5.0</h3>
        <div class="meta">${esc(r.display_name)} • ${r.verified ? "✓ Verified" : ""} • ${new Date(r.created_at).toLocaleDateString()}</div>
        ${r.comment_tech ? `<div style="margin-top:8px"><strong>Tech:</strong> ${esc(r.comment_tech)}</div>` : ""}
        ${r.comment_service ? `<div style="margin-top:8px"><strong>Service:</strong> ${esc(r.comment_service)}</div>` : ""}
        ${r.tags.length ? `<div style="margin-top:8px;font-size:13px;opacity:.8">${r.tags.map(t => "#" + esc(t)).join(" ")}</div>` : ""}
        <div id="replies-${esc(r.review_id)}" style="margin-top:12px;padding-left:16px;border-left:2px solid rgba(255,255,255,.2)"></div>
        <div class="actions">
          <button class="btn secondary" data-reply="${esc(r.review_id)}" type="button">Reply</button>
        </div>
      `;
      box.appendChild(el);
      
      // Render existing replies
      const repliesBox = document.getElementById("replies-" + r.review_id);
      if (r.replies && r.replies.length) {
        r.replies.forEach(rep => {
          const repEl = document.createElement("div");
          repEl.style.cssText = "margin-top:8px;padding:8px;background:rgba(255,255,255,.05);border-radius:8px";
          repEl.innerHTML = `
            <div style="font-size:13px;opacity:.7">${new Date(rep.created_at).toLocaleDateString()}</div>
            <div style="margin-top:4px">${esc(rep.message)}</div>
          `;
          repliesBox.appendChild(repEl);
        });
      }
    });
    
    // Reply handler
    box.onclick = async e => {
      const btn = e.target.closest("button[data-reply]");
      if (!btn) return;
      const reviewId = btn.dataset.reply;
      
      // Show styled reply modal
      $("replyText").value = "";
      $("replyModal").style.display = "grid";
      $("replyModal").setAttribute("aria-hidden", "false");
      $("replyText").focus();
      
      // Store review ID for handler
      $("replyOK").dataset.reviewId = reviewId;
    };
    
  } catch(err) { 
    console.error("Reviews error:", err);
    toast(err.message || "Failed to load reviews"); 
  }
  finally { loading(false); }
}

// Helper to render reviews from cache
function renderReviews(reviews) {
  const box = $("reviews-rows");
  box.innerHTML = "";
  $("reviews-empty").style.display = reviews.length ? "none" : "block";
  
  reviews.forEach(r => {
    const avgStars = ((r.stars_tech || 0) + (r.stars_service || 0)) / 2;
    const starsDisplay = "⭐".repeat(Math.round(avgStars));
    
    const el = document.createElement("div");
    el.className = "item";
    el.innerHTML = `
      <h3>${starsDisplay} ${avgStars.toFixed(1)} / 5.0</h3>
      <div class="meta">${esc(r.display_name)} • ${r.verified ? "✓ Verified" : ""} • ${new Date(r.created_at).toLocaleDateString()}</div>
      ${r.comment_tech ? `<div style="margin-top:8px"><strong>Tech:</strong> ${esc(r.comment_tech)}</div>` : ""}
      ${r.comment_service ? `<div style="margin-top:4px"><strong>Service:</strong> ${esc(r.comment_service)}</div>` : ""}
      <div id="replies-${esc(r.review_id)}" style="margin-top:8px"></div>
      <div style="margin-top:10px">
        <button class="btn secondary" data-reply="${esc(r.review_id)}" type="button">Reply</button>
      </div>
    `;
    box.appendChild(el);
    
    // Render existing replies
    const repliesBox = document.getElementById("replies-" + r.review_id);
    if (r.replies && r.replies.length) {
      r.replies.forEach(rep => {
        const repEl = document.createElement("div");
        repEl.style.cssText = "margin-top:8px;padding:8px;background:rgba(255,255,255,.05);border-radius:8px";
        repEl.innerHTML = `
          <div style="font-size:13px;opacity:.7">${new Date(rep.created_at).toLocaleDateString()}</div>
          <div style="margin-top:4px">${esc(rep.message)}</div>
        `;
        repliesBox.appendChild(repEl);
      });
    }
  });
}

/* ===== REVIEW REPLY MODAL HANDLERS ===== */
$("replyCancel").addEventListener("click", () => {
  $("replyModal").style.display = "none";
  $("replyModal").setAttribute("aria-hidden", "true");
});

$("replyModal").addEventListener("click", e => {
  if (e.target === $("replyModal")) {
    $("replyModal").style.display = "none";
    $("replyModal").setAttribute("aria-hidden", "true");
  }
});

/* ===== JOB DETAILS MODAL HANDLERS ===== */
$("md-close").addEventListener("click", () => {
  $("modal").style.display = "none";
  $("modal").setAttribute("aria-hidden", "true");
});

$("modal").addEventListener("click", e => {
  if (e.target === $("modal")) {
    $("modal").style.display = "none";
    $("modal").setAttribute("aria-hidden", "true");
  }
});

/* ===== SIGNATURE MODAL HANDLERS ===== */
let currentSignatureJobId = null;
const sigCanvas = $("sig");
const sigCtx = sigCanvas.getContext("2d");
let isDrawing = false;
let lastX = 0;
let lastY = 0;

function setupCanvas() {
  // Responsive canvas sizing
  const isMobile = window.innerWidth <= 640;
  
  if (isMobile) {
    // Mobile: full width minus padding
    const parentWidth = sigCanvas.parentElement.clientWidth;
    sigCanvas.width = Math.min(parentWidth - 16, 600); // 16px for padding
    sigCanvas.height = 180;
    sigCtx.lineWidth = 3; // Thicker for touch
  } else {
    // Desktop: fixed size
    sigCanvas.width = 560;
    sigCanvas.height = 220;
    sigCtx.lineWidth = 2;
  }
  
  sigCtx.strokeStyle = "#000";
  sigCtx.lineCap = "round";
  sigCtx.lineJoin = "round";
}

function clearCanvas() {
  sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
}

function getCoordinates(e) {
  const rect = sigCanvas.getBoundingClientRect();
  const scaleX = sigCanvas.width / rect.width;
  const scaleY = sigCanvas.height / rect.height;
  
  if (e.touches && e.touches[0]) {
    return {
      x: (e.touches[0].clientX - rect.left) * scaleX,
      y: (e.touches[0].clientY - rect.top) * scaleY
    };
  }
  return {
    x: (e.clientX - rect.left) * scaleX,
    y: (e.clientY - rect.top) * scaleY
  };
}

function startDrawing(e) {
  e.preventDefault();
  isDrawing = true;
  const coords = getCoordinates(e);
  lastX = coords.x;
  lastY = coords.y;
}

function draw(e) {
  if (!isDrawing) return;
  e.preventDefault();
  
  const coords = getCoordinates(e);
  sigCtx.beginPath();
  sigCtx.moveTo(lastX, lastY);
  sigCtx.lineTo(coords.x, coords.y);
  sigCtx.stroke();
  
  lastX = coords.x;
  lastY = coords.y;
}

function stopDrawing(e) {
  if (isDrawing) {
    e.preventDefault();
  }
  isDrawing = false;
}

// Mouse events
sigCanvas.addEventListener("mousedown", startDrawing, {passive: false});
sigCanvas.addEventListener("mousemove", draw, {passive: false});
sigCanvas.addEventListener("mouseup", stopDrawing, {passive: false});
sigCanvas.addEventListener("mouseout", stopDrawing, {passive: false});

// Touch events
sigCanvas.addEventListener("touchstart", startDrawing, {passive: false});
sigCanvas.addEventListener("touchmove", draw, {passive: false});
sigCanvas.addEventListener("touchend", stopDrawing, {passive: false});

function openSignatureModal(jobId) {
  currentSignatureJobId = jobId;
  clearCanvas();
  setupCanvas();
  $("sigModal").style.display = "block";
  $("sigModal").setAttribute("aria-hidden", "false");
}

$("sigClear").addEventListener("click", () => {
  clearCanvas();
});

$("sigClose").addEventListener("click", () => {
  $("sigModal").style.display = "none";
  $("sigModal").setAttribute("aria-hidden", "true");
  currentSignatureJobId = null;
});

$("sigModal").addEventListener("click", e => {
  if (e.target === $("sigModal")) {
    $("sigModal").style.display = "none";
    $("sigModal").setAttribute("aria-hidden", "true");
    currentSignatureJobId = null;
  }
});

$("sigSave").addEventListener("click", async () => {
  if (!currentSignatureJobId) {
    toast("No job selected");
    return;
  }
  
  // Check if canvas is blank
  const imageData = sigCtx.getImageData(0, 0, sigCanvas.width, sigCanvas.height);
  const isBlank = !imageData.data.some(channel => channel !== 0);
  
  if (isBlank) {
    toast("Please draw a signature first");
    return;
  }
  
  try {
    loading(true);
    
    // Convert canvas to base64 PNG and strip data URL prefix
    const dataUrl = sigCanvas.toDataURL("image/png");
    const base64Data = dataUrl.split(",")[1]; // Remove "data:image/png;base64," prefix
    
    const out = await POST("portal_upload_signature", {
      token,
      job_id: currentSignatureJobId,
      data: base64Data,
      filename: `signature_${currentSignatureJobId}.png`,
      mimetype: "image/png"
    });
    
    if (!out.ok) {
      toast(out.error || "Failed to save signature");
      return;
    }
    
    toast("Signature saved!");
    signatureOnFile[currentSignatureJobId] = true;
    
    // Close modal and refresh jobs
    $("sigModal").style.display = "none";
    $("sigModal").setAttribute("aria-hidden", "true");
    currentSignatureJobId = null;
    
    await loadJobs();
  } catch(err) {
    toast(err.message || "Failed to save signature");
  } finally {
    loading(false);
  }
});

$("replyOK").addEventListener("click", async () => {
  const reviewId = $("replyOK").dataset.reviewId;
  const message = $("replyText").value.trim();
  
  if (!message) {
    toast("Please enter a reply message");
    return;
  }
  
  try {
    loading(true);
    $("replyModal").style.display = "none";
    $("replyModal").setAttribute("aria-hidden", "true");
    
    const out = await POST("portal_reviews_reply", {token, review_id: reviewId, message});
    if (!out.ok) { toast(out.error || "Reply failed"); return; }
    toast("Reply posted!");
    await loadReviews();
  } catch(err) { toast(err.message || "Reply failed"); }
  finally { loading(false); }
});

/* ===== AUTH HANDLERS ===== */
document.getElementById("btnSignIn").addEventListener("click", async function() {
  const email = document.getElementById("siEmail").value.trim();
  const zip = document.getElementById("siZip").value.trim();
  const errDiv = document.getElementById("err");
  errDiv.style.display = "none";
  
  if (!email || !zip) { 
    errDiv.textContent = "Email and ZIP required"; 
    errDiv.style.display = "block"; 
    return; 
  }
  
  try {
    loading(true);
    
    // Admin login
    if (email.toLowerCase() === "dispatch@h2s.com" && zip === "29649") {
      const out = await GET("admin_login", {email, zip});
      if (!out.ok) { 
        loading(false);
        errDiv.textContent = out.error || "Admin login failed"; 
        errDiv.style.display = "block"; 
        return; 
      }
      adminToken = out.token || "";
      localStorage.setItem(LS_ADMIN_TOKEN, adminToken);
      isAdmin = true;
      renderMenuItems();
      showAdmin();
      await adminLoadJobs();
      loading(false);
      return;
    }
    
    // Pro login
    token = ""; // Ensure no stale token is sent
    console.log(`[LOGIN] Attempting login for ${email}...`);
    const out = await GET("portal_login", {email, zip});
    console.log(`[LOGIN] Response:`, out);
    
    if (!out.ok) { 
      loading(false);
      errDiv.textContent = out.error || "Sign in failed"; 
      errDiv.style.display = "block"; 
      return; 
    }
    
    token = out.token || "";
    const remember = document.getElementById("siRemember")?.checked;
    
    if (remember) {
        localStorage.setItem(LS_TOKEN, token);
        localStorage.setItem('h2s_last_login_email', email);
    } else {
        sessionStorage.setItem(LS_TOKEN, token);
        localStorage.removeItem(LS_TOKEN); // Ensure local is clear if not remembering
    }
    
    const hydrated = await hydrateMe();
    
    if (hydrated) { 
      isAdmin = false; 
      renderMenuItems(); 
      showPortal(); 
      switchTab("dash");
      checkAndShowWelcome();
      toast("Welcome back!");
      document.getElementById("siEmail").value = "";
      document.getElementById("siZip").value = "";
      return;
    } else {
      localStorage.removeItem(LS_TOKEN);
      sessionStorage.removeItem(LS_TOKEN);
      token = "";
      errDiv.textContent = "Failed to load profile"; 
      errDiv.style.display = "block";
      loading(false);
    }
  } catch(err) { 
    errDiv.textContent = err.message || "Error"; 
    errDiv.style.display = "block"; 
    loading(false);
  }
});

$("btnStartSignup").addEventListener("click", () => {
  $("step-signin").style.display = "none";
  $("step-info").style.display = "block";
});

$("backToSignIn").addEventListener("click", () => {
  $("step-info").style.display = "none";
  $("step-signin").style.display = "block";
});

$("toAddress").addEventListener("click", () => {
  if (!$("piName").value.trim() || !$("piEmail").value.trim() || !$("piPhone").value.trim()) {
    $("err-info").textContent = "All fields required"; $("err-info").style.display = "block";
    return;
  }
  $("step-info").style.display = "none";
  $("step-address").style.display = "block";
});

$("backToInfo").addEventListener("click", () => {
  $("step-address").style.display = "none";
  $("step-info").style.display = "block";
});

$("finishStep1").addEventListener("click", async () => {
  const payload = {
    name: $("piName").value.trim(),
    email: $("piEmail").value.trim(),
    phone: $("piPhone").value.trim(),
    address: $("adStreet").value.trim(),
    city: $("adCity").value.trim(),
    state: $("adState").value.trim(),
    zip: $("adZip").value.trim()
  };
  if (!payload.address || !payload.city || !payload.state || !payload.zip) {
    $("err-address").textContent = "All address fields required"; $("err-address").style.display = "block";
    return;
  }
  try {
    loading(true);
    const out = await POST("portal_signup_step1", payload);
    if (!out.ok) { 
      $("err-address").textContent = out.error || "Signup failed"; 
      $("err-address").style.display = "block"; 
      loading(false);
      return; 
    }
    
    console.log("✅ Signup successful!");
    console.log("📧 Account created for:", payload.email);
    
    token = out.token || "";
    localStorage.setItem(LS_TOKEN, token);
    
    // Store the signup email in localStorage for reference
    localStorage.setItem('h2s_signup_email', payload.email);
    
    if (await hydrateMe()) { 
      isAdmin = false; 
      renderMenuItems(); 
      showPortal(); 
      
      // Show success notification with email confirmation
      toast(`Account created successfully! You're now logged in as ${payload.email}`, 5000);
      console.log(`✅ Welcome email: ${payload.email}`);
      
      switchTab("dash"); // This calls loadJobs() which handles loading(false)
      checkAndShowWelcome(); // Show welcome modal if profile incomplete
      return; // Don't turn off loading - let loadJobs() do it
    } else {
      // Hydration failed after signup - this is unusual
      console.error("❌ Signup succeeded but hydration failed");
      $("err-address").textContent = `Account created for ${payload.email}, but there was an issue loading your profile. Please try logging in.`; 
      $("err-address").style.display = "block"; 
      loading(false);
    }
  } catch(err) { 
    console.error("❌ Signup error:", err);
    $("err-address").textContent = err.message || "Error creating account"; 
    $("err-address").style.display = "block"; 
    loading(false);
  }
  // No finally - let loadJobs() turn off loading on success
});

/* ===== PROFILE PHOTO UPLOAD ===== */
// When user clicks "Choose Photo" button, trigger file input
$("btnChoosePhoto").addEventListener("click", () => {
  $("pfPhotoInput").click();
});

// When user selects a photo
$("pfPhotoInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  
  // Validate file type
  if (!file.type.startsWith('image/')) {
    toast("Please select an image file");
    return;
  }
  
  // Validate file size (max 5MB)
  if (file.size > 5 * 1024 * 1024) {
    toast("Image too large. Please choose a photo under 5MB");
    return;
  }
  
  try {
    // Show uploading state
    $("pfPhotoUploading").style.display = "block";
    
    // Read file as base64
    const reader = new FileReader();
    reader.onload = async (event) => {
      const base64 = event.target.result;
      
      try {
        console.log(`[Profile Photo] Uploading ${file.name} (${Math.round(file.size / 1024)}KB)`);
        
        // Upload to backend
        const out = await POST("portal_upload_photo", {
          token,
          image: base64,
          filename: file.name
        });
        
        if (out.ok && out.url) {
          // Update hidden input with URL
          $("pfPhoto").value = out.url;
          
          // Update preview with new photo
          const preview = $("pfPhotoPreview");
          preview.innerHTML = `<img src="${out.url}" style="width:100%;height:100%;object-fit:cover" alt="Profile photo">`;
          
          // Update button text to show photo is ready
          const btn = $("btnChoosePhoto");
          btn.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Change Photo
          `;
          
          console.log("[Profile Photo] ✅ Upload successful");
          toast("✅ Photo uploaded! Click 'Save Profile' to save changes");
        } else {
          // ✅ DETAILED ERROR HANDLING
          let errorMsg = out.error || "Unknown error";
          
          // Server 500 specific handling
          if (errorMsg.includes('500') || errorMsg.includes('Server error') || errorMsg.includes('Internal')) {
            errorMsg = "Server error - please try again in a moment";
            console.error("[Profile Photo] Server 500 error:", out);
          }
          
          // Storage errors
          if (errorMsg.includes('storage') || errorMsg.includes('bucket')) {
            errorMsg = "Storage error - contact support if this persists";
            console.error("[Profile Photo] Storage error:", out);
          }
          
          // File size errors
          if (errorMsg.includes('size') || errorMsg.includes('large')) {
            errorMsg = "Photo too large - please use an image under 5MB";
          }
          
          // Network errors
          if (errorMsg.includes('network') || errorMsg.includes('timeout')) {
            errorMsg = "Network issue - check your connection and try again";
          }
          
          console.error("[Profile Photo] Upload failed:", { error: errorMsg, response: out });
          toast(`❌ Upload failed: ${errorMsg}`);
        }
      } catch (err) {
        console.error("[Profile Photo] Critical error:", err);
        toast(`❌ Error uploading photo: ${err.message || "Please try again"}`);
      } finally {
        $("pfPhotoUploading").style.display = "none";
      }
    };
    
    reader.onerror = () => {
      toast("Error reading file");
      $("pfPhotoUploading").style.display = "none";
    };
    
    reader.readAsDataURL(file);
    
  } catch (err) {
    console.error("[Photo Upload] Error:", err);
    toast("Error uploading photo");
    $("pfPhotoUploading").style.display = "none";
  }
});

// Load existing photo preview when showing profile tab
function loadProfilePhotoPreview() {
  if (me && me.photo_url) {
    const preview = $("pfPhotoPreview");
    preview.innerHTML = `<img src="${me.photo_url}" style="width:100%;height:100%;object-fit:cover" alt="Profile photo">`;
    
    // Update button to say "Change Photo" if photo exists
    const btn = $("btnChoosePhoto");
    btn.innerHTML = `
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21 15 16 10 5 21"></polyline>
      </svg>
      Change Photo
    `;
    
    // Set hidden input value
    $("pfPhoto").value = me.photo_url;
  }
}

/* ===== PROFILE SAVE ===== */
$("btnSaveProfile").addEventListener("click", async () => {
  try {
    loading(true);
    const out = await POST("portal_update_profile", {
      token,
      vehicle_text: $("pfVehicle").value.trim(),
      service_radius_miles: $("pfMiles").value.trim(),
      max_jobs_per_day: $("pfMax").value.trim(),
      photo_url: $("pfPhoto").value.trim(),
      bio_short: $("pfBio").value.trim()
    });
    if (!out.ok) { $("pf-err").textContent = out.error || "Save failed"; $("pf-err").style.display = "block"; return; }
    
    // Update me object with new data
    me.vehicle_text = $("pfVehicle").value.trim();
    me.service_radius_miles = $("pfMiles").value.trim();
    me.max_jobs_per_day = $("pfMax").value.trim();
    me.photo_url = $("pfPhoto").value.trim();
    me.bio_short = $("pfBio").value.trim();
    
    // Update cache immediately
    setCache('me', me);
    localStorage.setItem(`h2s_me_${token}`, JSON.stringify(me));
    
    $("pf-ok").textContent = "Saved!"; $("pf-ok").style.display = "block";
    setTimeout(() => $("pf-ok").style.display = "none", 2000);
  } catch(err) { $("pf-err").textContent = err.message || "Error"; $("pf-err").style.display = "block"; }
  finally { loading(false); }
});

/* ===== WELCOME MODAL HANDLERS ===== */
$("welcomeGoToProfile").addEventListener("click", () => {
  closeWelcomeModal();
  switchTab("profile");
});

$("welcomeLater").addEventListener("click", () => {
  closeWelcomeModal();
});

/* ===== ADMIN / DISPATCH ===== */
$("btnCreateTestOrder").addEventListener("click", async () => {
  loading(true);
  try {
    const result = await GET("simulate_checkout", {});
    
    console.log('[Simulate Checkout] Result:', result);
    
    if (result.ok) {
      alert(`✅ Simulated checkout complete!\n\n` +
            `Order ID: ${result.order_id}\n` +
            `Customer: ${result.customer_email}\n` +
            `Items: ${result.items_count}\n` +
            `Rows created: ${result.total_rows}\n\n` +
            `Now click "Sync Orders → Jobs"`);
    } else {
      alert(`❌ Failed:\n${result.error}`);
    }
  } catch (err) {
    console.error('[Simulate Checkout] Error:', err);
    alert(`❌ Error: ${err.message}`);
  } finally {
    loading(false);
  }
});

$("btnMigrateOrders").addEventListener("click", async () => {
  if (!confirm("Convert all orders from h2s_orders into jobs in h2s_dispatch_jobs?\n\n" +
               "This will create jobs for any orders that don't have jobs yet.\n" +
               "Existing jobs will be skipped.")) {
    return;
  }
  
  loading(true);
  try {
    const result = await GET("create_jobs_from_orders", { token: adminToken, auto_migrate: true });
    
    console.log('[Migration] Full result:', result);
    
    if (result.ok) {
      const msg = `Migration complete!\n\n` +
                  `✅ Created: ${result.jobs_created} jobs\n` +
                  `⏭️ Skipped: ${result.jobs_skipped} (already exist)\n` +
                  `❌ Failed: ${result.jobs_failed}\n\n` +
                  `Total orders processed: ${result.total_orders}`;
      
      console.log('[Migration] Details:', result.details);
      
      // Show first 3 failures if any
      if (result.jobs_failed > 0 && result.details) {
        const failures = result.details.filter(d => d.status === 'failed').slice(0, 3);
        if (failures.length > 0) {
          console.error('[Migration] Sample failures:', failures);
          alert(msg + '\n\n⚠️ Sample errors:\n' + failures.map(f => 
            `Order ${f.order_id}: ${f.error || 'Unknown error'}`
          ).join('\n'));
          return;
        }
      }
      
      alert(msg);
      
      // Force clear cache and reload
      invalidateCache('adminJobs');
      setTimeout(() => {
        adminLoadJobs();
      }, 500);
    } else {
      alert(`Migration failed: ${result.error}`);
    }
  } catch (err) {
    console.error('[Migration] Error:', err);
    alert(`Migration error: ${err.message}`);
  } finally {
    loading(false);
  }
});

$("btnGeocodeAll").addEventListener("click", async () => {
  if (!confirm('🌍 Geocode all jobs and techs with missing coordinates?\n\nThis will:\n- Find all jobs without geo_lat/geo_lng\n- Find all techs without geo_lat/geo_lng\n- Call Google Maps API to get coordinates\n- Update database with real locations\n\nThis may take a few minutes. Continue?')) {
    return;
  }

  loading(true);
  try {
    console.log('[Geocode] Starting bulk geocoding...');
    const result = await GET("admin_geocode_all", { token: adminToken, target: 'both' });
    
    console.log('[Geocode] Full result:', result);

    if (result.ok) {
      const jobsMsg = `Jobs: ${result.results.jobs.geocoded} geocoded, ${result.results.jobs.failed} failed, ${result.results.jobs.skipped} skipped (${result.results.jobs.total} total)`;
      const prosMsg = `Techs: ${result.results.pros.geocoded} geocoded, ${result.results.pros.failed} failed, ${result.results.pros.skipped} skipped (${result.results.pros.total} total)`;
      
      alert(`✅ Geocoding complete!\n\n${jobsMsg}\n${prosMsg}`);
      
      console.log('[Geocode] Job details:', result.results.jobs.details);
      console.log('[Geocode] Pro details:', result.results.pros.details);
      
      // Refresh job list to show updated coordinates
      setTimeout(() => {
        invalidateCache('adminJobs');
        adminLoadJobs();
      }, 500);
    } else {
      alert(`Geocoding failed: ${result.error}`);
    }
  } catch (err) {
    console.error('[Geocode] Error:', err);
    alert(`Geocoding error: ${err.message}`);
  } finally {
    loading(false);
  }
});

$("btnAdRefresh").addEventListener("click", () => {
  console.log('[REFRESH] 🔄 Manual refresh - invalidating admin cache');
  invalidateCache('adminJobs');
  adminLoadJobs();
});
$("btnAdSignOut").addEventListener("click", () => doSignOut());
$("btnToggleDataHealth").addEventListener("click", () => toggleDataHealthDashboard());

async function adminLoadJobs() {
  if (!adminToken) { doSignOut(); return; }
  
  // Ensure jobs panel visible and others hidden
  $("jobsPanel").style.display = "block";
  $("announcementsPanel").style.display = "none";
  $("dataHealthDashboard").style.display = "none";
  
  const status = $("adStatus").value.trim();
  const days = Number($("adDays").value || 30) || 30;
  const cacheKey = `adminJobs_${status}_${days}`;
  
  // Check cache (shorter TTL for admin - 15s)
  const cached = getCache('adminJobs');
  if (cached && cached.status === status && cached.days === days) {
    console.log('[AdminJobs] 🎯 Using cached data');
    renderAdminJobs(cached.list);
    return;
  }
  
  try {
    loading(true);
    console.log('[AdminJobs] 🔄 Fetching jobs from server...', { status, days });
    const out = await GET("admin_jobs_list", {token: adminToken, status, days});
    console.log('[AdminJobs] 📥 Response:', out);
    
    if (!out.ok) { 
      console.error('[AdminJobs] ❌ Failed:', out.error);
      toast(out.error || "Could not load jobs"); 
      return; 
    }
    
    const list = out.jobs || [];
    console.log('[AdminJobs] ✅ Loaded', list.length, 'jobs');
    
    // Cache the result
    setCache('adminJobs', {list, status, days});
    
    // Update UX indicators
    updateLastUpdateIndicator();
    pulseJobsList();
    
    renderAdminJobs(list);
  } catch(err) { 
    console.error('[AdminJobs] 💥 Exception:', err);
    toast(err.message || "Failed to load jobs"); 
  }
  finally { loading(false); }
}

// Delete job function
async function adminDeleteJob(jobId) {
  if (!confirm(`Delete this job permanently?\n\nJob ID: ${jobId}\n\nThis action cannot be undone.`)) {
    return;
  }
  
  loading(true);
  try {
    const result = await GET("admin_job_delete", { token: adminToken, job_id: jobId });
    
    if (result.ok) {
      toast("Job deleted successfully");
      
      // Refresh job list
      invalidateCache('adminJobs');
      adminLoadJobs();
    } else {
      toast(`Failed to delete job: ${result.error}`);
    }
  } catch (err) {
    console.error('[Delete Job] Error:', err);
    toast(`Delete error: ${err.message}`);
  } finally {
    loading(false);
  }
}

// Helper to render admin jobs from cache
function renderAdminJobs(list) {
  const box = $("adList");
  $("adEmpty").style.display = list.length ? "none" : "block";
  box.onclick = null;
  
  // ✅ PERFORMANCE: Use DocumentFragment for batch DOM updates (critical for large job lists)
  const fragment = document.createDocumentFragment();
  list.forEach(J => {
    const row = document.createElement("div");
    row.className = "tr";
    row.innerHTML = `
      <div class="td"><strong>${esc(J.service_name||J.service_id||"Service")}</strong><div class="meta">${esc(J.customer_name||"")}</div></div>
      <div class="td">${esc(J.start_iso||"")}</div>
      <div class="td">${esc(J.address||"")} ${J.city ? ("• "+esc(J.city)+" "+esc(J.state||"")+" "+esc(J.zip||"")) : ""}</div>
      <div class="td">${esc(J.variant_code||"—")}</div>
      <div class="td">${esc(J.status||"")}${J.has_offer?" • offer":""}${J.accepted_by?(" • accepted by "+esc(J.accepted_by)):""}</div>
      <div class="td actions-sm">
        <button class="btn secondary" data-open="${esc(J.job_id)}" type="button">Open</button>
        <button class="btn warn" data-delete="${esc(J.job_id)}" type="button" style="margin-left:8px">Delete</button>
      </div>
    `;
    fragment.appendChild(row);
  });
  
  // Single DOM update (much faster for 50+ jobs)
  box.innerHTML = "";
  box.appendChild(fragment);
  box.onclick = e => {
    const openBtn = e.target.closest("button[data-open]");
    if (openBtn) {
      adminOpenJob(openBtn.dataset.open);
      return;
    }
    
    const deleteBtn = e.target.closest("button[data-delete]");
    if (deleteBtn) {
      adminDeleteJob(deleteBtn.dataset.delete);
      return;
    }
  };
}

/* ===== ADMIN JOB DETAIL MODAL ===== */
let currentAdminJobId = null;
let currentAdminJob = null;
let allRelatedJobIds = []; // For multi-line jobs with same ghl_event_id

async function adminOpenJob(jobId) {
  currentAdminJobId = jobId;
  
  // ✅ CRITICAL: Clear buy list UI when switching jobs - prevents showing stale data
  console.log("[adminOpenJob] Clearing buy list UI for new job:", jobId);
  clearBuyListUI();
  
  try {
    loading(true);
    const out = await GET("admin_job_get", {token: adminToken, job_id: jobId});
    if (!out.ok) { toast(out.error || "Could not load job"); return; }
    
    currentAdminJob = out.job || {};
    
    // Populate form fields
    $("adServiceId").value = currentAdminJob.service_id || "";
    $("adVariant").value = currentAdminJob.variant_code || "";
    $("adStatusField").value = currentAdminJob.status || "";
    $("adStart").value = currentAdminJob.start_iso || "";
    $("adEnd").value = currentAdminJob.end_iso || "";
    $("adRes").value = currentAdminJob.resources_needed || "";
    $("adAddr").value = currentAdminJob.address || "";
    $("adCity").value = currentAdminJob.city || "";
    $("adState").value = currentAdminJob.state || "";
    $("adZip").value = currentAdminJob.zip || "";
    
    // Check for related jobs with same ghl_event_id
    allRelatedJobIds = [jobId]; // Start with current job
    // Note: Backend would need to return ghl_event_id, for now we just work with single job
    
    // Display current assignments/offers
    const offersBox = $("adOffers");
    offersBox.innerHTML = "";
    const offers = out.offers || [];
    if (offers.length) {
      offers.forEach(a => {
        const el = document.createElement("div");
        el.className = "cand";
        const stateLabel = a.state === "accepted" ? "✓ Accepted" : 
                          a.state === "offered" ? "Pending offer" : 
                          a.state === "declined" ? "Declined" : a.state;
        el.innerHTML = `
          <div><strong>${esc(a.pro_id)}</strong> • ${stateLabel} ${a.distance_miles ? ("• " + a.distance_miles + " mi") : ""}</div>
          <div>
            ${a.state === "offered" ? `<button class="btn warn" data-cancel-offer="${esc(a.pro_id)}" type="button">Cancel offer</button>` : ""}
          </div>
        `;
        offersBox.appendChild(el);
      });
    } else {
      offersBox.innerHTML = '<p class="muted">No assignments or offers yet.</p>';
    }
    
    // Clear candidates list
    $("adCands").innerHTML = "";
    $("adProsSearch").value = "";
    
    // Show modal
    $("adModal").style.display = "grid";
    $("adModal").setAttribute("aria-hidden", "false");
    
  } catch(err) { 
    console.error("Admin open job error:", err);
    toast(err.message || "Failed to load job"); 
  }
  finally { loading(false); }
}

/* ===== DISPATCH - FIND AVAILABLE TECHS ===== */
async function adminFindAvailableTechs() {
  if (!currentAdminJobId) {
    toast("No job selected");
    return;
  }
  
  loading(true);
  try {
    console.log('[Dispatch] Finding available techs for job:', currentAdminJobId);
    
    const result = await GET("admin_dispatch", {
      token: adminToken,
      job_id: currentAdminJobId,
      action: 'find_matches'
    });
    
    if (!result.ok) {
      toast(result.error || "Failed to find available techs");
      return;
    }
    
    console.log('[Dispatch] Found', result.total_matches, 'available techs');
    
    // Display results
    const box = $("adAvailableTechs");
    box.innerHTML = "";
    box.style.display = "block";
    
    if (result.matches.length === 0) {
      box.innerHTML = `<p class="muted">No available techs found. Techs may be outside service radius or on time off.</p>`;
      return;
    }
    
    // Render available techs with send offer button
    result.matches.forEach(pro => {
      const el = document.createElement("div");
      el.className = "cand";
      el.innerHTML = `
        <div>
          <strong>${esc(pro.name)}</strong> • ${esc(pro.email)}
          ${pro.distance_miles ? `<br><span class="meta">📍 ${pro.distance_miles} miles away (max: ${pro.max_radius} mi)</span>` : ''}
          ${pro.city && pro.state ? `<br><span class="meta">${esc(pro.city)}, ${esc(pro.state)}</span>` : ''}
        </div>
        <button class="btn" data-send-offer="${esc(pro.pro_id)}" data-distance="${pro.distance_miles || 0}" type="button">Send Offer</button>
      `;
      box.appendChild(el);
    });
    
    // Add click handler for send offer buttons
    box.onclick = async (e) => {
      const btn = e.target.closest("button[data-send-offer]");
      if (!btn) return;
      
      const proId = btn.dataset.sendOffer;
      const distance = btn.dataset.distance;
      
      if (!confirm(`Send job offer to this tech?`)) return;
      
      btn.disabled = true;
      btn.textContent = "Sending...";
      
      try {
        const offerResult = await GET("admin_send_offer", {
          token: adminToken,
          job_id: currentAdminJobId,
          pro_id: proId,
          distance_miles: parseFloat(distance) || null
        });
        
        if (offerResult.ok) {
          toast("✅ Offer sent successfully!");
          btn.textContent = "✓ Sent";
          btn.classList.add("success");
          
          // Reload job to show new offer
          await adminOpenJob(currentAdminJobId);
          await adminLoadJobs();
        } else {
          toast(offerResult.error || "Failed to send offer");
          btn.disabled = false;
          btn.textContent = "Send Offer";
        }
      } catch (err) {
        console.error('[Dispatch] Send offer error:', err);
        toast("Error sending offer: " + err.message);
        btn.disabled = false;
        btn.textContent = "Send Offer";
      }
    };
    
    toast(`Found ${result.total_matches} available techs`);
    
  } catch (err) {
    console.error('[Dispatch] Error finding techs:', err);
    toast("Error: " + err.message);
  } finally {
    loading(false);
  }
}

async function adminLoadPros() {
  if (!currentAdminJobId) { toast("No job selected"); return; }
  
  try {
    loading(true);
    const out = await GET("admin_pros_for_job", {token: adminToken, job_id: currentAdminJobId, active_only: "1"});
    if (!out.ok) { toast(out.error || "Could not load pros"); return; }
    
    const candidates = out.candidates || [];
    const searchTerm = $("adProsSearch").value.toLowerCase().trim();
    
    // Filter by search
    const filtered = searchTerm ? candidates.filter(c => {
      return (c.name || "").toLowerCase().includes(searchTerm) || 
             (c.email || "").toLowerCase().includes(searchTerm);
    }) : candidates;
    
    const box = $("adCands");
    box.innerHTML = "";
    
    if (!filtered.length) {
      box.innerHTML = '<p class="muted">No pros found.</p>';
      return;
    }
    
    filtered.forEach(c => {
      const el = document.createElement("div");
      el.className = "cand";
      
      const distLabel = c.distance_miles === "" ? "Unknown distance" : 
                       c.out_of_radius ? `${c.distance_miles} mi (${c.over_miles} mi over radius)` : 
                       `${c.distance_miles} mi`;
      const ratingLabel = c.rating > 0 ? `⭐ ${c.rating.toFixed(1)}` : "No rating";
      
      el.innerHTML = `
        <div>
          <strong>${esc(c.name || c.pro_id)}</strong><br>
          <span class="meta">${esc(c.email)} • ${distLabel} • ${ratingLabel}</span>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn secondary" data-offer="${esc(c.pro_id)}" type="button">Assign (offer)</button>
          <button class="btn" data-direct="${esc(c.pro_id)}" type="button">Assign direct</button>
        </div>
      `;
      box.appendChild(el);
    });
    
    // Add click handlers
    box.onclick = async e => {
      const offerBtn = e.target.closest("button[data-offer]");
      const directBtn = e.target.closest("button[data-direct]");
      
      if (offerBtn) {
        await adminAssignOffer(offerBtn.dataset.offer);
      } else if (directBtn) {
        await adminAssignDirect(directBtn.dataset.direct);
      }
    };
    
  } catch(err) { 
    console.error("Load pros error:", err);
    toast(err.message || "Failed to load pros"); 
  }
  finally { loading(false); }
}

async function adminAssignOffer(proId) {
  if (!currentAdminJobId) return;
  
  try {
    loading(true);
    toast("Creating offer and sending email...");
    
    // If multi-line job, assign to all related job_ids
    for (const jid of allRelatedJobIds) {
      const out = await GET("admin_offer_create", {token: adminToken, job_id: jid, pro_id: proId});
      if (!out.ok) { 
        toast(`Failed to create offer for ${jid}: ${out.error}`); 
        return; 
      }
    }
    
    toast("✓ Offer created and email sent to pro!");
    await adminOpenJob(currentAdminJobId); // Reload to show updated assignments
    await adminLoadJobs(); // Refresh main list
    
  } catch(err) { 
    console.error("Assign offer error:", err);
    toast(err.message || "Failed to create offer"); 
  }
  finally { loading(false); }
}

async function adminAssignDirect(proId) {
  if (!currentAdminJobId) return;
  
  if (!confirm("Assign directly without email offer? Pro will be immediately assigned.")) return;
  
  try {
    loading(true);
    toast("Assigning pro directly...");
    
    // If multi-line job, assign to all related job_ids
    for (const jid of allRelatedJobIds) {
      const out = await GET("admin_assign_direct", {token: adminToken, job_id: jid, pro_id: proId});
      if (!out.ok) { 
        toast(`Failed to assign ${jid}: ${out.error}`); 
        return; 
      }
    }
    
    toast("✓ Pro assigned directly!");
    await adminOpenJob(currentAdminJobId); // Reload to show updated assignments
    await adminLoadJobs(); // Refresh main list
    
  } catch(err) { 
    console.error("Assign direct error:", err);
    toast(err.message || "Failed to assign"); 
  }
  finally { loading(false); }
}

async function adminSaveJobChanges() {
  if (!currentAdminJobId) return;
  
  try {
    loading(true);
    
    const payload = {
      token: adminToken,
      job_id: currentAdminJobId,
      service_id: $("adServiceId").value.trim(),
      variant_code: $("adVariant").value.trim(),
      status: $("adStatusField").value.trim(),
      start_iso: $("adStart").value.trim(),
      end_iso: $("adEnd").value.trim(),
      resources_needed: $("adRes").value.trim(),
      service_address: $("adAddr").value.trim(),
      service_city: $("adCity").value.trim(),
      service_state: $("adState").value.trim(),
      service_zip: $("adZip").value.trim()
    };
    
    const out = await POST("admin_job_update", payload);
    if (!out.ok) { toast(out.error || "Save failed"); return; }
    
    toast("Job updated!");
    await adminLoadJobs(); // Refresh list
    
  } catch(err) { 
    console.error("Save job error:", err);
    toast(err.message || "Failed to save"); 
  }
  finally { loading(false); }
}

/* ===== ADMIN MODAL HANDLERS ===== */
$("btnFindAvailableTechs").addEventListener("click", () => adminFindAvailableTechs());
$("btnAdLoadPros").addEventListener("click", () => adminLoadPros());
$("adProsSearch").addEventListener("input", () => {
  if ($("adCands").innerHTML) adminLoadPros(); // Only search if list is already loaded
});

$("btnAdSave").addEventListener("click", () => adminSaveJobChanges());

$("btnAdClose").addEventListener("click", () => {
  $("adModal").style.display = "none";
  $("adModal").setAttribute("aria-hidden", "true");
  currentAdminJobId = null;
  currentAdminJob = null;
  allRelatedJobIds = [];
});

$("adModal").addEventListener("click", e => {
  if (e.target === $("adModal")) {
    $("adModal").style.display = "none";
    $("adModal").setAttribute("aria-hidden", "true");
    currentAdminJobId = null;
    currentAdminJob = null;
    allRelatedJobIds = [];
  }
});

// Handle cancel offer from assignments list
$("adOffers").addEventListener("click", async e => {
  const cancelBtn = e.target.closest("button[data-cancel-offer]");
  if (!cancelBtn) return;
  
  const proId = cancelBtn.dataset.cancelOffer;
  if (!confirm("Cancel this offer?")) return;
  
  try {
    loading(true);
    const out = await GET("admin_offer_cancel", {token: adminToken, job_id: currentAdminJobId, pro_id: proId});
    if (!out.ok) { toast(out.error || "Failed to cancel"); return; }
    toast("Offer canceled");
    await adminOpenJob(currentAdminJobId); // Reload
    await adminLoadJobs();
  } catch(err) { 
    toast(err.message || "Failed to cancel offer"); 
  }
  finally { loading(false); }
});

// Handle Generate Buy List button
$("btnGenerateBuyList").addEventListener("click", () => {
  if (currentAdminJobId) {
    generateBuyList(currentAdminJobId);
  } else {
    toast("No job selected");
  }
});

/* ===== TRAINING ===== */
// trainingCatalog and trainingProgress already declared in global state
let currentVideo = null;
let heartbeatInterval = null;
let searchDebounce = null;

/* ===== BUY LIST & MATERIALS ORDERING ===== */

// Clear buy list UI completely - prevents stale data from bleeding across jobs
function clearBuyListUI() {
  console.log("[clearBuyListUI] Clearing all buy list UI elements");
  
  const resultsDiv = $("adBuyListResults");
  const statusDiv = $("adBuyListStatus");
  
  // Hide results
  if (resultsDiv) {
    resultsDiv.innerHTML = "";
    resultsDiv.style.display = "none";
    resultsDiv.classList.remove('slide-down');
  }
  
  // Reset status to default
  if (statusDiv) {
    statusDiv.innerHTML = `
      <span style="color: rgba(255,255,255,0.5); font-size: 14px;">
        📋 Click "Generate Buy List" to load materials for this job
      </span>
    `;
  }
  
  // Reset button state
  setBuyListButtonLoading(false);
  
  console.log("[clearBuyListUI] UI cleared - ready for new job");
}

// Helper to show/hide button loading state
function setBuyListButtonLoading(isLoading) {
  const btn = $("btnGenerateBuyList");
  const textSpan = $("btnGenerateBuyListText");
  const spinnerSpan = $("btnGenerateBuyListSpinner");
  const indicator = $("buyListLoadingIndicator");
  
  if (isLoading) {
    btn.disabled = true;
    btn.style.opacity = "0.7";
    btn.style.cursor = "not-allowed";
    textSpan.style.display = "none";
    spinnerSpan.style.display = "inline-flex";
    indicator.style.display = "inline";
  } else {
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
    textSpan.style.display = "inline";
    spinnerSpan.style.display = "none";
    indicator.style.display = "none";
  }
}

/**
 * ✨ AUTO-IMPROVEMENT: Automatically fix Service_BOM and Catalog data
 * Called in background when intelligence detects issues
 */
async function autoImproveData(jobId, analysis) {
  console.log("[autoImproveData] 🔧 Starting auto-improvement for job:", jobId);
  console.log("[autoImproveData] Analysis:", analysis);
  
  if (!analysis || !analysis.has_issues) {
    console.log("[autoImproveData] No issues to fix, skipping");
    return { ok: true, skipped: true };
  }
  
  // ✅ Filter out tech supplies from missing items before auto-fixing
  if (analysis.missing && analysis.missing.length > 0) {
    const originalCount = analysis.missing.length;
    analysis.missing = analysis.missing.filter(item => !isTechSuppliedItem(item.item_name));
    if (analysis.missing.length < originalCount) {
      console.log(`[autoImproveData] ⏭️ Filtered out ${originalCount - analysis.missing.length} tech-supplied items`);
    }
    // If no legitimate issues remain, skip
    if (analysis.missing.length === 0 && (!analysis.wrong_items || analysis.wrong_items.length === 0)) {
      console.log("[autoImproveData] No legitimate issues after filtering tech supplies");
      return { ok: true, skipped: true };
    }
  }
  
  try {
    const resp = await GET("admin_auto_improve", {
      admin_token: adminToken,
      job_id: jobId,
      analysis: JSON.stringify(analysis)
    });
    
    if (resp.ok) {
      console.log("[autoImproveData] ✅ Auto-improvement successful");
      console.log("[autoImproveData] Improvements:", resp.improvements);
      
      // Log detailed results
      if (resp.improvements.added_to_catalog > 0) {
        console.log("[autoImproveData]   📦 Added", resp.improvements.added_to_catalog, "items to Catalog");
      }
      if (resp.improvements.added_to_service_bom > 0) {
        console.log("[autoImproveData]   🔧 Added", resp.improvements.added_to_service_bom, "items to Service_BOM");
      }
      if (resp.improvements.removed_wrong_items > 0) {
        console.log("[autoImproveData]   🗑️ Removed", resp.improvements.removed_wrong_items, "wrong items");
      }
      
      return resp;
    } else {
      console.warn("[autoImproveData] ⚠️ Auto-improvement failed:", resp.error);
      return resp;
    }
  } catch (err) {
    console.error("[autoImproveData] ❌ Exception:", err);
    return { ok: false, error: err.message };
  }
}

async function generateBuyList(jobId) {
  // ✅ VALIDATION: Ensure we have a job ID
  if (!jobId) {
    console.error("[generateBuyList] ❌ CRITICAL: No job ID provided");
    toast("No job selected");
    return;
  }
  
  // ✅ VALIDATION: Ensure this matches the current job
  if (jobId !== currentAdminJobId) {
    console.warn("[generateBuyList] ⚠️ Job ID mismatch:", jobId, "vs current:", currentAdminJobId);
    console.warn("[generateBuyList] Using current job ID:", currentAdminJobId);
    jobId = currentAdminJobId; // Force sync
  }
  
  if (!adminToken) {
    $("adBuyListStatus").innerHTML = `
      <div class="fade-in" style="padding: 14px; background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3); border-radius: 10px; border-left: 4px solid #dc2626;">
        <strong>Admin session required</strong><br>
        <span style="opacity:0.9">Sign in as admin/dispatch first, then try again.</span>
      </div>`;
    toast("Admin sign-in required");
    return;
  }
  
  // ✅ LOG: Track which job we're generating for
  console.log("[generateBuyList] ═══════════════════════════════════════");
  console.log("[generateBuyList] 🎯 GENERATING BUY LIST FOR JOB:", jobId);
  console.log("[generateBuyList] 📋 Job Service:", currentAdminJob?.service_id || "unknown");
  console.log("[generateBuyList] 🏷️ Job Variant:", currentAdminJob?.variant_code || "unknown");
  console.log("[generateBuyList] ═══════════════════════════════════════");
  
  // Show loading states
  setBuyListButtonLoading(true);
  loading(true);
  
  // Clear previous results
  $("adBuyListResults").style.display = "none";
  $("adBuyListStatus").innerHTML = `
    <div style="padding: 12px; background: rgba(20,147,255,0.1); border-left: 4px solid var(--azure); border-radius: 8px; display: flex; align-items: center; gap: 10px;">
      <span class="btn-spinner" style="margin: 0;"></span>
      <div>
        <strong>Generating materials list for job ${esc(jobId)}</strong><br>
        <span style="opacity: 0.8; font-size: 13px;">Service: ${esc(currentAdminJob?.service_id || 'loading...')}</span>
      </div>
    </div>
  `;
  
  try {
    console.log("[generateBuyList] Starting for job:", jobId);
    console.log("[generateBuyList] Admin token:", adminToken ? "present" : "MISSING");
    console.log("[generateBuyList] API URL:", API);
    
    const resp = await GET("admin_buy_list", { admin_token: adminToken, job_id: jobId });
    
    console.log("[generateBuyList] Response:", resp);
    console.log("[generateBuyList] Response error:", resp.error);
    console.log("[generateBuyList] Response error_code:", resp.error_code);
    
    if (!resp.ok) {
      console.error("[generateBuyList] Error response:", resp);
      toast((resp.error || "Failed to generate buy list"));
      $("adBuyListStatus").innerHTML = `
        <div class="fade-in" style="padding: 14px; background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3); border-radius: 10px; border-left: 4px solid #dc2626;">
          <strong>Error:</strong> ${esc(resp.error || "Unknown error")}
          ${resp.error_code ? `<br><small style=\"opacity: 0.7;\">Error code: ${esc(resp.error_code)}</small>` : ''}
          ${resp.received_action ? `<br><small style=\"opacity: 0.7;\">Received action: ${esc(resp.received_action)}</small>` : ''}
          ${resp.param_keys ? `<br><small style=\"opacity: 0.7;\">Params: ${esc(resp.param_keys.join(', '))}</small>` : ''}
          <div style="margin-top: 8px; font-size: 13px; opacity: 0.9;">
            <strong>Troubleshooting:</strong><br>
            ${resp.error_code === 'unknown_action' ? 
              '• Router did not recognize this action<br>• Confirm you are signed in as admin (admin token present)<br>• Try again now that caching is off (this call is uncached)' :
              resp.error_code === 'exception' ?
              '• Server-side exception — check Apps Script execution logs<br>• Verify Buy List sheet ID and tabs (Catalog, Service_BOM)' :
              '• Check that Buy List sheet has Catalog and Service_BOM tabs<br>• Verify service_code in Jobs tab matches Service_BOM entries'
            }
          </div>
        </div>
      `;
      return;
    }
    
    if (!resp.qualified) {
      // Job date has already passed or is too soon for material delivery
      console.warn("[generateBuyList] Job not qualified:", resp.reason);
      $("adBuyListStatus").innerHTML = `
        <div class="fade-in" style="padding: 14px; background: rgba(251,191,36,0.15); border: 1px solid rgba(251,191,36,0.3); border-radius: 10px; border-left: 4px solid #fbbf24;">
          <strong>Job date issue:</strong> ${esc(resp.reason)}<br>
          <span style="opacity: 0.9; font-size: 14px; margin-top: 6px; display: block;"><strong>What to do:</strong> ${esc(resp.recommendation)}</span>
          <div style="margin-top: 12px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px; font-size: 13px;">
            <strong>Why this happened:</strong><br>
            • Job date: ${esc(resp.job_date || 'Unknown')}<br>
            • Current time: ${new Date().toLocaleString()}<br>
            • This job ${resp.reason.includes('past') ? 'has already happened' : 'is less than 48 hours away'}<br>
            • Materials need 48+ hours for guaranteed delivery
          </div>
        </div>
      `;
      $("adBuyListResults").style.display = "none";
      toast("Job timing doesn't allow material ordering");
      return;
    }
    
    // Render buy list with animation
    console.log("[generateBuyList] ✅ SUCCESS - Rendering", resp.buy_list?.items?.length || 0, "items for job", jobId);
    renderBuyList(resp.buy_list, jobId);
    
    // Update status to show success with job context
    $("adBuyListStatus").innerHTML = `
      <div style="padding: 12px; background: rgba(16,185,129,0.15); border-left: 4px solid #10b981; border-radius: 8px;">
        <strong style="color: #10b981;">Buy list generated for job ${esc(jobId)}</strong><br>
        <span style="opacity: 0.9; font-size: 13px;">Service: ${esc(currentAdminJob?.service_id || 'N/A')} • ${resp.buy_list?.items?.length || 0} items</span>
      </div>
    `;
    
    toast("Buy list generated successfully");
    
  } catch (err) {
    console.error("[generateBuyList] Exception:", err);
    toast("Failed to generate buy list");
    $("adBuyListStatus").innerHTML = `
      <div class="fade-in" style="padding: 14px; background: rgba(220,38,38,0.15); border: 1px solid rgba(220,38,38,0.3); border-radius: 10px;">
        <strong>Error:</strong> ${esc(err.message || "Unknown error")}
        <div style="margin-top: 8px; font-size: 13px; opacity: 0.9;">
          <strong>Common causes:</strong><br>
          • Network connection issue<br>
          • API endpoint not responding<br>
          • Admin token expired (try signing out and back in)
        </div>
      </div>
    `;
  } finally {
    loading(false);
    setBuyListButtonLoading(false);
  }
}

// ✅ INTELLIGENT ANALYSIS: What SHOULD be in the buy list based on service type
// Now accepts full job object with quantities for smarter analysis
function analyzeExpectedItems(job) {
  if (!job) {
    console.warn('[analyzeExpectedItems] ⚠️ No job provided');
    return [];
  }
  
  try {
    // Extract context from job object
    const service = job?.service_id || job?.service_code || '';
    const variant = job?.variant_code || job?.option_code || '';
    const customerNotes = job?.notes || job?.customer_notes || job?.notes_from_customer || '';
    const units = job?.units || job?.quantities?.units || 1;
    const tvSize = job?.tv_size || job?.quantities?.tv_size || 0;
    const runFeet = job?.run_feet || job?.quantities?.run_feet || 0;
    const cameraCount = job?.camera_count || job?.quantities?.camera_count || 0;
    
    if (!service) {
      console.warn('[analyzeExpectedItems] ⚠️ No service_id or service_code in job:', job);
      return [];
    }
    
    const serviceLC = (service || '').toLowerCase();
    const variantLC = (variant || '').toLowerCase();
    const notesLC = (customerNotes || '').toLowerCase();
    const expected = [];
    
    console.log('[analyzeExpectedItems] Analyzing with context:', {
      service, variant, units, tvSize, runFeet, cameraCount
    });
  
  // Mesh WiFi / Network Setup
  if (serviceLC.includes('mesh') || serviceLC.includes('wifi') || serviceLC.includes('network') || serviceLC.includes('router')) {
    // Smart quantity: 3-pack for units=1, scale up for multiple units
    const packSize = units > 1 ? (units * 3) : 3;
    const packLabel = packSize > 3 ? `${packSize}-node system` : '3-pack';
    
    expected.push({
      category: 'PRIMARY',
      item_name: `Mesh WiFi Router System (${packLabel})`,
      suggested_id: packSize > 3 ? `MESH_ROUTER_${packSize}NODE` : 'MESH_ROUTER_3PACK',
      why_needed: `Main equipment for whole-home mesh network (${units} unit${units > 1 ? 's' : ''})`,
      typical_brands: ['TP-Link Deco X20', 'Google Nest WiFi', 'Eero Pro 6'],
      search_terms: `mesh wifi system ${packLabel}`,
      priority: 1,
      quantity_logic: `${packSize} nodes needed for ${units} installation unit(s)`
    });
    
    // Scale Ethernet cables based on units
    expected.push({
      category: 'INSTALLATION',
      item_name: `Ethernet Cable 25ft (Cat6) ${units > 1 ? 'x' + units : ''}`,
      suggested_id: 'ETH_CABLE_25FT',
      why_needed: 'Connect main node to modem/router',
      typical_brands: ['Amazon Basics', 'Cable Matters'],
      search_terms: 'cat6 ethernet cable 25ft',
      priority: 2,
      quantity_logic: `${units} cable(s) for ${units} unit(s)`
    });
    
    expected.push({
      category: 'OPTIONAL',
      item_name: 'Cable Clips (50-pack)',
      suggested_id: 'CABLE_CLIPS_50',
      why_needed: 'Clean cable management if running Ethernet',
      typical_brands: ['Command', 'Scotch'],
      search_terms: 'cable clips adhesive',
      priority: 3
    });
  }
  
  // TV Mounting
  if (serviceLC.includes('tv') || serviceLC.includes('mount')) {
    // Use actual TV size from job data, fallback to variant parsing
    let size = '32-55"';
    if (tvSize > 0) {
      size = tvSize + '"';
    } else if (variantLC.includes('75')) {
      size = '75"';
    } else if (variantLC.includes('65')) {
      size = '65"';
    } else if (variantLC.includes('55')) {
      size = '55"';
    }
    
    // Scale hardware for multiple units
    expected.push({
      category: 'PRIMARY',
      item_name: `TV Wall Mount Bracket (${size})${units > 1 ? ' x' + units : ''}`,
      suggested_id: `TV_MOUNT_${size.replace(/"/g, '').replace('-', '_')}`,
      why_needed: `Main mounting hardware for ${size} TV${units > 1 ? ' (' + units + ' units)' : ''}`,
      typical_brands: ['Mounting Dream', 'ECHOGEAR', 'Sanus'],
      search_terms: `tv wall mount ${size}`,
      priority: 1,
      quantity_logic: `${units} mount(s) for ${units} TV(s) at ${size}`
    });
    expected.push({
      category: 'INSTALLATION',
      item_name: 'Lag Bolts & Anchors Kit',
      suggested_id: 'LAG_BOLT_KIT',
      why_needed: 'Secure mount to wall studs',
      typical_brands: ['TOGGLER', 'Hillman'],
      search_terms: 'lag bolts tv mount',
      priority: 1
    });
    // ❌ REMOVED: HDMI cables are tech supplies techs carry, NOT job-specific orders
    // They keep these in their van/supplies, no need to order per job
    expected.push({
      category: 'OPTIONAL',
      item_name: 'Cable Management Kit',
      suggested_id: 'CABLE_MGMT_KIT',
      why_needed: 'Hide cables for clean look',
      typical_brands: ['Legrand', 'Cable Concealer'],
      search_terms: 'cable management kit tv',
      priority: 3
    });
  }
  
  // Camera Installation
  if (serviceLC.includes('cam') || serviceLC.includes('camera')) {
    const isExterior = serviceLC.includes('outdoor') || serviceLC.includes('exterior') || notesLC.includes('outside');
    expected.push({
      category: 'PRIMARY',
      item_name: isExterior ? 'Outdoor Security Camera' : 'Indoor Security Camera',
      suggested_id: isExterior ? 'CAM_OUTDOOR_1080P' : 'CAM_INDOOR_1080P',
      why_needed: 'Main camera unit',
      typical_brands: ['Wyze Cam', 'Ring', 'Arlo'],
      search_terms: isExterior ? 'outdoor security camera 1080p' : 'indoor security camera 1080p',
      priority: 1
    });
    if (isExterior) {
      expected.push({
        category: 'INSTALLATION',
        item_name: 'Weatherproof Silicone Sealant',
        suggested_id: 'OUTDOOR_SEALANT',
        why_needed: 'Seal cable entry points from weather',
        typical_brands: ['DAP', 'GE Silicone II'],
        search_terms: 'outdoor silicone sealant weatherproof',
        priority: 1
      });
      expected.push({
        category: 'INSTALLATION',
        item_name: 'Masonry Drill Bit Set',
        suggested_id: 'MASONRY_BIT_SET',
        why_needed: 'Drill into brick/concrete if needed',
        typical_brands: ['DeWalt', 'Bosch'],
        search_terms: 'masonry drill bit set',
        priority: 2
      });
    }
    expected.push({
      category: 'INSTALLATION',
      item_name: 'Ethernet Cable 50ft (if wired)',
      suggested_id: 'ETH_CABLE_50FT',
      why_needed: 'Connect wired cameras to network',
      typical_brands: ['Amazon Basics', 'Cable Matters'],
      search_terms: 'cat6 ethernet cable 50ft outdoor',
      priority: 2
    });
  }
  
  // Smart Lock Installation
  if (serviceLC.includes('lock') || serviceLC.includes('smart_lock')) {
    expected.push({
      category: 'PRIMARY',
      item_name: 'Smart Lock',
      suggested_id: 'SMART_LOCK_DEADBOLT',
      why_needed: 'Main smart lock unit',
      typical_brands: ['Yale Assure Lock 2', 'August Smart Lock', 'Schlage Encode'],
      search_terms: 'smart lock deadbolt wifi',
      priority: 1
    });
    expected.push({
      category: 'INSTALLATION',
      item_name: 'Wood Screw Assortment Kit',
      suggested_id: 'WOOD_SCREW_KIT',
      why_needed: 'Various sizes for door hardware',
      typical_brands: ['Hillman', 'Grip-Rite'],
      search_terms: 'wood screw assortment kit',
      priority: 2
    });
  }
  
  // Doorbell Installation
  if (serviceLC.includes('doorbell')) {
    expected.push({
      category: 'PRIMARY',
      item_name: 'Video Doorbell',
      suggested_id: 'VIDEO_DOORBELL',
      why_needed: 'Main doorbell unit',
      typical_brands: ['Ring Video Doorbell Pro 2', 'Nest Doorbell', 'Arlo Video Doorbell'],
      search_terms: 'video doorbell wifi',
      priority: 1
    });
    if (notesLC.includes('transformer') || notesLC.includes('low voltage')) {
      expected.push({
        category: 'INSTALLATION',
        item_name: 'Doorbell Transformer 16V-30VA',
        suggested_id: 'DOORBELL_XFORMER_16V',
        why_needed: 'Power supply for video doorbell',
        typical_brands: ['Newhouse Hardware', 'Broan-NuTone'],
        search_terms: 'doorbell transformer 16v 30va',
        priority: 1
      });
    }
  }
  
  // Lighting Installation
  if (serviceLC.includes('light') || serviceLC.includes('lighting')) {
    if (serviceLC.includes('smart') || notesLC.includes('smart bulb')) {
      expected.push({
        category: 'PRIMARY',
        item_name: 'Smart Light Bulbs (4-pack)',
        suggested_id: 'SMART_BULB_4PACK',
        why_needed: 'Smart lighting control',
        typical_brands: ['Philips Hue', 'LIFX', 'Wyze Bulb'],
        search_terms: 'smart light bulbs 4 pack wifi',
        priority: 1
      });
    }
    expected.push({
      category: 'INSTALLATION',
      item_name: 'Wire Nut Assortment',
      suggested_id: 'WIRE_NUT_ASSORT',
      why_needed: 'Electrical connections',
      typical_brands: ['Ideal', '3M Scotchlok'],
      search_terms: 'wire nut assortment electrical',
      priority: 2
    });
  }
  
  return expected;
  
  } catch (err) {
    console.error('[analyzeExpectedItems] ❌ Error:', err);
    return [];
  }
}

// ✅ COMPARE: What we got vs what we expected (now accepts full job context)
function generateMissingItemsReport(job, buyList) {
  if (!job || !buyList) {
    console.warn('[generateMissingItemsReport] ⚠️ Missing job or buyList');
    return null;
  }
  
  try {
    console.log('[generateMissingItemsReport] Analyzing job:', job?.job_id, 'Service:', job?.service_id);
    
    // Get what we SHOULD have (pass full job object for quantity-aware analysis)
    const expected = analyzeExpectedItems(job);
    if (expected.length === 0) {
      console.log('[generateMissingItemsReport] No intelligence available for service:', job?.service_id);
      return null; // No intelligence for this service yet
    }
    
    console.log('[generateMissingItemsReport] Expected', expected.length, 'items:', expected.map(e => e.item_name));
  
  // Get what we ACTUALLY got
  const actual = buyList.items || [];
  
  // Find missing items (expected but not in actual)
  const missing = [];
  const missingLinks = [];
  const wrongItems = [];
  
  expected.forEach(exp => {
    // ✅ NEW: Skip tech-supplied items
    if (isTechSuppliedItem(exp.item_name)) {
      console.log(`[Intelligence] ⏭️ Skipping tech-supplied item: ${exp.item_name}`);
      return; // Don't flag as missing
    }
    
    // ✅ SMART MATCHING: Extract key product identifiers from expected item
    const expName = exp.item_name.toLowerCase();
    const expCategory = exp.category || '';
    
    // Extract key identifying terms (product type, not descriptors)
    const keyTerms = [];
    
    // Mesh/WiFi/Router detection
    if (expName.includes('mesh') || expName.includes('wifi') || expName.includes('router')) {
      keyTerms.push('mesh', 'wifi', 'router', 'network');
    }
    // TV mount detection
    if (expName.includes('mount') && (expName.includes('tv') || expName.includes('bracket'))) {
      keyTerms.push('mount', 'bracket', 'tv');
    }
    // Camera detection
    if (expName.includes('camera') || expName.includes('cam')) {
      keyTerms.push('camera', 'cam', 'security');
    }
    // Smart bulb/light detection
    if (expName.includes('bulb') || expName.includes('light')) {
      keyTerms.push('bulb', 'light', 'lamp');
    }
    // Hub/automation detection
    if (expName.includes('hub') || expName.includes('smart')) {
      keyTerms.push('hub', 'smartthings', 'alexa', 'automation');
    }
    // Doorbell detection
    if (expName.includes('doorbell') || expName.includes('video doorbell')) {
      keyTerms.push('doorbell', 'video doorbell');
    }
    // Hardware/mounting supplies
    if (expName.includes('bolt') || expName.includes('anchor') || expName.includes('screw')) {
      keyTerms.push('bolt', 'anchor', 'screw', 'hardware', 'fastener');
    }
    // Cable/wire detection
    if (expName.includes('cable') || expName.includes('wire')) {
      keyTerms.push('cable', 'wire', 'cord');
    }
    
    // Find matching item in actual buy list
    const found = actual.find(item => {
      const itemName = (item.item_name || '').toLowerCase();
      const itemId = (item.item_id || '').toLowerCase();
      
      // Must match at least 2 key terms, or 1 very specific term
      const matchCount = keyTerms.filter(term => itemName.includes(term)).length;
      const idMatchCount = keyTerms.filter(term => itemId.includes(term)).length;
      
      if (keyTerms.length === 0) {
        // Fallback: if no key terms extracted, do basic word matching
        const expWords = expName.split(/\s+/).filter(w => w.length > 4 && !['pack', 'system', 'kit'].includes(w));
        return expWords.some(word => itemName.includes(word));
      }
      
      // Check both item_name AND item_id for matches
      const totalMatches = matchCount + idMatchCount;
      
      // Primary device (mesh router, camera, etc): need 2+ matches
      if (expCategory === 'PRIMARY') {
        return totalMatches >= 2;
      }
      
      // Installation supplies: need 1+ match
      return totalMatches >= 1;
    });
    
    if (!found) {
      console.log(`[Intelligence] ❌ MISSING: "${exp.item_name}" - Key terms: [${keyTerms.join(', ')}] - Priority: ${exp.priority}`);
      
      // ✅ ONLY FLAG PRIMARY ITEMS (priority 1) - don't clutter with optional accessories
      if (exp.priority === 1) {
        missing.push({
          ...exp,
          status: 'MISSING',
          action: 'Add to Service_BOM and Catalog'
        });
      } else {
        console.log(`[Intelligence] ⏭️ Skipping non-critical missing item (priority ${exp.priority}): ${exp.item_name}`);
      }
    } else {
      console.log(`[Intelligence] ✅ FOUND: "${exp.item_name}" matched "${found.item_name}" (${found.item_id})`);
      
      // Item exists, but check if it has purchase links
      if (!found.lowes_url && !found.amazon_url && !found.missing_link) {
        missingLinks.push({
          existing_item: found,
          expected: exp,
          status: 'NO_LINK',
          action: 'Add purchase URL to Catalog'
        });
      }
    }
  });
  
  // Check for items that seem wrong (e.g., UPS battery for mesh setup)
  actual.forEach(item => {
    const itemName = (item.item_name || '').toLowerCase();
    const serviceLC = (job?.service_id || job?.service_code || '').toLowerCase();
    
    // ✅ Skip tech supplies - they're fine if included
    if (isTechSuppliedItem(item.item_name)) {
      console.log(`[Intelligence] ✅ Tech supply found (OK): ${item.item_name}`);
      return;
    }
    
    // Flag obviously wrong items
    if ((serviceLC.includes('mesh') || serviceLC.includes('wifi')) && (itemName.includes('ups') || itemName.includes('battery backup'))) {
      wrongItems.push({
        item: item,
        reason: 'UPS battery not needed for mesh WiFi setup',
        suggestion: 'Remove from Service_BOM or mark as optional'
      });
    }
    
    if (serviceLC.includes('tv') && itemName.includes('camera')) {
      wrongItems.push({
        item: item,
        reason: 'Camera not needed for TV mounting',
        suggestion: 'Wrong service_code mapping in Service_BOM'
      });
    }
    
    if (serviceLC.includes('camera') && itemName.includes('tv mount')) {
      wrongItems.push({
        item: item,
        reason: 'TV mount not needed for camera installation',
        suggestion: 'Wrong service_code mapping in Service_BOM'
      });
    }
  });
  
  return {
    expected_count: expected.length,
    actual_count: actual.length,
    missing: missing,
    missing_links: missingLinks,
    wrong_items: wrongItems,
    has_issues: missing.length > 0 || missingLinks.length > 0 || wrongItems.length > 0
  };
  
  } catch (err) {
    console.error('[generateMissingItemsReport] ❌ Error:', err);
    console.error('[generateMissingItemsReport] Stack:', err.stack);
    return null;
  }
}

// ✅ NEW: Generate intelligent job notes based on conditions
function generateJobNotes(job, buyList) {
  if (!job) return [];
  
  const notes = [];
  const service = (buyList?.service_code || job?.service_id || '').toLowerCase();
  const items = buyList?.items || [];
  const warnings = buyList?.warnings || [];
  const customerNotes = (job?.notes_from_customer || '').toLowerCase();
  const address = (job?.service_address || '').toLowerCase();
  
  // ✅ Mesh WiFi / Network Setup - DISPATCH ORDERING CONTEXT
  if (service.includes('mesh') || service.includes('wifi') || service.includes('network') || service.includes('router')) {
    notes.push("🌐 Order: Mesh WiFi System with 3+ nodes for whole-home coverage");
    
    if (customerNotes.includes('large home') || customerNotes.includes('multi-story') || customerNotes.includes('3 story') || customerNotes.includes('4000')) {
      notes.push("⚡ Large home - consider ordering extra mesh node(s) beyond standard 3-pack");
    }
    if (customerNotes.includes('dead zone') || customerNotes.includes('weak signal') || customerNotes.includes('no signal')) {
      notes.push("⚠️ Coverage issues mentioned - verify node count is sufficient for property size");
    }
  }
  
  // ✅ Smart Home Hub - DISPATCH ORDERING CONTEXT
  if (service.includes('hub') || service.includes('home_automation') || service.includes('smartthings') || service.includes('alexa hub')) {
    notes.push("📦 Order: Smart home hub (SmartThings, Hubitat, or customer-specified brand)");
  }
  
  // ✅ TV Mounting - DISPATCH ORDERING CONTEXT
  if (service.includes('tv') || service.includes('mount')) {
    const tvSize = customerNotes.match(/(\d+)['"]?\s*(inch|in|tv)?/i);
    const size = tvSize ? tvSize[1] + '"' : '32-65"';
    notes.push(`📦 Order: TV wall mount bracket for ${size} TV`);
    notes.push("📦 Order: Lag bolts & anchor kit for secure mounting");
  }
  
  // ✅ Smart Lock - DISPATCH ORDERING CONTEXT
  if (service.includes('lock') || service.includes('smart_lock')) {
    notes.push("📦 Order: Smart lock (Yale, August, or Schlage - verify door compatibility)");
  }
  
  // ❌ REMOVED: Installation tips - dispatch doesn't install, they ORDER
  
  // ✅ Doorbell - DISPATCH ORDERING CONTEXT
  if (service.includes('doorbell')) {
    const hasBattery = customerNotes.includes('battery') || customerNotes.includes('wireless');
    const hasWired = customerNotes.includes('wired') || customerNotes.includes('existing doorbell');
    
    if (hasBattery) {
      notes.push("📦 Order: Battery-powered video doorbell (Ring, Nest, Arlo)");
    } else if (hasWired) {
      notes.push("📦 Order: Wired video doorbell + transformer (if existing doorbell is old)");
    } else {
      notes.push("📦 Order: Video doorbell (confirm wired vs battery with customer)");
    }
  }
  
  // ✅ Camera - DISPATCH ORDERING CONTEXT  
  if (service.includes('cam') && !service.includes('doorbell')) {
    const isOutdoor = service.includes('outdoor') || service.includes('exterior') || customerNotes.includes('outside');
    const cameraQty = items.filter(i => (i.item_name || '').toLowerCase().includes('camera')).reduce((sum, i) => sum + (i.qty || 0), 0);
    
    if (isOutdoor) {
      notes.push(`📦 Order: ${cameraQty || 1} outdoor security camera(s) - weatherproof rated`);
    } else {
      notes.push(`📦 Order: ${cameraQty || 1} indoor security camera(s)`);
    }
  }
  
  // ❌ REMOVED: Installation details (ladder needs, wire lengths, etc.) - not relevant for dispatch ordering
  
  // ❌ REMOVED: Missing links notification - items without links won't be displayed, so no need to warn
  
  // Check for AI-created items needing review
  const needsReview = items.filter(i => i.auto_created === true || i.needs_manual_review === true);
  if (needsReview.length > 0) {
    notes.push(`🤖 ${needsReview.length} AI-generated item(s) - verify specifications before ordering`);
  }
  
  // Check for urgent delivery
  if (buyList?.delivery_strategy?.urgency === 'next_day') {
    notes.push("⚡ Next-day delivery required - order immediately to meet job schedule");
  }
  
  // ❌ REMOVED: Weather/installation considerations - dispatch orders equipment, techs handle installation
  
  return notes;
}

function renderBuyList(buyList, jobId) {
  const resultsDiv = $("adBuyListResults");
  const deliveryStrategy = buyList.delivery_strategy || {};
  
  // ✅ CRITICAL: Log which job this buy list is for
  console.log("[renderBuyList] ═══════════════════════════════════════");
  console.log("[renderBuyList] 📦 RENDERING BUY LIST");
  console.log("[renderBuyList] 🎯 Job ID:", jobId || "UNKNOWN");
  console.log("[renderBuyList] 📋 Service:", buyList.service_code || "UNKNOWN");
  console.log("[renderBuyList] 🔢 Items:", buyList.items?.length || 0);
  console.log("[renderBuyList] ═══════════════════════════════════════");
  
  // Show delivery strategy badge
  let strategyBadge = deliveryStrategy.urgency === 'next_day' 
    ? '<span style="background: #fbbf24; color: #0a2a5a; padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 13px;">NEXT-DAY REQUIRED</span>'
    : '<span style="background: #10b981; color: white; padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 13px;">STANDARD 2-DAY</span>';
  
  // ✅ Generate AI notes for special job conditions
  let aiNotes = generateJobNotes(currentAdminJob, buyList);
  
  // ✅ CRITICAL: Job identifier header - compact for mobile
  let html = `
    <div class="fade-in" style="margin-bottom: 16px; padding: 12px 14px; background: linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(168,85,247,0.15) 100%); border-radius: 10px; border: 2px solid rgba(99,102,241,0.4);">
      <div style="font-size: 14px; font-weight: 700; color: #c4b5fd; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
        <span>Materials Order</span>
        <span style="font-size: 11px; opacity: 0.7; font-weight: 400; font-family: monospace;">${esc(jobId || currentAdminJobId || 'UNKNOWN')}</span>
      </div>
      <div style="font-size: 13px; opacity: 0.9;">
        <strong>Service:</strong> ${esc(buyList.service_code || currentAdminJob?.service_id || 'N/A')} 
        ${buyList.option_code ? `• <strong>Option:</strong> ${esc(buyList.option_code)}` : ''}
        ${currentAdminJob?.units > 1 ? `• <strong>Qty:</strong> ${currentAdminJob.units}` : ''}
      </div>
    </div>`;
  
  // ✅ INTELLIGENT ANALYSIS: Compare what we got vs what we should have (pass full job context)
  let analysis = null;
  try {
    if (!currentAdminJob) {
      console.warn("[renderBuyList] ⚠️ currentAdminJob is null, skipping intelligence analysis");
    } else {
      const analysisContext = {
        ...currentAdminJob,
        buy_list_items: buyList.items || [],
        quantities: {
          units: currentAdminJob?.units || 1,
          tv_size: currentAdminJob?.tv_size || 0,
          run_feet: currentAdminJob?.run_feet || 0,
          camera_count: currentAdminJob?.camera_count || 0
        }
      };
      console.log("[renderBuyList] 🔍 Analysis context:", analysisContext);
      analysis = generateMissingItemsReport(analysisContext, buyList);
      console.log("[renderBuyList] 📊 Analysis result:", analysis);
    }
  } catch (err) {
    console.error("[renderBuyList] ❌ Intelligence analysis failed:", err);
    console.error("[renderBuyList] Error stack:", err.stack);
    analysis = null; // Gracefully fail
  }
  
  // ✅ AUTO-IMPROVEMENT: Trigger automatic fixes in the background
  if (analysis && analysis.has_issues) {
    console.log("[renderBuyList] 🔧 Issues detected - triggering auto-improvement...");
    
    // Store reference to intelligence panel for updating after completion
    const intelligencePanelId = 'intelligence-panel-' + Date.now();
    
    autoImproveData(jobId, analysis)
      .then(result => {
        if (result.ok) {
          console.log("[renderBuyList] ✅ Auto-improvement complete:", result.improvements);
          
          const statusDiv = document.querySelector('#' + intelligencePanelId + ' .auto-fix-status');
          if (statusDiv && result.improvements && !result.improvements.skipped) {
            const totalFixed = (result.improvements.added_to_service_bom || 0) + (result.improvements.added_to_catalog || 0);
            statusDiv.innerHTML = `<strong>Database Updated:</strong> Added ${totalFixed} item(s). Reload to see changes.`;
            statusDiv.style.background = 'rgba(16,185,129,0.15)';
            statusDiv.style.borderLeft = '3px solid #10b981';
          }
          
          showToast(`Auto-fixed ${(result.improvements.added_to_service_bom || 0) + (result.improvements.added_to_catalog || 0)} items`, "success");
        } else {
          console.warn("[renderBuyList] ⚠️ Auto-improvement failed:", result.error);
          
          const statusDiv = document.querySelector('#' + intelligencePanelId + ' .auto-fix-status');
          if (statusDiv) {
            statusDiv.innerHTML = `<strong>Update Failed:</strong> ${result.error || 'Unknown error'}`;
            statusDiv.style.background = 'rgba(220,38,38,0.15)';
            statusDiv.style.borderLeft = '3px solid #dc2626';
          }
        }
      })
      .catch(err => {
        console.error("[renderBuyList] ❌ Auto-improvement error:", err);
        
        const statusDiv = document.querySelector('#' + intelligencePanelId + ' .auto-fix-status');
        if (statusDiv) {
          statusDiv.innerHTML = `<strong>Error:</strong> ${err.message || 'Unknown error'}`;
          statusDiv.style.background = 'rgba(220,38,38,0.15)';
        }
      })
      .finally(() => {
        // ✅ FIX: ALWAYS remove spinner (success, failure, OR error)
        console.log('[Intelligence] Removing spinner...');
        const spinner = document.querySelector('#' + intelligencePanelId + ' .btn-spinner');
        if (spinner) {
          spinner.remove();
          console.log('[Intelligence] ✓ Spinner removed');
        } else {
          console.warn('[Intelligence] ⚠️ Spinner not found');
        }
      });
    
    // Store panel ID for later updates
    html = html.replace('<div class="fade-in" style="margin-bottom: 16px; padding: 18px;', 
                        `<div id="${intelligencePanelId}" class="fade-in" style="margin-bottom: 16px; padding: 18px;`);
  }
  
  // ✅ UNIFIED JOB ANALYSIS: One clean section instead of 3-4 colored boxes
  const hasAnalysis = (aiNotes && aiNotes.length > 0) || (analysis && analysis.has_issues);
  
  if (hasAnalysis) {
    const totalIssues = analysis ? ((analysis.missing?.length || 0) + (analysis.wrong_items?.length || 0) + (analysis.missing_links?.length || 0)) : 0;
    
    html += `
    <div class="fade-in" style="margin: 0 0 16px 0; padding: 16px; background: linear-gradient(135deg, rgba(99,102,241,0.12) 0%, rgba(139,92,246,0.08) 100%); border: 1px solid rgba(99,102,241,0.25); border-radius: 12px; box-shadow: 0 2px 8px rgba(99,102,241,0.1);">
      <div style="font-size: 15px; font-weight: 700; color: #c4b5fd; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 20px;">�</span>
        <span>Ordering Checklist</span>
      </div>`;
    
    // Ordering checklist (dispatch-focused: what to ORDER, not how to INSTALL)
    if (aiNotes && aiNotes.length > 0) {
      aiNotes.forEach(note => {
        html += `<div style="font-size: 13px; margin-bottom: 8px; opacity: 0.95; line-height: 1.6; padding-left: 4px;">• ${esc(note)}</div>`;
      });
    }
    
    // ❌ REMOVED: Materials summary with "expected vs found" - confusing for dispatch
    // They don't need to know about BOM discrepancies, just what to order
    
    // ❌ REMOVED: Missing items, missing links, wrong items sections
    // These are backend/data quality issues, not actionable for dispatch ordering
    // Dispatch needs to see: what TO order (items with links)
    // They don't need to see: what's MISSING from database, what links need adding, what's wrong in BOM
    
    html += `</div>`;
  }
  
  html += `
    <div class="fade-in" style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 12px; margin-bottom: 18px; padding: 16px; background: rgba(20,147,255,0.12); border-radius: 12px; border: 1px solid rgba(20,147,255,0.3);">
      <div style="flex: 1; min-width: 250px;">
        ${strategyBadge}
        <div style="margin-top: 10px; font-size: 14px; opacity: 0.95; line-height: 1.6;">
          <strong>Preferred Retailer:</strong> ${esc(deliveryStrategy.preferred_retailer || 'N/A')}<br>
          <strong>Lead Time:</strong> ${Math.round(deliveryStrategy.lead_time_hours || 0)} hours<br>
          <strong>Delivery Address:</strong> ${esc(deliveryStrategy.delivery_address || 'N/A')}
        </div>
      </div>
    </div>
  `;
  

  
  // ✅ SIMPLIFIED FILTERING: Only show items that are actually orderable
  const filteredItems = buyList.items ? buyList.items.filter(item => {
    // Must have a name
    if (!item.item_name || item.item_name.trim() === '') {
      return false;
    }
    
    // Must have a purchase link (Lowes or Amazon)
    const hasLink = (item.lowes_item || item.lowes_url || item.amazon_asin || item.amazon_url);
    if (!hasLink) {
      return false;
    }
    
    // Filter out tech supplies (screwdrivers, drill bits, etc - techs bring these)
    if (isTechSuppliedItem(item.item_name)) {
      return false;
    }
    
    return true;
  }) : [];
  
  console.log(`[renderBuyList] Showing ${filteredItems.length} orderable items`);
  
  // Check if we have items AFTER filtering
  if (filteredItems.length === 0) {
    html += `
      <div class="fade-in" style="padding: 20px; text-align: center; background: rgba(251,191,36,0.1); border-radius: 10px; border: 1px solid rgba(251,191,36,0.3);">
        <div style="font-size: 48px; margin-bottom: 12px;"></div>
        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No equipment with purchase links</div>
        <div style="opacity: 0.8; font-size: 14px;">
          This service doesn't have equipment configured with Lowes/Amazon links yet.<br>
          You'll need to manually determine what to order for this job.
        </div>
      </div>
    `;
    resultsDiv.innerHTML = html;
    resultsDiv.style.display = "block";
    resultsDiv.classList.add('slide-down');
    $("adBuyListStatus").innerHTML = `
      <div style="padding: 12px; background: rgba(251,191,36,0.15); border-left: 4px solid #fbbf24; border-radius: 8px;">
        <strong style="color: #fbbf24;">No orderable items</strong><br>
        <span style="opacity: 0.9; font-size: 13px;">Service: ${esc(buyList.service_code || 'N/A')}</span>
      </div>
    `;
    return;
  }
  
  // ❌ REMOVED: Warnings section - if items have no links, they're already filtered out
  // No need to show "item has no link" warnings when we just don't display those items
  
  // Render items table
  html += '<div style="overflow-x: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;">';
  html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
  html += '<thead>';
  html += '<tr style="background: rgba(255,255,255,0.08); text-align: left;">';
  html += '<th style="padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.2); font-weight: 700;">Item</th>';
  html += '<th style="padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.2); font-weight: 700;">Brand/Model</th>';
  html += '<th style="padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.2); text-align: center; font-weight: 700;">Qty</th>';
  html += '<th style="padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.2); text-align: center; font-weight: 700;">Retailer</th>';
  html += '<th style="padding: 12px; border-bottom: 2px solid rgba(255,255,255,0.2); text-align: right; font-weight: 700;">Action</th>';
  html += '</tr>';
  html += '</thead>';
  html += '<tbody>';
  
  let totalQty = 0;
  let totalCost = 0;
  
  // filteredItems already declared above - use it here
  filteredItems.forEach((item, idx) => {
    // Skip items with no name (safety check - shouldn't happen after filtering)
    if (!item.item_name || item.item_name.trim() === '') {
      console.warn(`[renderBuyList] ⚠️ Skipping item with no name: ${item.item_id}`);
      return;
    }
    
    totalQty += item.qty || 0;
    if (item.unit_cost_target) {
      totalCost += (item.qty || 0) * (item.unit_cost_target || 0);
    }
    
    // Retailer badge
    let retailerBadge = item.retailer === 'lowes'
      ? '<span style="background: #004990; color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700;">Lowe\'s</span>'
      : '<span style="background: #ff9900; color: black; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700;">Amazon</span>';
    
    // Build purchase link (we already filtered out items without links)
    let buyLink = '';
    if (item.lowes_item) {
      buyLink = `https://www.lowes.com/pd/_/${item.lowes_item}`;
    } else if (item.lowes_url) {
      buyLink = item.lowes_url;
    } else if (item.amazon_asin) {
      buyLink = `https://www.amazon.com/dp/${item.amazon_asin}`;
    } else if (item.amazon_url) {
      buyLink = item.amazon_url;
    }
    
    let actionButton = buyLink 
      ? `<a href="${buyLink}" target="_blank" rel="noopener" class="btn" style="padding: 8px 16px; min-width: auto; font-size: 13px; text-decoration: none; display: inline-block;">🛒 Buy Now</a>`
      : '<span style="opacity: 0.5; font-size: 12px;">—</span>';
    
    let requiredFlag = item.required ? '<span style="color: #fbbf24; font-weight: 700; margin-right: 6px;">★</span>' : '';
    
    html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.06); ${idx % 2 === 0 ? 'background: rgba(255,255,255,0.02);' : ''}">`;
    html += `<td data-label="Item" style="padding: 12px;">${requiredFlag}${esc(item.item_name)}</td>`;
    html += `<td data-label="Brand/Model" style="padding: 12px; opacity: 0.85;">${esc(item.brand_model || '—')}</td>`;
    html += `<td data-label="Qty" style="padding: 12px; text-align: center; font-weight: 700; font-size: 15px;">${item.qty}</td>`;
    html += `<td data-label="Retailer" style="padding: 12px; text-align: center;">${retailerBadge}</td>`;
    html += `<td data-label="Action" style="padding: 12px; text-align: right;">${actionButton}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody>';
  html += '</table>';
  html += '</div>';
  
  // Totals summary
  html += '<div class="fade-in" style="margin-top: 18px; padding: 14px; background: rgba(255,255,255,0.05); border-radius: 10px; display: flex; flex-wrap: wrap; gap: 16px; justify-content: space-between; align-items: center;">';
  html += `<div style="min-width: 150px;"><strong style="font-size: 16px;">Total Items:</strong> <span style="font-size: 18px; font-weight: 700; color: #1493ff;">${totalQty}</span></div>`;
  if (totalCost > 0) {
    html += `<div style="min-width: 150px;"><strong style="font-size: 16px;">Est. Cost:</strong> <span style="font-size: 18px; font-weight: 700; color: #10b981;">${fmtMoney(totalCost)}</span></div>`;
  }
  html += '</div>';
  
  resultsDiv.innerHTML = html;
  resultsDiv.style.display = "block";
  resultsDiv.classList.add('slide-down');
  
  // Update status indicator with animation
  $("adBuyListStatus").innerHTML = '<span class="fade-in" style="color: #10b981; font-weight: 600; font-size: 15px;">✓ Order ready to place</span>';
  
  console.log("[renderBuyList] Complete - displayed", buyList.items.length, "items");
}

async function sendOrderToAgent(jobId) {
  if (!jobId) {
    toast("No job selected");
    return;
  }
  
  if (!confirm("Send this order to the automated ordering agent?\n\nThe agent will:\n• Purchase all items from preferred retailers\n• Route delivery to the customer address\n• Track order confirmations\n• Report back with status")) {
    return;
  }
  
  loading(true);
  try {
    const resp = await GET("admin_send_to_agent", {
      admin_token: adminToken,
      job_id: jobId
    });
    
    if (!resp.ok) {
      // Check if it's a webhook config issue
      if (resp.error_code === 'no_webhook') {
        // Show payload for manual processing
        toast("Ordering agent not configured");
        showAgentPayload(resp.payload);
        return;
      }
      
      toast("Error: " + (resp.error || "Failed to send to agent"));
      console.error("[sendOrderToAgent] Error:", resp);
      return;
    }
    
    // Success!
    toast("✓ Order sent to agent successfully!");
    
    // Show confirmation details
    showAgentResponse(resp);
    
  } catch (err) {
    console.error("[sendOrderToAgent] Error:", err);
    toast("Failed to send order: " + err.message);
  } finally {
    loading(false);
  }
}

function showAgentResponse(resp) {
  const resultsDiv = $("adBuyListResults");
  
  let html = '<div style="margin-top: 20px; padding: 20px; background: rgba(16,185,129,0.15); border: 2px solid rgba(16,185,129,0.4); border-radius: 12px;">';
  html += '<h4 style="margin: 0 0 12px 0; color: #10b981; font-size: 18px;">Order Submitted Successfully</h4>';
  html += `<div style="font-size: 14px; line-height: 1.8; opacity: 0.95;">`;
  html += `<strong>Order ID:</strong> <code style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-family: monospace;">${esc(resp.order_id || 'N/A')}</code><br>`;
  html += `<strong>Submitted At:</strong> ${new Date(resp.submitted_at).toLocaleString()}<br>`;
  html += `<strong>Status:</strong> <span style="color: #10b981; font-weight: 700;">Sent to Agent</span><br>`;
  
  if (resp.agent_response) {
    html += '<div style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">';
    html += '<strong>Agent Response:</strong><br>';
    html += '<pre style="margin: 8px 0 0 0; white-space: pre-wrap; word-wrap: break-word;">' + esc(JSON.stringify(resp.agent_response, null, 2)) + '</pre>';
    html += '</div>';
  }
  
  html += '</div>';
  html += '<p style="margin: 16px 0 0 0; font-size: 13px; opacity: 0.7;">The ordering agent will process this request and update the Orders sheet with tracking information.</p>';
  html += '</div>';
  
  resultsDiv.innerHTML += html;
  
  // Update status
  $("adBuyListStatus").innerHTML = '<span style="color: #10b981; font-weight: 700; font-size: 15px;">Order sent to agent - Processing...</span>';
}

function showAgentPayload(payload) {
  if (!payload) return;
  
  const resultsDiv = $("adBuyListResults");
  
  let html = '<div style="margin-top: 20px; padding: 20px; background: rgba(251,191,36,0.15); border: 2px solid rgba(251,191,36,0.4); border-radius: 12px;">';
  html += '<h4 style="margin: 0 0 12px 0; color: #fbbf24; font-size: 18px;">Agent Webhook Not Configured</h4>';
  html += '<p style="margin: 0 0 16px 0; font-size: 14px; opacity: 0.9;">The ordering agent webhook URL is not set up. You can:</p>';
  html += '<ol style="margin: 0 0 16px 0; padding-left: 20px; font-size: 14px; line-height: 1.8;">';
  html += '<li>Configure the webhook URL in Settings sheet (key: <code>ordering_agent_webhook</code>)</li>';
  html += '<li>Copy the payload below and send it manually to your agent</li>';
  html += '</ol>';
  
  html += '<div style="margin-top: 16px;">';
  html += '<button id="btnCopyPayload" class="btn secondary" style="margin-right: 8px;">Copy Payload to Clipboard</button>';
  html += '<button id="btnDownloadPayload" class="btn ghost">Download JSON</button>';
  html += '</div>';
  
  html += '<div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; max-height: 300px; overflow-y: auto;">';
  html += '<pre id="agentPayloadJson" style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 12px;">';
  html += esc(JSON.stringify(payload, null, 2));
  html += '</pre>';
  html += '</div>';
  html += '</div>';
  
  resultsDiv.innerHTML += html;
  
  // Wire up buttons
  const copyBtn = $("btnCopyPayload");
  if (copyBtn) {
    copyBtn.onclick = () => {
      const text = JSON.stringify(payload, null, 2);
      navigator.clipboard.writeText(text).then(() => {
        toast("✓ Payload copied to clipboard");
      }).catch(err => {
        toast("Failed to copy: " + err.message);
      });
    };
  }
  
  const downloadBtn = $("btnDownloadPayload");
  if (downloadBtn) {
    downloadBtn.onclick = () => {
      const text = JSON.stringify(payload, null, 2);
      const blob = new Blob([text], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `order_${payload.order_id}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast("✓ Payload downloaded");
    };
  }
}

/* ===== DATA HEALTH DASHBOARD ===== */

// Show/hide Data Health dashboard
function toggleDataHealthDashboard() {
  const dashboard = $("dataHealthDashboard");
  const isVisible = dashboard.style.display !== "none";
  dashboard.style.display = isVisible ? "none" : "block";
  
  if (!isVisible) {
    // Load data when showing
    loadDataHealthDashboard();
  }
}

// Load complete Data Health dashboard
async function loadDataHealthDashboard() {
  if (!adminToken) {
    toast("Admin access required");
    return;
  }
  
  try {
    loading(true);
    
    // Load metrics
    await loadDataHealthMetrics();
    
    // Load Link Todo list
    await loadLinkTodoList();
    
    // Load BOM Improvements
    await loadBOMImprovements();
    
  } catch (err) {
    console.error("[loadDataHealthDashboard] Error:", err);
    toast("Failed to load dashboard: " + err.message);
  } finally {
    loading(false);
  }
}

// Load data health metrics
async function loadDataHealthMetrics() {
  try {
    const resp = await GET("admin_data_health", { admin_token: adminToken });
    
    if (!resp.ok) {
      toast("Failed to load metrics: " + (resp.error || "Unknown error"));
      return;
    }
    
    const m = resp.metrics || {};
    
    // Update KPI cards
    $("kpiCatalogTotal").textContent = m.catalog_items_total || 0;
    $("kpiCatalogWithLinks").textContent = m.catalog_items_with_links || 0;
    $("kpiMissingLinks").textContent = m.catalog_items_missing_links || 0;
    $("kpiAutoCreated").textContent = m.catalog_auto_created || 0;
    $("kpiBOMPending").textContent = m.bom_improvements_pending || 0;
    
  } catch (err) {
    console.error("[loadDataHealthMetrics] Error:", err);
    toast("Failed to load metrics");
  }
}

// Load Link Todo list (items needing links)
async function loadLinkTodoList() {
  try {
    const resp = await GET("admin_link_todo_list", { 
      admin_token: adminToken,
      status: "pending"
    });
    
    if (!resp.ok) {
      $("linkTodoList").innerHTML = '<p class="muted">Failed to load: ' + esc(resp.error || "Unknown error") + '</p>';
      return;
    }
    
    const items = resp.items || [];
    
    if (items.length === 0) {
      $("linkTodoList").innerHTML = '<p class="muted">All items have links! No action needed.</p>';
      return;
    }
    
    let html = '';
    items.forEach(item => {
      const priorityClass = item.priority === 'high' ? ' high' : '';
      const searchTerms = item.suggested_search_terms || item.search_keywords || item.item_name || '';
      
      html += `
        <div class="link-todo-item" data-item-id="${esc(item.item_id)}" data-todo-id="${esc(item.todo_id)}">
          <div class="link-todo-item-header">
            <div>
              <div class="link-todo-item-name">${esc(item.item_name || item.item_id)}</div>
              <div class="link-todo-item-search">Search: <strong>${esc(searchTerms)}</strong></div>
            </div>
            <span class="link-todo-item-priority${priorityClass}">${item.priority || 'normal'}</span>
          </div>
          <div class="link-todo-item-actions">
            <button class="btn-search-retailer" onclick="searchLowes('${esc(searchTerms).replace(/'/g, "\\'")}')">
              🔵 Search Lowe's
            </button>
            <button class="btn-search-retailer" onclick="searchAmazon('${esc(searchTerms).replace(/'/g, "\\'")}')">
              🟠 Search Amazon
            </button>
            <input 
              type="text" 
              class="link-todo-item-input" 
              id="url_${esc(item.todo_id)}" 
              placeholder="Paste product URL here..."
              aria-label="Product URL"
            />
            <button class="btn-save-link" onclick="saveLinkManually('${esc(item.item_id)}', '${esc(item.todo_id)}')">
              💾 Save Link
            </button>
          </div>
        </div>
      `;
    });
    
    $("linkTodoList").innerHTML = html;
    
  } catch (err) {
    console.error("[loadLinkTodoList] Error:", err);
    $("linkTodoList").innerHTML = '<p class="muted">Error loading items: ' + esc(err.message) + '</p>';
  }
}

// Open retailer search in new tab
function searchLowes(query) {
  const encodedQuery = encodeURIComponent(query);
  window.open(`https://www.lowes.com/search?searchTerm=${encodedQuery}`, '_blank');
}

function searchAmazon(query) {
  const encodedQuery = encodeURIComponent(query);
  window.open(`https://www.amazon.com/s?k=${encodedQuery}`, '_blank');
}

// Save product link manually
async function saveLinkManually(itemId, todoId) {
  const urlInput = $("url_" + todoId);
  const url = urlInput.value.trim();
  
  if (!url) {
    toast("Please paste a URL first");
    urlInput.focus();
    return;
  }
  
  // Validate URL
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    toast("Please enter a valid URL starting with http:// or https://");
    urlInput.focus();
    return;
  }
  
  // Determine which retailer
  const isLowes = url.includes('lowes.com');
  const isAmazon = url.includes('amazon.com');
  
  if (!isLowes && !isAmazon) {
    toast("URL must be from Lowe's or Amazon");
    return;
  }
  
  try {
    loading(true);
    
    const params = {
      admin_token: adminToken,
      item_id: itemId
    };
    
    if (isLowes) {
      params.lowes_url = url;
    } else if (isAmazon) {
      params.amazon_url = url;
    }
    
    const resp = await GET("admin_save_product_link", params);
    
    if (!resp.ok) {
      toast("Failed to save: " + (resp.error || "Unknown error"));
      return;
    }
    
    toast("Link saved successfully!");
    
    // Clear input
    urlInput.value = '';
    
    // Reload dashboard
    await loadDataHealthDashboard();
    
  } catch (err) {
    console.error("[saveLinkManually] Error:", err);
    toast("Error saving link: " + err.message);
  } finally {
    loading(false);
  }
}

// Auto-find links using AI
async function autoFindLinks(dryRun = false) {
  if (!adminToken) {
    toast("Admin access required");
    return;
  }
  
  if (!dryRun && !confirm("🤖 Start AI link search?\n\nThe AI will:\n• Search for missing product URLs\n• Validate links exist\n• Auto-populate Catalog\n\nThis may take a few minutes and will use OpenAI API credits.")) {
    return;
  }
  
  try {
    loading(true);
    
    const resp = await GET("admin_auto_find_links", {
      admin_token: adminToken,
      dry_run: dryRun ? "true" : "false"
    });
    
    if (!resp.ok) {
      toast("Failed: " + (resp.error || "Unknown error"));
      return;
    }
    
    const results = resp.results || {};
    
    if (dryRun) {
      toast(`Preview: Would process ${results.processed || 0} items`);
    } else {
      toast(`Complete! Found ${results.found || 0} links, ${results.failed || 0} failed`);
      
      // Show detailed results
      if (results.found > 0 || results.failed > 0) {
        const msg = `AI Link Search Results:\n\n` +
                   `✅ Successfully found: ${results.found}\n` +
                   `❌ Failed to find: ${results.failed}\n` +
                   `⏭️ Skipped: ${results.skipped}\n` +
                   `📊 Total processed: ${results.processed}`;
        alert(msg);
      }
      
      // Reload dashboard
      await loadDataHealthDashboard();
    }
    
  } catch (err) {
    console.error("[autoFindLinks] Error:", err);
    toast("❌ Error: " + err.message);
  } finally {
    loading(false);
  }
}

// Load BOM Improvements suggestions
async function loadBOMImprovements() {
  try {
    const resp = await GET("admin_bom_improvements", {
      admin_token: adminToken,
      status: "pending_review"
    });
    
    if (!resp.ok) {
      $("bomImprovementsList").innerHTML = '<p class="muted">Failed to load: ' + esc(resp.error || "Unknown error") + '</p>';
      return;
    }
    
    const improvements = resp.improvements || [];
    
    if (improvements.length === 0) {
      $("bomImprovementsList").innerHTML = '<p class="muted">No pending improvements. System is learning from your jobs!</p>';
      return;
    }
    
    let html = '';
    improvements.forEach(item => {
      const confidence = parseFloat(item.confidence_score || 0);
      const confidencePercent = Math.round(confidence * 100);
      let confidenceClass = 'high';
      if (confidence < 0.5) confidenceClass = 'low';
      else if (confidence < 0.75) confidenceClass = 'medium';
      
      html += `
        <div class="improvement-item" data-improvement-id="${esc(item.improvement_id)}">
          <div class="improvement-item-header">
            <div>
              <div class="improvement-item-title">${esc(item.item_id || 'Unknown Item')}</div>
              <div class="improvement-item-service">
                For service: <strong>${esc(item.service_code || 'N/A')}</strong>
                ${item.condition_tags ? ' • Conditions: ' + esc(item.condition_tags) : ''}
              </div>
            </div>
            <span class="improvement-item-confidence ${confidenceClass}">${confidencePercent}%</span>
          </div>
          <div class="improvement-item-stats">
            📊 Suggested ${item.jobs_analyzed || 0} times across recent jobs
            ${item.qty_rule ? ' • Qty: ' + esc(item.qty_rule) : ''}
          </div>
          <div class="improvement-item-actions">
            <button class="btn-approve-bom" onclick="approveBOMImprovement('${esc(item.improvement_id)}')">
              ✅ Approve & Add to BOM
            </button>
            <button class="btn-reject-bom" onclick="rejectBOMImprovement('${esc(item.improvement_id)}')">
              ❌ Reject
            </button>
          </div>
        </div>
      `;
    });
    
    $("bomImprovementsList").innerHTML = html;
    
  } catch (err) {
    console.error("[loadBOMImprovements] Error:", err);
    $("bomImprovementsList").innerHTML = '<p class="muted">Error loading improvements: ' + esc(err.message) + '</p>';
  }
}

// Approve BOM improvement
async function approveBOMImprovement(improvementId) {
  if (!improvementId) {
    toast("⚠️ Invalid improvement ID");
    return;
  }
  
  if (!confirm("✅ Approve this BOM improvement?\n\nThis will add it to the Service_BOM and it will automatically be included in future job orders.")) {
    return;
  }
  
  try {
    loading(true);
    
    const resp = await GET("admin_approve_bom", {
      admin_token: adminToken,
      improvement_id: improvementId
    });
    
    if (!resp.ok) {
      toast("Failed to approve: " + (resp.error || "Unknown error"));
      return;
    }
    
    toast("Approved! Added to Service_BOM");
    
    // Reload dashboard
    await loadDataHealthDashboard();
    
  } catch (err) {
    console.error("[approveBOMImprovement] Error:", err);
    toast("Error: " + err.message);
  } finally {
    loading(false);
  }
}

// Reject BOM improvement
async function rejectBOMImprovement(improvementId) {
  if (!improvementId) {
    toast("⚠️ Invalid improvement ID");
    return;
  }
  
  if (!confirm("❌ Reject this suggestion?\n\nThis will mark it as rejected and it won't be shown again.")) {
    return;
  }
  
  try {
    loading(true);
    
    // Note: Backend doesn't have explicit reject endpoint yet, 
    // but we can add it later. For now, just remove from view.
    toast("Reject functionality not yet implemented in backend");
    
    // TODO: Add admin_reject_bom endpoint to backend
    // const resp = await GET("admin_reject_bom", {
    //   admin_token: adminToken,
    //   improvement_id: improvementId
    // });
    
  } catch (err) {
    console.error("[rejectBOMImprovement] Error:", err);
    toast("Error: " + err.message);
  } finally {
    loading(false);
  }
}

// Event listeners for Data Health dashboard (run immediately; we're already inside outer DOMContentLoaded)
  const btnRefreshDataHealth = $("btnRefreshDataHealth");
  if (btnRefreshDataHealth) {
    btnRefreshDataHealth.addEventListener("click", () => loadDataHealthDashboard());
  }
  
  const btnAutoFindLinks = $("btnAutoFindLinks");
  if (btnAutoFindLinks) {
    btnAutoFindLinks.addEventListener("click", () => autoFindLinks(false));
  }
  
  const btnRefreshBOM = $("btnRefreshBOMImprovements");
  if (btnRefreshBOM) {
    btnRefreshBOM.addEventListener("click", () => loadBOMImprovements());
  }
  
  // Time off modal - open button
  const btnOpenTimeOffModal = $("btnOpenTimeOffModal");
  if (btnOpenTimeOffModal) {
    btnOpenTimeOffModal.addEventListener("click", () => window.openTimeOffModal());
  }
  
  // Time off modal - cancel button
  const btnCancelTimeOffModal = $("btnCancelTimeOffModal");
  if (btnCancelTimeOffModal) {
    btnCancelTimeOffModal.addEventListener("click", () => window.closeTimeOffModal());
  }
  
  // Time off modal - submit button
  const btnSubmitTimeOffModal = $("btnSubmitTimeOffModal");
  if (btnSubmitTimeOffModal) {
    btnSubmitTimeOffModal.addEventListener("click", () => window.submitTimeOffRequest());
  }
  
  // Time off modal - click outside to close
  const timeOffModal = $("timeOffModal");
  if (timeOffModal) {
    timeOffModal.addEventListener("click", e => {
      if (e.target === timeOffModal) window.closeTimeOffModal();
    });
  }

  // Support modal - open button from header
  const supportLink = $("supportLink");
  if (supportLink) {
    supportLink.addEventListener("click", (e) => {
      e.preventDefault();
      try { window.openSupportModal(); } catch(err){ console.error('[Support] open failed', err); }
    });
  }

  // Support modal buttons
  const btnCancelSupportModal = $("btnCancelSupportModal");
  if (btnCancelSupportModal) {
    btnCancelSupportModal.addEventListener("click", () => window.closeSupportModal());
  }
  const btnSubmitSupportModal = $("btnSubmitSupportModal");
  if (btnSubmitSupportModal) {
    btnSubmitSupportModal.addEventListener("click", () => window.submitSupportTicket());
  }
  // Support modal - click outside to close
  const supportModal = $("supportModal");
  if (supportModal) {
    supportModal.addEventListener("click", e => { if (e.target === supportModal) window.closeSupportModal(); });
  }

  // Safety net: delegate click to open modal in case the direct binding ever misses
  document.addEventListener("click", (e) => {
    const trigger = e.target.closest && e.target.closest('#btnOpenTimeOffModal');
    if (trigger) {
      try { window.openTimeOffModal(); } catch(err) { console.error('[TimeOff] open failed', err); }
    }
  });

  // Accessibility: allow ESC to close modal
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      const m = $("timeOffModal");
      if (m && m.style.display !== "none") {
        try { window.closeTimeOffModal(); } catch(err) { console.error('[TimeOff] close failed', err); }
      }
      const s = $("supportModal");
      if (s && s.style.display !== "none") {
        try { window.closeSupportModal(); } catch(err) { console.error('[Support] close failed', err); }
      }
    }
  });
// NOTE: We're already inside an outer DOMContentLoaded; handlers attached above.

/* ===== TIME OFF REQUESTS ===== */
async function loadSchedule() {
  try {
    // ✅ PERFORMANCE: Check cache first (5 min TTL)
    const now = Date.now();
    if (scheduleCache && scheduleCache._timestamp && (now - scheduleCache._timestamp < 300000)) {
      console.log("✅ Using cached schedule");
      displayTimeOffRequests(scheduleCache.items);
      return;
    }
    
    loading(true);
    
    // Call Apps Script availability endpoint (portal_availability doesn't exist on Vercel yet)
    const out = await GET("portal_availability_get", {token});
    
    if (!out.ok) {
      console.warn("⚠️ Could not load time off requests (non-critical):", out.error);
      // Show empty state - don't toast error for empty availability
      displayTimeOffRequests([]);
      return;
    }
    
    // ✅ Cache with timestamp
    const items = out.items || [];
    scheduleCache = { items, _timestamp: now };
    
    displayTimeOffRequests(items);
  } catch(e) {
    console.error("⚠️ Error loading time off requests (non-critical):", e);
    // Show empty state - don't toast error
    displayTimeOffRequests([]);
  } finally {
    loading(false);
  }
}

function displayTimeOffRequests(items) {
  const container = $("current-schedule-display");
  
  // Filter to only vacation/time off requests
  const timeOffRequests = items.filter(i => i.type === 'vacation').sort((a,b) => 
    new Date(a.date_local) - new Date(b.date_local)
  );
  
  if (timeOffRequests.length === 0) {
    container.innerHTML = `
      <div class="empty-state-modern">
        <div class="empty-state-icon-modern">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
        <h4 class="empty-state-title-modern">No Time Off Requested</h4>
        <p class="empty-state-text-modern">Block dates above when you can't take jobs</p>
      </div>
    `;
    return;
  }
  
  let html = '<div class="availability-section-modern">';
  timeOffRequests.forEach(item => {
    const dateStr = new Date(item.date_local).toLocaleDateString('en-US', {
      weekday: 'short',
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
    html += `
      <div class="availability-item-modern type-vacation">
        <div class="availability-info-modern">
          <div class="availability-type-badge vacation">${item.reason || 'Time Off'}</div>
          <div class="availability-details-modern">${dateStr}</div>
        </div>
        <button class="btn-delete-modern" onclick="deleteAvailability('${item.avail_id}')" type="button">Cancel</button>
      </div>
    `;
  });
  html += '</div>';
  
  container.innerHTML = html;
}

// ✅ Make time off modal functions globally accessible for onclick handlers
window.openTimeOffModal = function() {
  const $ = (id) => document.getElementById(id);
  console.log("🔓 Opening time off modal");
  const modal = $("timeOffModal");
  
  if (!modal) {
    console.error("❌ Modal element not found!");
    return;
  }
  
  console.log("✅ Modal element found:", modal);
  modal.style.display = "grid";
  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
  
  // Set up date input with min/max
  const today = new Date();
  const yyyyMmDd = (d)=>{
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };
  
  // Config: how far ahead can users book time off (in months)
  window.TIME_OFF_MAX_MONTHS_AHEAD = typeof window.TIME_OFF_MAX_MONTHS_AHEAD === 'number' ? window.TIME_OFF_MAX_MONTHS_AHEAD : 12;
  const maxDate = new Date(today.getFullYear(), today.getMonth() + window.TIME_OFF_MAX_MONTHS_AHEAD, 0);
  
  const dateInput = $("timeOffDateModal");
  const dateDisplay = $("dateDisplayValue");
  const dateDisplayTrigger = $("dateDisplayTrigger");
  const reasonSelect = $("timeOffReasonModal");
  const hintEl = $("dateRangeHint");
  
  if (dateInput) {
    dateInput.setAttribute("min", yyyyMmDd(today));
    dateInput.setAttribute("max", yyyyMmDd(maxDate));
    dateInput.value = "";
    
    // Update display when date changes
    dateInput.addEventListener('change', (e) => {
      if (e.target.value) {
        const d = new Date(e.target.value + 'T00:00:00');
        dateDisplay.textContent = d.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
      } else {
        dateDisplay.textContent = 'Choose a date';
      }
    });
  }
  
  // Trigger custom calendar on display click
  if (dateDisplayTrigger && dateInput) {
    dateDisplayTrigger.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const dropdown = document.getElementById('customCalendarDropdown');
      console.log('📅 Date display clicked, dropdown element:', dropdown);
      if (dropdown) {
        const isVisible = dropdown.style.display === 'block';
        dropdown.style.display = isVisible ? 'none' : 'block';
        console.log('📅 Dropdown display set to:', dropdown.style.display);
        if (!isVisible) {
          console.log('📅 Rendering custom calendar...');
          renderCustomCalendar(today, maxDate);
        }
      } else {
        console.error('❌ customCalendarDropdown element not found in DOM!');
      }
    });
  }
  
  if (reasonSelect) reasonSelect.value = "Vacation";
  if (hintEl) hintEl.innerHTML = `📅 You can request time off up to <strong>${maxDate.toLocaleDateString('en-US',{month:'long',year:'numeric'})}</strong>`;
  if (dateDisplay) dateDisplay.textContent = 'Choose a date';
  
  // Render quick-pick chips
  renderQuickPicks(today, maxDate);
  
  console.log("✅ Modal should now be visible");
}

window.closeTimeOffModal = function() {
  const $ = (id) => document.getElementById(id);
  console.log("🔒 Closing time off modal");
  const modal = $("timeOffModal");
  
  if (!modal) {
    console.error("❌ Modal element not found!");
    return;
  }
  
  modal.style.display = "none";
  modal.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
  console.log("✅ Modal closed");
}

window.submitTimeOffRequest = async function() {
  const $ = (id) => document.getElementById(id);
  const date = $("timeOffDateModal").value;
  const reason = $("timeOffReasonModal").value;
  
  if (!date) {
    toast("Please select a date");
    return;
  }
  
  // Handle date range if both start and end are selected
  if (selectedRangeStart && selectedRangeEnd) {
    try {
      loading(true);
      const requests = [];
      
      // Generate all dates in range
      const start = new Date(selectedRangeStart + 'T00:00:00');
      const end = new Date(selectedRangeEnd + 'T00:00:00');
      
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        requests.push(
          POST("portal_availability?action=set", {
            token, 
            type: reason, 
            date_local: dateStr
          })
        );
      }
      
      const results = await Promise.all(requests);
      const failures = results.filter(r => !r.ok);
      
      if (failures.length === 0) {
        toast(`✓ Time off requested for ${results.length} day${results.length > 1 ? 's' : ''}`);
        selectedRangeStart = null;
        selectedRangeEnd = null;
        window.closeTimeOffModal();
        await loadSchedule();
      } else {
        toast(`⚠️ ${results.length - failures.length} days saved, ${failures.length} failed`);
      }
    } catch(e) {
      toast("Error submitting range request");
    } finally {
      loading(false);
    }
    return;
  }
  
  // Single date submission
  try {
    const today = new Date();
    const maxMonths = Number(window.TIME_OFF_MAX_MONTHS_AHEAD || 12);
    const maxDate = new Date(today.getFullYear(), today.getMonth() + maxMonths, 0);
    const picked = new Date(date + 'T00:00:00');
    const floor = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    if (picked < floor) { toast("Date must be today or later"); return; }
    if (picked > maxDate) { toast(`Please choose a date on or before ${maxDate.toLocaleDateString('en-US')}`); return; }
  } catch(e) { /* ignore parse issues; backend will re-validate too */ }
  
  try {
    loading(true);
    
    const out = await POST("portal_availability?action=set", {
      token, 
      type: reason, 
      date_local: date
    });
    
    if (out.ok) {
      toast("✓ Time off requested for " + new Date(date).toLocaleDateString());
      selectedRangeStart = null;
      selectedRangeEnd = null;
      window.closeTimeOffModal();
      await loadSchedule();
    } else {
      toast(out.error || "Could not save time off request");
    }
  } catch(e) {
    toast("Error submitting request");
  } finally {
    loading(false);
  }
}

// Quick-pick chip renderer for common dates
function renderQuickPicks(today, maxDate){
  const container = document.getElementById('quickPicks');
  if (!container) return;
  
  const yyyyMmDd = (d)=>{
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };
  
  const picks = [];
  
  // Today
  picks.push({label:'Today', date: new Date(today)});
  
  // Tomorrow
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  picks.push({label:'Tomorrow', date: tomorrow});
  
  // Next Monday
  const nextMon = new Date(today);
  const daysUntilMon = (1 - nextMon.getDay() + 7) % 7 || 7;
  nextMon.setDate(nextMon.getDate() + daysUntilMon);
  if (nextMon <= maxDate) picks.push({label:'Next Monday', date: nextMon});
  
  // Next Friday
  const nextFri = new Date(today);
  const daysUntilFri = (5 - nextFri.getDay() + 7) % 7 || 7;
  nextFri.setDate(nextFri.getDate() + daysUntilFri);
  if (nextFri <= maxDate) picks.push({label:'Next Friday', date: nextFri});
  
  container.innerHTML = picks.map(p => `
    <button type="button" 
            onclick="(function(){
              const inp = document.getElementById('timeOffDateModal');
              const display = document.getElementById('dateDisplayValue');
              const dropdown = document.getElementById('customCalendarDropdown');
              if (inp) {
                inp.value = '${yyyyMmDd(p.date)}';
                if (display) {
                  display.textContent = '${p.date.toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'})}';
                }
              }
              if (dropdown) dropdown.style.display = 'none';
            })()"
            style="background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
                   border:2px solid #8b5cf6 !important;
                   border-radius:12px !important;
                   padding:16px 24px !important;
                   color:#ffffff !important;
                   font-size:15px !important;
                   font-weight:700 !important;
                   cursor:pointer !important;
                   transition:all 0.25s cubic-bezier(0.4,0,0.2,1) !important;
                   text-align:center !important;
                   white-space:nowrap !important;
                   box-shadow:0 4px 12px rgba(139,92,246,0.4) !important;
                   display:inline-block !important;
                   min-width:120px !important"
            onmouseover="this.style.cssText='background:linear-gradient(135deg, #7c3aed 0%, #a855f7 100%) !important;border:2px solid #a855f7 !important;border-radius:12px !important;padding:16px 24px !important;color:#ffffff !important;font-size:15px !important;font-weight:700 !important;cursor:pointer !important;transition:all 0.25s cubic-bezier(0.4,0,0.2,1) !important;text-align:center !important;white-space:nowrap !important;box-shadow:0 8px 20px rgba(139,92,246,0.5) !important;display:inline-block !important;min-width:120px !important;transform:translateY(-3px) scale(1.05) !important'"
            onmouseout="this.style.cssText='background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;border:2px solid #8b5cf6 !important;border-radius:12px !important;padding:16px 24px !important;color:#ffffff !important;font-size:15px !important;font-weight:700 !important;cursor:pointer !important;transition:all 0.25s cubic-bezier(0.4,0,0.2,1) !important;text-align:center !important;white-space:nowrap !important;box-shadow:0 4px 12px rgba(139,92,246,0.4) !important;display:inline-block !important;min-width:120px !important;transform:translateY(0) scale(1) !important'"
            onmousedown="this.style.transform='translateY(0) scale(0.98) !important'">${p.label}</button>
  `).join('');
}

// Custom calendar renderer with date range selection
let selectedRangeStart = null;
let selectedRangeEnd = null;

function renderCustomCalendar(today, maxDate) {
  const calMonthYear = document.getElementById('calMonthYear');
  const calWeekdays = document.getElementById('calWeekdays');
  const calDays = document.getElementById('calDays');
  const prevBtn = document.getElementById('calPrevMonth');
  const nextBtn = document.getElementById('calNextMonth');
  
  if (!calMonthYear || !calWeekdays || !calDays) return;
  
  let currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
  
  const renderMonth = () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    
    calMonthYear.textContent = firstDay.toLocaleDateString('en-US', {month:'long', year:'numeric'});
    
    // Weekday headers
    calWeekdays.innerHTML = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(day => 
      `<div style="text-align:center;font-size:12px;font-weight:700;color:#94a3b8;padding:8px 0">${day}</div>`
    ).join('');
    
    // Days grid with range selection
    let daysHTML = '';
    for (let i = 0; i < startDay; i++) {
      daysHTML += '<div></div>';
    }
    
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const isPast = date < new Date(today.getFullYear(), today.getMonth(), today.getDate());
      const isFuture = date > maxDate;
      const isDisabled = isPast || isFuture;
      
      // Check if date is in selected range
      const isSelected = (selectedRangeStart && dateStr === selectedRangeStart) || (selectedRangeEnd && dateStr === selectedRangeEnd);
      const isInRange = selectedRangeStart && selectedRangeEnd && dateStr >= selectedRangeStart && dateStr <= selectedRangeEnd;
      
      daysHTML += `<button type="button" 
        ${isDisabled ? 'disabled' : ''}
        data-date="${dateStr}"
        onclick="${isDisabled ? '' : `selectDateInRange('${dateStr}')`}"
        style="aspect-ratio:1;
               background:${isDisabled ? 'rgba(15,23,42,0.3)' : isSelected ? 'linear-gradient(135deg,#8b5cf6,#6366f1)' : isInRange ? 'linear-gradient(135deg,rgba(139,92,246,0.4),rgba(99,102,241,0.3))' : 'linear-gradient(135deg,rgba(99,102,241,0.15),rgba(99,102,241,0.08))'};
               border:2px solid ${isDisabled ? 'rgba(71,85,105,0.2)' : isSelected ? '#a855f7' : isInRange ? 'rgba(139,92,246,0.5)' : 'rgba(99,102,241,0.3)'};
               border-radius:10px;
               color:${isDisabled ? '#475569' : isSelected || isInRange ? '#ffffff' : '#e2e8f0'};
               font-size:15px;
               font-weight:${isDisabled ? '400' : isSelected ? '800' : '600'};
               cursor:${isDisabled ? 'not-allowed' : 'pointer'};
               transition:all 0.2s;
               display:flex;
               align-items:center;
               justify-content:center"
        ${isDisabled ? '' : `onmouseover="this.style.background='linear-gradient(135deg,rgba(139,92,246,0.5),rgba(99,102,241,0.4))';this.style.borderColor='rgba(139,92,246,0.6)';this.style.transform='scale(1.05)'"
        onmouseout="this.style.background='${isSelected ? 'linear-gradient(135deg,#8b5cf6,#6366f1)' : isInRange ? 'linear-gradient(135deg,rgba(139,92,246,0.4),rgba(99,102,241,0.3))' : 'linear-gradient(135deg,rgba(99,102,241,0.15),rgba(99,102,241,0.08))'}';this.style.borderColor='${isSelected ? '#a855f7' : isInRange ? 'rgba(139,92,246,0.5)' : 'rgba(99,102,241,0.3)'}';this.style.transform='scale(1)'"`}
      >${day}</button>`;
    }
    
    calDays.innerHTML = daysHTML;
  };
  
  renderMonth();
  
  if (prevBtn) {
    prevBtn.onclick = () => {
      currentMonth.setMonth(currentMonth.getMonth() - 1);
      renderMonth();
    };
  }
  
  if (nextBtn) {
    nextBtn.onclick = () => {
      currentMonth.setMonth(currentMonth.getMonth() + 1);
      renderMonth();
    };
  }
  
  // Close on outside click
  document.addEventListener('click', function closeCalOnOutside(e) {
    const dropdown = document.getElementById('customCalendarDropdown');
    const trigger = document.getElementById('dateDisplayTrigger');
    if (dropdown && dropdown.style.display === 'block' && 
        !dropdown.contains(e.target) && !trigger.contains(e.target)) {
      dropdown.style.display = 'none';
      document.removeEventListener('click', closeCalOnOutside);
    }
  });
}

// Handle date range selection
window.selectDateInRange = function(dateStr) {
  const display = document.getElementById('dateDisplayValue');
  const inp = document.getElementById('timeOffDateModal');
  
  if (!selectedRangeStart || (selectedRangeStart && selectedRangeEnd)) {
    // Start new range
    selectedRangeStart = dateStr;
    selectedRangeEnd = null;
    if (display) display.textContent = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', {weekday:'long', month:'long', day:'numeric', year:'numeric'});
    if (inp) inp.value = dateStr;
  } else if (selectedRangeStart && !selectedRangeEnd) {
    // Complete range
    if (dateStr < selectedRangeStart) {
      // Swap if end is before start
      selectedRangeEnd = selectedRangeStart;
      selectedRangeStart = dateStr;
    } else {
      selectedRangeEnd = dateStr;
    }
    const startDate = new Date(selectedRangeStart + 'T00:00:00');
    const endDate = new Date(selectedRangeEnd + 'T00:00:00');
    if (display) display.textContent = `${startDate.toLocaleDateString('en-US', {month:'short', day:'numeric'})} - ${endDate.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'})}`;
    if (inp) inp.value = selectedRangeStart; // Store start date in input
  }
  
  // Re-render calendar to show selection
  const today = new Date();
  const maxDate = new Date(today.getFullYear(), today.getMonth() + 12, 0);
  renderCustomCalendar(today, maxDate);
}

// ===== Support Ticket Modal =====
window.openSupportModal = function() {
  const $ = (id) => document.getElementById(id);
  const m = $("supportModal");
  if (!m) return;
  // Reset fields
  const subj = $("supportSubject");
  const msg = $("supportMessage");
  const cat = $("supportCategory");
  const sev = $("supportSeverity");
  if (subj) subj.value = "";
  if (msg) msg.value = "";
  if (cat) cat.value = "General";
  if (sev) sev.value = "Normal";
  m.style.display = "grid";
  m.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
};

window.closeSupportModal = function() {
  const m = document.getElementById("supportModal");
  if (!m) return;
  m.style.display = "none";
  m.setAttribute("aria-hidden", "true");
  document.body.style.overflow = "";
};

window.submitSupportTicket = async function() {
  const $ = (id) => document.getElementById(id);
  const subject = (($("supportSubject")||{}).value||"").trim();
  const message = (($("supportMessage")||{}).value||"").trim();
  const category = (($("supportCategory")||{}).value||"General");
  const severity = (($("supportSeverity")||{}).value||"Normal");
  
  if (!subject || subject.length < 3) { toast("Please enter a short subject"); return; }
  if (!message || message.length < 5) { toast("Please describe the issue"); return; }
  try{
    loading(true);
    const out = await POST("portal_support_ticket_create", {
      token,
      subject,
      message,
      category,
      severity,
      current_tab: (typeof currentTab !== 'undefined' ? currentTab : ''),
      app_version: 'portalv2-2025.11',
      user_agent: navigator.userAgent || ''
    });
    if(out && out.ok){
      toast("Ticket created: " + (out.ticket_id || "sent"));
      window.closeSupportModal();
    }else{
      toast(out && out.error ? out.error : "Failed to send ticket");
    }
  }catch(err){
    console.error('[Support] submit error', err);
    toast("Error sending to support");
  }finally{
    loading(false);
  }
};

window.deleteAvailability = async function(avail_id) {
  if (!confirm("Cancel this time off request?")) return;
  try {
    loading(true);
    const out = await POST("portal_availability?action=remove", {token, avail_id});
    if (out.ok) {
      toast("Availability removed");
      await loadSchedule();
    } else {
      toast(out.error || "Could not remove availability");
    }
  } catch(e) {
    toast("Error removing availability");
  } finally {
    loading(false);
  }
}

async function loadTraining() {
  try {
    console.log("🔍 TRAINING DEBUG: Starting loadTraining()");
    console.log("🔍 Current token:", token ? token.substring(0, 20) + '...' : 'MISSING');
    
    // ✅ PERFORMANCE: Check cache first (1 hour TTL for training)
    const cached = getCache('training');
    if (cached) {
      console.log("✅ Using cached training catalog");
      trainingCatalog = cached;
      updateTrainingStats();
      renderTrainingContent();
      renderResources();
      setupTrainingEventListeners();
      return;
    }
    
    // Show loading state
    $("training-content").innerHTML = '<div style="text-align:center;padding:60px;color:#64748b">Loading training content...</div>';
    $("training-loading").style.display = "grid";
    
    console.log("📡 Fetching training catalog from backend...");
    const preferredRegion = (localStorage.getItem('training_region') || '').toLowerCase();
    const useChina = preferredRegion === 'cn' || preferredRegion === 'china';
    let out;
    if (useChina) {
      console.log("🔍 Using China catalog per region preference");
      out = await GET("portal_training", {token, action: "china_catalog"});
    } else {
      console.log("🔍 Calling GET with action: catalog");
      out = await GET("portal_training", {token, action: "catalog"});
      // Fallback: if backend signals region block or no videos and user prefers CN
      if (!out.ok && (out.error_code === 'blocked_region' || out.error_code === 'china_required')) {
        console.log("⚠️ Region blocked or China required; switching to China catalog");
        out = await GET("portal_training", {token, action: "china_catalog"});
      } else if (out.ok && (!out.videos || out.videos.length === 0) && (preferredRegion === 'cn' || preferredRegion === 'china')) {
        console.log("ℹ️ Global catalog empty for CN preference; trying China catalog");
        const cnOut = await GET("portal_training", {token, action: "china_catalog"});
        if (cnOut && cnOut.ok) out = cnOut;
      }
    }
    
    console.log("🔍 Raw response:", out);
    
    if (!out.ok) { 
      console.error("❌ Training catalog failed:", out.error);
      console.error("🔍 Error code:", out.error_code);
      console.error("🔍 Full response:", JSON.stringify(out, null, 2));
      toast(out.error || "Could not load training"); 
      $("training-loading").style.display = "none";
      $("training-content").innerHTML = '<div style="text-align:center;padding:60px;color:#ef4444">Failed to load training content</div>';
      return; 
    }
    
    console.log("✅ Training catalog loaded:", out);
    console.log("📊 Videos count:", out.videos?.length || 0);
    console.log("📚 Resources count:", out.resources?.length || 0);
    console.log("📚 Modules count:", out.modules?.length || 0);
    console.log("🔍 Sample videos:", out.videos?.slice(0, 3));
    console.log("🔍 Modules:", out.modules);
    
    // ✅ PERFORMANCE: Cache the catalog (1 hour)
    trainingCatalog = out;
    setCache('training', out);
    
    // 🔍 LOG: Show categories from backend for debugging
    if (out.videos && out.videos.length > 0) {
      const categories = [...new Set(out.videos.map(v => v.module || v.category || 'uncategorized'))];
      console.log('📚 Training categories found:', categories);
      console.log('📊 Videos by category:', categories.map(cat => ({
        category: cat,
        count: out.videos.filter(v => (v.module || v.category) === cat).length
      })));
    }
    
    // Load progress for all videos in parallel
    const videoIds = (out.videos || []).map(v => v.id);
    await loadTrainingProgress(videoIds);
    
    $("training-loading").style.display = "none";
    
    // Update dashboard stats
    updateTrainingStats();
    
    // Build dynamic category tabs
    buildDynamicCategoryTabs();
    
    // Render sections
    renderTrainingContent();
    renderResources();
    
    // Setup event listeners
    setupTrainingEventListeners();
    
  } catch(err) { 
    console.error("❌ Training error:", err);
    console.error("🔍 Error stack:", err.stack);
    toast(err.message || "Failed to load training");
    $("training-loading").style.display = "none";
    $("training-content").innerHTML = `
      <div style="text-align:center;padding:60px;color:#ef4444">
        <h3>Error loading training</h3>
        <p style="margin:20px 0;opacity:0.8">${err.message}</p>
        <button onclick="localStorage.removeItem('cache_training'); location.reload()" class="btn" style="margin:10px">
          Clear Cache & Reload
        </button>
      </div>
    `;
  }
}

function updateTrainingStats() {
  if (!trainingCatalog || !trainingCatalog.videos) return;
  
  let completed = 0;
  let inProgress = 0;
  let totalWatchSeconds = 0;
  
  trainingCatalog.videos.forEach(v => {
    const status = getVideoStatus(v.id);
    if (status === 'completed') completed++;
    if (status === 'in_progress') inProgress++;
    
    const progress = trainingProgress[v.id];
    // ✅ USE TOTAL WATCH TIME: More accurate than position_sec
    if (progress && progress.total_watch_time) {
      totalWatchSeconds += progress.total_watch_time;
    } else if (progress && progress.position_sec) {
      // Fallback to position if total_watch_time not available yet
      totalWatchSeconds += progress.position_sec;
    }
  });
  
  $("statCompleted").textContent = completed;
  $("statInProgress").textContent = inProgress;
  
  const hours = Math.floor(totalWatchSeconds / 3600);
  const mins = Math.floor((totalWatchSeconds % 3600) / 60);
  
  if (hours > 0) {
    $("statHours").textContent = `${hours}h ${mins}m`;
  } else {
    $("statHours").textContent = `${mins}m`;
  }
}

function buildDynamicCategoryTabs() {
  if (!trainingCatalog || !trainingCatalog.videos || trainingCatalog.videos.length === 0) {
    $("trainingCategoriesOverview").style.display = "none";
    return;
  }
  
  // Group videos by module to get counts
  const moduleGroups = {};
  trainingCatalog.videos.forEach(v => {
    const module = v.module || 'Uncategorized';
    if (!moduleGroups[module]) moduleGroups[module] = [];
    moduleGroups[module].push(v);
  });
  
  const modules = Object.keys(moduleGroups).sort();
  
  if (modules.length === 0) {
    $("trainingCategoriesOverview").style.display = "none";
    return;
  }
  
  // Show the overview section
  $("trainingCategoriesOverview").style.display = "block";
  
  // Build category pills
  const pillsContainer = $("trainingCategoryPills");
  let pillsHTML = '';
  modules.forEach(module => {
    const count = moduleGroups[module].length;
    const moduleSlug = module.toLowerCase().replace(/\s+/g, '_');
    pillsHTML += `
      <div class="category-pill" data-module="${esc(moduleSlug)}">
        <span class="name">${esc(module)}</span>
        <span class="count">${count}</span>
      </div>
    `;
  });
  pillsContainer.innerHTML = pillsHTML;
  
  // Build filter tabs
  const tabsContainer = $("trainingFilterTabs");
  let tabsHTML = '<button class="filter-tab active" data-category="all" role="tab">📚 All</button>';
  
  // Auto-detect emojis for common categories
  const categoryEmojis = {
    'onboarding': '🚀',
    'getting started': '🚀',
    'technical': '🔧',
    'safety': '⚠️',
    'customer': '👥',
    'customer service': '👥',
    'business': '💼',
    'operations': '⚙️',
    'training': '📖',
    'advanced': '🎓',
    'basics': '📘'
  };
  
  modules.forEach(module => {
    const moduleLower = module.toLowerCase();
    const moduleSlug = moduleLower.replace(/\s+/g, '_');
    let emoji = '📁';
    
    // Find matching emoji
    for (const [key, icon] of Object.entries(categoryEmojis)) {
      if (moduleLower.includes(key)) {
        emoji = icon;
        break;
      }
    }
    
    tabsHTML += `
      <button class="filter-tab" data-category="${esc(moduleSlug)}" role="tab">
        ${emoji} ${esc(module)}
      </button>
    `;
  });
  
  tabsContainer.innerHTML = tabsHTML;
  
  // Add click handlers for pills (scroll to category tab and activate it)
  pillsContainer.onclick = e => {
    const pill = e.target.closest('.category-pill');
    if (!pill) return;
    
    const moduleSlug = pill.dataset.module;
    const tab = document.querySelector(`.filter-tab[data-category="${moduleSlug}"]`);
    if (tab) {
      // Activate the tab
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // Scroll to filters section
      $("trainingFilterTabs").scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      // Render filtered content
      renderTrainingContent();
    }
  };
}

async function loadTrainingProgress(videoIds) {
  try {
    console.log("📊 Loading progress for", videoIds.length, "videos");
    logTraining("Starting progress load", {videoCount: videoIds.length});
    
    // Fetch progress for all videos in parallel
    const promises = videoIds.map(async id => {
      try {
        const out = await POST("portal_training", {token, action: "progress", video_id: id});
        if (out.ok) {
          trainingProgress[id] = {
            position_sec: out.position_sec || 0,
            duration_sec: out.duration_sec || 0,
            completed: out.completed || false,
            total_watch_time: out.total_watch_time || 0,
            watch_count: out.watch_count || 0
          };
          logTraining(`Loaded ${id}`, trainingProgress[id]);
        }
      } catch(e) {
        console.warn("Failed to load progress for", id, e);
        logTraining(`Load failed for ${id}`, e.message);
      }
    });
    await Promise.all(promises);
    console.log("✅ Progress loaded for", Object.keys(trainingProgress).length, "videos");
    logTraining("Progress load complete", {count: Object.keys(trainingProgress).length});
  } catch(err) {
    console.error("❌ Progress loading error:", err);
    logTraining("Progress load error", err.message);
  }
}

function getVideoStatus(videoId) {
  const progress = trainingProgress[videoId];
  if (!progress) return "not_started";
  if (progress.completed) return "completed";
  if (progress.position_sec > 0) return "in_progress";
  return "not_started";
}

function getProgressPercentage(videoId) {
  const progress = trainingProgress[videoId];
  if (!progress || !progress.duration_sec || progress.duration_sec === 0) return 0;
  return Math.min(100, Math.round((progress.position_sec / progress.duration_sec) * 100));
}

function renderTrainingContent() {
  if (!trainingCatalog) return;
  
  const activeCategory = document.querySelector('.filter-tab.active')?.dataset.category || 'all';
  const statusFilter = $("trainingStatusFilter").value;
  const searchTerm = $("trainingSearch").value.toLowerCase().trim();
  
  let videos = trainingCatalog.videos || [];
  
  // Filter by category using actual module names
  if (activeCategory && activeCategory !== 'all') {
    videos = videos.filter(v => {
      const videoModule = (v.module || '').toLowerCase().replace(/\s+/g, '_');
      return videoModule === activeCategory;
    });
  }
  
  // Filter by status
  if (statusFilter) {
    videos = videos.filter(v => getVideoStatus(v.id) === statusFilter);
  }
  
  // Search filter
  if (searchTerm) {
    videos = videos.filter(v => {
      const hay = (v.title + ' ' + v.description + ' ' + v.module + ' ' + (v.tags || []).join(' ')).toLowerCase();
      return hay.includes(searchTerm);
    });
  }
  
  const box = $("training-content");
  const fragment = document.createDocumentFragment();
  
  // Show empty state if no videos match
  if (videos.length === 0) {
    box.innerHTML = "";
    $("currentSectionSubtitle").textContent = "No videos match your filters";
    return;
  }
  
  // Update section title with actual module name
  const activeTab = document.querySelector('.filter-tab.active');
  const categoryName = activeTab?.textContent?.trim() || 'All Training Content';
  
  $("currentSectionTitle").textContent = categoryName;
  $("currentSectionSubtitle").textContent = `${videos.length} video${videos.length !== 1 ? 's' : ''} available`;
  
  videos.forEach(v => {
    const status = getVideoStatus(v.id);
    const progressPct = getProgressPercentage(v.id);
    const el = createTrainingCard(v, progressPct, status);
    fragment.appendChild(el);
  });
  
  box.innerHTML = "";
  box.appendChild(fragment);
  
  // Add click handler
  box.onclick = async e => {
    const btn = e.target.closest("button[data-play]");
    if (!btn) return;
    const videoId = btn.dataset.play;
    const video = videos.find(v => v.id === videoId);
    if (video) playVideo(video);
  };
}

function createTrainingCard(v, progressPct, status) {
  let badgeHTML = "";
  if (status === "completed") {
    badgeHTML = '<div class="training-badge badge-completed">✓ Completed</div>';
  } else if (status === "in_progress") {
    badgeHTML = '<div class="training-badge badge-progress">⏱ In Progress</div>';
  } else {
    badgeHTML = '<div class="training-badge badge-new">New</div>';
  }
  
  const el = document.createElement("div");
  el.className = "training-card";
  el.dataset.videoId = v.id;
  
  // Thumbnail with gradient or image
  const thumbStyle = v.thumbnail 
    ? `background-image:url('${esc(v.thumbnail)}');background-size:cover;background-position:center` 
    : "";
  
  const duration = v.duration || formatDuration(v.duration_sec || 0);
  
  el.innerHTML = `
    <div class="training-thumb" style="${thumbStyle}">
      ${!v.thumbnail ? '🎬' : ''}
      ${badgeHTML}
      ${status === 'in_progress' && progressPct > 0 ? `
        <div style="position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(0,0,0,.5)">
          <div style="height:100%;background:#3b82f6;width:${progressPct}%"></div>
        </div>
      ` : ''}
    </div>
    <div class="training-body">
      <h3 class="training-title">${esc(v.title)}</h3>
      <div class="training-meta">
        <span>${esc(v.module || 'General')}</span>
        ${v.level ? `<span>${esc(v.level)}</span>` : ""}
        ${duration ? `<span>${esc(duration)}</span>` : ""}
        ${v.certificate ? '<span>Certificate</span>' : ''}
      </div>
      ${v.description ? `<div class="training-desc">${esc(v.description)}</div>` : ""}
      ${progressPct > 0 && status === 'in_progress' ? `
        <div class="training-progress">
          <div class="training-progress-bar" style="width:${progressPct}%"></div>
        </div>
        <div style="font-size:12px;opacity:.75;margin-top:6px">${progressPct}% complete</div>
      ` : ""}
      <div class="actions" style="margin-top:12px">
        <button class="btn" data-play="${esc(v.id)}" type="button">
          ${status === "completed" ? "▶ Rewatch" : status === "in_progress" ? "▶ Continue" : "▶ Watch"}
        </button>
      </div>
    </div>
  `;
  
  return el;
}

function formatDuration(seconds) {
  if (!seconds) return '';
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  if (mins > 60) {
    const hours = Math.floor(mins / 60);
    const remainMins = mins % 60;
    return `${hours}h ${remainMins}m`;
  }
  return `${mins}m ${secs}s`;
}

function renderResources() {
  if (!trainingCatalog || !trainingCatalog.resources) {
    $("training-resources-empty").style.display = "block";
    return;
  }
  
  const resources = trainingCatalog.resources || [];
  
  if (resources.length === 0) {
    $("training-resources-empty").style.display = "block";
    return;
  }
  
  $("training-resources-empty").style.display = "none";
  const box = $("training-resources");
  const fragment = document.createDocumentFragment();
  
  // ✅ SMART CATEGORIZATION: Auto-detect category from title if not set
  const autoCategories = {
    'safety': ['safety', 'ppe', 'hazard', 'osha', 'protect'],
    'technical': ['hvac', 'repair', 'install', 'troubleshoot', 'diagnostic', 'wiring', 'refrigerant'],
    'customer': ['customer', 'service', 'communication', 'complaint', 'satisfaction'],
    'checklist': ['checklist', 'inspection', 'maintenance', 'pre-', 'post-'],
    'guide': ['guide', 'manual', 'handbook', 'reference', 'how to'],
    'template': ['template', 'form', 'worksheet', 'report']
  };
  
  // Sort resources: Checklists first, then guides, then others
  const sorted = [...resources].sort((a, b) => {
    const aType = (a.type || '').toLowerCase();
    const bType = (b.type || '').toLowerCase();
    const priority = {'checklist': 1, 'guide': 2, 'template': 3, 'pdf': 4};
    return (priority[aType] || 5) - (priority[bType] || 5);
  });
  
  sorted.forEach(r => {
    const el = document.createElement("div");
    el.className = "resource-item";
    el.dataset.resourceId = r.id;
    
    // Smart icon detection
    let icon = '📄';
    let detectedType = (r.type || '').toLowerCase();
    const titleLower = (r.title || '').toLowerCase();
    
    // Auto-detect type from title if not set
    if (!detectedType || detectedType === 'pdf') {
      if (titleLower.includes('checklist') || titleLower.includes('inspection')) {
        detectedType = 'checklist';
      } else if (titleLower.includes('guide') || titleLower.includes('manual')) {
        detectedType = 'guide';
      } else if (titleLower.includes('template') || titleLower.includes('form')) {
        detectedType = 'template';
      }
    }
    
    // Icon mapping
    if (detectedType === 'checklist') icon = '✅';
    else if (detectedType === 'guide') icon = '📘';
    else if (detectedType === 'template') icon = '📋';
    else if (detectedType === 'pdf' || titleLower.includes('pdf')) icon = '📕';
    
    // Auto-detect category from title
    let category = r.category || 'General';
    if (category === 'General') {
      for (let [cat, keywords] of Object.entries(autoCategories)) {
        if (keywords.some(kw => titleLower.includes(kw))) {
          category = cat.charAt(0).toUpperCase() + cat.slice(1);
          break;
        }
      }
    }
    
    const fileSize = r.file_size ? formatFileSize(r.file_size) : '';
    
    el.innerHTML = `
      <div class="resource-icon">${icon}</div>
      <div class="resource-info">
        <h4 class="resource-title">${esc(r.title)}</h4>
        <div class="resource-meta">
          <span>${esc(category)}</span>
          ${fileSize ? `<span>${fileSize}</span>` : ''}
          ${r.updated_at ? `<span>${new Date(r.updated_at).toLocaleDateString()}</span>` : ''}
        </div>
      </div>
      <button class="resource-download" type="button">
        Download
      </button>
    `;
    
    fragment.appendChild(el);
  });
  
  box.innerHTML = "";
  box.appendChild(fragment);
  
  // Event delegation for download buttons
  box.onclick = e => {
    const btn = e.target.closest('.resource-download');
    if (!btn) return;
    const item = btn.closest('.resource-item');
    const resourceId = item.dataset.resourceId;
    const resource = resources.find(r => r.id === resourceId);
    if (resource && resource.download_url) {
      window.open(resource.download_url, '_blank');
      toast('📥 Downloading...');
    }
  };
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function setupTrainingEventListeners() {
  // Filter tab clicks
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderTrainingContent();
    });
  });
  
  // Search input
  $("trainingSearch").addEventListener('input', debounce(() => {
    renderTrainingContent();
  }, 300));
  
  // Status filter
  $("trainingStatusFilter").addEventListener('change', () => {
    renderTrainingContent();
  });
}

// Debounce helper
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// Clear all training filters
function clearTrainingFilters() {
  // Reset search
  $("trainingSearch").value = '';
  
  // Reset category to "All"
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  const allTab = document.querySelector('.filter-tab[data-category="all"]');
  if (allTab) allTab.classList.add('active');
  
  // Reset status to all
  $("trainingStatusFilter").value = '';
  
  // Re-render
  renderTrainingContent();
  
  toast('✓ Filters cleared');
}

function renderTrainingResources() {
  if (!trainingCatalog) return;
  
  const moduleFilter = $("trainingModule").value;
  const searchTerm = $("trainingSearch").value.toLowerCase().trim();
  
  let resources = trainingCatalog.resources || [];
  
  if (moduleFilter) {
    resources = resources.filter(r => r.module === moduleFilter);
  }
  
  if (searchTerm) {
    resources = resources.filter(r => {
      const hay = (r.title + ' ' + r.module + ' ' + r.type).toLowerCase();
      return hay.includes(searchTerm);
    });
  }
  
  const box = $("training-resources");
  const fragment = document.createDocumentFragment();
  $("training-resources-empty").style.display = resources.length ? "none" : "block";
  
  resources.forEach(r => {
    const el = document.createElement("div");
    el.className = "resource-card";
    
    let icon = "📄";
    if (r.type === "pdf") icon = "📄";
    else if (r.type === "link") icon = "🔗";
    else if (r.type === "checklist") icon = "✅";
    else if (r.type === "guide") icon = "📘";
    
    el.innerHTML = `
      <div class="resource-icon">${icon}</div>
      <h3 class="training-title" style="font-size:16px">${esc(r.title)}</h3>
      <div class="training-meta">
        <span>${esc(r.module)}</span>
        <span>${r.type.toUpperCase()}</span>
      </div>
      <div class="actions" style="margin-top:12px">
        <a href="${esc(r.url)}" target="_blank" rel="noopener" class="btn secondary" style="text-decoration:none;display:inline-block">Open Resource</a>
      </div>
    `;
    fragment.appendChild(el);
  });
  
  box.innerHTML = "";
  box.appendChild(fragment);
}

function playVideo(video) {
  currentVideo = video;
  $("videoTitle").textContent = video.title;
  $("videoModule").textContent = video.module || "General";
  $("videoLevel").textContent = video.level ? `${video.level}` : "";
  $("videoDuration").textContent = video.duration ? `⏱ ${video.duration}` : "";
  
  const status = getVideoStatus(video.id);
  const statusText = status === "completed" ? "✓ Completed" : status === "in_progress" ? "⏱ In Progress" : "🆕 New";
  $("videoProgressStatus").textContent = statusText;
  
  $("videoDescription").textContent = video.description || "";
  
  console.log("▶️ Playing video:", video.title, "Platform:", video.platform, "URL:", video.url);
  
  // Embed video player
  const playerBox = $("videoPlayer");
  playerBox.innerHTML = "";
  
  // Detect platform from URL if not specified
  const platform = video.platform || detectPlatform(video.url);
  
  if (platform === "loom") {
    // Extract Loom ID from URL
    const loomMatch = video.url.match(/loom\.com\/(?:share|embed)\/([a-zA-Z0-9]+)/);
    if (loomMatch) {
      const loomId = loomMatch[1];
      console.log("📹 Loom video ID:", loomId);
      
      const iframe = document.createElement("iframe");
      iframe.src = `https://www.loom.com/embed/${loomId}?hide_owner=true&hide_share=true&hide_title=true&hideEmbedTopBar=true`;
      iframe.style.cssText = "width:100%;height:100%;border:0";
      iframe.allow = "autoplay; fullscreen; picture-in-picture";
      iframe.allowFullscreen = true;
      playerBox.appendChild(iframe);
    } else {
      console.error("❌ Failed to extract Loom ID from:", video.url);
      playerBox.innerHTML = '<div style="color:#ef4444;padding:20px">Invalid Loom URL</div>';
      return;
    }
  } else if (platform === "youtube") {
    // Extract YouTube ID
    const ytMatch = video.url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]+)/);
    if (ytMatch) {
      const ytId = ytMatch[1];
      console.log("🎥 YouTube video ID:", ytId);
      
      const iframe = document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${ytId}?enablejsapi=1`;
      iframe.style.cssText = "width:100%;height:100%;border:0";
      iframe.allow = "autoplay; fullscreen; picture-in-picture";
      iframe.allowFullscreen = true;
      playerBox.appendChild(iframe);
    } else {
      console.error("❌ Failed to extract YouTube ID from:", video.url);
      playerBox.innerHTML = '<div style="color:#ef4444;padding:20px">Invalid YouTube URL</div>';
      return;
    }
  } else {
    // Generic iframe embed
    console.log("🎬 Generic video embed:", video.url);
    const iframe = document.createElement("iframe");
    iframe.src = video.url;
    iframe.style.cssText = "width:100%;height:100%;border:0";
    iframe.allow = "autoplay; fullscreen; picture-in-picture";
    iframe.allowFullscreen = true;
    playerBox.appendChild(iframe);
  }
  
  // Show modal
  $("videoModal").style.display = "grid";
  $("videoModal").setAttribute("aria-hidden", "false");
  
  // Track video viewing (simple heartbeat every 10 seconds while modal open)
  startVideoHeartbeat(video.id, video.duration_sec || 0);
  
  // Mark as viewed immediately (first touch)
  if (status === "not_started") {
    markVideoViewed(video.id);
  }
}

function detectPlatform(url) {
  if (url.includes('loom.com')) return 'loom';
  if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
  if (url.includes('vimeo.com')) return 'vimeo';
  return 'generic';
}

async function markVideoViewed(videoId) {
  try {
    console.log("👁️ Marking video as viewed:", videoId);
    await POST("portal_training", {
      token,
      action: "heartbeat",
      video_id: videoId,
      position_sec: 1,
      duration_sec: currentVideo?.duration_sec || 0,
      watch_time_delta: 1 // Initial view counts as 1 second
    });
    // Update local progress
    if (!trainingProgress[videoId]) {
      trainingProgress[videoId] = {
        position_sec: 1, 
        duration_sec: currentVideo?.duration_sec || 0, 
        completed: false,
        total_watch_time: 1
      };
    }
  } catch(e) {
    console.error("❌ Failed to mark viewed:", e);
  }
}

function startVideoHeartbeat(videoId, videoDuration) {
  stopVideoHeartbeat();
  
  let position = trainingProgress[videoId]?.position_sec || 0;
  let lastHeartbeat = Date.now();
  
  console.log("⏱️ Starting heartbeat for video:", videoId, "Resume position:", position + "s");
  logTraining("Heartbeat started", {videoId, position, duration: videoDuration});
  
  // ✅ UPDATE UI: Show progress bar if video has duration
  if (videoDuration > 0) {
    $("videoProgressBar").style.display = "block";
    $("videoWatchTime").style.display = "block";
    updateVideoProgressUI(position, videoDuration);
  }
  
  // ✅ IMPROVED: Heartbeat every 10 seconds with accurate watch time delta
  heartbeatInterval = setInterval(async () => {
    const now = Date.now();
    const watchTimeDelta = Math.floor((now - lastHeartbeat) / 1000); // Actual seconds elapsed
    lastHeartbeat = now;
    
    // Increment position by watch time (simulated playback)
    position = Math.min(position + watchTimeDelta, videoDuration || 999999);
    
    // ✅ UPDATE UI: Show progress in real-time
    if (videoDuration > 0) {
      updateVideoProgressUI(position, videoDuration);
    }
    
    console.log("💓 Heartbeat - Position:", position + "s", "Duration:", videoDuration + "s", "Delta:", watchTimeDelta + "s");
    logTraining("Heartbeat", {videoId, position, duration: videoDuration, delta: watchTimeDelta});
    
    try {
      const out = await POST("portal_training", {
        token,
        action: "heartbeat",
        video_id: videoId,
        position_sec: position,
        duration_sec: videoDuration,
        watch_time_delta: watchTimeDelta // ✅ Send actual time elapsed
      });
      
      // Update local progress
      if (out.ok) {
        trainingProgress[videoId] = {
          position_sec: out.position_sec || position,
          duration_sec: videoDuration,
          completed: out.completed || false,
          total_watch_time: (trainingProgress[videoId]?.total_watch_time || 0) + watchTimeDelta
        };
        
        logTraining("Heartbeat saved", {videoId, progress: trainingProgress[videoId]});
        
        if (out.completed && !trainingProgress[videoId].wasCompleted) {
          trainingProgress[videoId].wasCompleted = true; // Prevent duplicate toasts
          console.log("✅ Video auto-completed by backend");
          logTraining("Auto-completed", {videoId});
          toast("✓ Video completed!");
          
          // Update stats immediately
          updateTrainingStats();
        }
      } else {
        console.error("❌ Heartbeat failed:", out.error || "Unknown error");
        logTraining("Heartbeat failed", out.error);
      }
      
    } catch(e) {
      console.error("❌ Heartbeat error:", e);
      logTraining("Heartbeat exception", e.message);
    }
  }, 10000); // Every 10 seconds
}

function stopVideoHeartbeat() {
  if (heartbeatInterval) {
    clearInterval(heartbeatInterval);
    heartbeatInterval = null;
  }
}

// ✅ UPDATE UI: Show real-time progress during video playback
function updateVideoProgressUI(position, duration) {
  if (duration <= 0) return;
  
  const percentage = Math.min(100, Math.round((position / duration) * 100));
  const totalWatchTime = trainingProgress[currentVideo?.id]?.total_watch_time || position;
  
  $("videoProgressFill").style.width = percentage + "%";
  
  // Format watch time nicely
  const mins = Math.floor(totalWatchTime / 60);
  const secs = totalWatchTime % 60;
  const durMins = Math.floor(duration / 60);
  const durSecs = duration % 60;
  
  $("videoWatchTime").textContent = `${percentage}% complete • ${mins}:${secs.toString().padStart(2,'0')} / ${durMins}:${durSecs.toString().padStart(2,'0')}`;
}

$("videoMarkComplete").addEventListener("click", async () => {
  if (!currentVideo) return;
  
  try {
    loading(true);
    console.log("✅ Manually marking complete:", currentVideo.id);
    const out = await POST("portal_training", {token, action: "complete", video_id: currentVideo.id});
    if (!out.ok) { 
      toast(out.error || "Failed to mark complete");
      loading(false);
      return;
    }
    
    // Update local progress
    trainingProgress[currentVideo.id] = {
      ...(trainingProgress[currentVideo.id] || {}),
      completed: true
    };
    
    toast("✓ Marked complete!");
    closeVideoModal();
    
    // Re-render training to update badges
    updateTrainingStats();
    renderTrainingContent();
  } catch(err) {
    console.error("❌ Mark complete error:", err);
    toast(err.message || "Failed to mark complete");
  } finally {
    loading(false);
  }
});

$("videoClose").addEventListener("click", () => closeVideoModal());

$("videoModal").addEventListener("click", e => {
  if (e.target === $("videoModal")) closeVideoModal();
});

function closeVideoModal() {
  console.log("🚪 Closing video modal");
  
  // ✅ SAFEGUARD: Save progress one final time before closing
  if (currentVideo && heartbeatInterval) {
    saveFinalProgress();
  }
  
  stopVideoHeartbeat();
  $("videoModal").style.display = "none";
  $("videoModal").setAttribute("aria-hidden", "true");
  $("videoPlayer").innerHTML = "";
  currentVideo = null;
  
  // Update UI to reflect any progress changes
  updateTrainingStats();
  renderTrainingContent();
}

// ✅ SAFEGUARD: Save progress immediately when closing modal
async function saveFinalProgress() {
  if (!currentVideo) return;
  
  const videoId = currentVideo.id;
  const videoDuration = currentVideo.duration_sec || 0;
  const position = trainingProgress[videoId]?.position_sec || 0;
  
  console.log("💾 Saving final progress:", videoId, position + "s");
  
  try {
    await POST("portal_training", {
      token,
      action: "heartbeat",
      video_id: videoId,
      position_sec: position,
      duration_sec: videoDuration,
      watch_time_delta: 0 // No delta on final save, just persist current state
    });
  } catch(e) {
    console.error("❌ Failed to save final progress:", e);
  }
}

// ✅ SAFEGUARD: Save progress when user leaves page
window.addEventListener("beforeunload", () => {
  if (currentVideo && heartbeatInterval) {
    // Use sendBeacon for reliable delivery even as page unloads
    const videoId = currentVideo.id;
    const position = trainingProgress[videoId]?.position_sec || 0;
    const videoDuration = currentVideo.duration_sec || 0;
    
    const payload = JSON.stringify({
      action: "heartbeat",
      token,
      video_id: videoId,
      position_sec: position,
      duration_sec: videoDuration,
      watch_time_delta: 0
    });
    
    // Try sendBeacon first (most reliable)
    const beaconUrl = VERCEL_API + "/portal_training";
    const beaconPayload = new Blob([payload], {type: 'application/json'});
    if (navigator.sendBeacon) {
      navigator.sendBeacon(beaconUrl, beaconPayload);
      console.log("📡 Beacon sent:", videoId);
    }
  }
});


/* ===== INIT ===== */
(async function init() {
  console.log("🚀 Initializing portal...");
  console.log("Admin token:", adminToken ? "present" : "none");
  console.log("Pro token:", token ? "present" : "none");
  
  // 💾 Load cache from LocalStorage FIRST (instant initial render)
  loadCacheFromStorage();
  
  try {
    if (adminToken) {
      console.log("🔧 Attempting admin session...");
      loading(true);
      isAdmin = true;
      renderMenuItems();
      showAdmin();
      await adminLoadJobs();
      loading(false);
      return;
    }
    
    renderMenuItems();
    
    if (token) {
      console.log("👤 Attempting pro session with existing token...");
      console.log(`🔑 Token found in storage: ${token.substring(0, 20)}...`);
      const perfStart = performance.now();
      
      // 🚀 INSTANT RENDER: Show portal UI immediately, validate token in background
      isAdmin = false;
      renderMenuItems();
      showPortal();
      
      // Show cached data FIRST (instant), then validate and refresh
      const cachedJobs = getCache('dash');
      
      // ✅ PERSISTENCE: Restore last used tab
      const lastTab = localStorage.getItem('h2s_last_tab') || 'dash';
      
      if (cachedJobs) {
        console.log("⚡ Rendering cached dashboard instantly...");
        currentJobsData = cachedJobs;
        renderOffers(cachedJobs.offers || []);
        renderUpcoming(cachedJobs.upcoming || []);
        renderCompleted(cachedJobs.completed || []);
        // Restore last tab and view state
        switchTab(lastTab);
        restoreViewState();
        console.log(`⚡ Instant render complete: ${Math.round(performance.now() - perfStart)}ms`);
      } else {
        // No cache, show loading for first-time users
        loading(true);
        switchTab(lastTab);
        restoreViewState();
      }
      
      // Validate token in background (doesn't block render)
      hydrateMe().then(hydrated => {
        console.log(`💧 Hydration: ${hydrated ? 'SUCCESS' : 'FAILED'} (${Math.round(performance.now() - perfStart)}ms)`);
        
        if (hydrated) {
          console.log("✅ Pro session valid - staying logged in");
          checkAndShowWelcome(); // Show welcome modal if profile incomplete
          
          // Refresh dashboard with fresh data (background update)
          if (!cachedJobs) {
            loadJobs(); // Only load if we didn't show cache
          } else {
            // Soft refresh in background to update cache
            console.log("🔄 Soft refresh: updating cache in background");
            loadJobs();
          }

          // Keep view state consistent on successful hydration
          restoreViewState();
          
          console.log(`⚡ Portal fully loaded in ${Math.round(performance.now() - perfStart)}ms`);
        } else {
          // ✅ RESILIENCE: Don't log out on network error, only on explicit auth failure
          // If we have a token but hydration failed, it might be a network blip.
          // We'll assume valid for now if we have cached data, otherwise show auth.
          if (cachedJobs && me) {
             console.warn("⚠️ Hydration failed but cache + profile exists - staying logged in (offline mode)");
             toast("⚠️ Working offline - some features may be limited");
          } else if (cachedJobs) {
             console.warn("⚠️ Hydration failed but cache exists - staying logged in (degraded mode)");
             toast("⚠️ Connection issue - using cached data");
          } else {
             console.warn("⚠️ Hydration failed and no cache - session likely expired");
             toast("Session expired - please sign in again");
             doSignOut();
          }
        }
      }).catch(err => {
        console.error("❌ Hydration error:", err);
        // ✅ RESILIENCE: Same logic as above
        if (cachedJobs) {
           console.warn("⚠️ Hydration exception but cache exists - staying logged in");
           toast("⚠️ Network error - using cached data");
        } else {
           console.warn("⚠️ Hydration error and no cache - redirecting to auth");
           doSignOut();
        }
      });
    } else {
      console.log("📝 No token, showing auth");
      showAuth();
      loading(false); // Ensure loading is off
    }
    
    if ($("view-portal").getAttribute("aria-hidden") === "false") {
      showMenuButton();
    }
  } catch(err) {
    console.error("❌ Init error:", err);
    loading(false); // Always turn off loading on error
    showAuth();
  }
})();

/* ===== ANNOUNCEMENTS EVENT LISTENERS ===== */
// Test connection button - ENHANCED DIAGNOSTICS
if ($("btnTestAnnouncements")) {
  $("btnTestAnnouncements").addEventListener("click", async () => {
    console.log('========================================');
    console.log('🔧 TESTING ANNOUNCEMENTS CONNECTION');
    console.log('========================================');
    console.log('API URL:', API);
    console.log('Action: announcements_list');
    console.log('Params: { admin: "true" }');
    
    loading(true);
    try {
      const result = await GET("announcements_list", { admin: "true" });
      console.log('\n� RESULT:', result);
      console.log('Type:', typeof result);
      console.log('Keys:', result ? Object.keys(result) : 'null');
      
      if (result && result.ok) {
        const count = (result.announcements || []).length;
        toast(`✅ Connected! Found ${count} announcements`);
        console.log('✅ SUCCESS - Announcements:', result.announcements);
        console.log('✅ Viewed IDs:', result.viewed_ids);
      } else if (result && result.error) {
        toast(`❌ Backend Error: ${result.error}`);
        console.error('❌ BACKEND ERROR:', result);
        console.error('   Error code:', result.error_code);
        console.error('   Full response:', JSON.stringify(result, null, 2));
      } else {
        toast(`❌ Unexpected response format`);
        console.error('❌ UNEXPECTED RESPONSE:', JSON.stringify(result, null, 2));
      }
    } catch (err) {
      toast(`Exception: ${err.message}`);
      console.error('❌ EXCEPTION CAUGHT:', err);
      console.error('   Message:', err.message);
      console.error('   Stack:', err.stack);
    } finally {
      loading(false);
      console.log('========================================\n');
    }
  });
}

// Set up announcement modal event listeners using event delegation
console.log('[Announcements] Setting up modal event listeners...');

// Use document-level event delegation for buttons that might not exist yet
document.addEventListener('click', function(e) {
  // New Announcement button (robust: allow clicks from child elements)
  if (e.target && (e.target.id === 'btnNewAnnouncement' || e.target.closest && e.target.closest('#btnNewAnnouncement'))) {
    console.log('[Announcements] 🆕 New Announcement button clicked');
    e.preventDefault();
    e.stopPropagation();
    
    currentEditingAnnouncement = null;
    
    const modal = $("announcementModal");
    if (!modal) {
      console.error('[Announcements] ❌ Modal element not found!');
      toast("Error: Modal not found");
      return;
    }
    
    console.log('[Announcements] Setting form fields...');
    $("announcementModalTitle").textContent = "New Announcement";
    $("announcementTitleInput").value = "";
    $("announcementMessage").value = "";
    $("announcementType").value = "info";
    $("announcementPriority").value = "10";
    $("announcementVideoUrl").value = "";
    $("announcementExpires").value = "";
    $("announcementActive").checked = true;
    
    console.log('[Announcements] Opening modal...');
    console.log('[Announcements] Modal before:', modal.style.display);
    modal.style.display = "flex";
    console.log('[Announcements] Modal after:', modal.style.display);
    console.log('[Announcements] Modal computed:', window.getComputedStyle(modal).display);
    console.log('[Announcements] Modal visibility:', window.getComputedStyle(modal).visibility);
    console.log('[Announcements] Modal z-index:', window.getComputedStyle(modal).zIndex);
    // Focus the title input for immediate typing
    setTimeout(() => { 
      const t = $("announcementTitleInput"); 
      if (t) {
        t.focus();
        console.log('[Announcements] ✅ Title input focused');
      } else {
        console.error('[Announcements] ❌ Title input not found for focus');
      }
    }, 100);
    console.log('[Announcements] ✅ Modal opened');
    return;
  }
  
  // Close modal buttons
  if (e.target && (e.target.id === 'btnCloseAnnouncementModal' || e.target.id === 'btnCancelAnnouncement')) {
    console.log('[Announcements] Closing modal');
    const modal = $("announcementModal");
    if (modal) modal.style.display = "none";
    return;
  }
  // Close when clicking on overlay background
  if (e.target && e.target.id === 'announcementModal') {
    const modal = $("announcementModal");
    if (modal) modal.style.display = "none";
    return;
  }
  
  // Save announcement button
  if (e.target && (e.target.id === 'btnSaveAnnouncement' || (e.target.closest && e.target.closest('#btnSaveAnnouncement')))) {
    console.log('[Announcements] 💾 Save button clicked');
    e.preventDefault();
    e.stopPropagation();
    
    const title = $("announcementTitleInput").value.trim();
    if (!title) { 
      console.warn('[Announcements] ⚠️ Title is required');
      toast("Title required"); 
      return; 
    }
    
    // Capture all form field values
    const message = $("announcementMessage").value.trim() || '';
    const type = $("announcementType").value;
    const priority = parseInt($("announcementPriority").value) || 10;
    const video_url = $("announcementVideoUrl").value.trim() || '';
    const expires_raw = $("announcementExpires").value;
    const expires_at = expires_raw ? new Date(expires_raw).toISOString() : '';
    const is_active = $("announcementActive").checked ? 'true' : 'false';
    
    console.log('[Announcements] 📋 Form data captured:');
    console.log('  - Title:', title);
    console.log('  - Message:', message);
    console.log('  - Type:', type);
    console.log('  - Priority:', priority);
    console.log('  - Video URL:', video_url);
    console.log('  - Expires (raw):', expires_raw);
    console.log('  - Expires (ISO):', expires_at);
    console.log('  - Active:', is_active);
    
    const params = {
      title,
      message,
      type,
      priority,
      video_url,
      expires_at,
      is_active,
      created_by: adminToken || 'admin'
    };
    
    console.log('[Announcements] 📦 Params object:', JSON.stringify(params, null, 2));
    
    (async () => {
      try {
        let result;
        if (currentEditingAnnouncement) {
          params.announcement_id = currentEditingAnnouncement.announcement_id;
          console.log('[Announcements] 🔄 UPDATE mode - ID:', params.announcement_id);
          result = await GET("portal_announcements_update", params);
          console.log('[Announcements] 🔄 Update response:', result);
          toast(result.ok ? "Updated!" : (result.error || "Update failed"));
        } else {
          console.log('[Announcements] ➕ CREATE mode - new announcement');
          result = await GET("portal_announcements_create", params);
          console.log('[Announcements] ➕ Create response:', result);
          toast(result.ok ? "Created!" : (result.error || "Create failed"));
        }
        
        if (result.ok) {
          console.log('[Announcements] ✅ Success! Closing modal and reloading list...');
          $("announcementModal").style.display = "none";
          loadAnnouncements();
        } else {
          console.error('[Announcements] ❌ Failed:', result.error, result.error_code);
        }
      } catch (e) {
        console.error('[Announcements] ❌ Exception:', e);
        toast("Error: " + e.message);
      }
    })();
    return;
  }
});

// Close on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = $("announcementModal");
    if (modal && modal.style.display !== 'none') {
      modal.style.display = 'none';
    }
  }
});

console.log('[Announcements] ✅ Event delegation set up for all announcement buttons');

/* ===== ANNOUNCEMENTS MANAGEMENT (ADMIN) ===== */
let currentEditingAnnouncement = null;

async function loadAnnouncements() {
  const box = $("announcementsList");
  box.innerHTML = '<p class="muted">Loading...</p>';
  
  try {
    console.log('========================================');
    console.log('[Announcements] Loading announcements...');
    console.log('[Announcements] API:', API);
    console.log('[Announcements] Calling: portal_announcements_list');
    
    const result = await GET("portal_announcements_list", { admin: "true", token: adminToken });
    
    console.log('[Announcements] Response received:', result);
    console.log('[Announcements] Response type:', typeof result);
    console.log('[Announcements] Response keys:', result ? Object.keys(result) : 'null');
    
    if (!result) {
      throw new Error('No response from backend');
    }
    
    if (!result.ok) {
      console.error('[Announcements] Backend error:', result);
      throw new Error(result.error || 'Backend returned error');
    }
    
    console.log('[Announcements] Success! Found', (result.announcements || []).length, 'announcements');
    console.log('========================================\n');
    
    renderAnnouncements(result.announcements || []);
  } catch (err) {
    console.error('========================================');
    console.error('[Announcements] ERROR:', err);
    console.error('[Announcements] Error message:', err.message);
    console.error('[Announcements] Error stack:', err.stack);
    console.error('========================================\n');
    
    box.innerHTML = `
      <div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:16px;margin:16px 0">
        <p style="color:#ef4444;font-weight:bold;margin:0 0 8px 0">Error loading announcements</p>
        <p style="color:#94a3b8;font-size:14px;margin:0">${err.message}</p>
        <p style="color:#64748b;font-size:12px;margin:8px 0 0 0">Check browser console (F12) for details</p>
      </div>
    `;
  }
}

function renderAnnouncements(announcements) {
  const box = $("announcementsList");
  
  if (!announcements || announcements.length === 0) {
    box.innerHTML = `
      <div style="text-align:center;padding:60px 20px">
        <div style="font-size:64px;margin-bottom:16px;opacity:0.3"></div>
        <p style="color:#94a3b8;font-size:16px;margin:0">No announcements yet</p>
        <p style="color:#64748b;font-size:14px;margin:8px 0 0 0">Click "New Announcement" to create one</p>
      </div>
    `;
    return;
  }
  
  box.innerHTML = announcements.map(a => {
    const icons = {info:'i', update:'!', warning:'!', urgent:'!!'};
    const colors = {info:'#3b82f6', update:'#10b981', warning:'#f59e0b', urgent:'#ef4444'};
    const bgColors = {info:'rgba(59,130,246,0.08)', update:'rgba(16,185,129,0.08)', warning:'rgba(245,158,11,0.08)', urgent:'rgba(239,68,68,0.08)'};
    const icon = icons[a.type] || 'i';
    const color = colors[a.type] || '#3b82f6';
    const bgColor = bgColors[a.type] || 'rgba(59,130,246,0.08)';
    const createdDate = new Date(a.created_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
    
    return `
      <div style="background:${bgColor};border-left:4px solid ${color};border-radius:12px;padding:20px;margin-bottom:16px;border:1px solid ${color}20;transition:all 0.2s;position:relative" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)'" onmouseout="this.style.transform='';this.style.boxShadow=''">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
              <span style="font-size:28px;font-weight:bold;color:${color}">${icon}</span>
              <div>
                <h3 style="margin:0;font-size:18px;font-weight:700;color:#e0f2fe">${a.title}</h3>
                <div style="display:flex;gap:12px;align-items:center;margin-top:4px">
                  <span style="font-size:12px;color:#64748b">${createdDate}</span>
                  ${!a.is_active?'<span style="background:#ef4444;color:#fff;font-size:11px;padding:3px 10px;border-radius:6px;font-weight:600">Inactive</span>':''}
                </div>
              </div>
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button onclick="editAnnouncement('${a.announcement_id}')" style="background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:#60a5fa;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s" onmouseover="this.style.background='rgba(59,130,246,0.25)'" onmouseout="this.style.background='rgba(59,130,246,0.15)'">Edit</button>
            <button id="delete_${a.announcement_id}" onclick="deleteAnnouncement('${a.announcement_id}','${a.title.replace(/'/g,"\\'")}') "style="background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s" onmouseover="this.style.background='rgba(239,68,68,0.25)'" onmouseout="this.style.background='rgba(239,68,68,0.15)'">Delete</button>
          </div>
        </div>
        ${a.message?`<p style="margin:12px 0;color:#cbd5e1;font-size:15px;line-height:1.6;padding-left:40px">${a.message}</p>`:''}
        <div style="display:flex;gap:20px;font-size:13px;color:#64748b;margin-top:16px;padding-left:40px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05)">
          <span style="display:flex;align-items:center;gap:6px">Priority: <strong style="color:#94a3b8">${a.priority}</strong></span>
          <span style="display:flex;align-items:center;gap:6px">Expires: <strong style="color:#94a3b8">${a.expires_at?new Date(a.expires_at).toLocaleDateString():'Never'}</strong></span>
          ${a.video_url?'<span style="display:flex;align-items:center;gap:6px;color:#10b981"><strong>Video attached</strong></span>':''}
        </div>
      </div>
    `;
  }).join('');
}

async function editAnnouncement(id){
  try{
    const result = await GET("announcements_list", { admin: "true" });
    if (!result.ok || !result.announcements) throw new Error('Failed to fetch');
    
    const a = result.announcements.find(ann => ann.announcement_id === id);
    if (!a) throw new Error('Announcement not found');
    
    currentEditingAnnouncement=a;
  $("announcementModalTitle").textContent="Edit Announcement";
  $("announcementTitleInput").value=a.title||"";
    $("announcementMessage").value=a.message||"";
    $("announcementType").value=a.type||"info";
    $("announcementPriority").value=a.priority||10;
    $("announcementVideoUrl").value=a.video_url||"";
    $("announcementExpires").value=a.expires_at?new Date(a.expires_at).toISOString().slice(0,16):"";
    $("announcementActive").checked=a.is_active!==false;
    $("announcementModal").style.display="flex";
  }catch(e){toast("Error: "+e.message)}
}

async function deleteAnnouncement(id,title){
  // Custom styled confirmation dialog
  const confirmed = await customConfirm(
    'Delete Announcement',
    `<strong style="color:#f1f5f9;font-size:16px">"${title}"</strong><br><br>` +
    `This will <strong>permanently remove</strong> this announcement from the database.<br>` +
    `Pros will no longer see it.<br><br>` +
    `<span style="color:#94a3b8">This action cannot be undone.</span>`
  );
  
  if(!confirmed) return;
  
  // Show loading state on button
  const deleteBtn = document.getElementById('delete_' + id);
  if (deleteBtn) {
    deleteBtn.disabled = true;
    deleteBtn.textContent = 'Deleting...';
    deleteBtn.style.opacity = '0.5';
    deleteBtn.style.cursor = 'wait';
  }
  
  try{
    console.log('[Announcements] Deleting announcement:', id);
    const result = await GET("portal_announcements_delete", { announcement_id: id });
    
    console.log('[Announcements] Delete response:', result);
    
    if (result.ok) {
      // Show success toast
      const toastEl = document.createElement('div');
      toastEl.style.cssText = 'position:fixed;top:24px;right:24px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(16,185,129,0.4);z-index:99999;font-size:15px;font-weight:600;animation:slideInDown 0.3s ease';
      toastEl.textContent = '✓ Announcement deleted successfully';
      document.body.appendChild(toastEl);
      setTimeout(() => {
        toastEl.style.animation = 'slideOutUp 0.3s ease';
        setTimeout(() => document.body.removeChild(toastEl), 300);
      }, 3000);
      
      // Reload the list
      loadAnnouncements();
    } else {
      throw new Error(result.error || "Delete failed");
    }
  }catch(e){
    console.error('[Announcements] Delete error:', e);
    
    // Reset button state
    if (deleteBtn) {
      deleteBtn.disabled = false;
      deleteBtn.textContent = 'Delete';
      deleteBtn.style.opacity = '';
      deleteBtn.style.cursor = 'pointer';
    }
    
    // Show error toast
    const toastEl = document.createElement('div');
    toastEl.style.cssText = 'position:fixed;top:24px;right:24px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:16px 24px;border-radius:12px;box-shadow:0 8px 24px rgba(239,68,68,0.4);z-index:99999;font-size:15px;font-weight:600;animation:slideInDown 0.3s ease';
    toastEl.textContent = '❌ Delete failed: ' + e.message;
    document.body.appendChild(toastEl);
    setTimeout(() => {
      toastEl.style.animation = 'slideOutUp 0.3s ease';
      setTimeout(() => document.body.removeChild(toastEl), 300);
    }, 4000);
  }
}

// Make admin announcement functions globally accessible for inline onclick handlers
window.editAnnouncement = editAnnouncement;
window.deleteAnnouncement = deleteAnnouncement;

/**
 * Custom styled confirmation dialog
 * @param {string} title - Modal title
 * @param {string} message - Modal message
 * @param {string} confirmText - Text for confirm button (default: "Delete")
 * @returns {Promise<boolean>} - Resolves to true if confirmed, false if cancelled
 */
function customConfirm(title, message, confirmText = 'Delete') {
  return new Promise((resolve) => {
    const modal = $('confirmModal');
    const titleEl = $('confirmModalTitle');
    const messageEl = $('confirmModalMessage');
    const confirmBtn = $('confirmModalConfirm');
    const cancelBtn = $('confirmModalCancel');
    
    titleEl.textContent = title;
    messageEl.innerHTML = message;
    confirmBtn.textContent = confirmText;
    
    modal.style.display = 'flex';
    
    const cleanup = () => {
      modal.style.display = 'none';
      confirmBtn.onclick = null;
      cancelBtn.onclick = null;
    };
    
    confirmBtn.onclick = () => {
      cleanup();
      resolve(true);
    };
    
    cancelBtn.onclick = () => {
      cleanup();
      resolve(false);
    };
    
    // Also close on background click
    modal.onclick = (e) => {
      if (e.target === modal) {
        cleanup();
        resolve(false);
      }
    };
  });
}

// Make globally accessible
window.customConfirm = customConfirm;

/* ===== PRO-FACING ANNOUNCEMENTS ===== */
let proAnnouncementsCache = [];
let viewedAnnouncementIds = new Set();
let proAnnouncementsRefreshTimer = null;

async function loadProAnnouncements() {
  if (!me || !me.email) return;
  
  // 🚀 FAST LOAD: Check cache first (5-min TTL for announcements)
  const cached = getCache('announcements');
  if (cached && cached._timestamp && (Date.now() - cached._timestamp) < 5 * 60 * 1000) {
    console.log(`[Announcements] ⚡ Using cached data (age: ${Math.round((Date.now() - cached._timestamp)/1000)}s)`);
    proAnnouncementsCache = cached.announcements || [];
    viewedAnnouncementIds = new Set(cached.viewed_ids || []);
    updateAnnouncementBanner();
    updateCommunicationHub();
    return;
  }
  
  try {
    const result = await GET("portal_announcements_list", { token });
    
    if (!result.ok) throw new Error(result.error || 'Failed to load');
    
    proAnnouncementsCache = result.announcements || [];
    viewedAnnouncementIds = new Set(result.viewed_ids || []);
    
    // 🚀 CACHE IT: Store for 5 minutes
    setCache('announcements', {
      announcements: proAnnouncementsCache,
      viewed_ids: Array.from(viewedAnnouncementIds),
      _timestamp: Date.now()
    });
    
    updateAnnouncementBanner();
    updateCommunicationHub();
    
    // Auto-show urgent unread announcements (delayed so it doesn't block portal load)
    const urgentUnread = proAnnouncementsCache.filter(a => 
      a.type === 'urgent' && !viewedAnnouncementIds.has(a.announcement_id)
    );
    
    if (urgentUnread.length > 0) {
      setTimeout(() => openAnnouncementsModal(), 2000); // Delayed 2s to not block initial render
    }
  } catch (err) {
    console.error('⚠️ Error loading announcements (non-critical):', err);
    // Fallback UI - don't block portal
    const cultureSloganSection = $("cultureSloganSection");
    const activeAnnouncementsSection = $("activeAnnouncementsSection");
    if (cultureSloganSection) cultureSloganSection.style.display = "block";
    if (activeAnnouncementsSection) activeAnnouncementsSection.style.display = "none";
  }
}

function updateAnnouncementBanner() {
  // Legacy banner - may not exist on all views, so check first
  const banner = $("announcementBanner");
  if (!banner) {
    console.log('[Banner] Old announcement banner element not found (OK - using Communication Hub instead)');
    return; // Exit gracefully if banner doesn't exist
  }
  
  const badge = $("announcementBadge");
  const title = $("announcementTitle");
  const preview = $("announcementPreview");
  const icon = $("announcementIcon");
  
  const unreadCount = proAnnouncementsCache.filter(a => !viewedAnnouncementIds.has(a.announcement_id)).length;
  
  if (unreadCount > 0) {
    banner.style.display = "block";
    if (badge) badge.textContent = unreadCount;
    
    const urgentCount = proAnnouncementsCache.filter(a => 
      a.type === 'urgent' && !viewedAnnouncementIds.has(a.announcement_id)
    ).length;
    
    if (urgentCount > 0) {
      banner.style.background = "linear-gradient(135deg,rgba(239,68,68,0.15) 0%,rgba(220,38,38,0.1) 100%)";
      banner.style.borderColor = "rgba(239,68,68,0.4)";
      if (icon) {
        icon.textContent = "🚨";
        icon.style.background = "rgba(239,68,68,0.2)";
      }
      if (title) title.textContent = "Urgent Announcement" + (urgentCount > 1 ? "s" : "");
      if (preview) preview.textContent = "Important updates require your attention";
      if (badge) badge.style.background = "#ef4444";
    } else {
      banner.style.background = "linear-gradient(135deg,rgba(59,130,246,0.15) 0%,rgba(37,99,235,0.1) 100%)";
      banner.style.borderColor = "rgba(59,130,246,0.3)";
      if (icon) {
        icon.textContent = "📢";
        icon.style.background = "rgba(59,130,246,0.2)";
      }
      if (title) title.textContent = "New Announcement" + (unreadCount > 1 ? "s" : "");
      if (preview) preview.textContent = "Click to view updates from dispatch";
      if (badge) badge.style.background = "#3b82f6";
    }
  } else {
    banner.style.display = "none";
  }
}

function openAnnouncementsModal() {
  const modal = $("announcementsModal");
  const listBox = $("announcementsListPro");
  
  modal.style.display = "block";
  
  if (proAnnouncementsCache.length === 0) {
    listBox.innerHTML = '<p style="color:#64748b;text-align:center;padding:40px 0">No announcements at this time.</p>';
    return;
  }
  
  const icons = {info:'ℹ️', update:'📢', warning:'⚠️', urgent:'🚨'};
  const colors = {info:'#3b82f6', update:'#10b981', warning:'#f59e0b', urgent:'#ef4444'};
  
  listBox.innerHTML = proAnnouncementsCache.map(a => {
    const icon = icons[a.type] || 'ℹ️';
    const color = colors[a.type] || '#3b82f6';
    const isUnread = !viewedAnnouncementIds.has(a.announcement_id);
    const createdDate = new Date(a.created_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
    
    // Extract video embed (Loom or YouTube)
    let videoEmbed = '';
    if (a.video_url) {
      if (a.video_url.includes('loom.com')) {
        const loomId = a.video_url.match(/share\/([a-f0-9]+)/)?.[1];
        if (loomId) {
          videoEmbed = `<div style="position:relative;padding-bottom:56.25%;height:0;margin:16px 0"><iframe src="https://www.loom.com/embed/${loomId}" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:8px"></iframe></div>`;
        }
      } else if (a.video_url.includes('youtube.com') || a.video_url.includes('youtu.be')) {
        const ytId = a.video_url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\?]+)/)?.[1];
        if (ytId) {
          videoEmbed = `<div style="position:relative;padding-bottom:56.25%;height:0;margin:16px 0"><iframe src="https://www.youtube.com/embed/${ytId}" frameborder="0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;border-radius:8px"></iframe></div>`;
        }
      }
    }
    
    return `
      <div style="background:${isUnread?'rgba(59,130,246,0.08)':'rgba(255,255,255,0.03)'};border-left:4px solid ${color};border-radius:12px;padding:20px;margin-bottom:16px;${isUnread?'box-shadow:0 0 0 1px rgba(59,130,246,0.2)':''}">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
              <span style="font-size:24px">${icon}</span>
              <h3 style="margin:0;font-size:18px;font-weight:700;color:#e0f2fe">${a.title}</h3>
              ${isUnread?'<span style="background:#3b82f6;color:#fff;font-size:11px;padding:3px 8px;border-radius:4px;font-weight:600">NEW</span>':''}
            </div>
            <div style="font-size:12px;color:#64748b;margin-bottom:8px">${createdDate}${a.created_by?' • By '+a.created_by:''}</div>
          </div>
        </div>
        
        ${a.message?`<p style="margin:12px 0;color:#cbd5e1;font-size:15px;line-height:1.6">${a.message.replace(/\n/g,'<br>')}</p>`:''}
        
        ${videoEmbed}
        
        ${isUnread?`<button onclick="markAnnouncementAsViewed('${a.announcement_id}')" style="background:#3b82f6;border:none;color:#fff;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;margin-top:12px;transition:all 0.2s" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">Mark as Read</button>`:'<div style="color:#64748b;font-size:13px;margin-top:8px">✓ Read</div>'}
      </div>
    `;
  }).join('');
}

function closeAnnouncementsModal() {
  $("announcementsModal").style.display = "none";
}

// Make modal functions globally accessible for inline onclick handlers
window.closeAnnouncementsModal = closeAnnouncementsModal;
window.openAnnouncementsModal = openAnnouncementsModal;
window.markAnnouncementAsViewed = markAnnouncementAsViewed;

async function markAnnouncementAsViewed(announcementId) {
  if (!token) return;
  
  try {
    const result = await GET("portal_announcements_mark_viewed", { 
      token,
      announcement_id: announcementId
    });
    
    if (result.ok) {
      viewedAnnouncementIds.add(announcementId);
      updateAnnouncementBanner();
      updateCommunicationHub(); // Update the communication hub
      openAnnouncementsModal(); // Refresh the modal display
      
      // Show subtle success feedback
      const toastEl = document.createElement('div');
      toastEl.style.cssText = 'position:fixed;bottom:24px;right:24px;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:14px 20px;border-radius:12px;box-shadow:0 8px 24px rgba(16,185,129,0.4);z-index:99999;font-size:14px;font-weight:600;animation:slideInUp 0.3s ease';
      toastEl.textContent = '✓ Marked as read';
      document.body.appendChild(toastEl);
      setTimeout(() => {
        toastEl.style.animation = 'slideOutDown 0.3s ease';
        setTimeout(() => document.body.removeChild(toastEl), 300);
      }, 2000);
    }
  } catch (err) {
    console.error('Error marking as viewed:', err);
  }
}

/* ===== COMMUNICATION HUB (PRO DASHBOARD) ===== */

function updateCommunicationHub() {
  const cultureSloganSection = $("cultureSloganSection");
  const activeAnnouncementsSection = $("activeAnnouncementsSection");
  const announcementCardsContainer = $("announcementCardsContainer");
  const announcementCount = $("announcementCount");
  
  if (!cultureSloganSection || !activeAnnouncementsSection) return;
  
  // Filter active, non-expired announcements
  const now = new Date();
  const activeAnnouncements = proAnnouncementsCache.filter(a => 
    a.is_active && (!a.expires_at || new Date(a.expires_at) > now)
  );
  
  if (activeAnnouncements.length === 0) {
    cultureSloganSection.style.display = "block";
    activeAnnouncementsSection.style.display = "none";
  } else {
    cultureSloganSection.style.display = "none";
    activeAnnouncementsSection.style.display = "block";
    
    const unreadCount = activeAnnouncements.filter(a => !viewedAnnouncementIds.has(a.announcement_id)).length;
    
    announcementCount.textContent = unreadCount > 0 
      ? `${unreadCount} new message${unreadCount > 1 ? 's' : ''} from dispatch`
      : `${activeAnnouncements.length} active message${activeAnnouncements.length > 1 ? 's' : ''}`;
    
    // Render top 2 announcements
    announcementCardsContainer.innerHTML = activeAnnouncements.slice(0, 2).map(a => {
      const isUnread = !viewedAnnouncementIds.has(a.announcement_id);
      // Clean date format: "Nov 27" instead of verbose timestamp
      const createdDate = new Date(a.created_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
      
      const typeStyles = {
        info: { bg: 'rgba(59,130,246,0.12)', border: 'rgba(59,130,246,0.3)', icon: 'ℹ️', color: '#60a5fa', label: 'Info' },
        update: { bg: 'rgba(16,185,129,0.12)', border: 'rgba(16,185,129,0.3)', icon: '📢', color: '#34d399', label: 'Update' },
        warning: { bg: 'rgba(245,158,11,0.12)', border: 'rgba(245,158,11,0.3)', icon: '⚠️', color: '#fbbf24', label: 'Warning' },
        urgent: { bg: 'rgba(239,68,68,0.12)', border: 'rgba(239,68,68,0.3)', icon: '🚨', color: '#f87171', label: 'Urgent' }
      };
      
      const style = typeStyles[a.type] || typeStyles.info;
      
      // Extract video embed (optimized)
      let videoEmbed = '';
      if (a.video_url) {
        const loomMatch = a.video_url.match(/loom\.com\/share\/([a-f0-9]+)/);
        const ytMatch = a.video_url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&?]+)/);
        
        if (loomMatch) {
          videoEmbed = `<div style="margin-top:14px;border-radius:10px;overflow:hidden;aspect-ratio:16/9;background:#000"><iframe src="https://www.loom.com/embed/${loomMatch[1]}" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen style="width:100%;height:100%"></iframe></div>`;
        } else if (ytMatch) {
          videoEmbed = `<div style="margin-top:14px;border-radius:10px;overflow:hidden;aspect-ratio:16/9;background:#000"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen style="width:100%;height:100%"></iframe></div>`;
        }
      }
      
      return `<div onclick="openAnnouncementsModal()" style="background:${style.bg};border:1px solid ${style.border};border-radius:12px;padding:18px;position:relative;${isUnread ? 'box-shadow:0 0 0 2px rgba(59,130,246,0.15)' : ''};cursor:pointer;transition:all 0.2s" class="announcement-card" onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='';this.style.boxShadow='${isUnread ? '0 0 0 2px rgba(59,130,246,0.15)' : ''}'">
          ${isUnread ? `<div style="position:absolute;top:12px;right:12px;width:10px;height:10px;background:#3b82f6;border-radius:50%;box-shadow:0 0 8px rgba(59,130,246,0.6)" class="unread-dot"></div>` : ''}
          <div style="display:flex;align-items:start;justify-content:space-between;margin-bottom:10px">
            <div style="display:flex;align-items:center;gap:10px">
              <div style="font-size:24px" class="announcement-card-icon">${style.icon}</div>
              <div>
                <h4 style="margin:0;font-size:17px;font-weight:700;color:#f1f5f9;line-height:1.3" class="announcement-card-title">${a.title}</h4>
                <div style="display:flex;align-items:center;gap:8px;margin-top:4px;flex-wrap:wrap">
                  <span style="font-size:11px;font-weight:600;color:${style.color};text-transform:uppercase;letter-spacing:0.5px">${style.label}</span>
                  <span style="color:#64748b;font-size:12px">• ${createdDate}</span>
                  ${a.priority > 50 ? `<span style="background:rgba(239,68,68,0.15);color:#f87171;font-size:11px;font-weight:600;padding:2px 8px;border-radius:6px">Priority ${a.priority}</span>` : ''}
                </div>
              </div>
            </div>
          </div>
          ${a.message ? `<p style="margin:10px 0 0 0;color:#cbd5e1;font-size:14px;line-height:1.6" class="announcement-preview">${a.message.split('\n').slice(0, 3).join('<br>')}</p>` : ''}
          ${videoEmbed}
          <div style="margin-top:14px;display:flex;gap:10px;align-items:center" class="announcement-actions">
            ${isUnread ? `<button onclick="event.stopPropagation();markAnnouncementAsViewed('${a.announcement_id}')" style="background:${style.color};border:none;color:#0f172a;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Mark as Read</button>` : `<span style="color:#64748b;font-size:13px">✓ Read</span>`}
            ${a.video_url ? `<a href="${a.video_url}" target="_blank" onclick="event.stopPropagation()" style="color:${style.color};font-size:13px;font-weight:600;text-decoration:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">Open Video →</a>` : ''}
          </div>
        </div>`;
    }).join('');
  }
}

/* ===== PAYOUT ACTIONS ===== */

// Instant Withdraw button handler
$("btnInstantWithdraw").addEventListener("click", async () => {
  const availableBalance = parseFloat($("available-balance").textContent.replace(/[$,]/g, '')) || 0;
  
  if (availableBalance <= 0) {
    toast("No funds available to withdraw");
    return;
  }
  
  // Show instant withdraw modal
  const fee = Math.max(0.99, availableBalance * 0.015); // $0.99 or 1.5%, whichever is higher
  const net = availableBalance - fee;
  
  const confirmed = confirm(
    `Instant Withdraw\n\n` +
    `Amount: $${availableBalance.toFixed(2)}\n` +
    `Instant Fee: $${fee.toFixed(2)} (1.5%)\n` +
    `You'll receive: $${net.toFixed(2)}\n\n` +
    `Funds will be deposited to your bank account within minutes.\n\n` +
    `Continue with instant withdrawal?`
  );
  
  if (!confirmed) return;
  
  try {
    loading(true);
    const out = await POST("portal_instant_withdraw", { token, amount: availableBalance });
    
    if (!out.ok) {
      toast(out.error || "Withdrawal failed");
      return;
    }
    
    toast(`✅ Instant withdrawal initiated! $${net.toFixed(2)} will arrive in minutes.`, 5000);
    
    // Refresh payouts to show updated balance
    clearCache('payouts');
    await loadPayouts();
    
  } catch (err) {
    console.error("Instant withdraw error:", err);
    toast(err.message || "Failed to process withdrawal");
  } finally {
    loading(false);
  }
});

// View History button handler
$("btnViewHistory").addEventListener("click", async () => {
  const modal = $("payoutHistoryModal");
  if (!modal) {
    toast("History modal not found");
    return;
  }
  
  modal.style.display = "grid";
  modal.setAttribute("aria-hidden", "false");
  document.body.style.overflow = "hidden";
  
  // Load payout and withdrawal history
  try {
    const [payoutsResult, withdrawalsResult] = await Promise.all([
      GET("portal_payouts", { token }),
      GET("portal_instant_withdrawals", { token })
    ]);
    
    const payouts = payoutsResult.ok ? (payoutsResult.rows || []) : [];
    const withdrawals = withdrawalsResult.ok ? (withdrawalsResult.rows || []) : [];
    
    // Combine and sort by date
    const allRecords = [
      ...payouts.map(p => ({
        type: 'payout',
        date: p.created_at || p.payout_date,
        amount: parseFloat(p.total_amount || 0),
        status: p.state || 'pending',
        description: `Payout for ${p.jobs_count || 0} job(s)`,
        id: p.payout_id
      })),
      ...withdrawals.map(w => ({
        type: 'withdrawal',
        date: w.requested_at || w.created_at,
        amount: parseFloat(w.net_amount || 0),
        status: w.status || 'pending',
        description: `Instant withdrawal`,
        fee: parseFloat(w.fee || 0),
        id: w.withdrawal_id
      }))
    ].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const historyList = $("historyList");
    
    if (allRecords.length === 0) {
      historyList.innerHTML = `
        <div style="text-align:center;padding:60px 20px;color:#94a3b8">
          <div style="font-size:48px;font-weight:300;margin-bottom:12px;opacity:.5;color:#3b82f6">$0</div>
          <div style="font-size:15px">No transaction history yet</div>
        </div>
      `;
    } else {
      historyList.innerHTML = allRecords.map(record => {
        const statusColors = {
          approved: '#10b981',
          completed: '#10b981',
          processing: '#f59e0b',
          pending: '#f59e0b',
          failed: '#ef4444',
          rejected: '#ef4444'
        };
        const statusColor = statusColors[record.status] || '#94a3b8';
        const date = new Date(record.date);
        
        return `
          <div style="background:linear-gradient(135deg,rgba(30,41,59,0.6),rgba(15,23,42,0.6));border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;margin-bottom:12px;transition:all 0.2s" onmouseover="this.style.borderColor='rgba(59,130,246,0.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)'">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
              <div>
                <div style="font-size:16px;font-weight:700;color:#e2e8f0;margin-bottom:4px">${record.description}</div>
                <div style="font-size:13px;color:#94a3b8">${date.toLocaleDateString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'})}</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:24px;font-weight:800;color:#e0f2fe">$${record.amount.toFixed(2)}</div>
                ${record.fee ? `<div style="font-size:12px;color:#94a3b8">Fee: $${record.fee.toFixed(2)}</div>` : ''}
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <div style="padding:6px 12px;background:${statusColor}22;border:1px solid ${statusColor}44;border-radius:8px;font-size:12px;font-weight:600;color:${statusColor};text-transform:uppercase;letter-spacing:0.5px">
                ${record.status}
              </div>
              <div style="padding:6px 12px;background:rgba(59,130,246,0.12);border:1px solid rgba(59,130,246,0.25);border-radius:8px;font-size:12px;font-weight:600;color:#60a5fa;text-transform:uppercase">
                ${record.type}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
  } catch(error) {
    console.error('Load history error:', error);
    $("historyList").innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:#ef4444">
        <div style="font-size:15px">Failed to load history</div>
      </div>
    `;
  }
});  // End of View History click handler

// Close history modal
$("btnCloseHistory").addEventListener("click", () => {
  const modal = $("payoutHistoryModal");
  if (modal) {
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
  }
});

// ============================
// ADDRESS AUTOCOMPLETE
// ============================
const adStreetInput = document.getElementById('adStreet');
const adStreetDropdown = document.getElementById('adStreetDropdown');
const adCityInput = document.getElementById('adCity');
const adStateInput = document.getElementById('adState');
const adZipInput = document.getElementById('adZip');

let adDebounceTimer;
let adSelectedIndex = -1;

if (adStreetInput && adStreetDropdown) {
  adStreetInput.addEventListener('input', (e) => {
    const input = e.target.value.trim();
    
    clearTimeout(adDebounceTimer);
    
    if (input.length < 3) {
      adStreetDropdown.style.display = 'none';
      adStreetDropdown.innerHTML = '';
      return;
    }
    
    adDebounceTimer = setTimeout(async () => {
      try {
        const response = await fetch(`/api/address_autocomplete?input=${encodeURIComponent(input)}`);
        const data = await response.json();
        
        if (data.ok && data.predictions && data.predictions.length > 0) {
          adSelectedIndex = -1;
          adStreetDropdown.innerHTML = data.predictions.map((prediction, idx) => `
            <div class="address-suggestion" data-index="${idx}" style="padding:12px 16px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.15s;color:#e2e8f0;font-size:14px" 
              onmouseover="this.style.background='rgba(59,130,246,0.15)'" 
              onmouseout="this.style.background='transparent'">
              ${escapeHTML(prediction.description)}
            </div>
          `).join('');
          adStreetDropdown.style.display = 'block';
          
          // Add click handlers
          adStreetDropdown.querySelectorAll('.address-suggestion').forEach((item, idx) => {
            item.addEventListener('click', () => {
              selectAdAddress(data.predictions[idx]);
            });
          });
        } else {
          adStreetDropdown.style.display = 'none';
        }
      } catch (error) {
        console.error('Address autocomplete error:', error);
        adStreetDropdown.style.display = 'none';
      }
    }, 300);
  });
  
  // Keyboard navigation
  adStreetInput.addEventListener('keydown', (e) => {
    if (!adStreetDropdown.style.display || adStreetDropdown.style.display === 'none') return;
    
    const suggestions = adStreetDropdown.querySelectorAll('.address-suggestion');
    if (suggestions.length === 0) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      adSelectedIndex = Math.min(adSelectedIndex + 1, suggestions.length - 1);
      updateAdSelection(suggestions);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      adSelectedIndex = Math.max(adSelectedIndex - 1, -1);
      updateAdSelection(suggestions);
    } else if (e.key === 'Escape') {
      adStreetDropdown.style.display = 'none';
      adSelectedIndex = -1;
    }
  });
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!adStreetInput.contains(e.target) && !adStreetDropdown.contains(e.target)) {
      adStreetDropdown.style.display = 'none';
      adSelectedIndex = -1;
    }
  });
}

function updateAdSelection(suggestions) {
  suggestions.forEach((item, idx) => {
    if (idx === adSelectedIndex) {
      item.style.background = 'rgba(59,130,246,0.25)';
      item.scrollIntoView({ block: 'nearest' });
    } else {
      item.style.background = 'transparent';
    }
  });
}

function selectAdAddress(prediction) {
  adStreetInput.value = prediction.description;
  
  // Auto-fill city, state, zip if available
  if (prediction.components) {
    const comp = prediction.components;
    
    // Build street address from components if available
    if (comp.street_number && comp.street) {
      adStreetInput.value = `${comp.street_number} ${comp.street}`;
    }
    
    if (comp.city && adCityInput) {
      adCityInput.value = comp.city;
    }
    if (comp.state && adStateInput) {
      adStateInput.value = comp.state;
    }
    if (comp.zip && adZipInput) {
      adZipInput.value = comp.zip;
    }
  }
  
  adStreetDropdown.style.display = 'none';
  adSelectedIndex = -1;
}

function escapeHTML(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// View History button handler (old - kept for compatibility)
/*
$("btnViewHistory").addEventListener("click", () => {
  // For now, just show a toast - you can expand this to show a modal with full history
  toast("Full withdrawal history coming soon! Check Recent Earnings below for now.");
});
*/

}); // End of DOMContentLoaded

</script>
<!-- Call Outcome Modal -->
<div id="callOutcomeModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="callOutcomeTitle">
  <div class="sheet" style="max-width: 400px;">
    <h3 id="callOutcomeTitle">Call Outcome</h3>
    <p id="callOutcomeText">How did the call go?</p>
    
    <div id="callOutcomeButtons" class="row" style="flex-direction: column; gap: 10px;">
      <button id="btnCallConfirmed" class="btn" type="button">Confirmed</button>
      <button id="btnCallVM" class="btn secondary" type="button">Left Voicemail</button>
      <button id="btnCallReschedule" class="btn secondary" type="button">Reschedule</button>
    </div>

    <div id="rescheduleForm" style="display:none; margin-top: 15px;">
      <label class="label" for="rescheduleDate">New Date</label>
      <input type="date" id="rescheduleDate" class="input" style="width:100%; padding: 10px; margin-bottom: 10px;">
      <label class="label" for="rescheduleTime">New Time</label>
      <input type="time" id="rescheduleTime" class="input" style="width:100%; padding: 10px; margin-bottom: 10px;">
      <button id="btnSubmitReschedule" class="btn" type="button" style="width:100%">Confirm Reschedule</button>
      <button id="btnCancelReschedule" class="btn ghost" type="button" style="width:100%; margin-top: 5px;">Back</button>
    </div>

    <div style="margin-top: 20px; text-align: center;">
      <button id="btnCallClose" class="btn ghost" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Customer Lead Nurturing Modal -->
<div id="customerCallOutcomeModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="customerCallTitle">
  <div class="sheet" style="max-width: 400px;">
    <h3 id="customerCallTitle">Lead Follow-up</h3>
    <p id="customerCallText">What happened with this lead?</p>
    
    <div id="customerCallButtons" class="row" style="flex-direction: column; gap: 10px;">
      <button id="btnCustContacted" class="btn" type="button" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%);border-color:#10b981">
        ✅ Contacted / Confirmed
      </button>
      <button id="btnCustVM" class="btn secondary" type="button">
        📼 Left Voicemail
      </button>
      <button id="btnCustNoAnswer" class="btn secondary" type="button">
        📵 No Answer
      </button>
      <button id="btnCustReschedule" class="btn secondary" type="button">
        📅 Reschedule
      </button>
    </div>

    <div id="custRescheduleForm" style="display:none; margin-top: 15px;">
      <!-- Calendar Widget (Adapted from Bundles) -->
      <p style="margin: 0 0 12px; color: #b8d9ff; font-size: 14px;">Pick a date and time window.</p>
      
      <div id="custRescheduleCalendar" style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); color: #0a2a5a;"></div>
      
      <div id="custTimeWindowSection" style="display:none; margin-bottom:16px;">
        <label style="display:block; font-weight:600; font-size:14px; margin-bottom:8px; color:#b8d9ff;">Select Time Window</label>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
          <button class="time-slot-btn" data-window="9:00 AM - 12:00 PM" type="button" style="padding:10px 4px; border:2px solid rgba(255,255,255,0.2); border-radius:8px; background:rgba(255,255,255,0.1); color:white; cursor:pointer; font-weight:600; font-size:13px; transition: all 0.2s;">9-12</button>
          <button class="time-slot-btn" data-window="12:00 PM - 3:00 PM" type="button" style="padding:10px 4px; border:2px solid rgba(255,255,255,0.2); border-radius:8px; background:rgba(255,255,255,0.1); color:white; cursor:pointer; font-weight:600; font-size:13px; transition: all 0.2s;">12-3</button>
          <button class="time-slot-btn" data-window="3:00 PM - 6:00 PM" type="button" style="padding:10px 4px; border:2px solid rgba(255,255,255,0.2); border-radius:8px; background:rgba(255,255,255,0.1); color:white; cursor:pointer; font-weight:600; font-size:13px; transition: all 0.2s;">3-6</button>
        </div>
      </div>

      <button id="btnCustSubmitReschedule" class="btn" type="button" style="width:100%; opacity:0.5; pointer-events:none;">Confirm Reschedule</button>
      <button id="btnCustCancelReschedule" class="btn ghost" type="button" style="width:100%; margin-top: 5px;">Back</button>
    </div>

    <div style="margin-top: 20px; text-align: center;">
      <button id="btnCustClose" class="btn ghost" type="button">Close</button>
    </div>
  </div>
</div>

<script>
let currentCustomerCallData = null;
let selectedRescheduleDate = null;
let selectedRescheduleWindow = null;

function renderRescheduleCalendar() {
  const cal = document.getElementById('custRescheduleCalendar');
  if(!cal) return;
  
  const now = new Date();
  const currentMonth = now.getMonth();
  const currentYear = now.getFullYear();
  
  const firstDay = new Date(currentYear, currentMonth, 1).getDay();
  const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
  const today = now.getDate();
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  
  let html = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <h4 style="margin:0; font-size:15px; font-weight:800; color:#0a2a5a;">${monthNames[currentMonth]} ${currentYear}</h4>
    </div>
    <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:2px; text-align:center;">
      <div style="font-size:11px; font-weight:700; color:#64748b; padding:4px 0;">Su</div>
      <div style="font-size:11px; font-weight:700; color:#64748b; padding:4px 0;">Mo</div>
      <div style="font-size:11px; font-weight:700; color:#64748b; padding:4px 0;">Tu</div>
      <div style="font-size:11px; font-weight:700; color:#64748b; padding:4px 0;">We</div>
      <div style="font-size:11px; font-weight:700; color:#64748b; padding:4px 0;">Th</div>
      <div style="font-size:11px; font-weight:700; color:#64748b; padding:4px 0;">Fr</div>
      <div style="font-size:11px; font-weight:700; color:#64748b; padding:4px 0;">Sa</div>
  `;
  
  // Empty cells before first day
  for(let i = 0; i < firstDay; i++) {
    html += `<div></div>`;
  }
  
  // Days of month
  for(let day = 1; day <= daysInMonth; day++) {
    const isPast = day < today;
    const isToday = day === today;
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    
    if(isPast) {
      html += `<div style="padding:8px; color:#cbd5e1; font-size:13px;">${day}</div>`;
    } else {
      const style = isToday 
        ? 'padding:8px; border:2px solid #0a2a5a; border-radius:6px; cursor:pointer; font-weight:700; font-size:13px; color:#0a2a5a;'
        : 'padding:8px; border:2px solid transparent; border-radius:6px; cursor:pointer; font-size:13px; color:#334155;';
      html += `<div class="cal-day-resched" data-date="${dateStr}" style="${style}" onmouseover="if(!this.classList.contains('selected')) this.style.background='#f1f5f9'" onmouseout="if(!this.classList.contains('selected')) this.style.background='transparent'">${day}</div>`;
    }
  }
  
  html += `</div>`;
  cal.innerHTML = html;
  
  // Click handlers
  cal.querySelectorAll('.cal-day-resched').forEach(dayEl => {
    dayEl.onclick = () => {
      selectedRescheduleDate = dayEl.getAttribute('data-date');
      
      // Reset styles
      cal.querySelectorAll('.cal-day-resched').forEach(d => {
        d.classList.remove('selected');
        d.style.background = 'transparent';
        d.style.color = d.textContent == today ? '#0a2a5a' : '#334155';
        d.style.borderColor = d.textContent == today ? '#0a2a5a' : 'transparent';
      });
      
      // Set active style
      dayEl.classList.add('selected');
      dayEl.style.background = '#3b82f6';
      dayEl.style.color = 'white';
      dayEl.style.borderColor = '#3b82f6';
      
      // Show time window
      document.getElementById('custTimeWindowSection').style.display = 'block';
      
      // Reset time selection
      selectedRescheduleWindow = null;
      document.querySelectorAll('.time-slot-btn').forEach(b => {
        b.style.borderColor = 'rgba(255,255,255,0.2)';
        b.style.background = 'rgba(255,255,255,0.1)';
      });
      
      // Disable submit
      const btn = document.getElementById('btnCustSubmitReschedule');
      btn.style.opacity = '0.5';
      btn.style.pointerEvents = 'none';
    };
  });
}

function handleCustomerRescheduleClick(e, orderId, name) {
  e.preventDefault();
  e.stopPropagation();
  
  currentCustomerCallData = { orderId, name, phone: '' };
  
  const modal = document.getElementById("customerCallOutcomeModal");
  if (modal) {
    modal.style.display = "grid";
    modal.setAttribute("aria-hidden", "false");
    
    // Show reschedule form directly
    document.getElementById("customerCallButtons").style.display = "none";
    document.getElementById("custRescheduleForm").style.display = "block";
    document.getElementById("customerCallText").textContent = `Reschedule ${name || 'Customer'}`;
    
    renderRescheduleCalendar();
  }
}

function handleCustomerCallClick(e, orderId, phone, name) {
  e.preventDefault();
  e.stopPropagation();
  
  if (!phone) {
    toast("No phone number available");
    return;
  }
  
  currentCustomerCallData = { orderId, phone, name };
  
  // Open phone dialer
  window.location.href = `tel:${phone}`;
  
  // Show outcome modal after a short delay
  setTimeout(() => {
    const modal = document.getElementById("customerCallOutcomeModal");
    if (modal) {
      modal.style.display = "grid";
      modal.setAttribute("aria-hidden", "false");
      
      // Reset view
      document.getElementById("customerCallButtons").style.display = "flex";
      document.getElementById("custRescheduleForm").style.display = "none";
      document.getElementById("customerCallText").textContent = `What happened with ${name || 'this customer'}?`;
    }
  }, 1000);
}

document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("customerCallOutcomeModal");
  const closeBtn = document.getElementById("btnCustClose");
  
  const contactedBtn = document.getElementById("btnCustContacted");
  const vmBtn = document.getElementById("btnCustVM");
  const noAnswerBtn = document.getElementById("btnCustNoAnswer");
  const rescheduleBtn = document.getElementById("btnCustReschedule");
  
  const submitRescheduleBtn = document.getElementById("btnCustSubmitReschedule");
  const cancelRescheduleBtn = document.getElementById("btnCustCancelReschedule");
  
  if (closeBtn) closeBtn.onclick = closeCustomerCallModal;
  
  if (contactedBtn) contactedBtn.onclick = async () => {
    if (!currentCustomerCallData) return;
    await submitCallLog(currentCustomerCallData.orderId, currentCustomerCallData.phone, null, currentCustomerCallData.name, 'completed');
    closeCustomerCallModal();
  };
  
  if (vmBtn) vmBtn.onclick = async () => {
    if (!currentCustomerCallData) return;
    await submitCallLog(currentCustomerCallData.orderId, currentCustomerCallData.phone, null, currentCustomerCallData.name, 'voicemail');
    closeCustomerCallModal();
  };
  
  if (noAnswerBtn) noAnswerBtn.onclick = async () => {
    if (!currentCustomerCallData) return;
    await submitCallLog(currentCustomerCallData.orderId, currentCustomerCallData.phone, null, currentCustomerCallData.name, 'no_answer');
    closeCustomerCallModal();
  };
  
  if (rescheduleBtn) rescheduleBtn.onclick = () => {
    document.getElementById("customerCallButtons").style.display = "none";
    document.getElementById("custRescheduleForm").style.display = "block";
    document.getElementById("customerCallText").textContent = "Select new time";
    
    // Render calendar
    renderRescheduleCalendar();
  };
  
  // Time slot handlers
  document.querySelectorAll('.time-slot-btn').forEach(btn => {
    btn.onclick = () => {
      selectedRescheduleWindow = btn.getAttribute('data-window');
      
      // Reset all buttons
      document.querySelectorAll('.time-slot-btn').forEach(b => {
        b.style.borderColor = 'rgba(255,255,255,0.2)';
        b.style.background = 'rgba(255,255,255,0.1)';
      });
      
      // Highlight selected
      btn.style.borderColor = '#3b82f6';
      btn.style.background = '#3b82f6';
      
      // Enable submit
      const submitBtn = document.getElementById('btnCustSubmitReschedule');
      submitBtn.style.opacity = '1';
      submitBtn.style.pointerEvents = 'auto';
    };
  });
  
  if (cancelRescheduleBtn) cancelRescheduleBtn.onclick = () => {
    document.getElementById("customerCallButtons").style.display = "flex";
    document.getElementById("custRescheduleForm").style.display = "none";
    document.getElementById("customerCallText").textContent = `What happened with ${currentCustomerCallData?.name || 'this customer'}?`;
    
    // Reset selection
    selectedRescheduleDate = null;
    selectedRescheduleWindow = null;
  };
  
  if (submitRescheduleBtn) submitRescheduleBtn.onclick = async () => {
    if (!selectedRescheduleDate || !selectedRescheduleWindow) {
      toast("Please select date and time");
      return;
    }
    
    if (!currentCustomerCallData) return;
    
    loading(true);
    try {
      // 1. Call the Reschedule API
      const response = await fetch(`${API}/reschedule-appointment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          order_id: currentCustomerCallData.orderId,
          delivery_date: selectedRescheduleDate,
          delivery_time: selectedRescheduleWindow,
          reason: 'Rescheduled by Pro via Portal'
        })
      });
      
      const result = await response.json();
      if (!result.ok) throw new Error(result.error || 'Reschedule failed');

      // 2. Log the call outcome
      await submitCallLog(
        currentCustomerCallData.orderId, 
        currentCustomerCallData.phone, 
        null, 
        currentCustomerCallData.name, 
        'rescheduled', 
        `Rescheduled to ${selectedRescheduleDate} ${selectedRescheduleWindow}`
      );
      
      toast("✅ Appointment rescheduled successfully");
      closeCustomerCallModal();
      
      // Reload to show changes
      setTimeout(() => loadCustomers(), 1000);
      
    } catch (err) {
      console.error(err);
      toast("Failed to reschedule: " + err.message);
    } finally {
      loading(false);
    }
  };
});

function closeCustomerCallModal() {
  const modal = document.getElementById("customerCallOutcomeModal");
  if (modal) {
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
  }
  currentCustomerCallData = null;
}

// Overload submitCallLog to handle direct calls
const originalSubmitCallLog = window.submitCallLog;
window.submitCallLog = async function(order_id, phone, email, name, outcomeOverride = null, notesOverride = null) {
  // If called from modal (no args), use DOM elements
  let outcome = outcomeOverride;
  let notes = notesOverride;
  let followUp = null;
  
  if (!outcome) {
    const outcomeEl = $('callOutcome');
    if (outcomeEl) outcome = outcomeEl.value;
  }
  
  if (!notes) {
    const notesEl = $('callNotes');
    if (notesEl) notes = notesEl.value;
  }
  
  if (!outcome) {
    toast('Please select a call outcome');
    return;
  }
  
  try {
    loading(true);
    // Close any open modals
    closeModal(); 
    
    const response = await fetch(`${API}/portal_log_call`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        customer_phone: phone,
        customer_email: email || null,
        customer_name: name || null,
        order_id: order_id,
        call_reason: 'appointment',
        call_outcome: outcome,
        notes: notes || null,
        follow_up_date: followUp || null
      })
    });
    
    const result = await response.json();
    
    if (!result.ok) {
      toast(result.error || 'Failed to log call');
      return;
    }
    
    toast('✅ Call logged successfully');
    
    // Reload customers list to show updated status
    setTimeout(() => loadCustomers(), 500);
    
  } catch(e) {
    console.error('[CallLog] Error:', e);
    toast(e.message || 'Failed to log call');
  } finally {
    loading(false);
  }
};
</script>

<script>
let currentCallJobId = null;

function handleCallClick(e, jobId, phone) {
  e.preventDefault();
  e.stopPropagation();
  
  if (!phone) {
    toast("No phone number available");
    return;
  }
  
  currentCallJobId = jobId;
  
  // Open phone dialer
  window.location.href = `tel:${phone}`;
  
  // Show outcome modal after a short delay
  setTimeout(() => {
    const modal = document.getElementById("callOutcomeModal");
    if (modal) {
      modal.style.display = "grid";
      modal.setAttribute("aria-hidden", "false");
      
      // Reset view
      document.getElementById("callOutcomeButtons").style.display = "flex";
      document.getElementById("rescheduleForm").style.display = "none";
      document.getElementById("callOutcomeText").textContent = "How did the call go?";
    }
  }, 1000);
}

document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("callOutcomeModal");
  const closeBtn = document.getElementById("btnCallClose");
  const confirmBtn = document.getElementById("btnCallConfirmed");
  const vmBtn = document.getElementById("btnCallVM");
  const rescheduleBtn = document.getElementById("btnCallReschedule");
  const submitRescheduleBtn = document.getElementById("btnSubmitReschedule");
  const cancelRescheduleBtn = document.getElementById("btnCancelReschedule");
  
  if (closeBtn) closeBtn.onclick = closeCallModal;
  
  if (confirmBtn) confirmBtn.onclick = async () => {
    if (!currentCallJobId) return;
    await logCallOutcome(currentCallJobId, "confirmed");
    closeCallModal();
  };
  
  if (vmBtn) vmBtn.onclick = async () => {
    if (!currentCallJobId) return;
    await logCallOutcome(currentCallJobId, "voicemail");
    closeCallModal();
  };
  
  if (rescheduleBtn) rescheduleBtn.onclick = () => {
    document.getElementById("callOutcomeButtons").style.display = "none";
    document.getElementById("rescheduleForm").style.display = "block";
    document.getElementById("callOutcomeText").textContent = "Select new time";
  };
  
  if (cancelRescheduleBtn) cancelRescheduleBtn.onclick = () => {
    document.getElementById("callOutcomeButtons").style.display = "flex";
    document.getElementById("rescheduleForm").style.display = "none";
    document.getElementById("callOutcomeText").textContent = "How did the call go?";
  };
  
  if (submitRescheduleBtn) submitRescheduleBtn.onclick = async () => {
    const date = document.getElementById("rescheduleDate").value;
    const time = document.getElementById("rescheduleTime").value;
    
    if (!date || !time) {
      toast("Please select date and time");
      return;
    }
    
    if (!currentCallJobId) return;
    
    loading(true);
    try {
      console.log(`Rescheduling job ${currentCallJobId} to ${date} ${time}`);
      // TODO: Implement actual backend call
      toast(`Reschedule requested for ${date} at ${time}`);
      closeCallModal();
      setTimeout(() => loadJobs(), 1000);
    } catch (err) {
      console.error(err);
      toast("Failed to reschedule");
    } finally {
      loading(false);
    }
  };
});

function closeCallModal() {
  const modal = document.getElementById("callOutcomeModal");
  if (modal) {
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
  }
  currentCallJobId = null;
}

async function logCallOutcome(jobId, outcome) {
  loading(true);
  try {
    console.log(`Logging call outcome for ${jobId}: ${outcome}`);
    // TODO: Implement actual backend call
    await new Promise(r => setTimeout(r, 500));
    toast(`Call logged: ${outcome}`);
  } catch (err) {
    console.error(err);
    toast("Failed to log call");
  } finally {
    loading(false);
  }
}
</script>
</body>
</html>


