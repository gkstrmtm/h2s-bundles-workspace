<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch Command Center - Home2Smart</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ========================= BASE STYLES ========================= */
:root {
    /* Brand Colors */
    --brand-cobalt: #0A2A5A;
    --brand-azure: #1493FF;
    --brand-green: #22C96F;
    --brand-gold: #FFC857;
    
    /* UI Colors */
    --bg-dark: #0f172a;
    --bg-card: #1e293b;
    --bg-hover: #334155;
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --border: #334155;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

/* Custom Scrollbars */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(15, 23, 42, 0.4);
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, rgba(20, 147, 255, 0.6), rgba(34, 201, 111, 0.6));
    border-radius: 10px;
    transition: all 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, rgba(20, 147, 255, 0.8), rgba(34, 201, 111, 0.8));
}

html, body {
    margin: 0;
    padding: 0;
    background: #0f172a;
    width: 100%;
    height: 100%;
    scroll-behavior: smooth;
}

body {
    font-family: 'Inter', sans-serif;
    color: #f8fafc;
}

/* GHL-SAFE ROOT WRAPPER */
.h2s-dispatch-root {
    display: flex;
    flex-direction: row;
    width: 100vw;
    min-height: 100vh;
    height: 100vh;
    background: #0f172a;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden;
}

/* ========================= LOGIN OVERLAY ========================= */
#login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-dark);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.login-box {
    background: var(--bg-card);
    padding: 40px;
    border-radius: 16px;
    border: 1px solid var(--border);
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

.login-input {
    width: 100%;
    padding: 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: #fff;
    margin-bottom: 16px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}

.login-input:focus {
    border-color: var(--brand-azure);
}

.login-btn {
    width: 100%;
    padding: 12px;
    background: var(--brand-azure);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.login-btn:hover {
    background: #0077e6;
}

.login-error {
    color: #ef4444;
    font-size: 13px;
    margin-top: 12px;
    text-align: center;
    display: none;
}

/* ========================= SIDEBAR ========================= */
.h2s-dispatch-root .sidebar {
    width: 260px;
    min-height: 100vh;
    height: 100%;
    background: #0A2A5A;
    border-right: 1px solid #334155;
    display: flex;
    flex-direction: column;
    padding: 20px;
    flex-shrink: 0;
    overflow-y: auto;
    position: relative;
}

.logo-container {
    margin-bottom: 40px;
    padding: 0 10px;
}

.logo-img {
    height: 32px;
    width: auto;
    display: block;
}

.h2s-dispatch-root .nav-menu {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex: 1;
}

.h2s-dispatch-root .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border-radius: 8px;
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    font-weight: 500;
    font-size: 15px;
    transition: all 0.2s;
    cursor: pointer;
    white-space: nowrap;
}

.h2s-dispatch-root .nav-item:hover {
    background: rgba(255,255,255,0.1);
    color: #fff;
}

.h2s-dispatch-root .nav-item.active {
    background: #1493FF;
    color: #fff;
    box-shadow: 0 4px 12px rgba(20, 147, 255, 0.3);
}

.h2s-dispatch-root .nav-icon {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
    opacity: 0.8;
}

/* ========================= MAIN CONTENT ========================= */
.h2s-dispatch-root .main-content {
    flex: 1;
    min-height: 100vh;
    height: 100%;
    overflow-y: auto;
    padding: 30px;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    position: relative;
    width: 100%;
}

@media (max-width: 768px) {
    .main-content {
        padding: 16px;
    }
    
    .sidebar {
        position: fixed;
        left: -260px;
        top: 0;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
    }
    
    .sidebar.mobile-open {
        left: 0;
    }
    
    body {
        flex-direction: column;
    }
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 16px;
}

@media (max-width: 640px) {
    .page-header {
        margin-bottom: 20px;
    }
}

.page-title {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
}

@media (max-width: 640px) {
    .page-title {
        font-size: 20px;
    }
}

/* ========================= CARDS & METRICS ========================= */
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

@media (max-width: 640px) {
    .metrics-grid {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-bottom: 20px;
    }
}

.metric-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.8) 100%);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    padding: 20px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.metric-card:hover {
    border-color: rgba(20, 147, 255, 0.4);
    box-shadow: 0 8px 24px rgba(20, 147, 255, 0.15);
    transform: translateY(-2px);
}

@media (max-width: 640px) {
    .metric-card {
        padding: 16px;
    }
}

.metric-label {
    font-size: 13px;
    color: #94a3b8;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
}

.metric-value {
    font-size: 28px;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

@media (max-width: 640px) {
    .metric-value {
        font-size: 24px;
    }
}

.metric-trend {
    font-size: 13px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.trend-up { color: var(--brand-green); }
.trend-down { color: var(--brand-gold); }

/* AI Analysis Card */
.ai-card {
    background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
    border: 1px solid var(--brand-azure);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
}

.ai-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--brand-azure), var(--brand-green));
}

.ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.ai-title {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ai-content {
    font-size: 14px;
    line-height: 1.6;
    color: #cbd5e1;
    white-space: pre-line;
}

/* ========================= JOBS GRID ========================= */
.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

@media (max-width: 768px) {
    .jobs-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
}

.job-card {
    background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(51, 65, 85, 0.9) 100%);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
    backdrop-filter: blur(10px);
}

@media (max-width: 640px) {
    .job-card {
        padding: 16px;
    }
}

.job-card:hover {
    transform: translateY(-4px);
    border-color: rgba(20, 147, 255, 0.5);
    box-shadow: 0 8px 24px rgba(20, 147, 255, 0.2);
}

@media (hover: none) {
    .job-card:hover {
        transform: none;
    }
    .job-card:active {
        transform: scale(0.98);
    }
}

.job-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}

.job-id {
    font-family: monospace;
    font-size: 12px;
    color: var(--brand-azure);
    background: rgba(20, 147, 255, 0.1);
    padding: 4px 8px;
    border-radius: 6px;
}

.job-status {
    font-size: 11px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 6px;
    text-transform: uppercase;
}

.status-new { background: rgba(20, 147, 255, 0.2); color: #60a5fa; }
.status-assigned { background: rgba(255, 200, 87, 0.2); color: #fbbf24; }
.status-completed { background: rgba(34, 201, 111, 0.2); color: #34d399; }

.job-title {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 8px;
    line-height: 1.4;
}

.job-meta {
    font-size: 13px;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.meta-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.meta-icon {
    width: 14px;
    height: 14px;
    opacity: 0.7;
}

.tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 12px;
}

.tag {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(255,255,255,0.1);
    color: var(--text-muted);
}

.tag.clarification {
    background: rgba(255, 200, 87, 0.2);
    color: var(--brand-gold);
    border: 1px solid rgba(255, 200, 87, 0.3);
}

/* ========================= MODAL ========================= */
.modal-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
}

.modal-overlay.active {
    opacity: 1;
    pointer-events: all;
}

.modal {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 16px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 30px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}

@media (max-width: 768px) {
    .modal {
        width: 100%;
        max-height: 100vh;
        border-radius: 0;
        padding: 20px;
    }
}

@media (max-width: 640px) {
    .modal {
        padding: 16px;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 24px;
    cursor: pointer;
}

.section-title {
    font-size: 14px;
    font-weight: 700;
    color: var(--brand-azure);
    text-transform: uppercase;
    margin-bottom: 12px;
    margin-top: 24px;
}

.info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.info-item label {
    display: block;
    font-size: 12px;
    color: var(--text-muted);
    margin-bottom: 4px;
}

.info-item div {
    font-size: 14px;
    color: #fff;
}

/* Purchasing Suggestions */
.suggestion-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.suggestion-check {
    margin-top: 4px;
    width: 18px;
    height: 18px;
    accent-color: var(--brand-azure);
    cursor: pointer;
}

.suggestion-content {
    flex: 1;
}

.suggestion-content h4 {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
    color: #fff;
}

.suggestion-content p {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 8px;
}

.brand-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.brand-tag {
    font-size: 11px;
    padding: 2px 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    color: #cbd5e1;
}

/* ========================= UTILS ========================= */
.hidden { display: none !important; }

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
}

@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}

.btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-primary { background: var(--brand-azure); color: #fff; }
.btn-primary:hover { background: #0077e6; }
.btn-ghost { background: rgba(255,255,255,0.1); color: #fff; }
.btn-ghost:hover { background: rgba(255,255,255,0.2); }
.btn-success { background: var(--brand-green); color: #fff; }
.btn-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

/* Icons */
.icon-sm { width: 16px; height: 16px; }
.icon-md { width: 20px; height: 20px; }

/* Pagination & Tabs */
.tabs-container {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    overflow-x: auto;
    padding-bottom: 4px;
}
.tab-btn {
    padding: 8px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid transparent;
    border-radius: 20px;
    color: var(--text-muted);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
}
.tab-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.tab-btn.active {
    background: rgba(20, 147, 255, 0.15);
    color: var(--brand-azure);
    border-color: rgba(20, 147, 255, 0.3);
}
.pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 16px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
}
.page-btn {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s;
}
.page-btn:hover:not(:disabled) {
    background: var(--brand-azure);
    color: #fff;
    border-color: var(--brand-azure);
}
.page-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

</style>
</head>
<body>
<div class="h2s-dispatch-root">

<!-- LOGIN OVERLAY -->
<div id="login-overlay">
    <div class="login-box">
        <div style="text-align:center; margin-bottom:24px">
            <h2 style="font-size:24px; font-weight:700; margin-bottom:8px">Dispatch Login</h2>
            <p style="color:var(--text-muted); font-size:14px">Enter your credentials to access the command center</p>
        </div>
        <input type="email" id="login-email" class="login-input" placeholder="Email Address" value="dispatch@h2s.com">
        <input type="password" id="login-password" class="login-input" placeholder="Password">
        <button class="login-btn" onclick="attemptLogin()">Login</button>
        <div id="login-error" class="login-error">Invalid credentials. Please try again.</div>
    </div>
</div>

<!-- Connection Status Indicator -->
<div id="connection-status" style="position:fixed; top:20px; right:20px; z-index:9999; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:8px 16px; font-size:12px; display:flex; align-items:center; gap:8px; opacity:0; transition:opacity 0.3s">
    <div id="status-dot" style="width:8px; height:8px; border-radius:50%; background:var(--brand-green)"></div>
    <span id="status-text">Connected</span>
</div>

<!-- SIDEBAR -->
<div class="sidebar">
    <div class="logo-container">
        <img src="https://storage.googleapis.com/msgsndr/7Drmpw623JAkrfDKPdjG/media/68da0ce6f00445991d64a63f.png" alt="Home2Smart" class="logo-img">
    </div>
    
    <div class="nav-menu">
        <div class="nav-item active" onclick="switchView('dashboard', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Dashboard
        </div>
        <div class="nav-item" onclick="switchView('jobs', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            Jobs
        </div>
        <div class="nav-item" onclick="switchView('payouts', this)">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Payouts
        </div>
        <div class="nav-item" onclick="openSettings()" style="margin-top:auto">
            <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            Settings
        </div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">
    
    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard">
        <div class="page-header">
            <h1 class="page-title">Business Intelligence</h1>
            <div style="display:flex; gap:12px">
                <button class="btn btn-ghost" onclick="loadMetrics()">Refresh Data</button>
                <button class="btn btn-primary" onclick="generateAIReport()">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Generate AI Report
                </button>
            </div>
        </div>
        
        <div id="ai-report-container" class="hidden">
            <div class="ai-card">
                <div class="ai-header">
                    <div class="ai-title">
                        <svg class="icon-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        Executive Analysis
                    </div>
                    <span style="font-size:12px; color:var(--text-muted)">Generated just now</span>
                </div>
                <div id="ai-content" class="ai-content">
                    Loading analysis...
                </div>
            </div>
        </div>

        <div id="metrics-container">
            <div style="text-align:center; padding:40px; color:var(--text-muted)">Loading analytics...</div>
        </div>
        
        <!-- CHARTS SECTION -->
        <div id="charts-section" class="hidden" style="margin-top:30px">
            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:20px">
                <div class="metric-card">
                    <div class="metric-label">Revenue Trend (Last 30 Days)</div>
                    <canvas id="revenueChart" style="max-height:250px"></canvas>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Job Status Distribution</div>
                    <canvas id="jobStatusChart" style="max-height:250px"></canvas>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="metric-card">
                    <div class="metric-label">Capacity Utilization</div>
                    <canvas id="capacityChart" style="max-height:200px"></canvas>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Pricing Tier Breakdown</div>
                    <canvas id="pricingChart" style="max-height:200px"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- JOBS VIEW -->
    <div id="view-jobs" class="hidden">
        <div class="page-header">
            <h1 class="page-title">Dispatch Jobs</h1>
            <div style="display:flex; gap:12px">
                <button class="btn btn-primary" onclick="loadJobs()">Refresh List</button>
            </div>
        </div>
        
        <!-- Status Tabs -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <div class="tabs-container" id="job-tabs">
                <button class="tab-btn active" onclick="filterJobsByTab('all')">All Jobs</button>
                <button class="tab-btn" onclick="filterJobsByTab('pending')">Pending</button>
                <button class="tab-btn" onclick="filterJobsByTab('accepted')">Scheduled</button>
                <button class="tab-btn" onclick="filterJobsByTab('in_progress')">In Progress</button>
                <button class="tab-btn" onclick="filterJobsByTab('completed')">Completed</button>
                <button class="tab-btn" onclick="filterJobsByTab('cancelled')">Cancelled</button>
            </div>
            
            <div style="display:flex; align-items:center; gap:12px">
                <label style="font-size:13px; color:var(--text-muted)">Equipment:</label>
                <select id="equipment-status-filter" onchange="filterJobsByEquipmentStatus()" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:#fff; font-size:13px; cursor:pointer">
                    <option value="all">All</option>
                    <option value="needs_order">Needs Order</option>
                    <option value="ordered">Ordered</option>
                </select>
            </div>
        </div>
        
        <div id="jobs-grid" class="jobs-grid">
            <!-- Jobs injected here -->
        </div>

        <!-- Pagination Controls -->
        <div id="jobs-pagination" class="pagination-controls hidden">
            <button class="page-btn" id="prev-page" onclick="changePage(-1)">
                <svg style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <span id="page-info" style="color:var(--text-muted); font-size:14px; font-weight:500">Page 1 of 1</span>
            <button class="page-btn" id="next-page" onclick="changePage(1)">
                <svg style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
    </div>

    <!-- PAYOUTS VIEW - PAYOUT COCKPIT -->
    <div id="view-payouts" class="hidden">
        <div class="page-header">
            <h1 class="page-title">Payout Cockpit</h1>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap">
                <!-- Week Selector -->
                <div style="display:flex; align-items:center; gap:8px">
                    <label style="font-size:13px; color:var(--text-muted)">Week:</label>
                    <input type="week" id="payout-week-selector" onchange="loadPayouts()" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:#fff; font-size:14px">
                </div>
                <!-- Search -->
                <input type="text" id="payout-search" placeholder="Search pro name/email..." oninput="filterPayoutsTable()" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:#fff; font-size:14px; min-width:200px">
                <!-- Filters -->
                <select id="payout-filter" onchange="filterPayoutsTable()" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:#fff; font-size:14px">
                    <option value="all">All Pros</option>
                    <option value="active">Active Only</option>
                </select>
                <select id="payout-status-filter" onchange="filterPayoutsTable()" style="padding:8px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:#fff; font-size:14px">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="paid">Paid</option>
                </select>
                <button class="btn btn-primary" onclick="loadPayouts()">Refresh</button>
            </div>
        </div>
        
        <!-- Summary Cards -->
        <div class="metrics-grid" style="margin-bottom:30px">
            <div class="metric-card">
                <div class="metric-label">Total Pending</div>
                <div class="metric-value" id="payout-pending-amount" style="color:var(--brand-gold)">$0</div>
                <div class="metric-trend" id="payout-pending-count">0 pros</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Approved (Not Paid)</div>
                <div class="metric-value" id="payout-approved-amount" style="color:var(--brand-green)">$0</div>
                <div class="metric-trend" id="payout-approved-count">0 pros</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">This Week Total</div>
                <div class="metric-value" id="payout-week-total">$0</div>
                <div class="metric-trend" id="payout-week-pros">0 pros</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Jobs Completed</div>
                <div class="metric-value" id="payout-jobs-count">0</div>
                <div class="metric-trend" id="payout-bonuses-count">0 bonuses</div>
            </div>
        </div>

        <!-- Pending Approval Queue (Job-level) -->
        <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:12px; overflow:hidden; margin-bottom:20px">
            <div style="padding:20px; border-bottom:1px solid var(--border)">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap">
                    <div>
                        <h3 style="font-size:16px; font-weight:600; margin:0">Pending Payout Approvals</h3>
                        <div id="pending-approvals-meta" style="font-size:12px; color:var(--text-muted); margin-top:6px"></div>
                    </div>
                    <button class="btn btn-ghost" onclick="loadPayouts()" style="font-size:12px; padding:6px 12px">Refresh Queue</button>
                </div>
            </div>
            <div id="pending-approvals-container" style="overflow-x:auto">
                <div style="text-align:center; padding:24px; color:var(--text-muted)">Loading pending approvals...</div>
            </div>
        </div>
        
        <!-- Payouts Table - Grouped by Pro -->
        <div style="background:var(--bg-card); border:1px solid var(--border); border-radius:12px; overflow:hidden">
            <div style="padding:20px; border-bottom:1px solid var(--border)">
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <h3 style="font-size:16px; font-weight:600; margin:0">Pro Payouts</h3>
                    <div style="display:flex; gap:8px">
                        <button class="btn btn-ghost" onclick="sortPayouts('amount')" style="font-size:12px; padding:6px 12px">Sort: Highest Due</button>
                        <button class="btn btn-success" onclick="approveSelectedPayouts()" id="btn-approve-selected" style="font-size:12px; padding:6px 12px" disabled>Approve Selected</button>
                    </div>
                </div>
            </div>
            <div id="payouts-container" style="overflow-x:auto">
                <div style="text-align:center; padding:40px; color:var(--text-muted)">Loading payouts...</div>
            </div>
        </div>
    </div>

</div>

<!-- JOB DETAIL MODAL -->
<div id="job-modal" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <div>
                <h2 id="modal-title" style="font-size:20px; font-weight:700; color:#fff; margin-bottom:4px">Job Details</h2>
                <span id="modal-id" class="job-id">ID: 12345</span>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="info-grid">
            <div class="info-item">
                <label>Customer</label>
                <div id="modal-customer">John Doe</div>
            </div>
            <div class="info-item">
                <label>Location</label>
                <div id="modal-location">123 Main St, City</div>
                <a id="modal-map-link" href="#" target="_blank" style="font-size:11px; color:var(--brand-azure); text-decoration:none; display:inline-flex; align-items:center; gap:4px; margin-top:4px">
                    <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    View on Google Maps
                </a>
            </div>
            <div class="info-item">
                <label>Service</label>
                <div id="modal-service">TV Mounting</div>
            </div>
            <div class="info-item">
                <label>Date</label>
                <div id="modal-date">Oct 12, 2023</div>
            </div>
        </div>

        <div id="modal-metadata">
            <!-- Job metadata details injected here -->
        </div>

        <div id="modal-photos" style="margin-top:24px">
            <!-- Customer photos injected here -->
        </div>

        <div id="modal-tech-photos" style="margin-top:24px">
            <!-- Tech-uploaded photos injected here -->
        </div>

        <div id="suggestions-header" style="display:flex; justify-content:space-between; align-items:center; margin-top:24px; margin-bottom:12px">
            <div class="section-title" style="margin:0">Purchasing Suggestions</div>
            <button class="btn btn-ghost" style="padding:6px 12px; font-size:12px" onclick="copySelectedItems()">
                <svg class="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                Copy Selected
            </button>
        </div>
        
        <div id="modal-suggestions">
            <!-- Suggestions injected here -->
        </div>

        <div class="section-title">Actions</div>
        <div style="display:flex; gap:12px">
            <button class="btn btn-primary" onclick="openDispatchWorkflow()">Dispatch Job</button>
            <button class="btn btn-success" onclick="markJobComplete()">Mark Complete</button>
            <button class="btn btn-ghost">Edit Details</button>
        </div>
    </div>
</div>

<!-- DISPATCH WORKFLOW MODAL -->
<div id="dispatch-modal" class="modal-overlay">
    <div class="modal" style="max-width:500px">
        <div class="modal-header">
            <h2 style="font-size:18px; font-weight:700; color:#fff">Assign Pro</h2>
            <button class="modal-close" onclick="closeDispatchModal()">&times;</button>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">Select Pro</label>
            <select id="pro-select" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff">
                <option value="">Select a pro...</option>
                <option value="pro_1">Mike Johnson (5 stars)</option>
                <option value="pro_2">Sarah Connor (4.9 stars)</option>
                <option value="pro_3">Pro Team A (4.8 stars)</option>
            </select>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px">
            <button class="btn btn-ghost" onclick="closeDispatchModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmDispatch()">Confirm Assignment</button>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-modal" class="modal-overlay">
    <div class="modal" style="max-width:500px">
        <div class="modal-header">
            <h2 style="font-size:18px; font-weight:700; color:#fff">Dashboard Settings</h2>
            <button class="modal-close" onclick="closeSettings()">&times;</button>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">API Base URL</label>
            <input id="setting-api" type="text" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff; font-family:monospace" placeholder="https://h2s-backend.vercel.app/api">
            <p style="font-size:11px; color:var(--text-muted); margin-top:6px">Use full URL if running locally (e.g. https://.../api)</p>
        </div>
        <div style="margin-bottom:20px">
            <label style="display:block; color:var(--text-muted); margin-bottom:8px; font-size:13px">Admin Token</label>
            <input id="setting-token" type="password" style="width:100%; padding:12px; background:var(--bg-dark); border:1px solid var(--border); border-radius:8px; color:#fff; font-family:monospace">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:12px">
            <button class="btn btn-ghost" onclick="closeSettings()">Cancel</button>
            <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
        </div>
    </div>
</div>

<script>
    // DISPATCH_BUILD_ID: 2025-12-24
    window.__DISPATCH_BUILD_ID = '2025-12-24';
    console.log('[DISPATCH] Loaded build', window.__DISPATCH_BUILD_ID);
    // --- CONFIGURATION ---
    let API_BASE = localStorage.getItem('h2s_api_base') || 'https://h2s-backend.vercel.app/api';
    let ADMIN_TOKEN = localStorage.getItem('h2s_admin_token') || '';
    
    let currentJobs = [];
    let currentPayouts = []; // Store enriched payout data
    let currentJobId = null;
    let connectionStatus = 'online';
    
    // Pagination & Filtering State
    let currentPage = 1;
    let itemsPerPage = 12;
    let currentStatusFilter = 'all';
    
    // Performance optimization: Cache for job data and photos
    const jobCache = {
        data: new Map(),
        photos: new Map(),
        TTL: 5 * 60 * 1000, // 5 minutes
        
        set(key, value, type = 'data') {
            const cache = type === 'photos' ? this.photos : this.data;
            cache.set(key, {
                value,
                timestamp: Date.now()
            });
        },
        
        get(key, type = 'data') {
            const cache = type === 'photos' ? this.photos : this.data;
            const item = cache.get(key);
            if (!item) return null;
            
            // Check if expired
            if (Date.now() - item.timestamp > this.TTL) {
                cache.delete(key);
                return null;
            }
            
            return item.value;
        },
        
        clear() {
            this.data.clear();
            this.photos.clear();
        }
    };
    
    // Debounce utility for performance
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Connection health check
    async function checkConnection() {
        try {
            const res = await fetch(`${API_BASE}/admin_business_intelligence`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN }),
                signal: AbortSignal.timeout(5000)
            });
            connectionStatus = res.ok ? 'online' : 'degraded';
            return res.ok;
        } catch (err) {
            connectionStatus = 'offline';
            return false;
        }
    }

    // Retry wrapper for API calls
    async function fetchWithRetry(url, options, retries = 3) {
        console.log(`[FETCH] Calling: ${url}`);
        for (let i = 0; i < retries; i++) {
            try {
                const res = await fetch(url, {
                    ...options,
                    signal: AbortSignal.timeout(10000)
                });
                
                console.log(`[FETCH] ${url} - Status: ${res.status}`);
                
                if (res.ok) {
                    connectionStatus = 'online';
                    return res;
                }
                
                if (res.status === 404) {
                    console.error(`[FETCH] 404 Not Found: ${url}`);
                    throw new Error(`Endpoint not found: ${url.split('/api/')[1] || url}`);
                }
                
                if (res.status === 401) {
                    // Auth failure - don't retry
                    throw new Error('Authentication failed. Please check your token in Settings.');
                }
                
                // Server error - retry
                if (i < retries - 1) {
                    console.log(`[FETCH] Retry ${i + 1}/${retries} after error ${res.status}`);
                    await new Promise(r => setTimeout(r, 1000 * (i + 1)));
                    continue;
                }
                
                throw new Error(`Server returned ${res.status}`);
                
            } catch (err) {
                console.error(`[FETCH] Error on attempt ${i + 1}:`, err.message);
                if (i === retries - 1) throw err;
                connectionStatus = 'degraded';
                await new Promise(r => setTimeout(r, 1000 * (i + 1)));
            }
        }
    }

    function openSettings() {
        document.getElementById('settings-modal').classList.add('active');
        document.getElementById('setting-api').value = API_BASE;
        document.getElementById('setting-token').value = ADMIN_TOKEN;
    }

    function closeSettings() {
        document.getElementById('settings-modal').classList.remove('active');
    }

    function saveSettings() {
        const newApi = document.getElementById('setting-api').value;
        const newToken = document.getElementById('setting-token').value;
        
        if(newApi) {
            API_BASE = newApi;
            localStorage.setItem('h2s_api_base', newApi);
        }
        
        if(newToken) {
            ADMIN_TOKEN = newToken;
            localStorage.setItem('h2s_admin_token', newToken);
        }
        
        closeSettings();
        loadMetrics(); // Reload with new settings
        alert('Settings saved!');
    }

    // --- NAVIGATION ---
    function switchView(view, el) {
        document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
        if(el) el.classList.add('active');
        
        document.getElementById('view-dashboard').classList.add('hidden');
        document.getElementById('view-jobs').classList.add('hidden');
        document.getElementById('view-payouts').classList.add('hidden');
        
        document.getElementById(`view-${view}`).classList.remove('hidden');
        
        if (view === 'dashboard') loadMetrics();
        if (view === 'jobs') loadJobs();
        if (view === 'payouts') loadPayouts();
    }

    // --- DASHBOARD METRICS ---
    async function loadMetrics() {
        const container = document.getElementById('metrics-container');
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">Loading analytics...</div>';
        
        console.log('[LOAD METRICS] Starting API call...');
        console.log('[LOAD METRICS] API_BASE:', API_BASE);
        console.log('[LOAD METRICS] ADMIN_TOKEN:', ADMIN_TOKEN);
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_business_intelligence`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN })
            });
            
            console.log('[LOAD METRICS] Response status:', res.status);
            const data = await res.json();
            console.log('[LOAD METRICS] Data received:', data);
            
            if (data.error && data.error !== 'Partial data failure - showing safe defaults') {
                throw new Error(data.error);
            }
            
            console.log('[LOAD METRICS] Rendering metrics...');
            renderMetrics(data);
            console.log('[LOAD METRICS] Rendering charts...');
            renderCharts(data);
            
            // Show warning if partial data
            if (data.error) {
                container.insertAdjacentHTML('afterbegin', 
                    '<div style="background:rgba(255,200,87,0.1); border:1px solid var(--brand-gold); padding:12px; border-radius:8px; margin-bottom:20px; font-size:13px">⚠️ Some data unavailable. Showing cached metrics.</div>'
                );
            }
            
            console.log('[LOAD METRICS] Complete!');
            
        } catch (err) {
            console.error('[LOAD METRICS] ERROR:', err);
            container.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Connection Error</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadMetrics()">Retry</button>
                    <button class="btn btn-ghost" onclick="openSettings()" style="margin-left:8px">Check Settings</button>
                </div>
            `;
        }
    }

    async function generateAIReport() {
        const container = document.getElementById('ai-report-container');
        const content = document.getElementById('ai-content');
        
        container.classList.remove('hidden');
        content.innerHTML = 'Analyzing data with AI...';
        
        try {
            const res = await fetch(`${API_BASE}/admin_business_intelligence?analyze=true`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN })
            });
            const data = await res.json();
            
            if (data.ai_analysis) {
                content.innerHTML = data.ai_analysis;
            } else {
                content.innerHTML = 'AI Analysis unavailable. Please check API configuration.';
            }
        } catch (err) {
            content.innerHTML = 'Error generating report.';
        }
    }

    function renderMetrics(data) {
        const container = document.getElementById('metrics-container');
        
        const revenue = data.revenue || {};
        const ops = data.operations || {};
        const growth = data.growth || {};
        
        container.innerHTML = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Revenue</div>
                    <div class="metric-value">$${(revenue.total || 0).toLocaleString()}</div>
                    <div class="metric-trend trend-up">
                        <span>Margin: ${revenue.margin}%</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Jobs Completed</div>
                    <div class="metric-value">${ops.jobs_completed || 0}</div>
                    <div class="metric-trend">
                        <span>${ops.completion_rate}% Completion Rate</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Pros</div>
                    <div class="metric-value">${data.workforce?.active_pros || 0}</div>
                    <div class="metric-trend">
                        <span>${data.workforce?.utilization_rate}% Utilization</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">MoM Growth</div>
                    <div class="metric-value">${growth.mom_growth}%</div>
                    <div class="metric-trend ${growth.mom_growth >= 0 ? 'trend-up' : 'trend-down'}">
                        <span>${growth.this_month_jobs} jobs this month</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Capacity</div>
                    <div class="metric-value">${data.capacity?.utilization_pct || 0}%</div>
                    <div class="metric-trend ${(data.capacity?.utilization_pct || 0) > 80 ? 'trend-down' : 'trend-up'}">
                        <span>${data.capacity?.current_load || 0} pending jobs</span>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Repeat Rate</div>
                    <div class="metric-value">${growth.repeat_rate || 0}%</div>
                    <div class="metric-trend">
                        <span>${growth.unique_customers || 0} unique customers</span>
                    </div>
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                <div class="metric-card">
                    <div class="metric-label">Top Cities</div>
                    <div style="margin-top:12px">
                        ${(data.geography?.top_cities || []).slice(0,5).map(c => `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(148,163,184,0.2)">
                                <div style="display:flex; flex-direction:column; gap:4px">
                                    <span style="font-weight:600; color:#fff; text-transform:capitalize">${c.name}</span>
                                    <span style="font-size:11px; color:var(--text-muted)">${c.jobs} jobs • ${c.margin}% margin</span>
                                </div>
                                <span style="font-weight:700; color:var(--brand-green)">$${c.revenue.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Pricing Tiers Performance</div>
                    <div style="margin-top:12px">
                        ${Object.entries(data.pricing || {}).map(([tier, stats]) => {
                            const marginColor = stats.margin >= 60 ? '#22C96F' : 
                                              stats.margin >= 40 ? '#FFC857' : '#ef4444';
                            const tierLabel = tier === 'byo' ? 'BYO (Customer Mount)' :
                                            tier === 'h2s' ? 'H2S Premium' : 'Base Package';
                            return `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid rgba(148,163,184,0.2); font-size:13px">
                                <div style="display:flex; flex-direction:column; gap:4px">
                                    <span style="text-transform:uppercase; color:var(--brand-azure); font-weight:600">${tierLabel}</span>
                                    <span style="font-size:11px; color:var(--text-muted)">${stats.jobs} jobs</span>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-weight:600; color:#fff">$${stats.revenue.toLocaleString()}</div>
                                    <div style="font-size:11px; color:${marginColor}; font-weight:600">${stats.margin}% margin</div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            </div>

            <style>
                @media (max-width: 768px) {
                    div[style*="grid-template-columns: 1fr 1fr"] {
                        grid-template-columns: 1fr !important;
                    }
                }
            </style>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px">
                <div class="metric-card">
                    <div class="metric-label">Top Services</div>
                    <div style="margin-top:12px">
                        ${(data.services?.top_services || []).slice(0,5).map(s => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border)">
                                <span style="font-size:13px">${s.name}</span>
                                <span style="font-weight:600">$${s.revenue.toLocaleString()}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No data</span>'}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Top Performers</div>
                    <div style="margin-top:12px">
                        ${(data.workforce?.top_performers || []).slice(0,5).map(p => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px">
                                <span>${p.name}</span>
                                <span style="color:var(--brand-green)">${p.jobs} jobs • $${p.earnings.toLocaleString()}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No data</span>'}
                    </div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px">
                <div class="metric-card">
                    <div class="metric-label">Understaffed Markets</div>
                    <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px">
                        ${(data.geography?.understaffed_cities || []).map(c => `
                            <span class="tag clarification">${c}</span>
                        `).join('') || '<span style="color:var(--text-muted)">None</span>'}
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Bottlenecks (>48h Pending)</div>
                    <div style="margin-top:12px">
                        ${(data.operations?.bottlenecks || []).slice(0,3).map(b => `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--border); font-size:13px">
                                <span style="color:var(--brand-gold)">${b.job_id}</span>
                                <span>${b.hours_pending}h • ${b.status}</span>
                            </div>
                        `).join('') || '<span style="color:var(--text-muted)">No bottlenecks detected</span>'}
                    </div>
                </div>
            </div>
        `;
    }

    // --- JOBS LOGIC ---
    
    // Helper: Build service description from items
    const buildServiceDescription = (itemsInput) => {
        let items = itemsInput;
        if (typeof items === 'string') {
            try { items = JSON.parse(items); } catch (e) { return null; }
        }
        if (!items || !Array.isArray(items) || items.length === 0) return null;
        
        const descriptions = [];
        items.forEach(item => {
            if (!item || item.type === 'product') return; // Skip hardware items
            const meta = item.metadata || {};
            const bundleId = (item.bundle_id || item.service_name || item.service_id || '').toLowerCase();
            let desc = '';
            
            // TV MOUNTING
            if (bundleId.includes('tv_multi') || bundleId === 'tv_multi') {
                const tvCount = meta.mounts_needed || meta.tv_count || item.qty || 1;
                const tvSize = meta.tv_size || '';
                const sizeText = tvSize ? tvSize.replace('-', '"-') + '"' : '';
                const mountSource = meta.mount_provider === 'customer' ? 'BYO Mount' : 'H2S Mount';
                desc = `${tvCount}x ${sizeText} TV Installation (${mountSource})`.trim();
            } else if (bundleId.includes('tv_single') || bundleId === 'tv_single') {
                const tvSize = meta.tv_size || '';
                const sizeText = tvSize ? tvSize.replace('-', '"-') + '"' : '';
                const mountSource = meta.mount_provider === 'customer' ? 'BYO' : 'H2S Mount';
                desc = `${sizeText} TV Mount (${mountSource})`.trim();
            } else if (bundleId.includes('tv')) {
                const tvCount = meta.mounts_needed || item.qty || 1;
                desc = `${tvCount}x TV Mount Installation`;
            }
            
            // SECURITY CAMERAS
            else if (bundleId === 'cam_premium' || bundleId.includes('premium')) {
                desc = 'Premium Security (8 Cameras)';
            } else if (bundleId === 'cam_standard' || bundleId.includes('standard')) {
                desc = 'Standard Security (4 Cameras)';
            } else if (bundleId === 'cam_basic' || bundleId.includes('basic')) {
                desc = 'Basic Security (2 Cameras)';
            } else if (bundleId.includes('cam') || bundleId.includes('camera')) {
                const count = item.qty || 1;
                desc = `${count}x Security Camera${count > 1 ? 's' : ''}`;
            }
            
            // OTHER SERVICES
            else if (bundleId.includes('soundbar') || bundleId.includes('sound_bar')) {
                desc = 'Soundbar Installation';
            } else if (bundleId.includes('doorbell')) {
                desc = 'Video Doorbell Setup';
            } else if (bundleId.includes('lock') || bundleId.includes('smart_lock')) {
                desc = 'Smart Lock Installation';
            } else if (bundleId.includes('mesh') || bundleId.includes('wifi')) {
                const nodes = meta.node_count || 3;
                desc = `${nodes}-Node Mesh WiFi Setup`;
            } else if (bundleId.includes('thermostat')) {
                desc = 'Smart Thermostat Install';
            } else if (bundleId.includes('outlet') || bundleId.includes('switch')) {
                desc = 'Smart Outlet/Switch Install';
            } else {
                // Generic cleanup
                const rawName = item.service_name || bundleId || item.service_id || '';
                if (rawName) {
                    desc = rawName.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }
            }
            
            if (desc) descriptions.push(desc);
        });
        return descriptions.length > 0 ? descriptions.join(' + ') : null;
    };

    async function loadJobs() {
        const grid = document.getElementById('jobs-grid');
        
        // Show skeleton grid while loading
        grid.innerHTML = `
            ${[1,2,3,4,5,6].map(() => `
                <div class="job-card" style="background:rgba(255,255,255,0.03); animation:pulse 1.5s ease-in-out infinite; pointer-events:none">
                    <div style="height:16px; width:70%; background:rgba(255,255,255,0.1); border-radius:4px; margin-bottom:12px"></div>
                    <div style="height:12px; width:90%; background:rgba(255,255,255,0.08); border-radius:4px; margin-bottom:8px"></div>
                    <div style="height:12px; width:80%; background:rgba(255,255,255,0.08); border-radius:4px; margin-bottom:8px"></div>
                    <div style="height:12px; width:60%; background:rgba(255,255,255,0.08); border-radius:4px"></div>
                </div>
            `).join('')}
        `;
        
        // Always fetch ALL jobs to allow client-side filtering
        try {
            // Fetch jobs and payouts in parallel to ensure we have payout data for completed jobs
            const [jobsRes, payoutsRes] = await Promise.all([
                fetchWithRetry(`${API_BASE}/admin_jobs_list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: ADMIN_TOKEN, status: 'all', days: 30 })
                }),
                fetchWithRetry(`${API_BASE}/admin_payouts_overview`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: ADMIN_TOKEN, status: 'all' })
                })
            ]);
            
            const data = await jobsRes.json();
            if (!data.ok) throw new Error(data.error || 'Failed to load jobs');
            
            // Process Payouts
            let payoutsMap = {};
            try {
                const payoutsData = await payoutsRes.json();
                if (payoutsData.ok && payoutsData.rows) {
                    payoutsData.rows.forEach(p => {
                        payoutsMap[p.job_id] = p;
                    });
                    currentPayouts = payoutsData.rows; // Update global payouts
                }
            } catch (e) { console.warn('Failed to load payouts for job cards', e); }

            currentJobs = data.jobs || [];
            
            // Merge payout info into jobs - API already returns enriched data
            currentJobs.forEach(job => {
                if (payoutsMap[job.job_id]) {
                    job.payout_info = payoutsMap[job.job_id];
                }
                
                // Service Name formatting (API returns clean names, just ensure capitalization)
                const smartName = buildServiceDescription(job.metadata?.items_json || job.line_items_json);
                if (smartName) {
                    job.formatted_service_name = smartName;
                } else {
                    const raw = job.service_name || 'Service Order';
                    job.formatted_service_name = raw.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }

                // UPDATE JOB CACHE: Single source of truth for all job lookups
                jobCache.set(job.job_id, job, 'data');

                // Normalize address fields so list cards show the same data as the modal
                const addr = job.address || job.service_address || job.metadata?.service_address || job.metadata?.address || job.location || job.metadata?.location || '';
                const city = job.city || job.service_city || job.metadata?.service_city || job.metadata?.city || '';
                const state = job.state || job.service_state || job.metadata?.service_state || job.metadata?.state || '';
                const zip = job.zip || job.service_zip || job.metadata?.service_zip || job.metadata?.zip || '';
                job.display_address = addr;
                job.display_city = city;
                job.display_state = state;
                job.display_zip = zip;
            });
            
            // Reset to page 1 on new load
            currentPage = 1;
            
            renderJobs(currentJobs);
            
            // PRE-FETCH: Load photos for pending payment jobs in background for instant modal access
            const pendingPaymentJobs = currentJobs.filter(j => 
                j.status === 'completed' || j.status === 'pending_payment'
            );
            
            if (pendingPaymentJobs.length > 0) {
                console.log(`[PRE-FETCH] Loading photos for ${pendingPaymentJobs.length} completed jobs...`);
                
                // Pre-fetch first 3 completed jobs (most likely to be viewed)
                pendingPaymentJobs.slice(0, 3).forEach(job => {
                    Promise.all([
                        loadJobPhotos(job.job_id, 'customer_photo'),
                        loadJobPhotos(job.job_id, 'photo')
                    ]).then(() => {
                        console.log(`[PRE-FETCH] ✓ Photos cached for job ${job.job_id}`);
                    }).catch(() => {
                        // Silent fail - photos will load on demand
                    });
                });
            }
        } catch (err) {
            console.error('Jobs load error:', err);
            grid.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Unable to Load Jobs</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadJobs()">Retry</button>
                </div>
            `;
        }
    }

    // --- PAGINATION & FILTERING ---
    function filterJobsByTab(status) {
        currentStatusFilter = status;
        currentPage = 1; // Reset to first page
        
        // Update active tab UI
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            const btnText = btn.textContent.toLowerCase();
            // Handle special cases
            if (status === 'all' && btnText === 'all jobs') {
                btn.classList.add('active');
            } else if (status === 'accepted' && btnText === 'scheduled') {
                btn.classList.add('active');
            } else if (btnText.includes(status.replace('_', ' '))) {
                btn.classList.add('active');
            }
        });
        
        renderJobs(currentJobs);
    }
    
    function filterJobsByEquipmentStatus() {
        currentPage = 1; // Reset to first page
        renderJobs(currentJobs);
    }

    function changePage(delta) {
        currentPage += delta;
        renderJobs(currentJobs);
        // Scroll to top of grid
        document.getElementById('view-jobs').scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderJobs(allJobs) {
        const grid = document.getElementById('jobs-grid');
        const pagination = document.getElementById('jobs-pagination');
        
        // 1. Filter by Status
        let filteredJobs = allJobs;
        if (currentStatusFilter !== 'all') {
            filteredJobs = allJobs.filter(j => {
                if (currentStatusFilter === 'completed') {
                    return j.status === 'completed' || j.status === 'pending_payment' || j.status === 'paid';
                }
                if (currentStatusFilter === 'accepted') {
                    // "Scheduled" tab includes all scheduling-related statuses
                    return j.status === 'accepted' || j.status === 'scheduled' || j.status === 'pending_scheduling';
                }
                return j.status === currentStatusFilter;
            });
            
            console.log(`[Dispatch Filter] Tab: "${currentStatusFilter}" | Total: ${allJobs.length} | Filtered: ${filteredJobs.length}`);
            if (currentStatusFilter === 'accepted') {
                const statusBreakdown = {
                    accepted: filteredJobs.filter(j => j.status === 'accepted').length,
                    scheduled: filteredJobs.filter(j => j.status === 'scheduled').length,
                    pending_scheduling: filteredJobs.filter(j => j.status === 'pending_scheduling').length
                };
                console.log('[Dispatch Filter] Scheduled tab breakdown:', statusBreakdown);
            }
        }
        
        // 1.5. Filter by Equipment Status
        const equipmentFilter = document.getElementById('equipment-status-filter')?.value || 'all';
        if (equipmentFilter !== 'all') {
            filteredJobs = filteredJobs.filter(j => {
                const hasEquipment = j.metadata?.items_json && (Array.isArray(j.metadata.items_json) ? j.metadata.items_json.length > 0 : true);
                const isOrdered = j.metadata?.equipment_ordered === true;
                
                if (equipmentFilter === 'needs_order') {
                    return hasEquipment && !isOrdered;
                } else if (equipmentFilter === 'ordered') {
                    return isOrdered;
                }
                return true;
            });
            console.log(`[Equipment Filter] Filter: "${equipmentFilter}" | Remaining: ${filteredJobs.length}`);
        }
        
        if (filteredJobs.length === 0) {
            grid.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:40px">No jobs found for this status</div>';
            pagination.classList.add('hidden');
            return;
        }
        
        // 2. Sort (Newest First)
        filteredJobs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        // 3. Paginate
        const totalPages = Math.ceil(filteredJobs.length / itemsPerPage);
        if (currentPage < 1) currentPage = 1;
        if (currentPage > totalPages) currentPage = totalPages;
        
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageJobs = filteredJobs.slice(start, end);
        
        // 4. Render Grid
        grid.innerHTML = pageJobs.map(job => {
            let tagsHtml = '';
            if (job.metadata && job.metadata.tags) {
                tagsHtml = job.metadata.tags.map(t => `<span class="tag">${t}</span>`).join('');
            }
            if (job.metadata && job.metadata.clarification_needed) {
                tagsHtml += `<span class="tag clarification">⚠️ Clarification Needed</span>`;
            }
            
            // Pain Flags Badge
            const painFlags = job.metadata?.pain_flags || [];
            const unresolvedFlags = painFlags.filter(f => !f.resolved_at);
            let painFlagBadge = '';
            if (unresolvedFlags.length > 0) {
                const criticalCount = unresolvedFlags.filter(f => f.severity === 'CRITICAL').length;
                const highCount = unresolvedFlags.filter(f => f.severity === 'HIGH').length;
                const badgeColor = criticalCount > 0 ? '#ef4444' : highCount > 0 ? '#f59e0b' : '#60a5fa';
                painFlagBadge = `<span class="pain-flag-badge" style="background:${badgeColor}; color:#fff; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:700; margin-left:8px">⚠️ ${unresolvedFlags.length}</span>`;
            }
            
            // Equipment Lane Badge
            let equipmentBadge = '';
            if (job.metadata?.equipment_lane) {
                const lane = job.metadata.equipment_lane;
                const badges = {
                    'BYO': { icon: '🏠', text: 'Customer Mounts', color: '#d1fae5', textColor: '#065f46' },
                    'COMPANY_SUPPLIED': { icon: '', text: 'H2S Supplies', color: '#dbeafe', textColor: '#1e40af' },
                    'HYBRID': { icon: '🔀', text: 'Hybrid', color: '#fef3c7', textColor: '#92400e' }
                };
                const badge = badges[lane];
                if (badge) {
                    equipmentBadge = `<span style="background:${badge.color}; color:${badge.textColor}; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; display:inline-block; margin-top:4px">${badge.icon} ${badge.text}</span>`;
                }
            }
            
            // Equipment Ordering Status Badge
            let equipmentStatusBadge = '';
            const equipmentOrdered = job.metadata?.equipment_ordered;
            if (equipmentOrdered) {
                equipmentStatusBadge = `<span style="background:rgba(34,197,94,0.2); color:#22c55e; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; display:inline-block; margin-top:4px; margin-left:4px">✓ Equipment Ordered</span>`;
            } else if (job.metadata?.items_json && (Array.isArray(job.metadata.items_json) ? job.metadata.items_json.length > 0 : true)) {
                // Only show "Order Equipment" badge if job actually has equipment needs
                equipmentStatusBadge = `<span style="background:rgba(251,191,36,0.2); color:#f59e0b; padding:4px 8px; border-radius:6px; font-size:11px; font-weight:600; display:inline-block; margin-top:4px; margin-left:4px">⚠ Order Equipment</span>`;
            }

            return `
                <div class="job-card" onclick="openJobModal('${job.job_id}')">
                    <div class="job-header">
                        <span class="job-id">${job.job_id}</span>
                        <span class="job-status status-${job.status}">${job.status}</span>
                        ${painFlagBadge}
                    </div>
                    <div class="job-title">${job.formatted_service_name || job.service_name || 'Service'}</div>
                    <div class="job-meta">
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <span>${job.customer_name || 'Unknown Customer'}</span>
                        </div>
                        ${job.assigned_pro_name || job.metadata?.pro_name ? `
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <span style="color:var(--brand-green)">${job.assigned_pro_name || job.metadata?.pro_name}</span>
                            ${job.assigned_pro_phone || job.metadata?.pro_phone ? `<span style="color:var(--text-muted); margin-left:8px; font-size:12px">📞 ${job.assigned_pro_phone || job.metadata?.pro_phone}</span>` : ''}
                        </div>
                        ` : ''}
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>${job.display_address || 'No Address'}${job.display_city ? ', ' + job.display_city.charAt(0).toUpperCase() + job.display_city.slice(1) : ''}${job.display_state ? ', ' + job.display_state.toUpperCase() : ''}</span>
                        </div>
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span>${new Date(job.start_iso || job.created_at).toLocaleDateString()}</span>
                        </div>
                        ${(job.status === 'completed' || job.status === 'pending_payment' || job.status === 'paid') && job.payout_info ? `
                        <div class="meta-row">
                            <svg class="meta-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <span style="font-weight:600; color:var(--brand-green)">$${job.payout_info.amount}</span>
                            <span style="font-size:12px; color:var(--text-muted); margin-left:6px">(${job.payout_info.status.replace('_', ' ')})</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="tags">${tagsHtml}${equipmentBadge}${equipmentStatusBadge}</div>
                </div>
            `;
        }).join('');
        
        // 5. Update Pagination Controls
        pagination.classList.remove('hidden');
        document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;
    }

    // --- MODAL LOGIC ---
    async function openJobModal(jobId) {
        const startTime = performance.now();
        console.log('[openJobModal] Opening job:', jobId);
        
        const job = currentJobs.find(j => j.job_id === jobId);
        if (!job) {
            console.error('[openJobModal] Job not found in currentJobs:', jobId);
            return;
        }
        
        // INSTANT DISPLAY: Show modal immediately with skeleton loaders
        document.getElementById('job-modal').classList.add('active');
        
        console.log('[openJobModal] Job data:', {
            job_id: job.job_id,
            service_name: job.service_name,
            metadata_exists: !!job.metadata,
            items_json_count: job.metadata?.items_json?.length || 0,
            purchasing_suggestions_count: job.purchasing_suggestions?.length || 0,
            assigned_pro: job.assigned_pro_name
        });
        
        currentJobId = jobId;
        
        const renderStart = performance.now();
        console.log(`[PERF] Modal opened in ${Math.round(renderStart - startTime)}ms`);

        // --- SMART DATA RESOLUTION ---
        
        // 1. Service Name Builder (Moved to global scope for reuse)
        // const buildServiceDescription = ... (Removed local definition)

        // PRIORITY: Use formatted name if passed (e.g. from Payouts view), otherwise build it
        let serviceName = job.formatted_service_name || buildServiceDescription(job.metadata?.items_json || job.line_items_json);
        
        // Fallback: Clean up the raw service name
        if (!serviceName) {
            const raw = job.service_name || 'Service Order';
            if (raw === 'svc_maintenance') {
                serviceName = 'Maintenance / Service Call';
            } else {
                serviceName = raw.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
        }

        // 2. Customer Name
        let customerName = job.customer_name || job.metadata?.customer_name || job.metadata?.shipping_name || job.metadata?.billing_name || job.customer_email?.split('@')[0] || 'Customer';
        if (customerName && customerName !== 'Customer') {
            customerName = customerName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ');
        }

        // 3. Address - Aggressive Lookup
        const address = job.address || job.service_address || job.metadata?.service_address || job.metadata?.address || job.location || job.metadata?.location || '';
        const city = job.city || job.service_city || job.metadata?.service_city || job.metadata?.city || '';
        const state = job.state || job.service_state || job.metadata?.service_state || job.metadata?.state || '';
        const zip = job.zip || job.service_zip || job.metadata?.service_zip || job.metadata?.zip || '';
        
        let fullAddress = 'No address provided';
        if (address) {
            fullAddress = city ? `${address}, ${city}` : address;
        } else if (city) {
            fullAddress = city;
        }
        
        // DEBUG: If address is missing, log all keys to help debug
        if (fullAddress === 'No address provided') {
            console.warn('[openJobModal] Address missing! Job keys:', Object.keys(job));
            console.warn('[openJobModal] Metadata keys:', job.metadata ? Object.keys(job.metadata) : 'null');
        }

        document.getElementById('modal-title').innerText = serviceName;
        document.getElementById('modal-id').innerText = `ID: ${job.job_id}`;
        document.getElementById('modal-customer').innerText = customerName;
        document.getElementById('modal-location').innerText = fullAddress;
        
        const mapLink = document.getElementById('modal-map-link');
        if (address || city) {
            const query = encodeURIComponent(`${address}, ${city}, ${state} ${zip}`);
            mapLink.href = `https://www.google.com/maps/search/?api=1&query=${query}`;
            mapLink.classList.remove('hidden');
        } else {
            mapLink.classList.add('hidden');
        }

        document.getElementById('modal-service').innerText = serviceName;
        document.getElementById('modal-date').innerText = new Date(job.start_iso || job.created_at).toLocaleString();

        // Show job metadata details with complete breakdown
        const metadataContainer = document.getElementById('modal-metadata');
        console.log('[openJobModal] Metadata:', job.metadata);
        console.log('[openJobModal] Items JSON:', job.metadata?.items_json);
        console.log('[openJobModal] line_items_json:', job.line_items_json);
        console.log('[openJobModal] service_name:', job.service_name);
        console.log('[openJobModal] service_id:', job.service_id);
        
        if (job.metadata && Object.keys(job.metadata).length > 0) {
            const meta = job.metadata;
            
            // Analyze equipment needs from items_json
            let equipmentBreakdown = '';
            let serviceDetails = '';
            
            // SMART PARSING: Handle multiple data sources and formats
            let items = [];
            
            // Priority 1: metadata.items_json (shop orders)
            if (meta.items_json) {
                if (Array.isArray(meta.items_json)) {
                    items = meta.items_json;
                } else if (typeof meta.items_json === 'string') {
                    try {
                        items = JSON.parse(meta.items_json);
                    } catch (e) {
                        console.warn('[openJobModal] Failed to parse metadata.items_json string:', e);
                    }
                }
            }
            
            // Priority 2: job.line_items_json (legacy dispatch jobs)
            if (items.length === 0 && job.line_items_json) {
                if (Array.isArray(job.line_items_json)) {
                    items = job.line_items_json;
                } else if (typeof job.line_items_json === 'string') {
                    try {
                        items = JSON.parse(job.line_items_json);
                    } catch (e) {
                        console.warn('[openJobModal] Failed to parse line_items_json string:', e);
                    }
                }
            }
            
            // Priority 3: Synthesize from service_name/service_id
            if (items.length === 0 && (job.service_name || job.service_id)) {
                const serviceName = job.service_name || job.service_id || '';
                const qty = job.qty || 1;
                
                // Create synthetic line item for equipment parsing
                items = [{
                    bundle_id: serviceName,
                    service_name: serviceName,
                    qty: qty,
                    metadata: meta || {}
                }];
                
                console.log('[openJobModal] ⚠️ No items_json found, synthesized from service fields:', items);
            }
            
            if (items.length > 0) {
                console.log('[openJobModal] ✅ Processing', items.length, 'items for equipment breakdown');
                let totalTVMounts = 0;
                let totalCameras = 0;
                let equipmentList = [];
                
                items.forEach((item, idx) => {
                    // SMART BUNDLE DETECTION: Check bundle_id, service_name, service_id, AND name field
                    const bundleId = (item.bundle_id || item.service_name || item.service_id || '').toLowerCase();
                    const itemName = (item.name || '').toLowerCase();
                    const qty = item.qty || item.quantity || 1;
                    const itemMeta = item.metadata || {};
                    
                    console.log(`[openJobModal] Item ${idx + 1}:`, {
                        bundle_id: item.bundle_id,
                        service_name: item.service_name,
                        name: item.name,
                        qty: qty,
                        metadata_keys: Object.keys(itemMeta)
                    });
                    
                    // FALLBACK: If no bundle_id, detect from name patterns
                    let detectedType = '';
                    if (!bundleId || bundleId === 'unknown') {
                        if (itemName.includes('front door') || itemName.includes('basic') && itemName.includes('cam')) {
                            detectedType = 'cam_basic';
                        } else if (itemName.includes('perimeter') || itemName.includes('standard') && itemName.includes('cam')) {
                            detectedType = 'cam_standard';
                        } else if (itemName.includes('premium') || itemName.includes('full') && itemName.includes('cam')) {
                            detectedType = 'cam_premium';
                        } else if (itemName.includes('tv') || itemName.includes('mount')) {
                            detectedType = 'tv';
                        } else if (itemName.includes('doorbell')) {
                            detectedType = 'doorbell';
                        } else if (itemName.includes('soundbar')) {
                            detectedType = 'soundbar';
                        }
                        
                        if (detectedType) {
                            console.log(`[openJobModal] 🔍 Detected from name "${item.name}": ${detectedType}`);
                        }
                    }
                    
                    const effectiveBundleId = bundleId || detectedType;
                    
                    // ========== TV MOUNT PACKAGES ==========
                    if (effectiveBundleId.includes('tv')) {
                        const mountsNeeded = itemMeta.mounts_needed || itemMeta.tv_count || qty;
                        totalTVMounts += mountsNeeded;
                        const tvSize = itemMeta.tv_size || 'Unknown Size';
                        const mountType = itemMeta.mount_type === 'full_motion' ? 'Full Motion' :
                                        itemMeta.mount_type === 'tilt' ? 'Tilt' :
                                        itemMeta.mount_type === 'fixed' ? 'Fixed/Flat' : 
                                        itemMeta.mount_type === 'customer_provided' ? 'Customer Mount' : '';
                        const mountProvider = itemMeta.mount_provider === 'customer' ? 'Customer Provided' : 
                                            itemMeta.mount_provider === 'h2s' ? 'H2S Supplied' : 'Standard';
                        
                        const tvLabel = bundleId === 'tv_single' ? 'Single TV Mount' :
                                      bundleId === 'tv_multi' ? 'Multi-Room TV Install' : 'TV Mount';
                        
                        equipmentList.push({
                            type: 'TV Mount',
                            details: `${tvLabel}: ${mountsNeeded}x ${tvSize}" TV${mountType ? ` (${mountType})` : ''} - ${mountProvider}`,
                            qty: mountsNeeded,
                            meta: itemMeta
                        });
                        
                        console.log('[openJobModal] ✅ TV Mount detected:', mountsNeeded, 'mount(s),', tvSize, 'inch');
                    }
                    
                    // ========== CAMERA PACKAGES ==========
                    else if (effectiveBundleId.includes('cam') || effectiveBundleId.includes('camera')) {
                        let camerasInPackage = qty;
                        let packageType = 'Standard';
                        let packageDetails = '';
                        
                        if (effectiveBundleId === 'cam_basic' || effectiveBundleId.includes('basic') || itemName.includes('front door')) {
                            camerasInPackage = 2 * qty;
                            packageType = 'Basic';
                            packageDetails = 'Front Door Coverage (2 cams)';
                        } else if (effectiveBundleId === 'cam_standard' || effectiveBundleId.includes('standard') || itemName.includes('perimeter')) {
                            camerasInPackage = 4 * qty;
                            packageType = 'Standard';
                            packageDetails = 'Perimeter Coverage (4 cams)';
                        } else if (effectiveBundleId === 'cam_premium' || effectiveBundleId.includes('premium') || itemName.includes('full')) {
                            camerasInPackage = 8 * qty;
                            packageType = 'Premium';
                            packageDetails = 'Full Property Coverage (8 cams)';
                        }
                        
                        totalCameras += camerasInPackage;
                        
                        equipmentList.push({
                            type: 'Security Camera',
                            details: `${packageType} Camera System: ${camerasInPackage}x Cameras - ${packageDetails}`,
                            qty: camerasInPackage,
                            meta: itemMeta,
                            originalName: item.name || item.service_name
                        });
                        
                        console.log('[openJobModal] ✅ Camera package detected:', packageType, '-', camerasInPackage, 'cameras');
                    }
                    
                    // ========== DOORBELL ==========
                    else if (effectiveBundleId.includes('doorbell') || effectiveBundleId.includes('door_bell')) {
                        equipmentList.push({
                            type: 'Smart Doorbell',
                            details: `${qty}x Video Doorbell Installation`,
                            qty: qty,
                            meta: itemMeta
                        });
                        
                        console.log('[openJobModal] ✅ Doorbell detected:', qty, 'unit(s)');
                    }
                    
                    // ========== SOUNDBAR ==========
                    else if (bundleId.includes('soundbar') || bundleId.includes('sound_bar')) {
                        equipmentList.push({
                            type: 'Soundbar',
                            details: `${qty}x Soundbar Installation & Setup`,
                            qty: qty,
                            meta: itemMeta
                        });
                        
                        console.log('[openJobModal] ✅ Soundbar detected:', qty, 'unit(s)');
                    }
                    
                    // ========== SMART LOCK ==========
                    else if (bundleId.includes('lock') || bundleId.includes('smart_lock')) {
                        equipmentList.push({
                            type: 'Smart Lock',
                            details: `${qty}x Smart Lock Installation`,
                            qty: qty,
                            meta: itemMeta
                        });
                        
                        console.log('[openJobModal] ✅ Smart lock detected:', qty, 'unit(s)');
                    }
                    
                    // ========== MESH WIFI ==========
                    else if (bundleId.includes('mesh') || bundleId.includes('wifi') || bundleId.includes('router')) {
                        const nodeCount = itemMeta.node_count || 3;
                        equipmentList.push({
                            type: 'Mesh WiFi',
                            details: `${nodeCount}-Node Mesh WiFi System Setup`,
                            qty: nodeCount,
                            meta: itemMeta
                        });
                        
                        console.log('[openJobModal] ✅ Mesh WiFi detected:', nodeCount, 'nodes');
                    }
                    
                    // ========== GENERIC SERVICE ==========
                    else if (effectiveBundleId && effectiveBundleId !== 'product') {
                        const cleanName = (item.service_name || item.name || effectiveBundleId).replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        equipmentList.push({
                            type: 'Service',
                            details: `${qty}x ${cleanName}`,
                            qty: qty,
                            meta: itemMeta,
                            originalName: item.name
                        });
                        
                        console.log('[openJobModal] ℹ️ Generic service detected:', cleanName);
                    }
                });
                
                console.log('[openJobModal] 📊 Equipment Summary:', {
                    total_tv_mounts: totalTVMounts,
                    total_cameras: totalCameras,
                    total_items: equipmentList.length
                });
                
                // Build equipment breakdown HTML only if we found equipment
                if (equipmentList.length > 0) {
                    // Check ordering status from metadata
                    const equipmentOrdered = meta.equipment_ordered || false;
                    const orderedAt = meta.equipment_ordered_at ? new Date(meta.equipment_ordered_at).toLocaleDateString() : null;
                    const orderedBy = meta.equipment_ordered_by || 'Unknown';
                    
                    equipmentBreakdown = `
                        <div style="grid-column:1/-1; background:rgba(20,147,255,0.1); border:1px solid rgba(20,147,255,0.3); border-radius:8px; padding:16px; margin-bottom:16px">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
                                <div style="font-weight:700; font-size:14px; color:var(--brand-azure)">Equipment Breakdown</div>
                                ${equipmentOrdered ? `
                                    <div style="display:flex; align-items:center; gap:8px">
                                        <span style="background:rgba(34,197,94,0.2); color:#22c55e; padding:4px 12px; border-radius:4px; font-size:12px; font-weight:600">
                                            Ordered ${orderedAt ? `on ${orderedAt}` : ''}
                                        </span>
                                        <button class="btn" style="padding:4px 12px; font-size:12px; background:rgba(239,68,68,0.1); border:1px solid #ef4444; color:#ef4444" onclick="markEquipmentUnordered('${job.job_id}')">
                                            Undo
                                        </button>
                                    </div>
                                ` : `
                                    <button class="btn" style="padding:6px 16px; font-size:13px; background:rgba(251,191,36,0.1); border:1px solid #f59e0b; color:#f59e0b" onclick="markEquipmentOrdered('${job.job_id}')">
                                        Mark as Ordered
                                    </button>
                                `}
                            </div>
                            ${totalTVMounts > 0 ? `<div style="margin-bottom:8px"><strong>${totalTVMounts} TV Mount${totalTVMounts > 1 ? 's' : ''}</strong></div>` : ''}
                            ${totalCameras > 0 ? `<div style="margin-bottom:8px"><strong>${totalCameras} Security Camera${totalCameras > 1 ? 's' : ''}</strong></div>` : ''}
                            <div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(255,255,255,0.1)">
                                ${equipmentList.map(eq => `
                                    <div style="font-size:13px; color:var(--text-muted); margin-bottom:6px">
                                        <span style="color:#fff">•</span> ${eq.details}
                                        ${eq.meta.requires_team ? '<span style="color:var(--brand-gold); margin-left:8px">👥 Team Required</span>' : ''}
                                        ${eq.meta.team_recommended ? '<span style="color:var(--brand-gold); margin-left:8px">👥 Team Recommended</span>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Order Notes -->
                            <div style="margin-top:16px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1)">
                                <label style="font-size:12px; color:var(--text-muted); margin-bottom:6px; display:block">Order Notes (tracking #, supplier, etc.)</label>
                                <textarea id="equipment-notes-${job.job_id}" 
                                    style="width:100%; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:4px; padding:8px; color:#fff; font-size:13px; resize:vertical; min-height:60px" 
                                    placeholder="Amazon order #12345, arriving Tuesday...">${meta.equipment_notes || ''}</textarea>
                                <button class="btn" style="margin-top:8px; padding:4px 12px; font-size:12px" onclick="saveEquipmentNotes('${job.job_id}')">Save Notes</button>
                            </div>
                            
                            <!-- Quick Supplier Links -->
                            <div style="margin-top:16px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1)">
                                <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px">Quick Links:</div>
                                <div style="display:flex; gap:8px">
                                    <a href="https://www.amazon.com" target="_blank" class="btn" style="padding:6px 16px; font-size:13px; background:rgba(255,153,0,0.1); border:1px solid #ff9900; color:#ff9900; text-decoration:none">
                                        Amazon
                                    </a>
                                    <a href="https://www.lowes.com" target="_blank" class="btn" style="padding:6px 16px; font-size:13px; background:rgba(0,70,127,0.1); border:1px solid #00467f; color:#4a9eff; text-decoration:none">
                                        Lowe's
                                    </a>
                                    <a href="https://www.homedepot.com" target="_blank" class="btn" style="padding:6px 16px; font-size:13px; background:rgba(248,70,0,0.1); border:1px solid #f86600; color:#f86600; text-decoration:none">
                                        Home Depot
                                    </a>
                                </div>
                            </div>
                            
                            <!-- Order History -->
                            ${meta.audit_log && meta.audit_log.filter(entry => entry.action?.includes('equipment_ordered') || entry.action === 'metadata_updated').length > 0 ? `
                            <div style="margin-top:16px; padding-top:16px; border-top:1px solid rgba(255,255,255,0.1)">
                                <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px">Order History:</div>
                                ${meta.audit_log.filter(entry => entry.action?.includes('equipment_ordered') || entry.action === 'metadata_updated').slice(-5).reverse().map(entry => {
                                    const date = new Date(entry.timestamp).toLocaleString();
                                    const action = entry.notes || entry.action;
                                    const user = entry.user_name || entry.user_id || 'System';
                                    return `<div style="font-size:12px; color:var(--text-muted); margin-bottom:4px">• ${date} - ${user}: ${action}</div>`;
                                }).join('')}
                            </div>
                            ` : ''}
                        </div>
                    `;
                    
                    console.log('[openJobModal] ✅ Equipment breakdown HTML generated with ordering status:', equipmentOrdered);
                } else {
                    console.warn('[openJobModal] ⚠️ No equipment detected in items - breakdown will be empty');
                }
                
                // Service details with all metadata (only show if items exist)
                if (items.length > 0) {
                    serviceDetails = `
                        <div style="grid-column:1/-1">
                            <label style="display:block; font-size:12px; color:var(--text-muted); margin-bottom:8px">Service Line Items (${items.length})</label>
                            ${items.filter(item => item.type !== 'product').map(item => {
                                const itemMeta = item.metadata || {};
                                const price = item.line_total || item.unit_price || item.price || 0;
                                return `
                                    <div style="background:rgba(255,255,255,0.03); padding:12px; border-radius:6px; margin-bottom:8px">
                                        <div style="font-weight:600; margin-bottom:4px; color:var(--brand-azure)">${item.service_name || item.bundle_id || item.name || 'Service'}</div>
                                        <div style="font-size:13px; color:var(--text-muted); line-height:1.6">
                                            <div>Quantity: <strong>${item.qty || 1}</strong>${price > 0 ? ` | Price: <strong style="color:var(--brand-green)">$${price}</strong>` : ''}</div>
                                            ${itemMeta.tv_size ? `<div>TV Size: <strong>${itemMeta.tv_size}"</strong></div>` : ''}
                                            ${itemMeta.mount_type ? `<div>Mount Type: <strong style="color:var(--brand-azure)">${itemMeta.mount_type === 'full_motion' ? 'Full Motion' : itemMeta.mount_type === 'tilt' ? 'Tilt' : itemMeta.mount_type === 'fixed' ? 'Fixed/Flat' : itemMeta.mount_type === 'customer_provided' ? 'Customer' : itemMeta.mount_type}</strong></div>` : ''}
                                            ${itemMeta.mounts_needed ? `<div>Mounts Needed: <strong>${itemMeta.mounts_needed}</strong></div>` : ''}
                                            ${itemMeta.mount_provider ? `<div>Mount Provider: <strong>${itemMeta.mount_provider === 'customer' ? 'Customer BYO' : itemMeta.mount_provider === 'h2s' ? 'H2S Supplies' : 'Standard'}</strong></div>` : ''}
                                            ${itemMeta.mount_source ? `<div>Mount Source: <strong>${itemMeta.mount_source}</strong></div>` : ''}
                                            ${itemMeta.min_team_size ? `<div>Min Team Size: <strong>${itemMeta.min_team_size}</strong></div>` : ''}
                                            ${itemMeta.node_count ? `<div>WiFi Nodes: <strong>${itemMeta.node_count}</strong></div>` : ''}
                                            ${itemMeta.wall_type ? `<div>Wall Type: <strong>${itemMeta.wall_type}</strong></div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }
            } else {
                console.warn('[openJobModal] ⚠️ NO ITEMS FOUND - checked metadata.items_json, line_items_json, and service fields');
            }
            
            metadataContainer.innerHTML = `
                <div class="section-title">Job Details</div>
                <div class="info-grid">
                    ${equipmentBreakdown}
                    
                    ${(() => {
                        // Pain Flags Section
                        const painFlags = meta?.pain_flags || [];
                        const unresolvedFlags = painFlags.filter(f => !f.resolved_at);
                        if (unresolvedFlags.length === 0) return '';
                        
                        return `
                        <div style="grid-column:1/-1; background:rgba(251,191,36,0.1); border:1px solid #f59e0b; border-radius:8px; padding:16px; margin-bottom:16px">
                            <div style="font-weight:700; font-size:14px; margin-bottom:12px; color:#f59e0b; display:flex; align-items:center; gap:8px">
                                <span>⚠️ ATTENTION REQUIRED</span>
                                <span style="background:#fef3c7; color:#92400e; padding:2px 8px; border-radius:4px; font-size:11px">
                                    ${unresolvedFlags.length} FLAG${unresolvedFlags.length > 1 ? 'S' : ''}
                                </span>
                            </div>
                            ${unresolvedFlags.map(flag => {
                                const icon = flag.severity === 'CRITICAL' ? '🔴' : flag.severity === 'HIGH' ? '🟡' : flag.severity === 'MEDIUM' ? '🔵' : '⚪';
                                return `
                                <div style="background:rgba(0,0,0,0.2); padding:12px; border-radius:6px; margin-bottom:8px">
                                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px">
                                        <span>${icon}</span>
                                        <span style="font-weight:600">${flag.flag.replace(/_/g, ' ')}</span>
                                    </div>
                                    <div style="font-size:13px; color:var(--text-muted); margin-bottom:8px">${flag.message}</div>
                                    <button class="btn" style="padding:4px 12px; font-size:12px" onclick="resolvePainFlag('${job.job_id}', '${flag.flag}')">
                                        Resolve
                                    </button>
                                </div>
                                `;
                            }).join('')}
                        </div>
                        `;
                    })()}
                    
                    ${(() => {
                        // Equipment & Ordering Section
                        if (!meta?.equipment_lane && !meta?.order_required) return '';
                        
                        return `
                        <div style="grid-column:1/-1; background:rgba(30,41,59,0.5); border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px">
                            <div style="font-weight:700; font-size:14px; margin-bottom:12px; color:var(--brand-azure)">Equipment & Ordering</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                                ${meta.equipment_lane ? `
                                <div>
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px">Equipment Lane:</div>
                                    <div style="font-weight:600">${meta.equipment_lane === 'BYO' ? 'Customer Mounts' : meta.equipment_lane === 'COMPANY_SUPPLIED' ? 'H2S Supplies' : 'Hybrid'}</div>
                                </div>
                                ` : ''}
                                ${meta.order_required !== undefined ? `
                                <div>
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px">Order Required:</div>
                                    <div style="font-weight:600">${meta.order_required ? '✅ YES' : '❌ NO'}</div>
                                </div>
                                ` : ''}
                                ${meta.order_required && meta.order_stage ? `
                                <div>
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px">Order Stage:</div>
                                    <div style="font-weight:600; color:${meta.order_stage === 'DELIVERED' ? 'var(--brand-green)' : meta.order_stage === 'ORDERED' ? 'var(--brand-azure)' : '#f59e0b'}">
                                        ${meta.order_stage.replace(/_/g, ' ')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ${meta.order_plan ? `
                                <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border)">
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:8px">Order Plan: ${meta.order_plan.kit_type.replace(/_/g, ' ')}</div>
                                    ${meta.order_plan.components.map(comp => `
                                        <div style="font-size:13px; margin-bottom:4px; display:flex; justify-content:space-between">
                                            <span>${comp.quantity}x ${comp.name}</span>
                                            <span style="color:var(--brand-green)">$${(comp.unit_cost * comp.quantity / 100).toFixed(2)}</span>
                                        </div>
                                    `).join('')}
                                    <div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--border); display:flex; justify-content:space-between; font-weight:700">
                                        <span>Total Estimate:</span>
                                        <span style="color:var(--brand-green)">$${(meta.order_plan.total_cost_estimate / 100).toFixed(2)}</span>
                                    </div>
                                </div>
                            ` : meta.order_required ? `
                                <div style="margin-top:12px">
                                    <button class="btn btn-primary" style="width:100%" onclick="generateOrderPlan('${job.job_id}')">
                                        Generate Order Plan
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        `;
                    })()}
                    
                    ${(() => {
                        // Installation Details Section
                        if (!meta?.wire_management_required && !meta?.wall_type) return '';
                        
                        return `
                        <div style="grid-column:1/-1; background:rgba(30,41,59,0.5); border:1px solid var(--border); border-radius:8px; padding:16px; margin-bottom:16px">
                            <div style="font-weight:700; font-size:14px; margin-bottom:12px; color:var(--brand-azure)">🔧 Installation Details</div>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                                ${meta.wire_management_required ? `
                                <div>
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px">Wire Management:</div>
                                    <div style="font-weight:600; color:${meta.wire_management_required === 'UNKNOWN' ? '#f59e0b' : '#fff'}">
                                        ${meta.wire_management_required.replace(/_/g, ' ')}
                                    </div>
                                </div>
                                ` : ''}
                                ${meta.wall_type ? `
                                <div>
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px">Wall Type:</div>
                                    <div style="font-weight:600; color:${meta.wall_type === 'UNKNOWN' ? '#f59e0b' : '#fff'}">
                                        ${meta.wall_type}
                                    </div>
                                </div>
                                ` : ''}
                                ${meta.mounting_surface_notes ? `
                                <div style="grid-column:1/-1">
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px">Surface Notes:</div>
                                    <div style="font-size:13px">${meta.mounting_surface_notes}</div>
                                </div>
                                ` : ''}
                                ${meta.special_constraints?.length > 0 ? `
                                <div style="grid-column:1/-1">
                                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px">Constraints:</div>
                                    <div style="display:flex; gap:8px; flex-wrap:wrap">
                                        ${meta.special_constraints.map(c => `
                                            <span style="background:rgba(239,68,68,0.2); color:#fca5a5; padding:4px 8px; border-radius:4px; font-size:12px">${c}</span>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div style="margin-top:12px">
                                <button class="btn btn-ghost" style="width:100%" onclick="updateInstallDetails('${job.job_id}')">
                                    Update Details
                                </button>
                            </div>
                        </div>
                        `;
                    })()}
                    
                    ${meta.estimated_payout ? `<div class="info-item"><label>Estimated Payout</label><div style="color:var(--brand-green); font-weight:600">$${meta.estimated_payout}</div></div>` : ''}
                    ${meta.customer_phone ? `<div class="info-item"><label>Customer Phone</label><div>${meta.customer_phone}</div></div>` : ''}
                    ${meta.order_id ? `<div class="info-item"><label>Order ID</label><div style="font-size:11px; font-family:monospace">${meta.order_id}</div></div>` : ''}
                    ${meta.source ? `<div class="info-item"><label>Source</label><div>${meta.source}</div></div>` : ''}
                    ${meta.geo_lat && meta.geo_lng ? `<div class="info-item"><label>Coordinates</label><div style="font-size:11px">${meta.geo_lat.toFixed(4)}, ${meta.geo_lng.toFixed(4)}</div></div>` : ''}
                    ${meta.referral_code ? `<div class="info-item"><label>Referral Code</label><div>${meta.referral_code}</div></div>` : ''}
                    ${serviceDetails}
                </div>
            `;
        } else {
            metadataContainer.innerHTML = '';
        }

        // PARALLEL LOADING: Load both photo types simultaneously for faster modal open
        const photosContainer = document.getElementById('modal-photos');
        const techPhotosContainer = document.getElementById('modal-tech-photos');
        
        // Show loading skeletons immediately
        photosContainer.innerHTML = '<div class="skeleton-pulse" style="height:150px; border-radius:8px"></div>';
        techPhotosContainer.innerHTML = '<div class="skeleton-pulse" style="height:150px; border-radius:8px"></div>';
        
        // Load both photo types in parallel (saves ~70-100ms)
        const [customerPhotos, techPhotos] = await Promise.all([
            loadJobPhotos(job.job_id, 'customer_photo'),
            loadJobPhotos(job.job_id, 'photo')
        ]);
        
        // Render customer photos - show for ALL jobs (uploaded BEFORE job starts for planning)
        if (customerPhotos.length > 0) {
            const uploadDate = customerPhotos[0].created_at ? new Date(customerPhotos[0].created_at).toLocaleDateString() : '';
            photosContainer.innerHTML = `
                <div style="background:rgba(20,147,255,0.1); border:1px solid rgba(20,147,255,0.3); border-radius:8px; padding:16px; margin-bottom:16px">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
                        <div style="font-weight:700; font-size:14px; color:var(--brand-azure)">📸 Customer Pre-Job Photos (${customerPhotos.length})</div>
                        ${uploadDate ? `<div style="font-size:11px; color:var(--text-muted)">Uploaded ${uploadDate}</div>` : ''}
                    </div>
                    <div style="font-size:12px; color:var(--text-muted); margin-bottom:12px; font-style:italic">Customer uploaded these photos to help plan installation & order equipment</div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px">
                        ${customerPhotos.map(photo => {
                            const photoUrl = photo.file_url || photo.photo_url || photo.url || photo.storage_url;
                            return `
                                <div style="position:relative; border-radius:8px; overflow:hidden; border:1px solid var(--border); background:#000">
                                    <img src="${photoUrl}" style="width:100%; height:150px; object-fit:cover; cursor:pointer" loading="lazy" onclick="openPhotoLightbox('${photoUrl}')">
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        } else {
            // No customer photos - don't show anything (they're optional)
            photosContainer.innerHTML = '';
        }

        // Render tech photos
        if (techPhotos.length > 0) {
            techPhotosContainer.innerHTML = `
                <div class="section-title">📸 Pro Photos (${techPhotos.length})</div>
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:12px">
                    ${techPhotos.map(photo => {
                        const photoUrl = photo.file_url || photo.photo_url || photo.url || photo.storage_url;
                        const uploadDate = photo.created_at || photo.added_at;
                        return `
                            <div style="position:relative; border-radius:8px; overflow:hidden; border:1px solid var(--border)">
                                <img src="${photoUrl}" style="width:100%; height:150px; object-fit:cover; cursor:pointer" onclick="openPhotoLightbox('${photoUrl}')">
                                <div style="position:absolute; bottom:0; left:0; right:0; background:linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding:6px 8px; font-size:10px; color:rgba(255,255,255,0.9)">
                                    ${uploadDate ? new Date(uploadDate).toLocaleDateString() : 'Unknown date'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        } else {
            techPhotosContainer.innerHTML = '<div style="color:var(--text-muted); font-size:13px; font-style:italic">No pro photos uploaded yet</div>';
        }

        // Render Suggestions with intelligent categorization
        const suggestionsContainer = document.getElementById('modal-suggestions');
        const suggestionsHeader = document.getElementById('suggestions-header');
        
        console.log('[openJobModal] Purchasing suggestions:', job.purchasing_suggestions);
        console.log('[openJobModal] Suggestions count:', job.purchasing_suggestions?.length || 0);
        
        if (job.purchasing_suggestions && job.purchasing_suggestions.length > 0) {
            suggestionsHeader.classList.remove('hidden');
            suggestionsContainer.classList.remove('hidden');
            
            // Categorize suggestions
            const categories = {
                PURCHASE_NEEDED: job.purchasing_suggestions.filter(s => s.category === 'PRIMARY'),
                FIELD_STOCK: job.purchasing_suggestions.filter(s => s.category === 'SUPPLIES' && s.priority > 2),
                VERIFY_CUSTOMER: job.purchasing_suggestions.filter(s => s.category === 'SUPPLIES' && s.priority <= 2)
            };
            
            // Check if there are multiple TV mounts with different specs
            const tvMounts = categories.PURCHASE_NEEDED.filter(s => s.suggested_id?.includes('TV_MOUNT'));
            const hasMultipleTVMounts = tvMounts.length > 1;
            
            console.log('[openJobModal] Categorized suggestions:', {
                PURCHASE_NEEDED: categories.PURCHASE_NEEDED.length,
                FIELD_STOCK: categories.FIELD_STOCK.length,
                VERIFY_CUSTOMER: categories.VERIFY_CUSTOMER.length,
                TV_MOUNTS: tvMounts.length
            });
            
            suggestionsContainer.innerHTML = `
                ${hasMultipleTVMounts ? `
                    <div style="background:rgba(34,201,111,0.1); border:1px solid rgba(34,201,111,0.3); border-radius:8px; padding:12px; margin-bottom:16px">
                        <div style="font-weight:700; font-size:12px; color:var(--brand-green); margin-bottom:8px">📊 MULTIPLE TV INSTALLATION</div>
                        <div style="font-size:12px; color:var(--text-muted); line-height:1.6">
                            This job requires <strong style="color:#fff">${tvMounts.length} different TV mounts</strong>:
                            ${tvMounts.map(m => `<div style="margin-top:4px">• ${m.tv_size}" TV - ${m.mount_type === 'full_motion' ? 'Full Motion' : m.mount_type === 'tilt' ? 'Tilt' : 'Fixed'}</div>`).join('')}
                        </div>
                    </div>
                ` : ''}
                ${categories.PURCHASE_NEEDED.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--brand-azure); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>🛒</span> ORDER REQUIRED (${categories.PURCHASE_NEEDED.length} item${categories.PURCHASE_NEEDED.length > 1 ? 's' : ''})
                        </div>
                        ${categories.PURCHASE_NEEDED.map((item, idx) => `
                            <div class="suggestion-card" style="border-left:3px solid var(--brand-azure)">
                                <input type="checkbox" class="suggestion-check" id="check-${idx}" checked>
                                <div class="suggestion-content">
                                    <h4>
                                        ${item.item_name} 
                                        ${item.quantity ? `<span style="color:var(--text-muted); font-size:12px; font-weight:normal">(Qty: ${item.quantity})</span>` : ''}
                                    </h4>
                                    <p style="margin:6px 0">${item.why_needed}</p>
                                    ${item.mount_type || item.tv_size ? `
                                        <div style="font-size:11px; color:var(--brand-azure); margin-bottom:8px">
                                            ${item.tv_size ? `📺 ${item.tv_size}" TV` : ''}
                                            ${item.mount_type ? ` | ${item.mount_type === 'full_motion' ? '🔄 Full Motion' : item.mount_type === 'tilt' ? '⬇️ Tilt' : '📍 Fixed'}` : ''}
                                        </div>
                                    ` : ''}
                                    <div class="brand-tags">
                                        ${item.typical_brands.map(b => `<span class="brand-tag">${b}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${categories.VERIFY_CUSTOMER.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--brand-gold); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>⚠️</span> VERIFY WITH CUSTOMER (${categories.VERIFY_CUSTOMER.length})
                        </div>
                        ${categories.VERIFY_CUSTOMER.map((item, idx) => `
                            <div class="suggestion-card" style="border-left:3px solid var(--brand-gold); opacity:0.8">
                                <div class="suggestion-content">
                                    <h4>${item.item_name}</h4>
                                    <p style="font-size:12px; color:var(--text-muted)">${item.why_needed}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${categories.FIELD_STOCK.length > 0 ? `
                    <div style="margin-bottom:20px">
                        <div style="font-weight:700; font-size:13px; color:var(--text-muted); margin-bottom:12px; display:flex; align-items:center; gap:8px">
                            <span>🧰</span> FIELD STOCK (Pro should have)
                        </div>
                        <div style="font-size:12px; color:var(--text-muted); font-style:italic">
                            ${categories.FIELD_STOCK.map(s => s.item_name).join(', ')}
                        </div>
                    </div>
                ` : ''}
            `;
        } else {
            suggestionsHeader.classList.add('hidden');
            suggestionsContainer.classList.add('hidden');
            suggestionsContainer.innerHTML = '';
        }
        
        const endTime = performance.now();
        const totalTime = Math.round(endTime - startTime);
        const renderTime = Math.round(endTime - renderStart);
        
        console.log(`[PERF] ✓ Modal fully rendered in ${totalTime}ms (render: ${renderTime}ms)`);
        
        if (totalTime > 500) {
            console.warn(`[PERF] ⚠️ Modal took ${totalTime}ms (target: <500ms)`);
        }
    }
    
    function showJobModal(job) {
        // Helper function for payout view to open job details
        currentJobs = [job]; // Temporarily add to array
        openJobModal(job.job_id);
    }

    // --- PAIN FLAG RESOLUTION ---
    async function resolvePainFlag(jobId, flag) {
        const notes = prompt('Resolution notes (optional):');
        if (notes === null) return; // User cancelled
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/resolve_pain_flag`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: jobId, 
                    flag: flag,
                    resolution_notes: notes || 'Resolved',
                    admin_user: 'admin',
                    admin_name: 'Admin'
                })
            });
            
            const data = await res.json();
            if (data.ok) {
                alert('✅ Pain flag resolved!');
                loadJobs(); // Refresh
                if (currentJobId) openJobModal(currentJobId); // Reopen modal
            } else {
                alert('❌ Failed to resolve: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            console.error('Failed to resolve pain flag:', e);
            alert('❌ Error: ' + e.message);
        }
    }

    // --- EQUIPMENT ORDERING FUNCTIONS ---
    async function markEquipmentOrdered(jobId) {
        if (!confirm('Mark equipment as ordered for this job?\\n\\nThis will update the job record and help track ordering status.')) return;
        
        try {
            // Update job metadata with equipment_ordered flag
            const res = await fetchWithRetry(`${API_BASE}/admin_update_job`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: jobId,
                    metadata_updates: {
                        equipment_ordered: true,
                        equipment_ordered_at: new Date().toISOString(),
                        equipment_ordered_by: 'admin' // TODO: Get actual admin user
                    }
                })
            });
            
            const data = await res.json();
            if (data.ok) {
                alert('✅ Equipment marked as ordered!');
                loadJobs(); // Refresh job list
                if (currentJobId) openJobModal(currentJobId); // Reopen modal to show updated status
            } else {
                alert('❌ Failed to mark as ordered: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            console.error('Failed to mark equipment as ordered:', e);
            alert('❌ Error updating equipment status: ' + e.message);
        }
    }
    
    async function markEquipmentUnordered(jobId) {
        if (!confirm('Undo equipment ordering?\\n\\nThis will clear the ordering timestamp.')) return;
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_update_job`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: jobId,
                    metadata_updates: {
                        equipment_ordered: false,
                        equipment_ordered_at: null,
                        equipment_ordered_by: null
                    }
                })
            });
            
            const data = await res.json();
            if (data.ok) {
                alert('✅ Equipment ordering status cleared!');
                loadJobs();
                if (currentJobId) openJobModal(currentJobId);
            } else {
                alert('❌ Failed to undo: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            console.error('Failed to undo equipment ordering:', e);
            alert('❌ Error updating status: ' + e.message);
        }
    }
    
    async function saveEquipmentNotes(jobId) {
        const notesField = document.getElementById(`equipment-notes-${jobId}`);
        if (!notesField) return;
        
        const notes = notesField.value.trim();
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_update_job`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: jobId,
                    metadata_updates: {
                        equipment_notes: notes
                    }
                })
            });
            
            const data = await res.json();
            if (data.ok) {
                alert('✅ Notes saved!');
                loadJobs();
            } else {
                alert('❌ Failed to save notes: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            console.error('Failed to save equipment notes:', e);
            alert('❌ Error saving notes: ' + e.message);
        }
    }

    // --- ORDER PLAN GENERATION ---
    async function generateOrderPlan(jobId) {
        if (!confirm('Generate order plan for this job?')) return;
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/generate_order_plan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: jobId,
                    admin_user: 'admin',
                    admin_name: 'Admin'
                })
            });
            
            const data = await res.json();
            if (data.ok) {
                alert(`✅ Order plan generated!\n\nKit: ${data.order_plan.kit_type}\nComponents: ${data.order_plan.components.length}\nEstimate: $${(data.order_plan.total_cost_estimate / 100).toFixed(2)}`);
                loadJobs(); // Refresh
                if (currentJobId) openJobModal(currentJobId); // Reopen modal
            } else {
                alert('❌ Failed to generate: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            console.error('Failed to generate order plan:', e);
            alert('❌ Error: ' + e.message);
        }
    }

    // --- INSTALL DETAILS UPDATE ---
    async function updateInstallDetails(jobId) {
        const job = currentJobs.find(j => j.job_id === jobId);
        if (!job) return;
        
        const meta = job.metadata || {};
        
        // Prompt for details
        const wireManagement = prompt(`Wire Management Level:\n\n1. NONE\n2. BASIC_CONCEAL\n3. CONCEAL_RACEWAY\n4. FULL_INWALL\n5. UNKNOWN\n\nCurrent: ${meta.wire_management_required || 'UNKNOWN'}\n\nEnter 1-5:`, 
            meta.wire_management_required === 'NONE' ? '1' :
            meta.wire_management_required === 'BASIC_CONCEAL' ? '2' :
            meta.wire_management_required === 'CONCEAL_RACEWAY' ? '3' :
            meta.wire_management_required === 'FULL_INWALL' ? '4' : '5'
        );
        
        if (wireManagement === null) return; // Cancelled
        
        const wireOptions = ['', 'NONE', 'BASIC_CONCEAL', 'CONCEAL_RACEWAY', 'FULL_INWALL', 'UNKNOWN'];
        const wireValue = wireOptions[parseInt(wireManagement)] || 'UNKNOWN';
        
        const wallType = prompt(`Wall Type:\n\n1. DRYWALL\n2. BRICK\n3. PLASTER\n4. TILE\n5. CONCRETE\n6. WOOD\n7. UNKNOWN\n\nCurrent: ${meta.wall_type || 'UNKNOWN'}\n\nEnter 1-7:`,
            meta.wall_type === 'DRYWALL' ? '1' :
            meta.wall_type === 'BRICK' ? '2' :
            meta.wall_type === 'PLASTER' ? '3' :
            meta.wall_type === 'TILE' ? '4' :
            meta.wall_type === 'CONCRETE' ? '5' :
            meta.wall_type === 'WOOD' ? '6' : '7'
        );
        
        if (wallType === null) return; // Cancelled
        
        const wallOptions = ['', 'DRYWALL', 'BRICK', 'PLASTER', 'TILE', 'CONCRETE', 'WOOD', 'UNKNOWN'];
        const wallValue = wallOptions[parseInt(wallType)] || 'UNKNOWN';
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/update_install_details`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: jobId,
                    wire_management_required: wireValue,
                    wall_type: wallValue,
                    admin_user: 'admin',
                    admin_name: 'Admin'
                })
            });
            
            const data = await res.json();
            if (data.ok) {
                const flagsResolved = (meta.pain_flags?.length || 0) - (data.pain_flags?.length || 0);
                alert(`✅ Install details updated!\n\n${flagsResolved > 0 ? `${flagsResolved} pain flags resolved!` : 'Pain flags re-evaluated.'}`);
                loadJobs(); // Refresh
                if (currentJobId) openJobModal(currentJobId); // Reopen modal
            } else {
                alert('❌ Failed to update: ' + (data.error || 'Unknown error'));
            }
        } catch (e) {
            console.error('Failed to update install details:', e);
            alert('❌ Error: ' + e.message);
        }
    }

    function closeModal() {
        document.getElementById('job-modal').classList.remove('active');
    }

    function copySelectedItems() {
        const job = currentJobs.find(j => j.job_id === currentJobId);
        if (!job || !job.purchasing_suggestions) return;

        const selected = [];
        job.purchasing_suggestions.forEach((item, idx) => {
            const checkbox = document.getElementById(`check-${idx}`);
            if (checkbox && checkbox.checked) {
                selected.push(`- ${item.item_name} (${item.why_needed})`);
            }
        });

        if (selected.length > 0) {
            const text = `Order List for Job ${currentJobId}:\n${selected.join('\n')}`;
            navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
        }
    }

    // --- DISPATCH WORKFLOW ---
    async function openDispatchWorkflow() {
        const modal = document.getElementById('dispatch-modal');
        const select = document.getElementById('pro-select');
        
        modal.classList.add('active');
        select.innerHTML = '<option value="">Loading pros...</option>';
        
        try {
            // Fetch all pros for manual assignment
            const res = await fetchWithRetry(`${API_BASE}/admin_pros_list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN })
            });
            
            const data = await res.json();
            if (data.ok && data.pros) {
                select.innerHTML = '<option value="">Select a Pro...</option>' + 
                    data.pros.map(pro => `
                        <option value="${pro.pro_id}" data-name="${pro.name || pro.pro_name}">
                            ${pro.name || pro.pro_name} ${pro.status ? `(${pro.status})` : ''}
                        </option>
                    `).join('');
            } else {
                select.innerHTML = '<option value="">Failed to load pros</option>';
            }
        } catch (e) {
            console.error('Failed to load pros:', e);
            select.innerHTML = '<option value="">Error loading pros</option>';
        }
    }

    function closeDispatchModal() {
        document.getElementById('dispatch-modal').classList.remove('active');
    }

    async function confirmDispatch() {
        const select = document.getElementById('pro-select');
        const proId = select.value;
        const proName = select.options[select.selectedIndex]?.dataset.name || 'Unknown Pro';
        
        if (!proId) {
            alert('Please select a Pro');
            return;
        }
        
        const btn = document.querySelector('#dispatch-modal .btn-primary');
        const originalText = btn.innerText;
        btn.innerText = 'Assigning...';
        btn.disabled = true;
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_dispatch`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN,
                    job_id: currentJobId,
                    action: 'assign',
                    pro_id: proId,
                    pro_name: proName
                })
            });
            
            const data = await res.json();
            if (data.ok) {
                alert(`Job ${currentJobId} assigned to ${proName}!`);
                closeDispatchModal();
                closeModal();
                loadJobs(); // Refresh list
            } else {
                throw new Error(data.error || 'Assignment failed');
            }
        } catch (e) {
            alert('Failed to assign job: ' + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function markJobComplete() {
        if (!confirm('Are you sure you want to mark this job as completed?')) return;
        
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_update_status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN, 
                    job_id: currentJobId, 
                    status: 'completed' 
                })
            });
            const data = await res.json();
            
            if (data.ok) {
                alert('✅ Job marked as completed!');
                closeModal();
                loadJobs(); // Refresh list
            } else {
                throw new Error(data.error);
            }
        } catch (err) {
            console.error('Mark complete error:', err);
            alert('❌ Failed to mark job complete: ' + err.message);
        }
    }

    // --- PHOTO GALLERY ---

    async function loadJobPhotos(jobId, photoType = 'photo') {
        const cacheKey = `${jobId}_${photoType}`;
        
        // Check cache first
        const cached = jobCache.get(cacheKey, 'photos');
        if (cached) {
            console.log(`[loadJobPhotos] Using cached ${photoType} photos for job ${jobId}`);
            return cached;
        }
        
        try {
            // CUSTOMER PHOTOS: Use dedicated customer_photos endpoint (from bundles upload)
            if (photoType === 'customer_photo') {
                const res = await fetchWithRetry(`${API_BASE}/customer_photos?job_id=${encodeURIComponent(jobId)}&token=${encodeURIComponent(ADMIN_TOKEN)}`, {
                    method: 'GET'
                });
                const data = await res.json();
                
                if (data.ok && data.uploads) {
                    const photos = data.uploads || [];
                    console.log(`[loadJobPhotos] Loaded ${photos.length} customer photos for job ${jobId} from customer_photos API`);
                    
                    // Cache the result
                    jobCache.set(cacheKey, photos, 'photos');
                    
                    return photos;
                }
            }
            
            // TECH PHOTOS: Use artifacts endpoint (for completion photos)
            const res = await fetchWithRetry(`${API_BASE}/portal_get_artifacts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token: ADMIN_TOKEN,
                    admin_token: ADMIN_TOKEN,
                    job_id: jobId, 
                    type: photoType 
                })
            });
            const data = await res.json();
            
            if (data.ok) {
                const artifacts = data.artifacts || [];
                console.log(`[loadJobPhotos] Loaded ${artifacts.length} ${photoType} photos for job ${jobId}`);
                
                // Cache the result
                jobCache.set(cacheKey, artifacts, 'photos');
                
                return artifacts;
            } else {
                console.error('Failed to load photos:', data.error);
                return [];
            }
        } catch (err) {
            console.error('Photo fetch error:', err);
            return [];
        }
    }

    function openPhotoLightbox(photoUrl) {
        const lightbox = document.createElement('div');
        lightbox.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        `;
        
        const img = document.createElement('img');
        img.src = photoUrl;
        img.style.cssText = `
            max-width: 95%;
            max-height: 95vh;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        `;
        
        lightbox.appendChild(img);
        lightbox.onclick = () => lightbox.remove();
        document.body.appendChild(lightbox);
    }

    // --- PAYOUTS LOGIC ---

    function showConfirmationModal(title, message, onConfirm, isDestructive = false) {
        // Remove existing modal if any
        const existing = document.getElementById('confirm-modal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.id = 'confirm-modal';
        modal.className = 'modal-overlay active';
        modal.style.zIndex = '9999';
        
        modal.innerHTML = `
            <div class="modal" style="max-width:400px; text-align:center; padding:30px">
                <div style="font-size:48px; margin-bottom:16px">${isDestructive ? '⚠️' : '❓'}</div>
                <h2 style="font-size:20px; font-weight:700; color:#fff; margin-bottom:12px">${title}</h2>
                <p style="color:var(--text-muted); margin-bottom:24px; line-height:1.5">${message}</p>
                <div style="display:flex; gap:12px; justify-content:center">
                    <button class="btn btn-ghost" id="confirm-cancel" style="border:1px solid var(--border)">Cancel</button>
                    <button class="btn ${isDestructive ? 'btn-danger' : 'btn-primary'}" id="confirm-ok" style="${!isDestructive ? 'background:var(--brand-green); border:none' : ''}">
                        ${isDestructive ? 'Reject' : 'Confirm'}
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        const close = () => modal.remove();

        document.getElementById('confirm-cancel').onclick = close;
        document.getElementById('confirm-ok').onclick = () => {
            close();
            onConfirm();
        };
        
        // Close on background click
        modal.onclick = (e) => {
            if (e.target === modal) close();
        };
    }

    async function approvePayout(payoutId) {
        showConfirmationModal(
            'Approve Payout?',
            'This will mark the payout as approved and visible to the pro. They will be able to withdraw these funds.',
            () => updatePayoutStatus(payoutId, 'approve'),
            false
        );
    }

    async function rejectPayout(payoutId) {
        showConfirmationModal(
            'Reject Payout?',
            'Are you sure you want to reject this payout? This action cannot be easily undone.',
            () => updatePayoutStatus(payoutId, 'reject'),
            true
        );
    }

    async function updatePayoutStatus(payoutId, action) {
        // Disable approve button during request
        const approveBtn = document.querySelector(`button[onclick*="approvePayout('${payoutId}')"]`);
        const originalText = approveBtn?.textContent;
        if (approveBtn && action === 'approve') {
            approveBtn.disabled = true;
            approveBtn.style.opacity = '0.6';
            approveBtn.style.cursor = 'not-allowed';
            approveBtn.textContent = 'Approving...';
        }

        try {
            console.log(`[PAYOUT] Updating ${payoutId} to ${action}...`);
            const res = await fetchWithRetry(`${API_BASE}/admin_approve_payout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN, payout_id: payoutId, action })
            });
            const data = await res.json();
            if (data.ok) {
                console.log('[PAYOUT] Success:', data.message || 'Updated');
                
                // Show success feedback with notification status
                const actionText = action === 'approve' ? 'approved' : 'rejected';
                let toastMessage = `✅ Payout ${actionText} successfully`;
                
                if (action === 'approve' && data.notification) {
                    if (data.notification.sent) {
                        toastMessage += ' • Tech notified';
                    } else if (data.notification.skipped) {
                        toastMessage += ' • Tech notification skipped (already sent)';
                    } else if (data.notification.error) {
                        toastMessage += ' • Tech notify failed: ' + data.notification.error;
                    }
                }
                
                showToast(toastMessage, 'success');
                
                // Refresh both payouts list and metrics (to update top performers)
                await Promise.all([
                    loadPayouts(),
                    loadMetrics()
                ]);
            } else {
                throw new Error(data.error);
            }
        } catch (err) {
            console.error('Payout update error:', err);
            alert('❌ Failed to update payout: ' + err.message);
        } finally {
            // Re-enable button
            if (approveBtn && action === 'approve') {
                approveBtn.disabled = false;
                approveBtn.style.opacity = '1';
                approveBtn.style.cursor = 'pointer';
                if (originalText) approveBtn.textContent = originalText;
            }
        }
    }

    // Toast notification helper
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: ${type === 'success' ? 'var(--brand-green)' : 'var(--brand-red)'};
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Load payout preview image
    async function loadPayoutPreview(jobId) {
        const container = document.getElementById(`payout-preview-${jobId}`);
        container.innerHTML = '<div style="font-size:9px">Loading...</div>';
        
        try {
            const photos = await loadJobPhotos(jobId, 'photo');
            if (photos && photos.length > 0) {
                container.innerHTML = `<img src="${photos[0]}" style="width:100%; height:100%; object-fit:cover; border-radius:6px" alt="Job photo">`;
            } else {
                container.innerHTML = '<div style="font-size:9px; color:var(--text-muted)">No photos</div>';
            }
        } catch (e) {
            container.innerHTML = '<div style="font-size:9px; color:#ef4444">Failed</div>';
        }
    }

    // Connection status updater
    function updateConnectionUI() {
        const indicator = document.getElementById('connection-status');
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');
        
        if (connectionStatus === 'online') {
            dot.style.background = 'var(--brand-green)';
            text.textContent = 'Connected';
            indicator.style.opacity = '0';
        } else if (connectionStatus === 'degraded') {
            dot.style.background = 'var(--brand-gold)';
            text.textContent = 'Slow Connection';
            indicator.style.opacity = '1';
        } else {
            dot.style.background = '#ef4444';
            text.textContent = 'Offline';
            indicator.style.opacity = '1';
        }
    }

    // Monitor connection health
    setInterval(() => {
        checkConnection();
        updateConnectionUI();
    }, 30000); // Check every 30 seconds

    // --- CHARTS RENDERING ---
    let chartInstances = {};
    
    function renderCharts(data) {
        document.getElementById('charts-section').classList.remove('hidden');
        
        // Destroy existing charts
        Object.values(chartInstances).forEach(chart => chart?.destroy());
        chartInstances = {};
        
        // Revenue Trend Chart (last 30 days from backend)
        const revCtx = document.getElementById('revenueChart')?.getContext('2d');
        if (revCtx) {
            const trend = Array.isArray(data?.revenue?.trend) ? data.revenue.trend : [];
            let days = trend.map(t => String(t?.date || '').slice(5));
            let revenue = trend.map(t => Number(t?.total || 0));

            if (!days.length || days.length !== revenue.length) {
                // Fallback: render deterministic zeros (no random placeholders)
                days = Array.from({length: 30}, (_, i) => {
                    const d = new Date(Date.now() - (29 - i) * 24 * 60 * 60 * 1000);
                    return d.toISOString().slice(5, 10);
                });
                revenue = Array.from({length: 30}, () => 0);
            }
            
            chartInstances.revenue = new Chart(revCtx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Revenue',
                        data: revenue,
                        borderColor: '#1493FF',
                        backgroundColor: 'rgba(20, 147, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8', maxRotation: 0 },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // Job Status Pie Chart
        const statusCtx = document.getElementById('jobStatusChart')?.getContext('2d');
        if (statusCtx) {
            chartInstances.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'Pending', 'Assigned'],
                    datasets: [{
                        data: [
                            data.operations?.jobs_completed || 0,
                            data.operations?.jobs_pending || 0,
                            (data.operations?.bottlenecks?.length || 0)
                        ],
                        backgroundColor: ['#22C96F', '#FFC857', '#1493FF'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 15 }
                        }
                    }
                }
            });
        }
        
        // Capacity Bar Chart
        const capCtx = document.getElementById('capacityChart')?.getContext('2d');
        if (capCtx) {
            const util = data.capacity?.utilization_pct || 0;
            chartInstances.capacity = new Chart(capCtx, {
                type: 'bar',
                data: {
                    labels: ['Current Load', 'Available'],
                    datasets: [{
                        label: 'Capacity %',
                        data: [util, 100 - util],
                        backgroundColor: [util > 80 ? '#FFC857' : '#22C96F', '#334155']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { 
                            max: 100,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    }
                }
            });
        }
        
        // Pricing Tier Pie (BYO vs H2S Premium only)
        const priceCtx = document.getElementById('pricingChart')?.getContext('2d');
        if (priceCtx) {
            chartInstances.pricing = new Chart(priceCtx, {
                type: 'pie',
                data: {
                    labels: ['BYO (Bring Your Own)', 'H2S Premium'],
                    datasets: [{
                        data: [
                            data.pricing?.byo?.jobs || 1,
                            data.pricing?.h2s?.jobs || 1
                        ],
                        backgroundColor: ['#FFC857', '#22C96F']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#94a3b8', padding: 15 }
                        }
                    }
                }
            });
        }
    }

    // --- PAYOUTS MANAGEMENT ---
    // ===== PAYOUT COCKPIT =====
    let currentPayoutWeek = null;
    let currentPayoutData = null;
    
    // Initialize week selector to current week
    function initWeekSelector() {
        const selector = document.getElementById('payout-week-selector');
        if (!selector) return;
        
        const today = new Date();
        const weekStart = getWeekStart(today);
        const year = weekStart.split('-')[0];
        const weekNum = getWeekNumber(new Date(weekStart));
        selector.value = `${year}-W${String(weekNum).padStart(2, '0')}`;
        currentPayoutWeek = weekStart;
    }
    
    function getWeekStart(date = new Date()) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(d.setDate(diff));
        monday.setHours(0, 0, 0, 0);
        return monday.toISOString().split('T')[0];
    }
    
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    async function loadPayouts() {
        const container = document.getElementById('payouts-container');
        const weekSelector = document.getElementById('payout-week-selector');
        const pendingContainer = document.getElementById('pending-approvals-container');
        const pendingMeta = document.getElementById('pending-approvals-meta');
        
        // Get selected week
        let weekStart = currentPayoutWeek;
        if (weekSelector && weekSelector.value) {
            // Parse ISO week format (YYYY-Www)
            const [year, week] = weekSelector.value.split('-W');
            const date = new Date(year, 0, 1 + (week - 1) * 7);
            weekStart = getWeekStart(date);
        } else {
            weekStart = weekStart || getWeekStart();
        }
        
        currentPayoutWeek = weekStart;
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">Loading payouts...</div>';
        if (pendingContainer) pendingContainer.innerHTML = '<div style="text-align:center; padding:24px; color:var(--text-muted)">Loading pending approvals...</div>';
        if (pendingMeta) pendingMeta.textContent = '';
        
        try {
            console.log('[PAYOUTS COCKPIT] Loading for week:', weekStart);
            
            // Use new cockpit endpoint
            const res = await fetchWithRetry(`${API_BASE}/admin_payouts_cockpit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    admin_token: ADMIN_TOKEN, 
                    week_start: weekStart 
                })
            });
            
            const data = await res.json();
            if (!data.ok) {
                throw new Error(data.error || 'Failed to load payouts');
            }
            
            currentPayoutData = data;
            
            // Update summary cards
            const summary = data.summary || {};
            document.getElementById('payout-pending-amount').textContent = `$${summary.total_pending?.toLocaleString() || '0'}`;
            document.getElementById('payout-pending-count').textContent = `${data.pros?.filter(p => p.status === 'pending').length || 0} pros`;
            document.getElementById('payout-approved-amount').textContent = `$${summary.total_approved?.toLocaleString() || '0'}`;
            document.getElementById('payout-approved-count').textContent = `${data.pros?.filter(p => p.status === 'approved').length || 0} pros`;
            document.getElementById('payout-week-total').textContent = `$${summary.week_total?.toLocaleString() || '0'}`;
            document.getElementById('payout-week-pros').textContent = `${summary.pros_count || 0} pros`;
            document.getElementById('payout-jobs-count').textContent = `${summary.jobs_count || 0}`;
            document.getElementById('payout-bonuses-count').textContent = `${summary.bonuses_count || 0} bonuses`;
            
            renderPayoutsCockpit(data.pros || []);

            // ALSO load job-level pending payouts so dispatch can approve specific jobs.
            try {
                const pendingRes = await fetchWithRetry(`${API_BASE}/admin_payouts_overview`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_token: ADMIN_TOKEN,
                        token: ADMIN_TOKEN,
                        status: 'pending'
                    })
                });
                const pendingData = await pendingRes.json();
                if (pendingData?.ok) {
                    renderPendingApprovals(pendingData.rows || [], pendingData.meta || {});
                } else {
                    renderPendingApprovals([], pendingData?.meta || {}, pendingData?.error || 'Failed to load pending payouts');
                }
            } catch (e) {
                renderPendingApprovals([], {}, e?.message || 'Failed to load pending payouts');
            }

            // IMPORTANT: The cockpit endpoint already returns the final pro-level rollups.
            // Stop here to avoid running legacy payout-list logic below.
            return;
            
            // Handle Jobs Response
            let jobsMap = {};
            if (jobsResult.status === 'fulfilled') {
                try {
                    const jobsData = await jobsResult.value.json();
                    if (jobsData.ok && jobsData.jobs) {
                        jobsData.jobs.forEach(j => {
                            jobsMap[j.job_id] = j;
                            // CACHE: Store in global cache for consistency with Jobs tab
                            jobCache.set(j.job_id, j, 'data');
                        });
                        
                        // DEBUG: Check what data we have for the first job
                        const sampleJob = jobsData.jobs[0];
                        if (sampleJob) {
                            console.log('[PAYOUTS] Sample job data:', {
                                job_id: sampleJob.job_id,
                                customer_name: sampleJob.customer_name,
                                service_address: sampleJob.service_address || sampleJob.address,
                                service_city: sampleJob.service_city || sampleJob.city,
                                metadata_exists: !!sampleJob.metadata,
                                metadata_items: sampleJob.metadata?.items_json?.length || 0
                            });
                        }
                    }
                } catch (e) { 
                    console.warn('[PAYOUTS] Failed to parse jobs data:', e);
                }
            } else {
                console.warn('[PAYOUTS] Failed to load jobs list:', jobsResult.reason);
            }
            
            // SERVICE NAME BUILDER: Extract ALL relevant details from items_json
            const buildServiceDescription = (itemsInput) => {
                let items = itemsInput;
                
                // Parse if string (fixes "Service Order" placeholder issue)
                if (typeof items === 'string') {
                    try {
                        items = JSON.parse(items);
                    } catch (e) {
                        return 'Service Order';
                    }
                }

                if (!items || !Array.isArray(items) || items.length === 0) return 'Service Order';
                
                const descriptions = [];
                
                items.forEach(item => {
                    if (!item || item.type === 'product') return; // Skip product line items (mount hardware)
                    
                    const meta = item.metadata || {};
                    let desc = '';
                    
                    // TV Multi Package
                    if (item.bundle_id === 'tv_multi' || item.service_name === 'tv_multi') {
                        const tvCount = meta.mounts_needed || item.qty || 1;
                        const tvSize = meta.tv_size || '';
                        const sizeText = tvSize ? tvSize.replace('-', '"-') + '"' : '';
                        const mountSource = meta.mount_provider === 'customer' ? 'BYO Mount' : 'H2S Mount';
                        desc = `${tvCount}x ${sizeText} TV Installation (${mountSource})`.trim();
                    }
                    // Security Camera Packages
                    else if (item.bundle_id === 'cam_premium' || item.service_name === 'cam_premium') {
                        desc = 'Premium Security Camera Installation';
                    }
                    else if (item.bundle_id === 'cam_basic' || item.service_name === 'cam_basic') {
                        desc = 'Basic Security Camera Installation';
                    }
                    // Single TV
                    else if (item.bundle_id === 'tv_single' || item.service_name === 'tv_single') {
                        const tvSize = meta.tv_size || '';
                        const sizeText = tvSize ? tvSize.replace('-', '"-') + '"' : '';
                        desc = `${sizeText} TV Mount Installation`.trim();
                    }
                    // Soundbar
                    else if (item.bundle_id === 'soundbar' || item.service_name === 'soundbar') {
                        desc = 'Soundbar Installation';
                    }
                    // Fallback: Clean up the raw name
                    else {
                        const rawName = item.service_name || item.bundle_id || item.service_id || '';
                        desc = rawName.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    }
                    
                    if (desc) descriptions.push(desc);
                });
                
                return descriptions.length > 0 ? descriptions.join(' + ') : 'Service Order';
            };
            
            // Merge data with pro name resolution from job assignments
            const payouts = (payoutsData.rows || []).map(p => {
                // Try to find job in current map, or fallback to global cache
                const job = jobsMap[p.job_id] || jobCache.get(p.job_id, 'data');
                
                // PRO NAME: Use job assignment data (already fetched by admin_jobs_list)
                let proName = job?.assigned_pro_name || job?.metadata?.pro_name || job?.metadata?.technician_name;
                
                // Final fallback
                if (!proName && p.pro_id) {
                    proName = `Pro ${String(p.pro_id).substring(0, 8)}`;
                } else if (!proName) {
                    proName = 'Pending Assignment';
                }
                
                // SERVICE NAME: Build detailed description from items_json
                const serviceName = buildServiceDescription(job?.metadata?.items_json || p.job_metadata?.items_json);
                
                // CUSTOMER NAME: ALWAYS extract from job or order data
                let customerName = job?.customer_name || job?.metadata?.customer_name || job?.customer_email?.split('@')[0] || p.customer_name || p.customer || 'Customer';
                if (customerName && customerName !== 'Customer') {
                    customerName = customerName.split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
                    ).join(' ');
                }
                
                return {
                    payout_id: p.payout_id || p.entry_id,
                    entry_id: p.entry_id,
                    job_id: p.job_id,
                    pro_name: proName,
                    pro_id: p.pro_id,
                    amount: Number(p.amount || p.total_amount || 0),
                    state: p.state || 'pending',
                    job_status: job?.status || 'unknown',
                    earned_at: p.created_at || p.earned_at || new Date().toISOString(),
                    job_details: {
                        service: serviceName,
                        customer: customerName,
                        address: job?.address || job?.metadata?.service_address || p.address || p.service_address || '',
                        city: job?.city || job?.metadata?.service_city || p.city || p.service_city || '',
                        state: job?.state || job?.metadata?.service_state || p.service_state || '',
                        zip: job?.zip || job?.metadata?.service_zip || p.zip || p.service_zip || '',
                        line_items: job?.metadata?.items_json || job?.line_items_json || p.job_metadata?.items_json || [],
                        metadata: job?.metadata || p.job_metadata || {}
                    }
                };
            });
            
            // Calculate pro stats for the UI
            const proStats = {};
            payouts.forEach(p => {
                if (!proStats[p.pro_name]) {
                    proStats[p.pro_name] = {
                        total_accepted: 0, 
                        total_completed: 0,
                        total_earnings: 0,
                        pending_earnings: 0,
                        approved_earnings: 0
                    };
                }
                proStats[p.pro_name].total_accepted++; 
                proStats[p.pro_name].total_completed++;
                proStats[p.pro_name].total_earnings += p.amount;
                if (p.state === 'pending') proStats[p.pro_name].pending_earnings += p.amount;
                if (p.state === 'approved') proStats[p.pro_name].approved_earnings += p.amount;
            });
            
            // Attach pro stats
            payouts.forEach(p => {
                p.pro_stats = proStats[p.pro_name];
            });
            
            console.log('[PAYOUTS] Found', payouts.length, 'payouts ready for approval');
            currentPayouts = payouts; // Store globally for modal access
            renderPayouts(payouts, filter);
            
        } catch (err) {
            console.error('[PAYOUTS] Error:', err);
            container.innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Unable to Load Payouts</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="loadPayouts()">Retry</button>
                </div>
            `;
        }
    }

    function parsePayoutDate(row) {
        const candidates = [row?.created_at, row?.earned_at, row?.updated_at, row?.approved_at, row?.completed_at];
        for (const v of candidates) {
            const ms = Date.parse(String(v || ''));
            if (!Number.isNaN(ms)) return ms;
        }
        return null;
    }

    function escapeHtml(str) {
        return String(str ?? '').replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c] || c));
    }

    function getArtifactUrl(artifact) {
        if (!artifact) return '';
        return artifact.url || artifact.file_url || artifact.photo_url || artifact.public_url || artifact.signed_url || artifact.href || '';
    }

    async function getJobData(jobId) {
        if (!jobId) return null;

        // Single source of truth: cache
        let job = jobCache.get(jobId, 'data');
        if (job) return job;

        // Fallback: in-memory list
        job = currentJobs.find(j => j.job_id === jobId);
        if (job) {
            jobCache.set(jobId, job, 'data');
            return job;
        }

        // Fallback: fetch jobs list and locate
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_jobs_list`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: ADMIN_TOKEN, status: 'all', days: 180 })
            });
            const data = await res.json();
            if (data?.ok && Array.isArray(data.jobs)) {
                job = data.jobs.find(j => j.job_id === jobId);
                if (job) {
                    // Normalize address fields for consistent rendering
                    const addr = job.address || job.service_address || job.metadata?.service_address || job.metadata?.address || job.location || job.metadata?.location || '';
                    const city = job.city || job.service_city || job.metadata?.service_city || job.metadata?.city || '';
                    const state = job.state || job.service_state || job.metadata?.service_state || job.metadata?.state || '';
                    const zip = job.zip || job.service_zip || job.metadata?.service_zip || job.metadata?.zip || '';
                    job.display_address = addr;
                    job.display_city = city;
                    job.display_state = state;
                    job.display_zip = zip;
                    jobCache.set(jobId, job, 'data');
                    return job;
                }
            }
        } catch (e) {
            console.warn('[getJobData] failed:', e);
        }

        return null;
    }

    // =====================================================
    // SERVICE SUMMARY BUILDER (copied from portal.html)
    // =====================================================
    function buildServiceSummary(lineItems, description, cameraDetails) {
        function escHtml(s) {
            return String(s || '').replace(/[<>&"]/g, c => ({"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;"}[c]));
        }
        
        const out = { summary: '', bulletsHtml: '' };
        
        // Camera install details
        if (cameraDetails && cameraDetails.is_camera_install) {
            const bullets = [];
            
            if (cameraDetails.camera_count > 0) {
                bullets.push(`• ${cameraDetails.camera_count} Camera${cameraDetails.camera_count > 1 ? 's' : ''}`);
            }
            
            if (cameraDetails.coverage_type && cameraDetails.coverage_type !== 'Unknown') {
                bullets.push(`• Coverage: ${escHtml(cameraDetails.coverage_type)}`);
            }
            
            if (cameraDetails.equipment_mode && cameraDetails.equipment_mode !== 'Unknown') {
                const equipIcon = cameraDetails.equipment_mode === 'Equipment Provided' ? '' : 
                                  cameraDetails.equipment_mode === 'Customer-Supplied' ? '🔧' : '❓';
                bullets.push(`• ${equipIcon} ${escHtml(cameraDetails.equipment_mode)}`);
            }
            
            if (cameraDetails.install_requirements && cameraDetails.install_requirements.length > 0) {
                cameraDetails.install_requirements.forEach(req => {
                    bullets.push(`• ${escHtml(req)}`);
                });
            }
            
            if (cameraDetails.equipment_mode === 'Check with customer') {
                bullets.push(`• <span style="color:#FFC857;font-weight:600">⚠️ Pre-call required: Confirm equipment</span>`);
            }
            
            out.summary = `${cameraDetails.camera_count} Camera Install - ${cameraDetails.coverage_type}`;
            out.bulletsHtml = bullets.join('<br>');
            return out;
        }
        
        if (!Array.isArray(lineItems) || lineItems.length === 0) {
            out.summary = description ? description.split('\n')[0].slice(0, 120) : '';
            out.bulletsHtml = out.summary ? `• ${escHtml(out.summary)}` : '';
            return out;
        }
        
        const groups = {
            tv: { label: 'TV', count: 0, sizes: [] },
            mount: { label: 'Mount', count: 0 },
            soundbar: { label: 'Soundbar', count: 0 },
            camera: { label: 'Camera', count: 0 },
            doorbell: { label: 'Doorbell', count: 0 },
            thermostat: { label: 'Thermostat', count: 0 },
            outlet: { label: 'Outlet', count: 0 },
            wiring: { label: 'Wiring', count: 0 }
        };
        
        const sizeRe = /(\d{2,3})\s*(?:"|in|inch|inches)/i;
        
        lineItems.forEach(it => {
            const qty = Number(it.qty || it.quantity || 1) || 1;
            let nameSource = it.title || it.name || it.sku || '';
            if (nameSource.toLowerCase() === 'service' && it.service_id) {
                nameSource = it.service_id;
            }
            const name = (nameSource || '').toLowerCase();
            if (!name) return;
            const sizeMatch = name.match(sizeRe);
            if (name.includes('tv')) {
                groups.tv.count += qty;
                if (sizeMatch) groups.tv.sizes.push(sizeMatch[1]);
                return;
            }
            if (name.includes('sound')) { groups.soundbar.count += qty; return; }
            if (name.includes('mount')) { groups.mount.count += qty; return; }
            if (name.includes('camera')) { groups.camera.count += qty; return; }
            if (name.includes('doorbell')) { groups.doorbell.count += qty; return; }
            if (name.includes('thermostat')) { groups.thermostat.count += qty; return; }
            if (name.includes('outlet')) { groups.outlet.count += qty; return; }
            if (name.includes('wire') || name.includes('ethernet') || name.includes('cable')) { groups.wiring.count += qty; return; }
        });
        
        const parts = [];
        const bullets = [];
        const push = (g, suffix = '') => {
            if (g.count > 0) parts.push(`${g.count} ${g.label}${g.count > 1 ? 's' : ''}${suffix}`);
            if (g.count > 0) bullets.push(`• ${g.count} ${g.label}${g.count > 1 ? 's' : ''}${suffix}`);
        };
        if (groups.tv.count) {
            const sizes = groups.tv.sizes.length ? ` (${[...new Set(groups.tv.sizes)].join('", ')}")` : '';
            push(groups.tv, sizes);
        }
        ['mount','soundbar','camera','doorbell','thermostat','outlet','wiring'].forEach(k => push(groups[k]));
        
        out.summary = parts.join(' • ');
        out.bulletsHtml = bullets.map(escHtml).join('<br>');
        return out;
    }

    function buildJobSummaryHtml(job) {
        if (!job) return '<div style="color:var(--text-muted)">Job not found.</div>';
        const serviceName = job.formatted_service_name || job.service_name || 'Service Order';
        const customerName = job.customer_name || job.metadata?.customer_name || job.customer_email || 'Customer';
        const customerPhone = job.customer_phone || job.metadata?.customer_phone || '';
        const address = job.display_address || job.address || job.service_address || job.metadata?.service_address || '';
        const city = job.display_city || job.city || job.service_city || job.metadata?.service_city || '';
        const state = job.display_state || job.state || job.service_state || job.metadata?.service_state || '';
        const zip = job.display_zip || job.zip || job.service_zip || job.metadata?.service_zip || '';
        const status = job.status || 'unknown';
        
        // Extract camera details if available
        const cameraDetails = job.camera_details || null;
        const lineItems = job.line_items || job.metadata?.items_json || [];
        const description = job.description || job.metadata?.description || '';
        
        // Build service summary with camera details
        const summary = buildServiceSummary(lineItems, description, cameraDetails);

        const line1 = [address, city && `${city}`, state && `${state}`, zip && `${zip}`].filter(Boolean).join(', ').replace(/, ,/g, ', ');
        const when = new Date(job.start_iso || job.created_at || Date.now()).toLocaleString();

        return `
            <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-start">
                <div style="min-width:240px">
                    <div style="font-weight:700; color:#f1f5f9; margin-bottom:6px">${escapeHtml(summary.summary || serviceName)}</div>
                    ${summary.bulletsHtml ? `<div style="color:#cbd5e1; font-size:12px; margin-bottom:8px; line-height:1.6">${summary.bulletsHtml}</div>` : ''}
                    <div style="color:#cbd5e1; font-size:13px; margin-bottom:4px">
                        ${escapeHtml(customerName)}${customerPhone ? ` • ${escapeHtml(customerPhone)}` : ''}
                    </div>
                    <div style="color:var(--text-muted); font-size:12px">${escapeHtml(line1 || 'No address provided')}</div>
                    <div style="color:var(--text-muted); font-size:12px; margin-top:4px">${escapeHtml(when)} • Status: ${escapeHtml(status)}</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
                    <button class="btn btn-ghost" style="padding:6px 12px; font-size:12px" onclick="viewPayoutDetails(${JSON.stringify(String(job.job_id))})">Open Full</button>
                </div>
            </div>
        `;
    }

    async function togglePendingApprovalDetails(payoutId, jobId) {
        const payoutIdSafe = String(payoutId || '').replace(/[^a-zA-Z0-9_-]/g, '_');
        const rowEl = document.getElementById(`pending-row-${payoutIdSafe}`);
        if (!rowEl) return;

        const existing = document.getElementById(`pending-details-${payoutIdSafe}`);
        if (existing) {
            existing.remove();
            return;
        }

        const detailsRow = document.createElement('tr');
        detailsRow.id = `pending-details-${payoutIdSafe}`;
        detailsRow.innerHTML = `
            <td colspan="5" style="padding:0; background:rgba(15,23,42,0.35); border-bottom:1px solid rgba(71,85,105,0.2);">
                <div style="padding:16px 14px">
                    <div style="color:var(--text-muted)">Loading job details + artifacts...</div>
                </div>
            </td>
        `;
        rowEl.insertAdjacentElement('afterend', detailsRow);

        if (!jobId) {
            detailsRow.querySelector('div').innerHTML = '<div style="color:var(--text-muted)">No job_id on this payout row.</div>';
            return;
        }

        const host = detailsRow.querySelector('div');
        try {
            const job = await getJobData(jobId);
            host.innerHTML = `
                <div style="background:rgba(2,6,23,0.35); border:1px solid rgba(71,85,105,0.25); border-radius:12px; padding:14px">
                    ${buildJobSummaryHtml(job)}
                    <div style="margin-top:12px; display:grid; grid-template-columns: 1fr; gap:12px">
                        <div>
                            <div style="font-weight:700; font-size:12px; color:var(--text-muted); text-transform:uppercase; margin-bottom:8px">Customer Photos</div>
                            <div id="pending-photos-customer-${payoutIdSafe}" style="display:flex; gap:10px; flex-wrap:wrap"></div>
                        </div>
                        <div>
                            <div style="font-weight:700; font-size:12px; color:var(--text-muted); text-transform:uppercase; margin-bottom:8px">Technician Photos</div>
                            <div id="pending-photos-tech-${payoutIdSafe}" style="display:flex; gap:10px; flex-wrap:wrap"></div>
                        </div>
                    </div>
                </div>
            `;

            const [cust, tech] = await Promise.all([
                loadJobPhotos(jobId, 'customer_photo'),
                loadJobPhotos(jobId, 'photo')
            ]);

            const renderThumbs = (containerId, artifacts) => {
                const el = document.getElementById(containerId);
                if (!el) return;
                const list = Array.isArray(artifacts) ? artifacts : [];
                if (!list.length) {
                    el.innerHTML = '<div style="color:var(--text-muted); font-size:12px">No images found.</div>';
                    return;
                }
                el.innerHTML = list.map(a => {
                    const url = getArtifactUrl(a);
                    if (!url) return '';
                    return `
                        <img src="${escapeHtml(url)}" style="width:110px; height:80px; object-fit:cover; border-radius:10px; border:1px solid rgba(71,85,105,0.35); cursor:pointer" onclick="openPhotoLightbox(${JSON.stringify(String(url))})" />
                    `;
                }).join('');
            };

            renderThumbs(`pending-photos-customer-${payoutIdSafe}`, cust);
            renderThumbs(`pending-photos-tech-${payoutIdSafe}`, tech);
        } catch (e) {
            console.error('[pending details] failed:', e);
            host.innerHTML = `<div style="color:var(--text-muted)">Failed to load details: ${escapeHtml(e?.message || String(e))}</div>`;
        }
    }

    function renderPendingApprovals(rows, meta = {}, errorMsg = '') {
        const container = document.getElementById('pending-approvals-container');
        const metaEl = document.getElementById('pending-approvals-meta');
        if (!container) return;

        const normalized = (rows || []).map(r => {
            const payout_id = r.payout_id || r.entry_id || r.id || '';
            const job_id = r.job_id || r.dispatch_job_id || r.work_order_id || '';
            const pro_id = r.pro_id || r.tech_id || r.assigned_pro_id || r.pro_email || r.email || '';
            const amount = Number(r.amount || r.total_amount || 0) || 0;
            const createdMs = parsePayoutDate(r);
            return { ...r, payout_id, job_id, pro_id, amount, _createdMs: createdMs };
        }).filter(r => String(r.payout_id || '').trim());

        // Oldest pending first (longest waiting gets priority)
        normalized.sort((a, b) => {
            const am = a._createdMs ?? Number.POSITIVE_INFINITY;
            const bm = b._createdMs ?? Number.POSITIVE_INFINITY;
            if (am !== bm) return am - bm;
            return Number(b.amount || 0) - Number(a.amount || 0);
        });

        if (metaEl) {
            const src = meta?.source_table ? `source: ${meta.source_table}` : 'source: unknown';
            const count = normalized.length;
            metaEl.textContent = errorMsg ? `⚠️ ${errorMsg} (${src})` : `${count} pending payout${count === 1 ? '' : 's'} • ${src}`;
        }

        if (!normalized.length) {
            container.innerHTML = '<div style="text-align:center; padding:24px; color:var(--text-muted)">No pending payouts found.</div>';
            return;
        }

        container.innerHTML = `
            <table style="width:100%; border-collapse:collapse">
                <thead>
                    <tr style="background:rgba(255,200,87,0.08); border-bottom:1px solid rgba(255,200,87,0.25);">
                        <th style="padding:14px; text-align:left; font-size:12px; font-weight:700; text-transform:uppercase; color:var(--brand-gold)">Job</th>
                        <th style="padding:14px; text-align:left; font-size:12px; font-weight:700; text-transform:uppercase; color:var(--brand-gold)">Pro</th>
                        <th style="padding:14px; text-align:right; font-size:12px; font-weight:700; text-transform:uppercase; color:var(--brand-gold)">Amount</th>
                        <th style="padding:14px; text-align:left; font-size:12px; font-weight:700; text-transform:uppercase; color:var(--brand-gold)">Waiting Since</th>
                        <th style="padding:14px; text-align:right; font-size:12px; font-weight:700; text-transform:uppercase; color:var(--brand-gold)">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${normalized.map((p, idx) => {
                        const rowBg = idx % 2 === 0 ? 'rgba(15,23,42,0.3)' : 'rgba(15,23,42,0.5)';
                        const when = p._createdMs ? new Date(p._createdMs).toLocaleString() : 'Unknown';
                        const jobIdSafe = escapeHtml(p.job_id || '');
                        const proSafe = escapeHtml(p.pro_id || '');
                        const payoutIdRaw = String(p.payout_id || '');
                        const payoutIdSafe = escapeHtml(payoutIdRaw).replace(/[^a-zA-Z0-9_-]/g, '_');
                        const payoutIdArg = JSON.stringify(payoutIdRaw);
                        const jobIdArg = JSON.stringify(String(p.job_id || ''));
                        return `
                        <tr id="pending-row-${payoutIdSafe}" style="background:${rowBg}; border-bottom:1px solid rgba(71,85,105,0.2);">
                            <td style="padding:14px; color:#f1f5f9; font-weight:600; font-family:monospace; font-size:12px">
                                <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap">
                                    <span>${jobIdSafe}</span>
                                    <button class="btn btn-ghost" onclick="togglePendingApprovalDetails(${payoutIdArg}, ${jobIdArg})" style="padding:4px 10px; font-size:11px">View</button>
                                </div>
                            </td>
                            <td style="padding:14px; color:#94a3b8; font-size:12px">${proSafe}</td>
                            <td style="padding:14px; text-align:right; color:#f1f5f9; font-weight:700">$${Number(p.amount || 0).toFixed(2)}</td>
                            <td style="padding:14px; color:#94a3b8; font-size:12px">${when}</td>
                            <td style="padding:14px; text-align:right;">
                                <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap">
                                    <button class="btn btn-success" onclick="approvePayoutById(${payoutIdArg}, ${jobIdArg})" style="padding:6px 12px; font-size:12px;">Approve</button>
                                    <button class="btn btn-ghost" onclick="rejectPayoutById(${payoutIdArg}, ${jobIdArg})" style="padding:6px 12px; font-size:12px;">Reject</button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    async function approvePayoutById(payoutId, jobId) {
        if (!payoutId) return;
        if (!confirm(`Approve payout for job ${jobId || payoutId}?`)) return;
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_approve_payout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_token: ADMIN_TOKEN,
                    payout_id: payoutId,
                    action: 'approve'
                })
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Approve failed');
            showToast(`✅ Approved payout (${jobId || payoutId})`, 'success');
            await loadPayouts();
            // Update jobs list indicators too
            try { await loadJobs(); } catch {}
        } catch (e) {
            console.error('Approve payout error:', e);
            alert('❌ Failed to approve payout: ' + (e?.message || e));
        }
    }

    async function rejectPayoutById(payoutId, jobId) {
        if (!payoutId) return;
        if (!confirm(`Reject payout for job ${jobId || payoutId}?`)) return;
        try {
            const res = await fetchWithRetry(`${API_BASE}/admin_approve_payout`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_token: ADMIN_TOKEN,
                    payout_id: payoutId,
                    action: 'reject'
                })
            });
            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Reject failed');
            showToast(`✅ Rejected payout (${jobId || payoutId})`, 'info');
            await loadPayouts();
            try { await loadJobs(); } catch {}
        } catch (e) {
            console.error('Reject payout error:', e);
            alert('❌ Failed to reject payout: ' + (e?.message || e));
        }
    }

    function renderPayoutsCockpit(pros) {
        const container = document.getElementById('payouts-container');
        const statusFilter = document.getElementById('payout-status-filter')?.value || 'all';
        const proFilter = document.getElementById('payout-filter')?.value || 'all';
        const searchTerm = document.getElementById('payout-search')?.value?.toLowerCase() || '';
        
        // Apply filters
        let filtered = pros;
        if (statusFilter !== 'all') {
            filtered = filtered.filter(p => p.status === statusFilter);
        }
        if (proFilter === 'active') {
            filtered = filtered.filter(p => p.is_active !== false);
        }
        if (searchTerm) {
            filtered = filtered.filter(p => 
                p.pro_name.toLowerCase().includes(searchTerm) || 
                p.pro_email?.toLowerCase().includes(searchTerm)
            );
        }

        // Intelligent default ordering:
        // 1) Pending first
        // 2) Within pending, longest-waiting first (oldest_pending_at ascending)
        // 3) Tie-breaker: highest total due
        filtered.sort((a, b) => {
            const aPending = a.status === 'pending';
            const bPending = b.status === 'pending';
            if (aPending !== bPending) return aPending ? -1 : 1;

            const aOld = a.oldest_pending_at ? Date.parse(a.oldest_pending_at) : Number.POSITIVE_INFINITY;
            const bOld = b.oldest_pending_at ? Date.parse(b.oldest_pending_at) : Number.POSITIVE_INFINITY;
            if (aOld !== bOld) return aOld - bOld;

            const aDue = Number(a.total_due || 0);
            const bDue = Number(b.total_due || 0);
            if (aDue !== bDue) return bDue - aDue;

            return String(a.pro_name || '').localeCompare(String(b.pro_name || ''));
        });
        
        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">No payouts found for this week/filter</div>';
            return;
        }
        
        container.innerHTML = `
            <table style="width:100%; border-collapse:collapse">
                <thead>
                    <tr style="background:linear-gradient(135deg, rgba(20,147,255,0.1) 0%, rgba(34,201,111,0.1) 100%); border-bottom:2px solid rgba(20,147,255,0.3);">
                        <th style="padding:16px; text-align:left; font-size:12px; font-weight:700; text-transform:uppercase; color:#60a5fa;">Pro</th>
                        <th style="padding:16px; text-align:center; font-size:12px; font-weight:700; text-transform:uppercase; color:#60a5fa;">Jobs</th>
                        <th style="padding:16px; text-align:right; font-size:12px; font-weight:700; text-transform:uppercase; color:#60a5fa;">Base Payout</th>
                        <th style="padding:16px; text-align:right; font-size:12px; font-weight:700; text-transform:uppercase; color:#60a5fa;">Bonuses</th>
                        <th style="padding:16px; text-align:right; font-size:12px; font-weight:700; text-transform:uppercase; color:#60a5fa;">Adjustments</th>
                        <th style="padding:16px; text-align:right; font-size:12px; font-weight:700; text-transform:uppercase; color:#60a5fa;">Total Due</th>
                        <th style="padding:16px; text-align:center; font-size:12px; font-weight:700; text-transform:uppercase; color:#60a5fa;">Status</th>
                        <th style="padding:16px; text-align:right; font-size:12px; font-weight:700; text-transform:uppercase; color:#60a5fa;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${filtered.map((pro, idx) => {
                        const isEven = idx % 2 === 0;
                        const rowBg = isEven ? 'rgba(15,23,42,0.3)' : 'rgba(15,23,42,0.5)';
                        const statusColor = pro.status === 'pending' ? '#FFC857' : pro.status === 'approved' ? '#22C96F' : '#1493FF';
                        
                        return `
                        <tr style="background:${rowBg}; border-bottom:1px solid rgba(71,85,105,0.2);" 
                            onmouseenter="this.style.background='rgba(20,147,255,0.1)'" 
                            onmouseleave="this.style.background='${rowBg}'">
                            <td style="padding:16px;">
                                <div style="font-weight:600; color:#f1f5f9; margin-bottom:4px;">${pro.pro_name}</div>
                                <div style="font-size:12px; color:#94a3b8;">${pro.pro_email || ''}</div>
                            </td>
                            <td style="padding:16px; text-align:center; color:#f1f5f9; font-weight:600;">${pro.jobs_completed}</td>
                            <td style="padding:16px; text-align:right; color:#f1f5f9; font-weight:600;">$${pro.base_payout.toFixed(2)}</td>
                            <td style="padding:16px; text-align:right; color:${pro.bonuses > 0 ? '#22C96F' : '#94a3b8'}; font-weight:600;">${pro.bonuses > 0 ? `$${pro.bonuses.toFixed(2)}` : '-'}</td>
                            <td style="padding:16px; text-align:right; color:#94a3b8;">${pro.adjustments > 0 ? `$${pro.adjustments.toFixed(2)}` : '-'}</td>
                            <td style="padding:16px; text-align:right;">
                                <div style="color:#22C96F; font-weight:700; font-size:18px;">$${pro.total_due.toFixed(2)}</div>
                            </td>
                            <td style="padding:16px; text-align:center;">
                                <span style="padding:6px 12px; border-radius:6px; font-size:11px; font-weight:700; text-transform:uppercase; background:rgba(${pro.status === 'pending' ? '255,200,87' : pro.status === 'approved' ? '34,201,111' : '20,147,255'},0.2); color:${statusColor}; border:1px solid ${statusColor}40;">
                                    ${pro.status}
                                </span>
                            </td>
                            <td style="padding:16px; text-align:right;">
                                <div style="display:flex; gap:8px; justify-content:flex-end;">
                                    ${pro.status === 'pending' ? `
                                        <button class="btn btn-success" onclick="approveProPayout('${pro.pro_id}')" style="padding:6px 12px; font-size:12px;">Approve</button>
                                    ` : ''}
                                    <button class="btn btn-ghost" onclick="viewProPayoutDetails('${pro.pro_id}')" style="padding:6px 12px; font-size:12px;">Details</button>
                                </div>
                            </td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }
    
    function filterPayoutsTable() {
        if (currentPayoutData && currentPayoutData.pros) {
            renderPayoutsCockpit(currentPayoutData.pros);
        }
    }
    
    function sortPayouts(by) {
        if (!currentPayoutData || !currentPayoutData.pros) return;
        if (by === 'amount') {
            currentPayoutData.pros.sort((a, b) => b.total_due - a.total_due);
        }
        renderPayoutsCockpit(currentPayoutData.pros);
    }
    
    async function approveProPayout(proId) {
        if (!confirm(`Approve all pending payouts for this pro?`)) return;
        // TODO: Implement bulk approval
        showToast('Bulk approval coming soon', 'info');
    }
    
    function viewProPayoutDetails(proId) {
        if (!currentPayoutData) return;
        const pro = currentPayoutData.pros.find(p => p.pro_id === proId);
        if (!pro) return;
        
        // Show modal with detailed breakdown
        alert(`Pro: ${pro.pro_name}\nJobs: ${pro.jobs_completed}\nBase: $${pro.base_payout}\nBonuses: $${pro.bonuses}\nTotal: $${pro.total_due}`);
    }
    
    function approveSelectedPayouts() {
        showToast('Bulk approval coming soon', 'info');
    }
    
    // Initialize on page load
    if (document.getElementById('payout-week-selector')) {
        initWeekSelector();
    }

    async function viewPayoutDetails(jobId) {
        console.log('[PAYOUT] Opening job details for:', jobId);
        
        // PRIORITY 1: Check currentPayouts for enriched data (contains address/customer from manual join)
        const payout = currentPayouts.find(p => p.job_id === jobId);
        if (payout && payout.job_details) {
            console.log('[PAYOUT] Found enriched data in payouts list');
            
            // Get cached job to merge with (if any)
            const cachedJob = jobCache.get(jobId, 'data') || {};
            
            // Construct job object from payout details, prioritizing enriched data
            const enrichedJob = {
                ...cachedJob, // Start with cache
                job_id: jobId,
                // Overwrite with enriched fields
                customer_name: payout.job_details.customer,
                service_name: payout.job_details.service,
                formatted_service_name: payout.job_details.service, // Pass explicitly to bypass re-parsing
                address: payout.job_details.address,
                city: payout.job_details.city,
                state: payout.job_details.state,
                zip: payout.job_details.zip,
                // Ensure metadata has the right fields
                metadata: {
                    ...(cachedJob.metadata || {}),
                    ...(payout.job_details.metadata || {}),
                    items_json: payout.job_details.line_items,
                    service_address: payout.job_details.address,
                    service_city: payout.job_details.city,
                    service_state: payout.job_details.state,
                    service_zip: payout.job_details.zip,
                    customer_name: payout.job_details.customer
                }
            };
            
            showJobModal(enrichedJob);
            return;
        }
        
        // CONSISTENCY CHECK: Use jobCache as single source of truth
        let job = jobCache.get(jobId, 'data');
        
        // Fallback 1: Check currentJobs array
        if (!job) {
            job = currentJobs.find(j => j.job_id === jobId);
            if (job) {
                console.log('[PAYOUT] Found in currentJobs, caching...');
                jobCache.set(jobId, job, 'data');
            }
        }
        
        // Fallback 2: Fetch from API if still not found
        if (!job) {
            console.log('[PAYOUT] Job not in cache, fetching from API:', jobId);
            try {
                const res = await fetchWithRetry(`${API_BASE}/admin_jobs_list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: ADMIN_TOKEN, status: 'all', days: 90 })
                });
                
                const data = await res.json();
                if (data.ok && data.jobs) {
                    job = data.jobs.find(j => j.job_id === jobId);
                    if (job) {
                        console.log('[PAYOUT] Fetched and caching job');
                        jobCache.set(jobId, job, 'data');
                    }
                }
            } catch (err) {
                console.error('[PAYOUT] Failed to fetch job:', err);
                alert('Failed to load job details. Please try again.');
                return;
            }
        }
        
        if (job) {
            showJobModal(job);
        } else {
            alert('Job details not found. The job may have been deleted.');
        }
    }

    // --- LOGIN LOGIC ---
    async function attemptLogin() {
        const email = document.getElementById('login-email').value;
        const zip = document.getElementById('login-password').value;
        const errorMsg = document.getElementById('login-error');
        const btn = document.querySelector('#login-overlay .login-btn');

        errorMsg.style.display = 'none';
        if (!email || !zip) {
            errorMsg.textContent = 'Email and access code required.';
            errorMsg.style.display = 'block';
            return;
        }

        try {
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Logging in...';
            }

            const res = await fetch(`${API_BASE}/admin_login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, zip })
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok || !data?.ok || !data?.token) {
                throw new Error(data?.error || `Login failed (${res.status})`);
            }

            ADMIN_TOKEN = String(data.token);
            localStorage.setItem('h2s_admin_token', ADMIN_TOKEN);

            document.getElementById('login-overlay').style.display = 'none';
            init();
        } catch (e) {
            errorMsg.textContent = e?.message || 'Invalid credentials. Please try again.';
            errorMsg.style.display = 'block';
            const box = document.querySelector('.login-box');
            box.style.transform = 'translateX(10px)';
            setTimeout(() => box.style.transform = 'translateX(-10px)', 100);
            setTimeout(() => box.style.transform = 'translateX(10px)', 200);
            setTimeout(() => box.style.transform = 'translateX(0)', 300);
        } finally {
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        }
    }

    document.getElementById('login-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') attemptLogin();
    });

    // Initial Load
    function init() {
        console.log('==================== DASHBOARD INIT ====================');
        console.log('API_BASE:', API_BASE);
        console.log('ADMIN_TOKEN:', ADMIN_TOKEN);
        console.log('=======================================================');
        
        checkConnection().then(() => {
            console.log('Connection check complete. Status:', connectionStatus);
            updateConnectionUI();
            loadMetrics();
        }).catch(err => {
            console.error('Init error:', err);
            document.getElementById('metrics-container').innerHTML = `
                <div style="background:rgba(239,68,68,0.1); border:1px solid #ef4444; padding:20px; border-radius:8px; text-align:center">
                    <div style="font-size:16px; font-weight:600; margin-bottom:8px">Failed to Initialize</div>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px">${err.message}</div>
                    <button class="btn btn-primary" onclick="location.reload()">Reload Page</button>
                </div>
            `;
        });
    }

    // Auto-bypass login if token already stored
    if (ADMIN_TOKEN) {
        document.getElementById('login-overlay').style.display = 'none';
        init();
    }

</script>
<!-- DISPATCH_EOF_MARKER: 2025-12-24 -->
</div>
</body>
</html>
