<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="color-scheme" content="light dark">
    <title>H2S Analytics Dashboard</title>
    
    <!-- Preconnect to critical origins -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;900&display=swap" rel="stylesheet">
    
    <!-- App icons -->
    <link rel="icon" type="image/png" sizes="180x180" href="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png">
    <meta name="theme-color" content="#0a2a5a">
    
    <style>
        /* Font loaded via Google Fonts API link tag above */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cobalt: #0a2a5a;
            --azure: #1493ff;
            --white: #ffffff;
            --success: #34A853;
            --warning: #FBBC04;
            --danger: #EA4335;
            --dark: #0a2a5a;
            --light: #F8F9FA;
            --border: #e7eaf0;
            --ease: cubic-bezier(.22,.8,.32,1);
            --ease-smooth: cubic-bezier(.16,.84,.44,1);
            --elev-1: 0 2px 6px rgba(0,0,0,.20), 0 6px 18px rgba(0,0,0,.14);
            --elev-2: 0 6px 14px rgba(0,0,0,.24), 0 18px 28px rgba(0,0,0,.18);
            --elev-card: 0 2px 10px rgba(0,0,0,.08);
            --elev-card-lg: 0 16px 36px rgba(0,0,0,.22);
        }

        html {
            scroll-behavior: smooth;
        }

        html, body {
            background: var(--cobalt) !important; /* ensure full-bleed blue in GHL embeds */
        }

        body {
            font-family: Archivo, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            color: var(--white);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0;
        }

        /* ===== HEADER ===== */
        .h2s-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: var(--white);
            box-shadow: var(--elev-2);
            border-bottom: 1px solid var(--border);
            width: 100%;
            contain: layout style paint;
        }

        .h2s-head-row {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: 16px;
            padding: 12px clamp(20px, 4vw, 40px);
            max-width: 1280px;
            margin: 0 auto;
        }

        .h2s-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 64px;
            min-height: 64px;
        }

        .h2s-logo img {
            width: 64px;
            height: 64px;
            display: block;
            object-fit: contain;
        }

        .h2s-logo-text {
            font-weight: 900;
            font-size: clamp(20px, 2.4vw, 28px);
            color: var(--cobalt);
            text-transform: lowercase;
        }

        .header-actions {
            justify-self: end;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* ===== BUTTONS ===== */
        .btn {
            appearance: none;
            border: 2px solid var(--azure);
            background: var(--azure);
            color: var(--white);
            font-weight: 700;
            border-radius: 12px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            min-height: 44px;
            font-size: clamp(14px, 1.4vw, 16px);
            transition: transform 0.2s var(--ease), box-shadow 0.22s var(--ease-smooth);
            box-shadow: var(--elev-1);
            will-change: transform, box-shadow;
            transform: translateZ(0);
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-4px);
            box-shadow: var(--elev-2);
        }

        .btn:active {
            transform: translateY(-1px);
            box-shadow: var(--elev-1);
        }

        .btn:focus-visible {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
        }

        .btn-secondary {
            background: transparent;
            border-color: var(--azure);
            color: var(--azure);
        }

        .btn-secondary:hover {
            background: var(--azure);
            color: var(--white);
        }

        .btn-icon {
            padding: 10px;
            min-width: 44px;
        }

        /* ===== TRACKING REFERENCE MODAL ===== */
        .tracking-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(10, 42, 90, 0.95);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(8px);
        }

        .tracking-modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .tracking-content {
            background: var(--white);
            max-width: 900px;
            width: 100%;
            border-radius: 16px;
            box-shadow: var(--elev-2);
            margin: 40px auto;
            position: relative;
        }

        .tracking-header {
            background: linear-gradient(135deg, var(--cobalt), var(--azure));
            color: var(--white);
            padding: 24px 32px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tracking-header h2 {
            margin: 0;
            font-size: clamp(20px, 3vw, 28px);
            font-weight: 900;
        }

        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s var(--ease);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tracking-body {
            padding: 32px;
            color: var(--cobalt);
            line-height: 1.8;
            max-width: 100%;
            overflow-x: hidden;
        }

        .tracking-body h3 {
            color: var(--cobalt);
            font-weight: 900;
            margin: 24px 0 12px;
            font-size: clamp(18px, 2vw, 22px);
        }

        .tracking-body h4 {
            color: var(--azure);
            font-weight: 700;
            margin: 16px 0 8px;
            font-size: clamp(15px, 1.6vw, 18px);
        }

        .tracking-body p {
            margin: 12px 0;
            color: #5f6368;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .tracking-body ul, .tracking-body ol {
            margin: 12px 0;
            padding-left: 24px;
            max-width: 100%;
        }

        .tracking-body li {
            margin: 8px 0;
            color: #5f6368;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .tracking-body strong {
            color: var(--cobalt);
            font-weight: 700;
        }

        .tracking-body code {
            background: var(--light);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: var(--danger);
            word-break: break-all;
        }

        .tracking-body a {
            color: var(--azure);
            text-decoration: none;
            font-weight: 600;
            word-break: break-all;
        }

        .tracking-body a:hover {
            text-decoration: underline;
        }

        .code-block {
            background: #f5f5f5;
            color: #333;
            padding: 60px 20px 20px 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
            position: relative;
            border: 1px solid #e0e0e0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .code-block pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #333;
        }

        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--azure);
            color: var(--white);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.2s var(--ease);
            box-shadow: 0 2px 8px rgba(20, 147, 255, 0.3);
            z-index: 10;
        }

        .copy-btn:hover {
            background: #0d7de0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(20, 147, 255, 0.4);
        }

        .copy-btn.copied {
            background: var(--success);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid var(--azure);
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .info-box code {
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
            display: inline-block;
            max-width: 100%;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid var(--warning);
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* ===== MAIN CONTENT ===== */
        .dashboard-main {
            padding: clamp(24px, 4vw, 48px) clamp(20px, 4vw, 40px);
            max-width: 1280px;
            margin: 0 auto;
        }

        .section-title {
            font-weight: 900;
            font-size: clamp(24px, 3vw, 36px);
            color: var(--white);
            margin-bottom: clamp(16px, 2vw, 24px);
            letter-spacing: 0.2px;
        }

        /* ===== AI REPORT SECTION ===== */
        .ai-report {
            background: var(--white);
            border-radius: 16px;
            padding: clamp(20px, 3vw, 32px);
            margin-bottom: clamp(20px, 3vw, 32px);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
            transition: box-shadow 0.3s var(--ease);
        }

        .ai-report:hover {
            box-shadow: var(--elev-card-lg);
        }

        .ai-report h2 {
            font-size: clamp(18px, 2vw, 24px);
            color: var(--cobalt);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 900;
        }

        .ai-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--azure), var(--success));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 18px;
            font-weight: 900;
            flex-shrink: 0;
        }

        .ai-content {
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            border-left: 4px solid var(--azure);
            font-size: 15px;
            line-height: 1.8;
            color: var(--cobalt);
        }

        .ai-content.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 120px;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 4px solid var(--light);
            border-top: 4px solid var(--azure);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== KPI CARDS GRID ===== */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 260px), 1fr));
            gap: clamp(16px, 2.5vw, 24px);
            margin-bottom: clamp(24px, 3vw, 36px);
        }

        .kpi-card {
            background: var(--white);
            border-radius: 16px;
            padding: clamp(18px, 2.5vw, 24px);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
            transition: transform 0.3s var(--ease), box-shadow 0.3s var(--ease);
            position: relative;
            overflow: hidden;
            contain: layout style paint;
        }

        .kpi-card::before {
            content: "";
            position: absolute;
            inset: -10px;
            border-radius: 18px;
            box-shadow: var(--elev-card-lg);
            opacity: 0;
            transition: opacity 0.3s var(--ease);
            pointer-events: none;
        }

        .kpi-card:hover {
            transform: translateY(-6px);
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .kpi-title {
            font-size: clamp(13px, 1.3vw, 15px);
            color: #5f6368;
            font-weight: 600;
            line-height: 1.3;
        }

        .kpi-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 900;
            flex-shrink: 0;
        }

        .kpi-value {
            font-size: clamp(28px, 4vw, 36px);
            font-weight: 900;
            color: var(--cobalt);
            margin-bottom: 10px;
            line-height: 1.1;
        }

        .kpi-change {
            font-size: clamp(12px, 1.2vw, 14px);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .kpi-change.positive {
            color: var(--success);
        }

        .kpi-change.negative {
            color: var(--danger);
        }

        /* ===== CHARTS SECTION ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 450px), 1fr));
            gap: clamp(16px, 2.5vw, 24px);
            margin-bottom: clamp(24px, 3vw, 36px);
        }

        .chart-card {
            background: var(--white);
            border-radius: 16px;
            padding: clamp(20px, 3vw, 28px);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
            transition: box-shadow 0.3s var(--ease);
        }

        /* Custom scrollbars for event lists - thinner, subtle */
        #pixelEventTypes,
        #pixelPagePerformance,
        #pixelUTMSources {
            max-height: 260px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(20,147,255,0.5) transparent;
        }
        #pixelEventTypes::-webkit-scrollbar,
        #pixelPagePerformance::-webkit-scrollbar,
        #pixelUTMSources::-webkit-scrollbar {
            width: 6px;
        }
        #pixelEventTypes::-webkit-scrollbar-track,
        #pixelPagePerformance::-webkit-scrollbar-track,
        #pixelUTMSources::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 8px;
        }
        #pixelEventTypes::-webkit-scrollbar-thumb,
        #pixelPagePerformance::-webkit-scrollbar-thumb,
        #pixelUTMSources::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(20,147,255,0.65), rgba(20,147,255,0.35));
            border-radius: 8px;
        }
        #pixelEventTypes::-webkit-scrollbar-thumb:hover,
        #pixelPagePerformance::-webkit-scrollbar-thumb:hover,
        #pixelUTMSources::-webkit-scrollbar-thumb:hover {
            background: #0d7de0;
        }

        .chart-card:hover {
            box-shadow: var(--elev-card-lg);
        }

        .chart-card h3 {
            font-size: clamp(16px, 1.8vw, 20px);
            color: var(--cobalt);
            margin-bottom: 20px;
            font-weight: 900;
        }

        .chart-card canvas {
            max-height: 300px;
        }

        /* ===== FUNNEL VISUALIZATION ===== */
        .funnel-container {
            background: var(--white);
            border-radius: 16px;
            padding: clamp(20px, 3vw, 28px);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
            margin-bottom: clamp(24px, 3vw, 36px);
            transition: box-shadow 0.3s var(--ease);
        }

        .funnel-container:hover {
            box-shadow: var(--elev-card-lg);
        }

        .funnel-container h3 {
            font-size: clamp(18px, 2.2vw, 24px);
            color: var(--cobalt);
            margin-bottom: 20px;
            font-weight: 900;
        }

        .funnel-stage {
            margin-bottom: 18px;
        }

        .funnel-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: clamp(14px, 1.4vw, 16px);
            font-weight: 700;
            color: var(--cobalt);
        }

        .funnel-label .stage-name {
            font-weight: 900;
            letter-spacing: 0.3px;
        }

        .funnel-label .stage-count {
            font-weight: 600;
            color: #5f6368;
        }

        .funnel-bar {
            height: 48px;
            background: linear-gradient(90deg, var(--azure), var(--success));
            border-radius: 12px;
            position: relative;
            transition: all 0.5s var(--ease);
            display: flex;
            align-items: center;
            padding: 0 20px;
            color: var(--white);
            font-weight: 700;
            font-size: clamp(14px, 1.4vw, 16px);
            box-shadow: 0 2px 8px rgba(20, 147, 255, 0.3);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .funnel-bar:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(20, 147, 255, 0.4);
        }

        /* ===== TABLE ===== */
        .table-card {
            background: var(--white);
            border-radius: 16px;
            padding: clamp(20px, 3vw, 28px);
            box-shadow: var(--elev-card);
            border: 1px solid var(--border);
            margin-bottom: clamp(24px, 3vw, 36px);
            overflow-x: auto;
            transition: box-shadow 0.3s var(--ease);
        }

        .table-card:hover {
            box-shadow: var(--elev-card-lg);
        }

        .table-card h3 {
            font-size: clamp(18px, 2.2vw, 24px);
            color: var(--cobalt);
            margin-bottom: 20px;
            font-weight: 900;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: var(--light);
            padding: 14px 12px;
            text-align: left;
            font-size: clamp(12px, 1.2vw, 14px);
            color: var(--cobalt);
            font-weight: 700;
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 14px 12px;
            border-bottom: 1px solid var(--border);
            font-size: clamp(13px, 1.3vw, 15px);
            color: var(--cobalt);
        }

        tbody tr {
            transition: background-color 0.2s var(--ease);
        }

        tbody tr:hover {
            background: var(--light);
        }

        /* ===== FOOTER ===== */
        .dashboard-footer {
            background: rgba(10, 42, 90, 0.6);
            border-top: 1px solid rgba(255, 255, 255, 0.12);
            padding: 24px clamp(20px, 4vw, 40px);
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: auto;
        }

        .dashboard-footer a {
            color: var(--azure);
            text-decoration: none;
            transition: color 0.2s var(--ease);
        }

        .dashboard-footer a:hover {
            color: var(--white);
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .h2s-head-row {
                grid-template-columns: auto 1fr;
                gap: 12px;
                padding: 10px 16px;
            }

            .h2s-logo {
                min-width: 48px;
                min-height: 48px;
            }

            .h2s-logo img {
                width: 48px;
                height: 48px;
            }

            .h2s-logo-text {
                font-size: 18px;
            }

            .header-nav {
                display: none;
            }

            .header-actions {
                grid-column: 1 / -1;
                justify-self: stretch;
                flex-wrap: wrap;
            }

            .header-actions .btn {
                flex: 1;
                min-width: 0;
                font-size: 13px;
                padding: 8px 12px;
            }

            .dashboard-main {
                padding: 20px 16px;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .chart-card {
                padding: 16px;
            }

            .chart-card h3 {
                font-size: 16px;
                margin-bottom: 12px;
            }

            .chart-card canvas {
                max-height: 250px;
                width: 100% !important;
                height: auto !important;
            }

            /* Page Performance Cards - Mobile Optimization */
            #pixelPagePerformance > div {
                padding: 10px !important;
                margin-bottom: 12px !important;
            }

            #pixelPagePerformance > div > div:first-child {
                flex-direction: column !important;
                gap: 8px !important;
            }

            #pixelPagePerformance > div > div:first-child > div:first-child {
                width: 100% !important;
            }

            #pixelPagePerformance > div > div:first-child > div:last-child {
                text-align: left !important;
                margin-left: 0 !important;
            }

            #pixelEventTypes,
            #pixelUTMSources {
                max-height: 250px !important;
            }

            .table-card {
                padding: 16px;
                overflow-x: auto;
            }

            table {
                font-size: 12px;
                min-width: 600px;
            }

            th, td {
                padding: 10px 8px;
            }
        }

        @media (max-width: 480px) {
            .funnel-bar {
                font-size: 13px;
                padding: 0 14px;
                height: 44px;
            }

            .funnel-label {
                font-size: 13px;
            }

            .kpi-card {
                padding: 16px;
            }

            .ai-report {
                padding: 16px;
            }
        }

        /* ===== LOADING & ERROR STATES ===== */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 42, 90, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loading-card {
            background: var(--white);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            box-shadow: var(--elev-2);
        }

        .error-message {
            background: #fee;
            color: var(--danger);
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            border-left: 4px solid var(--danger);
            font-weight: 600;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.6s var(--ease) both;
        }

        .fade-in-delay-1 { animation-delay: 0.1s; }
        .fade-in-delay-2 { animation-delay: 0.2s; }
        .fade-in-delay-3 { animation-delay: 0.3s; }

        /* ===== REDUCED MOTION ===== */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .btn:hover,
            .kpi-card:hover,
            .funnel-bar:hover {
                transform: none !important;
            }
        }

        /* ===== ACCESSIBILITY ===== */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        :focus-visible {
            outline: 2px solid var(--azure);
            outline-offset: 2px;
        }
    </style>
    
    <!-- Lazy load Chart.js after critical content -->
    <link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js">
</head>
<body>
    <!-- Header -->
    <header class="h2s-header">
        <div class="h2s-head-row">
            <a href="/" class="h2s-logo" aria-label="Home2Smart Home">
                <img src="https://cdn.jsdelivr.net/gh/gkstrmtm/home2smart-assets@main/logo-180.png" 
                     alt="Home2Smart Logo" 
                     width="64" 
                     height="64"
                     loading="eager">
                <span class="h2s-logo-text">dashboard</span>
            </a>
            
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="openTrackingReference()" aria-label="View tracking documentation">
                    <span>üìñ Tracking Docs</span>
                </button>
                <button class="btn btn-secondary" onclick="refreshData()" aria-label="Refresh dashboard data">
                    <span>Refresh</span>
                </button>
                <button class="btn" onclick="generateAIReport()" aria-label="Generate AI insights">
                    <span>Generate Insights</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Dashboard Content -->
    <main class="dashboard-main">
        <div id="dataStatus" class="status-banner" style="display:none; background:#fff3cd; color:#8a6d3b; border:1px solid #ffeeba; padding:10px 14px; border-radius:10px; margin-bottom:14px; font-size:13px;"></div>
        <!-- AI Report Section -->
        <section class="ai-report fade-in" id="aiReportSection" style="display: none;" aria-live="polite">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                <h2 style="margin-bottom: 0;">
                    <span class="ai-icon" aria-hidden="true">AI</span>
                    AI-Powered Marketing Insights
                </h2>
                <button id="emailReportBtn" class="btn btn-secondary" onclick="emailAIReport()" style="display: none; font-size: 14px; padding: 8px 16px;">
                    üìß Email Report
                </button>
            </div>
            <div class="ai-content" id="aiReportContent">
                <div class="loading">
                    <div class="spinner" role="status" aria-label="Loading AI insights"></div>
                </div>
            </div>
        </section>

        <!-- Meta Pixel Tracking Section -->
        <section class="meta-pixel-section fade-in" id="metaPixelSection" style="margin-bottom: 36px;" aria-label="Meta Pixel Tracking Analytics">
            <h2 style="margin-bottom: 20px; color: var(--white); font-size: clamp(22px, 2.8vw, 30px); font-weight: 900;">
                üìç Meta Pixel Performance
            </h2>
            
            <div class="kpi-grid">
                <!-- Total Pixel Events -->
                <div class="kpi-card fade-in-delay-1">
                    <div class="kpi-header">
                        <div class="kpi-title">Total Pixel Events</div>
                        <div class="kpi-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üìä</div>
                    </div>
                    <div class="kpi-value" id="pixelTotalEvents">-</div>
                    <div class="kpi-change" id="pixelEventsChange">Loading...</div>
                </div>

                <!-- Event Match Quality -->
                <div class="kpi-card fade-in-delay-2">
                    <div class="kpi-header">
                        <div class="kpi-title">Unique Users</div>
                        <div class="kpi-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">üë•</div>
                    </div>
                    <div class="kpi-value" id="pixelMatchQuality">-</div>
                    <div class="kpi-change" id="pixelQualityChange">Tracked across sessions</div>
                </div>

                <!-- Top Performing Content -->
                <div class="kpi-card fade-in-delay-3">
                    <div class="kpi-header">
                        <div class="kpi-title">Top Content by Engagement</div>
                        <div class="kpi-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">üèÜ</div>
                    </div>
                    <div class="kpi-value" id="pixelTopPage" style="font-size: clamp(16px, 2.5vw, 22px); line-height: 1.3;">-</div>
                    <div class="kpi-change" id="pixelTopPageEvents">-</div>
                </div>

                <!-- Conversion Value -->
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-title">Total Conversion Value</div>
                        <div class="kpi-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">üí∞</div>
                    </div>
                    <div class="kpi-value" id="pixelTotalValue">$0.00</div>
                    <div class="kpi-change" id="pixelConversions">0 conversions</div>
                </div>
            </div>

            <!-- ENHANCED: Analytics Context Card -->
            <div class="chart-card" style="margin-top: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; border: none !important;">
                <h3 style="color: white !important; margin-bottom: 16px;">üìä Analytics Context & Performance</h3>
                <div id="analyticsContext" style="line-height: 1.8;">
                    <div class="loading">
                        <div class="spinner" role="status" aria-label="Loading analytics context"></div>
                    </div>
                </div>
            </div>

            <!-- Event Type Breakdown -->
            <div class="chart-card" style="margin-top: 24px;">
                <h3>Event Type Distribution</h3>
                <div id="pixelEventTypes" style="max-height: 300px; overflow-y: auto; scrollbar-color: #1493ff #0a2a5a; scrollbar-width: thin;">
                    <div class="loading">
                        <div class="spinner" role="status" aria-label="Loading event types"></div>
                    </div>
                </div>
            </div>

            <!-- Page Performance Breakdown -->
            <div class="chart-card" style="margin-top: 24px;">
                <h3>Page Type Performance</h3>
                <div id="pixelPagePerformance" style="max-height: 300px; overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner" role="status" aria-label="Loading page performance"></div>
                    </div>
                </div>
            </div>

            <!-- UTM Source Attribution -->
            <div class="chart-card" style="margin-top: 24px;">
                <h3>Traffic Source Attribution</h3>
                <div id="pixelUTMSources" style="max-height: 300px; overflow-y: auto;">
                    <div class="loading">
                        <div class="spinner" role="status" aria-label="Loading UTM sources"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- KPI Cards -->
        <section aria-labelledby="kpi-heading">
            <h2 id="kpi-heading" class="visually-hidden">Key Performance Indicators</h2>
            <div class="kpi-grid" id="kpiGrid">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Funnel Visualization -->
        <section class="funnel-container fade-in fade-in-delay-1" aria-labelledby="funnel-heading">
            <h3 id="funnel-heading">Conversion Funnel</h3>
            <div id="funnelVisualization" role="img" aria-label="Conversion funnel visualization">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Charts -->
        <section aria-labelledby="charts-heading">
            <h2 id="charts-heading" class="visually-hidden">Analytics Charts</h2>
            <div class="charts-grid">
                <div class="chart-card fade-in fade-in-delay-2">
                    <h3>Revenue Over Time</h3>
                    <canvas id="revenueChart" role="img" aria-label="Revenue over time chart"></canvas>
                </div>
                <div class="chart-card fade-in fade-in-delay-3">
                    <h3>Traffic by Device</h3>
                    <canvas id="deviceChart" role="img" aria-label="Traffic by device chart"></canvas>
                </div>
            </div>
        </section>

        <!-- Top Users Table -->
        <section class="table-card fade-in fade-in-delay-3" aria-labelledby="top-users-heading">
            <h3 id="top-users-heading">Top Customers by Lifetime Value</h3>
            <div style="overflow-x: auto;">
                <table id="topUsersTable">
                    <thead>
                        <tr>
                            <th scope="col">Email</th>
                            <th scope="col">Total Orders</th>
                            <th scope="col">Lifetime Revenue</th>
                            <th scope="col">Last Purchase</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="dashboard-footer">
        <p>
            <strong>Home2Smart Analytics</strong> ¬∑ Service area: NC &amp; SC ¬∑ 
            <a href="mailto:h2sbackend@gmail.com">h2sbackend@gmail.com</a> ¬∑ 
            <a href="/privacy-policy" rel="nofollow">Privacy Policy</a>
        </p>
    </footer>

    <!-- Tracking Reference Modal -->
    <div class="tracking-modal" id="trackingModal">
        <div class="tracking-content">
            <div class="tracking-header">
                <h2>üìç Home2Smart Tracking Reference</h2>
                <button class="close-modal" onclick="closeTrackingReference()" aria-label="Close">√ó</button>
            </div>
            <div class="tracking-body">
                
                <h3>üéØ System Overview</h3>
                <p>Home2Smart uses a comprehensive tracking system powered by <strong>Supabase</strong> to capture, analyze, and optimize every user interaction across our digital ecosystem. All data flows directly to the database with intelligent business entity linking.</p>

                <div class="info-box">
                    <strong>üîë Meta Pixel ID:</strong> <code>2384221445259822</code><br>
                    <strong>üìä Tracking API:</strong> <code>https://h2s-backend-nrgjyhn31-tabari-ropers-projects-6f2e090b.vercel.app/api/track</code><br>
                    <strong>üóÑÔ∏è Database:</strong> <code>Supabase (PostgreSQL)</code><br>
                    <strong>üìà Tables:</strong> <code>h2s_tracking_visitors, h2s_tracking_sessions, h2s_tracking_events, h2s_tracking_funnel_attribution</code>
                </div>

                <h3>üìä Conversion Funnel Structure</h3>
                <p>Our 5-stage funnel tracks users from initial awareness to loyal customers:</p>
                <ol>
                    <li><strong>Visitor</strong> ‚Üí First interaction with any page (PageView event)</li>
                    <li><strong>Browser</strong> ‚Üí Engaged viewing (ViewContent event, 3+ seconds on page)</li>
                    <li><strong>Engaged</strong> ‚Üí Multiple pages visited or interaction events (CTA clicks, chat opens)</li>
                    <li><strong>Lead</strong> ‚Üí Contact form submission or phone click (Lead event)</li>
                    <li><strong>Customer</strong> ‚Üí Completed purchase (Purchase event with value)</li>
                </ol>

                <h3>üé® Tracked Pages & Events</h3>
                
                <h4>Homepage (homev2.html)</h4>
                <ul>
                    <li><strong>Page Type:</strong> <code>home</code> or <code>landing_page</code></li>
                    <li><strong>Events:</strong> PageView, ViewContent ("Home Landing Page"), Lead (form), Contact (phone click)</li>
                    <li><strong>UTM Tracking:</strong> Yes (all parameters captured)</li>
                    <li><strong>Advanced Matching:</strong> Email, phone, name (when form submitted)</li>
                </ul>

                <h4>Shop (shop.html)</h4>
                <ul>
                    <li><strong>Page Type:</strong> <code>shop</code> or <code>product</code></li>
                    <li><strong>Events:</strong> PageView, ViewContent (per product), AddToCart, InitiateCheckout</li>
                    <li><strong>Product Tracking:</strong> content_name, content_ids, value, currency</li>
                    <li><strong>Advanced Matching:</strong> Full user data on checkout</li>
                </ul>

                <h4>Security (securityv3.html)</h4>
                <ul>
                    <li><strong>Page Type:</strong> <code>security</code> or <code>service</code></li>
                    <li><strong>Events:</strong> PageView, ViewContent (delayed 3s), Lead, Contact</li>
                    <li><strong>Service Tracking:</strong> content_name = "Security Installations"</li>
                    <li><strong>CTA Tracking:</strong> All button clicks tracked</li>
                </ul>

                <h4>TV Mounting (tvmountingv3.html)</h4>
                <ul>
                    <li><strong>Page Type:</strong> <code>tvmounting</code> or <code>service</code></li>
                    <li><strong>Events:</strong> PageView, ViewContent, wizard step tracking</li>
                    <li><strong>Special:</strong> Multi-step funnel with step completion events</li>
                </ul>

                <h4>Smart Integrations (smart.html)</h4>
                <ul>
                    <li><strong>Page Type:</strong> <code>automations</code> or <code>smart</code></li>
                    <li><strong>Events:</strong> PageView, ViewContent, service interest tracking</li>
                    <li><strong>Focus:</strong> High-value automation packages</li>
                </ul>

                <h3>üîó UTM Parameter Structure</h3>
                <p>All campaigns must include these parameters for proper attribution:</p>
                
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, 'utm-structure')">Copy</button>
                    <pre id="utm-structure">?utm_source=[source]
&utm_medium=[medium]
&utm_campaign=[campaign_name]
&utm_content=[ad_creative_id]
&utm_term=[keyword]</pre>
                </div>

                <h4>UTM Source Values:</h4>
                <ul>
                    <li><code>google</code> - Google Ads</li>
                    <li><code>facebook</code> or <code>meta</code> - Facebook/Instagram Ads</li>
                    <li><code>email</code> - Email campaigns</li>
                    <li><code>direct</code> - Direct traffic (no UTM)</li>
                    <li><code>organic</code> - Organic search</li>
                </ul>

                <h4>UTM Medium Values:</h4>
                <ul>
                    <li><code>cpc</code> - Cost-per-click ads</li>
                    <li><code>social</code> - Social media organic/paid</li>
                    <li><code>email</code> - Email marketing</li>
                    <li><code>display</code> - Display advertising</li>
                    <li><code>video</code> - Video ads (YouTube, etc.)</li>
                </ul>

                <h3>üìà Meta Pixel Event Catalog</h3>
                
                <h4>Standard Events We Track:</h4>
                <ul>
                    <li><strong>PageView</strong> - Every page load (automatic)</li>
                    <li><strong>ViewContent</strong> - Product/service page views (3s engagement)</li>
                    <li><strong>Lead</strong> - Form submissions, phone clicks</li>
                    <li><strong>Contact</strong> - Direct contact interactions</li>
                    <li><strong>AddToCart</strong> - Product added to cart (shop only)</li>
                    <li><strong>InitiateCheckout</strong> - Checkout process started</li>
                    <li><strong>Purchase</strong> - Completed transaction with value</li>
                </ul>

                <h4>Custom Events:</h4>
                <ul>
                    <li><strong>ChatWidget_Open</strong> - User opens chat</li>
                    <li><strong>CTA_Click</strong> - Call-to-action button clicked</li>
                    <li><strong>Step_[N]_Complete</strong> - Wizard step completion (TV mounting)</li>
                </ul>

                <h3>üéØ Campaign Setup Best Practices</h3>
                
                <div class="warning-box">
                    <strong>‚ö†Ô∏è Critical:</strong> Always test tracking BEFORE launching campaigns. Use <code>seedAllTrackingData()</code> in Apps Script to verify dashboard displays correctly.
                </div>

                <h4>For Google Ads:</h4>
                <ol>
                    <li>Use <code>utm_source=google</code></li>
                    <li>Set <code>utm_medium=cpc</code></li>
                    <li>Campaign name should describe objective: <code>utm_campaign=smart_home_nc_search</code></li>
                    <li>Use <code>utm_term={keyword}</code> for dynamic keyword insertion</li>
                    <li>Track final URL in Ad Group settings</li>
                </ol>

                <h4>For Facebook/Instagram Ads:</h4>
                <ol>
                    <li>Use <code>utm_source=facebook</code> (or instagram for IG-specific)</li>
                    <li>Set <code>utm_medium=social</code> or <code>utm_medium=cpc</code></li>
                    <li>Campaign name: <code>utm_campaign=smart_lighting_promo_nc</code></li>
                    <li>Use <code>utm_content={{ad.id}}</code> for ad-level tracking</li>
                    <li>Meta Pixel will automatically capture with Advanced Matching</li>
                </ol>

                <h4>Landing Page Best Practices:</h4>
                <ul>
                    <li>Always direct to <code>homev2.html</code> for general awareness</li>
                    <li>Use <code>shop.html</code> for product-specific campaigns</li>
                    <li>Use service pages (security, tvmounting, smart) for targeted service campaigns</li>
                    <li>Include UTM parameters in ALL ad links</li>
                    <li>Test links with <code>?test=1</code> parameter to verify tracking fires</li>
                </ul>

                <h3>üìã AI Campaign Briefing Prompt</h3>
                <p>Copy this prompt to use with ChatGPT/Claude when planning new campaigns:</p>
                
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, 'ai-prompt')">Copy Prompt</button>
                    <pre id="ai-prompt">You are a performance marketing expert for Home2Smart, a smart home installation company serving North Carolina and South Carolina.

BUSINESS CONTEXT:
- Services: Smart home automation, security systems, TV mounting, lighting control
- Target Market: NC & SC homeowners, 35-65 years old, household income $75k+
- Unique Value: Professional installation, local expertise, 24/7 support
- Service Area: Charlotte, Raleigh, Charleston, Columbia, Greensboro (+ surrounding areas)

TRACKING INFRASTRUCTURE:
- Meta Pixel ID: 2384221445259822
- We track 5-stage funnel: Visitor ‚Üí Browser ‚Üí Engaged ‚Üí Lead ‚Üí Customer
- All pages have Meta Pixel + Google Apps Script tracking
- Dashboard auto-refreshes every 30 seconds with real-time data

TRACKED PAGES:
1. Homepage (homev2.html) - General awareness, page_type: "home"
2. Shop (shop.html) - Product catalog, page_type: "shop"
3. Security (securityv3.html) - Security services, page_type: "security"
4. TV Mounting (tvmountingv3.html) - TV installation wizard, page_type: "tvmounting"
5. Smart Integrations (smart.html) - Automation packages, page_type: "automations"

UTM STRUCTURE REQUIRED:
?utm_source=[google/facebook/email/direct]
&utm_medium=[cpc/social/email/display]
&utm_campaign=[descriptive_campaign_name]
&utm_content=[ad_creative_id]
&utm_term=[keyword_or_targeting]

TRACKED EVENTS:
- PageView (all pages, automatic)
- ViewContent (3+ seconds engagement)
- Lead (form submission, phone click)
- Contact (direct interactions)
- AddToCart (shop only)
- Purchase (conversion with value)

CAMPAIGN OBJECTIVES:
[Specify your goal: Awareness / Lead Generation / Sales / Service Promotion]

TARGET AUDIENCE:
[Define demographics, interests, behaviors]

BUDGET & TIMELINE:
[Budget amount and campaign duration]

CREATIVE REQUIREMENTS:
[Ad formats needed: image/video/carousel, copy angles, CTAs]

YOUR TASK:
Create a comprehensive campaign strategy including:
1. Campaign structure (campaigns > ad sets > ads)
2. Audience targeting recommendations
3. Ad copy variations (headlines, descriptions, CTAs)
4. Landing page assignment per ad set
5. Complete UTM tracking URLs for each ad
6. Budget allocation recommendations
7. Success metrics and KPIs to monitor in dashboard
8. A/B testing plan

Ensure all tracking URLs follow our UTM structure and align with our funnel stages.</pre>
                </div>

                <h3>üîç Dashboard Metrics Explained</h3>
                
                <h4>Meta Pixel Performance Section:</h4>
                <ul>
                    <li><strong>Total Pixel Events:</strong> All events fired (PageView + ViewContent + Lead + etc.)</li>
                    <li><strong>Unique Users:</strong> Distinct individuals tracked (via User_ID or External_ID)</li>
                    <li><strong>Top Content by Engagement:</strong> Event type with most fires (usually PageView)</li>
                    <li><strong>Total Conversion Value:</strong> Sum of all Purchase event values</li>
                </ul>

                <h4>Event Type Distribution:</h4>
                <p>Shows breakdown of all Meta Pixel events by type. Healthy distribution:</p>
                <ul>
                    <li>PageView: 60-70% (highest - every page loads)</li>
                    <li>ViewContent: 20-30% (engaged users)</li>
                    <li>Lead: 5-10% (qualified prospects)</li>
                    <li>Purchase: 1-3% (conversions)</li>
                </ul>

                <h4>Page Type Performance:</h4>
                <p>Shows which pages drive most engagement. Use this to optimize ad targeting:</p>
                <ul>
                    <li>High <code>home</code> traffic = Good top-of-funnel awareness</li>
                    <li>High <code>shop</code> traffic = Product interest, optimize checkout</li>
                    <li>High <code>security</code>/<code>tvmounting</code> = Service-specific demand</li>
                </ul>

                <h4>Traffic Source Attribution:</h4>
                <p>Tracks performance by utm_source. Use this to allocate budget:</p>
                <ul>
                    <li>Compare cost-per-lead across sources</li>
                    <li>Identify highest-converting traffic sources</li>
                    <li>Adjust budget allocation monthly</li>
                </ul>

                <h3>‚ö° Quick Reference Links</h3>
                <ul>
                    <li><strong>Supabase Dashboard:</strong> <a href="https://supabase.com/dashboard" target="_blank">View Database</a></li>
                    <li><strong>Tracking Events Table:</strong> Query <code>h2s_tracking_events</code> in Supabase SQL Editor</li>
                    <li><strong>Funnel Attribution:</strong> Query <code>h2s_tracking_funnel_attribution</code> for conversion data</li>
                    <li><strong>Meta Events Manager:</strong> <a href="https://business.facebook.com/events_manager2/list/pixel/2384221445259822" target="_blank">View in Facebook</a></li>
                </ul>

                <h3>üß™ Testing Commands</h3>
                <p>Use these curl commands or test in browser console:</p>
                
                <div class="code-block">
                    <button class="copy-btn" onclick="copyToClipboard(this, 'test-commands')">Copy</button>
                    <pre id="test-commands"># Test tracking endpoint health
curl https://h2s-backend-nrgjyhn31-tabari-ropers-projects-6f2e090b.vercel.app/api/track-ping

# Send a test event
curl -X POST https://h2s-backend-nrgjyhn31-tabari-ropers-projects-6f2e090b.vercel.app/api/track \
  -H 'Content-Type: application/json' \
  -d '{
    "event": "test_event",
    "visitor_id": "test-visitor-123",
    "session_id": "test-session-123",
    "page_url": "https://home2smart.com/test",
    "page_path": "/test",
    "metadata": {"test": true}
  }'

# Query events in Supabase SQL Editor:
SELECT * FROM h2s_tracking_events 
ORDER BY occurred_at DESC 
LIMIT 100;

# Query funnel attribution:
SELECT * FROM h2s_tracking_funnel_attribution 
WHERE conversion_type = 'purchase'
ORDER BY converted_at DESC;</pre>
                </div>

                <div class="info-box">
                    <strong>üí° Pro Tip:</strong> Run <code>seedAllTrackingData()</code> before presenting dashboard to clients or stakeholders. It populates realistic data so you can demonstrate functionality and insights.
                </div>

                <div class="info-box">
                    <strong>üîó Deployable tracking links</strong>
                    <ul style="margin-top: 10px; padding-left: 20px; line-height: 1.6;">
                        <li><a href="https://home2smart.com/" target="_blank" rel="noopener">Home</a> ‚Äî https://home2smart.com/</li>
                        <li><a href="https://home2smart.com/bundles" target="_blank" rel="noopener">Bundles</a> ‚Äî https://home2smart.com/bundles</li>
                        <li><a href="https://home2smart.com/tvmounting" target="_blank" rel="noopener">TV Mounting</a> ‚Äî https://home2smart.com/tvmounting</li>
                    </ul>
                    <p style="margin-top: 8px; font-size: 13px; color: #5f6368;">Copy/paste these into campaigns or QA; paths match live production.</p>
                </div>

                <h3>üìû Support & Troubleshooting</h3>
                <ul>
                    <li><strong>Dashboard not updating?</strong> Check Auto-Refresh is enabled (30s default)</li>
                    <li><strong>Page Type showing "No Data"?</strong> Ensure pages send <code>page_type</code> field in payload</li>
                    <li><strong>UTM not tracking?</strong> Verify URLs include <code>?</code> before utm_source (not <code>&</code>)</li>
                    <li><strong>Meta Pixel not firing?</strong> Check browser console (F12) for <code>fbq(...)</code> logs</li>
                    <li><strong>Events not appearing?</strong> Check Supabase <code>h2s_tracking_events</code> table directly</li>
                </ul>

            </div>
        </div>
    </div>

    <script>
        // Configuration - ALL TRACKING NOW USES SUPABASE
        // Dashboard analytics should be queried directly from Supabase SQL Editor
        // Example queries available in TRACKING_VERIFICATION.md
        // Deployable links for tracking verification / copy-paste:
        const DEPLOYABLE_LINKS = [
            { label: 'Home', url: 'https://home2smart.com/' },
            { label: 'Bundles', url: 'https://home2smart.com/bundles' },
            { label: 'TV Mounting', url: 'https://home2smart.com/tvmounting' }
        ];
        const API_HOST = 'https://h2s-backend.vercel.app';
        const TRACK_API = `${API_HOST}/api/track`; // Uses Database 1: h2s_tracking_events, h2s_tracking_visitors (fixed foreign key constraint)
        const TRACK_PING_API = `${API_HOST}/api/track-ping`;
        const API_BASE = `${API_HOST}/api/v1`; // analytics endpoints use /api/v1?action=... format (revenue, cohorts, funnel, users, meta_pixel_events, ai-insights) - all use Database 1
        
        let dashboardData = {};
        let autoRefreshInterval = null;
        const AUTO_REFRESH_ENABLED = true; // Set to false to disable
        const AUTO_REFRESH_SECONDS = 30; // Refresh every 30 seconds

        // Filters (default: exclude test/seed data; keep internal/admin excluded)
        const EXCLUDE_TEST_DATA = true;
        const INCLUDE_INTERNAL_DATA = false;
        const DEFAULT_TIME_RANGE_DAYS = 30; // Default to last 30 days

        function withExcludeTest(url) {
            if (!EXCLUDE_TEST_DATA) return url;
            return url.includes('?') ? `${url}&exclude_test=1` : `${url}?exclude_test=1`;
        }

        function withIncludeInternal(url) {
            if (!INCLUDE_INTERNAL_DATA) return url;
            return url.includes('?') ? `${url}&include_internal=1` : `${url}?include_internal=1`;
        }

        function withDateFilter(url) {
            const days = document.getElementById('timeRangeFilter')?.value || 
                        localStorage.getItem('h2s_time_range') || 
                        DEFAULT_TIME_RANGE_DAYS.toString();
            
            if (days === 'all') return url;
            
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - parseInt(days));
            const separator = url.includes('?') ? '&' : '?';
            return `${url}${separator}start_date=${startDate.toISOString()}`;
        }

        function withFilters(url) {
            return withDateFilter(withIncludeInternal(withExcludeTest(url)));
        }

        function asNumber(value, fallback = 0) {
            if (typeof value === 'number') return Number.isFinite(value) ? value : fallback;
            if (typeof value === 'string') {
                const cleaned = value.replace(/[^0-9.+-]/g, '');
                const parsed = parseFloat(cleaned);
                return Number.isFinite(parsed) ? parsed : fallback;
            }
            return fallback;
        }

        function showStatus(message, isWarning=true) {
            const el = document.getElementById('dataStatus');
            if (!el) return;
            if (!message) {
                el.style.display = 'none';
                return;
            }
            el.textContent = message;
            el.style.display = 'block';
            el.style.background = isWarning ? '#fff3cd' : '#d4edda';
            el.style.color = isWarning ? '#8a6d3b' : '#155724';
            el.style.borderColor = isWarning ? '#ffeeba' : '#c3e6cb';
        }

        // Lazy load Chart.js after critical content
        function loadChartJS() {
            return new Promise((resolve, reject) => {
                if (window.Chart) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize Dashboard
        async function initDashboard() {
            try {
                showLoading();
                
                // Initialize time range filter from localStorage
                initTimeRangeFilter();
                
                // Load critical data first
                await Promise.all([
                    loadKPIs(),
                    loadFunnelData(),
                    loadMetaPixelData()
                ]);
                
                // Load Chart.js and render charts
                await loadChartJS();
                await Promise.all([
                    loadCharts(),
                    loadTopUsers()
                ]);
                
                hideLoading();
                
                // Start auto-refresh if enabled
                if (AUTO_REFRESH_ENABLED && !autoRefreshInterval) {
                    autoRefreshInterval = setInterval(silentRefresh, AUTO_REFRESH_SECONDS * 1000);
                    console.log(`‚úÖ Auto-refresh enabled (every ${AUTO_REFRESH_SECONDS}s)`);
                }
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                hideLoading();
            }
        }
        
        // Silent refresh - updates data without showing loading overlay
        async function silentRefresh() {
            try {
                console.log('üîÑ Silent refresh...');
                
                // Update all metrics in background
                await Promise.all([
                    loadKPIs(),
                    loadFunnelData(),
                    loadMetaPixelData(),
                    loadTopUsers()
                ]);
                
                console.log('‚úÖ Metrics updated');
            } catch (error) {
                console.error('Silent refresh error:', error);
                // Don't show error to user, just log it
            }
        }

        async function loadKPIs() {
            try {
                // Show loading state
                renderKPIs([
                    { title: 'Total Sessions', value: 'Loading‚Ä¶', label: 'S', color: '#1493ff' },
                    { title: 'Total Revenue', value: 'Loading‚Ä¶', label: '$', color: '#34A853' },
                    { title: 'Total Orders', value: 'Loading‚Ä¶', label: 'O', color: '#FBBC04' },
                    { title: 'Avg Order Value', value: 'Loading‚Ä¶', label: 'A', color: '#EA4335' },
                    { title: 'Total Users', value: 'Loading‚Ä¶', label: 'U', color: '#9C27B0' },
                    { title: 'Customers', value: 'Loading‚Ä¶', label: 'C', color: '#FF9800' }
                ]);

                const [revenueRes, cohortRes] = await Promise.all([
                    fetch(withFilters(`${API_BASE}?action=revenue`)).then(r => r.json().catch(()=>({}))).catch(()=>({})),
                    fetch(withFilters(`${API_BASE}?action=cohorts`)).then(r => r.json().catch(()=>({}))).catch(()=>({}))
                ]);

                // statsRes was removed - we don't fetch it anymore
                const statsData = {};
                const revenueData = revenueRes.ok ? revenueRes.revenue : revenueRes;
                const cohortData = cohortRes.ok ? cohortRes.cohorts : cohortRes;
                dashboardData.stats = statsData;
                dashboardData.revenue = revenueData;
                dashboardData.cohorts = cohortData;

                const warnings = [];
                if (revenueRes.warning) warnings.push(`Revenue: ${revenueRes.warning}`);
                if (cohortRes.warning) warnings.push(`Cohorts: ${cohortRes.warning}`);
                if (warnings.length) showStatus(warnings.join(' ‚Ä¢ '));

                const kpis = [
                    {
                        title: 'Total Sessions',
                        value: (revenueData.total_orders || 0).toLocaleString(), // fallback; replace with real sessions if available
                        icon: 'üìä',
                        label: 'S',
                        color: '#1493ff'
                    },
                    {
                        title: 'Total Revenue',
                        value: typeof revenueData.total_revenue === 'number' 
                            ? `$${revenueData.total_revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                            : (revenueData.total_revenue || '$0.00'),
                        icon: 'üí∞',
                        label: '$',
                        color: '#34A853'
                    },
                    {
                        title: 'Total Orders',
                        value: (revenueData.total_orders || 0).toLocaleString(),
                        icon: 'üõí',
                        label: 'O',
                        color: '#FBBC04'
                    },
                    {
                        title: 'Avg Order Value',
                        value: typeof revenueData.average_order_value === 'number'
                            ? `$${revenueData.average_order_value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                            : (revenueData.average_order_value || '$0.00'),
                        icon: 'üìà',
                        label: 'A',
                        color: '#EA4335'
                    },
                    {
                        title: 'Total Users',
                        value: (cohortData.total_users || 0).toLocaleString(),
                        icon: 'üë§',
                        label: 'U',
                        color: '#9C27B0'
                    },
                    {
                        title: 'Customers',
                        value: (cohortData.user_cohorts?.customer || 0).toLocaleString(),
                        icon: '‚≠ê',
                        label: 'C',
                        color: '#FF9800'
                    }
                ];

                renderKPIs(kpis);
            } catch (error) {
                console.error('‚ùå Error loading KPIs:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                // Render empty KPIs so UI doesn't break
                renderKPIs([
                    { title: 'Total Sessions', value: '0', label: 'S', color: '#1493ff' },
                    { title: 'Total Revenue', value: '$0.00', label: '$', color: '#34A853' },
                    { title: 'Total Orders', value: '0', label: 'O', color: '#FBBC04' },
                    { title: 'Avg Order Value', value: '$0.00', label: 'A', color: '#EA4335' },
                    { title: 'Total Users', value: '0', label: 'U', color: '#9C27B0' },
                    { title: 'Customers', value: '0', label: 'C', color: '#FF9800' }
                ]);
            }
        }

        // Render KPIs
        function renderKPIs(kpis) {
            const grid = document.getElementById('kpiGrid');
            grid.innerHTML = kpis.map((kpi, index) => `
                <div class="kpi-card fade-in" style="animation-delay: ${index * 0.05}s">
                    <div class="kpi-header">
                        <div class="kpi-title">${kpi.title}</div>
                        <div class="kpi-icon" style="background: ${kpi.color}20; color: ${kpi.color}">
                            ${kpi.label}
                        </div>
                    </div>
                    <div class="kpi-value">${kpi.value}</div>
                </div>
            `).join('');
        }

        // Load Meta Pixel Data
        async function loadMetaPixelData() {
            try {
                const apiUrl = withFilters(`${API_BASE}?action=meta_pixel_events`);
                console.log('üîç Loading Meta Pixel data from:', apiUrl);
                // show quick loading hints
                document.getElementById('pixelTotalEvents').textContent = 'Loading...';
                document.getElementById('pixelEventsChange').textContent = 'Loading...';
                document.getElementById('pixelTopPage').textContent = 'Loading...';

                const response = await fetch(apiUrl).then(r => {
                    console.log('Meta Pixel response:', r.status, r.statusText);
                    if (!r.ok) throw new Error(`Meta Pixel fetch failed: ${r.status}`);
                    return r.json();
                });

                console.log('‚úÖ Meta Pixel Data loaded:', response);
                
                const payload = response.meta_pixel_events || response;
                if (payload && payload.summary) {
                    const summary = payload.summary;
                    const hasData = summary.total_events && summary.total_events > 0;
                    
                    // Update KPI values - show TRUE database count
                    const trueTotal = summary.total_events_in_database || summary.total_events || 0;
                    const displayedTotal = summary.total_events || 0;
                    
                    document.getElementById('pixelTotalEvents').textContent = 
                        trueTotal.toLocaleString();
                    
                    // Show note if we're displaying a subset
                    const displayNote = trueTotal > displayedTotal 
                        ? `Showing ${displayedTotal.toLocaleString()} of ${trueTotal.toLocaleString()} events` 
                        : `${summary.unique_sessions || 0} sessions tracked`;
                    
                    document.getElementById('pixelEventsChange').textContent = 
                        hasData ? displayNote : 'No tracking data yet';
                    document.getElementById('pixelEventsChange').className = hasData ? 'kpi-change positive' : 'kpi-change';
                    
                    document.getElementById('pixelMatchQuality').textContent = 
                        summary.unique_users ? `${summary.unique_users.toLocaleString()}` : '0';
                    
                    // Find top event type by count
                    var topContentName = 'No data';
                    var topContentCount = 0;
                    
                    if (summary.by_event_type) {
                        Object.entries(summary.by_event_type).forEach(function([eventName, eventData]) {
                            const count = typeof eventData === 'object' ? eventData.count : eventData;
                            if (count > topContentCount) {
                                topContentCount = count;
                                topContentName = eventName;
                            }
                        });
                    }
                    
                    document.getElementById('pixelTopPage').textContent = topContentName;
                    document.getElementById('pixelTopPageEvents').textContent = 
                        topContentCount > 0 ? `${topContentCount.toLocaleString()} events` : (hasData ? 'N/A' : 'Waiting for events...');
                    document.getElementById('pixelTopPageEvents').className = topContentCount > 0 ? 'kpi-change positive' : 'kpi-change';
                    
                    document.getElementById('pixelTotalValue').textContent = 
                        summary.total_revenue ? `$${summary.total_revenue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : '$0.00';
                    
                    const purchaseData = summary.by_event_type?.purchase || summary.by_event_type?.Purchase;
                    const totalConversions = typeof purchaseData === 'object' ? (purchaseData.count || 0) : (purchaseData || 0);
                    document.getElementById('pixelConversions').textContent = 
                        `${totalConversions.toLocaleString()} conversion${totalConversions !== 1 ? 's' : ''}`;
                    document.getElementById('pixelConversions').className = totalConversions > 0 ? 'kpi-change positive' : 'kpi-change';
                    
                    // Render charts - pass full payload for all new fields
                    renderMetaPixelCharts(payload, hasData);
                } else {
                    // No summary data - show empty state
                    document.getElementById('pixelTotalEvents').textContent = '0';
                    document.getElementById('pixelEventsChange').textContent = 'No tracking data yet';
                    document.getElementById('pixelEventsChange').className = 'kpi-change';
                    
                    document.getElementById('pixelMatchQuality').textContent = '0';
                    document.getElementById('pixelTopPage').textContent = 'No data';
                    document.getElementById('pixelTopPageEvents').textContent = 'Waiting for events...';
                    document.getElementById('pixelTopPageEvents').className = 'kpi-change';
                    
                    document.getElementById('pixelTotalValue').textContent = '$0.00';
                    document.getElementById('pixelConversions').textContent = '0 conversions';
                    document.getElementById('pixelConversions').className = 'kpi-change';
                    
                    renderMetaPixelCharts({}, false);
                }
            } catch (error) {
                console.error('‚ùå Error loading Meta Pixel data:', error);
                // Set error state
                document.getElementById('pixelTotalEvents').textContent = '0';
                document.getElementById('pixelEventsChange').textContent = 'Error loading data';
                document.getElementById('pixelEventsChange').className = 'kpi-change negative';
                
                document.getElementById('pixelMatchQuality').textContent = '-';
                document.getElementById('pixelTopPage').textContent = 'Error';
                document.getElementById('pixelTopPageEvents').textContent = 'Check console';
                document.getElementById('pixelTopPageEvents').className = 'kpi-change negative';
                
                document.getElementById('pixelTotalValue').textContent = '$0.00';
                document.getElementById('pixelConversions').textContent = 'Error loading';
                document.getElementById('pixelConversions').className = 'kpi-change negative';
                
                renderMetaPixelCharts({}, false);
            }
        }

        // Render Analytics Context - Enhanced storytelling with time context
        function renderAnalyticsContext(summary) {
            console.log('üé® renderAnalyticsContext called with summary:', summary);
            
            // Use actual backend field names
            const context = summary.tracking_period || summary.time_context || {};
            const growth = summary.growth_metrics || summary.growth_velocity || {};
            const recent = summary.recent_activity || {};
            const sessionQuality = summary.session_metrics || summary.session_quality || {};
            const funnelAnalysis = summary.funnel || summary.funnel_analysis || {};
            const topSource = summary.top_converting_sources?.[0] || summary.top_traffic_source || {};
            
            console.log('üìä Analytics data:', { context, growth, recent, sessionQuality, funnelAnalysis, topSource });
            
            const container = document.getElementById('analyticsContext');
            
            // Check for actual property names from backend
            if (!context.days_tracked && !growth.avg_users_per_day && !context.first_event_date) {
                console.warn('‚ö†Ô∏è No analytics context data available yet');
                container.innerHTML = '<p style="text-align: center; padding: 20px; opacity: 0.7;">üìä Gathering analytics context... Check back after data starts flowing.</p>';
                return;
            }
            
            console.log('‚úÖ Rendering analytics context with data');
            
            // Helper to format money
            const fmtMoney = (val) => {
                if (!val || val === 0) return '$0.00';
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val);
            };
            
            // Build grid layout with correct property names
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; font-size: 13px;">
                    <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">‚è±Ô∏è Tracking Period</div>
                        <div>${context.days_tracked ? `${context.days_tracked} days of data<br>Since: ${new Date(context.first_event_date).toLocaleDateString()}<br>Latest: ${new Date(context.latest_event_date).toLocaleDateString()}` : 'No tracking data yet'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">üìà Growth Velocity</div>
                        <div>${growth.avg_users_per_day ? `${growth.avg_users_per_day} users/day avg<br>${growth.avg_events_per_day || 'N/A'} events/day avg<br>${growth.user_acquisition_velocity || 'N/A'}` : 'Waiting for data...'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">üî• Recent Activity</div>
                        <div>${recent.last_24h ? `Last 24h: ${recent.last_24h.unique_users || 0} users, ${recent.last_24h.total_events || 0} events<br>Last 7d: ${recent.last_7d.unique_users || 0} users, ${recent.last_7d.total_events || 0} events<br>Last 30d: ${recent.last_30d.unique_users || 0} users` : 'No recent data'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">üíé Session Quality</div>
                        <div>${sessionQuality.avg_events_per_session ? `${sessionQuality.avg_events_per_session} events/session avg<br>Quality: ${sessionQuality.engagement_quality || 'Unknown'}<br>${sessionQuality.converted_sessions || 0} converted (${sessionQuality.session_conversion_rate || 0}%)` : 'No session data'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">üéØ Funnel Performance</div>
                        <div>${funnelAnalysis.visitors || funnelAnalysis.page_views ? `Views ‚Üí Engage: ${funnelAnalysis.browsers && funnelAnalysis.visitors ? ((funnelAnalysis.browsers / funnelAnalysis.visitors) * 100).toFixed(0) : 0}%<br>Engage ‚Üí Lead: ${funnelAnalysis.leads && funnelAnalysis.engaged ? ((funnelAnalysis.leads / funnelAnalysis.engaged) * 100).toFixed(0) : 0}%<br>Lead ‚Üí Purchase: ${funnelAnalysis.customers && funnelAnalysis.leads ? ((funnelAnalysis.customers / funnelAnalysis.leads) * 100).toFixed(0) : 0}%` : 'Building funnel...'}</div>
                    </div>
                    <div style="padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">üèÜ Top Source</div>
                        <div>${topSource.source || topSource.utm_source ? `${topSource.source || topSource.utm_source}<br>${topSource.conversions || 0} conversions (${topSource.conversion_rate || 0}%)<br>${fmtMoney(topSource.revenue || 0)} revenue` : 'No traffic data'}</div>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; border-left: 4px solid rgba(255,255,255,0.5);">
                    <div style="font-weight: 600; margin-bottom: 4px;">üí° Key Insight</div>
                    <div>${(() => {
                        // Generate intelligent insights based on actual data
                        const hasData = funnelAnalysis.visitors || sessionQuality.total_sessions || growth.avg_users_per_day;
                        
                        if (!hasData) {
                            return 'Gathering insights... Data will appear as tracking flows in.';
                        }
                        
                        // Session Quality Insight
                        if (sessionQuality.avg_events_per_session) {
                            const quality = sessionQuality.engagement_quality || 
                                (sessionQuality.avg_events_per_session >= 5 ? 'High' : 
                                 sessionQuality.avg_events_per_session >= 3 ? 'Medium' : 'Low');
                            
                            if (quality === 'Low' && sessionQuality.avg_events_per_session < 2) {
                                return `‚ö†Ô∏è <strong>Low engagement detected:</strong> Average ${sessionQuality.avg_events_per_session} events per session. Users are bouncing quickly. Consider adding interactive elements, clearer CTAs, or reducing page load times to increase engagement.`;
                            }
                            if (quality === 'Medium') {
                                return `üìä <strong>Moderate engagement:</strong> ${sessionQuality.avg_events_per_session} events per session shows decent interest. Test adding urgency elements or limited-time offers to convert browsers into buyers.`;
                            }
                            if (quality === 'High') {
                                return `üöÄ <strong>Strong engagement:</strong> ${sessionQuality.avg_events_per_session} events per session indicates high interest! Focus on optimizing checkout flow and retargeting engaged users who didn't convert.`;
                            }
                        }
                        
                        // Growth Insight
                        if (growth.avg_users_per_day && growth.avg_users_per_day > 50) {
                            return `üìà <strong>Strong traffic growth:</strong> Averaging ${growth.avg_users_per_day} users/day. Make sure your conversion funnel can handle this volume and consider scaling your team to match demand.`;
                        }
                        
                        // Conversion Insight (fallback)
                        if (funnelAnalysis.customers && funnelAnalysis.visitors) {
                            const convRate = ((funnelAnalysis.customers / funnelAnalysis.visitors) * 100);
                            if (convRate >= 3) {
                                return `‚úÖ <strong>Healthy conversion rate:</strong> ${convRate.toFixed(2)}% of visitors become customers. Test optimizing your lead-to-purchase flow for even better results.`;
                            } else {
                                return `‚ö†Ô∏è <strong>Conversion opportunity:</strong> Only ${convRate.toFixed(2)}% of visitors convert. Focus on improving engagement, lead capture quality, and reducing checkout friction.`;
                            }
                        }
                        
                        // Default tracking period insight
                        if (context.days_tracked === 1) {
                            return `üìÖ <strong>Early data collection:</strong> Only ${context.days_tracked} day of tracking so far. Insights will become more actionable as you accumulate 7-14 days of data.`;
                        }
                        
                        return 'Continue tracking to unlock deeper insights. AI analysis available via "Generate Insights" button above.';
                    })()}</div>
                </div>
            `;
        }

        // Render Meta Pixel Charts - now uses full payload with all extracted fields
        function renderMetaPixelCharts(payload, hasData) {
            const summary = payload.summary || {};
            
            // Render Analytics Context first
            renderAnalyticsContext(summary);
            
            // Event Type Distribution
            const eventTypesContainer = document.getElementById('pixelEventTypes');
            if (summary.by_event_type && Object.keys(summary.by_event_type).length > 0) {
                const eventTypes = Object.entries(summary.by_event_type)
                    .map(([name, data]) => {
                        // Handle both {count, revenue} object and plain number
                        const count = typeof data === 'object' ? (data.count || 0) : data;
                        const revenue = typeof data === 'object' ? (data.revenue || 0) : 0;
                        return [name, { count, revenue }];
                    })
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 8);
                
                const maxCount = eventTypes[0][1].count;
                eventTypesContainer.innerHTML = eventTypes.map(([name, data]) => `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 13px; color: #333; font-weight: 600;">${name}</span>
                            <span style="font-size: 13px; color: #1493ff; font-weight: 700;">${data.count.toLocaleString()}${data.revenue > 0 ? ` ¬∑ $${data.revenue.toFixed(0)}` : ''}</span>
                        </div>
                        <div style="background: #f0f0f0; border-radius: 4px; height: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #1493ff, #0d7de0); height: 100%; width: ${(data.count / maxCount * 100).toFixed(1)}%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `).join('');
            } else {
                eventTypesContainer.innerHTML = `
                    <div style="color: #999; text-align: center; padding: 40px 20px; background: #f9f9f9; border-radius: 8px; border: 2px dashed #ddd;">
                        <div style="font-size: 36px; margin-bottom: 12px;">üìä</div>
                        <div style="font-size: 15px; font-weight: 600; color: #666; margin-bottom: 8px;">No Event Data Yet</div>
                        <div style="font-size: 13px; color: #999;">Events like PageView, Purchase, and AddToCart will appear here once tracking begins.</div>
                    </div>
                `;
            }

            // Page Performance - use scored pages if available, otherwise fall back to by_page_type/by_page_path
            const pagePerformanceContainer = document.getElementById('pixelPagePerformance');
            const scoredPages = payload.page_performance || [];
            
            if (scoredPages && scoredPages.length > 0) {
                // Display top performing pages with scores
                const maxScore = scoredPages[0].score || 1;
                pagePerformanceContainer.innerHTML = scoredPages.slice(0, 8).map((page) => {
                    const path = page.path || 'Unknown';
                    const score = page.score || 0;
                    const views = page.views || 0;
                    const leads = page.leads || 0;
                    const purchases = page.purchases || 0;
                    const revenue = page.revenue || 0;
                    const conversionRate = page.conversion_rate || 0;
                    
                    return `
                        <div style="margin-bottom: 16px; padding: 12px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #34A853;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; color: #333; font-weight: 700; margin-bottom: 4px;">${path}</div>
                                    <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                                        ${views} views ¬∑ ${leads} leads ¬∑ ${purchases} purchases
                                        ${revenue > 0 ? ` ¬∑ $${revenue.toFixed(0)}` : ''}
                                    </div>
                                </div>
                                <div style="text-align: right; margin-left: 12px;">
                                    <div style="font-size: 18px; color: #34A853; font-weight: 900;">${score}</div>
                                    <div style="font-size: 10px; color: #999; text-transform: uppercase;">Score</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <div style="flex: 1; background: #f0f0f0; border-radius: 4px; height: 8px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #34A853, #2d8e47); height: 100%; width: ${(score / maxScore * 100).toFixed(1)}%; transition: width 0.5s ease;"></div>
                                </div>
                                <div style="font-size: 11px; color: #666; white-space: nowrap; margin-left: 8px;">
                                    ${conversionRate > 0 ? `${conversionRate.toFixed(1)}% conv` : '0% conv'}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                // Fallback to page type/path data if scored pages not available
                const pageData = payload.by_page_type || payload.by_page_path || {};
                
                if (Object.keys(pageData).length > 0) {
                    const pageEntries = Object.entries(pageData)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 8);
                    
                    const maxCount = pageEntries[0][1];
                    pagePerformanceContainer.innerHTML = pageEntries.map(([name, count]) => `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 13px; color: #333; font-weight: 600;">${name}</span>
                                <span style="font-size: 13px; color: #34A853; font-weight: 700;">${count.toLocaleString()}</span>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 4px; height: 10px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #34A853, #2d8e47); height: 100%; width: ${(count / maxCount * 100).toFixed(1)}%; transition: width 0.5s ease;"></div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    pagePerformanceContainer.innerHTML = `
                        <div style="color: #999; text-align: center; padding: 40px 20px; background: #f9f9f9; border-radius: 8px; border: 2px dashed #ddd;">
                            <div style="font-size: 36px; margin-bottom: 12px;">üìÑ</div>
                            <div style="font-size: 15px; font-weight: 600; color: #666; margin-bottom: 8px;">No Page Data Yet</div>
                            <div style="font-size: 13px; color: #999;">Performance metrics for Home, Shop, Automations, and other pages will appear here.</div>
                        </div>
                    `;
                }
            }

            // UTM Sources - now uses by_utm_source (plain object)
            const utmSourcesContainer = document.getElementById('pixelUTMSources');
            const sourceData = payload.by_utm_source || {};
            
            if (Object.keys(sourceData).length > 0) {
                const sourceEntries = Object.entries(sourceData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 8);
                
                const maxCount = sourceEntries[0][1];
                utmSourcesContainer.innerHTML = sourceEntries.map(([name, count]) => `
                    <div style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="font-size: 13px; color: #333; font-weight: 600;">${name || 'Direct'}</span>
                            <span style="font-size: 13px; color: #FBBC04; font-weight: 700;">${count.toLocaleString()}</span>
                        </div>
                        <div style="background: #f0f0f0; border-radius: 4px; height: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #FBBC04, #e0a800); height: 100%; width: ${(count / maxCount * 100).toFixed(1)}%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `).join('');
            } else {
                utmSourcesContainer.innerHTML = `
                    <div style="color: #999; text-align: center; padding: 40px 20px; background: #f9f9f9; border-radius: 8px; border: 2px dashed #ddd;">
                        <div style="font-size: 36px; margin-bottom: 12px;">üîó</div>
                        <div style="font-size: 15px; font-weight: 600; color: #666; margin-bottom: 8px;">No Attribution Data Yet</div>
                        <div style="font-size: 13px; color: #999;">Traffic sources from Google, Facebook, Email campaigns, and Direct will appear here.</div>
                    </div>
                `;
            }
        }

        // Load Funnel Data
        async function loadFunnelData() {
            try {
                const funnelUrl = withFilters(`${API_BASE}?action=funnel`);
                console.log('üîç Loading funnel data from:', funnelUrl);
                const funnelRes = await fetch(funnelUrl).then(r => r.json().catch(()=>({}))).catch(()=>({}));
                console.log('‚úÖ Funnel data loaded:', funnelRes);
                const funnelData = funnelRes.funnel || funnelRes || {};
                if (funnelRes.warning) {
                    showStatus(`Funnel: ${funnelRes.warning}`);
                }
                dashboardData.funnel = funnelData;

                const stages = [
                    { name: 'Visitors', count: funnelData.stage_distribution?.visitor || 0, rate: '100%' },
                    { name: 'Browsers', count: funnelData.stage_distribution?.browser || 0, rate: funnelData.conversion_rates?.visitor_to_browser || '0%' },
                    { name: 'Engaged', count: funnelData.stage_distribution?.engaged || 0, rate: funnelData.conversion_rates?.browser_to_engaged || '0%' },
                    { name: 'Leads', count: funnelData.totals?.leads || 0, rate: funnelData.conversion_rates?.engaged_to_lead || '0%' },
                    { name: 'Customers', count: funnelData.totals?.customers || 0, rate: funnelData.conversion_rates?.lead_to_customer || '0%' }
                ];

                renderFunnel(stages);
            } catch (error) {
                console.error('‚ùå Error loading funnel:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                // Render empty funnel
                renderFunnel([
                    { name: 'Visitors', count: 0, rate: '0%' },
                    { name: 'Browsers', count: 0, rate: '0%' },
                    { name: 'Engaged', count: 0, rate: '0%' },
                    { name: 'Leads', count: 0, rate: '0%' },
                    { name: 'Customers', count: 0, rate: '0%' }
                ]);
            }
        }

        // Render Funnel
        function renderFunnel(stages) {
            const container = document.getElementById('funnelVisualization');
            const maxCount = Math.max(...stages.map(s => s.count), 1);

            container.innerHTML = stages.map(stage => {
                const width = Math.max((stage.count / maxCount) * 100, 5);
                return `
                    <div class="funnel-stage">
                        <div class="funnel-label">
                            <span class="stage-name">${stage.name}</span>
                            <span class="stage-count">${stage.count.toLocaleString()} ¬∑ ${stage.rate}</span>
                        </div>
                        <div class="funnel-bar" style="width: ${width}%">
                            ${stage.count.toLocaleString()}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load Charts
        async function loadCharts() {
            try {
                const revenueData = dashboardData.revenue || {};
                const revenueByDay = revenueData.revenue_by_day || {};
                const dates = Object.keys(revenueByDay).sort();
                const revenues = dates.map(d => revenueByDay[d]);
                const hasRevenueData = dates.length > 0 && revenues.some(v => v > 0);

                if (!hasRevenueData) {
                    document.getElementById('revenueChart').parentElement.innerHTML = `
                        <div style="text-align: center; padding: 32px;">
                            <div style="font-size: 36px; margin-bottom: 12px; opacity: 0.5;">üìà</div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--cobalt); margin-bottom: 6px;">No Revenue Data Yet</div>
                            <div style="font-size: 12px; color: #5f6368;">Charts will appear once orders are processed.</div>
                        </div>
                    `;
                    return;
                }

                new Chart(document.getElementById('revenueChart'), {
                    type: 'line',
                    data: {
                        labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: [{
                            label: 'Revenue',
                            data: revenues,
                            borderColor: '#34A853',
                            backgroundColor: 'rgba(52, 168, 83, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#34A853',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(10, 42, 90, 0.95)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => '$' + value.toLocaleString(),
                                    font: { size: 12, weight: '600' },
                                    color: '#5f6368'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                ticks: {
                                    font: { size: 12, weight: '600' },
                                    color: '#5f6368'
                                },
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });

                // Device Chart
                new Chart(document.getElementById('deviceChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Desktop', 'Mobile', 'Tablet'],
                        datasets: [{
                            data: [45, 40, 15],
                            backgroundColor: ['#1493ff', '#34A853', '#FBBC04'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    padding: 16,
                                    font: { size: 13, weight: '600' },
                                    color: '#0a2a5a',
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(10, 42, 90, 0.95)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ${percentage}%`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        // Load Top Users
        async function loadTopUsers() {
            try {
                const usersUrl = withFilters(`${API_BASE}?action=users&limit=10`);
                console.log('üîç Loading users from:', usersUrl);
                const tbody = document.querySelector('#topUsersTable tbody');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:24px;">Loading users...</td></tr>';
                const usersResponse = await fetch(usersUrl).then(r => {
                    console.log('Users response:', r.status, r.statusText);
                    if (!r.ok) {
                        console.warn('Users endpoint returned', r.status, '- endpoint may not exist');
                        return { ok: false, users: [] };
                    }
                    return r.json();
                }).catch(err => {
                    console.warn('Users fetch failed:', err);
                    return { ok: false, users: [] };
                });
                console.log('‚úÖ Users data loaded:', usersResponse);
                
                // Handle empty or failed responses gracefully
                if (!usersResponse || usersResponse.ok === false || (!usersResponse.users && !usersResponse.top_users && !Array.isArray(usersResponse))) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 32px; color: #5f6368;">No customer data available yet. Customer data will appear here once purchases are tracked.</td></tr>';
                    return;
                }
                
                const usersPayload = usersResponse.ok ? usersResponse.users : usersResponse;
                const topUsers = usersPayload?.top_users || usersPayload || [];
                
                if (topUsers.length > 0) {
                    tbody.innerHTML = topUsers.map(user => `
                        <tr>
                            <td><strong>${user.Email || user.Visitor_ID || 'N/A'}</strong></td>
                            <td>${(user.Total_Orders || 0).toLocaleString()}</td>
                            <td><strong style="color: var(--success)">$${((user.Lifetime_Revenue || 0).toFixed(2)).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</strong></td>
                            <td>${user.Last_Purchase_Date ? new Date(user.Last_Purchase_Date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A'}</td>
                            <td><span style="color: ${user.Current_Funnel_Stage === 'customer' ? 'var(--success)' : 'var(--warning)'}">‚óè</span> ${(user.Current_Funnel_Stage || 'customer').charAt(0).toUpperCase() + (user.Current_Funnel_Stage || 'customer').slice(1)}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 32px; color: #5f6368;">No customer data available yet. Customer data will appear here once purchases are tracked.</td></tr>';
                }

            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack,
                    type: error.constructor.name
                });
                document.querySelector('#topUsersTable tbody').innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 32px; color: var(--danger);">Error loading customer data. Check console (F12) for details.</td></tr>';
            }
        }

        // Generate AI Report
        async function generateAIReport() {
            const section = document.getElementById('aiReportSection');
            const content = document.getElementById('aiReportContent');
            
            if (!section || !content) {
                console.error('AI report elements not found');
                return;
            }
            
            // Show loading
            section.style.display = 'block';
            content.innerHTML = '<div class="loading"><div class="spinner" role="status" aria-label="Generating AI insights"></div><p style="margin-top: 16px; color: var(--cobalt); font-weight: 600;">Generating insights...</p></div>';
            section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            try {
                console.log('üì§ Sending AI report request to /api/v1?action=ai-insights...');
                const response = await fetch(`${API_BASE}?action=ai-insights`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'ai_report' })
                });
                
                console.log('üì• Response status:', response.status, response.statusText);
                console.log('ÔøΩ Content-Type:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('‚úÖ AI Report result:', result);
                
                if (result.status === 'success' && result.report) {
                    content.innerHTML = result.report;
                    console.log('‚úÖ AI report rendered successfully');
                    
                    // Store report for email
                    window.currentAIReport = result.report;
                    window.currentAIReportTimestamp = result.timestamp;
                    
                    // Show email button
                    document.getElementById('emailReportBtn').style.display = 'inline-flex';
                } else {
                    throw new Error(result.message || 'Failed to generate report');
                }
                
            } catch (error) {
                console.error('‚ùå AI Report Error:', error);
                content.innerHTML = `
                    <div style="padding: 20px; background: #fee; border-left: 4px solid #EA4335; border-radius: 8px;">
                        <h3 style="margin: 0 0 12px 0; color: #c5221f;">‚ö†Ô∏è Failed to Generate AI Report</h3>
                        <p style="margin: 8px 0; color: #666;"><strong>Error:</strong> ${error.message}</p>
                        <details style="margin-top: 12px;">
                            <summary style="cursor: pointer; color: #1a73e8; font-weight: 600;">Troubleshooting Steps</summary>
                            <ol style="margin: 12px 0 0 20px; color: #666; line-height: 1.8;">
                                <li>Check browser console (F12) for detailed errors</li>
                                <li>Verify OpenAI API key in Apps Script Project Settings</li>
                                <li>Ensure you have tracking data in sheets (run test functions)</li>
                                <li>Check Apps Script Execution Log for backend errors</li>
                                <li>Try refreshing the page and clicking "Generate Insights" again</li>
                            </ol>
                        </details>
                    </div>
                `;
            }
        }

        // Email AI Report
        async function emailAIReport() {
            if (!window.currentAIReport) {
                alert('No report to email. Please generate a report first.');
                return;
            }

            const btn = document.getElementById('emailReportBtn');
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'üìß Sending...';

            try {
                const timestamp = new Date(window.currentAIReportTimestamp || new Date()).toLocaleDateString();
                
                // Create styled email HTML
                const emailHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; background: white; }
        .header { background: #0a2a5a; color: white; padding: 30px 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 24px; }
        .header p { margin: 10px 0 0; font-size: 14px; opacity: 0.9; }
        .content { padding: 30px 20px; line-height: 1.6; color: #333; }
        .content h2, .content h3, .content h4 { color: #0a2a5a; margin-top: 20px; }
        .content ul, .content ol { padding-left: 20px; }
        .content strong { color: #0a2a5a; }
        .footer { background: #f5f5f5; padding: 20px; text-align: center; font-size: 12px; color: #666; border-top: 2px solid #e0e0e0; }
        .footer a { color: #1493ff; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† Home2Smart AI Marketing Report</h1>
            <p>Generated: ${timestamp}</p>
        </div>
        <div class="content">
            ${window.currentAIReport}
        </div>
        <div class="footer">
            <p><strong>Home2Smart</strong> | Smart Home Installation Services | NC & SC</p>
            <p><a href="mailto:contact@home2smart.com">contact@home2smart.com</a></p>
        </div>
    </div>
</body>
</html>`;

                // Send via backend (POST without fn parameter)
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        html: emailHTML,
                        timestamp: timestamp
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to send email: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.status === 'success') {
                    btn.innerHTML = '‚úÖ Sent!';
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.disabled = false;
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Failed to send email');
                }

            } catch (error) {
                console.error('‚ùå Email Error:', error);
                btn.innerHTML = '‚ùå Failed';
                alert('Failed to send email: ' + error.message);
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 3000);
            }
        }

        // Handle time range filter change
        function handleTimeRangeChange() {
            const select = document.getElementById('timeRangeFilter');
            const days = select.value;
            
            // Save preference to localStorage
            localStorage.setItem('h2s_time_range', days);
            
            // Reload dashboard with new filter
            console.log(`üìÖ Time range changed to: ${days === 'all' ? 'All Time' : days + ' days'}`);
            initDashboard();
        }

        // Initialize time range filter on load
        function initTimeRangeFilter() {
            const saved = localStorage.getItem('h2s_time_range');
            if (saved) {
                const select = document.getElementById('timeRangeFilter');
                if (select) select.value = saved;
            }
        }

        // Handle time range filter change
        function handleTimeRangeChange() {
            const select = document.getElementById('timeRangeFilter');
            const days = select.value;
            
            // Save preference to localStorage
            localStorage.setItem('h2s_time_range', days);
            
            // Reload dashboard with new filter
            console.log(`üìÖ Time range changed to: ${days === 'all' ? 'All Time' : days + ' days'}`);
            initDashboard();
        }

        // Initialize time range filter on load
        function initTimeRangeFilter() {
            const saved = localStorage.getItem('h2s_time_range');
            if (saved) {
                const select = document.getElementById('timeRangeFilter');
                if (select) select.value = saved;
            }
        }

        // Refresh Data (manual button click)
        async function refreshData() {
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>‚ü≥</span>';
            
            try {
                // Use silent refresh (no loading overlay)
                await silentRefresh();
                
                btn.innerHTML = '<span>‚úì</span>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 1500);
            } catch (error) {
                btn.innerHTML = '<span>‚úó</span>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Loading State
        let loadingOverlay = null;
        
        function showLoading() {
            if (!loadingOverlay) {
                loadingOverlay = document.createElement('div');
                loadingOverlay.className = 'loading-overlay';
                loadingOverlay.innerHTML = `
                    <div class="loading-card">
                        <div class="spinner"></div>
                        <p style="margin-top: 20px; color: var(--cobalt); font-weight: 700;">Loading dashboard...</p>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
            }
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // Tracking Reference Modal Functions
        function openTrackingReference() {
            document.getElementById('trackingModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeTrackingReference() {
            document.getElementById('trackingModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        function copyToClipboard(button, elementId) {
            const text = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy. Please select and copy manually.');
            });
        }

        // Close modal on outside click
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('trackingModal');
            if (e.target === modal) {
                closeTrackingReference();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTrackingReference();
            }
        });

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initDashboard);
        } else {
            initDashboard();
        }

        // Performance optimization: defer non-critical tasks
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                // Preload Chart.js during idle time
                loadChartJS().catch(() => {});
            });
        }
    </script>

    <!-- ============================================================================
         TRACKING STATUS INDICATOR
         ============================================================================
         Shows real-time tracking health status in dashboard
         Auto-checks backend connectivity and displays confirmation
         ============================================================================ -->
    
    <style>
    #tracking-status-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #0a2a5a 0%, #1a4a8a 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        font-family: 'Archivo', -apple-system, sans-serif;
        font-size: 13px;
        z-index: 999999;
        min-width: 300px;
        max-width: 340px;
        transition: all 0.3s ease;
        border: 2px solid rgba(255,255,255,0.1);
    }

    #tracking-status-widget.hidden {
        opacity: 0;
        transform: translateY(20px);
        pointer-events: none;
    }

    #tracking-status-widget .status-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    #tracking-status-widget .status-title {
        font-weight: 700;
        font-size: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    #tracking-status-widget .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #00ff88;
        box-shadow: 0 0 8px #00ff88;
        animation: pulse-indicator 2s infinite;
    }

    #tracking-status-widget .status-indicator.error {
        background: #ff6464;
        box-shadow: 0 0 8px #ff6464;
    }

    @keyframes pulse-indicator {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    #tracking-status-widget .status-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 12px;
    }

    #tracking-status-widget .status-label {
        color: rgba(255,255,255,0.7);
    }

    #tracking-status-widget .status-value {
        font-weight: 600;
        font-family: 'Courier New', monospace;
        color: #00ff88;
        font-size: 11px;
    }

    #tracking-status-widget .status-value.error {
        color: #ff6464;
    }

    #tracking-status-widget .close-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 20px;
        padding: 0;
        line-height: 1;
        opacity: 0.6;
        transition: opacity 0.2s;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #tracking-status-widget .close-btn:hover {
        opacity: 1;
    }

    #tracking-status-widget .backend-status {
        margin-top: 10px;
        padding: 8px 12px;
        background: rgba(0,255,136,0.15);
        border-radius: 6px;
        font-size: 11px;
        border-left: 3px solid #00ff88;
        line-height: 1.4;
    }

    #tracking-status-widget .backend-status.error {
        background: rgba(255,100,100,0.15);
        border-left-color: #ff6464;
        color: #ffcccc;
    }

    #tracking-status-widget .backend-status.checking {
        background: rgba(255,200,100,0.15);
        border-left-color: #ffc864;
        color: #ffe4b3;
    }

    #tracking-status-widget .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    #tracking-status-widget .metric-box {
        background: rgba(255,255,255,0.05);
        padding: 6px 8px;
        border-radius: 6px;
        text-align: center;
    }

    #tracking-status-widget .metric-label {
        font-size: 10px;
        color: rgba(255,255,255,0.6);
        margin-bottom: 2px;
    }

    #tracking-status-widget .metric-value {
        font-size: 14px;
        font-weight: 700;
        color: #00ff88;
    }

    @media (max-width: 768px) {
        #tracking-status-widget {
            bottom: 10px;
            right: 10px;
            left: 10px;
            min-width: 0;
            max-width: none;
        }
    }
    </style>

    <div id="tracking-status-widget">
        <div class="status-header">
            <div class="status-title">
                <div class="status-indicator" id="status-indicator"></div>
                <span id="status-title-text">Tracking Active</span>
            </div>
            <button class="close-btn" onclick="closeTrackingStatus()" aria-label="Close tracking status">√ó</button>
        </div>
        
        <div class="status-row">
            <span class="status-label">Backend:</span>
            <span class="status-value" id="backend-status-text">Checking...</span>
        </div>
        
        <div class="status-row">
            <span class="status-label">Last Event:</span>
            <span class="status-value" id="last-event-time">Loading...</span>
        </div>
        
        <div class="backend-status checking" id="backend-message">
            Verifying tracking system health...
        </div>

        <div class="metrics-grid" id="metrics-grid" style="display: none;">
            <div class="metric-box">
                <div class="metric-label">Events (24h)</div>
                <div class="metric-value" id="events-24h">0</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">Meta Pixel</div>
                <div class="metric-value" id="meta-24h">0</div>
            </div>
        </div>
    </div>

    <script>
    // Tracking Status Widget Functionality
    (function(){
        var widget = document.getElementById('tracking-status-widget');
        var indicator = document.getElementById('status-indicator');
        var titleText = document.getElementById('status-title-text');
        var backendStatusText = document.getElementById('backend-status-text');
        var lastEventTime = document.getElementById('last-event-time');
        var backendMessage = document.getElementById('backend-message');
        var metricsGrid = document.getElementById('metrics-grid');
        var events24h = document.getElementById('events-24h');
        var meta24h = document.getElementById('meta-24h');
        
        // Check tracking health
        function checkTrackingHealth(){
            fetch(TRACK_PING_API, { method: 'GET' })
                .then(function(res){ return res.json(); })
                .then(function(data){
                    if (data.ok && data.healthy) {
                        // HEALTHY - Tracking working
                        indicator.classList.remove('error');
                        titleText.textContent = 'Tracking Active ‚úì';
                        backendStatusText.textContent = 'Connected';
                        backendStatusText.classList.remove('error');
                        
                        // Prefer explicit last_event_mins; if missing but events exist, treat as fresh
                        var lastMins = (data.last_event_mins !== undefined && data.last_event_mins !== null)
                            ? data.last_event_mins
                            : ((data.total_events_24h || 0) > 0 ? 0 : null);
                        if (lastMins === null) {
                            lastEventTime.textContent = 'Unknown';
                        } else if (lastMins === 0) {
                            lastEventTime.textContent = 'Just now';
                        } else if (lastMins === 1) {
                            lastEventTime.textContent = '1 min ago';
                        } else {
                            lastEventTime.textContent = lastMins + ' mins ago';
                        }
                        lastEventTime.classList.remove('error');
                        
                        backendMessage.className = 'backend-status';
                        backendMessage.textContent = '‚úì All systems operational ‚Ä¢ ' + 
                            (data.total_events_24h || 0) + ' events tracked today';
                        
                        // Show metrics
                        metricsGrid.style.display = 'grid';
                        events24h.textContent = data.total_events_24h || 0;
                        meta24h.textContent = data.total_meta_24h || 0;
                        
                    } else if (data.ok && !data.healthy) {
                        // DEGRADED - No recent events
                        indicator.classList.add('error');
                        titleText.textContent = 'Tracking Alert ‚ö†';
                        backendStatusText.textContent = 'Degraded';
                        backendStatusText.classList.add('error');
                        
                        var lastMins = (data.last_event_mins !== undefined && data.last_event_mins !== null)
                            ? data.last_event_mins
                            : null;
                        lastEventTime.textContent = (lastMins === null) ? 'Unknown' : (lastMins + ' mins ago');
                        lastEventTime.classList.add('error');
                        
                        backendMessage.className = 'backend-status error';
                        backendMessage.textContent = (lastMins === null)
                            ? '‚ö† No recent event timestamp available ‚Ä¢ Verify tracking ping'
                            : ('‚ö† No events in ' + lastMins + ' minutes ‚Ä¢ Check tracking code on pages');
                        
                        metricsGrid.style.display = 'none';
                        
                    } else {
                        // ERROR - Backend issue
                        indicator.classList.add('error');
                        titleText.textContent = 'Tracking Error ‚úó';
                        backendStatusText.textContent = 'Error';
                        backendStatusText.classList.add('error');
                        lastEventTime.textContent = 'Unknown';
                        lastEventTime.classList.add('error');
                        
                        backendMessage.className = 'backend-status error';
                        backendMessage.textContent = '‚úó ' + (data.error || 'Backend unreachable');
                        
                        metricsGrid.style.display = 'none';
                    }
                })
                .catch(function(err){
                    // NETWORK ERROR
                    indicator.classList.add('error');
                    titleText.textContent = 'Connection Error ‚úó';
                    backendStatusText.textContent = 'Offline';
                    backendStatusText.classList.add('error');
                    lastEventTime.textContent = 'N/A';
                    lastEventTime.classList.add('error');
                    
                    backendMessage.className = 'backend-status error';
                    backendMessage.textContent = '‚úó Cannot reach backend ‚Ä¢ Check internet connection';
                    
                    metricsGrid.style.display = 'none';
                });
        }
        
        // Close widget
        window.closeTrackingStatus = function(){
            widget.classList.add('hidden');
            // Store preference
            sessionStorage.setItem('tracking_status_closed', 'true');
        };
        
        // Keyboard shortcut: Ctrl+Shift+T to toggle
        document.addEventListener('keydown', function(e){
            if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                widget.classList.toggle('hidden');
                if (!widget.classList.contains('hidden')) {
                    sessionStorage.removeItem('tracking_status_closed');
                    checkTrackingHealth();
                }
            }
        });
        
        // Auto-hide after 10 seconds (only if healthy)
        setTimeout(function(){
            // Only auto-hide if user hasn't manually closed it
            if (!sessionStorage.getItem('tracking_status_closed')) {
                // Backend tracking_health endpoint not present; auto-hide quietly
                widget.classList.add('hidden');
            }
        }, 10000);
        
        // Initial check after 1 second (let dashboard load first)
        setTimeout(function(){
            // Check if user closed it in this session
            if (!sessionStorage.getItem('tracking_status_closed')) {
                checkTrackingHealth();
            } else {
                widget.classList.add('hidden');
            }
        }, 1000);
        
        // Re-check every 2 minutes if widget is visible
        setInterval(function(){
            if (!widget.classList.contains('hidden')) {
                checkTrackingHealth();
            }
        }, 120000);
        
    })();
    </script>
    
    <!-- ===== TRACKING CLIENT ===== -->
    <script>
    (function() {
        'use strict';
        
        // Use Database 1 backend URL (same as global TRACK_API) - fixed foreign key constraint
        const TRACK_API = 'https://h2s-backend.vercel.app/api/track';
        const VISITOR_KEY = 'h2s_visitor_id';
        const SESSION_KEY = 'h2s_session_id';
        
        // Get or create visitor ID (persistent across sessions)
        function getVisitorId() {
            let vid = localStorage.getItem(VISITOR_KEY);
            if (!vid) {
                vid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
                localStorage.setItem(VISITOR_KEY, vid);
            }
            return vid;
        }
        
        // Get or create session ID (per browser session)
        function getSessionId() {
            let sid = sessionStorage.getItem(SESSION_KEY);
            if (!sid) {
                sid = crypto.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random());
                sessionStorage.setItem(SESSION_KEY, sid);
            }
            return sid;
        }
        
        // Extract UTM params from URL
        function extractUTM() {
            const params = new URLSearchParams(window.location.search);
            return {
                utm_source: params.get('utm_source') || null,
                utm_medium: params.get('utm_medium') || null,
                utm_campaign: params.get('utm_campaign') || null,
                utm_term: params.get('utm_term') || null,
                utm_content: params.get('utm_content') || null
            };
        }
        
        // Event queue with retry logic
        const eventQueue = [];
        let isSending = false;
        
        // Send event with retry
        function sendEvent(payload, retries = 1) {
            const useBeacon = navigator.sendBeacon && retries === 1;
            
            if (useBeacon) {
                // Use sendBeacon for page unload scenarios
                const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
                if (navigator.sendBeacon(TRACK_API, blob)) {
                    return Promise.resolve();
                }
            }
            
            // Fallback to fetch with keepalive
            return fetch(TRACK_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                keepalive: true
            })
            .then(res => {
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .catch(err => {
                if (retries > 0) {
                    // Retry once after 500ms
                    return new Promise(resolve => {
                        setTimeout(() => {
                            sendEvent(payload, retries - 1).then(resolve).catch(() => resolve());
                        }, 500);
                    });
                }
                console.warn('[Tracking] Event failed:', err);
            });
        }
        
        // Track event
        function track(eventType, data = {}) {
            const payload = {
                event_type: eventType,
                occurred_at: new Date().toISOString(),
                visitor_id: getVisitorId(),
                session_id: getSessionId(),
                page_url: window.location.href,
                page_path: window.location.pathname,
                referrer: document.referrer || null,
                user_agent: navigator.userAgent,
                ...extractUTM(),
                ...data
            };
            
            // Add element info if provided
            if (data.element_id) payload.element_id = data.element_id;
            if (data.element_text) payload.element_text = data.element_text;
            
            // Queue or send immediately
            if (isSending) {
                eventQueue.push(payload);
            } else {
                isSending = true;
                sendEvent(payload).finally(() => {
                    isSending = false;
                    if (eventQueue.length > 0) {
                        const next = eventQueue.shift();
                        track(next.event_type, next);
                    }
                });
            }
        }
        
        // Track page view on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                track('page_view');
            });
        } else {
            track('page_view');
        }
        
        // Track clicks on elements with data-track attribute
        document.addEventListener('click', function(e) {
            const target = e.target.closest('[data-track]');
            if (target) {
                const eventType = target.getAttribute('data-track') || 'click';
                const elementId = target.id || target.getAttribute('data-track-id') || null;
                const elementText = target.textContent?.trim().substring(0, 100) || null;
                
                track(eventType, {
                    element_id: elementId,
                    element_text: elementText
                });
            }
        });
        
        // Track form submissions
        document.addEventListener('submit', function(e) {
            const form = e.target;
            if (form.tagName === 'FORM') {
                const formId = form.id || form.getAttribute('data-track-id') || 'unknown_form';
                
                // Extract email and phone from form fields for user identification
                let customerEmail = null;
                let customerPhone = null;
                
                // Try to find email field (common patterns)
                const emailInput = form.querySelector('input[type="email"], input[name*="email" i], input[name*="Email"], input[id*="email" i], input[id*="Email"]');
                if (emailInput && emailInput.value) {
                    customerEmail = emailInput.value.trim().toLowerCase();
                }
                
                // Try to find phone field (common patterns)
                const phoneInput = form.querySelector('input[type="tel"], input[name*="phone" i], input[name*="Phone"], input[id*="phone" i], input[id*="Phone"], input[name*="mobile" i], input[name*="Mobile"]');
                if (phoneInput && phoneInput.value) {
                    customerPhone = phoneInput.value.trim();
                }
                
                const trackData = {
                    element_id: formId,
                    element_text: formId
                };
                
                // Only include email/phone if we found them (don't send empty strings)
                if (customerEmail) trackData.customer_email = customerEmail;
                if (customerPhone) trackData.customer_phone = customerPhone;
                
                track('form_submit', trackData);
            }
        });
        
        // Track outbound links
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a[href]');
            if (link && link.hostname !== window.location.hostname) {
                track('outbound', {
                    element_id: link.id || null,
                    element_text: link.textContent?.trim().substring(0, 100) || null,
                    metadata: { url: link.href }
                });
            }
        });
        
        // Expose track function globally for manual tracking
        window.h2sTrack = track;
        
        // Track page unload
        window.addEventListener('beforeunload', function() {
            track('page_unload');
        });
    })();
    </script>
</body>
</html>
